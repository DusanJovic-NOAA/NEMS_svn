      MODULE MODULE_VARS_STATE

      USE ESMF_Mod
      USE MODULE_VARS

      IMPLICIT NONE

      PRIVATE
      PUBLIC :: PUT_VARS_IN_STATE
      PUBLIC :: GET_VARS_FROM_STATE
      PUBLIC :: DELETE_FIELDS_FROM_STATE
      PUBLIC :: PUT_VARS_IN_BUNDLES

      CONTAINS

!###############################################################################

      SUBROUTINE PUT_VARS_IN_STATE(VARS, NUM_VARS, STATE_TYPE, GRID, STATE)

!-------------------------------------------------------------------------------
!***  Put pointers of variables in the composite VARS array into a given
!***  ESMF import/export state.
!-------------------------------------------------------------------------------

      IMPLICIT NONE

      TYPE(VAR), DIMENSION(:), INTENT(IN)    :: VARS
      INTEGER,                 INTENT(IN)    :: NUM_VARS
      CHARACTER(LEN=1),        INTENT(IN)    :: STATE_TYPE
      TYPE(ESMF_Grid),         INTENT(IN)    :: GRID
      TYPE(ESMF_State ),       INTENT(INOUT) :: STATE

      TYPE(ESMF_StateItemType) :: stateItemType
      TYPE(ESMF_Field)         :: FIELD
      INTEGER                  :: N, RC
      INTEGER                  :: IHALO,JHALO

!-------------------------------------------------------------------------------

!!!!!!!!! FIX this later
!!!!!!!!! FIX this later
                IHALO = 3
                JHALO = 3
!!!!!!!!! FIX this later
!!!!!!!!! FIX this later

      DO N=1,NUM_VARS
        IF (( (STATE_TYPE == 'I') .AND. VARS(N)%IMPORT ) .OR. &
            ( (STATE_TYPE == 'X') .AND. VARS(N)%EXPORT ) ) THEN

          SELECT CASE(VARS(N)%TKR)
            CASE(TKR_I0D)
              CALL ESMF_AttributeSet(state=STATE ,name=VARS(N)%VBL_NAME, value=VARS(N)%I0D, rc=RC)
            CASE(TKR_I1D)
            CASE(TKR_I2D)
            CASE(TKR_R0D)
              CALL ESMF_AttributeSet(state=STATE ,name=VARS(N)%VBL_NAME, value=VARS(N)%R0D, rc=RC)
            CASE(TKR_R1D)
            CASE(TKR_R2D)
              CALL ESMF_StateGet(state=STATE ,name=VARS(N)%VBL_NAME , stateitemtype=stateItemType, rc=RC)
              IF (stateItemType==ESMF_STATEITEM_NOTFOUND) THEN
                FIELD = ESMF_FieldCreate(grid            =GRID                              &
                                        ,farray          =VARS(N)%R2D                       &
                                        ,maxHaloUWidth   =(/IHALO,JHALO/)                   &  !<-- Upper bound of halo region
                                        ,maxHaloLWidth   =(/IHALO,JHALO/)                   &  !<-- Lower bound of halo region
                                        ,name            =VARS(N)%VBL_NAME                  &
!dusan                                        ,indexFlag       =ESMF_INDEX_DELOCAL                &
                                        ,indexFlag       =ESMF_INDEX_GLOBAL                 &
                                        ,rc              =RC)
                CALL ESMF_StateAdd(state=STATE ,field=FIELD ,rc=RC)
              ENDIF
            CASE(TKR_R3D)
              CALL ESMF_StateGet(state=STATE ,name=VARS(N)%VBL_NAME ,stateitemtype=stateItemType, rc=RC)
              IF (stateItemType==ESMF_STATEITEM_NOTFOUND) THEN
                FIELD = ESMF_FieldCreate(grid            =GRID                              &
                                        ,farray          =VARS(N)%R3D                       &
                                        ,maxHaloUWidth   =(/IHALO,JHALO/)                   &  !<-- Upper bound of halo region
                                        ,maxHaloLWidth   =(/IHALO,JHALO/)                   &  !<-- Lower bound of halo region
                                        ,ungriddedLBound =(/ lbound(VARS(N)%R3D,dim=3) /)   &
                                        ,ungriddedUBound =(/ ubound(VARS(N)%R3D,dim=3) /)   &
                                        ,name            =VARS(N)%VBL_NAME                  &
!dusan                                        ,indexFlag       =ESMF_INDEX_DELOCAL                &
                                        ,indexFlag       =ESMF_INDEX_GLOBAL                 &
                                        ,rc              =RC)
                CALL ESMF_StateAdd(state=STATE ,field=FIELD ,rc=RC)
              ENDIF
            CASE(TKR_R4D)
              CALL ESMF_StateGet(state=STATE ,name=VARS(N)%VBL_NAME ,stateitemtype=stateItemType, rc=RC)
              IF (stateItemType==ESMF_STATEITEM_NOTFOUND) THEN
                FIELD = ESMF_FieldCreate(grid            =GRID                              &
                                        ,farray          =VARS(N)%R4D                       &
                                        ,maxHaloUWidth   =(/IHALO,JHALO/)                   &  !<-- Upper bound of halo region
                                        ,maxHaloLWidth   =(/IHALO,JHALO/)                   &  !<-- Lower bound of halo region
                                        ,ungriddedLBound =(/ lbound(VARS(N)%R4D,dim=3),lbound(VARS(N)%R4D,dim=4) /)   &
                                        ,ungriddedUBound =(/ ubound(VARS(N)%R4D,dim=3),ubound(VARS(N)%R4D,dim=4) /)   &
                                        ,name            =VARS(N)%VBL_NAME                  &
!dusan                                        ,indexFlag       =ESMF_INDEX_DELOCAL                &
                                        ,indexFlag       =ESMF_INDEX_GLOBAL                 &
                                        ,rc              =RC)
                CALL ESMF_StateAdd(state=STATE ,field=FIELD ,rc=RC)
              ENDIF
            CASE DEFAULT
              write(0,*)' TKR = ', VARS(N)%TKR, TRIM(VARS(N)%VBL_NAME)
              stop 9
          END SELECT

        ENDIF
      END DO

      END SUBROUTINE PUT_VARS_IN_STATE

!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&

      SUBROUTINE GET_VARS_FROM_STATE(VARS, NUM_VARS, STATE)

!-------------------------------------------------------------------------------
!***  Take allocated pointers from a given ESMF state and either point 
!***  VARS locations at them if the VARS variable is unowned/unallocated
!***  or move the pointer data into the VARS location if both Dynamics
!***  and Physics own the variable.
!-------------------------------------------------------------------------------

      IMPLICIT NONE

      TYPE(VAR), DIMENSION(:), INTENT(INOUT) :: VARS
      INTEGER, INTENT(IN) :: NUM_VARS
      TYPE(ESMF_State ), INTENT(IN) :: STATE

      TYPE(ESMF_Field) :: FIELD
      INTEGER :: N, RC
      INTEGER                            :: HOLD_I0D
      INTEGER,DIMENSION(:)      ,POINTER :: HOLD_I1D
      INTEGER,DIMENSION(:,:)    ,POINTER :: HOLD_I2D
      REAL                               :: HOLD_R0D
      REAL   ,DIMENSION(:)      ,POINTER :: HOLD_R1D
      REAL   ,DIMENSION(:,:)    ,POINTER :: HOLD_R2D
      REAL   ,DIMENSION(:,:,:)  ,POINTER :: HOLD_R3D
      REAL   ,DIMENSION(:,:,:,:),POINTER :: HOLD_R4D
      CHARACTER(LEN=32) :: VBL_NAME

!-------------------------------------------------------------------------------

      DO N=1,NUM_VARS
        IF ( VARS(N)%IMPORT ) THEN
          VBL_NAME = TRIM(VARS(N)%VBL_NAME)
          SELECT CASE(VARS(N)%TKR)
            CASE(TKR_I0D)
              CALL ESMF_AttributeGet(state=STATE ,name=VARS(N)%VBL_NAME, value=VARS(N)%I0D, rc=RC)
              if (rc/=ESMF_SUCCESS) stop 990
            CASE(TKR_I1D)
              write(0,*)' not implemented TKR_I1D in GET_VARS_FROM_STATE '
              stop
            CASE(TKR_I2D)
              CALL ESMF_StateGet(state=STATE ,itemName=VBL_NAME ,field=FIELD ,rc=RC)
              if (rc/=ESMF_SUCCESS) stop 991
              CALL ESMF_FieldGet(field=FIELD ,localDe=0 ,farray=HOLD_I2D ,rc=RC)
              if (rc/=ESMF_SUCCESS) stop 992
              IF (VARS(N)%OWNED ) THEN
                if (size(VARS(N)%I2D) /= size(HOLD_I2D) ) stop 2
                VARS(N)%I2D =  HOLD_I2D        !<-- Both Dynamics and Physics own the variable thus transfer data
              ELSE
                VARS(N)%I2D => HOLD_I2D        !<-- Point the appropriate unallocated VARS location at allocated pointer
              END IF
            CASE(TKR_R0D)
              CALL ESMF_AttributeGet(state=STATE ,name=VARS(N)%VBL_NAME, value=VARS(N)%R0D, rc=RC)
              if (rc/=ESMF_SUCCESS) stop 993
            CASE(TKR_R1D)
              write(0,*)' not implemented TKR_R1D in UPDATE_VARS '
              stop
            CASE(TKR_R2D)
              CALL ESMF_StateGet(state=STATE ,itemName=VBL_NAME ,field=FIELD ,rc=RC)
              if (rc/=ESMF_SUCCESS) stop 996
              CALL ESMF_FieldGet(field=FIELD ,localDe=0 ,farray=HOLD_R2D ,rc=RC)
              if (rc/=ESMF_SUCCESS) stop 997
              IF (VARS(N)%OWNED ) THEN
                if (size(VARS(N)%R2D) /= size(HOLD_R2D) ) stop 4
                VARS(N)%R2D =  HOLD_R2D         !<-- Both Dynamics and Physics own the variable thus transfer data
              ELSE
                VARS(N)%R2D => HOLD_R2D         !<-- Point the appropriate unallocated VARS location at allocated pointer
              END IF
            CASE(TKR_R3D)
              CALL ESMF_StateGet(state=STATE ,itemName=VBL_NAME ,field=FIELD ,rc=RC)
              if (rc/=ESMF_SUCCESS) stop 998
              CALL ESMF_FieldGet(field=FIELD ,localDe=0 ,farray=HOLD_R3D ,rc=RC)
              if (rc/=ESMF_SUCCESS) stop 999
              IF (VARS(N)%OWNED ) THEN
                if (size(VARS(N)%R3D) /= size(HOLD_R3D) ) then
                  write(0,*)TRIM(VARS(N)%VBL_NAME), size(VARS(N)%R3D), size(HOLD_R3D)
                  write(0,*)TRIM(VARS(N)%VBL_NAME), 'lbound ',lbound(VARS(N)%R3D), lbound(HOLD_R3D)
                  write(0,*)TRIM(VARS(N)%VBL_NAME), 'ubound ',ubound(VARS(N)%R3D), ubound(HOLD_R3D)
                  stop 5
                end if
                VARS(N)%R3D =  HOLD_R3D         !<-- Both Dynamics and Physics own the variable thus transfer data
              ELSE
                VARS(N)%R3D => HOLD_R3D         !<-- Point the appropriate unallocated VARS location at allocated pointer
              END IF
            CASE(TKR_R4D)
              CALL ESMF_StateGet(state=STATE ,itemName=VBL_NAME ,field=FIELD ,rc=RC)
              if (rc/=ESMF_SUCCESS) stop 1998
              CALL ESMF_FieldGet(field=FIELD ,localDe=0 ,farray=HOLD_R4D ,rc=RC)
              if (rc/=ESMF_SUCCESS) stop 1999
              IF (VARS(N)%OWNED ) THEN
                if (size(VARS(N)%R4D) /= size(HOLD_R4D) ) then
                  write(0,*)TRIM(VARS(N)%VBL_NAME), size(VARS(N)%R4D), size(HOLD_R4D)
                  write(0,*)TRIM(VARS(N)%VBL_NAME), 'lbound ',lbound(VARS(N)%R4D), lbound(HOLD_R4D)
                  write(0,*)TRIM(VARS(N)%VBL_NAME), 'ubound ',ubound(VARS(N)%R4D), ubound(HOLD_R4D)
                  stop 5
                end if
                VARS(N)%R4D =  HOLD_R4D         !<-- Both Dynamics and Physics own the variable thus transfer data
              ELSE
                VARS(N)%R4D => HOLD_R4D         !<-- Point the appropriate unallocated VARS location at allocated pointer
              END IF
            CASE DEFAULT
              write(0,*)' TKR = ', VARS(N)%TKR, TRIM(VARS(N)%VBL_NAME)
              stop 9
          END SELECT

        END IF
      END DO

      END SUBROUTINE GET_VARS_FROM_STATE

!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&

      SUBROUTINE DELETE_FIELDS_FROM_STATE(STATE)

      IMPLICIT NONE

      TYPE(ESMF_State ), INTENT(INOUT) :: STATE

      INTEGER                                :: RC
      INTEGER                                :: i, itemCount
      TYPE(ESMF_Field)                       :: FIELD

      CHARACTER(LEN=10), DIMENSION(:), ALLOCATABLE :: itemNameList

      CALL ESMF_StateGet(state=STATE,itemCount=itemCount, rc=RC)
      ALLOCATE(itemNameList(itemCount))
      CALL ESMF_StateGet(state=STATE,itemCount=itemCount,itemNameList=itemNameList, rc=RC)
      DO i=1,itemCount
        CALL ESMF_StateGet(state=STATE ,itemName=itemNameList(i) ,field=FIELD ,rc=RC)
        CALL ESMF_FieldDestroy(field=FIELD, rc=RC)
      END DO
      DEALLOCATE(itemNameList)

      END SUBROUTINE DELETE_FIELDS_FROM_STATE

!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&

      SUBROUTINE PUT_VARS_IN_BUNDLES(VARS, NUM_VARS, GRID, HISTORY_BUNDLE, RESTART_BUNDLE)

      USE MODULE_ERR_MSG               ,ONLY: ERR_MSG,MESSAGE_CHECK

      IMPLICIT NONE

      TYPE(VAR), DIMENSION(:), INTENT(IN)    :: VARS
      INTEGER,                 INTENT(IN)    :: NUM_VARS
      TYPE(ESMF_Grid),         INTENT(IN)    :: GRID
      TYPE(ESMF_FieldBundle),  INTENT(INOUT) :: HISTORY_BUNDLE
      TYPE(ESMF_FieldBundle),  INTENT(INOUT) :: RESTART_BUNDLE

!-----------------------------------------------------------------------
!***  LOCAL VARIABLES
!-----------------------------------------------------------------------

      INTEGER                      :: K,LENGTH                          &
                                     ,N,M,NDIM3,NFIND                   &
                                     ,RC,RC_OUT

      INTEGER                  :: IHALO,JHALO

      INTEGER :: LDIM1,LDIM2,LDIM3,LDIM4,UDIM1,UDIM2,UDIM3,UDIM4

      INTEGER(ESMF_KIND_I4),DIMENSION(:,:),POINTER :: TEMP_I2D
      REAL(ESMF_KIND_R4)   ,DIMENSION(:,:),POINTER :: TEMP_R2D

      CHARACTER(2)           :: MODEL_LEVEL,TRACERS_KIND
      CHARACTER(6)           :: FMT='(I2.2)'
      CHARACTER(ESMF_MAXSTR) :: VBL_NAME,VBL_NAME_X

      TYPE(ESMF_Field)       :: FIELD

      TYPE(ESMF_CopyFlag)    :: COPYFLAG=ESMF_DATA_REF
!     TYPE(ESMF_CopyFlag)    :: COPYFLAG=ESMF_DATA_COPY

      INTEGER :: INDX_RRW  !! FIXME

!-----------------------------------------------------------------------
!***  BEGIN WITH THE INTEGER SCALARS.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Insert Integer Scalars into History Bundle"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      DO N=1,NUM_VARS
        IF (VARS(N)%TKR == TKR_I0D) THEN
          IF (VARS(N)%HISTORY) THEN                                        !<-- Take integer scalar data specified for history output
            CALL ESMF_AttributeSet(bundle=HISTORY_BUNDLE                &  !<-- The Write component output history Bundle
                                  ,name  =VARS(N)%VBL_NAME              &  !<-- Name of the integer scalar
                                  ,value =VARS(N)%I0D                   &  !<-- The scalar being inserted into the import state
                                  ,rc    =RC)
          END IF
          IF (VARS(N)%RESTART) THEN                                        !<-- Take integer scalar data specified for restart output
            CALL ESMF_AttributeSet(bundle=RESTART_BUNDLE                &  !<-- The Write component output restart Bundle
                                  ,name  =VARS(N)%VBL_NAME              &  !<-- Name of the integer scalar
                                  ,value =VARS(N)%I0D                   &  !<-- The scalar being inserted into the import state
                                  ,rc    =RC)
          END IF
        END IF
      END DO
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_OUT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------------------------------------------------
!***  THE REAL SCALARS.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Insert Real Scalars into History Bundle"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      DO N=1,NUM_VARS
        IF (VARS(N)%TKR == TKR_R0D) THEN
          IF (VARS(N)%HISTORY) THEN                                        !<-- Take real scalar data specified for history output
            CALL ESMF_AttributeSet(bundle=HISTORY_BUNDLE                &  !<-- The Write component output history Bundle
                                  ,name  =VARS(N)%VBL_NAME              &  !<-- Name of the real scalar
                                  ,value =VARS(N)%R0D                   &  !<-- The scalar being inserted into the import state
                                  ,rc    =RC)
          END IF
          IF (VARS(N)%RESTART) THEN                                        !<-- Take real scalar data specified for restart output
            CALL ESMF_AttributeSet(bundle=RESTART_BUNDLE                &  !<-- The Write component output restart Bundle
                                  ,name  =VARS(N)%VBL_NAME              &  !<-- Name of the real scalar
                                  ,value =VARS(N)%R0D                   &  !<-- The scalar being inserted into the import state
                                  ,rc    =RC)
          END IF
        END IF
      END DO
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_OUT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------------------------------------------------
!***  THE 1D INTEGER ARRAYS
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Insert 1-D Integer Arrays into History Bundle"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      DO N=1,NUM_VARS
        IF (VARS(N)%TKR == TKR_I1D) THEN
          LENGTH=SIZE(VARS(N)%I1D)
          IF (VARS(N)%HISTORY) THEN                                        !<-- Take 1D integer array data specified for history output
            CALL ESMF_AttributeSet(bundle   =HISTORY_BUNDLE             &  !<-- The Write component output history Bundle
                                  ,name     =VARS(N)%VBL_NAME           &  !<-- Name of the integer array
                                  ,count    =LENGTH                     &  !<-- # of elements in this attribute
                                  ,valueList=VARS(N)%I1D                &  !<-- The 1D integer being inserted into the import state
                                  ,rc       =RC)
          END IF
          IF (VARS(N)%RESTART) THEN                                        !<-- Take 1D integer array data specified for restart output
            CALL ESMF_AttributeSet(bundle   =RESTART_BUNDLE             &  !<-- The Write component output history Bundle
                                  ,name     =VARS(N)%VBL_NAME           &  !<-- Name of the integer array
                                  ,count    =LENGTH                     &  !<-- # of elements in this attribute
                                  ,valueList=VARS(N)%I1D                &  !<-- The 1D integer being inserted into the import state
                                  ,rc       =RC)
          END IF
        END IF
      END DO
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_OUT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------------------------------------------------
!***  THE 1D REAL ARRAYS.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Insert 1-D Real Arrays into History Bundle"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      DO N=1,NUM_VARS
        IF (VARS(N)%TKR == TKR_R1D) THEN
          LENGTH=SIZE(VARS(N)%R1D)
          IF (VARS(N)%HISTORY) THEN                                        !<-- Take 1D real array data specified for history output
            CALL ESMF_AttributeSet(bundle   =HISTORY_BUNDLE             &  !<-- The Write component output history Bundle
                                  ,name     =VARS(N)%VBL_NAME           &  !<-- Name of the real array
                                  ,count    =LENGTH                     &  !<-- # of elements in this attribute
                                  ,valueList=VARS(N)%R1D                &  !<-- The 1D real being inserted into the import state
                                  ,rc       =RC)
          END IF
          IF (VARS(N)%RESTART) THEN                                        !<-- Take 1D real array data specified for restart output
            CALL ESMF_AttributeSet(bundle   =RESTART_BUNDLE             &  !<-- The Write component output history Bundle
                                  ,name     =VARS(N)%VBL_NAME           &  !<-- Name of the real array
                                  ,count    =LENGTH                     &  !<-- # of elements in this attribute
                                  ,valueList=VARS(N)%R1D                &  !<-- The 1D real being inserted into the import state
                                  ,rc       =RC)
          END IF
        END IF
      END DO
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_OUT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------------------------------------------------
!***  THE 2D INTEGER ARRAYS.
!-----------------------------------------------------------------------
!
      IHALO=3
      JHALO=3
!
      NULLIFY(TEMP_I2D)
!
      DO N=1,NUM_VARS
        IF (VARS(N)%TKR == TKR_I2D) THEN
          IF (VARS(N)%HISTORY) THEN                                        !<-- Take 2D integer array data specified for history output
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
          MESSAGE_CHECK="Insert 2-D Integer Data into Field"
          CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
          FIELD=ESMF_FieldCreate(grid         =GRID                     &  !<-- The ESMF grid
                                ,farray       =VARS(N)%I2D              &  !<-- The 2D integer array being inserted into the import state
                                ,copyflag     =COPYFLAG                 &
                                ,maxHaloUWidth=(/IHALO,JHALO/)          &
                                ,maxHaloLWidth=(/IHALO,JHALO/)          &
                                ,name         =VARS(N)%VBL_NAME         &  !<-- Name of the 2D real array
                                ,indexFlag    =ESMF_INDEX_GLOBAL        &
                                ,rc           =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
          CALL ERR_MSG(RC,MESSAGE_CHECK,RC_OUT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
          MESSAGE_CHECK="Insert Phisics 2-D Integer Field into History Bundles"
          CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
          CALL ESMF_FieldBundleAdd(bundle=HISTORY_BUNDLE                &  !<-- The Write component output history Bundle
                                  ,field =FIELD                         &  !<-- ESMF Field holding the 2D real array
                                  ,rc    =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
          CALL ERR_MSG(RC,MESSAGE_CHECK,RC_OUT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
          END IF
          IF (VARS(N)%RESTART) THEN                                        !<-- Take 2D integer array data specified for restart output
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
          MESSAGE_CHECK="Insert 2-D Integer Data into Field"
          CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
          FIELD=ESMF_FieldCreate(grid         =GRID                     &  !<-- The ESMF grid
                                ,farray       =VARS(N)%I2D              &  !<-- The 2D integer array being inserted into the import state
                                ,copyflag     =COPYFLAG                 &
                                ,maxHaloUWidth=(/IHALO,JHALO/)          &
                                ,maxHaloLWidth=(/IHALO,JHALO/)          &
                                ,name         =VARS(N)%VBL_NAME         &  !<-- Name of the 2D real array
                                ,indexFlag    =ESMF_INDEX_GLOBAL        &
                                ,rc           =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
          CALL ERR_MSG(RC,MESSAGE_CHECK,RC_OUT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
          MESSAGE_CHECK="Insert 2-D Integer Field into Restart Bundles"
          CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
          CALL ESMF_FieldBundleAdd(bundle=RESTART_BUNDLE                &  !<-- The Write component output restart Bundle
                                  ,field =FIELD                         &  !<-- ESMF Field holding the 2D real array
                                  ,rc    =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_OUT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
          END IF
        END IF
      END DO

!
!-----------------------------------------------------------------------
!***  THE 2D REAL ARRAYS.
!-----------------------------------------------------------------------
!
      DO N=1,NUM_VARS
        IF (VARS(N)%TKR == TKR_R2D) THEN
          IF (VARS(N)%HISTORY) THEN                              !<-- Take 2D real array data specified for history output
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
          MESSAGE_CHECK="Insert Dynamics 2-D Real Data into Field"
          CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
          FIELD=ESMF_FieldCreate(grid         =GRID                     &  !<-- The ESMF grid
                                ,farray       =VARS(N)%R2D              &  !<-- The 2D real array being inserted into the import state
                                ,copyflag     =COPYFLAG                 &
                                ,maxHaloUWidth=(/IHALO,JHALO/)          &
                                ,maxHaloLWidth=(/IHALO,JHALO/)          &
                                ,name         =VARS(N)%VBL_NAME         &  !<-- Name of the 2D real array
                                ,indexFlag    =ESMF_INDEX_GLOBAL        &
                                ,rc           =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
          CALL ERR_MSG(RC,MESSAGE_CHECK,RC_OUT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
          MESSAGE_CHECK="Insert Dynamics 2-D Real Field into History Bundles"
          CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
          CALL ESMF_FieldBundleAdd(bundle=HISTORY_BUNDLE                &  !<-- The Write component output history Bundle
                                  ,field =FIELD                         &  !<-- ESMF Field holding the 2D real array
                                  ,rc    =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
          CALL ERR_MSG(RC,MESSAGE_CHECK,RC_OUT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
          END IF
          IF (VARS(N)%RESTART) THEN                                        !<-- Take 2D real array data specified for restart output
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
          MESSAGE_CHECK="Insert Dynamics 2-D Real Data into Field"
          CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
          FIELD=ESMF_FieldCreate(grid         =GRID                     &  !<-- The ESMF grid
                                ,farray       =VARS(N)%R2D              &  !<-- The 2D real array being inserted into the import state
                                ,copyflag     =COPYFLAG                 &
                                ,maxHaloUWidth=(/IHALO,JHALO/)          &
                                ,maxHaloLWidth=(/IHALO,JHALO/)          &
                                ,name         =VARS(N)%VBL_NAME         &  !<-- Name of the 2D real array
                                ,indexFlag    =ESMF_INDEX_GLOBAL        &
                                ,rc           =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
          CALL ERR_MSG(RC,MESSAGE_CHECK,RC_OUT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
          MESSAGE_CHECK="Insert Dynamics 2-D Real Field into Restart Bundles"
          CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
          CALL ESMF_FieldBundleAdd(bundle=RESTART_BUNDLE                &  !<-- The Write component output restart Bundle
                                  ,field =FIELD                         &  !<-- ESMF Field holding the 2D real array
                                  ,rc    =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_OUT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
          END IF
        END IF
      END DO
!
!-----------------------------------------------------------------------
!***  THE 3D REAL ARRAYS.
!***  WE ARE WORKING WITH 3D ARRAYS BUT THEY ARE LOADED LAYER BY LAYER
!***  INTO 2D Fields.
!-----------------------------------------------------------------------
!
      DO N=1,NUM_VARS
        IF (VARS(N)%TKR == TKR_R3D) THEN
          IF (VARS(N)%HISTORY) THEN                                        !<-- Take 3D real array data specified for history output
          NDIM3=UBOUND(VARS(N)%R3D,3)
          LDIM1=LBOUND(VARS(N)%R3D,1)
          UDIM1=UBOUND(VARS(N)%R3D,1)
          LDIM2=LBOUND(VARS(N)%R3D,2)
          UDIM2=UBOUND(VARS(N)%R3D,2)
!
          DO K=1,NDIM3
            WRITE(MODEL_LEVEL,FMT)K
            VBL_NAME=TRIM(VARS(N)%VBL_NAME)//'_'//MODEL_LEVEL//'_2D'
            TEMP_R2D=>VARS(N)%R3D(LDIM1:UDIM1,LDIM2:UDIM2,K)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
            MESSAGE_CHECK="Fill 2-D Fields with Each Level of 3-D Data"
            CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
            FIELD=ESMF_FieldCreate(grid         =GRID                   &  !<-- The ESMF grid
                                  ,farray       =TEMP_R2D               &  !<-- Level K of 3D real array being inserted into the import state
                                  ,copyflag     =COPYFLAG               &
                                  ,maxHaloUWidth=(/IHALO,JHALO/)        &
                                  ,maxHaloLWidth=(/IHALO,JHALO/)        &
                                  ,name         =VBL_NAME               &  !<-- Name of this level of the 3D real array
                                  ,indexFlag    =ESMF_INDEX_GLOBAL      &
                                  ,rc           =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
            CALL ERR_MSG(RC,MESSAGE_CHECK,RC_OUT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
            MESSAGE_CHECK="Insert 3-D Data into History Bundle"
            CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
            CALL ESMF_FieldBundleAdd(bundle=HISTORY_BUNDLE              &  !<-- The Write component output history Bundle
                                    ,field =FIELD                       &  !<-- ESMF Field holding the 3D real array
                                    ,rc    =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
            CALL ERR_MSG(RC,MESSAGE_CHECK,RC_OUT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
          ENDDO
!
          END IF
          IF (VARS(N)%RESTART) THEN                                        !<-- Take 3D real array data specified for restart output
          NDIM3=UBOUND(VARS(N)%R3D,3)
          LDIM1=LBOUND(VARS(N)%R3D,1)
          UDIM1=UBOUND(VARS(N)%R3D,1)
          LDIM2=LBOUND(VARS(N)%R3D,2)
          UDIM2=UBOUND(VARS(N)%R3D,2)
!
          DO K=1,NDIM3
            WRITE(MODEL_LEVEL,FMT)K
            VBL_NAME=TRIM(VARS(N)%VBL_NAME)//'_'//MODEL_LEVEL//'_2D'
            TEMP_R2D=>VARS(N)%R3D(LDIM1:UDIM1,LDIM2:UDIM2,K)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
            MESSAGE_CHECK="Fill 2-D Fields with Each Level of 3-D Data"
            CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
            FIELD=ESMF_FieldCreate(grid         =GRID                   &  !<-- The ESMF grid
                                  ,farray       =TEMP_R2D               &  !<-- Level K of 3D real array being inserted into the import state
                                  ,copyflag     =COPYFLAG               &
                                  ,maxHaloUWidth=(/IHALO,JHALO/)        &
                                  ,maxHaloLWidth=(/IHALO,JHALO/)        &
                                  ,name         =VBL_NAME               &  !<-- Name of this level of the 3D real array
                                  ,indexFlag    =ESMF_INDEX_GLOBAL      &
                                  ,rc           =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
            CALL ERR_MSG(RC,MESSAGE_CHECK,RC_OUT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
            MESSAGE_CHECK="Insert 3-D Data into Restart Bundle"
            CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
            CALL ESMF_FieldBundleAdd(bundle=RESTART_BUNDLE              &  !<-- The Write component output restart Bundle
                                    ,field =FIELD                       &  !<-- ESMF Field holding the 3D real array
                                    ,rc    =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
            CALL ERR_MSG(RC,MESSAGE_CHECK,RC_OUT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
          ENDDO
!
          END IF
        END IF
      END DO
!
!-----------------------------------------------------------------------
!***  THE 4D REAL ARRAYS.
!***  WE ARE WORKING WITH 4D ARRAYS BUT THEY ARE LOADED LAYER BY LAYER
!***  INTO 2D Fields.
!-----------------------------------------------------------------------
!
!!!!!!!!! FIX this later
!!!!!!!!! FIX this later
      INDX_RRW = 4
!!!!!!!!! FIX this later
!!!!!!!!! FIX this later

      DO N=1,NUM_VARS
        IF (VARS(N)%TKR == TKR_R4D) THEN
          IF (VARS(N)%HISTORY) THEN                                        !<-- Take 4D real array data specified for history output
          LDIM1=LBOUND(VARS(N)%R4D,1)
          UDIM1=UBOUND(VARS(N)%R4D,1)
          LDIM2=LBOUND(VARS(N)%R4D,2)
          UDIM2=UBOUND(VARS(N)%R4D,2)
          LDIM3=LBOUND(VARS(N)%R4D,3)
          UDIM3=UBOUND(VARS(N)%R4D,3)
          LDIM4=LBOUND(VARS(N)%R4D,4)
          UDIM4=UBOUND(VARS(N)%R4D,4)
!
          DO M=INDX_RRW+1,UDIM4                                            !<-- Loop through the tracers (skip unallocated pointers)
          DO K=LDIM3,UDIM3                                                 !<-- Loop through the levels of the array
            WRITE(TRACERS_KIND,FMT)M
            WRITE(MODEL_LEVEL,FMT)K
!
            VBL_NAME=TRIM(VARS(N)%VBL_NAME)//'_'//TRACERS_KIND//'_'//MODEL_LEVEL//'_2D'
            NULLIFY(TEMP_R2D)
            TEMP_R2D=>VARS(N)%R4D(LDIM1:UDIM1,LDIM2:UDIM2,K,M)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
            MESSAGE_CHECK="Fill 2-D Fields with Each Level of 4-D Data"
            CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
            FIELD=ESMF_FieldCreate(grid         =GRID                   &  !<-- The ESMF grid
                                  ,farray       =TEMP_R2D               &  !<-- Level K of 4D real array being inserted into the import state
                                  ,copyflag     =COPYFLAG               &
                                  ,maxHaloUWidth=(/IHALO,JHALO/)        &
                                  ,maxHaloLWidth=(/IHALO,JHALO/)        &
                                  ,name         =VBL_NAME               &  !<-- Name of this level of the 4D real array
                                  ,indexFlag    =ESMF_INDEX_GLOBAL      &
                                  ,rc           =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
            CALL ERR_MSG(RC,MESSAGE_CHECK,RC_OUT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
            MESSAGE_CHECK="Insert 4-D Data into History Bundle"
            CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
            CALL ESMF_FieldBundleAdd(bundle=HISTORY_BUNDLE              &  !<-- The Write component output history Bundle
                                    ,field =FIELD                       &  !<-- ESMF Field holding the 4D real array
                                    ,rc    =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
            CALL ERR_MSG(RC,MESSAGE_CHECK,RC_OUT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
          ENDDO
          ENDDO
!
          END IF
          IF (VARS(N)%RESTART) THEN                                        !<-- Take 4D real array data specified for restart output
          LDIM1=LBOUND(VARS(N)%R4D,1)
          UDIM1=UBOUND(VARS(N)%R4D,1)
          LDIM2=LBOUND(VARS(N)%R4D,2)
          UDIM2=UBOUND(VARS(N)%R4D,2)
          LDIM3=LBOUND(VARS(N)%R4D,3)
          UDIM3=UBOUND(VARS(N)%R4D,3)
          LDIM4=LBOUND(VARS(N)%R4D,4)
          UDIM4=UBOUND(VARS(N)%R4D,4)
!
          DO M=INDX_RRW+1,UDIM4                                            !<-- Loop through the tracers (skip unallocated pointers)
          DO K=LDIM3,UDIM3                                                 !<-- Loop through the levels of the array
            WRITE(TRACERS_KIND,FMT)M
            WRITE(MODEL_LEVEL,FMT)K
!
            VBL_NAME=TRIM(VARS(N)%VBL_NAME)//'_'//TRACERS_KIND//'_'//MODEL_LEVEL//'_2D'
            NULLIFY(TEMP_R2D)
            TEMP_R2D=>VARS(N)%R4D(LDIM1:UDIM1,LDIM2:UDIM2,K,M)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
            MESSAGE_CHECK="Fill 2-D Fields with Each Level of 4-D Data"
            CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
            FIELD=ESMF_FieldCreate(grid         =GRID                   &  !<-- The ESMF grid
                                  ,farray       =TEMP_R2D               &  !<-- Level K of 4D real array being inserted into the import state
                                  ,copyflag     =COPYFLAG               &
                                  ,maxHaloUWidth=(/IHALO,JHALO/)        &
                                  ,maxHaloLWidth=(/IHALO,JHALO/)        &
                                  ,name         =VBL_NAME               &  !<-- Name of this level of the 4D real array
                                  ,indexFlag    =ESMF_INDEX_GLOBAL      &
                                  ,rc           =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
            CALL ERR_MSG(RC,MESSAGE_CHECK,RC_OUT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
            MESSAGE_CHECK="Insert 4-D Data into Restart Bundle"
            CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
            CALL ESMF_FieldBundleAdd(bundle=RESTART_BUNDLE              &  !<-- The Write component output restart Bundle
                                    ,field =FIELD                       &  !<-- ESMF Field holding the 4D real array
                                    ,rc    =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
            CALL ERR_MSG(RC,MESSAGE_CHECK,RC_OUT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
          ENDDO
          ENDDO
!
          END IF
        END IF
      END DO
!
!-----------------------------------------------------------------------
!
      END SUBROUTINE PUT_VARS_IN_BUNDLES

!###############################################################################

      END MODULE MODULE_VARS_STATE

!-----------------------------------------------------------------------
!
      MODULE MODULE_RADIATION
!
!-----------------------------------------------------------------------
!
!***  THE RADIATION DRIVERS AND PACKAGES
!
!-----------------------------------------------------------------------
!
      USE MODULE_INCLUDE
      USE MODULE_CONSTANTS,ONLY : CAPPA,CP,EP_2,EPSQ,G,P608,PI,R_D,STBOLT
!
      USE MODULE_DM_PARALLEL,ONLY : IDS,IDE,JDS,JDE                     &
                                   ,IMS,IME,JMS,JME                     &
                                   ,ITS,ITE,JTS,JTE                     &
                                   ,ITS_B1,ITE_B1,ITE_B2                &
                                   ,ITS_B1_H1,ITE_B1_H1,ITE_B1_H2       &
                                   ,ITS_B1_H2,ITE_H2                    &
                                   ,JTS_B1,JTE_B1,JTE_B2                &
                                   ,JTS_B1_H1,JTE_B1_H1,JTE_B1_H2       &
                                   ,JTS_B1_H2,JTE_H2                    &
                                   ,MPI_COMM_COMP                       &
                                   ,MYPE_SHARE,NUM_TILES
!
      USE MODULE_MICROPHYSICS_NMM,ONLY :                                    &
       RHgrd,T_ICE,FPVS,QAUT0,XMImax,XMIexp,MDImin,MDImax,MASSI,        &
       FLARGE1,FLARGE2,NLImin,NLImax
!
      USE MODULE_CONTROL,ONLY : NMMB_FINALIZE
!
!-----------------------------------------------------------------------
!
      IMPLICIT NONE
!
!-----------------------------------------------------------------------
!
      PRIVATE
!
      PUBLIC :: GFDL_INIT,RADIATION,RDTEMP,TIME_MEASURE
      PUBLIC :: RRTMINIT,SWINIT
!
!-----------------------------------------------------------------------
!
      INTEGER :: MYPE
      REAL :: DPD=360./365.                                             &
             ,RLAG=14.8125
!
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!***  THE RADIATION PACKAGE OPTIONS
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!
!***  Shortwave
!
!!!   INTEGER(KIND=KINT) :: GFDLSWSCHEME=99                             &  !<--- (GFDL, WRF)
      INTEGER,PARAMETER  :: GFDLSWSCHEME=99                             &  !<--- (GFDL, WRF)
                           ,SWRADSCHEME=1                               &  !<--- (Dudhia, WRF)
                           ,GSFCSWSCHEME=2                                 !<--- (Goddard, WRF)
!
!***  Longwave
!
!!!   INTEGER(KIND=KINT) :: GFDLLWSCHEME=99                             &  !<--- (GFDL, WRF)
      INTEGER,PARAMETER  :: GFDLLWSCHEME=99                             &  !<--- (GFDL, WRF)
                           ,RRTMSCHEME=1                                   !<--- (RRTM, WRF)
!
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!***  FOR GFDL RADIATION 
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!
      INTEGER,PARAMETER :: NL=81
      INTEGER,PARAMETER :: NBLY=15
      REAL,PARAMETER :: DEGRAD=3.1415926/180.
      REAL,PARAMETER :: RTHRESH=1.E-15,RTD=1./DEGRAD

      INTEGER, SAVE, DIMENSION(3)     :: LTOP
      REAL   , SAVE, DIMENSION(37,NL) :: XDUO3N,XDO3N2,XDO3N3,XDO3N4
      REAL   , SAVE, DIMENSION(NL)    :: PRGFDL
      REAL   , SAVE                   :: AB15WD,SKO2D,SKC1R,SKO3R

      REAL   , SAVE :: EM1(28,180),EM1WDE(28,180),TABLE1(28,180),     &
                           TABLE2(28,180),TABLE3(28,180),             &
                           SOURCE(28,NBLY), DSRCE(28,NBLY)

      REAL   ,SAVE, DIMENSION(5040):: T1,T2,T4,EM1V,EM1VW,EM3V
      REAL   ,SAVE                 :: R1,RSIN1,RCOS1,RCOS2
! Created by CO2 initialization
      REAL,   SAVE, ALLOCATABLE, DIMENSION(:,:) :: CO251,CDT51,CDT58,C2D51,&
                                           C2D58,CO258
      REAL,   SAVE, ALLOCATABLE, DIMENSION(:)   :: STEMP,GTEMP,CO231,CO238, &
                                           C2D31,C2D38,CDT31,CDT38, &
                                           CO271,CO278,C2D71,C2D78, &
                                           CDT71,CDT78
      REAL,   SAVE, ALLOCATABLE, DIMENSION(:)   :: CO2M51,CO2M58,CDTM51,CDTM58, &
                                           C2DM51,C2DM58
      CHARACTER(256) :: ERRMESS

! Used by CO2 initialization
!     COMMON/PRESS/PA(109)
!     COMMON/TRAN/ TRANSA(109,109)
!     COMMON/COEFS/XA(109),CA(109),ETA(109),SEXPV(109),CORE,UEXP,SEXP
      REAL   ,SAVE, DIMENSION(109) :: PA, XA, CA, ETA, SEXPV
      REAL   ,SAVE, DIMENSION(109,109) :: TRANSA
      REAL   ,SAVE  :: CORE,UEXP,SEXP

      EQUIVALENCE (EM1V(1),EM1(1,1)),(EM1VW(1),EM1WDE(1,1)) 
      EQUIVALENCE (T1(1),TABLE1(1,1)),(T2(1),TABLE2(1,1)), &
                  (T4(1),TABLE3(1,1))
      REAL,SAVE,DIMENSION(4) :: PTOPC
!
!--- Used for Gaussian look up tables
!
      REAL, PRIVATE,PARAMETER :: XSDmax=3.1, DXSD=.01
      INTEGER, PRIVATE,PARAMETER :: NXSD=XSDmax/DXSD
      REAL, DIMENSION(NXSD),PRIVATE,SAVE :: AXSD
      REAL, PRIVATE :: RSQR
      LOGICAL, PRIVATE,SAVE :: SDprint=.FALSE.
!
!--- Important parameters for cloud properties - see extensive comments in
!    DO 580 loop within subroutine RADTN 
!
      REAL, PARAMETER ::  &
     &   TRAD_ice=0.5*T_ice      & !--- Very tunable parameter
     &,  ABSCOEF_W=1600.         & !--- Very tunable parameter
     &,  ABSCOEF_I=1000.         & !--- Very tunable parameter
     &,  SECANG=-1.66            & !--- Very tunable parameter
     &,  CLDCOEF_LW=1.5          & !--- Enhance LW cloud depths
     &,  ABSCOEF_LW=SECANG*CLDCOEF_LW  & !--- Final factor for cloud emissivities
     &,  Qconv=0.1e-3            & !--- Very tunable parameter
     &,  CTauCW=ABSCOEF_W*Qconv  &
     &,  CTauCI=ABSCOEF_I*Qconv
!
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!*** FOR DUDHIA SHORTWAVE
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!
      REAL,SAVE :: CSSCA
!
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!*** FOR GODDARD SHORTWAVE
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!
   REAL,    PARAMETER ::   thresh=1.e-9
   REAL,    SAVE      ::   center_lat
!
!  Assign co2 and trace gases amount (units are parts/part by volumn)
!
   REAL,PARAMETER :: co2=300.e-6
!
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!*** FOR RRTM LONGWAVE
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
! Parameters

      INTEGER, PRIVATE :: IDATA
      INTEGER, PARAMETER :: MG=16 
      INTEGER, PARAMETER :: NBANDS=16
      INTEGER, PARAMETER :: NGPT=140
      INTEGER, PARAMETER :: NG1=8
      INTEGER, PARAMETER :: NG2=14
      INTEGER, PARAMETER :: NG3=16
      INTEGER, PARAMETER :: NG4=14
      INTEGER, PARAMETER :: NG5=16 
      INTEGER, PARAMETER :: NG6=8
      INTEGER, PARAMETER :: NG7=12
      INTEGER, PARAMETER :: NG8=8
      INTEGER, PARAMETER :: NG9=12
      INTEGER, PARAMETER :: NG10=6 
      INTEGER, PARAMETER :: NG11=8
      INTEGER, PARAMETER :: NG12=8
      INTEGER, PARAMETER :: NG13=4
      INTEGER, PARAMETER :: NG14=2
      INTEGER, PARAMETER :: NG15=2
      INTEGER, PARAMETER :: NG16=2
      INTEGER, PARAMETER :: MAXINPX=35
      INTEGER, PARAMETER :: MAXXSEC=4

      INTEGER, PARAMETER :: NMOL = 6
      REAL, PARAMETER :: ONEMINUS = 1. - 1.E-6

! var

      REAL    , SAVE    :: FLUXFAC
      INTEGER , SAVE    :: NLAYERS
!
! data 1
!
      REAL,SAVE ::  abscoefL1(5,13,MG),    abscoefH1(5,13:59,MG),   &
                    SELFREF1(10,MG)
      REAL,SAVE ::  abscoefL2(5,13,MG),    abscoefH2(5,13:59,MG),   &
                    SELFREF2(10,MG)
      REAL,SAVE ::  abscoefL3(10,5,13,MG), abscoefH3(5,5,13:59,MG), &
                    SELFREF3(10,MG)
      REAL,SAVE ::  abscoefL4(9,5,13,MG),  abscoefH4(6,5,13:59,MG), &
                    SELFREF4(10,MG)
      REAL,SAVE ::  abscoefL5(9,5,13,MG),  abscoefH5(5,5,13:59,MG), &
                    SELFREF5(10,MG)
      REAL,SAVE ::  abscoefL6(5,13,MG),    SELFREF6(10,MG)
      REAL,SAVE ::  abscoefL7(9,5,13,MG),  abscoefH7(5,13:59,MG),   &
                    SELFREF7(10,MG)
      REAL,SAVE ::  abscoefL8(5,7,MG),     abscoefH8(5,7:59,MG),    &
                    SELFREF8(10,MG)
      REAL,SAVE ::  abscoefL9(11,5,13,MG), abscoefH9(5,13:59,MG),   &
                    SELFREF9(10,MG)
      REAL,SAVE ::  abscoefL10(5,13,MG),   abscoefH10(5,13:59,MG)  
      REAL,SAVE ::  abscoefL11(5,13,MG),   abscoefH11(5,13:59,MG),  &
                    SELFREF11(10,MG)
      REAL,SAVE ::  abscoefL12(9,5,13,MG), SELFREF12(10,MG)
      REAL,SAVE ::  abscoefL13(9,5,13,MG), SELFREF13(10,MG)
      REAL,SAVE ::  abscoefL14(5,13,MG),   abscoefH14(5,13:59,MG),  &
                    SELFREF14(10,MG)
      REAL,SAVE ::  abscoefL15(9,5,13,MG), SELFREF15(10,MG)
      REAL,SAVE ::  abscoefL16(9,5,13,MG), SELFREF16(10,MG)

!
! data 2
!
      INTEGER,SAVE ::  NGM(MG*NBANDS), NGC(NBANDS), NGS(NBANDS),       &
                    NGN(NGPT), NGB(NGPT)
      REAL,SAVE ::  WT(MG)
!
! data 3
!
      REAL,SAVE ::  FRACREFA1(MG), FRACREFB1(MG), FORREF1(MG)   
      REAL,SAVE ::  FRACREFA2(MG,13), FRACREFB2(MG), FORREF2(MG)
      REAL,SAVE ::  FRACREFA3(MG,10), FRACREFB3(MG,5)        
      REAL,SAVE ::  FORREF3(MG), ABSN2OA3(MG), ABSN2OB3(MG)   
      REAL,SAVE ::  FRACREFA4(MG,9), FRACREFB4(MG,6)        
      REAL,SAVE ::  FRACREFA5(MG,9), FRACREFB5(MG,5), CCL45(MG) 
      REAL,SAVE ::  FRACREFA6(MG), ABSCO26(MG), CFC11ADJ6(MG), CFC126(MG)    
      REAL,SAVE ::  FRACREFA7(MG,9), FRACREFB7(MG), ABSCO27(MG)        
      REAL,SAVE ::  FRACREFA8(MG), FRACREFB8(MG), ABSCO2A8(MG), ABSCO2B8(MG)
      REAL,SAVE ::  ABSN2OA8(MG), ABSN2OB8(MG), CFC128(MG), CFC22ADJ8(MG)  
      REAL,SAVE ::  FRACREFA9(MG,9), FRACREFB9(MG), ABSN2O9(3*MG)
      REAL,SAVE ::  FRACREFA10(MG), FRACREFB10(MG)        
      REAL,SAVE ::  FRACREFA11(MG), FRACREFB11(MG)        
      REAL,SAVE ::  FRACREFA12(MG,9)        
      REAL,SAVE ::  FRACREFA13(MG,9)        
      REAL,SAVE ::  FRACREFA14(MG), FRACREFB14(MG)
      REAL,SAVE ::  FRACREFA15(MG,9)
      REAL,SAVE ::  FRACREFA16(MG,9)
!
! data 4
!
      INTEGER,SAVE :: NXMOL, IXINDX(MAXINPX)

! data 5 

      REAL,SAVE    :: WAVENUM1(NBANDS),WAVENUM2(NBANDS),DELWAVE(NBANDS)

! data 6

      INTEGER,SAVE :: NG(NBANDS),NSPA(NBANDS),NSPB(NBANDS)
      REAL,   SAVE :: HEATFAC
      REAL,   SAVE :: PREF(59),PREFLOG(59),TREF(59)

! data 7 

      REAL,   SAVE :: TOTPLNK(181,NBANDS), TOTPLK16(181)

! data

      REAL,    SAVE :: TAU(0:5000),TF(0:5000),TRANS(0:5000)
!
      REAL,    SAVE :: ABSA1(5*13,NG1), ABSB1(5*(59-13+1),NG1),         &
                       SELFREFC1(10,NG1), FORREFC1(NG1)
      REAL,    SAVE :: ABSA2(5*13,NG2), ABSB2(5*(59-13+1),NG2),         &
                       SELFREFC2(10,NG2), FORREFC2(NG2)
      REAL,    SAVE :: ABSA3(10*5*13,NG3), ABSB3(5*5*(59-13+1),NG3),    &     
                       SELFREFC3(10,NG3), FORREFC3(NG3),                &
                       ABSN2OAC3(NG3), ABSN2OBC3(NG3)        
      REAL,    SAVE :: ABSA4(9*5*13,NG4), ABSB4(6*5*(59-13+1),NG4),     &
                       SELFREFC4(10,NG4)        
      REAL,    SAVE :: ABSA5(9*5*13,NG5), ABSB5(5*5*(59-13+1),NG5),     &
                       SELFREFC5(10,NG5), CCL4C5(NG5)        
      REAL,    SAVE :: ABSA6(5*13,NG6), SELFREFC6(10,NG6),              &        
                       ABSCO2C6(NG6), CFC11ADJC6(NG6), CFC12C6(NG6)  
      REAL,    SAVE :: ABSA7(9*5*13,NG7), ABSB7(5*(59-13+1),NG7),       &  
                       SELFREFC7(10,NG7), ABSCO2C7(NG7)        
      REAL,    SAVE :: ABSA8(5*7,NG8), ABSB8(5*(59-7+1),NG8),           &
                       SELFREFC8(10,NG8),                               &
                       ABSCO2AC8(NG8), ABSCO2BC8(NG8),                  &
                       ABSN2OAC8(NG8), ABSN2OBC8(NG8),                  &       
                       CFC12C8(NG8), CFC22ADJC8(NG8)      
      REAL,    SAVE :: ABSA9(11*5*13,NG9), ABSB9(5*(59-13+1),NG9),      &
                       SELFREFC9(10,NG9), ABSN2OC9(3*NG9)
      REAL,    SAVE :: ABSA10(5*13,NG10), ABSB10(5*(59-13+1),NG10)
      REAL,    SAVE :: ABSA11(5*13,NG11), ABSB11(5*(59-13+1),NG11),     &
                       SELFREFC11(10,NG11)
      REAL,DIMENSION(9*5*13,NG12),SAVE :: ABSA12
      REAL,DIMENSION(10,NG12),SAVE :: SELFREFC12
      REAL,    SAVE :: ABSA13(9*5*13,NG13), SELFREFC13(10,NG13)
      REAL,    SAVE :: ABSA14(5*13,NG14), ABSB14(5*(59-13+1),NG14),    &
                       SELFREFC14(10,NG14)
      REAL,    SAVE :: ABSA15(9*5*13,NG15), SELFREFC15(10,NG15)
      REAL,    SAVE :: ABSA16(9*5*13,NG16), SELFREFC16(10,NG16)

      REAL,    SAVE :: FRACREFAC1(NG1), FRACREFBC1(NG1)
      REAL,    SAVE :: FRACREFAC2(NG2,13), FRACREFBC2(NG2)
      REAL,    SAVE :: FRACREFAC3(NG3,10), FRACREFBC3(NG3,5)
      REAL,    SAVE :: FRACREFAC4(NG4,9), FRACREFBC4(NG4,6)
      REAL,    SAVE :: FRACREFAC5(NG5,9), FRACREFBC5(NG5,5)      
      REAL,    SAVE :: FRACREFAC6(NG6)                              
      REAL,    SAVE :: FRACREFAC7(NG7,9), FRACREFBC7(NG7)    
      REAL,    SAVE :: FRACREFAC8(NG8), FRACREFBC8(NG8)  
      REAL,    SAVE :: FRACREFAC9(NG9,9), FRACREFBC9(NG9)      
      REAL,    SAVE :: FRACREFAC10(NG10), FRACREFBC10(NG10)       
      REAL,    SAVE :: FRACREFAC11(NG11), FRACREFBC11(NG11)  
      REAL,    SAVE :: FRACREFAC12(NG12,9)                     
      REAL,    SAVE :: FRACREFAC13(NG13,9)           
      REAL,    SAVE :: FRACREFAC14(NG14), FRACREFBC14(NG14)    
      REAL,    SAVE :: FRACREFAC15(NG15,9)                      
      REAL,    SAVE :: FRACREFAC16(NG16,9)                 
      
      REAL,    SAVE :: CORR1(0:200),CORR2(0:200)
      REAL,    SAVE :: BPADE
      REAL,    SAVE :: RWGT(MG*NBANDS)

!----------------------------------------------------------------------------
!
! start data 2
                                                                                 
!     Arrays for the g-point reduction from 256 to 140 for the 16 LW bands:      
!     This mapping from 256 to 140 points has been carefully selected to         
!     minimize the effect on the resulting fluxes and cooling rates, and         
!     caution should be used if the mapping is modified.                         
!                                                                                
!     NGPT    The total number of new g-points                                   
!     NGC     The number of new g-points in each band                            
!     NGM     The index of each new g-point relative to the original             
!             16 g-points for each band.                                         
!     NGN     The number of original g-points that are combined to make          
!             each new g-point in each band.                                     
!     NGB     The band index for each new g-point.                               
!     WT      RRTM weights for 16 g-points.                                      
                                                                                 
! Data Statements                                                                
      DATA NGC  /8,14,16,14,16,8,12,8,12,6,8,8,4,2,2,2/                          
      DATA NGS  /8,22,38,52,68,76,88,96,108,114,122,130,134,136,138,140/         
      DATA NGM  /1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8, &             ! Band 1            
                 1,2,3,4,5,6,7,8,9,10,11,12,13,13,14,14, &      ! Band 2            
                 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16, &      ! Band 3            
                 1,2,3,4,5,6,7,8,9,10,11,12,13,14,14,14, &      ! Band 4            
                 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16, &      ! Band 5            
                 1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8, &             ! Band 6            
                 1,1,2,2,3,4,5,6,7,8,9,10,11,11,12,12, &        ! Band 7            
                 1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8, &             ! Band 8            
                 1,2,3,4,5,6,7,8,9,9,10,10,11,11,12,12, &       ! Band 9            
                 1,1,2,2,3,3,4,4,5,5,5,5,6,6,6,6, &             ! Band 10           
                 1,2,3,3,4,4,5,5,6,6,7,7,7,8,8,8, &             ! Band 11           
                 1,2,3,4,5,5,6,6,7,7,7,7,8,8,8,8, &             ! Band 12           
                 1,1,1,2,2,2,3,3,3,3,4,4,4,4,4,4, &             ! Band 13           
                 1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2, &             ! Band 14           
                 1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2, &             ! Band 15           
                 1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2/               ! Band 16           
      DATA NGN  /2,2,2,2,2,2,2,2, &                             ! Band 1            
                 1,1,1,1,1,1,1,1,1,1,1,1,2,2, &                 ! Band 2            
                 16*1, &                                        ! Band 3            
                 1,1,1,1,1,1,1,1,1,1,1,1,1,3, &                 ! Band 4            
                 16*1, &                                        ! Band 5            
                 2,2,2,2,2,2,2,2, &                             ! Band 6            
                 2,2,1,1,1,1,1,1,1,1,2,2, &                     ! Band 7            
                 2,2,2,2,2,2,2,2, &                             ! Band 8            
                 1,1,1,1,1,1,1,1,2,2,2,2, &                     ! Band 9            
                 2,2,2,2,4,4, &                                 ! Band 10           
                 1,1,2,2,2,2,3,3, &                             ! Band 11           
                 1,1,1,1,2,2,4,4, &                             ! Band 12           
                 3,3,4,6, &                                     ! Band 13           
                 8,8, &                                         ! Band 14           
                 8,8, &                                         ! Band 15           
                 8,8/                                           ! Band 16           
      DATA NGB  /8*1, &                                         ! Band 1            
                 14*2, &                                        ! Band 2            
                 16*3, &                                        ! Band 3            
                 14*4, &                                        ! Band 4            
                 16*5, &                                        ! Band 5            
                 8*6, &                                         ! Band 6            
                 12*7, &                                        ! Band 7            
                 8*8, &                                         ! Band 8            
                 12*9, &                                        ! Band 9            
                 6*10, &                                        ! Band 10           
                 8*11, &                                        ! Band 11           
                 8*12, &                                        ! Band 12           
                 4*13, &                                        ! Band 13           
                 2*14, &                                        ! Band 14           
                 2*15, &                                        ! Band 15           
                 2*16/                                       ! Band 16           
      DATA WT/ &                                                                  
           0.1527534276,0.1491729617,0.1420961469,0.1316886544, &                   
           0.1181945205,0.1019300893,0.0832767040,0.0626720116, &                   
           0.0424925,0.0046269894,0.0038279891,0.0030260086, &                      
           0.0022199750,0.0014140010,0.000533,0.000075/                          

!
! end of data 2
!
!-----------------------------------------------------------------------

! start data 3

                                                                                 
! Data

      DATA FRACREFA1/ &                                                            
          0.08452097,0.17952873,0.16214369,0.13602182, &                            
          0.12760490,0.10302561,0.08392423,0.06337652, &                            
          0.04206551,0.00487497,0.00410743,0.00344421, &                            
          0.00285731,0.00157327,0.00080648,0.00012406/                           
      DATA FRACREFB1/ &                                                            
          0.15492001,0.17384727,0.15165100,0.12675308, &                            
          0.10986247,0.09006091,0.07584465,0.05990077, &                            
          0.04113461,0.00438638,0.00374754,0.00313924, &                            
          0.00234381,0.00167167,0.00062744,0.00010889/                           
                                                                                 
      DATA FORREF1/   &                                                            
         -4.50470E-02,-1.18908E-01,-7.21730E-02,-2.83862E-02, &                     
         -3.01961E-02,-1.56877E-02,-1.53684E-02,-1.29135E-02, &                     
         -1.27963E-02,-1.81742E-03, 4.40008E-05, 1.05260E-02, &                     
          2.17290E-02, 1.65571E-02, 7.60751E-02, 1.47405E-01/                    

                                                                                 
! Data                                                                           
                                                                                 
!     The ith set of reference fractions are from the ith reference              
!     pressure level.                                                            

      DATA FRACREFA2/ &
          0.18068060,0.16803175,0.15140158,0.12221480, 0.10240850,0.09330297,0.07518960,0.05611294, &
          0.03781487,0.00387192,0.00321285,0.00244440, 0.00179546,0.00107704,0.00038798,0.00005060, &
          0.17927621,0.16731168,0.15129538,0.12328085, 0.10243484,0.09354796,0.07538418,0.05633071, &
          0.03810832,0.00398347,0.00320262,0.00250029, 0.00178666,0.00111127,0.00039438,0.00005169, &
          0.17762886,0.16638555,0.15115446,0.12470623, 0.10253213,0.09383459,0.07560240,0.05646568, &
          0.03844077,0.00409142,0.00322521,0.00254918, 0.00179296,0.00113652,0.00040169,0.00005259, &
          0.17566043,0.16539773,0.15092199,0.12571971, 0.10340609,0.09426189,0.07559051,0.05678188, &
          0.03881499,0.00414102,0.00328551,0.00258795, 0.00181648,0.00115145,0.00040969,0.00005357, &
          0.17335825,0.16442548,0.15070701,0.12667464, 0.10452303,0.09450833,0.07599410,0.05706393, &
          0.03910370,0.00417880,0.00335256,0.00261708, 0.00185491,0.00116627,0.00041759,0.00005464, &
          0.17082544,0.16321516,0.15044247,0.12797612, 0.10574646,0.09470057,0.07647423,0.05738756, &
          0.03935621,0.00423789,0.00342651,0.00264549, 0.00190188,0.00118281,0.00042592,0.00005583, &
          0.16809277,0.16193336,0.15013184,0.12937409, 0.10720784,0.09485368,0.07692636,0.05771774, &
          0.03966988,0.00427754,0.00349696,0.00268946, 0.00193536,0.00120222,0.00043462,0.00005712, &
          0.16517997,0.16059248,0.14984852,0.13079269, 0.10865030,0.09492947,0.07759736,0.05812201, &
          0.03997169,0.00432356,0.00355308,0.00274031, 0.00197243,0.00122401,0.00044359,0.00005849, &
          0.16209179,0.15912023,0.14938223,0.13198245, 0.11077233,0.09487948,0.07831636,0.05863440, &
          0.04028239,0.00436804,0.00360407,0.00279885, 0.00200364,0.00124861,0.00045521,0.00005996, &
          0.15962425,0.15789343,0.14898103,0.13275230, 0.11253940,0.09503502,0.07884382,0.05908009, &
          0.04053524,0.00439971,0.00364269,0.00284965, 0.00202758,0.00127076,0.00046408,0.00006114, &
          0.15926200,0.15770932,0.14891729,0.13283882, 0.11276010,0.09507311,0.07892222,0.05919230, &
          0.04054824,0.00440833,0.00365575,0.00286459, 0.00203786,0.00128405,0.00046504,0.00006146, &
          0.15926351,0.15770483,0.14891177,0.13279966, 0.11268171,0.09515216,0.07890341,0.05924807, &
          0.04052851,0.00440870,0.00365425,0.00286878, 0.00205747,0.00128916,0.00046589,0.00006221, &
          0.15937765,0.15775780,0.14892603,0.13273248, 0.11252731,0.09521657,0.07885858,0.05927679, &
          0.04050184,0.00440285,0.00365748,0.00286791, 0.00207507,0.00129193,0.00046679,0.00006308/
!     From P = 0.432 mb.                                                         
      DATA FRACREFB2/ &                                                             
          0.17444289,0.16467269,0.15021490,0.12460902, &                         
          0.10400643,0.09481928,0.07590704,0.05752856, &                         
          0.03931715,0.00428572,0.00349352,0.00278938, &                         
          0.00203448,0.00130037,0.00051560,0.00006255/                           
                                                                                 
      DATA FORREF2/ &                                                               
         -2.34550E-03,-8.42698E-03,-2.01816E-02,-5.66701E-02, &                  
         -8.93189E-02,-6.37487E-02,-4.56455E-02,-4.41417E-02, &                  
         -4.48605E-02,-4.74696E-02,-5.16648E-02,-5.63099E-02, &                  
         -4.74781E-02,-3.84704E-02,-2.49905E-02, 2.02114E-03/                    
                                                                                 
! Data                                                                           
                                                                                 
      DATA FRACREFA3/ &                                                             
!     From P = 1053.6 mb.                                                        
          0.15116400,0.14875700,0.14232300,0.13234501, 0.11881600,0.10224100,0.08345580,0.06267490, &                         
          0.04250650,0.00462650,0.00382259,0.00302600, 0.00222004,0.00141397,0.00053379,0.00007421, &                         
          0.15266000,0.14888400,0.14195900,0.13179500, 0.11842700,0.10209000,0.08336130,0.06264370, &                         
          0.04247660,0.00461946,0.00381536,0.00302601, 0.00222004,0.00141397,0.00053302,0.00007498, &                         
          0.15282799,0.14903000,0.14192399,0.13174300, 0.11835300,0.10202700,0.08329830,0.06264830, &                         
          0.04246910,0.00460242,0.00381904,0.00301573, 0.00222004,0.00141397,0.00053379,0.00007421, &                         
          0.15298399,0.14902800,0.14193401,0.13173500, 0.11833300,0.10195800,0.08324730,0.06264770, &                         
          0.04246490,0.00460489,0.00381123,0.00301893, 0.00221093,0.00141397,0.00053379,0.00007421, &                         
          0.15307599,0.14907201,0.14198899,0.13169800, 0.11827300,0.10192300,0.08321600,0.06263490, &                         
          0.04245600,0.00460846,0.00380836,0.00301663, 0.00221402,0.00141167,0.00052807,0.00007376, &                         
          0.15311401,0.14915401,0.14207301,0.13167299, 0.11819300,0.10188900,0.08318760,0.06261960, &                         
          0.04243890,0.00461584,0.00380929,0.00300815, 0.00221736,0.00140588,0.00052776,0.00007376, &                         
          0.15316001,0.14925499,0.14213000,0.13170999, 0.11807700,0.10181400,0.08317400,0.06260300, &                         
          0.04242720,0.00461520,0.00381381,0.00301285, 0.00220275,0.00140371,0.00052776,0.00007376, &                         
          0.15321200,0.14940999,0.14222500,0.13164200, 0.11798200,0.10174500,0.08317500,0.06253640, &                         
          0.04243130,0.00461724,0.00381534,0.00300320, 0.00220091,0.00140364,0.00052852,0.00007300, &                         
          0.15312800,0.14973100,0.14234400,0.13168900, 0.11795200,0.10156100,0.08302990,0.06252240, &                         
          0.04240980,0.00461035,0.00381381,0.00300176, 0.00220160,0.00140284,0.00052774,0.00007376, &                         
          0.15292500,0.14978001,0.14242400,0.13172600, 0.11798800,0.10156400,0.08303050,0.06251670, &                         
          0.04240970,0.00461302,0.00381452,0.00300250, 0.00220126,0.00140324,0.00052850,0.00007300/                           
      DATA FRACREFB3/ &                                                             
!     From P = 64.1 mb.                                                          
          0.16340201,0.15607700,0.14601400,0.13182700, &                         
          0.11524700,0.09666570,0.07825360,0.05849780, &                         
          0.03949650,0.00427980,0.00353719,0.00279303, &                         
          0.00204788,0.00130139,0.00049055,0.00006904, &                         
          0.15762900,0.15494700,0.14659800,0.13267800, &                         
          0.11562700,0.09838360,0.07930420,0.05962700, &                         
          0.04036360,0.00438053,0.00361463,0.00285723, &                         
          0.00208345,0.00132135,0.00050528,0.00008003, &                         
          0.15641500,0.15394500,0.14633600,0.13180400, &                         
          0.11617100,0.09924170,0.08000510,0.06021420, &                         
          0.04082730,0.00441694,0.00365364,0.00287723, &                         
          0.00210914,0.00135784,0.00054651,0.00008003, &                         
          0.15482700,0.15286300,0.14392500,0.13244100, &                         
          0.11712000,0.09994920,0.08119200,0.06104360, &                         
          0.04135600,0.00446685,0.00368377,0.00290767, &                         
          0.00215445,0.00142865,0.00056142,0.00008003, &                         
          0.15975100,0.15653500,0.14214399,0.12892200, &                         
          0.11508400,0.09906020,0.08087940,0.06078190, &                         
          0.04140530,0.00452724,0.00374558,0.00295328, &                         
          0.00218509,0.00138644,0.00056018,0.00008003/                           
                                                                                 
      DATA ABSN2OA3/ &                                                              
          1.50387E-01,2.91407E-01,6.28803E-01,9.65619E-01, &                     
          1.15054E-00,2.23424E-00,1.83392E-00,1.39033E-00, &                     
          4.28457E-01,2.73502E-01,1.84307E-01,1.61325E-01, &                     
          7.66314E-02,1.33862E-01,6.71196E-07,1.59293E-06/                       
      DATA ABSN2OB3/ &                                                              
          9.37044E-05,1.23318E-03,7.91720E-03,5.33005E-02, &                     
          1.72343E-01,4.29571E-01,1.01288E+00,3.83863E+00, &                     
          1.15312E+01,1.08383E+00,2.24847E+00,1.51268E+00, &                     
          3.33177E-01,7.82102E-01,3.44631E-01,1.61039E-03/                       
      DATA FORREF3/ &                                                               
          1.76842E-04, 1.77913E-04, 1.25186E-04, 1.07912E-04, &                  
          1.05217E-04, 7.48726E-05, 1.11701E-04, 7.68921E-05, &                  
          9.87242E-05, 9.85711E-05, 6.16557E-05,-1.61291E-05, &                  
         -1.26794E-04,-1.19011E-04,-2.67814E-04, 6.95005E-05/                    
                                                                                 
! Data                                                                           
                                                                                 
      DATA FRACREFA4/ &                                                             
!     From P =                                                                   
          0.15579100,0.14918099,0.14113800,0.13127001, &                         
          0.11796300,0.10174300,0.08282370,0.06238150, &                         
          0.04213440,0.00458968,0.00377949,0.00298736, &                         
          0.00220743,0.00140644,0.00053024,0.00007459, &                         
          0.15292799,0.15004000,0.14211500,0.13176700, &                         
          0.11821100,0.10186300,0.08288040,0.06241390, &                         
          0.04220720,0.00459006,0.00377919,0.00298743, &                         
          0.00220743,0.00140644,0.00053024,0.00007459, &                         
          0.14386199,0.15125300,0.14650001,0.13377000, &                         
          0.11895900,0.10229400,0.08312110,0.06239520, &                         
          0.04225560,0.00459428,0.00378865,0.00298860, &                         
          0.00220743,0.00140644,0.00053024,0.00007459, &                         
          0.14359100,0.14561599,0.14479300,0.13740200, &                         
          0.12150100,0.10315400,0.08355480,0.06247240, &                         
          0.04230980,0.00459916,0.00378373,0.00300063, &                         
          0.00221111,0.00140644,0.00053024,0.00007459, &                         
          0.14337599,0.14451601,0.14238000,0.13520500, &                         
          0.12354200,0.10581200,0.08451810,0.06262440, &                         
          0.04239590,0.00460297,0.00378701,0.00300466, &                         
          0.00221899,0.00141020,0.00053024,0.00007459, &                         
          0.14322001,0.14397401,0.14117201,0.13401900, &                         
          0.12255500,0.10774100,0.08617650,0.06296420, &                         
          0.04249590,0.00463406,0.00378241,0.00302037, &                         
          0.00221583,0.00141103,0.00053814,0.00007991, &                         
          0.14309500,0.14364301,0.14043900,0.13348100, &                         
          0.12211600,0.10684700,0.08820590,0.06374610, &                         
          0.04264730,0.00464231,0.00384022,0.00303427, &                         
          0.00221825,0.00140943,0.00055564,0.00007991, &                         
          0.15579100,0.14918099,0.14113800,0.13127001, &                         
          0.11796300,0.10174300,0.08282370,0.06238150, &                         
          0.04213440,0.00458968,0.00377949,0.00298736, &                         
          0.00220743,0.00140644,0.00053024,0.00007459, &                         
          0.15937001,0.15159500,0.14242800,0.13078900, &                         
          0.11671300,0.10035700,0.08143450,0.06093850, &                         
          0.04105320,0.00446233,0.00369844,0.00293784, &                         
          0.00216425,0.00143403,0.00054571,0.00007991/                           
      DATA FRACREFB4/ &                                                             
!     From P = 1.17 mb.                                                          
          0.15558299,0.14930600,0.14104301,0.13124099, &                         
          0.11792900,0.10159200,0.08314130,0.06240450, &                         
          0.04217020,0.00459313,0.00379798,0.00299835, &                         
          0.00218950,0.00140615,0.00053010,0.00007457, &                         
          0.15592700,0.14918999,0.14095700,0.13115700, &                         
          0.11788900,0.10158000,0.08313780,0.06240240, &                         
          0.04217000,0.00459313,0.00379798,0.00299835, &                         
          0.00218950,0.00140615,0.00053010,0.00007457, &                         
          0.15949000,0.15014900,0.14162201,0.13080800, &                         
          0.11713500,0.10057100,0.08170080,0.06128110, &                         
          0.04165600,0.00459202,0.00379835,0.00299717, &                         
          0.00218958,0.00140616,0.00053010,0.00007457, &                         
          0.15967900,0.15038200,0.14196999,0.13074800, &                         
          0.11701700,0.10053000,0.08160790,0.06122690, &                         
          0.04128310,0.00456598,0.00379486,0.00299457, &                         
          0.00219016,0.00140619,0.00053011,0.00007456, &                         
          0.15989800,0.15057300,0.14207700,0.13068600, &                         
          0.11682900,0.10053900,0.08163610,0.06121870, &                         
          0.04121690,0.00449061,0.00371235,0.00294207, &                         
          0.00217778,0.00139877,0.00053011,0.00007455, &                         
          0.15950100,0.15112500,0.14199100,0.13071300, &                         
          0.11680800,0.10054600,0.08179050,0.06120910, &                         
          0.04126050,0.00444324,0.00366843,0.00289369, &                         
          0.00211550,0.00134746,0.00050874,0.00007863/                           
                                                                                 
! Data                                                                           
                                                                                 
      DATA FRACREFA5/ &                                                             
!     From P = 387.6 mb.                                                         
          0.13966499,0.14138900,0.13763399,0.13076700, &                         
          0.12299100,0.10747700,0.08942000,0.06769200, &                         
          0.04587610,0.00501173,0.00415809,0.00328398, &                         
          0.00240015,0.00156222,0.00059104,0.00008323, &                         
          0.13958199,0.14332899,0.13785399,0.13205400, &                         
          0.12199700,0.10679600,0.08861080,0.06712320, &                         
          0.04556030,0.00500863,0.00416315,0.00328629, &                         
          0.00240023,0.00156220,0.00059104,0.00008323, &                         
          0.13907100,0.14250501,0.13889600,0.13297300, &                         
          0.12218700,0.10683800,0.08839260,0.06677310, &                         
          0.04538570,0.00495402,0.00409863,0.00328219, &                         
          0.00240805,0.00156266,0.00059104,0.00008323, &                         
          0.13867700,0.14190100,0.13932300,0.13327099, &                         
          0.12280800,0.10692500,0.08844510,0.06658510, &                         
          0.04519340,0.00492276,0.00408832,0.00323856, &                         
          0.00239289,0.00155698,0.00059104,0.00008323, &                         
          0.13845000,0.14158800,0.13929300,0.13295600, &                         
          0.12348300,0.10736700,0.08859480,0.06650610, &                         
          0.04498230,0.00491335,0.00406968,0.00322901, &                         
          0.00234666,0.00155235,0.00058813,0.00008323, &                         
          0.13837101,0.14113200,0.13930500,0.13283101, &                         
          0.12349200,0.10796400,0.08890490,0.06646480, &                         
          0.04485990,0.00489554,0.00405264,0.00320313, &                         
          0.00234742,0.00151159,0.00058438,0.00008253, &                         
          0.13834500,0.14093500,0.13896500,0.13262001, &                         
          0.12326900,0.10828900,0.08950050,0.06674610, &                         
          0.04476560,0.00489624,0.00400962,0.00317423, &                         
          0.00233479,0.00148249,0.00058590,0.00008253, &                         
          0.13831300,0.14069000,0.13871400,0.13247600, &                         
          0.12251400,0.10831300,0.08977090,0.06776920, &                         
          0.04498390,0.00484111,0.00398948,0.00316069, &                         
          0.00229741,0.00150104,0.00058608,0.00008253, &                         
          0.14027201,0.14420401,0.14215700,0.13446601, &                         
          0.12303700,0.10596100,0.08650370,0.06409570, &                         
          0.04312310,0.00471110,0.00393954,0.00310850, &                         
          0.00229588,0.00146366,0.00058194,0.00008253/                           
      DATA FRACREFB5/ &                                                             
!     From P = 1.17 mb.                                                          
          0.14339100,0.14358699,0.13935301,0.13306700, &                         
          0.12135700,0.10590600,0.08688240,0.06553220, &                         
          0.04446740,0.00483580,0.00399413,0.00316225, &                         
          0.00233007,0.00149135,0.00056246,0.00008059, &                         
          0.14330500,0.14430299,0.14053699,0.13355300, &                         
          0.12151200,0.10529100,0.08627630,0.06505230, &                         
          0.04385850,0.00476555,0.00395010,0.00313878, &                         
          0.00232273,0.00149354,0.00056246,0.00008059, &                         
          0.14328399,0.14442700,0.14078601,0.13390100, &                         
          0.12132600,0.10510600,0.08613660,0.06494630, &                         
          0.04381310,0.00475378,0.00394166,0.00313076, &                         
          0.00231235,0.00149159,0.00056301,0.00008059, &                         
          0.14326900,0.14453100,0.14114200,0.13397101, &                         
          0.12127200,0.10493400,0.08601380,0.06483360, &                         
          0.04378900,0.00474655,0.00393549,0.00312583, &                         
          0.00230686,0.00148433,0.00056502,0.00008059, &                         
          0.14328900,0.14532700,0.14179000,0.13384600, &                         
          0.12093700,0.10461500,0.08573010,0.06461340, &                         
          0.04366570,0.00473087,0.00392539,0.00311238, &                         
          0.00229865,0.00147572,0.00056517,0.00007939/                           
                                                                                 
      DATA CCL45/ &                                                                 
           26.1407,  53.9776,  63.8085,  36.1701, &                              
           15.4099, 10.23116,  4.82948,  5.03836, &                              
           1.75558,0.,0.,0., &                                                   
           0.,0.,0.,0./                                                          
                                                                                 
! Data                                                                           
                                                                                 
      DATA FRACREFA6/ &                                                             
!     From P = 706 mb.                                                           
          0.13739009,0.14259538,0.14033118,0.13547136, &                         
          0.12569460,0.11028396,0.08626066,0.06245148, &                         
          0.04309394,0.00473551,0.00403920,0.00321695, &                         
          0.00232470,0.00147662,0.00056095,0.00007373/                           
                                                                                 
      DATA CFC11ADJ6/ &                                                             
           0.,  0., 36.7627,  150.757,   &                                      
           81.4109, 74.9112, 56.9325, 49.3226, &                                 
           57.1074, 66.1202, 109.557, 89.0562, &                                 
           149.865, 196.140, 258.393, 80.9923/                                   
      DATA CFC126/ &                                                                
           62.8368, 43.2626, 26.7549, 22.2487, &                                 
           23.5029, 34.8323, 26.2335, 23.2306, &                                 
           18.4062, 13.9534, 22.6268, 24.2604, &                                 
           30.0088, 26.3634, 15.8237, 57.5050/                                   
      DATA ABSCO26/ &                                                               
           7.44852E-05, 6.29208E-05, 7.34031E-05, 6.65218E-05, &                 
           7.87511E-05, 1.22489E-04, 3.39785E-04, 9.33040E-04, &                 
           1.54323E-03, 4.07220E-04, 4.34332E-04, 8.76418E-05, &                 
           9.80381E-05, 3.51680E-05, 5.31766E-05, 1.01542E-05/                   
                                                                                 
! Data                                                                           
                                                                                 
      DATA FRACREFA7/ &                                                             
          0.16461779, 0.14889984, 0.14233345, 0.13156526, &                      
          0.11679733, 0.09988949, 0.08078653, 0.06006384, &                      
          0.04028391, 0.00435899, 0.00359173, 0.00281707, &                      
          0.00206767, 0.00135012, 0.00050720, 0.00007146, &                      
          0.16442357, 0.14944240, 0.14245804, 0.13111183, &                      
          0.11688625, 0.09983791, 0.08085148, 0.05993948, &                      
          0.04028057, 0.00435939, 0.00358708, 0.00284036, &                      
          0.00208869, 0.00133256, 0.00049260, 0.00006931, &                      
          0.16368519, 0.15018989, 0.14262174, 0.13084342, &                      
          0.11682195, 0.09996257, 0.08074036, 0.05985692, &                      
          0.04045362, 0.00436208, 0.00358257, 0.00287122, &                      
          0.00211004, 0.00133804, 0.00049260, 0.00006931, &                      
          0.16274056, 0.15133780, 0.14228874, 0.13081114, &                      
          0.11688486, 0.09979610, 0.08073687, 0.05996741, &                      
          0.04040616, 0.00439869, 0.00368910, 0.00293041, &                      
          0.00211604, 0.00133536, 0.00049260, 0.00006931, &                      
          0.16176532, 0.15207882, 0.14226955, 0.13079646, &                      
          0.11688191, 0.09966998, 0.08066384, 0.06020275, &                      
          0.04047901, 0.00446696, 0.00377456, 0.00294410, &                      
          0.00211082, 0.00133536, 0.00049260, 0.00006931, &                      
          0.15993737, 0.15305527, 0.14259829, 0.13078023, &                      
          0.11686983, 0.09980131, 0.08058286, 0.06031430, &                      
          0.04082833, 0.00450509, 0.00377574, 0.00294823, &                      
          0.00210977, 0.00133302, 0.00049260, 0.00006931, &                      
          0.15371189, 0.15592396, 0.14430280, 0.13076764, &                      
          0.11720382, 0.10023471, 0.08066396, 0.06073554, &                      
          0.04121581, 0.00451202, 0.00377832, 0.00294609, &                      
          0.00210943, 0.00133336, 0.00049260, 0.00006931, &                      
          0.14262275, 0.14572631, 0.14560597, 0.13736825, &                      
          0.12271351, 0.10419556, 0.08294533, 0.06199794, &                      
          0.04157615, 0.00452842, 0.00377704, 0.00293852, &                      
          0.00211034, 0.00133278, 0.00049259, 0.00006931, &                      
          0.14500433, 0.14590444, 0.14430299, 0.13770708, &                      
          0.12288283, 0.10350952, 0.08269450, 0.06130579, &                      
          0.04144571, 0.00452096, 0.00377382, 0.00294532, &                      
          0.00210943, 0.00133228, 0.00049260, 0.00006931/                        
      DATA FRACREFB7/ &                                                             
          0.15355594,0.15310939,0.14274909,0.13129812, &                         
          0.11736792,0.10118213,0.08215259,0.06165591, &                         
          0.04164486,0.00451141,0.00372837,0.00294095, &                         
          0.00215259,0.00136792,0.00051233,0.00007075/                           
                                                                                 
      DATA ABSCO27/ &                                                               
          9.30038E-05, 1.74061E-04, 2.09293E-04, 2.52360E-04, &                  
          3.13404E-04, 4.16619E-04, 6.27394E-04, 1.29386E-03, &                  
          4.05192E-03, 3.97050E-03, 7.00634E-04, 6.06617E-04, &                  
          7.66978E-04, 6.70661E-04, 7.89971E-04, 7.55709E-04/                    
                                                                                 
! Data                                                                           
                                                                                 
      DATA FRACREFA8/ &                                                             
!     From P = 1053.6 mb.                                                        
          0.15309700,0.15450300,0.14458799,0.13098200, &                         
          0.11817900,0.09953490,0.08132080,0.06139960, &                         
          0.04132010,0.00446788,0.00372533,0.00294053, &                         
          0.00211371,0.00128122,0.00048050,0.00006759/                           
      DATA FRACREFB8/ &                                                             
!     From P = 28.9 mb.                                                          
          0.14105400,0.14728899,0.14264800,0.13331699, &                         
          0.12034100,0.10467000,0.08574980,0.06469390, &                         
          0.04394640,0.00481284,0.00397375,0.00315006, &                         
          0.00228636,0.00144606,0.00054604,0.00007697/                           
                                                                                 
      DATA CFC128/ &                                                                
           85.4027, 89.4696, 74.0959, 67.7480, &                                 
           61.2444, 59.9073, 60.8296, 63.0998, &                                 
           59.6110, 64.0735, 57.2622, 58.9721, &                                 
           43.5505, 26.1192, 32.7023, 32.8667/                                   
      DATA CFC22ADJ8/ &                                                             
!     Original CFC22 is multiplied by 1.485 to account for the 780-850 cm-1      
!     and 1290-1335 cm-1 bands.                                                  
           135.335, 89.6642, 76.2375, 65.9748, &                                 
           63.1164, 60.2935, 64.0299, 75.4264, &                                 
           51.3018, 7.07911, 5.86928, 0.398693, &                                
           2.82885, 9.12751, 6.28271, 0./                                        
      DATA ABSCO2A8/ &                                                              
           1.11233E-05, 3.92400E-05, 6.62059E-05, 8.51687E-05, &                 
           7.79035E-05, 1.34058E-04, 2.82553E-04, 5.41741E-04, &                 
           1.47029E-05, 2.34982E-05, 6.91094E-08, 8.48917E-08, &                 
           6.58783E-08, 4.64849E-08, 3.62742E-08, 3.62742E-08/                   
      DATA ABSCO2B8/ &                                                              
           4.10977E-09, 5.65200E-08, 1.70800E-07, 4.16840E-07, &                 
           9.53684E-07, 2.36468E-06, 7.29502E-06, 4.93883E-05, &                 
           5.10440E-04, 9.75248E-04, 1.36495E-03, 2.40451E-03, &                 
           4.50277E-03, 2.24486E-02, 4.06756E-02, 2.17447E-10/                   
      DATA ABSN2OA8/ &                                                              
           1.28527E-02,5.28651E-02,1.01668E-01,1.57224E-01, &                    
           2.76947E-01,4.93048E-01,6.71387E-01,3.48809E-01, &                    
           4.19840E-01,3.13558E-01,2.44432E-01,2.05108E-01, &                    
           1.21423E-01,1.22158E-01,1.49702E-01,1.47799E-01/                      
      DATA ABSN2OB8/ &                                                              
           3.15864E-03,4.87347E-03,8.63235E-03,2.16053E-02, &                    
           3.63699E-02,7.89149E-02,3.53807E-01,1.27140E-00, &                    
           2.31464E-00,7.75834E-02,5.15063E-02,4.07059E-02, &                    
           5.91947E-02,5.83546E-02,3.12716E-01,1.47456E-01/                      
                                                                                 
!  Data                                                                          
                                                                                 
      DATA FRACREFA9/ &                                                             
!     From P = 1053.6 mb.                                                        
          0.16898900,0.15898301,0.13575301,0.12600900, &                         
          0.11545800,0.09879170,0.08106830,0.06063440, &                         
          0.03988780,0.00421760,0.00346635,0.00278779, &                         
          0.00206225,0.00132324,0.00050033,0.00007038, &                         
          0.18209399,0.15315101,0.13571000,0.12504999, &                         
          0.11379100,0.09680810,0.08008570,0.05970280, &                         
          0.03942860,0.00413383,0.00343186,0.00275558, &                         
          0.00204657,0.00130219,0.00045454,0.00005664, &                         
          0.18459500,0.15512000,0.13395500,0.12576801, &                         
          0.11276800,0.09645190,0.07956650,0.05903340, &                         
          0.03887050,0.00412226,0.00339453,0.00273518, &                         
          0.00196922,0.00119411,0.00040263,0.00005664, &                         
          0.18458800,0.15859900,0.13278100,0.12589300, &                         
          0.11272700,0.09599660,0.07903030,0.05843600, &                         
          0.03843400,0.00405181,0.00337980,0.00263818, &                         
          0.00186869,0.00111807,0.00040263,0.00005664, &                         
          0.18459301,0.16176100,0.13235000,0.12528200, &                         
          0.11237100,0.09618840,0.07833760,0.05800770, &                         
          0.03787610,0.00408253,0.00330363,0.00250445, &                         
          0.00176725,0.00111753,0.00040263,0.00005664, &                         
          0.18454400,0.16505300,0.13221300,0.12476600, &                         
          0.11158300,0.09618120,0.07797340,0.05740380, &                         
          0.03742820,0.00392691,0.00312208,0.00246306, &                         
          0.00176735,0.00111721,0.00040263,0.00005664, &                         
          0.18452001,0.16697501,0.13445500,0.12391300, &                         
          0.11059100,0.09596890,0.07761050,0.05643200, &                         
          0.03686520,0.00377086,0.00309351,0.00246297, &                         
          0.00176765,0.00111700,0.00040263,0.00005664, &                         
          0.18460999,0.16854499,0.13922299,0.12266400, &                         
          0.10962200,0.09452030,0.07653800,0.05551340, &                         
          0.03609660,0.00377043,0.00309367,0.00246304, &                         
          0.00176749,0.00111689,0.00040263,0.00005664, &                         
          0.18312500,0.16787501,0.14720701,0.12766500, &                         
          0.10890900,0.08935530,0.07310870,0.05443140, &                         
          0.03566380,0.00376446,0.00309521,0.00246510, &                         
          0.00176139,0.00111543,0.00040263,0.00005664/                           
      DATA FRACREFB9/ &                                                             
!     From P = 0.071 mb.                                                         
          0.20148601,0.15252700,0.13376500,0.12184600, &                         
          0.10767800,0.09307410,0.07674570,0.05876940, &                         
          0.04001480,0.00424612,0.00346896,0.00269954, &                         
          0.00196864,0.00122562,0.00043628,0.00004892/                           
                                                                                 
      DATA ABSN2O9/ &                                                               
!     From P = 952 mb.                                                           
           3.26267E-01,2.42869E-00,1.15455E+01,7.39478E-00, &                    
           5.16550E-00,2.54474E-00,3.53082E-00,3.82278E-00, &                    
           1.81297E-00,6.65313E-01,1.23652E-01,1.83895E-03, &                    
           1.70592E-03,2.68434E-09,0.,0., &                                      
!     From P = 620 mb.                                                           
           2.08632E-01,1.11865E+00,4.95975E+00,8.10907E+00, &                    
           1.10408E+01,5.45460E+00,4.18611E+00,3.53422E+00, &                    
           2.54164E+00,3.65093E-01,5.84480E-01,2.26918E-01, &                    
           1.36230E-03,5.54400E-10,6.83703E-10,0., &                             
!     From P = 313 mb.                                                           
           6.20022E-02,2.69521E-01,9.81928E-01,1.65004E-00, &                    
           3.08089E-00,5.38696E-00,1.14600E+01,2.41211E+01, &                    
           1.69655E+01,1.37556E-00,5.43254E-01,3.52079E-01, &                    
           4.31888E-01,4.82523E-06,5.74747E-11,0./                               
                                                                                 
! Data                                                                           
                                                                                 
      DATA FRACREFA10/ &                                                             
!     From P = 473 mb.                                                           
          0.16271301,0.15141940,0.14065412,0.12899506, &                         
          0.11607002,0.10142808,0.08116794,0.06104711, &                         
          0.04146209,0.00447386,0.00372902,0.00287258, &                         
          0.00206028,0.00134634,0.00049232,0.00006927/                           
      DATA FRACREFB10/ &                                                             
!     From P = 1.17 mb.                                                          
          0.16571465,0.15262246,0.14036226,0.12620729, &                         
          0.11477834,0.09967982,0.08155201,0.06159503, &                         
          0.04196607,0.00453940,0.00376881,0.00300437, &                         
          0.00223034,0.00139432,0.00051516,0.00007095/                           
                                                                                 
! Data                                                                           
                                                                                 
      DATA FRACREFA11/ &                                                             
!     From P = 473 mb.                                                           
          0.14152819,0.13811260,0.14312185,0.13705885, &                         
          0.11944738,0.10570189,0.08866373,0.06565409, &                         
          0.04428961,0.00481540,0.00387058,0.00329187, &                         
          0.00238294,0.00150971,0.00049287,0.00005980/                           
      DATA FRACREFB11/ &                                                             
!     From P = 1.17 mb.                                                          
          0.10874039,0.15164889,0.15149839,0.14515044, &                         
          0.12486220,0.10725017,0.08715712,0.06463144, &                         
          0.04332319,0.00441193,0.00393819,0.00305960, &                         
          0.00224221,0.00145100,0.00055586,0.00007934/                           
                                                                                 
! Data                                                                           
                                                                                 
      DATA FRACREFA12/ &                                                             
!     From P = 706.3 mb.                                                         
          0.21245100,0.15164700,0.14486700,0.13075501, &                         
          0.11629600,0.09266050,0.06579930,0.04524000, &                         
          0.03072870,0.00284297,0.00234660,0.00185208, &                         
          0.00133978,0.00082214,0.00031016,0.00004363, &                         
          0.14703900,0.16937999,0.15605700,0.14159000, &                         
          0.12088500,0.10058500,0.06809110,0.05131470, &                         
          0.03487040,0.00327281,0.00250183,0.00190024, &                         
          0.00133978,0.00082214,0.00031016,0.00004363, &                         
          0.13689300,0.16610400,0.15723500,0.14299500, &                         
          0.12399400,0.09907820,0.07169690,0.05367370, &                         
          0.03671630,0.00378148,0.00290510,0.00221076, &                         
          0.00142810,0.00093527,0.00031016,0.00004363, &                         
          0.13054299,0.16273800,0.15874299,0.14279599, &                         
          0.12674300,0.09664900,0.07462200,0.05620080, &                         
          0.03789090,0.00411690,0.00322920,0.00245036, &                         
          0.00178303,0.00098595,0.00040802,0.00010150, &                         
          0.12828299,0.15824600,0.15688400,0.14449100, &                         
          0.12787800,0.09517830,0.07679350,0.05890820, &                         
          0.03883570,0.00442304,0.00346796,0.00255333, &                         
          0.00212519,0.00116168,0.00067065,0.00010150, &                         
          0.12649800,0.15195100,0.15646499,0.14569700, &                         
          0.12669300,0.09653520,0.07887920,0.06106920, &                         
          0.04043910,0.00430390,0.00364453,0.00314360, &                         
          0.00203206,0.00187787,0.00067075,0.00010150, &                         
          0.12500300,0.14460599,0.15672199,0.14724600, &                         
          0.11978900,0.10190200,0.08196710,0.06315770, &                         
          0.04240100,0.00433645,0.00404097,0.00329466, &                         
          0.00288491,0.00187803,0.00067093,0.00010150, &                         
          0.12317200,0.14118700,0.15242000,0.13794300, &                         
          0.12119200,0.10655400,0.08808350,0.06521370, &                         
          0.04505680,0.00485949,0.00477105,0.00401468, &                         
          0.00288491,0.00187786,0.00067110,0.00010150, &                         
          0.10193600,0.11693000,0.13236099,0.14053200, &                         
          0.13749801,0.12193100,0.10221000,0.07448910, &                         
          0.05205320,0.00572312,0.00476882,0.00403380, &                         
          0.00288871,0.00187396,0.00067218,0.00010150/                           
                                                                                 
! Data                                                                           
                                                                                 
      DATA FRACREFA13/ &                                                             
!     From P = 706.3 mb.                                                         
          0.17683899,0.17319500,0.15712699,0.13604601, &                         
          0.10776200,0.08750010,0.06808820,0.04905150, &                         
          0.03280360,0.00350836,0.00281864,0.00219862, &                         
          0.00160943,0.00101885,0.00038147,0.00005348, &                         
          0.17535400,0.16999300,0.15610200,0.13589200, &                         
          0.10842100,0.08988550,0.06943920,0.04974900, &                         
          0.03323400,0.00352752,0.00289402,0.00231003, &                         
          0.00174659,0.00101884,0.00038147,0.00005348, &                         
          0.17409500,0.16846400,0.15641899,0.13503000, &                         
          0.10838600,0.08985800,0.07092720,0.05075710, &                         
          0.03364180,0.00354241,0.00303507,0.00243391, &                         
          0.00177502,0.00114638,0.00043585,0.00005348, &                         
          0.17248300,0.16778600,0.15543500,0.13496999, &                         
          0.10826300,0.09028740,0.07156720,0.05187120, &                         
          0.03424890,0.00363933,0.00324715,0.00255030, &                         
          0.00187380,0.00116978,0.00051229,0.00009768, &                         
          0.17061099,0.16715799,0.15405200,0.13471501, &                         
          0.10896400,0.09069460,0.07229760,0.05218280, &                         
          0.03555340,0.00379576,0.00330240,0.00274693, &                         
          0.00201587,0.00119598,0.00061885,0.00009768, &                         
          0.16789700,0.16629100,0.15270300,0.13360199, &                         
          0.11047200,0.09151080,0.07325000,0.05261450, &                         
          0.03657990,0.00450092,0.00349537,0.00283321, &                         
          0.00208396,0.00140354,0.00066587,0.00009768, &                         
          0.16412200,0.16387400,0.15211500,0.13062200, &                         
          0.11325100,0.09348130,0.07381380,0.05434740, &                         
          0.03803160,0.00481346,0.00393592,0.00296633, &                         
          0.00222532,0.00163762,0.00066648,0.00009768, &                         
          0.15513401,0.15768200,0.14850400,0.13330200, &                         
          0.11446500,0.09868230,0.07642050,0.05624170, &                         
          0.04197810,0.00502288,0.00429452,0.00315347, &                         
          0.00263559,0.00171772,0.00066860,0.00009768, &                         
          0.15732600,0.15223300,0.14271900,0.13563600, &                         
          0.11859600,0.10274200,0.07934560,0.05763410, &                         
          0.03921740,0.00437741,0.00337921,0.00280212, &                         
          0.00200156,0.00124812,0.00064664,0.00009768/                           
                                                                                 
! Data                                                                           
                                                                                 
      DATA FRACREFA14/ &                                                             
!     From P = 1053.6 mb.                                                        
          0.18446200,0.16795200,0.14949700,0.12036000, &                         
          0.10440100,0.09024280,0.07435880,0.05629380, &                         
          0.03825420,0.00417276,0.00345278,0.00272949, &                         
          0.00200378,0.00127404,0.00050721,0.00004141/                           
      DATA FRACREFB14/ &                                                             
!     From P = 0.64 mb.                                                          
          0.19128500,0.16495700,0.14146100,0.11904500, &                         
          0.10350200,0.09151190,0.07604270,0.05806020, &                         
          0.03979950,0.00423959,0.00357439,0.00287559, &                         
          0.00198860,0.00116529,0.00043616,0.00005987/                           
                                                                                 
! Data                                                                           
                                                                                 
      DATA FRACREFA15/ &                                                             
!     From P = 1053.6 mb.                                                        
          0.11287100,0.12070200,0.12729000,0.12858100, &                         
          0.12743001,0.11961800,0.10290400,0.07888980, &                         
          0.05900120,0.00667979,0.00552926,0.00436993, &                         
          0.00320611,0.00204765,0.00077371,0.00010894, &                         
          0.13918801,0.16353001,0.16155800,0.14090499, &                         
          0.11322300,0.08757720,0.07225720,0.05173390, &                         
          0.04731360,0.00667979,0.00552926,0.00436993, &                         
          0.00320611,0.00204765,0.00077371,0.00010894, &                         
          0.14687300,0.17853101,0.15664500,0.13351700, &                         
          0.10791200,0.08684320,0.07158090,0.05198410, &                         
          0.04340110,0.00667979,0.00552926,0.00436993, &                         
          0.00320611,0.00204765,0.00077371,0.00010894, &                         
          0.15760700,0.17759100,0.15158001,0.13193300, &                         
          0.10742800,0.08693760,0.07159490,0.05196250, &                         
          0.04065270,0.00667979,0.00552926,0.00436993, &                         
          0.00320611,0.00204765,0.00077371,0.00010894, &                         
          0.16646700,0.17299300,0.15018500,0.13138700, &                         
          0.10735900,0.08713110,0.07130330,0.05279420, &                         
          0.03766730,0.00667979,0.00552926,0.00436993, &                         
          0.00320611,0.00204765,0.00077371,0.00010894, &                         
          0.17546000,0.16666500,0.14969499,0.13105400, &                         
          0.10782500,0.08718610,0.07156770,0.05308320, &                         
          0.03753960,0.00432465,0.00509623,0.00436993, &                         
          0.00320611,0.00204765,0.00077371,0.00010894, &                         
          0.18378501,0.16064601,0.14940400,0.13146400, &                         
          0.10810300,0.08775740,0.07115360,0.05400040, &                         
          0.03689970,0.00388333,0.00323610,0.00353414, &                         
          0.00320611,0.00204765,0.00077371,0.00010894, &                         
          0.18966800,0.15744300,0.14993000,0.13152599, &                         
          0.10899200,0.08858690,0.07142920,0.05399600, &                         
          0.03433460,0.00374886,0.00302066,0.00240653, &                         
          0.00199205,0.00204765,0.00077371,0.00010894, &                         
          0.11887100,0.12479600,0.12569501,0.12839900, &                         
          0.12473500,0.12012800,0.11086700,0.08493590, &                         
          0.05063770,0.00328723,0.00266849,0.00210232, &                         
          0.00152114,0.00095635,0.00035374,0.00004980/                           
                                                                                 
! Data                                                                           
                                                                                 
      DATA FRACREFA16/ &                                                             
!     From P = 862.6 mb.                                                         
          0.17356300,0.18880001,0.17704099,0.13661300, &                         
          0.10691600,0.08222480,0.05939860,0.04230810, &                         
          0.02526330,0.00244532,0.00193541,0.00150415, &                         
          0.00103528,0.00067068,0.00024951,0.00003348, &                         
          0.17779499,0.19837400,0.16557600,0.13470000, &                         
          0.11013600,0.08342720,0.05987030,0.03938700, &                         
          0.02293650,0.00238849,0.00192400,0.00149921, &                         
          0.00103539,0.00067150,0.00024822,0.00003348, &                         
          0.18535601,0.19407199,0.16053200,0.13300700, &                         
          0.10779000,0.08408500,0.06480450,0.04070160, &                         
          0.02203590,0.00227779,0.00189074,0.00146888, &                         
          0.00103147,0.00066770,0.00024751,0.00003348, &                         
          0.19139200,0.18917400,0.15748601,0.13240699, &                         
          0.10557300,0.08383260,0.06724060,0.04364450, &                         
          0.02175820,0.00225436,0.00184421,0.00143153, &                         
          0.00103027,0.00066066,0.00024222,0.00003148, &                         
          0.19547801,0.18539500,0.15442000,0.13114899, &                         
          0.10515600,0.08350350,0.06909780,0.04671630, &                         
          0.02168820,0.00224400,0.00182009,0.00139098, &                         
          0.00102582,0.00065367,0.00023202,0.00003148, &                         
          0.19757500,0.18266800,0.15208900,0.12897800, &                         
          0.10637200,0.08391220,0.06989830,0.04964120, &                         
          0.02155800,0.00224310,0.00177358,0.00138184, &                         
          0.00101538,0.00063370,0.00023227,0.00003148, &                         
          0.20145500,0.17692900,0.14940600,0.12690400, &                         
          0.10828800,0.08553720,0.07004940,0.05153430, &                         
          0.02268740,0.00216943,0.00178603,0.00137754, &                         
          0.00098344,0.00063165,0.00023218,0.00003148, &                         
          0.20383500,0.17047501,0.14570600,0.12679300, &                         
          0.11043100,0.08719150,0.07045440,0.05345420, &                         
          0.02448340,0.00215839,0.00175893,0.00138296, &                         
          0.00098318,0.00063188,0.00023199,0.00003148, &                         
          0.18680701,0.15961801,0.15092900,0.13049100, &                         
          0.11418400,0.09380540,0.07093450,0.05664280, &                         
          0.02938410,0.00217751,0.00176766,0.00138275, &                         
          0.00098377,0.00063181,0.00023193,0.00003148/                           
               

!
! end of data 3
!

!-----------------------------------------------------------------------

! start data 4

      DATA NXMOL  /2/
      DATA IXINDX /0,2,3,0,31*0/
                                                                  
!
! end of data 4
!
!-----------------------------------------------------------------------

! start data 5
                                                                  
!     
!  Longwave spectral band data                                                   

      DATA WAVENUM1(1) /10./, WAVENUM2(1) /250./, DELWAVE(1) /240./              
      DATA WAVENUM1(2) /250./, WAVENUM2(2) /500./, DELWAVE(2) /250./             
      DATA WAVENUM1(3) /500./, WAVENUM2(3) /630./, DELWAVE(3) /130./             
      DATA WAVENUM1(4) /630./, WAVENUM2(4) /700./, DELWAVE(4) /70./              
      DATA WAVENUM1(5) /700./, WAVENUM2(5) /820./, DELWAVE(5) /120./             
      DATA WAVENUM1(6) /820./, WAVENUM2(6) /980./, DELWAVE(6) /160./             
      DATA WAVENUM1(7) /980./, WAVENUM2(7) /1080./, DELWAVE(7) /100./            
      DATA WAVENUM1(8) /1080./, WAVENUM2(8) /1180./, DELWAVE(8) /100./           
      DATA WAVENUM1(9) /1180./, WAVENUM2(9) /1390./, DELWAVE(9) /210./           
      DATA WAVENUM1(10) /1390./,WAVENUM2(10) /1480./,DELWAVE(10) /90./           
      DATA WAVENUM1(11) /1480./,WAVENUM2(11) /1800./,DELWAVE(11) /320./          
      DATA WAVENUM1(12) /1800./,WAVENUM2(12) /2080./,DELWAVE(12) /280./          
      DATA WAVENUM1(13) /2080./,WAVENUM2(13) /2250./,DELWAVE(13) /170./          
      DATA WAVENUM1(14) /2250./,WAVENUM2(14) /2380./,DELWAVE(14) /130./          
      DATA WAVENUM1(15) /2380./,WAVENUM2(15) /2600./,DELWAVE(15) /220./          
      DATA WAVENUM1(16) /2600./,WAVENUM2(16) /3000./,DELWAVE(16) /400./          
                                                                                 
!
! end of data 5
!
!-----------------------------------------------------------------------

! start data 6

              
      DATA NG  /16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16/                 
      DATA NSPA /1, 1,10, 9, 9, 1, 9, 1,11, 1, 1, 9, 9, 1, 9, 9/                 
      DATA NSPB /1, 1, 5, 6, 5, 0, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0/                 
                                                                                 
!     HEATFAC is the factor by which one must multiply delta-flux/               
!     delta-pressure, with flux in w/m-2 and pressure in mbar, to get            
!     the heating rate in units of degrees/day.  It is equal to                  
!           (g)x(#sec/day)x(1e-5)/(specific heat of air at const. p)             
!        =  (9.8066)(3600)(1e-5)/(1.004)                                         

      DATA HEATFAC /8.4391/                                                      
                                                                           
!     These pressures are chosen such that the ln of the first pressure          
!     has only a few non-zero digits (i.e. ln(PREF(1)) = 6.96000) and            
!     each subsequent ln(pressure) differs from the previous one by 0.2.         

      DATA PREF / &                                                                 
          1.05363E+03,8.62642E+02,7.06272E+02,5.78246E+02,4.73428E+02, & 
          3.87610E+02,3.17348E+02,2.59823E+02,2.12725E+02,1.74164E+02, & 
          1.42594E+02,1.16746E+02,9.55835E+01,7.82571E+01,6.40715E+01, & 
          5.24573E+01,4.29484E+01,3.51632E+01,2.87892E+01,2.35706E+01, & 
          1.92980E+01,1.57998E+01,1.29358E+01,1.05910E+01,8.67114E+00, & 
          7.09933E+00,5.81244E+00,4.75882E+00,3.89619E+00,3.18993E+00, & 
          2.61170E+00,2.13828E+00,1.75067E+00,1.43333E+00,1.17351E+00, & 
          9.60789E-01,7.86628E-01,6.44036E-01,5.27292E-01,4.31710E-01, & 
          3.53455E-01,2.89384E-01,2.36928E-01,1.93980E-01,1.58817E-01, & 
          1.30029E-01,1.06458E-01,8.71608E-02,7.13612E-02,5.84256E-02, & 
          4.78349E-02,3.91639E-02,3.20647E-02,2.62523E-02,2.14936E-02, & 
          1.75975E-02,1.44076E-02,1.17959E-02,9.65769E-03/                       
      DATA PREFLOG / &                                                              
           6.9600E+00, 6.7600E+00, 6.5600E+00, 6.3600E+00, 6.1600E+00, & 
           5.9600E+00, 5.7600E+00, 5.5600E+00, 5.3600E+00, 5.1600E+00, & 
           4.9600E+00, 4.7600E+00, 4.5600E+00, 4.3600E+00, 4.1600E+00, & 
           3.9600E+00, 3.7600E+00, 3.5600E+00, 3.3600E+00, 3.1600E+00, & 
           2.9600E+00, 2.7600E+00, 2.5600E+00, 2.3600E+00, 2.1600E+00, & 
           1.9600E+00, 1.7600E+00, 1.5600E+00, 1.3600E+00, 1.1600E+00, & 
           9.6000E-01, 7.6000E-01, 5.6000E-01, 3.6000E-01, 1.6000E-01, & 
          -4.0000E-02,-2.4000E-01,-4.4000E-01,-6.4000E-01,-8.4000E-01, & 
          -1.0400E+00,-1.2400E+00,-1.4400E+00,-1.6400E+00,-1.8400E+00, & 
          -2.0400E+00,-2.2400E+00,-2.4400E+00,-2.6400E+00,-2.8400E+00, & 
          -3.0400E+00,-3.2400E+00,-3.4400E+00,-3.6400E+00,-3.8400E+00, & 
          -4.0400E+00,-4.2400E+00,-4.4400E+00,-4.6400E+00/                       
!     These are the temperatures associated with the respective                  
!     pressures for the MLS standard atmosphere.                                 
      DATA TREF / &                                                                 
           2.9420E+02, 2.8799E+02, 2.7894E+02, 2.6925E+02, 2.5983E+02, & 
           2.5017E+02, 2.4077E+02, 2.3179E+02, 2.2306E+02, 2.1578E+02, & 
           2.1570E+02, 2.1570E+02, 2.1570E+02, 2.1706E+02, 2.1858E+02, & 
           2.2018E+02, 2.2174E+02, 2.2328E+02, 2.2479E+02, 2.2655E+02, & 
           2.2834E+02, 2.3113E+02, 2.3401E+02, 2.3703E+02, 2.4022E+02, & 
           2.4371E+02, 2.4726E+02, 2.5085E+02, 2.5457E+02, 2.5832E+02, & 
           2.6216E+02, 2.6606E+02, 2.6999E+02, 2.7340E+02, 2.7536E+02, & 
           2.7568E+02, 2.7372E+02, 2.7163E+02, 2.6955E+02, 2.6593E+02, & 
           2.6211E+02, 2.5828E+02, 2.5360E+02, 2.4854E+02, 2.4348E+02, & 
           2.3809E+02, 2.3206E+02, 2.2603E+02, 2.2000E+02, 2.1435E+02, & 
           2.0887E+02, 2.0340E+02, 1.9792E+02, 1.9290E+02, 1.8809E+02, & 
           1.8329E+02, 1.7849E+02, 1.7394E+02, 1.7212E+02/                       
                                                                                 
!
! end of data 6
!
!-----------------------------------------------------------------------

! start data 7

      DATA (TOTPLNK(IDATA, 1),IDATA=1,50)/ &                                                
      1.13735E-06,1.15150E-06,1.16569E-06,1.17992E-06,1.19419E-06, & 
      1.20850E-06,1.22285E-06,1.23723E-06,1.25164E-06,1.26610E-06, & 
      1.28059E-06,1.29511E-06,1.30967E-06,1.32426E-06,1.33889E-06, & 
      1.35355E-06,1.36824E-06,1.38296E-06,1.39772E-06,1.41250E-06, & 
      1.42732E-06,1.44217E-06,1.45704E-06,1.47195E-06,1.48689E-06, & 
      1.50185E-06,1.51684E-06,1.53186E-06,1.54691E-06,1.56198E-06, & 
      1.57709E-06,1.59222E-06,1.60737E-06,1.62255E-06,1.63776E-06, & 
      1.65299E-06,1.66825E-06,1.68352E-06,1.69883E-06,1.71416E-06, & 
      1.72951E-06,1.74488E-06,1.76028E-06,1.77570E-06,1.79114E-06, & 
      1.80661E-06,1.82210E-06,1.83760E-06,1.85313E-06,1.86868E-06/               
      DATA (TOTPLNK(IDATA, 1),IDATA=51,100)/ &                                              
      1.88425E-06,1.89985E-06,1.91546E-06,1.93109E-06,1.94674E-06, & 
      1.96241E-06,1.97811E-06,1.99381E-06,2.00954E-06,2.02529E-06, & 
      2.04105E-06,2.05684E-06,2.07264E-06,2.08846E-06,2.10429E-06, & 
      2.12015E-06,2.13602E-06,2.15190E-06,2.16781E-06,2.18373E-06, & 
      2.19966E-06,2.21562E-06,2.23159E-06,2.24758E-06,2.26358E-06, & 
      2.27959E-06,2.29562E-06,2.31167E-06,2.32773E-06,2.34381E-06, & 
      2.35990E-06,2.37601E-06,2.39212E-06,2.40825E-06,2.42440E-06, & 
      2.44056E-06,2.45673E-06,2.47292E-06,2.48912E-06,2.50533E-06, & 
      2.52157E-06,2.53781E-06,2.55406E-06,2.57032E-06,2.58660E-06, & 
      2.60289E-06,2.61919E-06,2.63550E-06,2.65183E-06,2.66817E-06/               
      DATA (TOTPLNK(IDATA, 1),IDATA=101,150)/ &                                             
      2.68452E-06,2.70088E-06,2.71726E-06,2.73364E-06,2.75003E-06, & 
      2.76644E-06,2.78286E-06,2.79929E-06,2.81572E-06,2.83218E-06, & 
      2.84864E-06,2.86510E-06,2.88159E-06,2.89807E-06,2.91458E-06, & 
      2.93109E-06,2.94762E-06,2.96415E-06,2.98068E-06,2.99724E-06, & 
      3.01379E-06,3.03036E-06,3.04693E-06,3.06353E-06,3.08013E-06, & 
      3.09674E-06,3.11335E-06,3.12998E-06,3.14661E-06,3.16324E-06, & 
      3.17989E-06,3.19656E-06,3.21323E-06,3.22991E-06,3.24658E-06, & 
      3.26328E-06,3.27998E-06,3.29669E-06,3.31341E-06,3.33013E-06, & 
      3.34686E-06,3.36360E-06,3.38034E-06,3.39709E-06,3.41387E-06, & 
      3.43063E-06,3.44742E-06,3.46420E-06,3.48099E-06,3.49779E-06/               
      DATA (TOTPLNK(IDATA, 1),IDATA=151,181)/ &                                             
      3.51461E-06,3.53141E-06,3.54824E-06,3.56506E-06,3.58191E-06, & 
      3.59875E-06,3.61559E-06,3.63244E-06,3.64931E-06,3.66617E-06, & 
      3.68305E-06,3.69992E-06,3.71682E-06,3.73372E-06,3.75061E-06, & 
      3.76753E-06,3.78443E-06,3.80136E-06,3.81829E-06,3.83522E-06, & 
      3.85215E-06,3.86910E-06,3.88605E-06,3.90301E-06,3.91997E-06, & 
      3.93694E-06,3.95390E-06,3.97087E-06,3.98788E-06,4.00485E-06, & 
      4.02187E-06/                                                               
      DATA (TOTPLNK(IDATA, 2),IDATA=1,50)/ &                                                
      2.13441E-06,2.18076E-06,2.22758E-06,2.27489E-06,2.32268E-06, & 
      2.37093E-06,2.41966E-06,2.46886E-06,2.51852E-06,2.56864E-06, & 
      2.61922E-06,2.67026E-06,2.72175E-06,2.77370E-06,2.82609E-06, & 
      2.87893E-06,2.93221E-06,2.98593E-06,3.04008E-06,3.09468E-06, & 
      3.14970E-06,3.20515E-06,3.26103E-06,3.31732E-06,3.37404E-06, & 
      3.43118E-06,3.48873E-06,3.54669E-06,3.60506E-06,3.66383E-06, & 
      3.72301E-06,3.78259E-06,3.84256E-06,3.90293E-06,3.96368E-06, & 
      4.02483E-06,4.08636E-06,4.14828E-06,4.21057E-06,4.27324E-06, & 
      4.33629E-06,4.39971E-06,4.46350E-06,4.52765E-06,4.59217E-06, & 
      4.65705E-06,4.72228E-06,4.78787E-06,4.85382E-06,4.92011E-06/               
      DATA (TOTPLNK(IDATA, 2),IDATA=51,100)/ &                                              
      4.98675E-06,5.05374E-06,5.12106E-06,5.18873E-06,5.25674E-06, & 
      5.32507E-06,5.39374E-06,5.46274E-06,5.53207E-06,5.60172E-06, & 
      5.67169E-06,5.74198E-06,5.81259E-06,5.88352E-06,5.95475E-06, & 
      6.02629E-06,6.09815E-06,6.17030E-06,6.24276E-06,6.31552E-06, & 
      6.38858E-06,6.46192E-06,6.53557E-06,6.60950E-06,6.68373E-06, & 
      6.75824E-06,6.83303E-06,6.90810E-06,6.98346E-06,7.05909E-06, & 
      7.13500E-06,7.21117E-06,7.28763E-06,7.36435E-06,7.44134E-06, & 
      7.51859E-06,7.59611E-06,7.67388E-06,7.75192E-06,7.83021E-06, & 
      7.90875E-06,7.98755E-06,8.06660E-06,8.14589E-06,8.22544E-06, & 
      8.30522E-06,8.38526E-06,8.46553E-06,8.54604E-06,8.62679E-06/               
      DATA (TOTPLNK(IDATA, 2),IDATA=101,150)/ &                                             
      8.70777E-06,8.78899E-06,8.87043E-06,8.95211E-06,9.03402E-06, & 
      9.11616E-06,9.19852E-06,9.28109E-06,9.36390E-06,9.44692E-06, & 
      9.53015E-06,9.61361E-06,9.69729E-06,9.78117E-06,9.86526E-06, & 
      9.94957E-06,1.00341E-05,1.01188E-05,1.02037E-05,1.02888E-05, & 
      1.03742E-05,1.04597E-05,1.05454E-05,1.06313E-05,1.07175E-05, & 
      1.08038E-05,1.08903E-05,1.09770E-05,1.10639E-05,1.11509E-05, & 
      1.12382E-05,1.13257E-05,1.14133E-05,1.15011E-05,1.15891E-05, & 
      1.16773E-05,1.17656E-05,1.18542E-05,1.19429E-05,1.20317E-05, & 
      1.21208E-05,1.22100E-05,1.22994E-05,1.23890E-05,1.24787E-05, & 
      1.25686E-05,1.26587E-05,1.27489E-05,1.28393E-05,1.29299E-05/               
      DATA (TOTPLNK(IDATA, 2),IDATA=151,181)/ &                                             
      1.30206E-05,1.31115E-05,1.32025E-05,1.32937E-05,1.33850E-05, & 
      1.34765E-05,1.35682E-05,1.36600E-05,1.37520E-05,1.38441E-05, & 
      1.39364E-05,1.40288E-05,1.41213E-05,1.42140E-05,1.43069E-05, & 
      1.43999E-05,1.44930E-05,1.45863E-05,1.46797E-05,1.47733E-05, & 
      1.48670E-05,1.49608E-05,1.50548E-05,1.51489E-05,1.52431E-05, & 
      1.53375E-05,1.54320E-05,1.55267E-05,1.56214E-05,1.57164E-05, & 
      1.58114E-05/                                                               
      DATA (TOTPLNK(IDATA, 3),IDATA=1,50)/ &                                                
      1.34822E-06,1.39134E-06,1.43530E-06,1.48010E-06,1.52574E-06, & 
      1.57222E-06,1.61956E-06,1.66774E-06,1.71678E-06,1.76666E-06, & 
      1.81741E-06,1.86901E-06,1.92147E-06,1.97479E-06,2.02898E-06, & 
      2.08402E-06,2.13993E-06,2.19671E-06,2.25435E-06,2.31285E-06, & 
      2.37222E-06,2.43246E-06,2.49356E-06,2.55553E-06,2.61837E-06, & 
      2.68207E-06,2.74664E-06,2.81207E-06,2.87837E-06,2.94554E-06, & 
      3.01356E-06,3.08245E-06,3.15221E-06,3.22282E-06,3.29429E-06, & 
      3.36662E-06,3.43982E-06,3.51386E-06,3.58876E-06,3.66451E-06, & 
      3.74112E-06,3.81857E-06,3.89688E-06,3.97602E-06,4.05601E-06, & 
      4.13685E-06,4.21852E-06,4.30104E-06,4.38438E-06,4.46857E-06/               
      DATA (TOTPLNK(IDATA, 3),IDATA=51,100)/ &                                              
      4.55358E-06,4.63943E-06,4.72610E-06,4.81359E-06,4.90191E-06, & 
      4.99105E-06,5.08100E-06,5.17176E-06,5.26335E-06,5.35573E-06, & 
      5.44892E-06,5.54292E-06,5.63772E-06,5.73331E-06,5.82970E-06, & 
      5.92688E-06,6.02485E-06,6.12360E-06,6.22314E-06,6.32346E-06, & 
      6.42455E-06,6.52641E-06,6.62906E-06,6.73247E-06,6.83664E-06, & 
      6.94156E-06,7.04725E-06,7.15370E-06,7.26089E-06,7.36883E-06, & 
      7.47752E-06,7.58695E-06,7.69712E-06,7.80801E-06,7.91965E-06, & 
      8.03201E-06,8.14510E-06,8.25891E-06,8.37343E-06,8.48867E-06, & 
      8.60463E-06,8.72128E-06,8.83865E-06,8.95672E-06,9.07548E-06, & 
      9.19495E-06,9.31510E-06,9.43594E-06,9.55745E-06,9.67966E-06/               
      DATA (TOTPLNK(IDATA, 3),IDATA=101,150)/ &                                             
      9.80254E-06,9.92609E-06,1.00503E-05,1.01752E-05,1.03008E-05, & 
      1.04270E-05,1.05539E-05,1.06814E-05,1.08096E-05,1.09384E-05, & 
      1.10679E-05,1.11980E-05,1.13288E-05,1.14601E-05,1.15922E-05, & 
      1.17248E-05,1.18581E-05,1.19920E-05,1.21265E-05,1.22616E-05, & 
      1.23973E-05,1.25337E-05,1.26706E-05,1.28081E-05,1.29463E-05, & 
      1.30850E-05,1.32243E-05,1.33642E-05,1.35047E-05,1.36458E-05, & 
      1.37875E-05,1.39297E-05,1.40725E-05,1.42159E-05,1.43598E-05, & 
      1.45044E-05,1.46494E-05,1.47950E-05,1.49412E-05,1.50879E-05, & 
      1.52352E-05,1.53830E-05,1.55314E-05,1.56803E-05,1.58297E-05, & 
      1.59797E-05,1.61302E-05,1.62812E-05,1.64327E-05,1.65848E-05/               
      DATA (TOTPLNK(IDATA, 3),IDATA=151,181)/ &                                             
      1.67374E-05,1.68904E-05,1.70441E-05,1.71982E-05,1.73528E-05, & 
      1.75079E-05,1.76635E-05,1.78197E-05,1.79763E-05,1.81334E-05, & 
      1.82910E-05,1.84491E-05,1.86076E-05,1.87667E-05,1.89262E-05, & 
      1.90862E-05,1.92467E-05,1.94076E-05,1.95690E-05,1.97309E-05, & 
      1.98932E-05,2.00560E-05,2.02193E-05,2.03830E-05,2.05472E-05, & 
      2.07118E-05,2.08768E-05,2.10423E-05,2.12083E-05,2.13747E-05, & 
      2.15414E-05/                                                               
      DATA (TOTPLNK(IDATA, 4),IDATA=1,50)/ &                                                
      8.90528E-07,9.24222E-07,9.58757E-07,9.94141E-07,1.03038E-06, & 
      1.06748E-06,1.10545E-06,1.14430E-06,1.18403E-06,1.22465E-06, & 
      1.26618E-06,1.30860E-06,1.35193E-06,1.39619E-06,1.44136E-06, & 
      1.48746E-06,1.53449E-06,1.58246E-06,1.63138E-06,1.68124E-06, & 
      1.73206E-06,1.78383E-06,1.83657E-06,1.89028E-06,1.94495E-06, & 
      2.00060E-06,2.05724E-06,2.11485E-06,2.17344E-06,2.23303E-06, & 
      2.29361E-06,2.35519E-06,2.41777E-06,2.48134E-06,2.54592E-06, & 
      2.61151E-06,2.67810E-06,2.74571E-06,2.81433E-06,2.88396E-06, & 
      2.95461E-06,3.02628E-06,3.09896E-06,3.17267E-06,3.24741E-06, & 
      3.32316E-06,3.39994E-06,3.47774E-06,3.55657E-06,3.63642E-06/               
      DATA (TOTPLNK(IDATA, 4),IDATA=51,100)/ &                                              
      3.71731E-06,3.79922E-06,3.88216E-06,3.96612E-06,4.05112E-06, & 
      4.13714E-06,4.22419E-06,4.31227E-06,4.40137E-06,4.49151E-06, & 
      4.58266E-06,4.67485E-06,4.76806E-06,4.86229E-06,4.95754E-06, & 
      5.05383E-06,5.15113E-06,5.24946E-06,5.34879E-06,5.44916E-06, & 
      5.55053E-06,5.65292E-06,5.75632E-06,5.86073E-06,5.96616E-06, & 
      6.07260E-06,6.18003E-06,6.28848E-06,6.39794E-06,6.50838E-06, & 
      6.61983E-06,6.73229E-06,6.84573E-06,6.96016E-06,7.07559E-06, & 
      7.19200E-06,7.30940E-06,7.42779E-06,7.54715E-06,7.66749E-06, & 
      7.78882E-06,7.91110E-06,8.03436E-06,8.15859E-06,8.28379E-06, & 
      8.40994E-06,8.53706E-06,8.66515E-06,8.79418E-06,8.92416E-06/               
      DATA (TOTPLNK(IDATA, 4),IDATA=101,150)/ &                                             
      9.05510E-06,9.18697E-06,9.31979E-06,9.45356E-06,9.58826E-06, & 
      9.72389E-06,9.86046E-06,9.99793E-06,1.01364E-05,1.02757E-05, & 
      1.04159E-05,1.05571E-05,1.06992E-05,1.08422E-05,1.09861E-05, & 
      1.11309E-05,1.12766E-05,1.14232E-05,1.15707E-05,1.17190E-05, & 
      1.18683E-05,1.20184E-05,1.21695E-05,1.23214E-05,1.24741E-05, & 
      1.26277E-05,1.27822E-05,1.29376E-05,1.30939E-05,1.32509E-05, & 
      1.34088E-05,1.35676E-05,1.37273E-05,1.38877E-05,1.40490E-05, & 
      1.42112E-05,1.43742E-05,1.45380E-05,1.47026E-05,1.48680E-05, & 
      1.50343E-05,1.52014E-05,1.53692E-05,1.55379E-05,1.57074E-05, & 
      1.58778E-05,1.60488E-05,1.62207E-05,1.63934E-05,1.65669E-05/               
      DATA (TOTPLNK(IDATA, 4),IDATA=151,181)/ &                                             
      1.67411E-05,1.69162E-05,1.70920E-05,1.72685E-05,1.74459E-05, & 
      1.76240E-05,1.78029E-05,1.79825E-05,1.81629E-05,1.83440E-05, & 
      1.85259E-05,1.87086E-05,1.88919E-05,1.90760E-05,1.92609E-05, & 
      1.94465E-05,1.96327E-05,1.98199E-05,2.00076E-05,2.01961E-05, & 
      2.03853E-05,2.05752E-05,2.07658E-05,2.09571E-05,2.11491E-05, & 
      2.13418E-05,2.15352E-05,2.17294E-05,2.19241E-05,2.21196E-05, & 
      2.23158E-05/                                                               
      DATA (TOTPLNK(IDATA, 5),IDATA=1,50)/ &                                                
      5.70230E-07,5.94788E-07,6.20085E-07,6.46130E-07,6.72936E-07, & 
      7.00512E-07,7.28869E-07,7.58019E-07,7.87971E-07,8.18734E-07, & 
      8.50320E-07,8.82738E-07,9.15999E-07,9.50110E-07,9.85084E-07, & 
      1.02093E-06,1.05765E-06,1.09527E-06,1.13378E-06,1.17320E-06, & 
      1.21353E-06,1.25479E-06,1.29698E-06,1.34011E-06,1.38419E-06, & 
      1.42923E-06,1.47523E-06,1.52221E-06,1.57016E-06,1.61910E-06, & 
      1.66904E-06,1.71997E-06,1.77192E-06,1.82488E-06,1.87886E-06, & 
      1.93387E-06,1.98991E-06,2.04699E-06,2.10512E-06,2.16430E-06, & 
      2.22454E-06,2.28584E-06,2.34821E-06,2.41166E-06,2.47618E-06, & 
      2.54178E-06,2.60847E-06,2.67626E-06,2.74514E-06,2.81512E-06/               
      DATA (TOTPLNK(IDATA, 5),IDATA=51,100)/ &                                              
      2.88621E-06,2.95841E-06,3.03172E-06,3.10615E-06,3.18170E-06, & 
      3.25838E-06,3.33618E-06,3.41511E-06,3.49518E-06,3.57639E-06, & 
      3.65873E-06,3.74221E-06,3.82684E-06,3.91262E-06,3.99955E-06, & 
      4.08763E-06,4.17686E-06,4.26725E-06,4.35880E-06,4.45150E-06, & 
      4.54537E-06,4.64039E-06,4.73659E-06,4.83394E-06,4.93246E-06, & 
      5.03215E-06,5.13301E-06,5.23504E-06,5.33823E-06,5.44260E-06, & 
      5.54814E-06,5.65484E-06,5.76272E-06,5.87177E-06,5.98199E-06, & 
      6.09339E-06,6.20596E-06,6.31969E-06,6.43460E-06,6.55068E-06, & 
      6.66793E-06,6.78636E-06,6.90595E-06,7.02670E-06,7.14863E-06, & 
      7.27173E-06,7.39599E-06,7.52142E-06,7.64802E-06,7.77577E-06/               
      DATA (TOTPLNK(IDATA, 5),IDATA=101,150)/ &                                             
      7.90469E-06,8.03477E-06,8.16601E-06,8.29841E-06,8.43198E-06, & 
      8.56669E-06,8.70256E-06,8.83957E-06,8.97775E-06,9.11706E-06, & 
      9.25753E-06,9.39915E-06,9.54190E-06,9.68580E-06,9.83085E-06, & 
      9.97704E-06,1.01243E-05,1.02728E-05,1.04224E-05,1.05731E-05, & 
      1.07249E-05,1.08779E-05,1.10320E-05,1.11872E-05,1.13435E-05, & 
      1.15009E-05,1.16595E-05,1.18191E-05,1.19799E-05,1.21418E-05, & 
      1.23048E-05,1.24688E-05,1.26340E-05,1.28003E-05,1.29676E-05, & 
      1.31361E-05,1.33056E-05,1.34762E-05,1.36479E-05,1.38207E-05, & 
      1.39945E-05,1.41694E-05,1.43454E-05,1.45225E-05,1.47006E-05, & 
      1.48797E-05,1.50600E-05,1.52413E-05,1.54236E-05,1.56070E-05/               
      DATA (TOTPLNK(IDATA, 5),IDATA=151,181)/ &                                             
      1.57914E-05,1.59768E-05,1.61633E-05,1.63509E-05,1.65394E-05, & 
      1.67290E-05,1.69197E-05,1.71113E-05,1.73040E-05,1.74976E-05, & 
      1.76923E-05,1.78880E-05,1.80847E-05,1.82824E-05,1.84811E-05, & 
      1.86808E-05,1.88814E-05,1.90831E-05,1.92857E-05,1.94894E-05, & 
      1.96940E-05,1.98996E-05,2.01061E-05,2.03136E-05,2.05221E-05, & 
      2.07316E-05,2.09420E-05,2.11533E-05,2.13657E-05,2.15789E-05, & 
      2.17931E-05/                                                               
      DATA (TOTPLNK(IDATA, 6),IDATA=1,50)/ &                                                
      2.73493E-07,2.87408E-07,3.01848E-07,3.16825E-07,3.32352E-07, & 
      3.48439E-07,3.65100E-07,3.82346E-07,4.00189E-07,4.18641E-07, & 
      4.37715E-07,4.57422E-07,4.77774E-07,4.98784E-07,5.20464E-07, & 
      5.42824E-07,5.65879E-07,5.89638E-07,6.14115E-07,6.39320E-07, & 
      6.65266E-07,6.91965E-07,7.19427E-07,7.47666E-07,7.76691E-07, & 
      8.06516E-07,8.37151E-07,8.68607E-07,9.00896E-07,9.34029E-07, & 
      9.68018E-07,1.00287E-06,1.03860E-06,1.07522E-06,1.11274E-06, & 
      1.15117E-06,1.19052E-06,1.23079E-06,1.27201E-06,1.31418E-06, & 
      1.35731E-06,1.40141E-06,1.44650E-06,1.49257E-06,1.53965E-06, & 
      1.58773E-06,1.63684E-06,1.68697E-06,1.73815E-06,1.79037E-06/               
      DATA (TOTPLNK(IDATA, 6),IDATA=51,100)/ &                                              
      1.84365E-06,1.89799E-06,1.95341E-06,2.00991E-06,2.06750E-06, & 
      2.12619E-06,2.18599E-06,2.24691E-06,2.30895E-06,2.37212E-06, & 
      2.43643E-06,2.50189E-06,2.56851E-06,2.63628E-06,2.70523E-06, & 
      2.77536E-06,2.84666E-06,2.91916E-06,2.99286E-06,3.06776E-06, & 
      3.14387E-06,3.22120E-06,3.29975E-06,3.37953E-06,3.46054E-06, & 
      3.54280E-06,3.62630E-06,3.71105E-06,3.79707E-06,3.88434E-06, & 
      3.97288E-06,4.06270E-06,4.15380E-06,4.24617E-06,4.33984E-06, & 
      4.43479E-06,4.53104E-06,4.62860E-06,4.72746E-06,4.82763E-06, & 
      4.92911E-06,5.03191E-06,5.13603E-06,5.24147E-06,5.34824E-06, & 
      5.45634E-06,5.56578E-06,5.67656E-06,5.78867E-06,5.90213E-06/               
      DATA (TOTPLNK(IDATA, 6),IDATA=101,150)/ &                                             
      6.01694E-06,6.13309E-06,6.25060E-06,6.36947E-06,6.48968E-06, & 
      6.61126E-06,6.73420E-06,6.85850E-06,6.98417E-06,7.11120E-06, & 
      7.23961E-06,7.36938E-06,7.50053E-06,7.63305E-06,7.76694E-06, & 
      7.90221E-06,8.03887E-06,8.17690E-06,8.31632E-06,8.45710E-06, & 
      8.59928E-06,8.74282E-06,8.88776E-06,9.03409E-06,9.18179E-06, & 
      9.33088E-06,9.48136E-06,9.63323E-06,9.78648E-06,9.94111E-06, & 
      1.00971E-05,1.02545E-05,1.04133E-05,1.05735E-05,1.07351E-05, & 
      1.08980E-05,1.10624E-05,1.12281E-05,1.13952E-05,1.15637E-05, & 
      1.17335E-05,1.19048E-05,1.20774E-05,1.22514E-05,1.24268E-05, & 
      1.26036E-05,1.27817E-05,1.29612E-05,1.31421E-05,1.33244E-05/               
      DATA (TOTPLNK(IDATA, 6),IDATA=151,181)/ &                                             
      1.35080E-05,1.36930E-05,1.38794E-05,1.40672E-05,1.42563E-05, & 
      1.44468E-05,1.46386E-05,1.48318E-05,1.50264E-05,1.52223E-05, & 
      1.54196E-05,1.56182E-05,1.58182E-05,1.60196E-05,1.62223E-05, & 
      1.64263E-05,1.66317E-05,1.68384E-05,1.70465E-05,1.72559E-05, & 
      1.74666E-05,1.76787E-05,1.78921E-05,1.81069E-05,1.83230E-05, & 
      1.85404E-05,1.87591E-05,1.89791E-05,1.92005E-05,1.94232E-05, & 
      1.96471E-05/                                                               
      DATA (TOTPLNK(IDATA, 7),IDATA=1,50)/ &                                                
      1.25349E-07,1.32735E-07,1.40458E-07,1.48527E-07,1.56954E-07, & 
      1.65748E-07,1.74920E-07,1.84481E-07,1.94443E-07,2.04814E-07, & 
      2.15608E-07,2.26835E-07,2.38507E-07,2.50634E-07,2.63229E-07, & 
      2.76301E-07,2.89864E-07,3.03930E-07,3.18508E-07,3.33612E-07, & 
      3.49253E-07,3.65443E-07,3.82195E-07,3.99519E-07,4.17428E-07, & 
      4.35934E-07,4.55050E-07,4.74785E-07,4.95155E-07,5.16170E-07, & 
      5.37844E-07,5.60186E-07,5.83211E-07,6.06929E-07,6.31355E-07, & 
      6.56498E-07,6.82373E-07,7.08990E-07,7.36362E-07,7.64501E-07, & 
      7.93420E-07,8.23130E-07,8.53643E-07,8.84971E-07,9.17128E-07, & 
      9.50123E-07,9.83969E-07,1.01868E-06,1.05426E-06,1.09073E-06/               
      DATA (TOTPLNK(IDATA, 7),IDATA=51,100)/ &                                              
      1.12810E-06,1.16638E-06,1.20558E-06,1.24572E-06,1.28680E-06, & 
      1.32883E-06,1.37183E-06,1.41581E-06,1.46078E-06,1.50675E-06, & 
      1.55374E-06,1.60174E-06,1.65078E-06,1.70087E-06,1.75200E-06, & 
      1.80421E-06,1.85749E-06,1.91186E-06,1.96732E-06,2.02389E-06, & 
      2.08159E-06,2.14040E-06,2.20035E-06,2.26146E-06,2.32372E-06, & 
      2.38714E-06,2.45174E-06,2.51753E-06,2.58451E-06,2.65270E-06, & 
      2.72210E-06,2.79272E-06,2.86457E-06,2.93767E-06,3.01201E-06, & 
      3.08761E-06,3.16448E-06,3.24261E-06,3.32204E-06,3.40275E-06, & 
      3.48476E-06,3.56808E-06,3.65271E-06,3.73866E-06,3.82595E-06, & 
      3.91456E-06,4.00453E-06,4.09584E-06,4.18851E-06,4.28254E-06/               
      DATA (TOTPLNK(IDATA, 7),IDATA=101,150)/ &                                             
      4.37796E-06,4.47475E-06,4.57293E-06,4.67249E-06,4.77346E-06, & 
      4.87583E-06,4.97961E-06,5.08481E-06,5.19143E-06,5.29948E-06, & 
      5.40896E-06,5.51989E-06,5.63226E-06,5.74608E-06,5.86136E-06, & 
      5.97810E-06,6.09631E-06,6.21597E-06,6.33713E-06,6.45976E-06, & 
      6.58388E-06,6.70950E-06,6.83661E-06,6.96521E-06,7.09531E-06, & 
      7.22692E-06,7.36005E-06,7.49468E-06,7.63084E-06,7.76851E-06, & 
      7.90773E-06,8.04846E-06,8.19072E-06,8.33452E-06,8.47985E-06, & 
      8.62674E-06,8.77517E-06,8.92514E-06,9.07666E-06,9.22975E-06, & 
      9.38437E-06,9.54057E-06,9.69832E-06,9.85762E-06,1.00185E-05, & 
      1.01810E-05,1.03450E-05,1.05106E-05,1.06777E-05,1.08465E-05/               
      DATA (TOTPLNK(IDATA, 7),IDATA=151,181)/ &                                             
      1.10168E-05,1.11887E-05,1.13621E-05,1.15372E-05,1.17138E-05, & 
      1.18920E-05,1.20718E-05,1.22532E-05,1.24362E-05,1.26207E-05, & 
      1.28069E-05,1.29946E-05,1.31839E-05,1.33749E-05,1.35674E-05, & 
      1.37615E-05,1.39572E-05,1.41544E-05,1.43533E-05,1.45538E-05, & 
      1.47558E-05,1.49595E-05,1.51647E-05,1.53716E-05,1.55800E-05, & 
      1.57900E-05,1.60017E-05,1.62149E-05,1.64296E-05,1.66460E-05, & 
      1.68640E-05/                                                               
      DATA (TOTPLNK(IDATA, 8),IDATA=1,50)/ &                                                
      6.74445E-08,7.18176E-08,7.64153E-08,8.12456E-08,8.63170E-08, & 
      9.16378E-08,9.72168E-08,1.03063E-07,1.09184E-07,1.15591E-07, & 
      1.22292E-07,1.29296E-07,1.36613E-07,1.44253E-07,1.52226E-07, & 
      1.60540E-07,1.69207E-07,1.78236E-07,1.87637E-07,1.97421E-07, & 
      2.07599E-07,2.18181E-07,2.29177E-07,2.40598E-07,2.52456E-07, & 
      2.64761E-07,2.77523E-07,2.90755E-07,3.04468E-07,3.18673E-07, & 
      3.33381E-07,3.48603E-07,3.64352E-07,3.80638E-07,3.97474E-07, & 
      4.14871E-07,4.32841E-07,4.51395E-07,4.70547E-07,4.90306E-07, & 
      5.10687E-07,5.31699E-07,5.53357E-07,5.75670E-07,5.98652E-07, & 
      6.22315E-07,6.46672E-07,6.71731E-07,6.97511E-07,7.24018E-07/               
      DATA (TOTPLNK(IDATA, 8),IDATA=51,100)/ &                                              
      7.51266E-07,7.79269E-07,8.08038E-07,8.37584E-07,8.67922E-07, & 
      8.99061E-07,9.31016E-07,9.63797E-07,9.97417E-07,1.03189E-06, & 
      1.06722E-06,1.10343E-06,1.14053E-06,1.17853E-06,1.21743E-06, & 
      1.25726E-06,1.29803E-06,1.33974E-06,1.38241E-06,1.42606E-06, & 
      1.47068E-06,1.51630E-06,1.56293E-06,1.61056E-06,1.65924E-06, & 
      1.70894E-06,1.75971E-06,1.81153E-06,1.86443E-06,1.91841E-06, & 
      1.97350E-06,2.02968E-06,2.08699E-06,2.14543E-06,2.20500E-06, & 
      2.26573E-06,2.32762E-06,2.39068E-06,2.45492E-06,2.52036E-06, & 
      2.58700E-06,2.65485E-06,2.72393E-06,2.79424E-06,2.86580E-06, & 
      2.93861E-06,3.01269E-06,3.08803E-06,3.16467E-06,3.24259E-06/               
      DATA (TOTPLNK(IDATA, 8),IDATA=101,150)/ &                                             
      3.32181E-06,3.40235E-06,3.48420E-06,3.56739E-06,3.65192E-06, & 
      3.73779E-06,3.82502E-06,3.91362E-06,4.00359E-06,4.09494E-06, & 
      4.18768E-06,4.28182E-06,4.37737E-06,4.47434E-06,4.57273E-06, & 
      4.67254E-06,4.77380E-06,4.87651E-06,4.98067E-06,5.08630E-06, & 
      5.19339E-06,5.30196E-06,5.41201E-06,5.52356E-06,5.63660E-06, & 
      5.75116E-06,5.86722E-06,5.98479E-06,6.10390E-06,6.22453E-06, & 
      6.34669E-06,6.47042E-06,6.59569E-06,6.72252E-06,6.85090E-06, & 
      6.98085E-06,7.11238E-06,7.24549E-06,7.38019E-06,7.51646E-06, & 
      7.65434E-06,7.79382E-06,7.93490E-06,8.07760E-06,8.22192E-06, & 
      8.36784E-06,8.51540E-06,8.66459E-06,8.81542E-06,8.96786E-06/               
      DATA (TOTPLNK(IDATA, 8),IDATA=151,181)/ &                                             
      9.12197E-06,9.27772E-06,9.43513E-06,9.59419E-06,9.75490E-06, & 
      9.91728E-06,1.00813E-05,1.02471E-05,1.04144E-05,1.05835E-05, & 
      1.07543E-05,1.09267E-05,1.11008E-05,1.12766E-05,1.14541E-05, & 
      1.16333E-05,1.18142E-05,1.19969E-05,1.21812E-05,1.23672E-05, & 
      1.25549E-05,1.27443E-05,1.29355E-05,1.31284E-05,1.33229E-05, & 
      1.35193E-05,1.37173E-05,1.39170E-05,1.41185E-05,1.43217E-05, & 
      1.45267E-05/                                                               
      DATA (TOTPLNK(IDATA, 9),IDATA=1,50)/ &                                                
      2.61522E-08,2.80613E-08,3.00838E-08,3.22250E-08,3.44899E-08, & 
      3.68841E-08,3.94129E-08,4.20820E-08,4.48973E-08,4.78646E-08, & 
      5.09901E-08,5.42799E-08,5.77405E-08,6.13784E-08,6.52001E-08, & 
      6.92126E-08,7.34227E-08,7.78375E-08,8.24643E-08,8.73103E-08, & 
      9.23832E-08,9.76905E-08,1.03240E-07,1.09039E-07,1.15097E-07, & 
      1.21421E-07,1.28020E-07,1.34902E-07,1.42075E-07,1.49548E-07, & 
      1.57331E-07,1.65432E-07,1.73860E-07,1.82624E-07,1.91734E-07, & 
      2.01198E-07,2.11028E-07,2.21231E-07,2.31818E-07,2.42799E-07, & 
      2.54184E-07,2.65983E-07,2.78205E-07,2.90862E-07,3.03963E-07, & 
      3.17519E-07,3.31541E-07,3.46039E-07,3.61024E-07,3.76507E-07/               
      DATA (TOTPLNK(IDATA, 9),IDATA=51,100)/ &                                              
      3.92498E-07,4.09008E-07,4.26050E-07,4.43633E-07,4.61769E-07, & 
      4.80469E-07,4.99744E-07,5.19606E-07,5.40067E-07,5.61136E-07, & 
      5.82828E-07,6.05152E-07,6.28120E-07,6.51745E-07,6.76038E-07, & 
      7.01010E-07,7.26674E-07,7.53041E-07,7.80124E-07,8.07933E-07, & 
      8.36482E-07,8.65781E-07,8.95845E-07,9.26683E-07,9.58308E-07, & 
      9.90732E-07,1.02397E-06,1.05803E-06,1.09292E-06,1.12866E-06, & 
      1.16526E-06,1.20274E-06,1.24109E-06,1.28034E-06,1.32050E-06, & 
      1.36158E-06,1.40359E-06,1.44655E-06,1.49046E-06,1.53534E-06, & 
      1.58120E-06,1.62805E-06,1.67591E-06,1.72478E-06,1.77468E-06, & 
      1.82561E-06,1.87760E-06,1.93066E-06,1.98479E-06,2.04000E-06/               
      DATA (TOTPLNK(IDATA, 9),IDATA=101,150)/ &                                             
      2.09631E-06,2.15373E-06,2.21228E-06,2.27196E-06,2.33278E-06, & 
      2.39475E-06,2.45790E-06,2.52222E-06,2.58773E-06,2.65445E-06, & 
      2.72238E-06,2.79152E-06,2.86191E-06,2.93354E-06,3.00643E-06, & 
      3.08058E-06,3.15601E-06,3.23273E-06,3.31075E-06,3.39009E-06, & 
      3.47074E-06,3.55272E-06,3.63605E-06,3.72072E-06,3.80676E-06, & 
      3.89417E-06,3.98297E-06,4.07315E-06,4.16474E-06,4.25774E-06, & 
      4.35217E-06,4.44802E-06,4.54532E-06,4.64406E-06,4.74428E-06, & 
      4.84595E-06,4.94911E-06,5.05376E-06,5.15990E-06,5.26755E-06, & 
      5.37671E-06,5.48741E-06,5.59963E-06,5.71340E-06,5.82871E-06, & 
      5.94559E-06,6.06403E-06,6.18404E-06,6.30565E-06,6.42885E-06/               
      DATA (TOTPLNK(IDATA, 9),IDATA=151,181)/ &                                             
      6.55364E-06,6.68004E-06,6.80806E-06,6.93771E-06,7.06898E-06, & 
      7.20190E-06,7.33646E-06,7.47267E-06,7.61056E-06,7.75010E-06, & 
      7.89133E-06,8.03423E-06,8.17884E-06,8.32514E-06,8.47314E-06, & 
      8.62284E-06,8.77427E-06,8.92743E-06,9.08231E-06,9.23893E-06, & 
      9.39729E-06,9.55741E-06,9.71927E-06,9.88291E-06,1.00483E-05, & 
      1.02155E-05,1.03844E-05,1.05552E-05,1.07277E-05,1.09020E-05, & 
      1.10781E-05/                                                               
      DATA (TOTPLNK(IDATA,10),IDATA=1,50)/ &                                                
      8.89300E-09,9.63263E-09,1.04235E-08,1.12685E-08,1.21703E-08, & 
      1.31321E-08,1.41570E-08,1.52482E-08,1.64090E-08,1.76428E-08, & 
      1.89533E-08,2.03441E-08,2.18190E-08,2.33820E-08,2.50370E-08, & 
      2.67884E-08,2.86402E-08,3.05969E-08,3.26632E-08,3.48436E-08, & 
      3.71429E-08,3.95660E-08,4.21179E-08,4.48040E-08,4.76294E-08, & 
      5.05996E-08,5.37201E-08,5.69966E-08,6.04349E-08,6.40411E-08, & 
      6.78211E-08,7.17812E-08,7.59276E-08,8.02670E-08,8.48059E-08, & 
      8.95508E-08,9.45090E-08,9.96873E-08,1.05093E-07,1.10733E-07, & 
      1.16614E-07,1.22745E-07,1.29133E-07,1.35786E-07,1.42711E-07, & 
      1.49916E-07,1.57410E-07,1.65202E-07,1.73298E-07,1.81709E-07/               
      DATA (TOTPLNK(IDATA,10),IDATA=51,100)/ &                                              
      1.90441E-07,1.99505E-07,2.08908E-07,2.18660E-07,2.28770E-07, & 
      2.39247E-07,2.50101E-07,2.61340E-07,2.72974E-07,2.85013E-07, & 
      2.97467E-07,3.10345E-07,3.23657E-07,3.37413E-07,3.51623E-07, & 
      3.66298E-07,3.81448E-07,3.97082E-07,4.13212E-07,4.29848E-07, & 
      4.47000E-07,4.64680E-07,4.82898E-07,5.01664E-07,5.20991E-07, & 
      5.40888E-07,5.61369E-07,5.82440E-07,6.04118E-07,6.26410E-07, & 
      6.49329E-07,6.72887E-07,6.97095E-07,7.21964E-07,7.47506E-07, & 
      7.73732E-07,8.00655E-07,8.28287E-07,8.56635E-07,8.85717E-07, & 
      9.15542E-07,9.46122E-07,9.77469E-07,1.00960E-06,1.04251E-06, & 
      1.07623E-06,1.11077E-06,1.14613E-06,1.18233E-06,1.21939E-06/               
      DATA (TOTPLNK(IDATA,10),IDATA=101,150)/ &                                             
      1.25730E-06,1.29610E-06,1.33578E-06,1.37636E-06,1.41785E-06, & 
      1.46027E-06,1.50362E-06,1.54792E-06,1.59319E-06,1.63942E-06, & 
      1.68665E-06,1.73487E-06,1.78410E-06,1.83435E-06,1.88564E-06, & 
      1.93797E-06,1.99136E-06,2.04582E-06,2.10137E-06,2.15801E-06, & 
      2.21576E-06,2.27463E-06,2.33462E-06,2.39577E-06,2.45806E-06, & 
      2.52153E-06,2.58617E-06,2.65201E-06,2.71905E-06,2.78730E-06, & 
      2.85678E-06,2.92749E-06,2.99946E-06,3.07269E-06,3.14720E-06, & 
      3.22299E-06,3.30007E-06,3.37847E-06,3.45818E-06,3.53923E-06, & 
      3.62161E-06,3.70535E-06,3.79046E-06,3.87695E-06,3.96481E-06, & 
      4.05409E-06,4.14477E-06,4.23687E-06,4.33040E-06,4.42538E-06/               
      DATA (TOTPLNK(IDATA,10),IDATA=151,181)/ &                                             
      4.52180E-06,4.61969E-06,4.71905E-06,4.81991E-06,4.92226E-06, & 
      5.02611E-06,5.13148E-06,5.23839E-06,5.34681E-06,5.45681E-06, & 
      5.56835E-06,5.68146E-06,5.79614E-06,5.91242E-06,6.03030E-06, & 
      6.14978E-06,6.27088E-06,6.39360E-06,6.51798E-06,6.64398E-06, & 
      6.77165E-06,6.90099E-06,7.03198E-06,7.16468E-06,7.29906E-06, & 
      7.43514E-06,7.57294E-06,7.71244E-06,7.85369E-06,7.99666E-06, & 
      8.14138E-06/                                                               
      DATA (TOTPLNK(IDATA,11),IDATA=1,50)/ &                                                
      2.53767E-09,2.77242E-09,3.02564E-09,3.29851E-09,3.59228E-09, & 
      3.90825E-09,4.24777E-09,4.61227E-09,5.00322E-09,5.42219E-09, & 
      5.87080E-09,6.35072E-09,6.86370E-09,7.41159E-09,7.99628E-09, & 
      8.61974E-09,9.28404E-09,9.99130E-09,1.07437E-08,1.15436E-08, & 
      1.23933E-08,1.32953E-08,1.42522E-08,1.52665E-08,1.63410E-08, & 
      1.74786E-08,1.86820E-08,1.99542E-08,2.12985E-08,2.27179E-08, & 
      2.42158E-08,2.57954E-08,2.74604E-08,2.92141E-08,3.10604E-08, & 
      3.30029E-08,3.50457E-08,3.71925E-08,3.94476E-08,4.18149E-08, & 
      4.42991E-08,4.69043E-08,4.96352E-08,5.24961E-08,5.54921E-08, & 
      5.86277E-08,6.19081E-08,6.53381E-08,6.89231E-08,7.26681E-08/               
      DATA (TOTPLNK(IDATA,11),IDATA=51,100)/ &                                              
      7.65788E-08,8.06604E-08,8.49187E-08,8.93591E-08,9.39879E-08, & 
      9.88106E-08,1.03834E-07,1.09063E-07,1.14504E-07,1.20165E-07, & 
      1.26051E-07,1.32169E-07,1.38525E-07,1.45128E-07,1.51982E-07, & 
      1.59096E-07,1.66477E-07,1.74132E-07,1.82068E-07,1.90292E-07, & 
      1.98813E-07,2.07638E-07,2.16775E-07,2.26231E-07,2.36015E-07, & 
      2.46135E-07,2.56599E-07,2.67415E-07,2.78592E-07,2.90137E-07, & 
      3.02061E-07,3.14371E-07,3.27077E-07,3.40186E-07,3.53710E-07, & 
      3.67655E-07,3.82031E-07,3.96848E-07,4.12116E-07,4.27842E-07, & 
      4.44039E-07,4.60713E-07,4.77876E-07,4.95537E-07,5.13706E-07, & 
      5.32392E-07,5.51608E-07,5.71360E-07,5.91662E-07,6.12521E-07/               
      DATA (TOTPLNK(IDATA,11),IDATA=101,150)/ &                                             
      6.33950E-07,6.55958E-07,6.78556E-07,7.01753E-07,7.25562E-07, & 
      7.49992E-07,7.75055E-07,8.00760E-07,8.27120E-07,8.54145E-07, & 
      8.81845E-07,9.10233E-07,9.39318E-07,9.69113E-07,9.99627E-07, & 
      1.03087E-06,1.06286E-06,1.09561E-06,1.12912E-06,1.16340E-06, & 
      1.19848E-06,1.23435E-06,1.27104E-06,1.30855E-06,1.34690E-06, & 
      1.38609E-06,1.42614E-06,1.46706E-06,1.50886E-06,1.55155E-06, & 
      1.59515E-06,1.63967E-06,1.68512E-06,1.73150E-06,1.77884E-06, & 
      1.82715E-06,1.87643E-06,1.92670E-06,1.97797E-06,2.03026E-06, & 
      2.08356E-06,2.13791E-06,2.19330E-06,2.24975E-06,2.30728E-06, & 
      2.36589E-06,2.42560E-06,2.48641E-06,2.54835E-06,2.61142E-06/               
      DATA (TOTPLNK(IDATA,11),IDATA=151,181)/ &                                             
      2.67563E-06,2.74100E-06,2.80754E-06,2.87526E-06,2.94417E-06, & 
      3.01429E-06,3.08562E-06,3.15819E-06,3.23199E-06,3.30704E-06, & 
      3.38336E-06,3.46096E-06,3.53984E-06,3.62002E-06,3.70151E-06, & 
      3.78433E-06,3.86848E-06,3.95399E-06,4.04084E-06,4.12907E-06, & 
      4.21868E-06,4.30968E-06,4.40209E-06,4.49592E-06,4.59117E-06, & 
      4.68786E-06,4.78600E-06,4.88561E-06,4.98669E-06,5.08926E-06, & 
      5.19332E-06/                                                               
      DATA (TOTPLNK(IDATA,12),IDATA=1,50)/ &                                                
      2.73921E-10,3.04500E-10,3.38056E-10,3.74835E-10,4.15099E-10, & 
      4.59126E-10,5.07214E-10,5.59679E-10,6.16857E-10,6.79103E-10, & 
      7.46796E-10,8.20335E-10,9.00144E-10,9.86671E-10,1.08039E-09, & 
      1.18180E-09,1.29142E-09,1.40982E-09,1.53757E-09,1.67529E-09, & 
      1.82363E-09,1.98327E-09,2.15492E-09,2.33932E-09,2.53726E-09, & 
      2.74957E-09,2.97710E-09,3.22075E-09,3.48145E-09,3.76020E-09, & 
      4.05801E-09,4.37595E-09,4.71513E-09,5.07672E-09,5.46193E-09, & 
      5.87201E-09,6.30827E-09,6.77205E-09,7.26480E-09,7.78794E-09, & 
      8.34304E-09,8.93163E-09,9.55537E-09,1.02159E-08,1.09151E-08, & 
      1.16547E-08,1.24365E-08,1.32625E-08,1.41348E-08,1.50554E-08/               
      DATA (TOTPLNK(IDATA,12),IDATA=51,100)/ &                                              
      1.60264E-08,1.70500E-08,1.81285E-08,1.92642E-08,2.04596E-08, & 
      2.17171E-08,2.30394E-08,2.44289E-08,2.58885E-08,2.74209E-08, & 
      2.90290E-08,3.07157E-08,3.24841E-08,3.43371E-08,3.62782E-08, & 
      3.83103E-08,4.04371E-08,4.26617E-08,4.49878E-08,4.74190E-08, & 
      4.99589E-08,5.26113E-08,5.53801E-08,5.82692E-08,6.12826E-08, & 
      6.44245E-08,6.76991E-08,7.11105E-08,7.46634E-08,7.83621E-08, & 
      8.22112E-08,8.62154E-08,9.03795E-08,9.47081E-08,9.92066E-08, & 
      1.03879E-07,1.08732E-07,1.13770E-07,1.18998E-07,1.24422E-07, & 
      1.30048E-07,1.35880E-07,1.41924E-07,1.48187E-07,1.54675E-07, & 
      1.61392E-07,1.68346E-07,1.75543E-07,1.82988E-07,1.90688E-07/               
      DATA (TOTPLNK(IDATA,12),IDATA=101,150)/ &                                             
      1.98650E-07,2.06880E-07,2.15385E-07,2.24172E-07,2.33247E-07, & 
      2.42617E-07,2.52289E-07,2.62272E-07,2.72571E-07,2.83193E-07, & 
      2.94147E-07,3.05440E-07,3.17080E-07,3.29074E-07,3.41430E-07, & 
      3.54155E-07,3.67259E-07,3.80747E-07,3.94631E-07,4.08916E-07, & 
      4.23611E-07,4.38725E-07,4.54267E-07,4.70245E-07,4.86666E-07, & 
      5.03541E-07,5.20879E-07,5.38687E-07,5.56975E-07,5.75751E-07, & 
      5.95026E-07,6.14808E-07,6.35107E-07,6.55932E-07,6.77293E-07, & 
      6.99197E-07,7.21656E-07,7.44681E-07,7.68278E-07,7.92460E-07, & 
      8.17235E-07,8.42614E-07,8.68606E-07,8.95223E-07,9.22473E-07, & 
      9.50366E-07,9.78915E-07,1.00813E-06,1.03802E-06,1.06859E-06/               
      DATA (TOTPLNK(IDATA,12),IDATA=151,181)/ &                                             
      1.09986E-06,1.13184E-06,1.16453E-06,1.19796E-06,1.23212E-06, & 
      1.26703E-06,1.30270E-06,1.33915E-06,1.37637E-06,1.41440E-06, & 
      1.45322E-06,1.49286E-06,1.53333E-06,1.57464E-06,1.61679E-06, & 
      1.65981E-06,1.70370E-06,1.74847E-06,1.79414E-06,1.84071E-06, & 
      1.88821E-06,1.93663E-06,1.98599E-06,2.03631E-06,2.08759E-06, & 
      2.13985E-06,2.19310E-06,2.24734E-06,2.30260E-06,2.35888E-06, & 
      2.41619E-06/                                                               
      DATA (TOTPLNK(IDATA,13),IDATA=1,50)/ &                                                
      4.53634E-11,5.11435E-11,5.75754E-11,6.47222E-11,7.26531E-11, & 
      8.14420E-11,9.11690E-11,1.01921E-10,1.13790E-10,1.26877E-10, & 
      1.41288E-10,1.57140E-10,1.74555E-10,1.93665E-10,2.14613E-10, & 
      2.37548E-10,2.62633E-10,2.90039E-10,3.19948E-10,3.52558E-10, & 
      3.88073E-10,4.26716E-10,4.68719E-10,5.14331E-10,5.63815E-10, & 
      6.17448E-10,6.75526E-10,7.38358E-10,8.06277E-10,8.79625E-10, & 
      9.58770E-10,1.04410E-09,1.13602E-09,1.23495E-09,1.34135E-09, & 
      1.45568E-09,1.57845E-09,1.71017E-09,1.85139E-09,2.00268E-09, & 
      2.16464E-09,2.33789E-09,2.52309E-09,2.72093E-09,2.93212E-09, & 
      3.15740E-09,3.39757E-09,3.65341E-09,3.92579E-09,4.21559E-09/               
      DATA (TOTPLNK(IDATA,13),IDATA=51,100)/ &                                              
      4.52372E-09,4.85115E-09,5.19886E-09,5.56788E-09,5.95928E-09, & 
      6.37419E-09,6.81375E-09,7.27917E-09,7.77168E-09,8.29256E-09, & 
      8.84317E-09,9.42487E-09,1.00391E-08,1.06873E-08,1.13710E-08, & 
      1.20919E-08,1.28515E-08,1.36514E-08,1.44935E-08,1.53796E-08, & 
      1.63114E-08,1.72909E-08,1.83201E-08,1.94008E-08,2.05354E-08, & 
      2.17258E-08,2.29742E-08,2.42830E-08,2.56545E-08,2.70910E-08, & 
      2.85950E-08,3.01689E-08,3.18155E-08,3.35373E-08,3.53372E-08, & 
      3.72177E-08,3.91818E-08,4.12325E-08,4.33727E-08,4.56056E-08, & 
      4.79342E-08,5.03617E-08,5.28915E-08,5.55270E-08,5.82715E-08, & 
      6.11286E-08,6.41019E-08,6.71951E-08,7.04119E-08,7.37560E-08/               
      DATA (TOTPLNK(IDATA,13),IDATA=101,150)/ &                                             
      7.72315E-08,8.08424E-08,8.45927E-08,8.84866E-08,9.25281E-08, & 
      9.67218E-08,1.01072E-07,1.05583E-07,1.10260E-07,1.15107E-07, & 
      1.20128E-07,1.25330E-07,1.30716E-07,1.36291E-07,1.42061E-07, & 
      1.48031E-07,1.54206E-07,1.60592E-07,1.67192E-07,1.74015E-07, & 
      1.81064E-07,1.88345E-07,1.95865E-07,2.03628E-07,2.11643E-07, & 
      2.19912E-07,2.28443E-07,2.37244E-07,2.46318E-07,2.55673E-07, & 
      2.65316E-07,2.75252E-07,2.85489E-07,2.96033E-07,3.06891E-07, & 
      3.18070E-07,3.29576E-07,3.41417E-07,3.53600E-07,3.66133E-07, & 
      3.79021E-07,3.92274E-07,4.05897E-07,4.19899E-07,4.34288E-07, & 
      4.49071E-07,4.64255E-07,4.79850E-07,4.95863E-07,5.12300E-07/               
      DATA (TOTPLNK(IDATA,13),IDATA=151,181)/ &                                             
      5.29172E-07,5.46486E-07,5.64250E-07,5.82473E-07,6.01164E-07, & 
      6.20329E-07,6.39979E-07,6.60122E-07,6.80767E-07,7.01922E-07, & 
      7.23596E-07,7.45800E-07,7.68539E-07,7.91826E-07,8.15669E-07, & 
      8.40076E-07,8.65058E-07,8.90623E-07,9.16783E-07,9.43544E-07, & 
      9.70917E-07,9.98912E-07,1.02754E-06,1.05681E-06,1.08673E-06, & 
      1.11731E-06,1.14856E-06,1.18050E-06,1.21312E-06,1.24645E-06, & 
      1.28049E-06/                                                               
      DATA (TOTPLNK(IDATA,14),IDATA=1,50)/ &                                                
      1.40113E-11,1.59358E-11,1.80960E-11,2.05171E-11,2.32266E-11, & 
      2.62546E-11,2.96335E-11,3.33990E-11,3.75896E-11,4.22469E-11, & 
      4.74164E-11,5.31466E-11,5.94905E-11,6.65054E-11,7.42522E-11, & 
      8.27975E-11,9.22122E-11,1.02573E-10,1.13961E-10,1.26466E-10, & 
      1.40181E-10,1.55206E-10,1.71651E-10,1.89630E-10,2.09265E-10, & 
      2.30689E-10,2.54040E-10,2.79467E-10,3.07128E-10,3.37190E-10, & 
      3.69833E-10,4.05243E-10,4.43623E-10,4.85183E-10,5.30149E-10, & 
      5.78755E-10,6.31255E-10,6.87910E-10,7.49002E-10,8.14824E-10, & 
      8.85687E-10,9.61914E-10,1.04385E-09,1.13186E-09,1.22631E-09, & 
      1.32761E-09,1.43617E-09,1.55243E-09,1.67686E-09,1.80992E-09/               
      DATA (TOTPLNK(IDATA,14),IDATA=51,100)/ &                                              
      1.95212E-09,2.10399E-09,2.26607E-09,2.43895E-09,2.62321E-09, & 
      2.81949E-09,3.02844E-09,3.25073E-09,3.48707E-09,3.73820E-09, & 
      4.00490E-09,4.28794E-09,4.58819E-09,4.90647E-09,5.24371E-09, & 
      5.60081E-09,5.97875E-09,6.37854E-09,6.80120E-09,7.24782E-09, & 
      7.71950E-09,8.21740E-09,8.74271E-09,9.29666E-09,9.88054E-09, & 
      1.04956E-08,1.11434E-08,1.18251E-08,1.25422E-08,1.32964E-08, & 
      1.40890E-08,1.49217E-08,1.57961E-08,1.67140E-08,1.76771E-08, & 
      1.86870E-08,1.97458E-08,2.08553E-08,2.20175E-08,2.32342E-08, & 
      2.45077E-08,2.58401E-08,2.72334E-08,2.86900E-08,3.02122E-08, & 
      3.18021E-08,3.34624E-08,3.51954E-08,3.70037E-08,3.88899E-08/               
      DATA (TOTPLNK(IDATA,14),IDATA=101,150)/ &                                             
      4.08568E-08,4.29068E-08,4.50429E-08,4.72678E-08,4.95847E-08, & 
      5.19963E-08,5.45058E-08,5.71161E-08,5.98309E-08,6.26529E-08, & 
      6.55857E-08,6.86327E-08,7.17971E-08,7.50829E-08,7.84933E-08, & 
      8.20323E-08,8.57035E-08,8.95105E-08,9.34579E-08,9.75488E-08, & 
      1.01788E-07,1.06179E-07,1.10727E-07,1.15434E-07,1.20307E-07, & 
      1.25350E-07,1.30566E-07,1.35961E-07,1.41539E-07,1.47304E-07, & 
      1.53263E-07,1.59419E-07,1.65778E-07,1.72345E-07,1.79124E-07, & 
      1.86122E-07,1.93343E-07,2.00792E-07,2.08476E-07,2.16400E-07, & 
      2.24568E-07,2.32988E-07,2.41666E-07,2.50605E-07,2.59813E-07, & 
      2.69297E-07,2.79060E-07,2.89111E-07,2.99455E-07,3.10099E-07/               
      DATA (TOTPLNK(IDATA,14),IDATA=151,181)/ &                                             
      3.21049E-07,3.32311E-07,3.43893E-07,3.55801E-07,3.68041E-07, & 
      3.80621E-07,3.93547E-07,4.06826E-07,4.20465E-07,4.34473E-07, & 
      4.48856E-07,4.63620E-07,4.78774E-07,4.94325E-07,5.10280E-07, & 
      5.26648E-07,5.43436E-07,5.60652E-07,5.78302E-07,5.96397E-07, & 
      6.14943E-07,6.33949E-07,6.53421E-07,6.73370E-07,6.93803E-07, & 
      7.14731E-07,7.36157E-07,7.58095E-07,7.80549E-07,8.03533E-07, & 
      8.27050E-07/                                                               
      DATA (TOTPLNK(IDATA,15),IDATA=1,50)/ &                                                
      3.90483E-12,4.47999E-12,5.13122E-12,5.86739E-12,6.69829E-12, & 
      7.63467E-12,8.68833E-12,9.87221E-12,1.12005E-11,1.26885E-11, & 
      1.43534E-11,1.62134E-11,1.82888E-11,2.06012E-11,2.31745E-11, & 
      2.60343E-11,2.92087E-11,3.27277E-11,3.66242E-11,4.09334E-11, & 
      4.56935E-11,5.09455E-11,5.67338E-11,6.31057E-11,7.01127E-11, & 
      7.78096E-11,8.62554E-11,9.55130E-11,1.05651E-10,1.16740E-10, & 
      1.28858E-10,1.42089E-10,1.56519E-10,1.72243E-10,1.89361E-10, & 
      2.07978E-10,2.28209E-10,2.50173E-10,2.73999E-10,2.99820E-10, & 
      3.27782E-10,3.58034E-10,3.90739E-10,4.26067E-10,4.64196E-10, & 
      5.05317E-10,5.49631E-10,5.97347E-10,6.48689E-10,7.03891E-10/               
      DATA (TOTPLNK(IDATA,15),IDATA=51,100)/ &                                              
      7.63201E-10,8.26876E-10,8.95192E-10,9.68430E-10,1.04690E-09, & 
      1.13091E-09,1.22079E-09,1.31689E-09,1.41957E-09,1.52922E-09, & 
      1.64623E-09,1.77101E-09,1.90401E-09,2.04567E-09,2.19647E-09, & 
      2.35690E-09,2.52749E-09,2.70875E-09,2.90127E-09,3.10560E-09, & 
      3.32238E-09,3.55222E-09,3.79578E-09,4.05375E-09,4.32682E-09, & 
      4.61574E-09,4.92128E-09,5.24420E-09,5.58536E-09,5.94558E-09, & 
      6.32575E-09,6.72678E-09,7.14964E-09,7.59526E-09,8.06470E-09, & 
      8.55897E-09,9.07916E-09,9.62638E-09,1.02018E-08,1.08066E-08, & 
      1.14420E-08,1.21092E-08,1.28097E-08,1.35446E-08,1.43155E-08, & 
      1.51237E-08,1.59708E-08,1.68581E-08,1.77873E-08,1.87599E-08/               
      DATA (TOTPLNK(IDATA,15),IDATA=101,150)/ &                                             
      1.97777E-08,2.08423E-08,2.19555E-08,2.31190E-08,2.43348E-08, & 
      2.56045E-08,2.69302E-08,2.83140E-08,2.97578E-08,3.12636E-08, & 
      3.28337E-08,3.44702E-08,3.61755E-08,3.79516E-08,3.98012E-08, & 
      4.17265E-08,4.37300E-08,4.58143E-08,4.79819E-08,5.02355E-08, & 
      5.25777E-08,5.50114E-08,5.75393E-08,6.01644E-08,6.28896E-08, & 
      6.57177E-08,6.86521E-08,7.16959E-08,7.48520E-08,7.81239E-08, & 
      8.15148E-08,8.50282E-08,8.86675E-08,9.24362E-08,9.63380E-08, & 
      1.00376E-07,1.04555E-07,1.08878E-07,1.13349E-07,1.17972E-07, & 
      1.22751E-07,1.27690E-07,1.32793E-07,1.38064E-07,1.43508E-07, & 
      1.49129E-07,1.54931E-07,1.60920E-07,1.67099E-07,1.73473E-07/               
      DATA (TOTPLNK(IDATA,15),IDATA=151,181)/ &                                             
      1.80046E-07,1.86825E-07,1.93812E-07,2.01014E-07,2.08436E-07, & 
      2.16082E-07,2.23957E-07,2.32067E-07,2.40418E-07,2.49013E-07, & 
      2.57860E-07,2.66963E-07,2.76328E-07,2.85961E-07,2.95868E-07, & 
      3.06053E-07,3.16524E-07,3.27286E-07,3.38345E-07,3.49707E-07, & 
      3.61379E-07,3.73367E-07,3.85676E-07,3.98315E-07,4.11287E-07, & 
      4.24602E-07,4.38265E-07,4.52283E-07,4.66662E-07,4.81410E-07, & 
      4.96535E-07/                                                               
      DATA (TOTPLNK(IDATA,16),IDATA=1,50)/ &                                                
      4.65378E-13,5.41927E-13,6.29913E-13,7.30869E-13,8.46510E-13, & 
      9.78750E-13,1.12972E-12,1.30181E-12,1.49764E-12,1.72016E-12, & 
      1.97260E-12,2.25858E-12,2.58206E-12,2.94744E-12,3.35955E-12, & 
      3.82372E-12,4.34581E-12,4.93225E-12,5.59010E-12,6.32711E-12, & 
      7.15171E-12,8.07317E-12,9.10159E-12,1.02480E-11,1.15244E-11, & 
      1.29438E-11,1.45204E-11,1.62697E-11,1.82084E-11,2.03545E-11, & 
      2.27278E-11,2.53494E-11,2.82424E-11,3.14313E-11,3.49431E-11, & 
      3.88064E-11,4.30522E-11,4.77139E-11,5.28273E-11,5.84308E-11, & 
      6.45658E-11,7.12764E-11,7.86103E-11,8.66176E-11,9.53534E-11, & 
      1.04875E-10,1.15245E-10,1.26528E-10,1.38796E-10,1.52123E-10/               
      DATA (TOTPLNK(IDATA,16),IDATA=51,100)/ &                                              
      1.66590E-10,1.82281E-10,1.99287E-10,2.17704E-10,2.37632E-10, & 
      2.59182E-10,2.82468E-10,3.07610E-10,3.34738E-10,3.63988E-10, & 
      3.95504E-10,4.29438E-10,4.65951E-10,5.05212E-10,5.47402E-10, & 
      5.92707E-10,6.41329E-10,6.93477E-10,7.49371E-10,8.09242E-10, & 
      8.73338E-10,9.41911E-10,1.01524E-09,1.09359E-09,1.17728E-09, & 
      1.26660E-09,1.36190E-09,1.46350E-09,1.57177E-09,1.68709E-09, & 
      1.80984E-09,1.94044E-09,2.07932E-09,2.22693E-09,2.38373E-09, & 
      2.55021E-09,2.72689E-09,2.91429E-09,3.11298E-09,3.32353E-09, & 
      3.54655E-09,3.78265E-09,4.03251E-09,4.29679E-09,4.57620E-09, & 
      4.87148E-09,5.18341E-09,5.51276E-09,5.86037E-09,6.22708E-09/               
      DATA (TOTPLNK(IDATA,16),IDATA=101,150)/ &                                             
      6.61381E-09,7.02145E-09,7.45097E-09,7.90336E-09,8.37967E-09, & 
      8.88092E-09,9.40827E-09,9.96280E-09,1.05457E-08,1.11583E-08, & 
      1.18017E-08,1.24773E-08,1.31865E-08,1.39306E-08,1.47111E-08, & 
      1.55295E-08,1.63872E-08,1.72860E-08,1.82274E-08,1.92132E-08, & 
      2.02450E-08,2.13247E-08,2.24541E-08,2.36352E-08,2.48699E-08, & 
      2.61602E-08,2.75082E-08,2.89161E-08,3.03860E-08,3.19203E-08, & 
      3.35213E-08,3.51913E-08,3.69330E-08,3.87486E-08,4.06411E-08, & 
      4.26129E-08,4.46668E-08,4.68058E-08,4.90325E-08,5.13502E-08, & 
      5.37617E-08,5.62703E-08,5.88791E-08,6.15915E-08,6.44107E-08, & 
      6.73404E-08,7.03841E-08,7.35453E-08,7.68278E-08,8.02355E-08/               
      DATA (TOTPLNK(IDATA,16),IDATA=151,181)/ &                                             
      8.37721E-08,8.74419E-08,9.12486E-08,9.51968E-08,9.92905E-08, & 
      1.03534E-07,1.07932E-07,1.12490E-07,1.17211E-07,1.22100E-07, & 
      1.27163E-07,1.32404E-07,1.37829E-07,1.43443E-07,1.49250E-07, & 
      1.55257E-07,1.61470E-07,1.67893E-07,1.74532E-07,1.81394E-07, & 
      1.88485E-07,1.95810E-07,2.03375E-07,2.11189E-07,2.19256E-07, & 
      2.27583E-07,2.36177E-07,2.45046E-07,2.54196E-07,2.63634E-07, & 
      2.73367E-07/                                                               
                                                                                 
      DATA (TOTPLK16(IDATA),IDATA=1,50)/ &                                                  
      4.46128E-13,5.19008E-13,6.02681E-13,6.98580E-13,8.08302E-13, & 
      9.33629E-13,1.07654E-12,1.23925E-12,1.42419E-12,1.63407E-12, & 
      1.87190E-12,2.14099E-12,2.44498E-12,2.78793E-12,3.17424E-12, & 
      3.60881E-12,4.09698E-12,4.64461E-12,5.25813E-12,5.94456E-12, & 
      6.71156E-12,7.56752E-12,8.52154E-12,9.58357E-12,1.07644E-11, & 
      1.20758E-11,1.35304E-11,1.51420E-11,1.69256E-11,1.88973E-11, & 
      2.10746E-11,2.34762E-11,2.61227E-11,2.90356E-11,3.22388E-11, & 
      3.57574E-11,3.96187E-11,4.38519E-11,4.84883E-11,5.35616E-11, & 
      5.91075E-11,6.51647E-11,7.17743E-11,7.89797E-11,8.68284E-11, & 
      9.53697E-11,1.04658E-10,1.14748E-10,1.25701E-10,1.37582E-10/               
      DATA (TOTPLK16(IDATA),IDATA=51,100)/ &                                                
      1.50457E-10,1.64400E-10,1.79487E-10,1.95799E-10,2.13422E-10, & 
      2.32446E-10,2.52970E-10,2.75094E-10,2.98925E-10,3.24578E-10, & 
      3.52172E-10,3.81833E-10,4.13695E-10,4.47897E-10,4.84588E-10, & 
      5.23922E-10,5.66063E-10,6.11182E-10,6.59459E-10,7.11081E-10, & 
      7.66251E-10,8.25172E-10,8.88065E-10,9.55155E-10,1.02668E-09, & 
      1.10290E-09,1.18406E-09,1.27044E-09,1.36233E-09,1.46002E-09, & 
      1.56382E-09,1.67406E-09,1.79108E-09,1.91522E-09,2.04686E-09, & 
      2.18637E-09,2.33416E-09,2.49063E-09,2.65622E-09,2.83136E-09, & 
      3.01653E-09,3.21221E-09,3.41890E-09,3.63712E-09,3.86740E-09, & 
      4.11030E-09,4.36641E-09,4.63631E-09,4.92064E-09,5.22003E-09/               
      DATA (TOTPLK16(IDATA),IDATA=101,150)/ &                                               
      5.53516E-09,5.86670E-09,6.21538E-09,6.58191E-09,6.96708E-09, & 
      7.37165E-09,7.79645E-09,8.24229E-09,8.71007E-09,9.20066E-09, & 
      9.71498E-09,1.02540E-08,1.08186E-08,1.14100E-08,1.20290E-08, & 
      1.26767E-08,1.33544E-08,1.40630E-08,1.48038E-08,1.55780E-08, & 
      1.63867E-08,1.72313E-08,1.81130E-08,1.90332E-08,1.99932E-08, & 
      2.09945E-08,2.20385E-08,2.31267E-08,2.42605E-08,2.54416E-08, & 
      2.66716E-08,2.79520E-08,2.92846E-08,3.06711E-08,3.21133E-08, & 
      3.36128E-08,3.51717E-08,3.67918E-08,3.84749E-08,4.02232E-08, & 
      4.20386E-08,4.39231E-08,4.58790E-08,4.79083E-08,5.00132E-08, & 
      5.21961E-08,5.44592E-08,5.68049E-08,5.92356E-08,6.17537E-08/               
      DATA (TOTPLK16(IDATA),IDATA=151,181)/ &                                               
      6.43617E-08,6.70622E-08,6.98578E-08,7.27511E-08,7.57449E-08, & 
      7.88419E-08,8.20449E-08,8.53568E-08,8.87805E-08,9.23190E-08, & 
      9.59753E-08,9.97526E-08,1.03654E-07,1.07682E-07,1.11841E-07, & 
      1.16134E-07,1.20564E-07,1.25135E-07,1.29850E-07,1.34712E-07, & 
      1.39726E-07,1.44894E-07,1.50221E-07,1.55711E-07,1.61367E-07, & 
      1.67193E-07,1.73193E-07,1.79371E-07,1.85732E-07,1.92279E-07, & 
      1.99016E-07/                                                               

!-----------------------------------------------------------------------
!
      CONTAINS
!
!-----------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!-----------------------------------------------------------------------
      SUBROUTINE RADIATION(ITIMESTEP,DT,JULDAY,JULYR,XTIME,JULIAN       &
     &                    ,IHRST,NPHS,GLAT,GLON                         &
     &                    ,NRADS,NRADL                                  &
     &                    ,DSG2,SGML2,PDSG1,PSGML1,PT,PD                &
     &                    ,T,Q,CWM                                      &
     &                    ,THS,ALBEDO,EPSR                              &
     &                    ,F_ICE,F_RAIN                                 &
     &                    ,P_QV,P_QC,P_QR,P_QI,P_QS,P_QG                &
     &                    ,F_QV,F_QC,F_QR,F_QI,F_QS,F_QG                &
     &                    ,SM,CLDFRA                                    &
     &                    ,NUM_WATER,WATER                              &
     &                    ,RLWTT,RSWTT                                  &
     &                    ,RLWIN,RSWIN                                  &
     &                    ,RSWINC,RSWOUT                                &
     &                    ,RLWTOA,RSWTOA                                &
     &                    ,CZMEAN,SIGT4                                 &
     &                    ,CFRACL,CFRACM,CFRACH                         &
     &                    ,ACFRST,NCFRST                                &
     &                    ,ACFRCV,NCFRCV                                &
     &                    ,CUPPT,VEGFRC,SNOW                            &
     &                    ,HTOP,HBOT                                    &
     &                    ,SHORTWAVE,LONGWAVE                           &
     &                    ,LM)
!-----------------------------------------------------------------------
!***  NOTE ***
! RLWIN  - downward longwave at the surface (=TOTLWDN, now a local array)
! RSWIN  - downward shortwave at the surface (=TOTSWDN, now a local array)
! RSWINC - CLEAR-SKY downward shortwave at the surface (=TOTSWDNC, new for AQ)
!-----------------------------------------------------------------------
!***********************************************************************
!-----------------------------------------------------------------------
!$$$  SUBPROGRAM DOCUMENTATION BLOCK
!                .      .    .     
! SUBPROGRAM:    RADIATION   RADIATION OUTER DRIVER
!   PRGRMMR: BLACK           ORG: W/NP22     DATE: 2002-06-04       
!     
! ABSTRACT:
!     RADIATION SERVES AS THE INTERFACE BETWEEN THE NMMB PHYSICS COMPONENT
!     AND THE WRF RADIATION DRIVER.
!     
! PROGRAM HISTORY LOG:
!   02-06-04  BLACK      - ORIGINATOR
!   02-09-09  WOLFE      - CONVERTING TO GLOBAL INDEXING
!   04-11-18  BLACK      - THREADED
!   06-07-20  BLACK      - INCORPORATED INTO NMMB PHYSICS COMPONENT
!   08-08     JANJIC     - Synchronize WATER array and Q.
!   08-11-23  janjic     - general hybrid coordinate
!     
! USAGE: CALL RADIATION FROM PHY_RUN
!
! ATTRIBUTES:
!   LANGUAGE: FORTRAN 90
!   MACHINE : IBM 
!$$$  
!-----------------------------------------------------------------------
!
      IMPLICIT NONE
!
!-----------------------------------------------------------------------
!
      INTEGER,INTENT(IN) :: LM                                          &
     &                     ,IHRST,ITIMESTEP,JULDAY,JULYR                &
     &                     ,NPHS,NRADL,NRADS,NUM_WATER
!
      INTEGER,INTENT(IN) :: P_QV,P_QC,P_QR,P_QI,P_QS,P_QG
!
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: NCFRCV,NCFRST
!
      REAL,INTENT(IN) :: DT,JULIAN,PT,XTIME
!
      REAL,DIMENSION(1:LM),INTENT(IN) :: DSG2,PDSG1,PSGML1,SGML2
!
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: ALBEDO,CUPPT        &
     &                                             ,EPSR,GLAT,GLON      &
     &                                             ,PD,SM               &
     &                                             ,SNOW,THS,VEGFRC
!
      REAL,DIMENSION(IMS:IME,JMS:JME,LM),INTENT(IN) :: CWM,Q,T
!
      REAL,DIMENSION(IMS:IME,JMS:JME,1:LM),INTENT(IN) :: F_ICE,F_RAIN
!
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: ACFRCV,ACFRST    &
     &                                                ,RLWIN,RLWTOA     &
     &                                                ,RSWIN,RSWOUT     &
     &                                                ,HBOT,HTOP        &
     &                                                ,RSWINC,RSWTOA
!
      REAL,DIMENSION(IMS:IME,JMS:JME,LM),INTENT(INOUT) :: RLWTT,RSWTT
!
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: CFRACH,CFRACL      &
     &                                              ,CFRACM,CZMEAN      &
     &                                              ,SIGT4
!
      REAL,DIMENSION(IMS:IME,JMS:JME,LM,NUM_WATER),INTENT(INOUT) :: WATER
!
      REAL,DIMENSION(IMS:IME,JMS:JME,1:LM),INTENT(OUT) :: CLDFRA
!
      LOGICAL,INTENT(IN) :: F_QV,F_QC,F_QR,F_QI,F_QS,F_QG
!
      CHARACTER(99),INTENT(IN) :: LONGWAVE,SHORTWAVE
!
!-----------------------------------------------------------------------
!***
!***  LOCAL VARIABLES
!***
!-----------------------------------------------------------------------
      INTEGER :: I,ICLOUD,II,J,JDAY,JMONTH                              &
                ,K,KFLIP,KMNTH,N,NRAD,NTSD
!
      INTEGER :: RA_LW_PHYSICS=0,RA_SW_PHYSICS=0
!
      INTEGER,DIMENSION(3) :: IDAT
      INTEGER,DIMENSION(12) :: MONTH=(/31,28,31,30,31,30,31,31          &
     &                                ,30,31,30,31/)
!
      REAL :: CAPA,DAYI,DPL,FICE,FRAIN,GMT,HOUR,PDSL,PLYR,PSFC          &
     &       ,RADT,TIMES,TDUM
!
      REAL,DIMENSION(1:LM) :: QL,TL
!
      REAL,DIMENSION(IMS:IME,JMS:JME) :: REXNSFC,SWNETDN                &
     &                                  ,TOT,TSFC,XLAND,XLAT,XLON       &
     &                                  ,TOTLWDN,TOTSWDN,TOTSWDNC,CZEN  &
     &                                  ,HBOTR,HTOPR,CUPPTR
!
!
      REAL,DIMENSION(IMS:IME,1:LM+1,JMS:JME) :: PM2_5_DRY,PM2_5_WATER   &
     &                                         ,DZ,P8W,P_PHY,PI_PHY     &
     &                                         ,RR,T8W,THRATEN          &
     &                                         ,THRATENLW,THRATENSW     &
     &                                         ,TH_PHY,T_PHY,CLFR
!
      REAL,DIMENSION(:,:,:,:),ALLOCATABLE :: WATER_TRANS
!
      LOGICAL :: WARM_RAIN
!
!-----------------------------------------------------------------------
!
      INTEGER,DIMENSION(NUM_TILES) :: I_START,I_END,J_START,J_END
!
!-----------------------------------------------------------------------
!***********************************************************************
!-----------------------------------------------------------------------
!*****
!***** NOTE: THIS IS HARDWIRED FOR CALLS TO LONGWAVE AND SHORTWAVE
!*****       AT EQUAL INTERVALS
!*****
      NRAD=NRADS
      RADT=DT*NRADS/60.
!
!-----------------------------------------------------------------------
!***  PHYSICS EXPECTS FIRST TIMESTEP(=1) TO BE ZERO.
!-----------------------------------------------------------------------
!
!!!   NTSD=ITIMESTEP-1
      NTSD=ITIMESTEP
!
!-----------------------------------------------------------------------
!
      IF(.NOT.ALLOCATED(WATER_TRANS))THEN
        ALLOCATE(WATER_TRANS(IMS:IME,1:LM+1,JMS:JME,NUM_WATER))
      ENDIF
!
!-----------------------------------------------------------------------
!
      CAPA=CAPPA
      MYPE=MYPE_SHARE
!
!-----------------------------------------------------------------------
!***  NOTE:  THE NMMB HAS IJK STORAGE WITH LAYER 1 AT THE TOP.
!***         THE WRF PHYSICS DRIVERS HAVE IKJ STORAGE WITH LAYER 1 
!***         AT THE BOTTOM.
!-----------------------------------------------------------------------
!
!jaa!$omp parallel do                                                       &
!jaa!$omp& private(dpl,fice,frain,i,j,k,pdsl,plyr,qi,ql,qr,qw,tl,wc)
!!!   DO J=JTS_B1,JTE_B1
!!!   DO I=ITS_B1,ITE_B1
!.......................................................................
!$omp parallel do                                                    &
!$omp private (j,i,k,kflip,pdsl,plyr,ql,tl,psfc)
!.......................................................................
      DO J=JTS,JTE
      DO I=ITS,ITE
!
        PDSL=PD(I,J)
        XLAT(I,J)=GLAT(I,J)*RTD
        XLON(I,J)=GLON(I,J)*RTD
        XLAND(I,J)=SM(I,J)+1.
        P8W(I,LM+1,J)=PT
!
!-----------------------------------------------------------------------
!***  FILL THE SINGLE-COLUMN INPUT
!-----------------------------------------------------------------------
!
        DO K=LM,1,-1   ! We are moving down from the top in the flipped arrays
          KFLIP=LM+1-K ! The flipped index will thus be for the NMMB arrays
!
          DPL=PDSG1(KFLIP)+DSG2(KFLIP)*PDSL
          PLYR=SGML2(KFLIP)*PDSL+PSGML1(KFLIP)
!
          QL(K)=AMAX1(Q(I,J,KFLIP),EPSQ)
          TL(K)=T(I,J,KFLIP)
!
          RR(I,K,J)=PLYR/(R_D*TL(K)*(1.+P608*QL(K)))
          T_PHY(I,K,J)=TL(K)
          TH_PHY(I,K,J)=TL(K)*(1.E5/PLYR)**CAPA
          P8W(I,K,J)=P8W(I,K+1,J)+PDSG1(KFLIP)+DSG2(KFLIP)*PDSL
          P_PHY(I,K,J)=PLYR
          PI_PHY(I,K,J)=(PLYR*1.E-5)**CAPA
          DZ(I,K,J)=TL(K)*(P608*QL(K)+1.)*R_D                           &
     &                 *(P8W(I,K,J)-P8W(I,K+1,J))                       &
     &                 /(P_PHY(I,K,J)*G)
!
          THRATEN(I,K,J)=0.
          THRATENLW(I,K,J)=0.
          THRATENSW(I,K,J)=0.
          PM2_5_DRY(I,K,J)=0.
          PM2_5_WATER(I,K,J)=0.
!
        ENDDO
!
!-----------------------------------------------------------------------
!
        PSFC=P8W(I,1,J)
        REXNSFC(I,J)=(PSFC*1.E-5)**CAPA
        TSFC(I,J)=THS(I,J)*REXNSFC(I,J)
        T8W(I,1,J)=TSFC(I,J)
!
        DO K=2,LM
          T8W(I,K,J)=0.5*(TL(K-1)+TL(K))
        ENDDO
        T8W(I,LM+1,J)=-1.E20
!
      ENDDO
      ENDDO
!.......................................................................
!$omp end parallel do 
!.......................................................................
!
      ICLOUD=999
!
      GMT=REAL(IHRST)
!
!.......................................................................
!$omp parallel do                                                    &
!$omp private (k,j,i)
!.......................................................................
        DO K=1,LM
        DO J=JMS,JME
        DO I=IMS,IME
          CLDFRA(I,J,K)=0.
        ENDDO
        ENDDO
        ENDDO
!
!.......................................................................
!$omp parallel do                                                    &
!$omp private (j,i)
!.......................................................................
      DO J=JMS,JME
        DO I=IMS,IME
          CFRACH(I,J)=0.
          CFRACL(I,J)=0.
          CFRACM(I,J)=0.
          CZMEAN(I,J)=0.
          SIGT4(I,J)=0.
          TOTSWDN(I,J)=0.   ! TOTAL (clear+cloudy sky) shortwave down at the surface
          TOTSWDNC(I,J)=0.  ! CLEAR SKY shortwave down at the surface
          SWNETDN(I,J)=0.   ! Net (down - up) total (clear+cloudy sky) shortwave at the surface
          TOTLWDN(I,J)=0.   ! Total longwave down at the surface
          CUPPTR(I,J)=CUPPT(I,J)   ! Temporary array set to zero in radiation
        ENDDO
      ENDDO
!.......................................................................
!$omp end parallel do 
!.......................................................................
!
!-----------------------------------------------------------------------
!-- NOTE:  HBOTR, HTOPR are passed into radiation and set equal to HBOT, HTOP.  HBOT, HTOP are
!          reset to clear sky values to be used by the ARW.  At the bottom of this subroutine, 
!          HBOT, HTOP are re-defined again to values stored in HBOTR, HTOPR.  HBOT, HTOP are 
!          reset to clear sky values after the call to radiation and after the top of the hour
!          in subroutine CUCNVC below.
!-----------------------------------------------------------------------
!
!-----------------------------------------------------------------------
!***  SYNCHRONIZE MIXING RATIO IN WATER ARRAY WITH SPECIFIC HUMIDITY.
!-----------------------------------------------------------------------
!
!.......................................................................
!$omp parallel do                                                       &
!$omp& private(i,j,k)
!.......................................................................
      DO K=1,LM                                            
        DO J=JMS,JME                                      
          DO I=IMS,IME                                   
            WATER(I,J,K,P_QV)=Q(I,J,K)/(1.-Q(I,J,K))    
          ENDDO                                        
        ENDDO                                         
      ENDDO                                          
!.......................................................................
!$omp end parallel do
!.......................................................................
!
!-----------------------------------------------------------------------
!***  TRANSPOSE THE MOIST ARRAY (IJK) FOR THE PHYSICS (IKJ).
!***  REMEMBER THAT MOIST AND MOIST_TRANS ARE ONLY USED WITH
!***  THE PHYSICS AND THUS THE P_QV SLOT (=2) IS MIXING RATIO,
!***  NOT SPECIFIC HUMIDITY.
!-----------------------------------------------------------------------
!
!     imax=0
!     jmax=0
!     kmax=0
!     wmax=-1.e10
!     kloop: do k=1,lm
!     do j=jts,jte
!     do i=its,ite
!       if(water(i,j,k,p_qi)>1.)then
!         write(0,*)' water(qi)=',water(i,j,k,p_qi),' at (',i,',',j,',',k,',',p_qi,')'
!         exit kloop
!       endif
!     enddo
!     enddo
!     enddo kloop
!.......................................................................
!$omp parallel do                                                       &
!$omp& private(i,j,k,n,kflip)
!.......................................................................
      DO N=1,NUM_WATER
        DO K=1,LM
        KFLIP=LM+1-K
        DO J=JMS,JME
        DO I=IMS,IME
          WATER_TRANS(I,KFLIP,J,N)=WATER(I,J,K,N)
        ENDDO
        ENDDO
        ENDDO
      ENDDO
!     kloop2: do k=1,lm
!     kflip=lm+1-k
!     do j=jts,jte
!     do i=its,ite
!       if(water_trans(i,k,j,p_qi)>1.)then
!         write(0,*)' water_trans(qi)=',water_trans(i,k,j,p_qi),' at (',i,',',j,',',k,',',p_qi,')' &
!                  ,' water=',water(i,j,kflip,p_qi)
!         exit kloop2
!       endif
!     enddo
!     enddo
!     enddo kloop2
!
!-----------------------------------------------------------------------
!
!***  CALL THE INNER DRIVER.
!
!-----------------------------------------------------------------------
!
!!!!! CALL SET_TILES(GRID,IDS+1,IDE-1,JDS+2,JDE-2,ITS,ITE,JTS,JTE)
      DO K=1,NUM_TILES
!!!     I_START(K)=ITS
!!!     I_END(K)=ITE
!!!     J_START(K)=JTS
!!!     J_END(K)=JTE
        I_START(K)=ITS_B1
        I_END(K)=ITE_B1
        J_START(K)=JTS_B1
        J_END(K)=JTE_B1
      ENDDO
!
!-----------------------------------------------------------------------
!
!***  A PRIMARY MODIFICATION TO THE WRF DRIVER IS THE SPECIFICATION
!***  OF THE PACKAGES IN THE SELECT_CASE BLOCKS BEING CHANGED FROM
!***  INTEGERS (LISTED IN THE PHYSICS SECTION OF THE WRF REGISTRY)
!***  TO CHARACTERS (AS DEFINED IN THE ESMF CONFIG FILE).
!
!-----------------------------------------------------------------------
!***  TRANSLATE THE RADIATION OPTIONS IN THE CONFIG FILE TO THEIR
!***  ANALOGS IN THE WRF REGISTRY SO THAT THE WRF RADIATION DRIVER
!***  REMAINS UNTOUCHED.
!-----------------------------------------------------------------------
!
!     write(0,*)' RADIATION before SELECT CASE shortwave=',trim(shortwave) &
!              ,' longwave=',trim(longwave)
      SELECT CASE (TRIM(SHORTWAVE))
        CASE ('gfdl')
          RA_SW_PHYSICS=99
        CASE ('dudh')
          RA_SW_PHYSICS=1
        CASE ('gsfc')
          RA_SW_PHYSICS=2
        CASE DEFAULT
          WRITE(0,*)' User selected SHORTWAVE=',TRIM(SHORTWAVE)
          WRITE(0,*)' Improper selection of SW scheme in RADIATION'
!!!       CALL ESMF_Finalize(terminationflag=ESMF_ABORT)
          CALL NMMB_FINALIZE
      END SELECT
!
      SELECT CASE (TRIM(LONGWAVE))
        CASE ('gfdl')
          RA_LW_PHYSICS=99
        CASE ('rrtm')
          RA_LW_PHYSICS=1
        CASE DEFAULT
          WRITE(0,*)' User selected LONGWAVE=',TRIM(LONGWAVE)
          WRITE(0,*)' Improper selection of LW scheme in RADIATION'
!!!       CALL ESMF_Finalize(terminationflag=ESMF_ABORT)
          CALL NMMB_FINALIZE
      END SELECT
!
!     write(0,*)' RADIATION before driver max QI=',maxval(water_trans(its:ite,1:lm,jts:jte,p_qi)) &
!              ,' min QI=',minval(water_trans(its:ite,1:lm,jts:jte,p_qi)),' p_qi=',p_qi,' f_qi=',f_qi
!-----------------------------------------------------------------------
      CALL RADIATION_DRIVER(                                            &
     &                  IDS=IDS,IDE=IDE,JDS=JDS,JDE=JDE,KDS=1,KDE=LM+1  &
     &                 ,IMS=IMS,IME=IME,JMS=JMS,JME=JME,KMS=1,KME=LM+1  &
     &                 ,I_START=I_START,I_END=I_END                     &
     &                 ,J_START=J_START,J_END=J_END                     &
     &                 ,KTS=1,KTE=LM,NUM_TILES=NUM_TILES                &
     &                 ,ITIMESTEP=NTSD,DT=DT                            &
     &                 ,PM2_5_DRY=PM2_5_DRY,PM2_5_WATER=PM2_5_WATER     &
     &                 ,RTHRATENLW=THRATENLW,RTHRATENSW=THRATENSW       &
     &                 ,RTHRATEN=THRATEN                                &
     &                 ,GLW=TOTLWDN,GSW=SWNETDN,SWDOWN=TOTSWDN          &
     &                 ,XLAT=XLAT,XLONG=XLON,ALBEDO=ALBEDO,EMISS=EPSR   &
     &                 ,XLAND=XLAND,TSK=TSFC                            &
     &                 ,HTOP=HTOP,HBOT=HBOT,CUPPT=CUPPTR                &
     &                 ,HTOPR=HTOPR,HBOTR=HBOTR                         &
     &                 ,VEGFRA=VEGFRC,SNOW=SNOW                         &
     &                 ,RHO=RR,P8W=P8W,P=P_PHY,PI=PI_PHY                &
     &                 ,DZ8W=DZ,T=T_PHY,T8W=T8W,GMT=GMT                 &
     &                 ,JULDAY=JULDAY,JULYR=JULYR,NPHS=NPHS             &
     &                 ,JULIAN=JULIAN,XTIME=XTIME                       &
     &                 ,LW_PHYSICS=RA_LW_PHYSICS                        &
     &                 ,SW_PHYSICS=RA_SW_PHYSICS                        &
     &                 ,RADT=RADT,STEPRA=NRAD,ICLOUD=ICLOUD             &
     &                 ,WARM_RAIN=WARM_RAIN                             & 
     &                 ,SWDOWNC=TOTSWDNC,CLDFRA=CLFR                    &
     &                 ,RSWTOA=RSWTOA,RLWTOA=RLWTOA                     &
     &                 ,CZMEAN=CZMEAN,CFRACL=CFRACL                     &
     &                 ,CFRACM=CFRACM,CFRACH=CFRACH                     &
     &                 ,ACFRST=ACFRST,NCFRST=NCFRST                     &
     &                 ,ACFRCV=ACFRCV,NCFRCV=NCFRCV                     &
     &                 ,QV=WATER_TRANS(IMS,1,JMS,P_QV),F_QV=F_QV        &
     &                 ,QC=WATER_TRANS(IMS,1,JMS,P_QC),F_QC=F_QC        &
     &                 ,QR=WATER_TRANS(IMS,1,JMS,P_QR),F_QR=F_QR        &
     &                 ,QI=WATER_TRANS(IMS,1,JMS,P_QI),F_QI=F_QI        &
     &                 ,QS=WATER_TRANS(IMS,1,JMS,P_QS),F_QS=F_QS        &
     &                 ,QG=WATER_TRANS(IMS,1,JMS,P_QG),F_QG=F_QG)
!
!-----------------------------------------------------------------------
!
!***  UPDATE FLUXES AND TEMPERATURE TENDENCIES.
!
!-----------------------------------------------------------------------
!***  SHORTWAVE
!-----------------------------------------------------------------------
!
!-----------------------------------------------------------------------
      IF(MOD(NTSD,NRADS)==0)THEN
!-----------------------------------------------------------------------
!
        IF(TRIM(SHORTWAVE)/='gfdl')THEN
!
!-----------------------------------------------------------------------
!***  COMPUTE CZMEAN FOR NON-GFDL SHORTWAVE
!-----------------------------------------------------------------------
!
          DO J=JMS,JME
          DO I=IMS,IME
            CZMEAN(I,J)=0.
            TOT(I,J)=0.
          ENDDO
          ENDDO
!
          CALL CAL_MON_DAY(JULDAY,JULYR,JMONTH,JDAY)
          IDAT(1)=JMONTH
          IDAT(2)=JDAY
          IDAT(3)=JULYR
!
          DO II=0,NRADS,NPHS
            TIMES=NTSD*DT+II*DT
            CALL ZENITH(TIMES,DAYI,HOUR,IDAT,IHRST,GLON,GLAT,CZEN       &
     &                 ,ITS,ITE,JTS,JTE                                 &
     &                 ,IDS,IDE,JDS,JDE,1,LM+1                          &
     &                 ,IMS,IME,JMS,JME,1,LM+1                          &
     &                 ,ITS,ITE,JTS,JTE,1,LM)
            DO J=JTS,JTE
            DO I=ITS,ITE
              IF(CZEN(I,J)>0.)THEN
                CZMEAN(I,J)=CZMEAN(I,J)+CZEN(I,J)
                TOT(I,J)=TOT(I,J)+1.
              ENDIF
            ENDDO
            ENDDO
!
          ENDDO
!
          DO J=JTS,JTE
          DO I=ITS,ITE
            IF(TOT(I,J)>0.)CZMEAN(I,J)=CZMEAN(I,J)/TOT(I,J)
          ENDDO
          ENDDO
!
!-----------------------------------------------------------------------
!***  COMPUTE TOTAL SFC SHORTWAVE DOWN FOR NON-GFDL SCHEMES
!-----------------------------------------------------------------------
!
!jaa!$omp parallel do                                                       &
!jaa!$omp& private(i,j)
          DO J=JTS_B1,JTE_B1
          DO I=ITS_B1,ITE_B1
!
            TOTSWDN(I,J)=SWNETDN(I,J)/(1.-ALBEDO(I,J))  
!--- No value currently available for clear-sky solar fluxes from
!    non GFDL schemes, though it's needed for air quality forecasts.
!    For the time being, set to the total downward solar fluxes.
            TOTSWDNC(I,J)=TOTSWDN(I,J)
!
          ENDDO
          ENDDO
!
        ENDIF   !End non-GFDL block
!-----------------------------------------------------------------------
!
!.......................................................................
!$omp parallel do                                                       &
!$omp& private(i,j,k,kflip)
!.......................................................................
        DO J=JTS_B1,JTE_B1
          DO I=ITS_B1,ITE_B1
!
            RSWIN(I,J)=TOTSWDN(I,J)
            RSWINC(I,J)=TOTSWDNC(I,J)
            RSWOUT(I,J)=TOTSWDN(I,J)-SWNETDN(I,J)
!
            DO K=1,LM
              KFLIP=LM+1-K
              RSWTT(I,J,KFLIP)=THRATENSW(I,K,J)*PI_PHY(I,K,J)
            ENDDO
!
          ENDDO
        ENDDO
!.......................................................................
!$omp end parallel do
!.......................................................................
!
      ENDIF
!
!-----------------------------------------------------------------------
!***  LONGWAVE
!-----------------------------------------------------------------------
!
      IF(MOD(NTSD,NRADL)==0)THEN
!
!.......................................................................
!$omp parallel do                                                       &
!$omp& private(i,j,k,kflip,tdum)
!.......................................................................
        DO J=JTS_B1,JTE_B1
          DO I=ITS_B1,ITE_B1
!
            TDUM=T(I,J,LM)
            SIGT4(I,J)=STBOLT*TDUM*TDUM*TDUM*TDUM
!
            DO K=1,LM
              KFLIP=LM+1-K
              RLWTT(I,J,KFLIP)=THRATENLW(I,K,J)*PI_PHY(I,K,J)

	if (K .eq. 10 .and. I .eq. 50 .and. J .eq. 50) then
!	write(0,*) 'THRATENLW(I,K,J),PI_PHY(I,K,J): ', THRATENLW(I,K,J),PI_PHY(I,K,J)
	endif

            ENDDO
!
            RLWIN(I,J)=TOTLWDN(I,J)
!
          ENDDO
        ENDDO
!.......................................................................
!$omp end parallel do
!.......................................................................
!
      ENDIF
!
!-- Store 3D cloud fractions & restore HBOT/HTOP arrays
!
      DO J=JTS_B1,JTE_B1
        DO K=1,LM
          DO I=ITS_B1,ITE_B1
            CLDFRA(I,J,K)=CLFR(I,K,J)
          ENDDO
        ENDDO
      ENDDO
!.......................................................................
!$omp parallel do                                                       &
!$omp& private(i,j)
!.......................................................................
      DO J=JTS_B1,JTE_B1
        DO I=ITS_B1,ITE_B1
          HBOT(I,J)=HBOTR(I,J)
          HTOP(I,J)=HTOPR(I,J)
        ENDDO
      ENDDO
!.......................................................................
!$omp end parallel do
!.......................................................................
!
!-----------------------------------------------------------------------
!
      DEALLOCATE(WATER_TRANS)
!
!-----------------------------------------------------------------------
!
      END SUBROUTINE RADIATION
!
!-----------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!-----------------------------------------------------------------------
      SUBROUTINE RDTEMP(NTSD,DT,JULDAY,JULYR,IHRST,GLAT,GLON            &
     &                 ,CZEN,CZMEAN,T,RSWTT,RLWTT                       &
     &                 ,LM)
!***********************************************************************
!$$$  SUBPROGRAM DOCUMENTATION BLOCK
!                .      .    .     
! SUBPROGRAM:    RDTEMP      RADIATIVE TEMPERATURE CHANGE
!   PRGRMMR: BLACK           ORG: W/NP22     DATE: 93-12-29
!     
! ABSTRACT:
!     RDTEMP APPLIES THE TEMPERATURE TENDENCIES DUE TO
!     RADIATION AT ALL LAYERS AT EACH ADJUSTMENT TIME STEP
!     
! PROGRAM HISTORY LOG:
!   87-09-??  BLACK      - ORIGINATOR
!   95-03-25  BLACK      - CONVERSION FROM 1-D TO 2-D IN HORIZONTAL
!   95-11-20  ABELES     - PARALLEL OPTIMIZATION
!   98-10-30  BLACK      - MODIFIED FOR DISTRIBUTED MEMORY
!   02-06-07  BLACK      - WRF CODING STANDARDS
!   02-09-09  WOLFE      - CONVERTING TO GLOBAL INDEXING
!   06-08-29  BLACK      - INTO NMMB
!     
! USAGE: CALL RDTEMP FROM SUBROUTINE PHY_RUN
!  
! ATTRIBUTES:
!   LANGUAGE: FORTRAN 90
!   MACHINE : IBM 
!$$$  
!-----------------------------------------------------------------------
!
      IMPLICIT NONE
!
!-----------------------------------------------------------------------
!
      INTEGER,INTENT(IN) :: LM
!
      INTEGER,INTENT(IN) :: IHRST,JULDAY,JULYR,NTSD
!
      REAL,INTENT(IN) :: DT
!
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: CZMEAN,GLAT,GLON 
!
      REAL,DIMENSION(IMS:IME,JMS:JME,1:LM),INTENT(IN) :: RLWTT,RSWTT
!
      REAL,DIMENSION(IMS:IME,JMS:JME,1:LM),INTENT(INOUT) :: T
!
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: CZEN
!
!-----------------------------------------------------------------------
!***  LOCAL VARIABLES
!-----------------------------------------------------------------------
!
      INTEGER :: I,J,JDAY,JMONTH,K
!
      INTEGER,DIMENSION(3) :: IDAT
!
      REAL :: DAYI,HOUR,TIMES,TTNDKL
!
      REAL,DIMENSION(IMS:IME,JMS:JME) :: CZEN2,XLAT2,XLON2
!
      REAL,DIMENSION(ITS:ITE,JTS:JTE) :: FACTR
!
      REAL :: DEGRAD=3.1415926/180.
      real :: xlat1,xlon1
!
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!
!***  GET CURRENT VALUE OF COS(ZENITH ANGLE)
!
      TIMES=NTSD*DT
!
!     DO J=JTS_B1,JTE_B1
!     DO I=ITS_B1,ITE_B1
      DO J=JTS,JTE
      DO I=ITS,ITE
        XLAT2(I,J)=GLAT(I,J)
        XLON2(I,J)=GLON(I,J)
!!!!!!!!!!!!Remove the following lines after bit-correct answers
!!!!!!!!!!!!are established with the control
!       xlat1=glat(i,j)/degrad
!       xlat2(i,j)=xlat1*degrad
!       xlon1=glon(i,j)/degrad
!       xlon2(i,j)=xlon1*degrad
!!!!!!!!!!!!
!!!!!!!!!!!!
      ENDDO
      ENDDO
!
      CALL CAL_MON_DAY(JULDAY,JULYR,JMONTH,JDAY)

      IDAT(1)=JMONTH
      IDAT(2)=JDAY
      IDAT(3)=JULYR
!
      CALL ZENITH(TIMES,DAYI,HOUR,IDAT,IHRST,XLON2,XLAT2,CZEN2          &
     &           ,ITS,ITE,JTS,JTE                                       &
     &           ,IDS,IDE,JDS,JDE,1,LM+1                                &
     &           ,IMS,IME,JMS,JME,1,LM+1                                &
     &           ,ITS,ITE,JTS,JTE,1,LM)
!
!!    DO J=JTS_B1,JTE_B1
!!    DO I=ITS_B1,ITE_B1
      DO J=JTS,JTE
      DO I=ITS,ITE
        CZEN(I,J)=CZEN2(I,J)
	if (I .eq. 50 .and. J .eq. 50) then
!	write(0,*) 'CZEN(50,50) in ZENITH: ', CZEN(50,50)
	endif
        IF(CZMEAN(I,J)>0.)THEN 
          FACTR(I,J)=CZEN(I,J)/CZMEAN(I,J)
        ELSE
          FACTR(I,J)=0.
        ENDIF
      ENDDO
      ENDDO
!
      DO K=1,LM
        DO J=JTS_B1,JTE_B1
        DO I=ITS_B1,ITE_B1
	if (I .eq. 50 .and. J .eq. 50 .and. K .eq. 10) then
!	write(0,*) 'FACTR(I,J), RSWTT, RLWTT: ', FACTR(I,J), RSWTT(I,J,10), RLWTT(I,J,10)
	endif
          TTNDKL=RSWTT(I,J,K)*FACTR(I,J)+RLWTT(I,J,K)
          T(I,J,K)=T(I,J,K)+TTNDKL*DT
        ENDDO
        ENDDO
      ENDDO
!-----------------------------------------------------------------------
!
      END SUBROUTINE RDTEMP
!
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!-----------------------------------------------------------------------
      SUBROUTINE TIME_MEASURE(START_YEAR,START_MONTH,START_DAY          &
                             ,START_HOUR,START_MINUTE,START_SECOND      &
                             ,NTIMESTEP,DT                              &
                             ,JULDAY,JULYR,JULIAN,XTIME)
!-----------------------------------------------------------------------
!
      IMPLICIT NONE
!
!-----------------------------------------------------------------------
!
      INTEGER,INTENT(IN) :: START_YEAR,START_MONTH,START_DAY,START_HOUR &
     &                     ,START_MINUTE,START_SECOND,NTIMESTEP
!
      REAL,INTENT(IN) :: DT
!
      INTEGER,INTENT(OUT) :: JULDAY,JULYR
!
      REAL,INTENT(OUT) :: JULIAN,XTIME
!
!-----------------------------------------------------------------------
!***  LOCAL VARIABLES
!-----------------------------------------------------------------------
!
      INTEGER :: N
!
      INTEGER,DIMENSION(12),SAVE :: MONTH=(/31,28,31,30,31,30           &
                                           ,31,31,30,31,30,31/)
!
      REAL :: SUM
!
!-----------------------------------------------------------------------
!***********************************************************************
!-----------------------------------------------------------------------
!
      JULYR=START_YEAR
!
      IF(MOD(START_YEAR,4)==0)THEN
        MONTH(2)=29
      ENDIF
!
            JULDAY=0
        julcount: DO N=1,12
                IF(N==START_MONTH)EXIT julcount
                JULDAY=JULDAY+MONTH(N)
        ENDDO julcount
!
      JULDAY=JULDAY+START_DAY  ! The day of the year the forecast begins
                               ! 12Z 2 January --> 2
!
      SUM=(START_HOUR+(START_MINUTE+START_SECOND/60.)/60.)/24.
      JULIAN=JULDAY-(1.-SUM)  ! The exact day the forecast begins
                              ! 12Z 2 January --> 1.5
!
!!!   XTIME=(NTIMESTEP-1)*DT/60. ! Minutes since start of forecast
      XTIME=NTIMESTEP*DT/60. ! Minutes since start of forecast
!
!-----------------------------------------------------------------------
!
      END SUBROUTINE TIME_MEASURE
!
!-----------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!-----------------------------------------------------------------------
   SUBROUTINE radiation_driver (                                          &
               itimestep,dt ,lw_physics,sw_physics ,NPHS                  &
              ,RTHRATENLW ,RTHRATENSW ,RTHRATEN                           &
              ,GLW, GSW, SWDOWN, XLAT, XLONG, ALBEDO                      &
              ,EMISS, rho, p8w, p , pi , dz8w ,t, t8w, GMT                &
              ,XLAND, TSK, HTOP,HBOT,HTOPR,HBOTR, CUPPT, VEGFRA, SNOW     &
              ,julyr, JULDAY, julian, RADT, STEPRA, ICLOUD, warm_rain     &
              ,RSWTOA,RLWTOA, CZMEAN                                      &
              ,CFRACL, CFRACM, CFRACH                                     &
              ,ACFRST,NCFRST,ACFRCV,NCFRCV,SWDOWNC                        &
              ,taucldi, taucldc, xtime                                    & ! Optional
              ,ids, ide, jds, jde, kds, kde                               &
              ,ims, ime, jms, jme, kms, kme                               &
              ,i_start, i_end                                             &
              ,j_start, j_end                                             &
              ,kts, kte                                                   &
              ,num_tiles                                                  &
              ,qv,qc,qr,qi,qs,qg                                          &
              ,f_qv,f_qc,f_qr,f_qi,f_qs,f_qg                              &
              ,CLDFRA ,Pb                                         &
              ,pm2_5_dry, pm2_5_water, pm2_5_dry_ec                       &
              ,tauaer300, tauaer400, tauaer600, tauaer999                 & ! jcb
              ,gaer300, gaer400, gaer600, gaer999                         & ! jcb
              ,waer300, waer400, waer600, waer999                         & ! jcb
                                                                          )

!-------------------------------------------------------------------------

! !USES:
!!!USE module_state_description, ONLY : RRTMSCHEME, GFDLLWSCHEME        &
!!!                                    ,SWRADSCHEME, GSFCSWSCHEME       &
!!!                                    ,GFDLSWSCHEME
!!!USE module_model_constants

! *** add new modules of schemes here

!!!USE module_ra_sw
!!!USE module_ra_gsfcsw
!!!USE module_ra_rrtm
!!!USE module_ra_gfdleta

   !  This driver calls subroutines for the radiation parameterizations.
   !
   !  short wave radiation choices:
   !  1. swrad (19??)
   !
   !  long wave radiation choices:
   !  1. rrtmlwrad
   !
!----------------------------------------------------------------------
   IMPLICIT NONE
!<DESCRIPTION>
!
! Radiation_driver is the WRF mediation layer routine that provides the interface to
! to radiation physics packages in the WRF model layer. The radiation
! physics packages to call are chosen by setting the namelist variable
! (Rconfig entry in Registry) to the integer value assigned to the 
! particular package (package entry in Registry). For example, if the
! namelist variable ra_lw_physics is set to 1, this corresponds to the
! Registry Package entry for swradscheme.  Note that the Package
! names in the Registry are defined constants (frame/module_state_description.F)
! in the CASE statements in this routine.
!
! Among the arguments is moist, a four-dimensional scalar array storing
! a variable number of moisture tracers, depending on the physics 
! configuration for the WRF run, as determined in the namelist.  The
! highest numbered index of active moisture tracers the integer argument
! n_moist (note: the number of tracers at run time is the quantity
! <tt>n_moist - PARAM_FIRST_SCALAR + 1</tt> , not n_moist. Individual tracers
! may be indexed from moist by the Registry name of the tracer prepended
! with P_; for example P_QC is the index of cloud water. An index 
! represents a valid, active field only if the index is greater than
! or equal to PARAM_FIRST_SCALAR.  PARAM_FIRST_SCALAR and the individual
! indices for each tracer is defined in module_state_description and
! set in <a href=set_scalar_indices_from_config.html>set_scalar_indices_from_config</a> defined in frame/module_configure.F.
!
! Physics drivers in WRF 2.0 and higher, originally model-layer 
! routines, have been promoted to mediation layer routines and they
! contain OpenMP threaded loops over tiles.  Thus, physics drivers
! are called from single-threaded regions in the solver. The physics
! routines that are called from the physics drivers are model-layer
! routines and fully tile-callable and thread-safe.
!</DESCRIPTION>
! 
!======================================================================
! Grid structure in physics part of WRF
!----------------------------------------------------------------------
! The horizontal velocities used in the physics are unstaggered
! relative to temperature/moisture variables. All predicted
! variables are carried at half levels except w, which is at full
! levels. Some arrays with names (*8w) are at w (full) levels.
!
!----------------------------------------------------------------------
! In WRF, kms (smallest number) is the bottom level and kme (largest
! number) is the top level.  In your scheme, if 1 is at the top level,
! then you have to reverse the order in the k direction.
!
!         kme      -   half level (no data at this level)
!         kme    ----- full level
!         kme-1    -   half level
!         kme-1  ----- full level
!         .
!         .
!         .
!         kms+2    -   half level
!         kms+2  ----- full level
!         kms+1    -   half level
!         kms+1  ----- full level
!         kms      -   half level
!         kms    ----- full level
!
!======================================================================
! Grid structure in physics part of WRF
! 
!-------------------------------------
! The horizontal velocities used in the physics are unstaggered 
! relative to temperature/moisture variables. All predicted 
! variables are carried at half levels except w, which is at full 
! levels. Some arrays with names (*8w) are at w (full) levels.
!
!==================================================================
! Definitions
!-----------
! Theta      potential temperature (K)
! Qv         water vapor mixing ratio (kg/kg)
! Qc         cloud water mixing ratio (kg/kg)
! Qr         rain water mixing ratio (kg/kg)
! Qi         cloud ice mixing ratio (kg/kg)
! Qs         snow mixing ratio (kg/kg)
!-----------------------------------------------------------------
!-- PM2_5_DRY     Dry PM2.5 aerosol mass for all species (ug m^-3)
!-- PM2_5_WATER   PM2.5 water mass (ug m^-3)
!-- PM2_5_DRY_EC  Dry PM2.5 elemental carbon aersol mass (ug m^-3)
!-- RTHRATEN      Theta tendency 
!                 due to radiation (K/s)
!-- RTHRATENLW    Theta tendency 
!                 due to long wave radiation (K/s)
!-- RTHRATENSW    Theta temperature tendency 
!                 due to short wave radiation (K/s)
!-- dt            time step (s)
!-- itimestep     number of time steps
!-- GLW           downward long wave flux at ground surface (W/m^2)
!-- GSW           net short wave flux at ground surface (W/m^2)
!-- SWDOWN        downward short wave flux at ground surface (W/m^2)
!-- SWDOWNC       clear-sky downward short wave flux at ground surface (W/m^2; optional; for AQ)
!-- XLAT          latitude, south is negative (degree)
!-- XLONG         longitude, west is negative (degree)
!-- ALBEDO                albedo (between 0 and 1)
!-- CLDFRA        cloud fraction (between 0 and 1)
!-- EMISS         surface emissivity (between 0 and 1)
!-- rho_phy       density (kg/m^3)
!-- rr            dry air density (kg/m^3)
!-- moist         moisture array (4D - last index is species) (kg/kg)
!-- n_moist       number of moisture species
!-- p8w           pressure at full levels (Pa)
!-- p_phy         pressure (Pa)
!-- Pb            base-state pressure (Pa)
!-- pi_phy        exner function (dimensionless)
!-- dz8w          dz between full levels (m)
!-- t_phy         temperature (K)
!-- t8w           temperature at full levels (K)
!-- GMT           Greenwich Mean Time Hour of model start (hour)
!-- JULDAY        the initial day (Julian day)
!-- RADT          time for calling radiation (min)
!-- DEGRAD        conversion factor for 
!                 degrees to radians (pi/180.) (rad/deg)
!-- DPD           degrees per day for earth's 
!                 orbital position (deg/day)
!-- R_d           gas constant for dry air (J/kg/K)
!-- CP            heat capacity at constant pressure for dry air (J/kg/K)
!-- G             acceleration due to gravity (m/s^2)
!-- rvovrd        R_v divided by R_d (dimensionless)
!-- XTIME         time since simulation start (min)
!-- DECLIN        solar declination angle (rad)
!-- SOLCON        solar constant (W/m^2)
!-- ids           start index for i in domain
!-- ide           end index for i in domain
!-- jds           start index for j in domain
!-- jde           end index for j in domain
!-- kds           start index for k in domain
!-- kde           end index for k in domain
!-- ims           start index for i in memory
!-- ime           end index for i in memory
!-- jms           start index for j in memory
!-- jme           end index for j in memory
!-- kms           start index for k in memory
!-- kme           end index for k in memory
!-- i_start       start indices for i in tile
!-- i_end         end indices for i in tile
!-- j_start       start indices for j in tile
!-- j_end         end indices for j in tile
!-- kts           start index for k in tile
!-- kte           end index for k in tile
!-- num_tiles     number of tiles
!
!==================================================================
!
   INTEGER,      INTENT(IN   )    ::   ids,ide, jds,jde, kds,kde, &
                                       ims,ime, jms,jme, kms,kme, &
                                                         kts,kte, &
                                       num_tiles

   INTEGER, INTENT(IN)            :: lw_physics, sw_physics

   INTEGER, DIMENSION(num_tiles), INTENT(IN) ::                       &
     &           i_start,i_end,j_start,j_end

   INTEGER,      INTENT(IN   )    ::   STEPRA,ICLOUD

   LOGICAL,      INTENT(IN   )    ::   warm_rain

   REAL,      INTENT(IN   )       ::   RADT

   REAL, DIMENSION( ims:ime, jms:jme ),                           &
         INTENT(IN   )  ::                                 XLAND, &
                                                             TSK, &
                                                          VEGFRA, &
                                                            SNOW 

   REAL, DIMENSION( ims:ime, jms:jme ),                           &
         INTENT(INOUT)  ::                                  HTOP, &
                                                            HBOT, &
                                                           HTOPR, &
                                                           HBOTR, &
                                                           CUPPT

   INTEGER, INTENT(IN   )  ::   julyr
!
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                  &
         INTENT(IN ) ::                                     dz8w, &
                                                             p8w, &
                                                               p, &
                                                              pi, &
                                                               t, &
                                                             t8w, &
                                                             rho
!
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), OPTIONAL ,       &
         INTENT(IN ) ::  tauaer300,tauaer400,tauaer600,tauaer999, & ! jcb
                                 gaer300,gaer400,gaer600,gaer999, & ! jcb
                                 waer300,waer400,waer600,waer999    ! jcb
!
! variables for aerosols (only if running with chemistry)
!
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), OPTIONAL ,       &
         INTENT(IN ) ::                                pm2_5_dry, &
                                                     pm2_5_water, &
                                                    pm2_5_dry_ec
!
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                  &
         INTENT(INOUT)  ::                              RTHRATEN, &
                                                      RTHRATENLW, &
                                                      RTHRATENSW

!
   REAL, DIMENSION( ims:ime, jms:jme ),                           &
         INTENT(IN   )  ::                                  XLAT, &
                                                           XLONG, &
                                                          ALBEDO, &
                                                           EMISS
!
   REAL, DIMENSION( ims:ime, jms:jme ),                           &
         INTENT(INOUT)  ::                                   GSW, &
                                                             GLW

   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT)  ::   SWDOWN
!
   REAL, INTENT(IN  )   ::                                GMT,dt, &
                                                   julian, xtime
!
   INTEGER, INTENT(IN  ) ::                    JULDAY, itimestep

   INTEGER,INTENT(IN)                                       :: NPHS
   REAL, DIMENSION( ims:ime, jms:jme ),INTENT(OUT)          ::    &
                                                      CFRACH,     & !Added
                                                      CFRACL,     & !Added
                                                      CFRACM,     & !Added
                                                      CZMEAN        !Added
   REAL, DIMENSION( ims:ime, jms:jme ),                           &
         INTENT(INOUT)  ::                                        &
                                                      RLWTOA,     & !Added
                                                      RSWTOA,     & !Added
                                                      ACFRST,     & !Added
                                                      ACFRCV        !Added

   INTEGER,DIMENSION( ims:ime, jms:jme ),INTENT(INOUT)        ::  &
                                                          NCFRST, &  !Added
                                                          NCFRCV     !Added

!
! Optional 
!
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                  &
         OPTIONAL,                                                &
         INTENT(INOUT) ::                                 CLDFRA
   REAL, DIMENSION( ims:ime, jms:jme ),                           &
         OPTIONAL,                                                &
         INTENT(OUT) ::                                   SWDOWNC
!
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                  &
         OPTIONAL,                                                &
         INTENT(IN ) ::                                           &
                                                               pb &
                                               ,qv,qc,qr,qi,qs,qg

   LOGICAL, OPTIONAL ::             f_qv,f_qc,f_qr,f_qi,f_qs,f_qg
!
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                  &
         OPTIONAL,                                                &
         INTENT(INOUT)  ::                       taucldi,taucldc
 
! LOCAL  VAR

   REAL, DIMENSION( ims:ime, jms:jme ) ::             GLAT,GLON

   REAL    ::    DECLIN,SOLCON 
   INTEGER ::    i,j,k,its,ite,jts,jte,ij
   LOGICAL ::    gfdl_lw,gfdl_sw

   REAL    ::    OBECL,SINOB,SXLONG,ARG,DECDEG,                  &
                 DJUL,RJUL,ECCFAC
!.......................................................................
#ifdef ENABLE_SMP
   INTEGER :: JSTART,JSTOP,NTH,OMP_GET_NUM_THREADS,OMP_GET_THREAD_NUM,TID
#endif
!.......................................................................
!------------------------------------------------------------------

!     write(0,*)' enter radiation_driver lw_physics=',lw_physics &
!              ,' sw_physics=',sw_physics,' num_tiles=',num_tiles

   if (lw_physics .eq. 0 .and. sw_physics .eq. 0)         return

   IF (itimestep .eq. 1 .or. mod(itimestep,STEPRA) .eq. 0) THEN
   gfdl_lw = .false.
   gfdl_sw = .false.

!---------------
!jaa   !$omp parallel do   &
!jaa   !$omp private ( ij ,i,j,k,its,ite,jts,jte)

   DO ij = 1 , num_tiles
     its = i_start(ij)
     ite = i_end(ij)
!.......................................................................
#ifdef ENABLE_SMP
!$omp parallel private(nth,tid,i,j,k,jts,jte,declin,solcon)
!.......................................................................
     nth = omp_get_num_threads()
     tid = omp_get_thread_num()
     call looplimits(tid,nth,j_start(ij),j_end(ij),jts,jte)
#else
     jts = j_start(ij)
     jte = j_end(ij)
#endif
!.......................................................................
!     write(0,*)' enter RADIATION_DRIVER lbound=',lbound(qi),' ubound=',ubound(qi)
!     write(0,*)' enter RADIATION_DRIVER its=',its,' ite=',ite,' jts=',jts,' jte=',jte,' kts=',kts,' kte=',kte
!     write(0,*)' enter RADIATION_DRIVER ims=',ims,' ime=',ime,' jms=',jms,' jme=',jme,' kms=',kms,' kme=',kte
!     write(0,*)' enter RADIATION_DRIVER ids=',ids,' ide=',ide,' jds=',jds,' jde=',jde,' kds=',kds,' kde=',kde
!     write(0,*)' enter RADIATION_DRIVER max QI=',maxval(qi(its:ite,kts:kte,jts:jte)) &
!              ,' min QI=',minval(qi(its:ite,kts:kte,jts:jte)),' f_qi=',f_qi

! initialize data

     DO j=jts,jte
     DO i=its,ite
        GSW(I,J)=0.
        GLW(I,J)=0.
        SWDOWN(I,J)=0.
        GLAT(I,J)=XLAT(I,J)*DEGRAD
        GLON(I,J)=XLONG(I,J)*DEGRAD
     ENDDO
     ENDDO

     DO j=jts,jte
     DO k=kts,kte
     DO i=its,ite
        RTHRATEN(I,K,J)=0.
     ENDDO
     ENDDO
     ENDDO

!---------------
! Calculate constant for short wave radiation

     CALL radconst(XTIME,DECLIN,SOLCON,JULIAN,               &
                   DEGRAD,DPD                                )

     lwrad_gfdl_select: SELECT CASE(lw_physics)

        CASE (GFDLLWSCHEME)

!-- Do nothing, since cloud fractions (with partial cloudiness effects) 
!-- are defined in GFDL LW/SW schemes and do not need to be initialized.

        CASE DEFAULT

     IF ( PRESENT ( CLDFRA ) .AND.                           &
          PRESENT(F_QC) .AND. PRESENT ( F_QI ) ) THEN
       CALL cal_cldfra(CLDFRA,qc,qi,F_QC,F_QI,               &
                       ids,ide, jds,jde, kds,kde,            &
                       ims,ime, jms,jme, kms,kme,            &
                       its,ite, jts,jte, kts,kte             )
     ENDIF

     END SELECT lwrad_gfdl_select    

!pjj/cray  Cray X1 cannot print from threaded region
#ifndef crayx1
!     WRITE(0,*)'SOLCON=',SOLCON,DECLIN,XTIME
#endif

     lwrad_select: SELECT CASE(lw_physics)

        CASE (RRTMSCHEME)

             CALL RRTMLWRAD(                                        &
                  RTHRATEN=RTHRATEN,GLW=GLW,EMISS=EMISS             &
                 ,QV3D=QV                                           &
                 ,QC3D=QC                                           &
                 ,QR3D=QR                                           &
                 ,QI3D=QI                                           &
                 ,QS3D=QS                                           &
                 ,QG3D=QG                                           &
                 ,P8W=p8w,P3D=p,PI3D=pi,DZ8W=dz8w,T3D=t             &
                 ,T8W=t8w,RHO3D=rho, CLDFRA3D=CLDFRA,R=R_d,G=G      &
                 ,F_QV=F_QV,F_QC=F_QC,F_QR=F_QR                     &
                 ,F_QI=F_QI,F_QS=F_QS,F_QG=F_QG                     &
                 ,ICLOUD=icloud,WARM_RAIN=warm_rain                 &
                 ,IDS=ids,IDE=ide, JDS=jds,JDE=jde, KDS=kds,KDE=kde &     
                 ,IMS=ims,IME=ime, JMS=jms,JME=jme, KMS=kms,KME=kme &
                 ,ITS=its,ITE=ite, JTS=jts,JTE=jte, KTS=kts,KTE=kte &
                                                                    )

        CASE (GFDLLWSCHEME)

             IF ( PRESENT(F_QV) .AND. PRESENT(F_QC) .AND. PRESENT(F_QS) .AND. &
                  PRESENT(qv)   .AND. PRESENT(qc)   .AND. PRESENT(qs)  ) THEN
               IF ( F_QV .AND. F_QC .AND. F_QS ) THEN
                 gfdl_lw  = .true.
!     write(0,*)' before ETARA_lw max QI=',maxval(qi(its:ite,kts:kte,jts:jte)) &
!              ,' min QI=',minval(qi(its:ite,kts:kte,jts:jte)),' f_qi=',f_qi
                 CALL ETARA(                                        &
                  DT=dt,XLAND=xland                                 &
                 ,P8W=p8w,DZ8W=dz8w,RHO_PHY=rho,P_PHY=p,T=t         &
                 ,QV=qv,QW=qc,QI=qi,QS=qs                           &
                 ,TSK2D=tsk,GLW=GLW,RSWIN=SWDOWN,GSW=GSW            &
                 ,RSWINC=SWDOWNC,CLDFRA=CLDFRA,PI3D=pi              &
                 ,GLAT=glat,GLON=glon,HTOP=htop,HBOT=hbot           &
                 ,HBOTR=hbotr, HTOPR=htopr                          &
                 ,ALBEDO=albedo,CUPPT=cuppt                         &
                 ,VEGFRA=vegfra,SNOW=snow,G=g,GMT=gmt               &
                 ,NSTEPRA=stepra,NPHS=nphs,ITIMESTEP=itimestep      &
                 ,XTIME=xtime,JULIAN=julian                         &
                 ,JULYR=julyr,JULDAY=julday                         &
                 ,GFDL_LW=gfdl_lw,GFDL_SW=gfdl_sw                   &
                 ,CFRACL=cfracl,CFRACM=cfracm,CFRACH=cfrach         &
                 ,ACFRST=acfrst,NCFRST=ncfrst                       &
                 ,ACFRCV=acfrcv,NCFRCV=ncfrcv                       &
                 ,RSWTOA=rswtoa,RLWTOA=rlwtoa,CZMEAN=czmean         &
                 ,THRATEN=rthraten,THRATENLW=rthratenlw             &
                 ,THRATENSW=rthratensw                              &
                 ,IDS=ids,IDE=ide, JDS=jds,JDE=jde, KDS=kds,KDE=kde &     
                 ,IMS=ims,IME=ime, JMS=jms,JME=jme, KMS=kms,KME=kme &
                 ,ITS=its,ITE=ite, JTS=jts,JTE=jte,KTS=kts,KTE=kte &
                                                                    )
               ELSE
                 WRITE(0,*)'Can not call ETARA (1a). Missing moisture fields.'
!!!              CALL ESMF_Finalize(terminationflag=ESMF_ABORT)
                 CALL NMMB_FINALIZE
               ENDIF
             ELSE
               WRITE(0,*)'Can not call ETARA (1b). Missing moisture fields.'
!!!            CALL ESMF_Finalize(terminationflag=ESMF_ABORT)
               CALL NMMB_FINALIZE
             ENDIF

        CASE DEFAULT
  
             WRITE(0,*)'The longwave option does not exist: lw_physics = ', lw_physics
!!!          CALL ESMF_Finalize(terminationflag=ESMF_ABORT)
             CALL NMMB_FINALIZE
           
     END SELECT lwrad_select    

     IF (lw_physics .gt. 0 .and. .not.gfdl_lw) THEN
        DO j=jts,jte
        DO k=kts,kte
        DO i=its,ite
           RTHRATENLW(I,K,J)=RTHRATEN(I,K,J)
        ENDDO
        ENDDO
        ENDDO
     ENDIF
!

!     write(0,*)' before SW select sw_physics=',sw_physics 
     swrad_select: SELECT CASE(sw_physics)

        CASE (SWRADSCHEME)
             CALL SWRAD(                                               &
                     DT=dt,RTHRATEN=rthraten,GSW=gsw                   &
                    ,XLAT=xlat,XLONG=xlong,ALBEDO=albedo               &
#ifdef WRF_CHEM
                    ,PM2_5_DRY=pm2_5_dry,PM2_5_WATER=pm2_5_water       &
                    ,PM2_5_DRY_EC=pm2_5_dry_ec                         &
#endif
                    ,RHO_PHY=rho,T3D=t                                 &
                    ,P3D=p,PI3D=pi,DZ8W=dz8w,GMT=gmt                   &
                    ,R=r_d,CP=cp,G=g,JULDAY=julday                     &
                    ,XTIME=xtime,DECLIN=declin,SOLCON=solcon           &
                    ,RADFRQ=radt,ICLOUD=icloud,DEGRAD=degrad           &
                    ,warm_rain=warm_rain                               &
                    ,IDS=ids,IDE=ide, JDS=jds,JDE=jde, KDS=kds,KDE=kde &     
                    ,IMS=ims,IME=ime, JMS=jms,JME=jme, KMS=kms,KME=kme &
                    ,ITS=its,ITE=ite, JTS=jts,JTE=jte, KTS=kts,KTE=kte &
                    ,QV3D=qv                                           &
                    ,QC3D=qc                                           &
                    ,QR3D=qr                                           &
                    ,QI3D=qi                                           &
                    ,QS3D=qs                                           &
                    ,QG3D=qg                                           &
                    ,F_QV=f_qv,F_QC=f_qc,F_QR=f_qr                     &
                    ,F_QI=f_qi,F_QS=f_qs,F_QG=f_qg                     &
                                                                       )

        CASE (GSFCSWSCHEME)
             CALL GSFCSWRAD(                                           &
                     RTHRATEN=rthraten,GSW=gsw,XLAT=xlat,XLONG=xlong   &
                    ,ALB=albedo,T3D=t,P3D=p,P8W3D=p8w,pi3D=pi          &
                    ,DZ8W=dz8w,RHO_PHY=rho                             &
                    ,CLDFRA3D=cldfra                                   &
                    ,GMT=gmt,CP=cp,G=g                                 &
                    ,JULDAY=julday,XTIME=xtime                         &
                    ,DECLIN=declin,SOLCON=solcon                       &
                    ,RADFRQ=radt,DEGRAD=degrad                         &
                    ,TAUCLDI=taucldi,TAUCLDC=taucldc                   &
                    ,WARM_RAIN=warm_rain                               &
#ifdef WRF_CHEM
                    ,TAUAER300=tauaer300,TAUAER400=tauaer400           & ! jcb
                    ,TAUAER600=tauaer600,TAUAER999=tauaer999           & ! jcb
                    ,GAER300=gaer300,GAER400=gaer400                   & ! jcb
                    ,GAER600=gaer600,GAER999=gaer999                   & ! jcb
                    ,WAER300=waer300,WAER400=waer400                   & ! jcb
                    ,WAER600=waer600,WAER999=waer999                   & ! jcb
#endif
                    ,IDS=ids,IDE=ide, JDS=jds,JDE=jde, KDS=kds,KDE=kde &     
                    ,IMS=ims,IME=ime, JMS=jms,JME=jme, KMS=kms,KME=kme &
                    ,ITS=its,ITE=ite, JTS=jts,JTE=jte, KTS=kts,KTE=kte &
                    ,QV3D=qv                                           &
                    ,QC3D=qc                                           &
                    ,QR3D=qr                                           &
                    ,QI3D=qi                                           &
                    ,QS3D=qs                                           &
                    ,QG3D=qg                                           &
                    ,F_QV=f_qv,F_QC=f_qc,F_QR=f_qr                     &
                    ,F_QI=f_qi,F_QS=f_qs,F_QG=f_qg                     &
                                                                       )

        CASE (GFDLSWSCHEME)

             IF ( PRESENT(F_QV) .AND. PRESENT(F_QC) .AND. PRESENT(F_QS) .AND. &
                  PRESENT(qv)   .AND. PRESENT(qc)   .AND. PRESENT(qs)  ) THEN
               IF ( F_QV .AND. F_QC .AND. F_QS ) THEN
                 gfdl_sw = .true.
!     write(0,*)' before ETARA_sw max QI=',maxval(qi(its:ite,kts:kte,jts:jte)) &
!              ,' min QI=',minval(qi(its:ite,kts:kte,jts:jte)),' f_qi=',f_qi
                 CALL ETARA(                                        &
                  DT=dt,XLAND=xland                                 &
                 ,P8W=p8w,DZ8W=dz8w,RHO_PHY=rho,P_PHY=p,T=t         &
                 ,QV=qv,QW=qc,QI=qi,QS=qs                           &
                 ,TSK2D=tsk,GLW=GLW,RSWIN=SWDOWN,GSW=GSW            &
                 ,RSWINC=SWDOWNC,CLDFRA=CLDFRA,PI3D=pi              &
                 ,GLAT=glat,GLON=glon,HTOP=htop,HBOT=hbot           &
                 ,HBOTR=hbotr, HTOPR=htopr                          &
                 ,ALBEDO=albedo,CUPPT=cuppt                         &
                 ,VEGFRA=vegfra,SNOW=snow,G=g,GMT=gmt               &
                 ,NSTEPRA=stepra,NPHS=nphs,ITIMESTEP=itimestep      &
                 ,XTIME=xtime,JULIAN=julian                         &
                 ,JULYR=julyr,JULDAY=julday                         &
                 ,GFDL_LW=gfdl_lw,GFDL_SW=gfdl_sw                   &
                 ,CFRACL=cfracl,CFRACM=cfracm,CFRACH=cfrach         &
                 ,ACFRST=acfrst,NCFRST=ncfrst                       &
                 ,ACFRCV=acfrcv,NCFRCV=ncfrcv                       &
                 ,RSWTOA=rswtoa,RLWTOA=rlwtoa,CZMEAN=czmean         &
                 ,THRATEN=rthraten,THRATENLW=rthratenlw             &
                 ,THRATENSW=rthratensw                              &
                 ,IDS=ids,IDE=ide, JDS=jds,JDE=jde, KDS=kds,KDE=kde &     
                 ,IMS=ims,IME=ime, JMS=jms,JME=jme, KMS=kms,KME=kme &
                 ,ITS=its,ITE=ite, JTS=jts,JTE=jte, KTS=kts,KTE=kte &
                                                                    )
               ELSE
                 WRITE(0,*)'Can not call ETARA (2a). Missing moisture fields.'
!!!              CALL ESMF_Finalize(terminationflag=ESMF_ABORT)
                 CALL NMMB_FINALIZE

               ENDIF
             ELSE
               WRITE(0,*)'Can not call ETARA (2b). Missing moisture fields.'
!!!            CALL ESMF_Finalize(terminationflag=ESMF_ABORT)
               CALL NMMB_FINALIZE
             ENDIF

        CASE DEFAULT

             WRITE(0,*)'The shortwave option does not exist: sw_physics = ', sw_physics
!!!          CALL ESMF_Finalize(terminationflag=ESMF_ABORT)
             CALL NMMB_FINALIZE

     END SELECT swrad_select    

     IF (sw_physics .gt. 0 .and. .not.gfdl_sw) THEN
        DO j=jts,jte
        DO k=kts,kte
        DO i=its,ite
           RTHRATENSW(I,K,J)=RTHRATEN(I,K,J)-RTHRATENLW(I,K,J)
        ENDDO
        ENDDO
        ENDDO

        DO j=jts,jte
        DO i=its,ite
           SWDOWN(I,J)=GSW(I,J)/(1.-ALBEDO(I,J))
        ENDDO
        ENDDO

     ENDIF
!
!.......................................................................
!$omp end parallel
!.......................................................................
!
   ENDDO
   ENDIF

   END SUBROUTINE radiation_driver

!---------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!---------------------------------------------------------------------
   SUBROUTINE radconst(XTIME,DECLIN,SOLCON,JULIAN,                   &
                       DEGRAD,DPD                                    )
!---------------------------------------------------------------------
   IMPLICIT NONE
!---------------------------------------------------------------------

! !ARGUMENTS:
   REAL, INTENT(IN   )      ::       DEGRAD,DPD,XTIME,JULIAN
   REAL, INTENT(OUT  )      ::       DECLIN,SOLCON
   REAL                     ::       OBECL,SINOB,SXLONG,ARG,  &
                                     DECDEG,DJUL,RJUL,ECCFAC
!
! !DESCRIPTION:
! Compute terms used in radiation physics 
!EOP

! for short wave radiation

   DECLIN=0.
   SOLCON=0.

!-----OBECL : OBLIQUITY = 23.5 DEGREE.
        
   OBECL=23.5*DEGRAD
   SINOB=SIN(OBECL)
        
!-----CALCULATE LONGITUDE OF THE SUN FROM VERNAL EQUINOX:
        
   IF(JULIAN.GE.80.)SXLONG=DPD*(JULIAN-80.)
   IF(JULIAN.LT.80.)SXLONG=DPD*(JULIAN+285.)

   SXLONG=SXLONG*DEGRAD
   ARG=SINOB*SIN(SXLONG)
   DECLIN=ASIN(ARG)
   DECDEG=DECLIN/DEGRAD
!----SOLAR CONSTANT ECCENTRICITY FACTOR (PALTRIDGE AND PLATT 1976)
   DJUL=JULIAN*360./365.
   RJUL=DJUL*DEGRAD
   ECCFAC=1.000110+0.034221*COS(RJUL)+0.001280*SIN(RJUL)+0.000719*  &
          COS(2*RJUL)+0.000077*SIN(2*RJUL)
   SOLCON=1370.*ECCFAC
   
   END SUBROUTINE radconst

!---------------------------------------------------------------------
   SUBROUTINE cal_cldfra(CLDFRA,QC,QI,F_QC,F_QI,                     &
          ids,ide, jds,jde, kds,kde,                                 &
          ims,ime, jms,jme, kms,kme,                                 &
          its,ite, jts,jte, kts,kte                                  )
!---------------------------------------------------------------------
   IMPLICIT NONE
!---------------------------------------------------------------------
   INTEGER,  INTENT(IN   )   ::           ids,ide, jds,jde, kds,kde, &
                                          ims,ime, jms,jme, kms,kme, &
                                          its,ite, jts,jte, kts,kte

!
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(OUT  ) ::    &
                                                             CLDFRA

   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN   ) ::    &
                                                                 QI, &
                                                                 QC

   LOGICAL,INTENT(IN) :: F_QC,F_QI

   REAL thresh
   INTEGER:: i,j,k
! !DESCRIPTION:
! Compute cloud fraction from input ice and cloud water fields
! if provided.
!
! Whether QI or QC is active or not is determined from the indices of
! the fields into the 4D scalar arrays in WRF. These indices are 
! P_QI and P_QC, respectively, and they are passed in to the routine
! to enable testing to see if QI and QC represent active fields in
! the moisture 4D scalar array carried by WRF.
! 
! If a field is active its index will have a value greater than or
! equal to PARAM_FIRST_SCALAR, which is also an input argument to 
! this routine.
!EOP
!---------------------------------------------------------------------
     thresh=1.0e-6

     IF ( f_qi .AND. f_qc ) THEN
!.......................................................................
!$omp parallel do private(j,k,i)
!.......................................................................
        DO j = jts,jte
        DO k = kts,kte
        DO i = its,ite
           IF ( QC(i,k,j)+QI(I,k,j) .gt. thresh) THEN
              CLDFRA(i,k,j)=1.
           ELSE
              CLDFRA(i,k,j)=0.
           ENDIF
        ENDDO
        ENDDO
        ENDDO
!.......................................................................
!$omp end parallel do
!.......................................................................
!
     ELSE IF ( f_qc ) THEN
!.......................................................................
!$omp parallel do private(j,k,i)
!.......................................................................
        DO j = jts,jte
        DO k = kts,kte
        DO i = its,ite
           IF ( QC(i,k,j) .gt. thresh) THEN
              CLDFRA(i,k,j)=1.
           ELSE
              CLDFRA(i,k,j)=0.
           ENDIF
        ENDDO
        ENDDO
        ENDDO
!.......................................................................
!$omp end parallel do
!.......................................................................
!
     ELSE 
!
!.......................................................................
!$omp parallel do private(j,k,i)
!.......................................................................
        DO j = jts,jte
        DO k = kts,kte
        DO i = its,ite
           CLDFRA(i,k,j)=0.
        ENDDO
        ENDDO
        ENDDO
!.......................................................................
!$omp end parallel do
!.......................................................................
     ENDIF

   END SUBROUTINE cal_cldfra
!-----------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!******************* THE GFDL RADIATION PACKAGE ************************
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!-----------------------------------------------------------------------
      SUBROUTINE GFDL_INIT(EMISS,SFULL,SHALF,PPTOP,                     &
     &                     JULYR,MONTH,IDAY,GMT,                        &
     &                     CO2TF,                                       &
     &                     IDS, IDE, JDS, JDE, KDS, KDE,                &
     &                     IMS, IME, JMS, JME, KMS, KME,                &
     &                     ITS, ITE, JTS, JTE, KTS, KTE              )
!-----------------------------------------------------------------------
      IMPLICIT NONE
!-----------------------------------------------------------------------
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &
     &                     ,IMS,IME,JMS,JME,KMS,KME                     &
     &                     ,ITS,ITE,JTS,JTE,KTS,KTE
      INTEGER,INTENT(IN) :: JULYR,MONTH,IDAY,CO2TF
      REAL,INTENT(IN) :: GMT,PPTOP
      REAL,DIMENSION(KMS:KME),INTENT(IN) :: SFULL, SHALF
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: EMISS
!
      INTEGER :: I,IHRST,J,N
      REAL :: PCLD,XSD,PI,SQR2PI
      REAL :: SSLP=1013.25
      REAL, PARAMETER :: PTOP_HI=150.,PTOP_MID=350.,PTOP_LO=642.,       &
     &                   PLBTM=105000.
!-----------------------------------------------------------------------
!***********************************************************************
!-----------------------------------------------------------------------
!
      MYPE=MYPE_SHARE
!
!***  INITIALIZE DIAGNOSTIC LOW,MIDDLE,HIGH CLOUD LAYER PRESSURE LIMITS.
!
      LTOP(1)=0
      LTOP(2)=0
      LTOP(3)=0
!
      DO N=1,KTE
        PCLD=(SSLP-PPTOP*10.)*SHALF(N)+PPTOP*10.
        IF(PCLD>=PTOP_LO)LTOP(1)=N
        IF(PCLD>=PTOP_MID)LTOP(2)=N
        IF(PCLD>=PTOP_HI)LTOP(3)=N
!       PRINT *,N,PCLD,SHALF(N),PSTAR,PPTOP
      ENDDO
!***  
!***  ASSIGN THE PRESSURES FOR CLOUD DOMAIN BOUNDARIES
!***
      PTOPC(1)=PLBTM
      PTOPC(2)=PTOP_LO*100.
      PTOPC(3)=PTOP_MID*100.
      PTOPC(4)=PTOP_HI*100.
!
!***  USE CALL TO CONRAD FOR DIRECT READ OF CO2 FUNCTIONS
!***  OTHERWISE CALL CO2O3.
!
      IF(CO2TF==1)THEN
        CALL CO2O3(SFULL,SHALF,PPTOP,KME-KMS,KME-KMS+1,KME-KMS+2)
      ELSE
        CALL CONRAD(KDS,KDE,KMS,KME,KTS,KTE)
      ENDIF
!
      CALL O3CLIM
!	write(0,*) 'call TABLE'
      CALL TABLE
!	write(0,*) 'return call TABLE'
      IHRST=NINT(GMT)
!jaa      if(mype==0)then
!jaa        WRITE(0,*)'into solard ',gmt,ihrst
!jaa      endif
      CALL SOLARD(IHRST,IDAY,MONTH,JULYR)
!jaa      if(mype==0)then
!jaa        WRITE(0,*)'from solard IDAY,MONTH,JULYR: ', IDAY,MONTH,JULYR
!jaa      endif
!
!***  FOR NOW, GFDL RADIATION ASSUMES EMISSIVITY = 1.0
!
      DO J=JTS,JTE
      DO I=ITS,ITE
        EMISS(I,J) = 1.0
      ENDDO
      ENDDO
!
!---  Calculate the area under the Gaussian curve at the start of the
!---  model run and build the look up table AXSD
!
      PI=ACOS(-1.)
      SQR2PI=SQRT(2.*PI)
      RSQR=1./SQR2PI
      DO I=1,NXSD
        XSD=REAL(I)*DXSD
        AXSD(I)=GAUSIN(XSD)
        if (SDprint) print *,'I, XSD, AXSD =',I,XSD,AXSD(I)
      ENDDO
!! !***
!! !***  MESO STANDARD DEVIATION OF EK AND MAHRT'S CLOUD COVER ALOGRITHM
!! !***
!!         SDM=-0.03-0.00015*DX+0.02*LOG(DX)  ! meso SD
!!         if (SDprint) print *,'DX, SDM=',DX,SDM
       if (SDprint) print *,                                            &
     & 'RHgrd,T_ICE,NLImin,NLImax,FLARGE1,FLARGE2,MDImin,MDImax=',&
     &  RHgrd,T_ICE,NLImin,NLImax,FLARGE1,FLARGE2,MDImin,MDImax
!
!-----------------------------------------------------------------------
      END SUBROUTINE GFDL_INIT
!-----------------------------------------------------------------------
!
!
!-----------------------------------------------------------------------
      SUBROUTINE ETARA(DT,THRATEN,THRATENLW,THRATENSW,CLDFRA,PI3D       & 
     &                ,XLAND,P8W,DZ8W,RHO_PHY,P_PHY,T                   &
     &                ,QV,QW,QI,QS                                      & 
     &                ,TSK2D,GLW,RSWIN,GSW,RSWINC                       &
     &                ,RSWTOA,RLWTOA,CZMEAN                             & 
     &                ,GLAT,GLON,HTOP,HBOT,HTOPR,HBOTR,ALBEDO,CUPPT     &
     &                ,VEGFRA,SNOW,G,GMT                                &
!BSF => for NAMX changes, pass in surface emissivity (SFCEMS) [different for snow]
     &                ,NSTEPRA,NPHS,ITIMESTEP                           &
     &                ,XTIME,JULIAN                                     &
     &                ,JULYR,JULDAY,GFDL_LW,GFDL_SW                     &
     &                ,CFRACL,CFRACM,CFRACH                             &
     &                ,ACFRST,NCFRST,ACFRCV,NCFRCV                      &
     &                ,IDS,IDE,JDS,JDE,KDS,KDE                          &
     &                ,IMS,IME,JMS,JME,KMS,KME                          &
     &                ,ITS,ITE,JTS,JTE,KTS,KTE)
!-----------------------------------------------------------------------
      IMPLICIT NONE
!-----------------------------------------------------------------------
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &
     &                     ,IMS,IME,JMS,JME,KMS,KME                     &
     &                     ,ITS,ITE,JTS,JTE,KTS,KTE,ITIMESTEP           &
     &                     ,NPHS,NSTEPRA
 
      INTEGER,INTENT(IN) :: julyr,julday   
      INTEGER,INTENT(INOUT),DIMENSION(ims:ime,jms:jme) :: NCFRST        & !Added
                                                         ,NCFRCV          !Added
      REAL,INTENT(IN) :: DT,GMT,G,XTIME,JULIAN

      REAL,INTENT(INOUT),DIMENSION(ims:ime, kms:kme, jms:jme)::         &
                                    THRATEN,THRATENLW,THRATENSW,CLDFRA  !Added CLDFRA
      REAL,INTENT(IN),DIMENSION(ims:ime, kms:kme, jms:jme)::p8w,dz8w,   &
     &                                                      rho_phy,    &
     &                                                      p_phy,      &
     &                                                      PI3D
      REAL, INTENT(IN), DIMENSION(ims:ime, jms:jme):: ALBEDO,SNOW,      &
     &                                                TSK2D,VEGFRA,     &
     &                                                XLAND
      REAL, INTENT(IN), DIMENSION(ims:ime, jms:jme):: GLAT,GLON
      REAL, INTENT(INOUT), DIMENSION(ims:ime, jms:jme):: HTOP,HBOT,HTOPR,HBOTR,CUPPT
      REAL, INTENT(INOUT), DIMENSION(ims:ime, jms:jme):: RSWTOA,        & !Added
     &                                                   RLWTOA,        & !Added
     &                                                   ACFRST,        & !Added
     &                                                   ACFRCV
      REAL,INTENT(INOUT),DIMENSION(ims:ime, jms:jme):: GLW,GSW
      REAL,INTENT(OUT),DIMENSION(ims:ime, jms:jme):: CZMEAN             &
     &                                           ,RSWIN,RSWINC        &
     &                                           ,CFRACL,CFRACM,CFRACH
      REAL, INTENT(IN), DIMENSION(ims:ime, kms:kme, jms:jme):: QS,QV,   &
     &                                                         QW,T
      LOGICAL, INTENT(IN) :: gfdl_lw,gfdl_sw
      REAL, OPTIONAL, INTENT(IN), DIMENSION(ims:ime, kms:kme, jms:jme):: QI

      REAL, DIMENSION(its:ite, kms:kme, jts:jte):: PFLIP,QIFLIP,QFLIP,  &
     &                                             QWFLIP,TFLIP
      REAL, DIMENSION(its:ite, kms:kme, jts:jte)::P8WFLIP,PHYD
      REAL, DIMENSION(its:ite, kts:kte, jts:jte)::TENDS,TENDL
      REAL, DIMENSION(ims:ime, jms:jme):: CUTOP,CUBOT
      INTEGER :: IDAT(3),Jmonth,Jday,IHOUR
      INTEGER :: I,J,K,KFLIP,IHRST
! begin debugging radiation
      integer :: imd,jmd
      real :: FSWrat
! end debugging radiation
!-----------------------------------------------------------------------
!***********************************************************************
!-----------------------------------------------------------------------
!     if(mype==0)write(0,*)' enter ETARA present(qi)=',present(qi)
      IF(GFDL_LW.AND.GFDL_SW )GO TO 100
!
      DO J=JTS,JTE
        DO K=KTS,KTE
        DO I=ITS,ITE
!jaa      DO J=JMS,JME
!jaa        DO K=KMS,KME
!jaa          DO I=IMS,IME
            CLDFRA(I,K,J)=0.
          ENDDO
        ENDDO
      ENDDO
! NEED HYDROSTATIC PRESSURE HERE (MONOTONIC CHANGE WITH HEIGHT)
      DO J=JTS,JTE
      DO I=ITS,ITE
        PHYD(I,KTS,J)=P8W(I,KTS,J) 
      ENDDO
      ENDDO
!
      DO J=JTS,JTE
        DO K=KTS,KTE
        DO I=ITS,ITE
          PHYD(I,K+1,J)=PHYD(I,K,J)-G*RHO_PHY(I,K,J)*DZ8W(I,K,J)
          TENDL(I,K,J)=0.
          TENDS(I,K,J)=0.
        ENDDO
        ENDDO
      ENDDO
!
      DO K=KMS,KME
         KFLIP=KME+1-K
         DO J=JTS,JTE
         DO I=ITS,ITE
           P8WFLIP(I,K,J)=PHYD(I,KFLIP,J)
         ENDDO
         ENDDO
      ENDDO
!
!- Note that the effects of rain are ignored in this radiation package (BSF 2005-01-25)
!
      DO K=KTS,KTE
        KFLIP=KTE+1-K
        DO J=JTS,JTE
        DO I=ITS,ITE
          TFLIP (I,K,J)=T(I,KFLIP,J)
          QFLIP (I,K,J)=MAX(0.,QV(I,KFLIP,J)/(1.+QV(I,KFLIP,J)))
          QWFLIP(I,K,J)=MAX(QW(I,KFLIP,J),0.)      !Modified
! Note that QIFLIP will contain QS+QI if both are passed in, otherwise just QS 
!     Eta MP now outputs QS instead of QI (JD 2006-05-12)
          QIFLIP(I,K,J)=MAX(QS(I,KFLIP,J),0.)      !Added QS
!      if(present(qi).and.qi(i,kflip,j)>0.)then
!        write(0,*)' ETARA i=',i,' kflip=',kflip,' j=',j,' qi=',qi(i,kflip,j)
!      endif
          IF(PRESENT(QI))QIFLIP(I,K,J)=QIFLIP(I,K,J)+QI(I,KFLIP,J)      !Added QI
!         PFLIP (I,K,J)=P_PHY(I,KFLIP,J)
!
!***  USE MONOTONIC HYDROSTATIC PRESSURE INTERPOLATED TO MID-LEVEL
!
          PFLIP(I,K,J)=0.5*(P8WFLIP(I,K,J)+P8WFLIP(I,K+1,J))
        ENDDO
        ENDDO
      ENDDO
!
      DO J=JTS,JTE
      DO I=ITS,ITE
        CUBOT(I,J)=KTE+1-HBOT(I,J)
        CUTOP(I,J)=KTE+1-HTOP(I,J)
      ENDDO
      ENDDO
!
      CALL CAL_MON_DAY(JULDAY,JULYR,JMONTH,JDAY)     
!
      IDAT(1)=JMONTH
      IDAT(2)=JDAY
      IDAT(3)=JULYR

      IHRST  =NINT(GMT)
      IHOUR  =MOD((IHRST+NINT(XTIME/60.0)),24)
      CALL SOLARD(IHOUR,JDAY,JMONTH,JULYR)

!-----------------------------------------------------------------------
      CALL RADTN (DT,TFLIP,QFLIP,QWFLIP,QIFLIP,                         &
     &            PFLIP,P8WFLIP,XLAND,TSK2D,                            &
     &            GLAT,GLON,CUTOP,CUBOT,ALBEDO,CUPPT,                   &
     &            ACFRCV,NCFRCV,ACFRST,NCFRST,                          &
     &            VEGFRA,SNOW,GLW,GSW,RSWIN,RSWINC,                     &
!BSF => for NAMX changes, pass in surface emissivity (SFCEMS) [different for snow]
     &            IDAT,IHRST,XTIME,JULIAN,                              &
     &            NSTEPRA,NSTEPRA,NPHS,ITIMESTEP,                       &
     &            TENDS,TENDL,CLDFRA,RSWTOA,RLWTOA,CZMEAN,              &
     &            CFRACL,CFRACM,CFRACH,                                 &
     &            IDS,IDE,JDS,JDE,KDS,KDE,                              &
     &            IMS,IME,JMS,JME,KMS,KME,                              &
     &            ITS,ITE,JTS,JTE,KTS,KTE                              )
!-----------------------------------------------------------------------
! begin debugging radiation
!     imd=(ims+ime)/2
!     jmd=(jms+jme)/2
!     FSWrat=0.
!     if (RSWIN(imd,jmd) .gt. 0.)   &
!        FSWrat=(RSWIN(imd,jmd)-GSW(imd,jmd))/RSWIN(imd,jmd)
!     write(6,"(2a,2i5,5f9.2,f8.4,i3,2f8.4)") & 
!       '{rad4 imd,jmd,GSW,RSWIN,RSWOUT=RSWIN-GSW,RSWINC,GLW,' &
!      ,'ACFRCV,NCFRCV,ALBEDO,RSWOUT/RSWIN = '   &
!      ,imd,jmd, GSW(imd,jmd),RSWIN(imd,jmd)  &
!      ,RSWIN(imd,jmd)-GSW(imd,jmd),RSWINC(imd,jmd),GLW(imd,jmd) &
!      ,ACFRCV(imd,jmd),NCFRCV(imd,jmd),ALBEDO(imd,jmd),FSWrat
! end debugging radiation
!
!--- Need to save LW & SW tendencies since radiation calculates both and this block
!    is skipped when GFDL SW is called, both only if GFDL LW is also called
!    


       
      IF(GFDL_LW)THEN
        DO J=JTS,JTE
        DO K = KTS,KTE
          KFLIP=KTE+1-K
          DO I=ITS,ITE
	if (I .eq. 50 .and. J .eq. 50 .and. K .eq. 10) then
!	write(0,*) 'I,J, TENDL(I,KFLIP,J), PI3D(I,K,J): ', I,J, TENDL(I,KFLIP,J), PI3D(I,K,J)
!	write(0,*) 'TENDS: ', I,J, TENDS(I,KFLIP,J)
	endif
            THRATENLW(I,K,J)=TENDL(I,KFLIP,J)/PI3D(I,K,J)
            THRATENSW(I,K,J)=TENDS(I,KFLIP,J)/PI3D(I,K,J)
            THRATEN(I,K,J)  =THRATEN(I,K,J) + THRATENLW(I,K,J)
          ENDDO
        ENDDO
        ENDDO
      ENDIF
!
!*** THIS ASSUMES THAT LONGWAVE IS CALLED FIRST IN THE RADIATION_DRIVER.
!    Only gets executed if a different LW scheme (not GFDL) is called
!
      IF(GFDL_SW)THEN
        DO J=JTS,JTE
        DO K=KTS,KTE
          KFLIP=KTE+1-K
          DO I=ITS,ITE
            THRATENSW(I,K,J)=TENDS(I,KFLIP,J)/PI3D(I,K,J)
          ENDDO
        ENDDO
        ENDDO
      ENDIF
!
!***  RESET ACCUMULATED CONVECTIVE CLOUD TOP/BOT AND CONVECTIVE PRECIP
!***  FOR NEXT INTERVAL BETWEEN RADIATION CALLS
!
      DO J=JTS,JTE
      DO I=ITS,ITE
! SAVE VALUE USED BY RADIATION BEFORE RESETTING HTOP AND HBOT
        HBOTR(I,J)=HBOT(I,J)
        HTOPR(I,J)=HTOP(I,J)
        HBOT(I,J)=REAL(KTE+1)
        HTOP(I,J)=0.
        CUPPT(I,J)=0.
      ENDDO
      ENDDO
!
  100 IF(GFDL_SW)THEN
        DO J=JTS,JTE
        DO K=KTS,KTE
          KFLIP=KTE+1-K
          DO I=ITS,ITE
            THRATEN(I,K,J)=THRATEN(I,K,J)+THRATENSW(I,K,J)
          ENDDO
        ENDDO
        ENDDO
      ENDIF


!
  END SUBROUTINE ETARA
!
!-----------------------------------------------------------------------
      SUBROUTINE RADTN(DT,T,Q,QCW,QICE,                                 &
     &                 PFLIP,P8WFLIP,XLAND,TSK2D,                       &
     &                 GLAT,GLON,CUTOP,CUBOT,ALB,CUPPT,                 &
     &                 ACFRCV,NCFRCV,ACFRST,NCFRST,                     &
     &                 VEGFRC,SNO,GLW,GSW,RSWIN,RSWINC,                 & 
!BSF => for NAMX changes, pass in surface emissivity (SFCEMS) [different for snow]
     &                 IDAT,IHRST,XTIME,JULIAN,                         &
     &                 NRADS,NRADL,NPHS,NTSD,                           &
     &                 TENDS,TENDL,CLDFRA,RSWTOA,RLWTOA,CZMEAN,         &
     &                 CFRACL,CFRACM,CFRACH,                            &
     &                 ids,ide, jds,jde, kds,kde,                       &
     &                 ims,ime, jms,jme, kms,kme,                       &
     &                 its,ite, jts,jte, kts,kte                       )
!-----------------------------------------------------------------------
      IMPLICIT NONE
!-----------------------------------------------------------------------

! GLAT : geodetic latitude in radians of the mass points on the computational grid.

! CZEN : instantaneous cosine of the solar zenith angle.

! CUTOP : (REAL) model layer number that is highest in the atmosphere
!        in which convective cloud occurred since the previous call to the
!        radiation driver.

! CUBOT : (REAL) model layer number that is lowest in the atmosphere
!        in which convective cloud occurred since the previous call to the
!        radiation driver.

! ALB  : is no longer used in the operational radiation.  Prior to 24 July 2001
!        ALB was the climatological albedo that was modified within RADTN to
!        account for vegetation fraction and snow.
!
! ALB  : reintroduced as the dynamic albedo from LSM

! CUPPT: accumulated convective precipitation (meters) since the
!        last call to the radiation.

! TSK2D : skin temperature

! IHE and IHW are relative location indices needed to locate neighboring
!       points on the Eta's Arakawa E grid since arrays are indexed locally on
!       each MPI task rather than globally.  IHE refers to the adjacent grid
!       point (a V point) to the east of the mass point being considered.  IHW
!       is the adjacent grid point to the west of the given mass point.

! IRAD is a relic from older code that is no longer needed.

! ACFRCV : sum of the convective cloud fractions that were computed
!          during each call to the radiation between calls to the subroutines that
!          do the forecast output.

! NCFRCV : the total number of times in which the convective cloud
!          fraction was computed to be greater than zero in the radiation between
!          calls to the output routines.  In the post-processor, ACFRCV is divided
!          by NCFRCV to yield an average convective cloud fraction.

!          ACFRST and NCFRST are the analogs for stratiform cloud cover.

!          VEGFRC is the fraction of the gridbox with vegetation.

!          LVL holds the number of model layers that lie below the ground surface
!          at each point.  Clearly for sigma coordinates LVL is zero everywhere.

! CTHK  :  an assumed maximum thickness of stratiform clouds currently set
!          to 20000 Pascals.  I think this is relevant for computing "low",
!          "middle", and "high" cloud fractions which are post-processed but which
!          do not feed back into the integration.

! IDAT  : a 3-element integer array holding the month, day, and year,
!        respectively, of the date for the start time of the free forecast.

! ABCFF : holds coefficients for various absorption bands.  You can see
!         where they are set in GFDLRD.F.

! LTOP  : a 3-element integer array holding the model layer that is at or
!         immediately below the specified pressure levels for the tops 
!         of "high" (15000 Pa), "middle" (35000 Pa), and "low" (64200 Pa) 
!         stratiform clouds.  These are for the diagnostic cloud layers 
!         needed in the output but not in the integration.

! NRADS : integer number of fundamental timesteps (our smallest
!         timestep, i.e., the one for inertial gravity wave adjustment) 
!         between updates of the shortwave tendencies.  

! NRADL : integer number of fundamental timesteps between updates of
!         the longwave tendencies.  

! NTSD   : integer counter of the fundamental timesteps that have
!         elapsed since the start of the forecast.

! GLW : incoming longwave radiation at the surface
! GSW : NET (down minus up, or incoming minus outgoing) all-sky shortwave radiation at the surface
! RSWIN  : total (clear + cloudy sky) incoming (downward) solar radiation at the surface
! RSWINC : clear sky incoming (downward) solar radiation at the surface

! TENDS,TENDL : shortwave,longwave (respectively) temperature tendency

! CLDFRA : 3D cloud fraction

! RSWTOA, RLWTOA : outgoing shortwave, longwave (respectively) fluxes at top of atmosphere

! CZMEAN : time-average cosine of the zenith angle

! CFRACL,CFRACM,CFRACH : low, middle, & high (diagnosed) cloud fractions

! XTIME : time since simulation start (minutes)
                                                                                                                                              
! JULIAN: Day of year (0.0 at 00Z Jan 1st)

!**********************************************************************
!****************************** NOTE **********************************
!**********************************************************************
!*** DUE TO THE RESETTING OF CONVECTIVE PRECIP AND CONVECTIVE CLOUD
!*** TOPS AND BOTTOMS, SHORTWAVE MUST NOT BE CALLED LESS FREQUENTLY
!*** THAN LONGWAVE.
!**********************************************************************
!****************************** NOTE **********************************
!**********************************************************************
!-----------------------------------------------------------------------
!     INTEGER, PARAMETER         :: NL=81
      INTEGER, INTENT(IN)        :: ids,ide, jds,jde, kds,kde ,         &
     &                              ims,ime, jms,jme, kms,kme ,         &
     &                              its,ite, jts,jte, kts,kte
      INTEGER, INTENT(IN)        :: NRADS,NRADL,NTSD,NPHS 
!     LOGICAL, INTENT(IN)        :: RESTRT
      REAL   , INTENT(IN)        :: DT,XTIME,JULIAN
!     REAL   , INTENT(IN), DIMENSION(37,NL) :: XDUO3N,XDO3N2,XDO3N3,XDO3N4
      INTEGER, INTENT(IN), DIMENSION(3) :: IDAT
!-----------------------------------------------------------------------
      INTEGER            :: LM1,LP1,LM
      INTEGER, INTENT(IN)               :: IHRST
!     REAL,    INTENT(IN), DIMENSION(NL)    :: PRGFDL
!
      REAL, PARAMETER :: EPSQ1=1.E-5,EPSQ=1.E-12,EPSO3=1.E-10,H0=0.     &
     &, H1=1.,HALF=.5,T0C=273.15,CUPRATE=24.*1000.,HPINC=HALF*1.E1      &
!------------------------ For Clouds ----------------------------------
     &, CLFRmin=0.01, TAUCmax=4.161                                     &
!--- Parameters used for new cloud cover scheme
     &, XSDmin=-XSDmax, DXSD1=-DXSD, STSDM=0.01, CVSDM=.04              &
     &, DXSD2=HALF*DXSD, DXSD2N=-DXSD2, PCLDY=0.25
!
      INTEGER, PARAMETER :: NB=12,KSMUD=0
      INTEGER,PARAMETER :: K15=SELECTED_REAL_KIND(15)
      REAL (KIND=K15) :: DDX,EEX,PROD
!     REAL, INTENT(IN) :: SKO3R,AB15WD,SKC1R,SKO2D
!-----------------------------------------------------------------------
      LOGICAL :: SHORT,LONG
      LOGICAL :: BITX,BITY,BITZ,BITW,BIT1,BIT2,BITC,BITCP1,BITSP1
      LOGICAL, SAVE :: CNCLD=.TRUE.
      LOGICAL :: NEW_CLOUD
!-----------------------------------------------------------------------
      REAL, INTENT(IN), DIMENSION(ims:ime,jms:jme) :: XLAND,TSK2D
      REAL, INTENT(IN), DIMENSION(its:ite, kms:kme, jts:jte):: Q,QCW,   &
     &                                                         QICE,T,  &
     &                                                         PFLIP,   &
     &                                                         P8WFLIP

!     REAL, INTENT(IN), DIMENSION(28,180) :: TABLE1,TABLE2,TABLE3,EM3,EM1,EM1WDE
      REAL, INTENT(OUT), DIMENSION(ims:ime, jms:jme):: GLW,GSW,CZMEAN   &
     &                                                ,RSWIN,RSWINC     & !Added
     &                                                ,CFRACL,CFRACM    &
     &                                                ,CFRACH
      REAL, INTENT(OUT),DIMENSION(ims:ime,kms:kme,jms:jme) :: CLDFRA   !added

!     REAL,   INTENT(IN), DIMENSION(kms:kme)   :: ETAD
!     REAL,   INTENT(IN), DIMENSION(kms:kme)   :: AETA
!-----------------------------------------------------------------------
      REAL, INTENT(IN), DIMENSION(ims:ime,jms:jme) :: CUTOP,CUBOT,CUPPT
      REAL,   INTENT(IN   ), DIMENSION(ims:ime,jms:jme)  :: ALB,SNO
!BSF => for NAMX changes, pass in surface emissivity (SFCEMS) [different for snow]
      REAL,   INTENT(IN   ), DIMENSION(ims:ime,jms:jme)  :: GLAT,GLON
!-----------------------------------------------------------------------
      REAL,   DIMENSION(ims:ime,jms:jme)  :: CZEN
      INTEGER, DIMENSION(its:ite, jts:jte):: LMH
!-----------------------------------------------------------------------
!     INTEGER,INTENT(IN), DIMENSION(jms:jme) :: IHE,IHW
!-----------------------------------------------------------------------
      REAL,   INTENT(INOUT), DIMENSION(ims:ime,jms:jme) :: ACFRCV,ACFRST &
                                                          ,RSWTOA,RLWTOA
      INTEGER,INTENT(INOUT), DIMENSION(ims:ime,jms:jme) :: NCFRCV,NCFRST
!-----------------------------------------------------------------------
      REAL,   INTENT(IN),   DIMENSION(ims:ime,jms:jme) :: VEGFRC
      REAL,   INTENT(INOUT),DIMENSION(its:ite,kts:kte,jts:jte) :: TENDL,&
     &                                                            TENDS
!-----------------------------------------------------------------------
      REAL :: CTHK(3)
      DATA CTHK/20000.0,20000.0,20000.0/

      REAL,DIMENSION(10),SAVE :: CC,PPT
!-----------------------------------------------------------------------
      REAL,SAVE :: ABCFF(NB)
      INTEGER,DIMENSION(its:ite,jts:jte) :: LVL
      REAL,   DIMENSION(its:ite, jts:jte):: PDSL,FNE,FSE,TL
      REAL,   DIMENSION(  0:kte)  :: CLDAMT
      REAL,   DIMENSION(its:ite,3):: CLDCFR
      INTEGER,   DIMENSION(its:ite,3):: MBOT,MTOP
      REAL,   DIMENSION(its:ite)  :: PSFC,TSKN,ALBEDO,XLAT,COSZ,        &
     &                               SLMSK,FLWUP,                       &
     &                               FSWDN,FSWUP,FSWDNS,FSWUPS,FLWDNS,  &
     &                               FLWUPS,FSWDNSC

      REAL,   DIMENSION(its:ite,kts:kte) :: PMID,TMID
      REAL,   DIMENSION(its:ite,kts:kte) :: QMID,THMID,OZN,POZN
      REAL,   DIMENSION(its:ite,jts:jte) :: TOT 

      REAL,   DIMENSION(its:ite,kts:kte+1) :: PINT,EMIS,CAMT
      INTEGER,DIMENSION(its:ite,kts:kte+1) :: KBTM,KTOP
      INTEGER,DIMENSION(its:ite)   :: NCLDS,KCLD 
      REAL,   DIMENSION(its:ite)   :: TAUDAR
      REAL,   DIMENSION(its:ite,NB,kts:kte+1) ::RRCL,TTCL

      REAL,   DIMENSION(its:ite,kts:kte):: CSMID,CCMID,QWMID,QIMID
!!      &                                     ,QOVRCST                  ! Added
      REAL,SAVE :: P400=40000.
      INTEGER,SAVE :: NFILE=14

!-----------------------------------------------------------------------
      REAL    :: CLSTP,TIME,DAYI,HOUR,ADDL,RANG
      REAL    :: TIMES,EXNER,APES,SNOFAC,CCLIMIT,CLIMIT,P1,P2,CC1,CC2
      REAL    :: PMOD,CLFR1,CTAU,WV,ARG,CLDMAX
      REAL    :: CL1,CL2,CR1,DPCL,QSUM,PRS1,PRS2,DELP,TCLD,DD,EE,AA,FF
      REAL    :: BB,GG,FCTR,PDSLIJ,CFRAVG,SNOMM
      REAL    :: THICK,CONVPRATE,CLFR,ESAT,QSAT,RHUM,QCLD
      REAL    :: RHtot,RRHO,FLARGE,FSMALL,DSNOW,SDM,QPCLDY,DIFCLD
      REAL    :: TauC,CTauL,CTauS,  CFSmax,CFCmax
      INTEGER :: I,J,MYJS,MYJE,MYIS,MYIE,NTSPH,NRADPP,ITIMSW,ITIMLW,    &
     &           JD,II
      INTEGER :: L,N,LML,LVLIJ,IR,KNTLYR,LL,NC,L400,NMOD,LTROP,IWKL
      INTEGER :: LCNVB,LCNVT
      INTEGER :: NLVL,MALVL,LLTOP,LLBOT,KBT2,KTH1,KBT1,KTH2,KTOP1,KFLIP
      INTEGER :: NBAND,NCLD,LBASE,NKTP,NBTM,KS,MYJS1,MYJS2,MYJE2,MYJE1
      INTEGER :: INDEXS,IXSD
      DATA    CC/0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1.0/
      DATA    PPT/0.,.14,.31,.70,1.6,3.4,7.7,17.,38.,85./
      DATA ABCFF/2*4.0E-5,.002,.035,.377,1.95,9.40,44.6,190.,989.,      &
     &           2706.,39011./
! begin debugging radiation
      integer :: imd,jmd, Jndx
      real :: FSWrat
      imd=(ims+ime)/2
      jmd=(jms+jme)/2
! end debugging radiation
!
!=======================================================================
!
!jaa      MYJS=jts_b1
!jaa      MYJE=jte_b1
      MYJS=jts
      MYJE=jte

      MYIS=its
      MYIE=ite
      MYJS1=jts !????
      MYJE1=jte
      MYJS2=jts
      MYJE2=jte
      LM=kte
      LM1=LM-1
      LP1=LM+1
!
      DO J=JTS,JTE
      DO I=ITS,ITE
        LMH(I,J)=KME-1
        LVL(I,J)=0
      ENDDO
      ENDDO
!**********************************************************************
!***  THE FOLLOWING CODE IS EXECUTED EACH TIME THE RADIATION IS CALLED.
!**********************************************************************
!----------------------CONVECTION--------------------------------------
!  NRADPP IS THE NUMBER OF TIME STEPS TO ACCUMULATE CONVECTIVE PRECIP
!     FOR RADIATION
!   NOTE: THIS WILL NOT WORK IF NRADS AND NRADL ARE DIFFERENT UNLESS
!         THEY ARE INTEGER MULTIPLES OF EACH OTHER
!  CLSTP IS THE NUMBER OF HOURS OF THE ACCUMULATION PERIOD
!
      NTSPH=NINT(3600./DT)
      NRADPP=MIN(NRADS,NRADL)
      CLSTP=1.0*NRADPP/NTSPH
      CONVPRATE=CUPRATE/CLSTP
!----------------------CONVECTION--------------------------------------
!***
!***  STATE WHETHER THE SHORT OR LONGWAVE COMPUTATIONS ARE TO BE DONE.
!***
      SHORT=.TRUE. 
      LONG=.TRUE. 
      ITIMSW=0
      ITIMLW=0
      IF(SHORT)ITIMSW=1
      IF(LONG) ITIMLW=1
!***
!***  FIND THE MEAN COSINE OF THE SOLAR ZENITH ANGLE 
!***  BETWEEN THE CURRENT TIME AND THE NEXT TIME RADIATION IS
!***  CALLED.  ONLY AVERAGE IF THE SUN IS ABOVE THE HORIZON.
!***
!     TIME=NTSD*DT
      TIME=XTIME*60.
!-----------------------------------------------------------------------
      CALL ZENITH(TIME,DAYI,HOUR,IDAT,IHRST,GLON,GLAT,CZEN,             &
     &            ITS,ITE,JTS,JTE,                                      &
     &            ids,ide, jds,jde, kds,kde,                            &
     &            ims,ime, jms,jme, kms,kme,                            &
     &            its,ite, jts,jte, kts,kte                         )
!-----------------------------------------------------------------------
!      write(0,*)'1st ZEN ',TIME,DAYI,HOUR,IDAT,IHRST,CZEN(ITS,JTS)
      ADDL=0.
      IF(MOD(IDAT(3),4).EQ.0)ADDL=1.
      RANG=2.*PI*(DAYI-RLAG)/(365.+ADDL)
      RSIN1=SIN(RANG)
      RCOS1=COS(RANG)
      RCOS2=COS(2.*RANG)
!
!-----------------------------------------------------------------------
      IF(SHORT)THEN
        DO J=MYJS,MYJE
        DO I=MYIS,MYIE
          CZMEAN(I,J)=0.
          TOT(I,J)=0.
        ENDDO
        ENDDO
!
        DO II=0,NRADS,NPHS
!         TIMES=NTSD*DT+II*DT
          TIMES=XTIME*60.+II*DT
          CALL ZENITH(TIMES,DAYI,HOUR,IDAT,IHRST,GLON,GLAT,CZEN,        &
     &                ITS,ITE,JTS,JTE,                                  &
     &                ids,ide, jds,jde, kds,kde,                        &
     &                ims,ime, jms,jme, kms,kme,                        &
     &                its,ite, jts,jte, kts,kte                       )
!         write(0,*)'2nd ZEN ',TIMES,DAYI,HOUR,IDAT,IHRST,CZEN(ITS,JTS),&
!    &                II,NRADS,NPHS,NTSD,DT
          DO J=MYJS,MYJE
          DO I=MYIS,MYIE
            IF(CZEN(I,J).GT.0.)THEN
              CZMEAN(I,J)=CZMEAN(I,J)+CZEN(I,J)
              TOT(I,J)=TOT(I,J)+1.
            ENDIF
          ENDDO
          ENDDO
        ENDDO
        DO J=MYJS,MYJE
        DO I=MYIS,MYIE
          IF(TOT(I,J).GT.0.)CZMEAN(I,J)=CZMEAN(I,J)/TOT(I,J)
        ENDDO
        ENDDO
      ENDIF
!
!***  Do not modify pressure for ozone concentrations below the top layer
!***
      DO L=2,LM
      DO I=MYIS,MYIE
        POZN(I,L)=H1
      ENDDO
      ENDDO
!-----------------------------------------------------------------------
!
!***********************************************************************
!***  THIS IS THE BEGINNING OF THE PRIMARY LOOP THROUGH THE DOMAIN
!***********************************************************************
!                        *********************
                         DO 700 J = MYJS, MYJE
!                        *********************
!
      DO 125 L=1,LM
      DO I=MYIS,MYIE
        TMID(I,L)=T(I,1,J)
        QMID(I,L)=EPSQ
        QWMID(I,L)=0.
        QIMID(I,L)=0.
        CSMID(I,L)=0.
        CCMID(I,L)=0.
        OZN(I,L)=EPSO3
        TENDS(I,L,J)=0.
        TENDL(I,L,J)=0.
      ENDDO
  125 CONTINUE
!
      DO 140 N=1,3
      DO I=MYIS,MYIE
        CLDCFR(I,N)=0.
        MTOP(I,N)=0
        MBOT(I,N)=0
      ENDDO
  140 CONTINUE
!***
!***  FILL IN WORKING ARRAYS WHERE VALUES AT L=LM ARE THOSE THAT
!***  ARE ACTUALLY AT ETA LEVEL L=LMH.
!***
      DO 200 I=MYIS,MYIE
!     IR=IRAD(I)
      LML=LMH(I,J)
      LVLIJ=LVL(I,J)
!
      DO L=1,LML
        PMID(I,L+LVLIJ)=PFLIP(I,L,J)
        PINT(I,L+LVLIJ+1)=P8WFLIP(I,L+1,J)
        EXNER=(1.E5/PMID(I,L+LVLIJ))**CAPPA
        TMID(I,L+LVLIJ)=T(I,L,J)
        THMID(I,L+LVLIJ)=T(I,L,J)*EXNER
        QMID(I,L+LVLIJ)=MAX(EPSQ, Q(I,L,J))
!--- Note that rain is ignored, only effects from cloud water and 
!    ice (cloud ice + snow) are considered
        QWMID(I,L+LVLIJ)=QCW(I,L,J)
        QIMID(I,L+LVLIJ)=QICE(I,L,J)
      ENDDO
!***
!***  FILL IN ARTIFICIAL VALUES ABOVE THE TOP OF THE DOMAIN.
!***  PRESSURE DEPTHS OF THESE LAYERS IS 1 HPA.
!***  TEMPERATURES ABOVE ARE ALREADY ISOTHERMAL WITH (TRUE) LAYER 1.
!***
      IF(LVLIJ.GT.0)THEN
        KNTLYR=0
!
        DO L=LVLIJ,1,-1
          KNTLYR=KNTLYR+1
          PMID(I,L)=P8WFLIP(I,1,J)-REAL(2*KNTLYR-1)*HPINC
          PINT(I,L+1)=PMID(I,L)+HPINC
          EXNER=(1.E5/PMID(I,L))**CAPPA
          THMID(I,L)=TMID(I,L)*EXNER
        ENDDO
      ENDIF
!
      IF(LVLIJ.EQ.0) THEN
         PINT(I,1)=P8WFLIP(I,1,J)
      ELSE
         PINT(I,1)=PMID(I,1)-HPINC
      ENDIF
  200 CONTINUE
!***
!***  FILL IN THE SURFACE PRESSURE, SKIN TEMPERATURE, GEODETIC LATITUDE,
!***  ZENITH ANGLE, SEA MASK, AND ALBEDO.  THE SKIN TEMPERATURE IS
!***  NEGATIVE OVER WATER.
!***
      DO 250 I=MYIS,MYIE
      PSFC(I)=P8WFLIP(I,KME,J)
      APES=(PSFC(I)*1.E-5)**CAPPA
!     TSKN(I)=THS(I,J)*APES*(1.-2.*SM(I,J))
      IF((XLAND(I,J)-1.5).GT.0.)THEN
        TSKN(I)=-TSK2D(I,J)
      ELSE
        TSKN(I)=TSK2D(I,J)
      ENDIF

!     TSKN(I)=THS(I,J)*APES*(1.-2.*(XLAND(I,J)-1.))
!     SLMSK(I)=SM(I,J)
      SLMSK(I)=XLAND(I,J)-1.
!
!     SNO(I,J)=AMAX1(SNO(I,J),0.)
!BSF => for NAMX changes, pass in surface emissivity (SFCEMS) [different for snow]
      SNOMM=AMAX1(SNO(I,J),0.)
      SNOFAC=AMIN1(SNOMM/0.02, 1.0)
!!!!  ALBEDO(I)=ALB(I,J)+(1.0-0.01*VEGFRC(I,J))*SNOFAC*(SNOALB-ALB(I,J))
      ALBEDO(I)=ALB(I,J)
!
      XLAT(I)=GLAT(I,J)*RTD
      COSZ(I)=CZMEAN(I,J)
  250 CONTINUE
!-----------------------------------------------------------------------
!---  COMPUTE GRID-SCALE CLOUD COVER FOR RADIATION  (Ferrier, Nov '04)
!
!--- Assumes Gaussian-distributed probability density functions (PDFs) for
!    total relative humidity (RHtot) within the grid for convective and
!    grid-scale cloud processes.  The standard deviation of RHtot is assumed
!    to be larger for convective clouds than grid-scale (stratiform) clouds.
!-----------------------------------------------------------------------
!
      DO I=MYIS,MYIE
        LML=LMH(I,J)
        LVLIJ=LVL(I,J)
        DO 255 L=1,LML
            LL=L+LVLIJ
!     write(0,*)' BAD i=',i,' j=',j,' l=',l,' ll=',ll,' qmid=',QMID(I,LL),' qimid=',QIMID(I,LL),' qwmid=',QWMID(I,LL)
            WV=QMID(I,LL)/(1.-QMID(I,LL))       !--- Water vapor mixing ratio
            QCLD=QWMID(I,LL)+QIMID(I,LL)        !--- Total cloud water + ice mixing ratio
            IF (QCLD .LE. EPSQ) GO TO 255       !--- Skip if no condensate is present
            CLFR=H0
            WV=QMID(I,LL)/(1.-QMID(I,LL))       !--- Water vapor mixing ratio
               
    !
    !--- Saturation vapor pressure w/r/t water ( >=0C ) or ice ( <0C )
    !
            ESAT=1000.*FPVS(TMID(I,LL))         !--- Saturation vapor pressure (Pa)
            QSAT=EP_2*ESAT/(PMID(I,LL)-ESAT)    !--- Saturation mixing ratio
            RHUM=WV/QSAT                        !--- Relative humidity
    !
    !--- Revised cloud cover parameterization (temporarily ignore rain)
    !
            RHtot=(WV+QCLD)/QSAT                !--- Total relative humidity
!!    !
!!    !--- QOVRCST is the amount of cloud condensate associated with full
!!    !    overcast, PCLDY is an arbitrary factor for partial cloudiness
!!    !
!!            TCLD=TMID(I,LL)-T0C                 !--- Air temp in deg C
!!            RRHO=(R_D*TMID(I,LL)*(1.+EP_1*QMID(I,LL)))/PMID(I,LL)
!!            IF (TCLD .GE. 0.) THEN
!!               QOVRCST(I,LL)=QAUT0*RRHO
!!            ELSE
!!               IF (TCLD.GE.-8. .AND. TCLD.LE.-3.) THEN
!!                  FLARGE=FLARGE1
!!               ELSE
!!                  FLARGE=FLARGE2
!!               ENDIF
!!               FSMALL=(1.-FLARGE)/FLARGE
!!               DSNOW=XMImax*EXP(XMIexp*TCLD)
!!               INDEXS=MAX(MDImin, MIN(MDImax, INT(DSNOW)))
!!               QOVRCST(I,LL)=NLImax*( FSMALL*MASSI(MDImin)              &
!!     &                               +MASSI(INDEXS) )*RRHO
!!            ENDIF                 !--- End IF (TCLD .GE. 0.)
!!            QOVRCST(I,LL)=PCLDY*QOVRCST(I,LL)
            LCNVT=NINT(CUTOP(I,J))+LVLIJ
            LCNVT=MIN(LM,LCNVT)
            LCNVB=NINT(CUBOT(I,J))+LVLIJ
            LCNVB=MIN(LM,LCNVB)
            IF (LL.GE.LCNVT .AND. LL.LE.LCNVB) THEN
               SDM=CVSDM
            ELSE
               SDM=STSDM
            ENDIF
            ARG=(RHtot-RHgrd)/SDM
            IF (ARG.LE.DXSD2 .AND. ARG.GE.DXSD2N) THEN
               CLFR=HALF
            ELSE IF (ARG .GT. DXSD2) THEN
               IF (ARG .GE. XSDmax) THEN
                  CLFR=H1
               ELSE
                  IXSD=INT(ARG/DXSD+HALF)
                  IXSD=MIN(NXSD, MAX(IXSD,1))
                  CLFR=HALF+AXSD(IXSD)
!                  if (SDprint)                                          &
!     & write(6,"(a,3i3,i4,f8.4,f7.4,2f6.3,f7.3,f6.1,f6.0)")                 &
!     & 'I,LL,J,IXSD,ARG,SDM,CLFR,RHtot,QSAT,T,P=', I,LL,J,IXSD,ARG,SDM,CLFR,RHtot     &
!     & ,1000.*QSAT,TCLD,.01*PMID(I,LL)
               ENDIF              !--- End IF (ARG .GE. XSDmax)
            ELSE
               IF (ARG .LE. XSDmin) THEN
                  CLFR=H0
               ELSE
                  IXSD=INT(ARG/DXSD1+HALF)
                  IXSD=MIN(NXSD, MAX(IXSD,1))
                  CLFR=HALF-AXSD(IXSD)
!                  if (SDprint)                                          &
!     & write(6,"(a,3i3,i4,f8.4,f7.4,2f6.3,f7.3,f6.1,f6.0)")                 &
!     & 'I,LL,J,IXSD,ARG,SDM,CLFR,RHtot,QSAT,T,P=', I,LL,J,IXSD,ARG,SDM,CLFR,RHtot     &
!     & ,1000.*QSAT,TCLD,.01*PMID(I,LL)
                  IF (CLFR .LT. CLFRmin) CLFR=H0
               ENDIF        !--- End IF (ARG .LE. XSDmin) 
            ENDIF           !--- IF (ARG.LE.DXSD2 .AND. ARG.GE.DXSD2N)
            CSMID(I,LL)=CLFR
!!  !
!!  !--- Here the condensate is adjusted to be only over the cloudy area
!!  !
!!            IF (CLFR.GT.0. .AND. QCLD.LE.0.) THEN
!!  !
!!  !--- Put in modest amounts of cloud water & cloud ice for partially cloudy grids
!!  !
!!               QPCLDY=MIN(.01*QSAT, QOVRCST(I,LL))
!!               IF (TCLD .GE. H0) THEN
!!                  QWMID(I,LL)=QPCLDY
!!               ELSE
!!                  QIMID(I,LL)=QPCLDY
!!               ENDIF
!!            ENDIF          !--- End IF (CLFR.GT.0. .AND. QCLD.LE.0.) 
255       CONTINUE         !--- End DO L=1,LML
      ENDDO                !--- End DO I=MYIS,MYIE
!
!***********************************************************************
!******************  END OF GRID-SCALE CLOUD FRACTIONS  ****************
!
!---  COMPUTE CONVECTIVE CLOUD COVER FOR RADIATION 
!
!--- The parameterization of Slingo (1987, QJRMS, Table 1, p. 904) is 
!    used for convective cloud fraction as a function of precipitation 
!    rate.  Cloud fractions have been increased by 20% for each rainrate
!    interval so that shallow, nonprecipitating convection is ascribed a
!    constant cloud fraction of 0.1  (Ferrier, Feb '02).
!***********************************************************************
!
      IF (CNCLD) THEN
        DO I=MYIS,MYIE
!
!***  CLOUD TOPS AND BOTTOMS COME FROM CUCNVC
!     Convective clouds need to be at least 2 model layers thick
!
          IF (CUBOT(I,J)-CUTOP(I,J) .GT. 1.0) THEN
 !--- Compute convective cloud fractions if appropriate  (Ferrier, Feb '02)
            CLFR=CC(1)
            PMOD=CUPPT(I,J)*CONVPRATE
            IF (PMOD .GT. PPT(1)) THEN
              DO NC=1,10
                IF(PMOD.GT.PPT(NC)) NMOD=NC
              ENDDO
              IF (NMOD .GE. 10) THEN
                CLFR=CC(10)
              ELSE
                CC1=CC(NMOD)
                CC2=CC(NMOD+1)
                P1=PPT(NMOD)
                P2=PPT(NMOD+1)
                CLFR=CC1+(CC2-CC1)*(PMOD-P1)/(P2-P1)
              ENDIF      !--- End IF (NMOD .GE. 10) ...
              CLFR=MIN(H1, CLFR)
            ENDIF        !--- End IF (PMOD .GT. PPT(1)) ...
  !
  !***  ADD LVL TO BE CONSISTENT WITH OTHER WORKING ARRAYS
  !
            LVLIJ=LVL(I,J)
            LCNVT=NINT(CUTOP(I,J))+LVLIJ
            LCNVT=MIN(LM,LCNVT)
            LCNVB=NINT(CUBOT(I,J))+LVLIJ
            LCNVB=MIN(LM,LCNVB)
!! !
!! !---- For debugging
!! !
!!      WRITE(6,"(2(A,I3),2(A,I2),2(A,F5.2),2(A,I2),A,F6.4)") 
!!     & ' J=',J,' I=',I,' LCNVB=',LCNVB,' LCNVT=',LCNVT
!!     &, ' CUBOT=',CUBOT(I,J),' CUTOP=',CUTOP(I,J)
!!     &,' LVL=',LVLIJ,' LMH=',LMH(I,J),' CCMID=',CLFR
!! !
   !
   !--- Build in small amounts of subgrid-scale convective condensate 
   !    (simple assumptions), but only if the convective cloud fraction 
   !    exceeds that of the grid-scale cloud fraction
   !
            DO LL=LCNVT,LCNVB
              ARG=MAX(H0, H1-CSMID(I,LL))
              CCMID(I,LL)=MIN(ARG,CLFR)
            ENDDO           !--- End DO LL=LCNVT,LCNVB
          ENDIF             !--- IF (CUBOT(I,J)-CUTOP(I,J) .GT. 1.0) ...
        ENDDO               !--- End DO I loop
      ENDIF                 !--- End IF (CNCLD) ...
!
!*********************************************************************
!***************  END OF CONVECTIVE CLOUD FRACTIONS  *****************
!*********************************************************************
!***
!***  DETERMINE THE FRACTIONAL CLOUD COVERAGE FOR HIGH, MID
!***  AND LOW OF CLOUDS FROM THE CLOUD COVERAGE AT EACH LEVEL
!***
!***  NOTE: THIS IS FOR DIAGNOSTICS ONLY!!!
!***
!***
       DO 500 I=MYIS,MYIE
!!
       DO L=0,LM
         CLDAMT(L)=0.
       ENDDO
!!  
!!***  NOW GOES LOW, MIDDLE, HIGH
!!
       DO 480 NLVL=1,3
       CLDMAX=0.
       MALVL=LM
       LLTOP=LM+1-LTOP(NLVL)+LVL(I,J)
!!***
!!***  GO TO THE NEXT CLOUD LAYER IF THE TOP OF THE CLOUD-TYPE IN
!!***  QUESTION IS BELOW GROUND OR IS IN THE LOWEST LAYER ABOVE GROUND.
!!***
       IF(LLTOP.GE.LM)GO TO 480
!!
       IF(NLVL.GT.1)THEN
         LLBOT=LM+1-LTOP(NLVL-1)-1+LVL(I,J)
         LLBOT=MIN(LLBOT,LM1)
       ELSE
         LLBOT=LM1
       ENDIF
!!
       DO 435 L=LLTOP,LLBOT
       CLDAMT(L)=AMAX1(CSMID(I,L),CCMID(I,L))
       IF(CLDAMT(L).GT.CLDMAX)THEN
         MALVL=L
         CLDMAX=CLDAMT(L)
       ENDIF
   435 CONTINUE
!!*********************************************************************
!! NOW, CALCULATE THE TOTAL CLOUD FRACTION IN THIS PRESSURE DOMAIN
!! USING THE METHOD DEVELOPED BY Y.H., K.A.C. AND A.K. (NOV., 1992).
!! IN THIS METHOD, IT IS ASSUMED THAT SEPERATED CLOUD LAYERS ARE
!! RADOMLY OVERLAPPED AND ADJACENT CLOUD LAYERS ARE MAXIMUM OVERLAPPED.
!! VERTICAL LOCATION OF EACH TYPE OF CLOUD IS DETERMINED BY THE THICKEST
!! CONTINUING CLOUD LAYERS IN THE DOMAIN.
!!*********************************************************************
       CL1=0.0
       CL2=0.0
       KBT1=LLBOT
       KBT2=LLBOT
       KTH1=0
       KTH2=0
!!
       DO 450 LL=LLTOP,LLBOT
       L=LLBOT-LL+LLTOP
       BIT1=.FALSE.
       CR1=CLDAMT(L)
       BITX=(PINT(I,L).GE.PTOPC(NLVL+1)).AND.                           &
      &     (PINT(I,L).LT.PTOPC(NLVL)).AND.                             &
      &     (CLDAMT(L).GT.0.0)
       BIT1=BIT1.OR.BITX
       IF(.NOT.BIT1)GO TO 450
!!***
!!***  BITY=T: FIRST CLOUD LAYER; BITZ=T:CONSECUTIVE CLOUD LAYER
!!***  NOTE:  WE ASSUME THAT THE THICKNESS OF EACH CLOUD LAYER IN THE
!!***         DOMAIN IS LESS THAN 200 MB TO AVOID TOO MUCH COOLING OR
!!***         HEATING. SO WE SET CTHK(NLVL)=200*E2. BUT THIS LIMIT MAY
!!***         WORK WELL FOR CONVECTIVE CLOUDS. MODIFICATION MAY BE
!!***         NEEDED IN THE FUTURE.
!!***
       BITY=BITX.AND.(KTH2.LE.0)
       BITZ=BITX.AND.(KTH2.GT.0)
!!
       IF(BITY)THEN
         KBT2=L
         KTH2=1
       ENDIF
!!
       IF(BITZ)THEN
         KTOP1=KBT2-KTH2+1
         DPCL=PMID(I,KBT2)-PMID(I,KTOP1)
         IF(DPCL.LT.CTHK(NLVL))THEN
           KTH2=KTH2+1
         ELSE
           KBT2=KBT2-1
         ENDIF
       ENDIF
       IF(BITX)CL2=AMAX1(CL2,CR1)
!!***
!!*** AT THE DOMAIN BOUNDARY OR SEPARATED CLD LAYERS, RANDOM OVERLAP.
!!*** CHOOSE THE THICKEST OR THE LARGEST FRACTION AMT AS THE CLD
!!*** LAYER IN THAT DOMAIN.
!!***
       BIT2=.FALSE.
       BITY=BITX.AND.(CLDAMT(L-1).LE.0.0.OR. &
            PINT(I,L-1).LT.PTOPC(NLVL+1))
       BITZ=BITY.AND.CL1.GT.0.0
       BITW=BITY.AND.CL1.LE.0.0
       BIT2=BIT2.OR.BITY
       IF(.NOT.BIT2)GO TO 450
!!
       IF(BITZ)THEN
         KBT1=INT((CL1*KBT1+CL2*KBT2)/(CL1+CL2))
         KTH1=INT((CL1*KTH1+CL2*KTH2)/(CL1+CL2))+1
         CL1=CL1+CL2-CL1*CL2
       ENDIF
!!
       IF(BITW)THEN
         KBT1=KBT2
         KTH1=KTH2
         CL1=CL2
       ENDIF
!!
       IF(BITY)THEN
         KBT2=LLBOT
         KTH2=0
         CL2=0.0
       ENDIF
   450 CONTINUE
!
       CLDCFR(I,NLVL)=AMIN1(1.0,CL1)
       MTOP(I,NLVL)=MIN(KBT1,KBT1-KTH1+1)
       MBOT(I,NLVL)=KBT1
   480 CONTINUE
   500 CONTINUE

!***
!***  SET THE UN-NEEDED TAUDAR TO ONE
!***
      DO I=MYIS,MYIE
        TAUDAR(I)=1.0
      ENDDO
!----------------------------------------------------------------------
! NOW, CALCULATE THE CLOUD RADIATIVE PROPERTIES AFTER DAVIS (1982),
! HARSHVARDHAN ET AL (1987) AND Y.H., K.A.C. AND A.K. (1993).
! 
! UPDATE: THE FOLLOWING PARTS ARE MODIFIED, AFTER Y.T.H. (1994), TO 
!         CALCULATE THE RADIATIVE PROPERTIES OF CLOUDS ON EACH MODEL
!         LAYER. BOTH CONVECTIVE AND STRATIFORM CLOUDS ARE USED
!         IN THIS CALCULATIONS.
!
!                                     QINGYUN ZHAO   95-3-22
!
!----------------------------------------------------------------------
!
!***
!*** INITIALIZE ARRAYS FOR USES LATER
!***

      DO 600 I=MYIS,MYIE
      LML=LMH(I,J)
      LVLIJ=LVL(I,J)
!
!***
!*** NOTE: LAYER=1 IS THE SURFACE, AND LAYER=2 IS THE FIRST CLOUD
!***       LAYER ABOVE THE SURFACE AND SO ON.
!***
      EMIS(I,1)=1.0
      KTOP(I,1)=LP1
      KBTM(I,1)=LP1
      CAMT(I,1)=1.0
      KCLD(I)=2
!
      DO NBAND=1,NB
        RRCL(I,NBAND,1)=0.0
        TTCL(I,NBAND,1)=1.0
      ENDDO
!
      DO 510 L=2,LP1
      CAMT(I,L)=0.0
      KTOP(I,L)=1
      KBTM(I,L)=1
      EMIS(I,L)=0.0
!
      DO NBAND=1,NB
        RRCL(I,NBAND,L)=0.0
        TTCL(I,NBAND,L)=1.0
      ENDDO
  510 CONTINUE

!### End changes so far
!***
!*** NOW CALCULATE THE AMOUNT, TOP, BOTTOM AND TYPE OF EACH CLOUD LAYER
!*** CLOUD TYPE=1: STRATIFORM CLOUD
!***       TYPE=2: CONVECTIVE CLOUD
!*** WHEN BOTH CONVECTIVE AND STRATIFORM CLOUDS EXIST AT THE SAME POINT,
!*** SELECT CONVECTIVE CLOUD WITH THE HIGHER CLOUD FRACTION.
!*** CLOUD LAYERS ARE SEPARATED BY TOTAL ABSENCE OF CLOUDINESS.
!*** NOTE: THERE IS ONLY ONE CONVECTIVE CLOUD LAYER IN ONE COLUMN.
!*** KTOP AND KBTM ARE THE TOP AND BOTTOM OF EACH CLOUD LAYER IN TERMS
!*** OF MODEL LEVEL.
!***
      NEW_CLOUD=.TRUE.
!
      DO L=2,LML
        LL=LML-L+1+LVLIJ                        !-- Model layer
        CLFR=MAX(CCMID(I,LL),CSMID(I,LL))       !-- Cloud fraction in layer
        CLFR1=MAX(CCMID(I,LL+1),CSMID(I,LL+1))  !-- Cloud fraction in lower layer
!-------------------
        IF (CLFR .GE. CLFRMIN) THEN
!--- Cloud present at level
          IF (NEW_CLOUD) THEN
!--- New cloud layer
            IF(L==2.AND.CLFR1>=CLFRmin)THEN
              KBTM(I,KCLD(I))=LL+1
              CAMT(I,KCLD(I))=CLFR1
            ELSE
              KBTM(I,KCLD(I))=LL
              CAMT(I,KCLD(I))=CLFR
            ENDIF
            NEW_CLOUD=.FALSE.
          ELSE
!--- Existing cloud layer
            CAMT(I,KCLD(I))=AMAX1(CAMT(I,KCLD(I)), CLFR)
          ENDIF        ! End IF (NEW_CLOUD .EQ. 0) ...
        ELSE IF (CLFR1 .GE. CLFRMIN) THEN
!--- Cloud is not present at level but did exist at lower level, then ...
          IF (L .EQ. 2) THEN
!--- For the case of ground fog
            KBTM(I,KCLD(I))=LL+1
            CAMT(I,KCLD(I))=CLFR1
          ENDIF
          KTOP(I,KCLD(I))=LL+1
          NEW_CLOUD=.TRUE.
          KCLD(I)=KCLD(I)+1
          CAMT(I,KCLD(I))=0.0
        ENDIF
!-------------------
      ENDDO      !--- End DO L loop
!***
!*** THE REAL NUMBER OF CLOUD LAYERS IS (THE FIRST IS THE GROUND;
!*** THE LAST IS THE SKY):
!***
      NCLDS(I)=KCLD(I)-2
      NCLD=NCLDS(I)
!***
!***  NOW CALCULATE CLOUD RADIATIVE PROPERTIES
!***
      IF(NCLD.GE.1)THEN
!***
!*** NOTE: THE FOLLOWING CALCULATIONS, THE UNIT FOR PRESSURE IS MB!!!
!***
        DO 580 NC=2,NCLD+1
!
        TauC=0.    !--- Total optical depth for each cloud layer (solar & longwave)
        QSUM=0.0
        NKTP=LP1
        NBTM=0
        BITX=CAMT(I,NC).GE.CLFRMIN
        NKTP=MIN(NKTP,KTOP(I,NC))
        NBTM=MAX(NBTM,KBTM(I,NC))
!
        DO LL=NKTP,NBTM
          IF(LL.GE.KTOP(I,NC).AND.LL.LE.KBTM(I,NC).AND.BITX)THEN
            PRS1=PINT(I,LL)*0.01
            PRS2=PINT(I,LL+1)*0.01
            DELP=PRS2-PRS1
            TCLD=TMID(I,LL)-T0C
            QSUM=QSUM+QMID(I,LL)*DELP*(PRS1+PRS2)                       &     
     &           /(120.1612*SQRT(TMID(I,LL)))
!
!***********************************************************************
!****  IMPORTANT NOTES concerning input cloud optical properties  ******
!***********************************************************************
!
!--- The simple optical depth parameterization from eq. (1) of Harshvardhan
!    et al. (1989, JAS, p. 1924; hereafter referred to as HRCD by authorship)
!    is used for convective cloud properties with some simple changes.
!
!--- The optical depth Tau is Tau=CTau*DELP, where values of CTau are
!    described below.
!      1) CTau=0.08*(Qc/Q0) for cloud water mixing ratio (Qc), where
!         Q0 is assumed to be the threshold mixing ratio for "thick anvils",
!         as noted in the 2nd paragraph after eq. (1) in Harshvardhan et al.
!         (1989).  A value of Q0=0.1 g/kg is assumed based on experience w/
!         cloud observations, and it is intended only to be a crude scaling
!         factor for "order of magnitude" effects.  The functional dependence
!         on mixing ratio is based on Stephens (1978, JAS, p. 2124, eq. 7).
!         Result: CTau=800.*Qc => note that the "800." factor is referred to
!         as an absorption coefficient
!      2) For an assumed value of Q0=1 g/kg for "thick anvils", then 
!         CTau=80.*Qc, or an absorption coefficient that is an order of 
!         magnitude less.
!      => ABSCOEF_W can vary from 100. to 1000. !!
!      3) From p. 3105 of Dudhia (1989), values of 
!         0.14 (m**2/g) * 1000 (g/kg) / 9.81 (m/s**2) = 14.27 /Pa
!         => 14.27 (/Pa) * 100 (Pa/mb) = 1427 /mb
!      4) From Dudhia's SW radiation, ABSCOEF_W ~ 1000.  after units conversion
!      5) Again from p. 3105 of Dudhia (1989), he notes that ice absorption 
!         coefficients are roughly half those of cloud water, it was decided
!         to keep this simple and assume half that of water.
!      => ABSCOEF_I=0.5*ABSCOEF_W
!
!--- For convection, the following is assumed:
!      1) A characteristic water/ice mixing ratio (Qconv)
!      2) A temperature threshold for water or ice (TRAD_ice)
!
!-----------------------------------------------------------------------
!
            CTau=0.
!-- For crude estimation of convective cloud optical depths
            IF (CCMID(I,LL) .GE. CLFRmin) THEN
              IF (TCLD .GE. TRAD_ice) THEN
                CTau=CTauCW            !--- Convective cloud water
              ELSE
                CTau=CTauCI            !--- Convective ice
              ENDIF
!              CTau=CTau*CCMID(I,LL)    !--- Reduce by convective cloud fraction
            ENDIF
!
!-- For crude estimation of grid-scale cloud optical depths
!
!--   => The following 2 lines were intended to reduce cloud optical depths further 
!        than what's parameterized in the NAM and what's theoretically justified
!            CTau=CTau+CSMID(I,LL)*   &
!     &           ( ABSCOEF_W*QWMID(I,LL)+ABSCOEF_I*QIMID(I,LL) )
            CTau=CTau+ABSCOEF_W*QWMID(I,LL)+ABSCOEF_I*QIMID(I,LL)
            TauC=TauC+DELP*CTau
          ENDIF      !--- End IF(LL.GE.KTOP(I,NC) ....
        ENDDO        !--- End DO LL
!
!!!!    IF(BITX)EMIS(I,NC)=1.0-EXP(-0.75*TauC)
        IF(BITX)EMIS(I,NC)=1.0-EXP(ABSCOEF_LW*TauC)
        IF(QSUM.GE.EPSQ1)THEN
!
          DO 570 NBAND=1,NB
          IF(BITX)THEN
            PROD=ABCFF(NBAND)*QSUM
            DDX=TauC/(TauC+PROD)
            EEX=1.0-DDX
            IF(ABS(EEX).GE.1.E-8)THEN
              DD=DDX
              EE=EEX
              FF=1.0-DD*0.85
              AA=MIN(50.0,SQRT(3.0*EE*FF)*TauC)
              AA=EXP(-AA)
              BB=FF/EE
              GG=SQRT(BB)
              DD=(GG+1.0)*(GG+1.0)-(GG-1.0)*(GG-1.0)*AA*AA
              RRCL(I,NBAND,NC)=MAX(0.1E-5,(BB-1.0)*(1.0-AA*AA)/DD)
              TTCL(I,NBAND,NC)=AMAX1(0.1E-5,4.0*GG*AA/DD)
            ENDIF
          ENDIF
  570     CONTINUE
        ENDIF
  580   CONTINUE
!
      ENDIF
!
  600 CONTINUE
!*********************************************************************
!******************  COMPUTE OZONE AT MIDLAYERS  *********************
!*********************************************************************
!
!***  MODIFY PRESSURE AT THE TOP MODEL LAYER TO ACCOUNT FOR THE TOTAL
!***  OZONE FROM MODEL TOP (PINT_1) TO THE TOP OF THE ATMOSPHERE (0 MB)
!
      DO I=MYIS,MYIE
        FCTR=PINT(I,2)/(PINT(I,2)-PINT(I,1))
        POZN(I,1)=FCTR*(PMID(I,1)-PINT(I,1))
      ENDDO
!
      CALL OZON2D(LM,POZN,XLAT,OZN,                                &
                  MYIS,MYIE,                                       &
                  ids,ide, jds,jde, kds,kde,                       &
                  ims,ime, jms,jme, kms,kme,                       &
                  its,ite, jts,jte, kts,kte                        )
!
!***  
!***  NOW THE VARIABLES REQUIRED BY RADFS HAVE BEEN CALCULATED.
!***
!----------------------------------------------------------------------
!***
!***  CALL THE GFDL RADIATION DRIVER
!***
!***
!     write(0,*)' RADTN before RADFS j=',j
      Jndx=J
      CALL RADFS &
     &     (PSFC,PMID,PINT,QMID,TMID,OZN,TSKN,SLMSK,ALBEDO,XLAT         &
!BSF => for NAMX changes, pass in surface emissivity (SFCEMS) [different for snow]
     &,     CAMT,KTOP,KBTM,NCLDS,EMIS,RRCL,TTCL                         &
     &,     COSZ,TAUDAR,1                                               &
     &,     1,0                                                         &
     &,     ITIMSW,ITIMLW                                               &
     &,     TENDS(ITS,KTS,J),TENDL(ITS,KTS,J)                           &
     &,     FLWUP,FSWUP,FSWDN,FSWDNS,FSWUPS,FLWDNS,FLWUPS,FSWDNSC       &
     &,     ids,ide, jds,jde, kds,kde                                   &
     &,     ims,ime, jms,jme, kms,kme                                   &
! begin debugging radiation
     &,     its,ite, jts,jte, kts,kte                                   &
     &,     imd,jmd, Jndx                                       )
! end debugging radiation
!----------------------------------------------------------------------
!     write(0,*)' RADTN after RADFS j=',j
      IF(LONG)THEN
!
!--  All fluxes in W/m**2
!--- GLW    => downward longwave at the surface (formerly RLWIN) 
!--- RLWTOA => outgoing longwave at the top of the atmosphere
!-- Note:  RLWOUT & SIGT4 have been removed because they are no longer being used!
!
        DO I=MYIS,MYIE
          GLW(I,J)=FLWDNS(I)

	if (I .eq. 50 .and. J .eq. 50) then
!	write(0,*) 'I,J, GLW(I,J) after RADFS: ', I,J,GLW(I,J)
	endif

          RLWTOA(I,J)=FLWUP(I)
	if (I .eq. 50 .and. J .eq. 50) then
!	write(0,*) 'I,J, RLWTOA(I,J) after RADFS: ', I,J,RLWTOA(I,J)
!	write(0,*) 'I,J, TENDL, TENDS: ', I,J, TENDL(I,10,J), TENDS(I,10,J)
	endif
        ENDDO
      ENDIF
!
      IF(SHORT)THEN
!
!--  All fluxes in W/m**2
!--- GSW    => NET shortwave at the surface 
!--- RSWIN  => incoming shortwave at the surface (all sky)
!--- RSWINC => clear-sky incoming shortwave at the surface
!--- RSWTOA => outgoing (reflected) shortwave at the top of the atmosphere 
!
        DO I=MYIS,MYIE
          GSW(I,J)=FSWDNS(I)-FSWUPS(I)
          RSWIN(I,J) =FSWDNS(I)
          RSWINC(I,J)=FSWDNSC(I)
          RSWTOA(I,J)=FSWUP(I)
        ENDDO
      ENDIF
!
!***  ARRAYS ACFRST AND ACFRCV ACCUMULATE AVERAGE STRATIFORM AND
!***  CONVECTIVE CLOUD FRACTIONS, RESPECTIVELY. 
!***  ACCUMLATE THESE VARIABLES ONLY ONCE PER RADIATION CALL.
!
!***  ASSUME RANDOM OVERLAP BETWEEN LOW, MIDDLE, & HIGH LAYERS.
!
!***  UPDATE NEW 3D CLOUD FRACTION (CLDFRA)
!
      DO I=MYIS,MYIE
        CFRACL(I,J)=CLDCFR(I,1)
        CFRACM(I,J)=CLDCFR(I,2)
        CFRACH(I,J)=CLDCFR(I,3)
        IF(CNCLD)THEN
          CFSmax=0.   !-- Maximum cloud fraction (stratiform component)
          CFCmax=0.   !-- Maximum cloud fraction (convective component)
          DO L=1,LMH(I,J)
            LL=L+LVL(I,J)
            CFSmax=MAX(CFSmax, CSMID(I,LL) )
            CFCmax=MAX(CFCmax, CCMID(I,LL) )
          ENDDO
          ACFRST(I,J)=ACFRST(I,J)+CFSmax
          NCFRST(I,J)=NCFRST(I,J)+1
          ACFRCV(I,J)=ACFRCV(I,J)+CFCmax
          NCFRCV(I,J)=NCFRCV(I,J)+1
        ELSE
  !--- Count only locations with grid-scale cloudiness, ignore convective clouds
  !    (option not used, but if so set to the total cloud fraction)
          CFRAVG=1.-(1.-CFRACL(I,J))*(1.-CFRACM(I,J))*(1.-CFRACH(I,J))
          ACFRST(I,J)=ACFRST(I,J)+CFRAVG
          NCFRST(I,J)=NCFRST(I,J)+1
        ENDIF
!--- Flip 3D cloud fractions in the vertical and save time
        LML=LMH(I,J)
        DO L=1,LML
          LL=LML-L+1+LVL(I,J)
          CLDFRA(I,L,J)=MAX(CCMID(I,LL),CSMID(I,LL))
        ENDDO
      ENDDO      !-- I index
!***
!***  THIS ROW IS FINISHED. GO TO NEXT
!***
!                        *********************
  700                          CONTINUE
!                        *********************
!----------------------------------------------------------------------
!***
!***  CALLS TO RADIATION THIS TIME STEP ARE COMPLETE.
!***
!----------------------------------------------------------------------
! begin debugging radiation
!     FSWrat=0.
!     if (RSWIN(imd,jmd) .gt. 0.)  &
!        FSWrat=(RSWIN(imd,jmd)-GSW(imd,jmd))/RSWIN(imd,jmd)
!     write(6,"(2a,2i5,7f9.2)") &
!       '{rad3 imd,jmd,GSW,RSWIN,RSWOUT=RSWIN-GSW,RSWINC,GLW,' &
!      ,'ALBEDO,RSWOUT/RSWIN = '&
!      ,imd,jmd, GSW(imd,jmd),RSWIN(imd,jmd)  &
!      ,RSWIN(imd,jmd)-GSW(imd,jmd),RSWINC(imd,jmd),GLW(imd,jmd) &
!      ,ALB(imd,jmd),FSWrat
! end debugging radiation
!----------------------------------------------------------------------
!
!--- Need to save LW & SW tendencies since radiation calculates both and this block

      END SUBROUTINE RADTN

!----------------------------------------------------------------------

      REAL FUNCTION GAUSIN(xsd)
      REAL, PARAMETER :: crit=1.e-3
      REAL A1,A2,RN,B1,B2,B3,SUM,xsd
!
!  This function calculate area under the Gaussian curve between mean
!  and xsd # of standard deviation (03/22/2004  Hsin-mu Lin)
!
      a1=xsd*RSQR
      a2=exp(-0.5*xsd**2)
      rn=1.
      b1=1.
      b2=1.
      b3=1.
      sum=1.
      do while (b2 .gt. crit)
         rn=rn+1.
         b2=xsd**2/(2.*rn-1.)
         b3=b1*b2
         sum=sum+b3
         b1=b3
      enddo
      GAUSIN=a1*a2*sum
      RETURN
      END FUNCTION GAUSIN

!----------------------------------------------------------------------

      SUBROUTINE ZENITH(TIMES,DAYI,HOUR,IDAT,IHRST,GLON,GLAT,CZEN,     &
                        MYIS,MYIE,MYJS,MYJE,                           &
                        IDS,IDE, JDS,JDE, KDS,KDE,                     &
                        IMS,IME, JMS,JME, KMS,KME,                     &
                        ITS,ITE, JTS,JTE, KTS,KTE)
!----------------------------------------------------------------------
      IMPLICIT NONE
!----------------------------------------------------------------------
      INTEGER, INTENT(IN)        :: IDS,IDE, JDS,JDE, KDS,KDE ,        &
                                    IMS,IME, JMS,JME, KMS,KME ,        &
                                    ITS,ITE, JTS,JTE, KTS,KTE
      INTEGER, INTENT(IN)        :: MYJS,MYJE,MYIS,MYIE

      REAL,    INTENT(IN)        :: TIMES
      REAL,    INTENT(OUT)       :: HOUR,DAYI
      INTEGER, INTENT(IN)        :: IHRST

      INTEGER, INTENT(IN), DIMENSION(3) :: IDAT 
      REAL,    INTENT(IN), DIMENSION(IMS:IME,JMS:JME) :: GLAT,GLON
      REAL,    INTENT(OUT), DIMENSION(IMS:IME,JMS:JME) :: CZEN

      REAL,    PARAMETER :: GSTC1=24110.54841,GSTC2=8640184.812866,    &
                            GSTC3=9.3104E-2,GSTC4=-6.2E-6,             &
                            PI=3.1415926,PI2=2.*PI,PIH=0.5*PI,         &
!#$                         DEG2RD=1.745329E-2,OBLIQ=23.440*DEG2RD,    &
                            DEG2RD=3.1415926/180.,OBLIQ=23.440*DEG2RD, &
                            ZEROJD=2451545.0

      REAL    :: DAY,YFCTR,ADDDAY,STARTYR,DATJUL,DIFJD,SLONM,   &
                 ANOM,SLON,DEC,RA,DATJ0,TU,STIM0,SIDTIM,HRANG
      REAL    :: HRLCL,SINALT
      INTEGER :: KMNTH,KNT,IDIFYR,J,I
      LOGICAL :: LEAP
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
      INTEGER :: MONTH (12)
!-----------------------------------------------------------------------
      DATA MONTH/31,28,31,30,31,30,31,31,30,31,30,31/
!***********************************************************************
!     SAVE MONTH

      DAY=0.
      LEAP=.FALSE.
      IF(MOD(IDAT(3),4).EQ.0)THEN
        MONTH(2)=29
        LEAP=.TRUE.
      ENDIF
      IF(IDAT(1).GT.1)THEN
        KMNTH=IDAT(1)-1
        DO 10 KNT=1,KMNTH
        DAY=DAY+REAL(MONTH(KNT))
   10   CONTINUE
      ENDIF
!***
!***  CALCULATE EXACT NUMBER OF DAYS FROM BEGINNING OF YEAR TO
!***  FORECAST TIME OF INTEREST 
!***
      DAY=DAY+REAL(IDAT(2)-1)+(REAL(IHRST)+TIMES/3600.)/24.
      DAYI=REAL(INT(DAY)+1)
      HOUR=(DAY-DAYI+1.)*24.
      YFCTR=2000.-IDAT(3)
!-----------------------------------------------------------------------
!***
!***  FIND CELESTIAL LONGITUDE OF THE SUN THEN THE SOLAR DECLINATION AND
!***  RIGHT ASCENSION.
!***
!-----------------------------------------------------------------------
      IDIFYR=IDAT(3)-2000
!***
!***  FIND JULIAN DATE OF START OF THE RELEVANT YEAR
!***  ADDING IN LEAP DAYS AS NEEDED
!***
      IF(IDIFYR.LT.0)THEN
        ADDDAY=REAL(IDIFYR/4)
      ELSE
        ADDDAY=REAL((IDIFYR+3)/4)
      ENDIF
      STARTYR=ZEROJD+IDIFYR*365.+ADDDAY-0.5
!***
!***  THE JULIAN DATE OF THE TIME IN QUESTION
!***
      DATJUL=STARTYR+DAY
!
!***  DIFFERENCE OF ACTUAL JULIAN DATE FROM JULIAN DATE
!***  AT 00H 1 January 2000
!
      DIFJD=DATJUL-ZEROJD
!
!***  MEAN GEOMETRIC LONGITUDE OF THE SUN
!
      SLONM=(280.460+0.9856474*DIFJD)*DEG2RD+YFCTR*PI2
!
!***  THE MEAN ANOMOLY
!
      ANOM=(357.528+0.9856003*DIFJD)*DEG2RD
!
!***  APPARENT GEOMETRIC LONGITUDE OF THE SUN
!
      SLON=SLONM+(1.915*SIN(ANOM)+0.020*SIN(2.*ANOM))*DEG2RD
      IF(SLON.GT.PI2)SLON=SLON-PI2
!
!***  DECLINATION AND RIGHT ASCENSION
! 
      DEC=ASIN(SIN(SLON)*SIN(OBLIQ))
      RA=ACOS(COS(SLON)/COS(DEC))
      IF(SLON.GT.PI)RA=PI2-RA
!***
!***  FIND THE GREENWICH SIDEREAL TIME THEN THE LOCAL SOLAR
!***  HOUR ANGLE.
!***
      DATJ0=STARTYR+DAYI-1.
      TU=(DATJ0-2451545.)/36525.
      STIM0=GSTC1+TU*(GSTC2+GSTC3*TU+GSTC4*TU*TU)
      SIDTIM=STIM0/3600.+YFCTR*24.+1.00273791*HOUR
      SIDTIM=SIDTIM*15.*DEG2RD
      IF(SIDTIM.LT.0.)SIDTIM=SIDTIM+PI2
      IF(SIDTIM.GT.PI2)SIDTIM=SIDTIM-PI2
      HRANG=SIDTIM-RA
!
      DO 100 J=MYJS,MYJE
      DO 100 I=MYIS,MYIE
!     HRLCL=HRANG-GLON(I,J)
      HRLCL=HRANG+GLON(I,J)+PI2
!***
!***  THE ZENITH ANGLE IS THE COMPLEMENT OF THE ALTITUDE THUS THE
!***  COSINE OF THE ZENITH ANGLE EQUALS THE SINE OF THE ALTITUDE.
!***
      SINALT=SIN(DEC)*SIN(GLAT(I,J))+COS(DEC)*COS(HRLCL)* &
       COS(GLAT(I,J))
      IF(SINALT.LT.0.)SINALT=0.
      CZEN(I,J)=SINALT
!     if(i==3.and.j==3)then
!       write(0,*) 'STARTYR, DAYI: ', STARTYR, DAYI
!       write(0,*) 'IDAT(1),IDAT(2),IDAT(3): ', IDAT(1),IDAT(2),IDAT(3)
!       write(0,*) 'SIDTIM,RA,HRANG,GLON: ', SIDTIM,RA,HRANG,GLON(I,J)
!       write(0,*) 'I,J,GLAT,DEC,HRLCL,CZEN: ', I,J,GLAT(I,J),DEC,HRLCL,CZEN(I,J)
!     endif
  100 CONTINUE
!***
!***  IF THE FORECAST IS IN A DIFFERENT YEAR THAN THE START TIME,
!***  RESET DAYI TO THE PROPER DAY OF THE NEW YEAR (IT MUST NOT BE
!***  RESET BEFORE THE SOLAR ZENITH ANGLE IS COMPUTED).
!***
      IF(DAYI.GT.365.)THEN
        IF(.NOT.LEAP)THEN
          DAYI=DAYI-365.
        ELSEIF(LEAP.AND.DAYI.GT.366.)THEN
          DAYI=DAYI-366.
        ENDIF
      ENDIF
!
      END SUBROUTINE ZENITH
!-----------------------------------------------------------------------

  SUBROUTINE OZON2D (LK,POZN,XLAT,QO3,                                &
                     MYIS,MYIE,                                       &
                     ids,ide, jds,jde, kds,kde,                       &
                     ims,ime, jms,jme, kms,kme,                       &
                     its,ite, jts,jte, kts,kte                        )
!----------------------------------------------------------------------
 IMPLICIT NONE
!----------------------------------------------------------------------
      INTEGER, INTENT(IN)        :: ids,ide, jds,jde, kds,kde ,      &
                                    ims,ime, jms,jme, kms,kme ,      &
                                    its,ite, jts,jte, kts,kte  
      INTEGER, INTENT(IN)        :: LK,MYIS,MYIE
      REAL,    INTENT(IN), DIMENSION(its:ite,kts:kte) :: POZN
      REAL,    INTENT(IN), DIMENSION(its:ite)  :: XLAT
      REAL,    INTENT(INOUT), DIMENSION(its:ite,kts:kte) :: QO3
!----------------------------------------------------------------------
      INTEGER, PARAMETER ::  NL=81,NLP1=NL+1,LNGTH=37*NL

!     REAL,    INTENT(IN),  DIMENSION(37,NL) :: XDUO3N,XDO3N4,XDO3N2,XDO3N3
!     REAL,    INTENT(IN), DIMENSION(NL)    :: PRGFDL
!----------------------------------------------------------------------
!----------------------------------------------------------------------
      INTEGER,DIMENSION(its:ite)    :: IARG,JJROW
      REAL,   DIMENSION(its:ite)    :: TTHAN
      REAL,   DIMENSION(its:ite,NL) :: QO3O3

      INTEGER :: I,K,NUMITR,ILOG,IT,NHALF
      REAL    :: TH2,DO3V,DO3VP,APHI,APLO
!----------------------------------------------------------------------
!
      DO I=ITS,ITE
        IARG(I)=0.
      ENDDO
!
      DO I=MYIS,MYIE
        TH2=0.2*XLAT(I)
        JJROW(I)=19.001-TH2
        TTHAN(I)=(19-JJROW(I))-TH2
        IARG(I)=MIN(JJROW(I),36)
      ENDDO
!
!***  SEASONAL AND SPATIAL INTERPOLATION DONE BELOW.
!
      DO K=1,NL
      DO I=MYIS,MYIE
        DO3V=XDUO3N(JJROW(I),K)+RSIN1*XDO3N2(JJROW(I),K)  &
                   +RCOS1*XDO3N3(JJROW(I),K)  &
                   +RCOS2*XDO3N4(JJROW(I),K)
        DO3VP=XDUO3N(IARG(I)+1,K)+RSIN1*XDO3N2(IARG(I)+1,K) &
                    +RCOS1*XDO3N3(IARG(I)+1,K) &
                    +RCOS2*XDO3N4(IARG(I)+1,K)
!
!***  NOW LATITUDINAL INTERPOLATION
!***  AND CONVERT O3 INTO MASS MIXING RATIO (ORIG DATA MPY BY 1.E4)
! 
        QO3O3(I,K)=1.E-4*(DO3V+TTHAN(I)*(DO3VP-DO3V))
      ENDDO
      ENDDO
!***
!***  VERTICAL INTERPOLATION FOR EACH GRIDPOINT (LINEAR IN LN P)
!***
      NUMITR=0
      ILOG=NL
   20 CONTINUE
      ILOG=(ILOG+1)/2
        IF(ILOG.EQ.1)GO TO 25
        NUMITR=NUMITR+1
        GO TO 20
   25 CONTINUE
!
      DO 60 K=1,LK
!
      NHALF=(NL+1)/2
      DO I=MYIS,MYIE
        JJROW(I)=NHALF
      ENDDO
!
      DO 40 IT=1,NUMITR
      NHALF=(NHALF+1)/2
      DO I=MYIS,MYIE
        IF(POZN(I,K).LT.PRGFDL(JJROW(I)-1))THEN
          JJROW(I)=JJROW(I)-NHALF
        ELSEIF(POZN(I,K).GE.PRGFDL(JJROW(I)))THEN
          JJROW(I)=JJROW(I)+NHALF
        ENDIF
        JJROW(I)=MIN(JJROW(I),NL)
        JJROW(I)=MAX(JJROW(I),2)
      ENDDO
   40 CONTINUE
!
      DO 50 I=MYIS,MYIE
      IF(POZN(I,K).LT.PRGFDL(1))THEN
        QO3(I,K)=QO3O3(I,1)
      ELSE IF(POZN(I,K).GT.PRGFDL(NL))THEN
        QO3(I,K)=QO3O3(I,NL)
      ELSE
        APLO=ALOG(PRGFDL(JJROW(I)-1))
        APHI=ALOG(PRGFDL(JJROW(I)))
        QO3(I,K)=QO3O3(I,JJROW(I))+(ALOG(POZN(I,K))-APHI)/ &
                   (APLO-APHI)* &
                   (QO3O3(I,JJROW(I)-1)-QO3O3(I,JJROW(I)))
      ENDIF
   50 CONTINUE
!
   60 CONTINUE

  END SUBROUTINE OZON2D
!-----------------------------------------------------------------------

! SUBROUTINE ZERO2(ARRAY, &
!                  ids,ide, jds,jde, kds,kde,                         &
!                  ims,ime, jms,jme, kms,kme,                         &
!                  its,ite, jts,jte, kts,kte                          )
!----------------------------------------------------------------------
!IMPLICIT NONE
!----------------------------------------------------------------------
!     INTEGER, INTENT(IN)        :: ids,ide, jds,jde, kds,kde ,      &
!                                   ims,ime, jms,jme, kms,kme ,      &
!                                   its,ite, jts,jte, kts,kte
!     REAL, INTENT(INOUT), DIMENSION(its:ite,jts:jte) :: ARRAY
!     INTEGER :: I,J
!----------------------------------------------------------------------
!     DO J=jts,jte
!     DO I=its,ite
!       ARRAY(I,J)=0.
!     ENDDO
!     ENDDO

! END SUBROUTINE ZERO2

!----------------------------------------------------------------

      SUBROUTINE O3INT(PHALF,DDUO3N,DDO3N2,DDO3N3,DDO3N4, &
                 ids,ide, jds,jde, kds,kde,            &
                 ims,ime, jms,jme, kms,kme,            &
                 its,ite, jts,jte, kts,kte             )
!----------------------------------------------------------------------
 IMPLICIT NONE
!----------------------------------------------------------------------
      INTEGER, INTENT(IN)        :: ids,ide, jds,jde, kds,kde ,      &
                                    ims,ime, jms,jme, kms,kme ,      &
                                    its,ite, jts,jte, kts,kte

!$$$  SUBPROGRAM DOCUMENTATION BLOCK
!                .      .    .                                       .
! SUBPROGRAM:    O3INT       COMPUTE ZONAL MEAN OZONE FOR ETA LYRS
!   PRGMMR: KENNETH CAMPANA  ORG: W/NMC23    DATE: 89-07-07
!           MICHAEL BALDWIN  ORG: W/NMC22    DATE: 92-06-08
!
! ABSTRACT: THIS CODE WRITTEN AT GFDL...
!   CALCULATES SEASONAL ZONAL MEAN OZONE,EVERY 5 DEG OF LATITUDE,
!   FOR CURRENT MODEL VERTICAL COORDINATE. OUTPUT DATA IN G/G * 1.E4
!   CODE IS CALLED ONLY ONCE.
!
! PROGRAM HISTORY LOG:
!   84-01-01  FELS AND SCHWARZKOPF,GFDL.
!   89-07-07  K. CAMPANA - ADAPTED STAND-ALONE CODE FOR IN-LINE USE.
!   92-06-08  M. BALDWIN - UPDATE TO RUN IN ETA MODEL
!
! USAGE:    CALL O3INT(O3,SIGL) OLD
!   INPUT ARGUMENT LIST:
!     PHALF    - MID LAYER PRESSURE (K=LM+1 IS MODEL SURFACE)
!   OUTPUT ARGUMENT LIST:
!     DDUO3N   - ZONAL MEAN OZONE DATA IN ALL MODEL LAYERS (G/G*1.E4)
!     DDO3N2     DIMENSIONED(L,N),WHERE L(=37) IS LATITUDE BETWEEN
!     DDO3N3     N AND S POLES,N=NUM OF VERTICAL LYRS(K=1 IS TOP LYR)
!     DDO3N4     AND SEASON-WIN,SPR,SUM,FALL.
!        IN COMMON
!
!   OUTPUT FILES:
!     OUTPUT   - PRINT FILE.
!
! ATTRIBUTES:
!   LANGUAGE: FORTRAN 200.
!
!$$$
!....     PROGRAM O3INT FROM DAN SCHWARZKOPF-GETS ZONAL MEAN O3
!..    OUTPUT O3 IS WINTER,SPRING,SUMMER,FALL (NORTHERN HEMISPHERE)
!-----------------------------------------------------------------------
!      INCLUDE "parmeta"
!-----------------------------------------------------------------------
!     *********************************************************

      INTEGER :: N,NP,NP2,NM1

!     PARAMETER (N=LM,NP=N+1,NP2=N+2,NM1=N-1)
!     *********************************************************
!-----------------------------------------------------------------------
!***
!***  SEASONAL CLIMATOLOGIES OF O3 (OBTAINED FROM A PREVIOUSLY RUN
!***  CODE WHICH INTERPOLATES O3 TO USER VERTICAL COORDINATE).
!***  DEFINED AS 5 DEG LAT MEANS N.P.->S.P.
!***
      REAL, INTENT(OUT), DIMENSION(37,kte):: DDUO3N,DDO3N2,DDO3N3,DDO3N4

!                        C O M M O N /SAVMEM/
!       ...WINTER....  ...SPRING....  ...SUMMER....  ....FALL.....
!    1  DDUO3N(37,LM), DDO3N2(37,LM), DDO3N3(37,LM), DDO3N4(37,LM)
!          ..... K.CAMPANA   OCTOBER 1988
!CCC  DIMENSION T41(NP2,2),O3O3(37,N,4)
!     DIMENSION SIGL(N)
!     *********************************************************
      REAL,DIMENSION(33) :: P2
      REAL,DIMENSION(37) :: PH2
      REAL,DIMENSION(45) :: PH1
      REAL,DIMENSION(48) :: P1
      REAL,DIMENSION(81) :: P,RSTD,RDATA
      REAL,DIMENSION(82) :: QI,PH
      REAL,DIMENSION(19,kts:kte) :: DDUO3(19,kts:kte)
      REAL,DIMENSION(10,41) :: RO31,RO32
      REAL,DIMENSION(19,41) :: DUO3N
      REAL,DIMENSION(19) :: TEMPN
      REAL,DIMENSION(10,9) :: O3HI2
      REAL,DIMENSION(10,25) :: O3HI
      REAL,DIMENSION(10,16) :: O3LO1,O3LO2,O3LO3,O3LO4,O3HI1
      REAL,DIMENSION(10,40) :: RO3M
      REAL,DIMENSION(10,41) :: RO3
      REAL,DIMENSION(37,kts:kte) :: O35DEG
      REAL,DIMENSION(kts:kte) :: RBAR
      REAL,DIMENSION(kts:kte+1) :: PHALF

      INTEGER :: NKK,NK,NKP,K,L,NCASE,ITAPE,IPLACE,NKMM,NKM,KI,KK,KQ,JJ,KEN
      REAL :: O3RD,O3TOT,O3DU

      EQUIVALENCE (O3HI1(1,1),O3HI(1,1)),(O3HI2(1,1),O3HI(1,17))
      EQUIVALENCE (PH1(1),PH(1)),(PH2(1),PH(46))
      EQUIVALENCE (P1(1),P(1)),(P2(1),P(49))
      DATA PH1/      0., &
           0.1027246E-04, 0.1239831E-04, 0.1491845E-04, 0.1788053E-04, &
           0.2135032E-04, 0.2540162E-04, 0.3011718E-04, 0.3558949E-04, &
           0.4192172E-04, 0.4922875E-04, 0.5763817E-04, 0.6729146E-04, &
           0.7834518E-04, 0.9097232E-04, 0.1053635E-03, 0.1217288E-03, &
           0.1402989E-03, 0.1613270E-03, 0.1850904E-03, 0.2119495E-03, &
           0.2423836E-03, 0.2768980E-03, 0.3160017E-03, 0.3602623E-03, &
           0.4103126E-03, 0.4668569E-03, 0.5306792E-03, 0.6026516E-03, &
           0.6839018E-03, 0.7759249E-03, 0.8803303E-03, 0.9987843E-03, &
           0.1133178E-02, 0.1285955E-02, 0.1460360E-02, 0.1660001E-02, &
           0.1888764E-02, 0.2151165E-02, 0.2452466E-02, 0.2798806E-02, &
           0.3197345E-02, 0.3656456E-02, 0.4185934E-02, 0.4797257E-02/
      DATA PH2/ &
           0.5503893E-02, 0.6321654E-02, 0.7269144E-02, 0.8368272E-02, &
           0.9644873E-02, 0.1112946E-01, 0.1285810E-01, 0.1487354E-01, &
           0.1722643E-01, 0.1997696E-01, 0.2319670E-01, 0.2697093E-01, &
           0.3140135E-01, 0.3660952E-01, 0.4274090E-01, 0.4996992E-01, &
           0.5848471E-01, 0.6847525E-01, 0.8017242E-01, 0.9386772E-01, &
           0.1099026E+00, 0.1286765E+00, 0.1506574E+00, 0.1763932E+00, &
           0.2065253E+00, 0.2415209E+00, 0.2814823E+00, 0.3266369E+00, &
           0.3774861E+00, 0.4345638E+00, 0.4984375E+00, 0.5697097E+00, &
           0.6490189E+00, 0.7370409E+00, 0.8344896E+00, 0.9421190E+00, &
           0.1000000E+01/
      DATA P1/ &
           0.9300000E-05, 0.1129521E-04, 0.1360915E-04, 0.1635370E-04, &
           0.1954990E-04, 0.2331653E-04, 0.2767314E-04, 0.3277707E-04, &
           0.3864321E-04, 0.4547839E-04, 0.5328839E-04, 0.6234301E-04, &
           0.7263268E-04, 0.8450696E-04, 0.9793231E-04, 0.1133587E-03, &
           0.1307170E-03, 0.1505832E-03, 0.1728373E-03, 0.1982122E-03, &
           0.2266389E-03, 0.2592220E-03, 0.2957792E-03, 0.3376068E-03, &
           0.3844381E-03, 0.4379281E-03, 0.4976965E-03, 0.5658476E-03, &
           0.6418494E-03, 0.7287094E-03, 0.8261995E-03, 0.9380076E-03, &
           0.1063498E-02, 0.1207423E-02, 0.1369594E-02, 0.1557141E-02, &
           0.1769657E-02, 0.2015887E-02, 0.2295520E-02, 0.2620143E-02, &
           0.2989651E-02, 0.3419469E-02, 0.3909867E-02, 0.4481491E-02, &
           0.5135272E-02, 0.5898971E-02, 0.6774619E-02, 0.7799763E-02/
      DATA P2/ &
           0.8978218E-02, 0.1036103E-01, 0.1195488E-01, 0.1382957E-01, &
           0.1599631E-01, 0.1855114E-01, 0.2151235E-01, 0.2501293E-01, &
           0.2908220E-01, 0.3390544E-01, 0.3952926E-01, 0.4621349E-01, &
           0.5403168E-01, 0.6330472E-01, 0.7406807E-01, 0.8677983E-01, &
           0.1015345E+00, 0.1189603E+00, 0.1391863E+00, 0.1630739E+00, &
           0.1908004E+00, 0.2235461E+00, 0.2609410E+00, 0.3036404E+00, &
           0.3513750E+00, 0.4055375E+00, 0.4656677E+00, 0.5335132E+00, &
           0.6083618E+00, 0.6923932E+00, 0.7845676E+00, 0.8875882E+00, &
           0.1000000E+01/
      DATA O3HI1/ &
       .55,.50,.45,.45,.40,.35,.35,.30,.30,.30, &
       .55,.51,.46,.47,.42,.38,.37,.36,.35,.35, &
       .55,.53,.48,.49,.44,.42,.41,.40,.38,.38, &
       .60,.55,.52,.52,.50,.47,.46,.44,.42,.41, &
       .65,.60,.55,.56,.53,.52,.50,.48,.45,.45, &
       .75,.65,.60,.60,.55,.55,.55,.50,.48,.47, &
       .80,.75,.75,.75,.70,.70,.65,.63,.60,.60, &
       .90,.85,.85,.80,.80,.75,.75,.74,.72,.71, &
       1.10,1.05,1.00,.90,.90,.90,.85,.83,.80,.80, &
       1.40,1.30,1.25,1.25,1.25,1.20,1.15,1.10,1.05,1.00, &
       1.7,1.7,1.6,1.6,1.6,1.6,1.6,1.6,1.5,1.5, &
       2.1,2.0,1.9,1.9,1.9,1.8,1.8,1.8,1.7,1.7, &
       2.4,2.3,2.2,2.2,2.2,2.1,2.1,2.1,2.0,2.0, &
       2.7,2.5,2.5,2.5,2.5,2.5,2.4,2.4,2.3,2.3, &
       2.9,2.8,2.7,2.7,2.7,2.7,2.7,2.7,2.6,2.6, &
       3.1,3.1,3.0,3.0,3.0,3.0,3.0,3.0,2.9,2.8/
      DATA O3HI2/ &
       3.3,3.4,3.4,3.6,3.7,3.9,4.0,4.1,4.0,3.8, &
       3.6,3.8,3.9,4.2,4.7,5.3,5.6,5.7,5.5,5.2, &
       4.1,4.3,4.7,5.2,6.0,6.7,7.0,6.8,6.4,6.2, &
       5.4,5.7,6.0,6.6,7.3,8.0,8.4,7.7,7.1,6.7, &
       6.7,6.8,7.0,7.6,8.3,10.0,9.6,8.2,7.5,7.2, &
       9.2,9.3,9.4,9.6,10.3,10.6,10.0,8.5,7.7,7.3, &
       12.6,12.1,12.0,12.1,11.7,11.0,10.0,8.6,7.8,7.4, &
       14.2,13.5,13.1,12.8,11.9,10.9,9.8,8.5,7.8,7.5, &
       14.3,14.0,13.4,12.7,11.6,10.6,9.3,8.4,7.6,7.3/
      DATA O3LO1/ &
       14.9,14.2,13.3,12.5,11.2,10.3,9.5,8.6,7.5,7.4, &
       14.5,14.1,13.0,11.8,10.5,9.8,9.2,7.9,7.4,7.4, &
       11.8,11.5,10.9,10.5,9.9,9.6,8.9,7.5,7.2,7.2, &
       7.3,7.7,7.8,8.4,8.4,8.5,7.9,7.4,7.1,7.1, &
       4.1,4.4,5.3,6.6,6.9,7.5,7.4,7.2,7.0,6.9, &
       1.8,1.9,2.5,3.3,4.5,5.8,6.3,6.3,6.4,6.1, &
       0.4,0.5,0.8,1.2,2.7,3.6,4.6,4.7,5.0,5.2, &
       .10,.15,.20,.50,1.4,2.1,3.0,3.2,3.5,3.9, &
       .07,.10,.12,.30,1.0,1.4,1.8,1.9,2.3,2.5, &
       .06,.08,.10,.15,.60,.80,1.4,1.5,1.5,1.6, &
       .05,.05,.06,.09,.20,.40,.70,.80,.90,.90, &
       .05,.05,.06,.08,.10,.13,.20,.25,.30,.40, &
       .05,.05,.05,.06,.07,.07,.08,.09,.10,.13, &
       .05,.05,.05,.05,.06,.06,.06,.06,.07,.07, &
       .05,.05,.05,.05,.05,.05,.05,.06,.06,.06, &
       .04,.04,.04,.04,.04,.04,.04,.05,.05,.05/
      DATA O3LO2/ &
       14.8,14.2,13.8,12.2,11.0,9.8,8.5,7.8,7.4,6.9, &
       13.2,13.0,12.5,11.3,10.4,9.0,7.8,7.5,7.0,6.6, &
       10.6,10.6,10.7,10.1,9.4,8.6,7.5,7.0,6.5,6.1, &
       7.0,7.3,7.5,7.5,7.5,7.3,6.7,6.4,6.0,5.8, &
       3.8,4.0,4.7,5.0,5.2,5.9,5.8,5.6,5.5,5.5, &
       1.4,1.6,2.4,3.0,3.7,4.1,4.6,4.8,5.1,5.0, &
       .40,.50,.90,1.2,2.0,2.7,3.2,3.6,4.3,4.1, &
       .07,.10,.20,.30,.80,1.4,2.1,2.4,2.7,3.0, &
       .06,.07,.09,.15,.30,.70,1.2,1.4,1.6,2.0, &
       .05,.05,.06,.12,.15,.30,.60,.70,.80,.80, &
       .04,.05,.06,.08,.09,.15,.30,.40,.40,.40, &
       .04,.04,.05,.055,.06,.09,.12,.13,.15,.15, &
       .03,.03,.045,.052,.055,.06,.07,.07,.06,.07, &
       .03,.03,.04,.051,.052,.052,.06,.06,.05,.05, &
       .02,.02,.03,.05,.05,.05,.04,.04,.04,.04, &
       .02,.02,.02,.04,.04,.04,.03,.03,.03,.03/
      DATA O3LO3/ &
       14.5,14.0,13.5,11.3,11.0,10.0,9.0,8.3,7.5,7.3, &
       13.5,13.2,12.5,11.1,10.4,9.7,8.2,7.8,7.4,6.8, &
       10.8,10.9,11.0,10.4,10.0,9.6,7.9,7.5,7.0,6.7, &
       7.3,7.5,7.8,8.5,9.0,8.5,7.7,7.4,6.9,6.5, &
       4.1,4.5,5.3,6.2,7.3,7.7,7.3,7.0,6.6,6.4, &
       1.8,2.0,2.2,3.8,4.3,5.6,6.2,6.2,6.4,6.2, &
       .30,.50,.60,1.5,2.8,3.7,4.5,4.7,5.5,5.6, &
       .09,.10,.15,.60,1.2,2.1,3.0,3.5,4.0,4.3, &
       .06,.08,.10,.30,.60,1.1,1.9,2.2,2.9,3.0, &
       .04,.05,.06,.15,.45,.60,1.1,1.3,1.6,1.8, &
       .04,.04,.04,.08,.20,.30,.55,.60,.75,.90, &
       .04,.04,.04,.05,.06,.10,.12,.15,.20,.25, &
       .04,.04,.03,.04,.05,.06,.07,.07,.07,.08, &
       .03,.03,.04,.05,.05,.05,.05,.05,.05,.05, &
       .03,.03,.03,.04,.04,.04,.05,.05,.04,.04, &
       .02,.02,.02,.04,.04,.04,.04,.04,.03,.03/
      DATA O3LO4/ &
       14.2,13.8,13.2,12.5,11.7,10.5,8.6,7.8,7.5,6.6, &
       12.5,12.4,12.2,11.7,10.8,9.8,7.8,7.2,6.5,6.1, &
       10.6,10.5,10.4,10.1,9.6,9.0,7.1,6.8,6.1,5.9, &
       7.0,7.4,7.9,7.8,7.6,7.3,6.2,6.1,5.8,5.6, &
       4.2,4.6,5.1,5.6,5.9,5.9,5.9,5.8,5.6,5.3, &
       2.1,2.3,2.6,2.9,3.5,4.3,4.8,4.9,5.1,5.1, &
       0.7,0.8,1.0,1.5,2.0,2.8,3.5,3.6,3.7,4.0, &
       .15,.20,.40,.50,.60,1.4,2.1,2.2,2.3,2.5, &
       .08,.10,.15,.25,.30,.90,1.2,1.3,1.4,1.6, &
       .07,.08,.10,.14,.20,.50,.70,.90,.90,.80, &
       .05,.06,.08,.12,.14,.20,.35,.40,.60,.50, &
       .05,.05,.08,.09,.09,.09,.11,.12,.15,.18, &
       .04,.05,.06,.07,.07,.08,.08,.08,.08,.08, &
       .04,.04,.05,.07,.07,.07,.07,.07,.06,.05, &
       .02,.02,.04,.05,.05,.05,.05,.05,.04,.04, &
       .02,.02,.03,.04,.04,.04,.04,.04,.03,.03/

!!!!!
!     PSS=101325.
!     PDIF=PSS-PT
!
!     DO L=1,LM1
!       PHALF(L+1)=AETA(L)*PDIF+PT
!     ENDDO
!
!     PHALF(1)=0.
!     PHALF(LP1)=PSS
!!!!
      N=kte;NP=N+1;NP2=N+2;NM1=N-1

      NKK=41
      NK=81
      NKP=NK+1
      DO 24 K=1,NP
!  24 PHALF(K)=PHALF(K)*1.0E 03
   24 PHALF(K)=PHALF(K)*0.01*1.0E+03
!  24 PSTD(K)=PSTD(K+1)*1.0E 03
      DO 25 K=1,NK
      PH(K)=PH(K)*1013250.
   25 P(K)=P(K)*1013250.
      PH(NKP)=PH(NKP)*1013250.
!KAC  WRITE (6,3) PH
!KAC  WRITE (6,3) P
!     WRITE (6,3) (PHALF(K),K=1,NP)
!     WRITE (6,3) (PSTD(K),K=1,NP)
!***LOAD ARRAYS RO31,RO32,AS IN DICKS PGM.
      DO 1010 K=1,25
      DO 1010 L=1,10
        RO31(L,K)=O3HI(L,K)
        RO32(L,K)=O3HI(L,K)
1010  CONTINUE
!
      DO 3000 NCASE=1,4
      ITAPE=NCASE+50
      IPLACE=2
      IF (NCASE.EQ.2) IPLACE=4
      IF (NCASE.EQ.3) IPLACE=1
      IF (NCASE.EQ.4) IPLACE=3
!***NCASE=1: SPRING (IN N.H.)
!***NCASE=2: FALL   (IN N.H.)
!***NCASE=3: WINTER (IN N.H.)
!***NCASE=4: SUMMER (IN N.H.)
      IF (NCASE.EQ.1.OR.NCASE.EQ.2) THEN
         DO 1011 K=26,41
         DO 1011 L=1,10
           RO31(L,K)=O3LO1(L,K-25)
           RO32(L,K)=O3LO2(L,K-25)
1011     CONTINUE
      ENDIF
      IF (NCASE.EQ.3.OR.NCASE.EQ.4) THEN
         DO 1031 K=26,41
         DO 1031 L=1,10
           RO31(L,K)=O3LO3(L,K-25)
           RO32(L,K)=O3LO4(L,K-25)
1031     CONTINUE
      ENDIF
      DO 30 KK=1,NKK
      DO 31 L=1,10
      DUO3N(L,KK)=RO31(11-L,KK)
   31 DUO3N(L+9,KK)=RO32(L,KK)
      DUO3N(10,KK)=.5*(RO31(1,KK)+RO32(1,KK))
   30 CONTINUE
!***FOR NCASE=2 OR NCASE=4,REVERSE LATITUDE ARRANGEMENT OF CORR. SEASON
      IF (NCASE.EQ.2.OR.NCASE.EQ.4) THEN
         DO 1024 KK=1,NKK
         DO 1025 L=1,19
           TEMPN(L)=DUO3N(20-L,KK)
1025     CONTINUE
         DO 1026 L=1,19
           DUO3N(L,KK)=TEMPN(L)
1026     CONTINUE
1024     CONTINUE
      ENDIF
!***DUO3N NOW IS O3 PROFILE FOR APPROPRIATE SEASON,AT STD. PRESSURE
!      LEVELS
!KAC  WRITE (6,800) DUO3N
!***BEGIN LATITUDE (10 DEG) LOOP
      DO 33 L=1,19
      DO 22 KK=1,NKK
   22 RSTD(KK)=DUO3N(L,KK)
      NKM=NK-1
      NKMM=NK-3
!     BESSELS HALF-POINT INTERPOLATION FORMULA
      DO 60 K=4,NKMM,2
      KI=K/2
   60 RDATA(K)=.5*(RSTD(KI)+RSTD(KI+1))-(RSTD(KI+2)-RSTD(KI+1)-RSTD(KI)+ &
      RSTD(KI-1))/16.
      RDATA(2)=.5*(RSTD(2)+RSTD(1))
      RDATA(NKM)=.5*(RSTD(NKK)+RSTD(NKK-1))
!     PUT UNCHANGED DATA INTO NEW ARRAY
      DO 61 K=1,NK,2
      KQ=(K+1)/2
   61 RDATA(K)=RSTD(KQ)
!---NOTE TO NMC: THIS WRITE IS COMMENTED OUT TO REDUCE PRINTOUT
!     WRITE (6,798) RDATA
!     CALCULATE LAYER-MEAN OZONE MIXING RATIO FOR EACH MODEL LEVEL
      DO 99 KK=1,N
      RBAR(KK)=0.
!     LOOP TO CALCULATE SUMS TO GET LAYER OZONE MEAN
      DO 98 K=1,NK
      IF(PH(K+1).LT.PHALF(KK)) GO TO 98
      IF(PH(K).GT.PHALF(KK+1)) GO TO 98
      IF(PH(K+1).LT.PHALF(KK+1).AND.PH(K).LT.PHALF(KK)) RBAR(KK)=RBAR(KK &
      )+RDATA(K)*(PH(K+1)-PHALF(KK))
      IF(PH(K+1).LT.PHALF(KK+1).AND.PH(K).GE.PHALF(KK)) RBAR(KK)=RBAR(KK &
      )+RDATA(K)*(PH(K+1)-PH(K))
      IF(PH(K+1).GT.PHALF(KK+1).AND.PH(K).GT.PHALF(KK)) RBAR(KK)=RBAR(KK &
      )+RDATA(K)*(PHALF(KK+1)-PH(K))
   98 CONTINUE
      RBAR(KK)=RBAR(KK)/(PHALF(KK+1)-PHALF(KK))
      IF(RBAR(KK).GT..0000) GO TO 99
!     CODE TO COVER CASE WHEN MODEL RESOLUTION IS SO FINE THAT NO VALUE
!     OF P(K) IN THE OZONE DATA ARRAY FALLS BETWEEN PHALF(KK+1) AND
!     PHALF(KK).   PROCEDURE IS TO SIMPLY GRAB THE NEAREST VALUE FROM
!     RDATA
      DO 29 K=1,NK
      IF(PH(K).LT.PHALF(KK).AND.PH(K+1).GE.PHALF(KK+1)) RBAR(KK)=RDATA(K)
   29 CONTINUE
   99 CONTINUE
!     CALCULATE TOTAL OZONE
      O3RD=0.
      DO 89 KK=1,80
   89 O3RD=O3RD+RDATA(KK)*(PH(KK+1)-PH(KK))
      O3RD=O3RD+RDATA(81)*(P(81)-PH(81))
      O3RD=O3RD/980.
      O3TOT=0.
      DO 88 KK=1,N
   88 O3TOT=O3TOT+RBAR(KK)*(PHALF(KK+1)-PHALF(KK))
      O3TOT=O3TOT/980.
!     UNITS ARE MICROGRAMS/CM**2
      O3DU=O3TOT/2.144
!     O3DU UNITS ARE DOBSON UNITS (10**-3 ATM-CM)
!--NOTE TO NMC: THIS IS COMMENTED OUT TO SAVE PRINTOUT
!     WRITE (6,796) O3RD,O3TOT,O3DU
      DO 23 KK=1,N
   23 DDUO3(L,KK)=RBAR(KK)*.01
   33 CONTINUE
!***END OF LATITUDE LOOP
!
!***CREATE 5 DEG OZONE QUANTITIES BY LINEAR INTERPOLATION OF
!      10 DEG VALUES
      DO 1060 KK=1,N
        DO 1061 L=1,19
          O35DEG(2*L-1,KK)=DDUO3(L,KK)
1061    CONTINUE
        DO 1062 L=1,18
          O35DEG(2*L,KK)=0.5*(DDUO3(L,KK)+DDUO3(L+1,KK))
1062    CONTINUE
1060  CONTINUE
!***OUTPUT TO UNIT (ITAPE) THE OZONE VALUES FOR LATER USE
!O222  ***************************************************
!C          WRITE (66) O35DEG
      IF (IPLACE.EQ.1) THEN
      DO 302 JJ=1,37
       DO 302 KEN=1,N
        DDUO3N(JJ,KEN) = O35DEG(JJ,KEN)
  302 CONTINUE
      ELSE IF (IPLACE.EQ.2) THEN
      DO 312 JJ=1,37
       DO 312 KEN=1,N
        DDO3N2(JJ,KEN) = O35DEG(JJ,KEN)
  312 CONTINUE
      ELSE IF (IPLACE.EQ.3) THEN
      DO 322 JJ=1,37
       DO 322 KEN=1,N
        DDO3N3(JJ,KEN) = O35DEG(JJ,KEN)
  322 CONTINUE
      ELSE IF (IPLACE.EQ.4) THEN
      DO 332 JJ=1,37
       DO 332 KEN=1,N
        DDO3N4(JJ,KEN) = O35DEG(JJ,KEN)
  332 CONTINUE
      END IF
!O222  ***************************************************
3000  CONTINUE
!***END OF LOOP OVER CASES
      RETURN
   1  FORMAT(10F4.2)
    2 FORMAT(10X,E14.7,1X,E14.7,1X,E14.7,1X,E14.7,1X)
   3  FORMAT(10E12.5)
  797 FORMAT(10F7.2)
  799 FORMAT(19F6.4)
  800 FORMAT(19F6.2)
  102 FORMAT(' O3 IPLACE=',I4)
 1033 FORMAT(19F6.5)
  101 FORMAT(5X,1H*,F6.5,1H,,F6.5,1H,,F6.5,1H,,F6.5,1H,,F6.5,1H,,F6.5, &
      1H,,F6.5,1H,,F6.5,1H,,F6.5,1H,)
      
      END SUBROUTINE O3INT
!----------------------------------------------------------------

  SUBROUTINE CLO89(CLDFAC,CAMT,NCLDS,KBTM,KTOP                  &
      ,          ids,ide, jds,jde, kds,kde                      &
      ,          ims,ime, jms,jme, kms,kme                      &
      ,          its,ite, jts,jte, kts,kte                      )
!----------------------------------------------------------------------
 IMPLICIT NONE
!----------------------------------------------------------------------
      INTEGER, INTENT(IN)        :: ids,ide, jds,jde, kds,kde ,      &
                                    ims,ime, jms,jme, kms,kme ,      &
                                    its,ite, jts,jte, kts,kte
!----------------------------------------------------------------------

!     ************************************************************
!     *                                                          *
!     * THIS SUBROUTINE WAS MODIFIED TO BE USED IN THE ETA MODEL *
!     *                                                          *
!     *                            Q. ZHAO    95-3-22            *
!     *                                                          *
!     ************************************************************

      REAL,    INTENT(OUT),DIMENSION(its:ite,kts:kte+1,kts:kte+1) :: CLDFAC
      REAL,    INTENT(IN), DIMENSION(its:ite,kts:kte+1) :: CAMT
      INTEGER, INTENT(IN), DIMENSION(its:ite,kts:kte+1) :: KBTM,KTOP
      INTEGER, INTENT(IN), DIMENSION(its:ite)           :: NCLDS

      REAL,    DIMENSION(kts:kte+1,kts:kte+1,64) :: CLDIPT
      REAL,    DIMENSION(kts:kte+1) :: CLDROW
      INTEGER:: IQ,ITOP,I,J,JTOP,IR,IP,K1,K2,KB,K,KP,KT,NC
      REAL   :: XCLD

      INTEGER :: L,LP1,LP2,LP3,LM1,LM2,LM3,MYIS,MYIE

    !  DIMENSION CLDIPT(LP1,LP1, 64 )
    !  DIMENSION NCLDS(IDIM1:IDIM2),KTOP(IDIM1:IDIM2,LP1), &
    !            KBTM(IDIM1:IDIM2,LP1)
    !  DIMENSION CLDROW(LP1)
    !  DIMENSION CAMT(IDIM1:IDIM2,LP1),CLDFAC(IDIM1:IDIM2,LP1,LP1)

      L=kte
      LP1=L+1;  LP2=L+2;  LP3=L+3
      LM1=L-1;  LM2=L-2;  LM3=L-3
      MYIS=its; MYIE=ite

!
      DO 1 IQ=MYIS,MYIE,64
      ITOP=IQ+63
      IF(ITOP.GT.MYIE) ITOP=MYIE
      JTOP=ITOP-IQ+1
      DO 11 IP=1,JTOP
      IR=IQ+IP-1
      IF (NCLDS(IR).EQ.0) THEN
        DO 25 J=1,LP1
        DO 25 I=1,LP1
        CLDIPT(I,J,IP)=1.
25      CONTINUE
      ENDIF
      IF (NCLDS(IR).GE.1) THEN
          XCLD=1.-CAMT(IR,2)
           K1=KTOP(IR,2)+1
           K2=KBTM(IR,2)
          DO 27 J=1,LP1
              CLDROW(J)=1.
27        CONTINUE
          DO 29 J=1,K2
              CLDROW(J)=XCLD
29        CONTINUE
          KB=MAX(K1,K2+1)
          DO 33 K=KB,LP1
          DO 33 KP=1,LP1
               CLDIPT(KP,K,IP)=CLDROW(KP)
33        CONTINUE
          DO 37 J=1,LP1
              CLDROW(J)=1.
37        CONTINUE
          DO 39 J=K1,LP1
              CLDROW(J)=XCLD
39        CONTINUE
          KT=MIN(K1-1,K2)
          DO 43 K=1,KT
          DO 43 KP=1,LP1
              CLDIPT(KP,K,IP)=CLDROW(KP)
43        CONTINUE
          IF(K2+1.LE.K1-1) THEN
            DO 31 J=K2+1,K1-1
            DO 31 I=1,LP1
                CLDIPT(I,J,IP)=1.
31          CONTINUE
          ELSE IF(K1.LE.K2) THEN
            DO 32 J=K1,K2
            DO 32 I=1,LP1
                CLDIPT(I,J,IP)=XCLD
32          CONTINUE
          ENDIF
      ENDIF

      IF (NCLDS(IR).GE.2) THEN
        DO 21 NC=2,NCLDS(IR)
          XCLD=1.-CAMT(IR,NC+1)
           K1=KTOP(IR,NC+1)+1
           K2=KBTM(IR,NC+1)
          DO 47 J=1,LP1
              CLDROW(J)=1.
47        CONTINUE
          DO 49 J=1,K2
              CLDROW(J)=XCLD
49        CONTINUE
          KB=MAX(K1,K2+1)
          DO 53 K=KB,LP1
          DO 53 KP=1,LP1
               CLDIPT(KP,K,IP)=CLDIPT(KP,K,IP)*CLDROW(KP)
53        CONTINUE
          DO 57 J=1,LP1
              CLDROW(J)=1.
57        CONTINUE
          DO 59 J=K1,LP1
              CLDROW(J)=XCLD
59        CONTINUE
          KT=MIN(K1-1,K2)
          DO 63 K=1,KT
          DO 63 KP=1,LP1
              CLDIPT(KP,K,IP)=CLDIPT(KP,K,IP)*CLDROW(KP)
63        CONTINUE
          IF(K1.LE.K2) THEN
            DO 52 J=K1,K2
            DO 52 I=1,LP1
                CLDIPT(I,J,IP)=CLDIPT(I,J,IP)*XCLD
52          CONTINUE
          ENDIF
21        CONTINUE
      ENDIF
11    CONTINUE
      DO 71 J=1,LP1
      DO 71 I=1,LP1
      DO 71 IP=1,JTOP
      IR=IQ+IP-1
      CLDFAC(IR,I,J)=CLDIPT(I,J,IP)
71    CONTINUE
1     CONTINUE

  END SUBROUTINE CLO89
!----------------------------------------------------------------
!     SUBROUTINE LWR88(HEATRA,GRNFLX,TOPFLX,                         &
!                      PRESS,TEMP,RH2O,QO3,CLDFAC,                   &
!                      CAMT,NCLDS,KTOP,KBTM,                         &
!!                     BO3RND,AO3RND,T1,T2,T4,EM1V,EM1VW,EM3V,       &
!                      BO3RND,AO3RND, &
!                      APCM,BPCM,ATPCM,BTPCM,ACOMB,BCOMB,BETACM,     &
!                      ZERO,ONE,H18E3,P0INV,H6P08108,DIFFCTR,        &
!                      GINV,H3M4,BETINW,RATH2OMW,GP0INV,P0,P0XZP8,   &
!                      P0XZP2,H3M3,H1M3,H1M2,H25E2,B0,B2,B1,B3,HAF,  &
!                      TEN,HP1,FOUR,HM1EZ,SKO3R,                     &
!                      AB15WD,SKC1R,RADCON,QUARTR,TWO,               &
!                      HM6666M2,HMP66667,HMP5, HP166666,H41666M2,    &
!                      RADCON1,H16E1, H28E1,H44194M2,H1P41819,SKO2D, &
!                      ids,ide, jds,jde, kds,kde,                    &
!                      ims,ime, jms,jme, kms,kme,                    &
!                      its,ite, jts,jte, kts,kte                     )

      SUBROUTINE LWR88(HEATRA,GRNFLX,TOPFLX,                         &
                       PRESS,TEMP,RH2O,QO3,CLDFAC,                   &
                       CAMT,NCLDS,KTOP,KBTM,                         &
!                      BO3RND,AO3RND,T1,T2,T4,EM1V,EM1VW,EM3V,       &
                       BO3RND,AO3RND, &
                       APCM,BPCM,ATPCM,BTPCM,ACOMB,BCOMB,BETACM,     &
                       ZERO,ONE,H18E3,P0INV,H6P08108,DIFFCTR,        &
                       GINV,H3M4,BETINW,RATH2OMW,GP0INV,P0,P0XZP8,   &
                       P0XZP2,H3M3,H1M3,H1M2,H25E2,B0,B2,B1,B3,HAF,  &
                       TEN,HP1,FOUR,HM1EZ,                           &
                       RADCON,QUARTR,TWO,                            &
                       HM6666M2,HMP66667,HMP5, HP166666,H41666M2,    &
                       RADCON1,H16E1, H28E1,H44194M2,H1P41819,       &
                       ids,ide, jds,jde, kds,kde,                    &
                       ims,ime, jms,jme, kms,kme,                    &
                       its,ite, jts,jte, kts,kte ,Jndx               )
!---------------------------------------------------------------------
 IMPLICIT NONE
!----------------------------------------------------------------------
!     INTEGER, PARAMETER :: NBLY=15

      INTEGER, INTENT(IN)        :: ids,ide, jds,jde, kds,kde ,      &
                                    ims,ime, jms,jme, kms,kme ,      &
                                    its,ite, jts,jte, kts,kte , Jndx
      REAL,    INTENT(IN)        :: ZERO,ONE,H18E3,P0INV,H6P08108,DIFFCTR
      REAL,    INTENT(IN)        :: GINV,H3M4,BETINW,RATH2OMW,GP0INV
      REAL,    INTENT(IN)        :: P0XZP8,P0XZP2,H3M3,P0,H1M3
      REAL,    INTENT(IN)        :: H1M2,H25E2,B0,B1,B2,B3,HAF
!     REAL,    INTENT(IN)        :: TEN,HP1,FOUR,HM1EZ,SKO3R
      REAL,    INTENT(IN)        :: TEN,HP1,FOUR,HM1EZ         
!     REAL,    INTENT(IN)        :: AB15WD,SKC1R,RADCON,QUARTR,TWO
      REAL,    INTENT(IN)        :: RADCON,QUARTR,TWO
      REAL,    INTENT(IN)        :: HM6666M2,HMP66667,HMP5, HP166666,H41666M2
!     REAL,    INTENT(IN) :: RADCON1,H16E1, H28E1,H44194M2,H1P41819,SKO2D
      REAL,    INTENT(IN) :: RADCON1,H16E1, H28E1,H44194M2,H1P41819
!----------------------------------------------------------------------
      REAL, INTENT(IN), DIMENSION(3) :: BO3RND,AO3RND
!     REAL,INTENT(IN),DIMENSION(5040):: T1,T2,T4,EM1V,EM1VW
!     REAL, INTENT(IN), DIMENSION(5040) :: EM3V
      REAL,INTENT(IN),DIMENSION(NBLY) :: APCM,BPCM,ATPCM,BTPCM,ACOMB, &
                                         BCOMB,BETACM

      REAL,    INTENT(IN),DIMENSION(its:ite,kts:kte+1,kts:kte+1) :: CLDFAC
      REAL,    INTENT(IN), DIMENSION(its:ite,kts:kte+1) :: CAMT
      INTEGER, INTENT(IN), DIMENSION(its:ite,kts:kte+1) :: KBTM,KTOP
      INTEGER, INTENT(IN), DIMENSION(its:ite)           :: NCLDS
     
      REAL,    INTENT(IN), DIMENSION(its:ite,kts:kte+1) :: PRESS,TEMP
      REAL,    INTENT(IN), DIMENSION(its:ite,kts:kte)   :: RH2O,QO3
      REAL,    INTENT(OUT), DIMENSION(its:ite,kts:kte)   :: HEATRA
      REAL,    INTENT(OUT), DIMENSION(its:ite)           :: GRNFLX,TOPFLX

!     REAL,    DIMENSION(kts:kte+1,kts:kte+1,64) :: CLDIPT

!     Include co2 data from a file, which needs to have exactly vertical
!     dimension of the model.
      

!!! ??? co2 table
!     REAL,    DIMENSION(kts:kte+1,kts:kte+1) :: CO251,CDT51,CDT58,C2D51,&
!                                                C2D58,CO258
!     REAL,    DIMENSION(kts:kte+1)           :: STEMP,GTEMP,CO231,CO238, &
!                                                C2D31,C2D38,CDT31,CDT38, &
!                                                CO271,CO278,C2D71,C2D78, &
!                                                CDT71,CDT78
!     REAL,    DIMENSION(kts:kte)             :: CO2M51,CO2M58,CDTM51,CDTM58, &
!                                                C2DM51,C2DM58
!!! end co2 table

!     REAL,    DIMENSION(kts:kte+1) :: CLDROW

      REAL,    DIMENSION(its:ite,kts:kte+1) :: TEXPSL,TOTPHI,TOTO3,CNTVAL,&
                                               TPHIO3,TOTVO2,TSTDAV,TDAV, & 
                                               VSUM3,CO2R1,D2CD21,DCO2D1, &
                                               CO2R2,D2CD22,DCO2D2,CO2SP1,&
                                               CO2SP2,CO2R,DCO2DT,D2CDT2, &
                                               TLSQU,DIFT
      REAL,    DIMENSION(its:ite,kts:kte)   :: DELP2,DELP,CO2NBL,&
                                               QH2O,VV,VAR1,VAR2,VAR3,VAR4
      REAL,    DIMENSION(its:ite,kts:kte+1) :: P,T
      REAL,    DIMENSION(its:ite,kts:kte)   :: CO2MR,CO2MD,CO2M2D
      REAL,    DIMENSION(its:ite,kts:kte*2+1):: EMPL

      REAL,    DIMENSION(its:ite)           :: EMX1,EMX2,VSUM1,VSUM2,A1,A2 
      REAL,    DIMENSION(its:ite,kts:kte+1,kts:kte+1) :: CO21

   !  COMMON/CO2BD3/CO251(LP1,LP1),CO258(LP1,LP1),CDT51(LP1,LP1),
   !  DIMENSION CO21(IDIM1:IDIM2,LP1,LP1),CO2NBL(IDIM1:IDIM2,L)
   !  DIMENSION CO2R(IDIM1:IDIM2,LP1),DIFT(IDIM1:IDIM2,LP1)
   ! 1   CO2M2D(IDIM1:IDIM2,L)
   !  DIMENSION CO2MR(IDIM1:IDIM2,L),CO2MD(IDIM1:IDIM2,L),
   ! 2 CO2M58(L),CDTM51(L),CDTM58(L),C2DM51(L),C2DM58(L),
   ! 1 CDT58(LP1,LP1),C2D51(LP1,LP1),C2D58(LP1,LP1),CO2M51(L),
   !  COMMON / CO2BD2 / CO231(LP1),CO238(LP1),CDT31(LP1),
   ! 1 CDT38(LP1),C2D31(LP1),C2D38(LP1)
   !  DIMENSION CO2R1(IDIM1:IDIM2,LP1),DCO2D1(IDIM1:IDIM2,LP1)
   !  DIMENSION D2CD21(IDIM1:IDIM2,LP1),D2CD22(IDIM1:IDIM2,LP1)
   ! 3 STEMP(LP1),GTEMP(LP1),B0,B1,B2,B3
   ! 1 VV(IDIM1:IDIM2,L),VSUM3(IDIM1:IDIM2,LP1),VSUM1(IDIM1:IDIM2),
   ! 2 VSUM2(IDIM1:IDIM2)
   !  DIMENSION TDAV(IDIM1:IDIM2,LP1),TSTDAV(IDIM1:IDIM2,LP1),
   !  LLP1=LL+1, LL = 2L
   !  EMX2(IDIM1:IDIM2),EMPL(IDIM1:IDIM2,LLP1)
   !  DIMENSION TPHIO3(IDIM1:IDIM2,LP1),
   !  DIMENSION TEXPSL(IDIM1:IDIM2,LP1)
   !  DIMENSION QH2O(IDIM1:IDIM2,L)
   !  DIMENSION DELP2(IDIM1:IDIM2,L)
   !  DIMENSION VAR1(IDIM1:IDIM2,L),VAR2(IDIM1:IDIM2,L),
   ! 1   VAR3(IDIM1:IDIM2,L),VAR4(IDIM1:IDIM2,L)
   ! 1 VV(IDIM1:IDIM2,L)
   !  DIMENSION CNTVAL(IDIM1:IDIM2,LP1)
   !  DIMENSION TOTO3(IDIM1:IDIM2,LP1)
   !  DIMENSION EMX1(IDIM1:IDIM2),

   !  DIMENSION PRESS(IDIM1:IDIM2,LP1),TEMP(IDIM1:IDIM2,LP1), &
   !     RH2O(IDIM1:IDIM2,L),QO3(IDIM1:IDIM2,L)
   !  DIMENSION HEATRA(IDIM1:IDIM2,L),GRNFLX(IDIM1:IDIM2),    &
   !     TOPFLX(IDIM1:IDIM2)

!
!
!****COMPUTE FLUX PRESSURES (P) AND DIFFERENCES (DELP2,DELP)
!****COMPUTE FLUX LEVEL TEMPERATURES (T) AND CONTINUUM TEMPERATURE
!    CORRECTIONS (TEXPSL)
    
      INTEGER :: K, I,KP, KK
      INTEGER :: L,LP1,LP2,LP3,LM1,LM2,LM3,MYIS,MYIE,LLP1,LL

      L=kte
      LP1=L+1;  LP2=L+2;  LP3=L+3; LLP1 = 2*L + 1
      LM1=L-1;  LM2=L-2;  LM3=L-3; LL = 2*L
      MYIS=its; MYIE=ite


      DO 103 K=2,L
      DO 103 I=MYIS,MYIE
      P(I,K)=HAF*(PRESS(I,K-1)+PRESS(I,K))
      T(I,K)=HAF*(TEMP(I,K-1)+TEMP(I,K))
103   CONTINUE
      DO 105 I=MYIS,MYIE
      P(I,1)=ZERO
      P(I,LP1)=PRESS(I,LP1)
      T(I,1)=TEMP(I,1)
      T(I,LP1)=TEMP(I,LP1)
105   CONTINUE
      DO 107 K=1,L
      DO 107 I=MYIS,MYIE
      DELP2(I,K)=P(I,K+1)-P(I,K)
      DELP(I,K)=ONE/DELP2(I,K)
107   CONTINUE
!****COMPUTE ARGUMENT FOR CONT.TEMP.COEFF.
!    (THIS IS 1800.(1./TEMP-1./296.))
      DO 125 K=1,LP1
      DO 125 I=MYIS,MYIE
      if(abs(temp(i,k))<1.e-6)then
!        write(0,*)' LWR88 i=',i,' j=',jndx,' k=',k,' temp=',temp(i,k)
	do KK=1,LP1
!	write(0,*) 'KK, TEMP(I,KK): ', KK, TEMP(I,KK)
	enddo
      endif
      TEXPSL(I,K)=H18E3/TEMP(I,K)-H6P08108
!...THEN TAKE EXPONENTIAL
      TEXPSL(I,K)=EXP(TEXPSL(I,K))
125   CONTINUE
!***COMPUTE OPTICAL PATHS FOR H2O AND O3, USING THE DIFFUSIVITY
!   APPROXIMATION FOR THE ANGULAR INTEGRATION (1.66). OBTAIN THE
!   UNWEIGHTED VALUES(VAR1,VAR3) AND THE WEIGHTED VALUES(VAR2,VAR4).
!   THE QUANTITIES H3M4(.0003) AND H3M3(.003) APPEARING IN THE VAR2 AND
!   VAR4 EXPRESSIONS ARE THE APPROXIMATE VOIGT CORRECTIONS FOR H2O AND
!   O3,RESPECTIVELY.
!
      DO 131 K=1,L
      DO 131 I=MYIS,MYIE
      QH2O(I,K)=RH2O(I,K)*DIFFCTR
!---VV IS THE LAYER-MEAN PRESSURE (IN ATM),WHICH IS NOT THE SAME AS
!   THE LEVEL PRESSURE (PRESS)
      VV(I,K)=HAF*(P(I,K+1)+P(I,K))*P0INV
      VAR1(I,K)=DELP2(I,K)*QH2O(I,K)*GINV
      VAR3(I,K)=DELP2(I,K)*QO3(I,K)*DIFFCTR*GINV
      VAR2(I,K)=VAR1(I,K)*(VV(I,K)+H3M4)
      VAR4(I,K)=VAR3(I,K)*(VV(I,K)+H3M3)
!  COMPUTE OPTICAL PATH FOR THE H2O CONTINUUM, USING ROBERTS COEFFS.
!  (BETINW),AND TEMP. CORRECTION (TEXPSL). THE DIFFUSIVITY FACTOR
!  (WHICH CANCELS OUT IN THIS EXPRESSION) IS ASSUMED TO BE 1.66. THE
!  USE OF THE DIFFUSIVITY FACTOR HAS BEEN SHOWN TO BE A SIGNIFICANT
!  SOURCE OF ERROR IN THE CONTINUUM CALCS.,BUT THE TIME PENALTY OF
!  AN ANGULAR INTEGRATION IS SEVERE.
!
      CNTVAL(I,K)=TEXPSL(I,K)*RH2O(I,K)*VAR2(I,K)*BETINW/ &
                   (RH2O(I,K)+RATH2OMW)
131   CONTINUE
!   COMPUTE SUMMED OPTICAL PATHS FOR H2O,O3 AND CONTINUUM
      DO 201 I=MYIS,MYIE
      TOTPHI(I,1)=ZERO
      TOTO3(I,1)=ZERO
      TPHIO3(I,1)=ZERO
      TOTVO2(I,1)=ZERO
201   CONTINUE
      DO 203 K=2,LP1
      DO 203 I=MYIS,MYIE
      TOTPHI(I,K)=TOTPHI(I,K-1)+VAR2(I,K-1)
      TOTO3(I,K)=TOTO3(I,K-1)+VAR3(I,K-1)
      TPHIO3(I,K)=TPHIO3(I,K-1)+VAR4(I,K-1)
      TOTVO2(I,K)=TOTVO2(I,K-1)+CNTVAL(I,K-1)
203   CONTINUE
!---EMX1 IS THE ADDITIONAL PRESSURE-SCALED MASS FROM PRESS(L) TO
!   P(L). IT IS USED IN NEARBY LAYER AND EMISS CALCULATIONS.
!---EMX2 IS THE ADDITIONAL PRESSURE-SCALED MASS FROM PRESS(L) TO
!   P(LP1). IT IS USED IN CALCULATIONS BETWEEN FLUX LEVELS L AND LP1.
!
      DO 801 I=MYIS,MYIE
      EMX1(I)=QH2O(I,L)*PRESS(I,L)*(PRESS(I,L)-P(I,L))*GP0INV
      EMX2(I)=QH2O(I,L)*PRESS(I,L)*(P(I,LP1)-PRESS(I,L))*GP0INV
801   CONTINUE
!---EMPL IS THE PRESSURE SCALED MASS FROM P(K) TO PRESS(K) (INDEX 2-LP1)
!   OR TO PRESS(K+1) (INDEX LP2-LL)
      DO 811 K=1,L
      DO 811 I=MYIS,MYIE
      EMPL(I,K+1)=QH2O(I,K)*P(I,K+1)*(P(I,K+1)-PRESS(I,K))*GP0INV
811   CONTINUE
      DO 812 K=1,LM1
      DO 812 I=MYIS,MYIE
      EMPL(I,LP2+K-1)=QH2O(I,K+1)*P(I,K+1)*(PRESS(I,K+1)-P(I,K+1)) &
                     *GP0INV
812   CONTINUE
      DO 821 I=MYIS,MYIE
      EMPL(I,1)=VAR2(I,L)
      EMPL(I,LLP1)=EMPL(I,LL)
821   CONTINUE
!***COMPUTE WEIGHTED TEMPERATURE (TDAV) AND PRESSURE (TSTDAV) INTEGRALS
!   FOR USE IN OBTAINING TEMP. DIFFERENCE BET. SOUNDING AND STD.
!   TEMP. SOUNDING (DIFT)
      DO 161 I=MYIS,MYIE
      TSTDAV(I,1)=ZERO
      TDAV(I,1)=ZERO
161   CONTINUE
      DO 162 K=1,LP1
      DO 162 I=MYIS,MYIE
      VSUM3(I,K)=TEMP(I,K)-STEMP(K)
162   CONTINUE
      DO 163 K=1,L
      DO 165 I=MYIS,MYIE
      VSUM2(I)=GTEMP(K)*DELP2(I,K)
      VSUM1(I)=VSUM2(I)*VSUM3(I,K)
      TSTDAV(I,K+1)=TSTDAV(I,K)+VSUM2(I)
      TDAV(I,K+1)=TDAV(I,K)+VSUM1(I)
165   CONTINUE
163   CONTINUE
!
!****EVALUATE COEFFICIENTS FOR CO2 PRESSURE INTERPOLATION (A1,A2)
      DO 171 I=MYIS,MYIE
      A1(I)=(PRESS(I,LP1)-P0XZP8)/P0XZP2
      A2(I)=(P0-PRESS(I,LP1))/P0XZP2
171   CONTINUE
!***PERFORM CO2 PRESSURE INTERPOLATION ON ALL INPUTTED TRANSMISSION
!   FUNCTIONS AND TEMP. DERIVATIVES
!---SUCCESSIVELY COMPUTING CO2R,DCO2DT AND D2CDT2 IS DONE TO SAVE
!   STORAGE (AT A SLIGHT LOSS IN COMPUTATION TIME)
      DO 184 K=1,LP1
      DO 184 I=MYIS,MYIE
        CO2R1(I,K)=A1(I)*CO231(K)+A2(I)*CO238(K)
        D2CD21(I,K)=H1M3*(A1(I)*C2D31(K)+A2(I)*C2D38(K))
        DCO2D1(I,K)=H1M2*(A1(I)*CDT31(K)+A2(I)*CDT38(K))
        CO2R2(I,K)=A1(I)*CO271(K)+A2(I)*CO278(K)
        D2CD22(I,K)=H1M3*(A1(I)*C2D71(K)+A2(I)*C2D78(K))
        DCO2D2(I,K)=H1M2*(A1(I)*CDT71(K)+A2(I)*CDT78(K))
184   CONTINUE
      DO 190 K=1,L
      DO 190 I=MYIS,MYIE
        CO2MR(I,K)=A1(I)*CO2M51(K)+A2(I)*CO2M58(K)
        CO2MD(I,K)=H1M2*(A1(I)*CDTM51(K)+A2(I)*CDTM58(K))
        CO2M2D(I,K)=H1M3*(A1(I)*C2DM51(K)+A2(I)*C2DM58(K))
190   CONTINUE
!***COMPUTE CO2 TEMPERATURE INTERPOLATIONS FOR ALL BANDS,USING DIFT
!
!   THE CASE WHERE K=1 IS HANDLED FIRST. WE ARE NOW REPLACING
!   3-DIMENSIONAL ARRAYS BY 2-D ARRAYS, TO SAVE SPACE. THUS THIS
!   CALCULATION IS FOR (I,KP,1)
      DO 211 KP=2,LP1
      DO 211 I=MYIS,MYIE
      DIFT(I,KP)=TDAV(I,KP)/TSTDAV(I,KP)
211   CONTINUE
      DO 212 I=MYIS,MYIE
      CO21(I,1,1)=1.0
      CO2SP1(I,1)=1.0
      CO2SP2(I,1)=1.0
212   CONTINUE
      DO 215 KP=2,LP1
      DO 215 I=MYIS,MYIE
!---CALCULATIONS FOR KP>1 FOR K=1
      CO2R(I,KP)=A1(I)*CO251(KP,1)+A2(I)*CO258(KP,1)
      DCO2DT(I,KP)=H1M2*(A1(I)*CDT51(KP,1)+A2(I)*CDT58(KP,1))
      D2CDT2(I,KP)=H1M3*(A1(I)*C2D51(KP,1)+A2(I)*C2D58(KP,1))
      CO21(I,KP,1)=CO2R(I,KP)+DIFT(I,KP)*(DCO2DT(I,KP)+ &
                   HAF*DIFT(I,KP)*D2CDT2(I,KP))
!---CALCULATIONS FOR (EFFECTIVELY) KP=1,K>KP. THESE USE THE
!   SAME VALUE OF DIFT DUE TO SYMMETRY
      CO2R(I,KP)=A1(I)*CO251(1,KP)+A2(I)*CO258(1,KP)
      DCO2DT(I,KP)=H1M2*(A1(I)*CDT51(1,KP)+A2(I)*CDT58(1,KP))
      D2CDT2(I,KP)=H1M3*(A1(I)*C2D51(1,KP)+A2(I)*C2D58(1,KP))
      CO21(I,1,KP)=CO2R(I,KP)+DIFT(I,KP)*(DCO2DT(I,KP)+ &
                   HAF*DIFT(I,KP)*D2CDT2(I,KP))
215   CONTINUE
!   THE TRANSMISSION FUNCTIONS USED IN SPA88 MAY BE COMPUTED NOW.
!---(IN THE 250 LOOP,DIFT REALLY SHOULD BE (I,1,K), BUT DIFT IS
!    INVARIANT WITH RESPECT TO K,KP,AND SO (I,1,K)=(I,K,1))
      DO 250 K=2,LP1
      DO 250 I=MYIS,MYIE
      CO2SP1(I,K)=CO2R1(I,K)+DIFT(I,K)*(DCO2D1(I,K)+HAF*DIFT(I,K)* &
       D2CD21(I,K))
      CO2SP2(I,K)=CO2R2(I,K)+DIFT(I,K)*(DCO2D2(I,K)+HAF*DIFT(I,K)* &
       D2CD22(I,K))
250   CONTINUE
!
!   NEXT THE CASE WHEN K=2...L
      DO 220 K=2,L
      DO 222 KP=K+1,LP1
      DO 222 I=MYIS,MYIE
      DIFT(I,KP)=(TDAV(I,KP)-TDAV(I,K))/ &
                    (TSTDAV(I,KP)-TSTDAV(I,K))
      CO2R(I,KP)=A1(I)*CO251(KP,K)+A2(I)*CO258(KP,K)
      DCO2DT(I,KP)=H1M2*(A1(I)*CDT51(KP,K)+A2(I)*CDT58(KP,K))
      D2CDT2(I,KP)=H1M3*(A1(I)*C2D51(KP,K)+A2(I)*C2D58(KP,K))
      CO21(I,KP,K)=CO2R(I,KP)+DIFT(I,KP)*(DCO2DT(I,KP)+ &
                   HAF*DIFT(I,KP)*D2CDT2(I,KP))
      CO2R(I,KP)=A1(I)*CO251(K,KP)+A2(I)*CO258(K,KP)
      DCO2DT(I,KP)=H1M2*(A1(I)*CDT51(K,KP)+A2(I)*CDT58(K,KP))
      D2CDT2(I,KP)=H1M3*(A1(I)*C2D51(K,KP)+A2(I)*C2D58(K,KP))
      CO21(I,K,KP)=CO2R(I,KP)+DIFT(I,KP)*(DCO2DT(I,KP)+ &
                   HAF*DIFT(I,KP)*D2CDT2(I,KP))
222   CONTINUE
220   CONTINUE
!   FINALLY THE CASE WHEN K=KP,K=2..LP1
      DO 206 K=2,LP1
      DO 206 I=MYIS,MYIE
      DIFT(I,K)=HAF*(VSUM3(I,K)+VSUM3(I,K-1))
      CO2R(I,K)=A1(I)*CO251(K,K)+A2(I)*CO258(K,K)
      DCO2DT(I,K)=H1M2*(A1(I)*CDT51(K,K)+A2(I)*CDT58(K,K))
      D2CDT2(I,K)=H1M3*(A1(I)*C2D51(K,K)+A2(I)*C2D58(K,K))
      CO21(I,K,K)=CO2R(I,K)+DIFT(I,K)*(DCO2DT(I,K)+ &
                   HAF*DIFT(I,K)*D2CDT2(I,K))
206   CONTINUE
!--- WE AREN'T DOING NBL TFS ON THE 100 CM-1 BANDS .
      DO 260 K=1,L
      DO 260 I=MYIS,MYIE
      CO2NBL(I,K)=CO2MR(I,K)+VSUM3(I,K)*(CO2MD(I,K)+HAF* &
       VSUM3(I,K)*CO2M2D(I,K))
260   CONTINUE
!***COMPUTE TEMP. COEFFICIENT BASED ON T(K) (SEE REF.2)
      DO 264 K=1,LP1
      DO 264 I=MYIS,MYIE
      IF (T(I,K).LE.H25E2) THEN
         TLSQU(I,K)=B0+(T(I,K)-H25E2)* &
                            (B1+(T(I,K)-H25E2)* &
                         (B2+B3*(T(I,K)-H25E2)))
      ELSE
         TLSQU(I,K)=B0
      ENDIF
264   CONTINUE
!***APPLY TO ALL CO2 TFS
      DO 280 K=1,LP1
      DO 282 KP=1,LP1
      DO 282 I=MYIS,MYIE
      CO21(I,KP,K)=CO21(I,KP,K)*(ONE-TLSQU(I,KP))+TLSQU(I,KP)
282   CONTINUE
280   CONTINUE
      DO 284 K=1,LP1
      DO 286 I=MYIS,MYIE
      CO2SP1(I,K)=CO2SP1(I,K)*(ONE-TLSQU(I,1))+TLSQU(I,1)
      CO2SP2(I,K)=CO2SP2(I,K)*(ONE-TLSQU(I,1))+TLSQU(I,1)
286   CONTINUE
284   CONTINUE
      DO 288 K=1,L
      DO 290 I=MYIS,MYIE
      CO2NBL(I,K)=CO2NBL(I,K)*(ONE-TLSQU(I,K))+TLSQU(I,K)
290   CONTINUE
288   CONTINUE
!     CALL FST88(HEATRA,GRNFLX,TOPFLX, &
!                QH2O,PRESS,P,DELP,DELP2,TEMP,T, &
!                CLDFAC,NCLDS,KTOP,KBTM,CAMT, &
!                CO21,CO2NBL,CO2SP1,CO2SP2, &
!                VAR1,VAR2,VAR3,VAR4,CNTVAL, &
!                TOTO3,TPHIO3,TOTPHI,TOTVO2, &
!                EMX1,EMX2,EMPL, &
!
!                BO3RND,AO3RND, &
!!               T1,T2,T4 , EM1V,EM1VW, EM3V, &
!                APCM,BPCM,ATPCM,BTPCM,ACOMB,BCOMB,BETACM,     &
!                TEN,HP1,HAF,ONE,FOUR,HM1EZ,SKO3R, &
!                AB15WD,SKC1R,RADCON,QUARTR,TWO, &
!                HM6666M2,HMP66667,HMP5, &
!                HP166666,H41666M2,RADCON1, &
!                H16E1, H28E1, H25E2, H44194M2,H1P41819, &
!                SKO2D,                                        &
!                ids,ide, jds,jde, kds,kde,                    &
!                ims,ime, jms,jme, kms,kme,                    &
!                its,ite, jts,jte, kts,kte                     )

      CALL FST88(HEATRA,GRNFLX,TOPFLX, &
                 QH2O,PRESS,P,DELP,DELP2,TEMP,T, &
                 CLDFAC,NCLDS,KTOP,KBTM,CAMT, &
                 CO21,CO2NBL,CO2SP1,CO2SP2, &
                 VAR1,VAR2,VAR3,VAR4,CNTVAL, &
                 TOTO3,TPHIO3,TOTPHI,TOTVO2, &
                 EMX1,EMX2,EMPL, &
!
                 BO3RND,AO3RND, &
!                T1,T2,T4 , EM1V,EM1VW, EM3V, &
                 APCM,BPCM,ATPCM,BTPCM,ACOMB,BCOMB,BETACM,     &
                 TEN,HP1,HAF,ONE,FOUR,HM1EZ,       &
                 RADCON,QUARTR,TWO,  &
                 HM6666M2,HMP66667,HMP5, &
                 HP166666,H41666M2,RADCON1, &
                 H16E1, H28E1, H25E2, H44194M2,H1P41819, &
                 ids,ide, jds,jde, kds,kde,                    &
                 ims,ime, jms,jme, kms,kme,                    &
                 its,ite, jts,jte, kts,kte,Jndx                 )

  END SUBROUTINE LWR88
!---------------------------------------------------------------------
! SUBROUTINE FST88(HEATRA,GRNFLX,TOPFLX, &
!                      QH2O,PRESS,P,DELP,DELP2,TEMP,T, &
!                      CLDFAC,NCLDS,KTOP,KBTM,CAMT, &
!                      CO21,CO2NBL,CO2SP1,CO2SP2, &
!                      VAR1,VAR2,VAR3,VAR4,CNTVAL, &
!                      TOTO3,TPHIO3,TOTPHI,TOTVO2, &
!                      EMX1,EMX2,EMPL, &
!                      BO3RND,AO3RND, &
!!                     T1,T2,T4 , EM1V,EM1VW, EM3V, &
!                      APCM,BPCM,ATPCM,BTPCM,ACOMB,BCOMB,BETACM,     &
!                      TEN,HP1,HAF,ONE,FOUR,HM1EZ,SKO3R, &
!                      AB15WD,SKC1R,RADCON,QUARTR,TWO, &
!                      HM6666M2,HMP66667,HMP5, &
!                      HP166666,H41666M2,RADCON1, &
!                      H16E1, H28E1, H25E2, H44194M2,H1P41819, &
!                      SKO2D,                                        &
!                      ids,ide, jds,jde, kds,kde,                    &
!                      ims,ime, jms,jme, kms,kme,                    &
!                      its,ite, jts,jte, kts,kte                     )

  SUBROUTINE FST88(HEATRA,GRNFLX,TOPFLX, &
                       QH2O,PRESS,P,DELP,DELP2,TEMP,T, &
                       CLDFAC,NCLDS,KTOP,KBTM,CAMT, &
                       CO21,CO2NBL,CO2SP1,CO2SP2, &
                       VAR1,VAR2,VAR3,VAR4,CNTVAL, &
                       TOTO3,TPHIO3,TOTPHI,TOTVO2, &
                       EMX1,EMX2,EMPL, &
                       BO3RND,AO3RND, &
!                      T1,T2,T4 , EM1V,EM1VW, EM3V, &
                       APCM,BPCM,ATPCM,BTPCM,ACOMB,BCOMB,BETACM,     &
                       TEN,HP1,HAF,ONE,FOUR,HM1EZ,       &
                       RADCON,QUARTR,TWO, &
                       HM6666M2,HMP66667,HMP5, &
                       HP166666,H41666M2,RADCON1, &
                       H16E1, H28E1, H25E2, H44194M2,H1P41819, &
                       ids,ide, jds,jde, kds,kde,                    &
                       ims,ime, jms,jme, kms,kme,                    &
                       its,ite, jts,jte, kts,kte,Jndx                )
!---------------------------------------------------------------------
 IMPLICIT NONE
!----------------------------------------------------------------------
!     INTEGER, PARAMETER :: NBLY=15

      INTEGER, INTENT(IN)        :: ids,ide, jds,jde, kds,kde ,      &
                                    ims,ime, jms,jme, kms,kme ,      &
                                    its,ite, jts,jte, kts,kte ,Jndx

!     REAL,    INTENT(IN)        :: TEN,HP1,HAF,ONE,FOUR,HM1EZ,SKO3R
      REAL,    INTENT(IN)        :: TEN,HP1,HAF,ONE,FOUR,HM1EZ
!     REAL,    INTENT(IN)        :: AB15WD,SKC1R,RADCON,QUARTR,TWO
      REAL,    INTENT(IN)        :: RADCON,QUARTR,TWO
      REAL,    INTENT(IN)        :: HM6666M2,HMP66667,HMP5
      REAL,    INTENT(IN)        :: HP166666,H41666M2,RADCON1,H16E1, H28E1 
!     REAL,    INTENT(IN)        :: H25E2,H44194M2,H1P41819,SKO2D
      REAL,    INTENT(IN)        :: H25E2,H44194M2,H1P41819

      REAL,INTENT(IN),DIMENSION(NBLY) :: APCM,BPCM,ATPCM,BTPCM,ACOMB, &
                                         BCOMB,BETACM

!     REAL, INTENT(IN), DIMENSION(5040) :: T1,T2,T4,EM1V,EM1VW
!     REAL, INTENT(IN), DIMENSION(5040) :: EM3V
      REAL, INTENT(IN), DIMENSION(its:ite,kts:kte*2+1) :: EMPL
      REAL, INTENT(IN), DIMENSION(its:ite,kts:kte+1) :: TOTO3,TPHIO3,TOTPHI,CNTVAL,&
                                                        CO2SP1,CO2SP2   

      REAL,    INTENT(IN),DIMENSION(its:ite,kts:kte+1,kts:kte+1) :: CLDFAC
      REAL,    INTENT(IN), DIMENSION(its:ite,kts:kte+1) :: CAMT,TOTVO2
      INTEGER, INTENT(IN), DIMENSION(its:ite,kts:kte+1) :: KBTM,KTOP
      INTEGER, INTENT(IN), DIMENSION(its:ite)           :: NCLDS
      REAL,    INTENT(IN), DIMENSION(its:ite,kts:kte)   :: QH2O
      REAL,    INTENT(IN), DIMENSION(its:ite,kts:kte+1) :: PRESS,TEMP
      REAL,    INTENT(OUT), DIMENSION(its:ite,kts:kte)  :: HEATRA
      REAL,    INTENT(OUT), DIMENSION(its:ite)          :: GRNFLX,TOPFLX
      REAL,    INTENT(IN), DIMENSION(its:ite,kts:kte+1) :: P,T
      REAL,    INTENT(INOUT), DIMENSION(its:ite,kts:kte+1,kts:kte+1) :: CO21
      REAL,    INTENT(IN), DIMENSION(its:ite,kts:kte)   :: CO2NBL,DELP2, &
                                                           DELP,&
                                               VAR1,VAR2,VAR3,VAR4
      REAL, INTENT(IN), DIMENSION(3) :: BO3RND,AO3RND
      REAL, INTENT(IN), DIMENSION(its:ite)   :: EMX1,EMX2
      
      REAL, DIMENSION(its:ite,kts:kte*2+1) :: TPL,EMD,ALP,C,CSUB,CSUB2
      REAL, DIMENSION(its:ite,kts:kte*2+1) :: C2
      INTEGER, DIMENSION(its:ite,kts:kte+1) :: IXO
      REAL, DIMENSION(its:ite,kts:kte+1) :: VTMP3,FXO,DT,FXOE2,DTE2, &
                                            SS1,CSOUR,TC,OSS,CSS,DTC,SS2,&
                                            AVEPHI,E1CTS1,E1FLX,  &
                                            E1CTW1,DSORC,EMISS,FAC1,&
                                            TO3SP,OVER1D,CNTTAU,TOTEVV,&
                                            CO2SP,FLX,AVMO3, &
                                            AVPHO3,AVVO2,CONT1D,TO31D,EMISDG,&
                                            DELPR1
      REAL, DIMENSION(its:ite,kts:kte+1) :: EMISSB,DELPR2,CONTDG,TO3DG,HEATEM,&
                                            VSUM1,FLXNET,Z1

      REAL, DIMENSION(its:ite,kts:kte+1,NBLY) :: SORC
      REAL, DIMENSION(its:ite,kts:kte)   :: E1CTS2,E1CTW2,TO3SPC,RLOG,EXCTS,&
                                            CTSO3,CTS
      REAL, DIMENSION(its:ite)   :: GXCTS,FLX1E1
      REAL, DIMENSION(its:ite)   :: PTOP,PBOT,FTOP,FBOT,DELPTC
      REAL, DIMENSION(its:ite,2) :: FXOSP,DTSP,EMSPEC
!     REAL, DIMENSION(28,NBLY) :: SOURCE,DSRCE
      INTEGER :: K, I,KP,LLM2,J1,J3,KMAX,KMIN,KCLDS,ICNT,LLM1
      INTEGER :: L,LP1,LP2,LP3,LM1,LM2,LM3,MYIS,MYIE,LLP1,LL,KK,KLEN

      L=kte
      LP1=L+1;  LP2=L+2;  LP3=L+3; LLP1 = 2*L + 1
      LM1=L-1;  LM2=L-2;  LM3=L-3; LL = 2*L
      LLM2 = LL-2; LLM1=LL-1
      MYIS=its; MYIE=ite

!
      DO 101 K=1,LP1
      DO 101 I=MYIS,MYIE
!---TEMP. INDICES FOR E1,SOURCE
      VTMP3(I,K)=AINT(TEMP(I,K)*HP1)
      FXO(I,K)=VTMP3(I,K)-9.
      DT(I,K)=TEMP(I,K)-TEN*VTMP3(I,K)
!---INTEGER INDEX FOR SOURCE (USED IMMEDIATELY)
      IXO(I,K)=FXO(I,K)
101   CONTINUE
      DO 103 k=1,L
      DO 103 I=MYIS,MYIE
!---TEMP. INDICES FOR E2 (KP=1 LAYER NOT USED IN FLUX CALCULATIONS)
      VTMP3(I,K)=AINT(T(I,K+1)*HP1)
      FXOE2(I,K)=VTMP3(I,K)-9.
      DTE2(I,K)=T(I,K+1)-TEN*VTMP3(I,K)
103   CONTINUE
!---SPECIAL CASE TO HANDLE KP=LP1 LAYER AND SPECIAL E2 CALCS.
      DO 105 I=MYIS,MYIE
      FXOE2(I,LP1)=FXO(I,L)
      DTE2(I,LP1)=DT(I,L)
      FXOSP(I,1)=FXOE2(I,LM1)
      FXOSP(I,2)=FXO(I,LM1)
      DTSP(I,1)=DTE2(I,LM1)
      DTSP(I,2)=DT(I,LM1)
105   CONTINUE
!
!---SOURCE FUNCTION FOR COMBINED BAND 1
      DO 4114 I=MYIS,MYIE
      DO 4114 K=1,LP1
        VTMP3(I,K)=SOURCE(IXO(I,K),1)
        DSORC(I,K)=DSRCE(IXO(I,K),1)
4114   CONTINUE
      DO 4112 K=1,LP1
      DO 4112 I=MYIS,MYIE
      SORC(I,K,1)=VTMP3(I,K)+DT(I,K)*DSORC(I,K)
4112   CONTINUE
!---SOURCE FUNCTION FOR COMBINED BAND 2
      DO 4214 I=MYIS,MYIE
      DO 4214 K=1,LP1
        VTMP3(I,K)=SOURCE(IXO(I,K),2)
        DSORC(I,K)=DSRCE(IXO(I,K),2)
4214   CONTINUE
      DO 4212 K=1,LP1
      DO 4212 I=MYIS,MYIE
      SORC(I,K,2)=VTMP3(I,K)+DT(I,K)*DSORC(I,K)
4212   CONTINUE
!---SOURCE FUNCTION FOR COMBINED BAND 3
      DO 4314 I=MYIS,MYIE
      DO 4314 K=1,LP1
        VTMP3(I,K)=SOURCE(IXO(I,K),3)
        DSORC(I,K)=DSRCE(IXO(I,K),3)
4314   CONTINUE
      DO 4312 K=1,LP1
      DO 4312 I=MYIS,MYIE
      SORC(I,K,3)=VTMP3(I,K)+DT(I,K)*DSORC(I,K)
4312   CONTINUE
!---SOURCE FUNCTION FOR COMBINED BAND 4
      DO 4414 I=MYIS,MYIE
      DO 4414 K=1,LP1
        VTMP3(I,K)=SOURCE(IXO(I,K),4)
        DSORC(I,K)=DSRCE(IXO(I,K),4)
4414   CONTINUE
      DO 4412 K=1,LP1
      DO 4412 I=MYIS,MYIE
      SORC(I,K,4)=VTMP3(I,K)+DT(I,K)*DSORC(I,K)
4412   CONTINUE
!---SOURCE FUNCTION FOR COMBINED BAND 5
      DO 4514 I=MYIS,MYIE
      DO 4514 K=1,LP1
        VTMP3(I,K)=SOURCE(IXO(I,K),5)
        DSORC(I,K)=DSRCE(IXO(I,K),5)
4514   CONTINUE
      DO 4512 K=1,LP1
      DO 4512 I=MYIS,MYIE
      SORC(I,K,5)=VTMP3(I,K)+DT(I,K)*DSORC(I,K)
4512   CONTINUE
!---SOURCE FUNCTION FOR COMBINED BAND 6
      DO 4614 I=MYIS,MYIE
      DO 4614 K=1,LP1
        VTMP3(I,K)=SOURCE(IXO(I,K),6)
        DSORC(I,K)=DSRCE(IXO(I,K),6)
4614   CONTINUE
      DO 4612 K=1,LP1
      DO 4612 I=MYIS,MYIE
      SORC(I,K,6)=VTMP3(I,K)+DT(I,K)*DSORC(I,K)
4612   CONTINUE
!---SOURCE FUNCTION FOR COMBINED BAND 7
      DO 4714 I=MYIS,MYIE
      DO 4714 K=1,LP1
        VTMP3(I,K)=SOURCE(IXO(I,K),7)
        DSORC(I,K)=DSRCE(IXO(I,K),7)
4714   CONTINUE
      DO 4712 K=1,LP1
      DO 4712 I=MYIS,MYIE
      SORC(I,K,7)=VTMP3(I,K)+DT(I,K)*DSORC(I,K)
4712   CONTINUE
!---SOURCE FUNCTION FOR COMBINED BAND 8
      DO 4814 I=MYIS,MYIE
      DO 4814 K=1,LP1
        VTMP3(I,K)=SOURCE(IXO(I,K),8)
        DSORC(I,K)=DSRCE(IXO(I,K),8)
4814   CONTINUE
      DO 4812 K=1,LP1
      DO 4812 I=MYIS,MYIE
      SORC(I,K,8)=VTMP3(I,K)+DT(I,K)*DSORC(I,K)
4812   CONTINUE
!---SOURCE FUNCTION FOR BAND 9 (560-670 CM-1)
      DO 4914 I=MYIS,MYIE
      DO 4914 K=1,LP1
        VTMP3(I,K)=SOURCE(IXO(I,K),9)
        DSORC(I,K)=DSRCE(IXO(I,K),9)
4914   CONTINUE
      DO 4912 K=1,LP1
      DO 4912 I=MYIS,MYIE
      SORC(I,K,9)=VTMP3(I,K)+DT(I,K)*DSORC(I,K)
4912   CONTINUE
!---SOURCE FUNCTION FOR BAND 10 (670-800 CM-1)
      DO 5014 I=MYIS,MYIE
      DO 5014 K=1,LP1
        VTMP3(I,K)=SOURCE(IXO(I,K),10)
        DSORC(I,K)=DSRCE(IXO(I,K),10)
5014  CONTINUE
      DO 5012 K=1,LP1
      DO 5012 I=MYIS,MYIE
      SORC(I,K,10)=VTMP3(I,K)+DT(I,K)*DSORC(I,K)
5012   CONTINUE
!---SOURCE FUNCTION FOR BAND 11 (800-900 CM-1)
      DO 5114 I=MYIS,MYIE
      DO 5114 K=1,LP1
        VTMP3(I,K)=SOURCE(IXO(I,K),11)
        DSORC(I,K)=DSRCE(IXO(I,K),11)
5114   CONTINUE
      DO 5112 K=1,LP1
      DO 5112 I=MYIS,MYIE
      SORC(I,K,11)=VTMP3(I,K)+DT(I,K)*DSORC(I,K)
5112   CONTINUE
!---SOURCE FUNCTION FOR BAND 12 (900-990 CM-1)
      DO 5214 I=MYIS,MYIE
      DO 5214 K=1,LP1
        VTMP3(I,K)=SOURCE(IXO(I,K),12)
        DSORC(I,K)=DSRCE(IXO(I,K),12)
5214   CONTINUE
      DO 5212 K=1,LP1
      DO 5212 I=MYIS,MYIE
      SORC(I,K,12)=VTMP3(I,K)+DT(I,K)*DSORC(I,K)
5212   CONTINUE
!---SOURCE FUNCTION FOR BAND 13 (990-1070 CM-1)
      DO 5314 I=MYIS,MYIE
      DO 5314 K=1,LP1
        VTMP3(I,K)=SOURCE(IXO(I,K),13)
        DSORC(I,K)=DSRCE(IXO(I,K),13)
5314   CONTINUE
      DO 5312 K=1,LP1
      DO 5312 I=MYIS,MYIE
      SORC(I,K,13)=VTMP3(I,K)+DT(I,K)*DSORC(I,K)
5312   CONTINUE
!---SOURCE FUNCTION FOR BAND 14 (1070-1200 CM-1)
      DO 5414 I=MYIS,MYIE
      DO 5414 K=1,LP1
        VTMP3(I,K)=SOURCE(IXO(I,K),14)
        DSORC(I,K)=DSRCE(IXO(I,K),14)
5414   CONTINUE
      DO 5412 K=1,LP1
      DO 5412 I=MYIS,MYIE
      SORC(I,K,14)=VTMP3(I,K)+DT(I,K)*DSORC(I,K)
5412   CONTINUE
!
!        THE FOLLOWING SUBROUTINE OBTAINS NLTE SOURCE FUNCTION FOR CO2
!
!
!     CALL NLTE
!
!
!---OBTAIN SPECIAL SOURCE FUNCTIONS FOR THE 15 UM BAND (CSOUR)
!   AND THE WINDOW REGION (SS1)
      DO 131 K=1,LP1
      DO 131 I=MYIS,MYIE
      SS1(I,K)=SORC(I,K,11)+SORC(I,K,12)+SORC(I,K,14)
131   CONTINUE
      DO 143 K=1,LP1
      DO 143 I=MYIS,MYIE
      CSOUR(I,K)=SORC(I,K,9)+SORC(I,K,10)
143   CONTINUE
!
!---COMPUTE TEMP**4 (TC) AND VERTICAL TEMPERATURE DIFFERENCES
!   (OSS,CSS,SS2,DTC). ALL THESE WILL BE USED LATER IN FLUX COMPUTA-
!   TIONS.
!
      DO 901 K=1,LP1
      DO 901 I=MYIS,MYIE
      TC(I,K)=TEMP(I,K)*TEMP(I,K)*TEMP(I,K)*TEMP(I,K)
901   CONTINUE
      DO 903 K=1,L
      DO 903 I=MYIS,MYIE
      OSS(I,K+1)=SORC(I,K+1,13)-SORC(I,K,13)
      CSS(I,K+1)=CSOUR(I,K+1)-CSOUR(I,K)
      DTC(I,K+1)=TC(I,K+1)-TC(I,K)
      SS2(I,K+1)=SS1(I,K+1)-SS1(I,K)
903   CONTINUE
!
!
!---THE FOLLOWIMG IS A DRASTIC REWRITE OF THE RADIATION CODE TO
!    (LARGELY) ELIMINATE THREE-DIMENSIONAL ARRAYS. THE CODE WORKS
!    ON THE FOLLOWING PRINCIPLES:
!
!          LET K = FIXED FLUX LEVEL, KP = VARYING FLUX LEVEL
!          THEN FLUX(K)=SUM OVER KP : (DELTAB(KP)*TAU(KP,K))
!               OVER ALL KP'S, FROM 1 TO LP1.
!
!          WE CAN BREAK DOWN THE CALCULATIONS FOR ALL K'S AS FOLLOWS:
!
!          FOR ALL K'S K=1 TO LP1:
!              FLUX(K)=SUM OVER KP : (DELTAB(KP)*TAU(KP,K))  (1)
!                      OVER ALL KP'S, FROM K+1 TO LP1
!          AND
!              FOR KP FROM K+1 TO LP1:
!                 FLUX(KP) = DELTAB(K)*TAU(K,KP)              (2)
!
!          NOW IF TAU(K,KP)=TAU(KP,K) (SYMMETRICAL ARRAYS)
!          WE CAN COMPUTE A 1-DIMENSIONAL ARRAY TAU1D(KP) FROM
!          K+1 TO LP1, EACH TIME K IS INCREMENTED.
!          EQUATIONS (1) AND (2) THEN BECOME:
!
!             TAU1D(KP) = (VALUES FOR TAU(KP,K) AT THE PARTICULAR K)
!             FLUX(K) = SUM OVER KP : (DELTAB(KP)*TAU1D(KP))   (3)
!             FLUX(KP) = DELTAB(K)*TAU1D(KP)                   (4)
!
!         THE TERMS FOR TAU (K,K) AND OTHER SPECIAL TERMS (FOR
!         NEARBY LAYERS) MUST, OF COURSE, BE HANDLED SEPARATELY, AND
!         WITH CARE.
!
!      COMPUTE "UPPER TRIANGLE" TRANSMISSION FUNCTIONS FOR
!      THE 9.6 UM BAND (TO3SP) AND THE 15 UM BAND (OVER1D). ALSO,
!      THE
!      STAGE 1...COMPUTE O3 ,OVER TRANSMISSION FCTNS AND AVEPHI
!---DO K=1 CALCULATION (FROM FLUX LAYER KK TO THE TOP) SEPARATELY
!   AS VECTORIZATION IS IMPROVED,AND OZONE CTS TRANSMISSIVITY
!   MAY BE EXTRACTED HERE.
      DO 3021 K=1,L
      DO 3021 I=MYIS,MYIE
      AVEPHI(I,K)=TOTPHI(I,K+1)
3021  CONTINUE
!---IN ORDER TO PROPERLY EVALUATE EMISS INTEGRATED OVER THE (LP1)
!   LAYER, A SPECIAL EVALUATION OF EMISS IS DONE. THIS REQUIRES
!   A SPECIAL COMPUTATION OF AVEPHI, AND IT IS STORED IN THE
!   (OTHERWISE VACANT) LP1'TH POSITION
!
      DO 803 I=MYIS,MYIE
      AVEPHI(I,LP1)=AVEPHI(I,LM1)+EMX1(I)
803   CONTINUE
!   COMPUTE FLUXES FOR K=1
      CALL E1E290(E1CTS1,E1CTS2,E1FLX,E1CTW1,E1CTW2,EMISS, &
                  FXO,DT,FXOE2,DTE2,AVEPHI,TEMP,T,         &
!                 T1,T2,T4 ,EM1V,EM1VW,                    &
                  H16E1,TEN,HP1,H28E1,HAF,                 &
                  ids,ide, jds,jde, kds,kde,               &
                  ims,ime, jms,jme, kms,kme,               &
                  its,ite, jts,jte, kts,kte                )

      DO 302 K=1,L
      DO 302 I=MYIS,MYIE
      FAC1(I,K)=BO3RND(2)*TPHIO3(I,K+1)/TOTO3(I,K+1)
      TO3SPC(I,K)=HAF*(FAC1(I,K)* &
          (SQRT(ONE+(FOUR*AO3RND(2)*TOTO3(I,K+1))/FAC1(I,K))-ONE))
!   FOR K=1, TO3SP IS USED INSTEAD OF TO31D (THEY ARE EQUAL IN THIS
!   CASE); TO3SP IS PASSED TO SPA90, WHILE TO31D IS A WORK-ARRAY.
      TO3SP(I,K)=EXP(HM1EZ*(TO3SPC(I,K)+SKO3R*TOTVO2(I,K+1)))
      OVER1D(I,K)=EXP(HM1EZ*(SQRT(AB15WD*TOTPHI(I,K+1))+ &
                  SKC1R*TOTVO2(I,K+1)))
!---BECAUSE ALL CONTINUUM TRANSMISSIVITIES ARE OBTAINED FROM THE
!  2-D QUANTITY CNTTAU (AND ITS RECIPROCAL TOTEVV) WE STORE BOTH
!  OF THESE HERE. FOR K=1, CONT1D EQUALS CNTTAU
      CNTTAU(I,K)=EXP(HM1EZ*TOTVO2(I,K+1))
      TOTEVV(I,K)=1./CNTTAU(I,K)
302   CONTINUE
      DO 3022 K=1,L
      DO 3022 I=MYIS,MYIE
      CO2SP(I,K+1)=OVER1D(I,K)*CO21(I,1,K+1)
3022  CONTINUE
      DO 3023 K=1,L
      DO 3023 I=MYIS,MYIE
      CO21(I,K+1,1)=CO21(I,K+1,1)*OVER1D(I,K)
3023  CONTINUE
!---RLOG IS THE NBL AMOUNT FOR THE 15 UM BAND CALCULATION
      DO 1808 I=MYIS,MYIE
      RLOG(I,1)=OVER1D(I,1)*CO2NBL(I,1)
1808  CONTINUE
!---THE TERMS WHEN KP=1 FOR ALL K ARE THE PHOTON EXCHANGE WITH
!   THE TOP OF THE ATMOSPHERE, AND ARE OBTAINED DIFFERENTLY THAN
!   THE OTHER CALCULATIONS
      DO 305 K=2,LP1
      DO 305 I=MYIS,MYIE
      FLX(I,K)= (TC(I,1)*E1FLX(I,K) &
                +SS1(I,1)*CNTTAU(I,K-1) &
                +SORC(I,1,13)*TO3SP(I,K-1) &
                +CSOUR(I,1)*CO2SP(I,K)) &
                *CLDFAC(I,1,K)

	if (I .eq. 50 .and. K .eq. 10) then
!	write(0,*) 'E1FLX(I,K), FLX(I,K): ', E1FLX(I,K), FLX(I,K)
	endif
305   CONTINUE
      DO 307 I=MYIS,MYIE
      FLX(I,1)= TC(I,1)*E1FLX(I,1)+SS1(I,1)+SORC(I,1,13) &
                +CSOUR(I,1)
307   CONTINUE
!---THE KP TERMS FOR K=1...
      DO 303 KP=2,LP1
      DO 303 I=MYIS,MYIE
      FLX(I,1)=FLX(I,1)+(OSS(I,KP)*TO3SP(I,KP-1) &
                        +SS2(I,KP)*CNTTAU(I,KP-1) &
                        +CSS(I,KP)*CO21(I,KP,1) &
                        +DTC(I,KP)*EMISS(I,KP-1))*CLDFAC(I,KP,1)
303   CONTINUE
!          SUBROUTINE SPA88 IS CALLED TO OBTAIN EXACT CTS FOR WATER
!     CO2 AND O3, AND APPROXIMATE CTS CO2 AND O3 CALCULATIONS.
!
      CALL SPA88(EXCTS,CTSO3,GXCTS,SORC,CSOUR, &
                 CLDFAC,TEMP,PRESS,VAR1,VAR2, &
                 P,DELP,DELP2,TOTVO2,TO3SP,TO3SPC, &
                 CO2SP1,CO2SP2,CO2SP,              &
                 APCM,BPCM,ATPCM,BTPCM,ACOMB,BCOMB,BETACM,     &
                 H25E2,ONE,H44194M2,H1P41819,HAF,HM1EZ,TWO,    &
!                SKO2D,RADCON,                                 &
                 RADCON,                                 &
                 ids,ide, jds,jde, kds,kde,                    &
                 ims,ime, jms,jme, kms,kme,                    &
                 its,ite, jts,jte, kts,kte                     )

!
!    THIS SECTION COMPUTES THE EMISSIVITY CTS HEATING RATES FOR 2
!    EMISSIVITY BANDS: THE 0-160,1200-2200 CM-1 BAND AND THE 800-
!    990,1070-1200 CM-1 BAND. THE REMAINING CTS COMTRIBUTIONS ARE
!    CONTAINED IN CTSO3, COMPUTED IN SPA88.
!
      DO 998 I=MYIS,MYIE
      VTMP3(I,1)=1.
998   CONTINUE
      DO 999 K=1,L
      DO 999 I=MYIS,MYIE
      VTMP3(I,K+1)=CNTTAU(I,K)*CLDFAC(I,K+1,1)
999   CONTINUE
      DO 1001 K=1,L
      DO 1001 I=MYIS,MYIE
      CTS(I,K)=RADCON*DELP(I,K)*(TC(I,K)* &
           (E1CTW2(I,K)*CLDFAC(I,K+1,1)-E1CTW1(I,K)*CLDFAC(I,K,1)) + &
            SS1(I,K)*(VTMP3(I,K+1)-VTMP3(I,K)))
1001  CONTINUE
!
      DO 1011 K=1,L
      DO 1011 I=MYIS,MYIE
      VTMP3(I,K)=TC(I,K)*(CLDFAC(I,K,1)*(E1CTS1(I,K)-E1CTW1(I,K)) - &
                        CLDFAC(I,K+1,1)*(E1CTS2(I,K)-E1CTW2(I,K)))
1011  CONTINUE
      DO 1012 I=MYIS,MYIE
      FLX1E1(I)=TC(I,LP1)*CLDFAC(I,LP1,1)* &
                (E1CTS1(I,LP1)-E1CTW1(I,LP1))
1012  CONTINUE
      DO 1014 K=1,L
      DO 1013 I=MYIS,MYIE
      FLX1E1(I)=FLX1E1(I)+VTMP3(I,K)
1013  CONTINUE
1014  CONTINUE
!
!---NOW REPEAT FLUX CALCULATIONS FOR THE K=2..LM1  CASES.
!   CALCULATIONS FOR FLUX LEVEL L AND LP1 ARE DONE SEPARATELY, AS ALL
!   EMISSIVITY AND CO2 CALCULATIONS ARE SPECIAL CASES OR NEARBY LAYERS.
!
      DO 321 K=2,LM1
      KLEN=K
!
      DO 3218 KK=1,LP1-K
      DO 3218 I=MYIS,MYIE
      AVEPHI(I,KK+K-1)=TOTPHI(I,KK+K)-TOTPHI(I,K)
3218  CONTINUE
      DO 1803 I=MYIS,MYIE
      AVEPHI(I,LP1)=AVEPHI(I,LM1)+EMX1(I)
1803   CONTINUE
!---COMPUTE EMISSIVITY FLUXES (E2) FOR THIS CASE. NOTE THAT
!   WE HAVE OMITTED THE NEARBY LATER CASE (EMISS(I,K,K)) AS WELL
!   AS ALL CASES WITH K=L OR LP1. BUT THESE CASES HAVE ALWAYS
!   BEEN HANDLED AS SPECIAL CASES, SO WE MAY AS WELL COMPUTE
!    THEIR FLUXES SEPARASTELY.
!
      CALL E290(EMISSB,EMISS,AVEPHI,KLEN,FXOE2,DTE2,  &
!                      T1,T2,T4,                      &
                       H16E1,HP1,H28E1,HAF,TEN,       &
                       ids,ide, jds,jde, kds,kde,     &
                       ims,ime, jms,jme, kms,kme,     &
                       its,ite, jts,jte, kts,kte      )

      DO 322 KK=1,LP1-K
      DO 322 I=MYIS,MYIE
      AVMO3(I,KK+K-1)=TOTO3(I,KK+K)-TOTO3(I,K)
      AVPHO3(I,KK+K-1)=TPHIO3(I,KK+K)-TPHIO3(I,K)
      AVVO2(I,KK+K-1)=TOTVO2(I,KK+K)-TOTVO2(I,K)
      CONT1D(I,KK+K-1)=CNTTAU(I,KK+K-1)*TOTEVV(I,K-1)
322   CONTINUE
!
      DO 3221 KK=1,LP1-K
      DO 3221 I=MYIS,MYIE
      FAC1(I,K+KK-1)=BO3RND(2)*AVPHO3(I,K+KK-1)/AVMO3(I,K+KK-1)
      VTMP3(I,K+KK-1)=HAF*(FAC1(I,K+KK-1)* &
        (SQRT(ONE+(FOUR*AO3RND(2)*AVMO3(I,K+KK-1))/ &
         FAC1(I,K+KK-1))-ONE))
      TO31D(I,K+KK-1)=EXP(HM1EZ*(VTMP3(I,K+KK-1) &
                         +SKO3R*AVVO2(I,K+KK-1)))
      OVER1D(I,K+KK-1)=EXP(HM1EZ*(SQRT(AB15WD*AVEPHI(I,K+KK-1))+ &
                  SKC1R*AVVO2(I,K+KK-1)))
      CO21(I,K+KK,K)=OVER1D(I,K+KK-1)*CO21(I,K+KK,K)
3221  CONTINUE
      DO 3223 KP=K+1,LP1
      DO 3223 I=MYIS,MYIE
      CO21(I,K,KP)=OVER1D(I,KP-1)*CO21(I,K,KP)
3223  CONTINUE
!---RLOG IS THE NBL AMOUNT FOR THE 15 UM BAND CALCULATION
      DO 1804 I=MYIS,MYIE
      RLOG(I,K)=OVER1D(I,K)*CO2NBL(I,K)
1804  CONTINUE
!---THE KP TERMS FOR ARBIRRARY K..
      DO 3423 KP=K+1,LP1
      DO 3423 I=MYIS,MYIE
	if (I .eq. 50 .and. K .eq. 10) then
!	write(0,*) 'I,L, FLX(I,K) (c): ', I,K, FLX(I,K)
	endif
      FLX(I,K)=FLX(I,K)+(OSS(I,KP)*TO31D(I,KP-1) &
                        +SS2(I,KP)*CONT1D(I,KP-1) &
                        +CSS(I,KP)*CO21(I,KP,K) &
                        +DTC(I,KP)*EMISS(I,KP-1))*CLDFAC(I,KP,K)
	if (I .eq. 50 .and. K .eq. 10) then
!	write(0,*) 'I,K, FLX(I,K) (d): ', I,K, FLX(I,K)
	endif
3423  CONTINUE
      DO 3425 KP=K+1,LP1
      DO 3425 I=MYIS,MYIE
      FLX(I,KP)=FLX(I,KP)+(OSS(I,K)*TO31D(I,KP-1) &
                         +SS2(I,K)*CONT1D(I,KP-1) &
                         +CSS(I,K)*CO21(I,K,KP) &
                         +DTC(I,K)*EMISSB(I,KP-1))*CLDFAC(I,K,KP)
3425  CONTINUE
321   CONTINUE
!
      DO 821 I=MYIS,MYIE
      TPL(I,1)=TEMP(I,L)
      TPL(I,LP1)=HAF*(T(I,LP1)+TEMP(I,L))
      TPL(I,LLP1)=HAF*(T(I,L)+TEMP(I,L))
821   CONTINUE
      DO 823 K=2,L
      DO 823 I=MYIS,MYIE
      TPL(I,K)=T(I,K)
      TPL(I,K+L)=T(I,K)
823   CONTINUE
!
!---E2 FUNCTIONS ARE REQUIRED IN THE NBL CALCULATIONS FOR 2 CASES,
!   DENOTED (IN OLD CODE) AS (L,LP1) AND (LP1,LP1)
      DO 833 I=MYIS,MYIE
      AVEPHI(I,1)=VAR2(I,L)
      AVEPHI(I,2)=VAR2(I,L)+EMPL(I,L)
833   CONTINUE
      CALL E2SPEC(EMISS,AVEPHI,FXOSP,DTSP,                          &
!                     T1,T2,T4, &
                      H16E1,TEN,H28E1,HP1,                          &
                      ids,ide, jds,jde, kds,kde,                    &
                      ims,ime, jms,jme, kms,kme,                    &
                      its,ite, jts,jte, kts,kte                     )

!
!     CALL E3V88 FOR NBL H2O TRANSMISSIVITIES
!          CALL E3V88(EMD,TPL,EMPL,EM3V, &
           CALL E3V88(EMD,TPL,EMPL, &
                      TEN,HP1,H28E1,H16E1,  &
                      ids,ide, jds,jde, kds,kde,                    &
                      ims,ime, jms,jme, kms,kme,                    &
                      its,ite, jts,jte, kts,kte                     )
!
!   COMPUTE NEARBY LAYER AND SPECIAL-CASE TRANSMISSIVITIES FOR EMISS
!    USING METHODS FOR H2O GIVEN IN REF. (4)
      DO 851 K=2,L
      DO 851 I=MYIS,MYIE
	if (I .eq. 50 .and. K .eq. 10) then
!	write(0,*) 'EMD(I,K), EMD(I,K+L): ', EMD(I,K), EMD(I,K+L)
	endif
      EMISDG(I,K)=EMD(I,K+L)+EMD(I,K)
851   CONTINUE
!
!   NOTE THAT EMX1/2 (PRESSURE SCALED PATHS) ARE NOW COMPUTED IN
!   LWR88
      DO 861 I=MYIS,MYIE
      EMSPEC(I,1)=(EMD(I,1)*EMPL(I,1)-EMD(I,LP1)*EMPL(I,LP1))/ &
       EMX1(I) + QUARTR*(EMISS(I,1)+EMISS(I,2))
      EMISDG(I,LP1)=TWO*EMD(I,LP1)
      EMSPEC(I,2)=TWO*(EMD(I,1)*EMPL(I,1)-EMD(I,LLP1)*EMPL(I,LLP1))/ &
       EMX2(I)
861   CONTINUE
      DO 331 I=MYIS,MYIE
      FAC1(I,L)=BO3RND(2)*VAR4(I,L)/VAR3(I,L)
      VTMP3(I,L)=HAF*(FAC1(I,L)* &
          (SQRT(ONE+(FOUR*AO3RND(2)*VAR3(I,L))/FAC1(I,L))-ONE))
      TO31D(I,L)=EXP(HM1EZ*(VTMP3(I,L)+SKO3R*CNTVAL(I,L)))
      OVER1D(I,L)=EXP(HM1EZ*(SQRT(AB15WD*VAR2(I,L))+ &
                  SKC1R*CNTVAL(I,L)))
      CONT1D(I,L)=CNTTAU(I,L)*TOTEVV(I,LM1)
      RLOG(I,L)=OVER1D(I,L)*CO2NBL(I,L)
331   CONTINUE
      DO 618 K=1,L
      DO 618 I=MYIS,MYIE
      RLOG(I,K)=LOG(RLOG(I,K))
618   CONTINUE
      DO 601 K=1,LM1
      DO 601 I=MYIS,MYIE
      DELPR1(I,K+1)=DELP(I,K+1)*(PRESS(I,K+1)-P(I,K+1))
      ALP(I,LP1+K-1)=-SQRT(DELPR1(I,K+1))*RLOG(I,K+1)
601   CONTINUE
      DO 603 K=1,L
      DO 603 I=MYIS,MYIE
      DELPR2(I,K+1)=DELP(I,K)*(P(I,K+1)-PRESS(I,K))
      ALP(I,K)=-SQRT(DELPR2(I,K+1))*RLOG(I,K)
603   CONTINUE
      DO 625 I=MYIS,MYIE
      ALP(I,LL)=-RLOG(I,L)
      ALP(I,LLP1)=-RLOG(I,L)*SQRT(DELP(I,L)*(P(I,LP1)-PRESS(I,LM1)))
625   CONTINUE
!        THE FIRST COMPUTATION IS FOR THE 15 UM BAND,WITH THE
!     FOR THE COMBINED H2O AND CO2 TRANSMISSION FUNCTION.
!
!       PERFORM NBL COMPUTATIONS FOR THE 15 UM BAND
!***THE STATEMENT FUNCTION SF IN PREV. VERSIONS IS NOW EXPLICITLY
!   EVALUATED.
      DO 631 K=1,LLP1
      DO 631 I=MYIS,MYIE
      C(I,K)=ALP(I,K)*(HMP66667+ALP(I,K)*(QUARTR+ALP(I,K)*HM6666M2))
631   CONTINUE
      DO 641 I=MYIS,MYIE
      CO21(I,LP1,LP1)=ONE+C(I,L)
      CO21(I,LP1,L)=ONE+(DELP2(I,L)*C(I,LL)-(PRESS(I,L)-P(I,L))* &
       C(I,LLM1))/(P(I,LP1)-PRESS(I,L))
      CO21(I,L,LP1)=ONE+((P(I,LP1)-PRESS(I,LM1))*C(I,LLP1)- &
       (P(I,LP1)-PRESS(I,L))*C(I,L))/(PRESS(I,L)-PRESS(I,LM1))
641   CONTINUE
      DO 643 K=2,L
      DO 643 I=MYIS,MYIE
      CO21(I,K,K)=ONE+HAF*(C(I,LM1+K)+C(I,K-1))
643   CONTINUE
!
!    COMPUTE NEARBY-LAYER TRANSMISSIVITIES FOR THE O3 BAND AND FOR THE
!    ONE-BAND CONTINUUM BAND (TO3 AND EMISS2). THE SF2 FUNCTION IS
!    USED. THE METHOD IS THE SAME AS DESCRIBED FOR CO2 IN REF (4).
      DO 651 K=1,LM1
      DO 651 I=MYIS,MYIE
      CSUB(I,K+1)=CNTVAL(I,K+1)*DELPR1(I,K+1)
      CSUB(I,LP1+K-1)=CNTVAL(I,K)*DELPR2(I,K+1)
651   CONTINUE
!---THE SF2 FUNCTION IN PREV. VERSIONS IS NOW EXPLICITLY EVALUATED
      DO 655 K=1,LLM2
      DO 655 I=MYIS,MYIE
      CSUB2(I,K+1)=SKO3R*CSUB(I,K+1)
      C(I,K+1)=CSUB(I,K+1)*(HMP5+CSUB(I,K+1)* &
                (HP166666-CSUB(I,K+1)*H41666M2))
      C2(I,K+1)=CSUB2(I,K+1)*(HMP5+CSUB2(I,K+1)* &
                 (HP166666-CSUB2(I,K+1)*H41666M2))
655   CONTINUE
      DO 661 I=MYIS,MYIE
      CONTDG(I,LP1)=1.+C(I,LLM1)
      TO3DG(I,LP1)=1.+C2(I,LLM1)
661   CONTINUE
      DO 663 K=2,L
      DO 663 I=MYIS,MYIE
      CONTDG(I,K)=ONE+HAF*(C(I,K)+C(I,LM1+K))
      TO3DG(I,K)=ONE+HAF*(C2(I,K)+C2(I,LM1+K))
663   CONTINUE
!---NOW OBTAIN FLUXES
!
!    FOR THE DIAGONAL TERMS...
      DO 871 K=2,LP1
      DO 871 I=MYIS,MYIE
	if (I .eq. 50 .and. K .eq. 10) then
!	write(0,*) 'I,L, FLX(I,K) (b): ', I,L, FLX(I,K)
!	write(0,*) 'DTC, EMISDG: ', DTC(I,K), EMISDG(I,K)
!	write(0,*) 'SS2, CONTDG: ', SS2(I,K), CONTDG(I,K)
!	write(0,*) 'OSS, TO3DG: ', OSS(I,K), TO3DG(I,K)
!	write(0,*) 'CSS,CO21,CLDFAC: ', CSS(I,K),CO21(I,K,K),CLDFAC(I,K,K)
	endif
      FLX(I,K)=FLX(I,K)+(DTC(I,K)*EMISDG(I,K) &
                       +SS2(I,K)*CONTDG(I,K) &
                       +OSS(I,K)*TO3DG(I,K) &
                       +CSS(I,K)*CO21(I,K,K))*CLDFAC(I,K,K)
	if (I .eq. 50 .and. K .eq. 10) then
!	write(0,*) 'I,L, FLX(I,K) (bb): ', I,L, FLX(I,K)
	endif
871   CONTINUE
!     FOR THE TWO OFF-DIAGONAL TERMS...
      DO 873 I=MYIS,MYIE
      FLX(I,L)=FLX(I,L)+(CSS(I,LP1)*CO21(I,LP1,L) &
                        +DTC(I,LP1)*EMSPEC(I,2) &
                        +OSS(I,LP1)*TO31D(I,L) &
                        +SS2(I,LP1)*CONT1D(I,L))*CLDFAC(I,LP1,L)
	if (I .eq. 50 .and. L .eq. 10) then
!	write(0,*) 'I,L, FLX(I,L) (e): ', I,L, FLX(I,L)
	endif
      FLX(I,LP1)=FLX(I,LP1)+(CSS(I,L)*CO21(I,L,LP1) &
                            +OSS(I,L)*TO31D(I,L) &
                            +SS2(I,L)*CONT1D(I,L) &
                            +DTC(I,L)*EMSPEC(I,1))*CLDFAC(I,L,LP1)
873   CONTINUE
!
!     FINAL SECTION OBTAINS EMISSIVITY HEATING RATES,
!     TOTAL HEATING RATES AND THE FLUX AT THE GROUND
!
!     .....CALCULATE THE EMISSIVITY HEATING RATES
      DO 1101 K=1,L
      DO 1101 I=MYIS,MYIE
      HEATEM(I,K)=RADCON*(FLX(I,K+1)-FLX(I,K))*DELP(I,K)
	if (I .eq. 50 .and. K .eq. 10) then
!	write(0,*) 'RADCON, FLX(I,K), DELP(I,K): ', RADCON, FLX(I,K), DELP(I,K)
	endif

1101  CONTINUE
!     .....CALCULATE THE TOTAL HEATING RATES
      DO 1103 K=1,L
      DO 1103 I=MYIS,MYIE
      HEATRA(I,K)=HEATEM(I,K)-CTS(I,K)-CTSO3(I,K)+EXCTS(I,K)
	if (I .eq. 50 .and. K .eq. 10) then
!	write(0,*) 'HEATEM(I,K),CTS(I,K),CTSO3(I,K),EXCTS(I,K): ', HEATEM(I,K),CTS(I,K),CTSO3(I,K),EXCTS(I,K)
	endif
1103  CONTINUE
!     .....CALCULATE THE FLUX AT EACH FLUX LEVEL USING THE FLUX AT THE
!    TOP (FLX1E1+GXCTS) AND THE INTEGRAL OF THE HEATING RATES (VSUM1)
      DO 1111 K=1,L
      DO 1111 I=MYIS,MYIE
      VSUM1(I,K)=HEATRA(I,K)*DELP2(I,K)*RADCON1
	if (I .eq. 50 .and. K .eq. 10) then
!	write(0,*) 'HEATRA(I,K),DELP2(I,K),RADCON1: ', HEATRA(I,K),DELP2(I,K),RADCON1
	endif
1111  CONTINUE
      DO 1115 I=MYIS,MYIE
      TOPFLX(I)=FLX1E1(I)+GXCTS(I)
      FLXNET(I,1)=TOPFLX(I)
1115  CONTINUE
!---ONLY THE SURFACE VALUE OF FLUX (GRNFLX) IS NEEDED UNLESS
!    THE THICK CLOUD SECTION IS INVOKED.
      DO 1123 K=2,LP1
      DO 1123 I=MYIS,MYIE
      FLXNET(I,K)=FLXNET(I,K-1)+VSUM1(I,K-1)

	if (I .eq. 50 .and. K .eq. 10) then
!	write(0,*) 'FLXNET(I,K), FLXNET(I,K-1),VSUM1(I,K-1): ', FLXNET(I,K), FLXNET(I,K-1),VSUM1(I,K-1)
	endif

1123  CONTINUE
      DO 1125 I=MYIS,MYIE
      GRNFLX(I)=FLXNET(I,LP1)
	if (I .eq. 50) then
!	write(0,*) 'FLXNET(I,LP1), GRNFLX(I): ', FLXNET(I,LP1), GRNFLX(I)
	endif
1125  CONTINUE
!
!     THIS IS THE THICK CLOUD SECTION.OPTIONALLY,IF THICK CLOUD
!     FLUXES ARE TO BE "CONVECTIVELY ADJUSTED",IE,DF/DP IS CONSTANT,
!     FOR CLOUDY PART OF GRID POINT, THE FOLLOWING CODE IS EXECUTED.
!***FIRST,COUNT THE NUMBER OF CLOUDS ALONG THE LAT. ROW. SKIP THE
!   ENTIRE THICK CLOUD COMPUTATION OF THERE ARE NO CLOUDS.
      ICNT=0
      DO 1301 I=MYIS,MYIE
      ICNT=ICNT+NCLDS(I)
1301  CONTINUE
      IF (ICNT.EQ.0) GO TO 6999
!---FIND THE MAXIMUM NUMBER OF CLOUDS IN THE LATITUDE ROW
      KCLDS=NCLDS(MYIS)
      DO 2106 I=MYIS,MYIE
      KCLDS=MAX(NCLDS(I),KCLDS)
2106  CONTINUE
!
!
!***OBTAIN THE PRESSURES AND FLUXES OF THE TOP AND BOTTOM OF
!   THE NC'TH CLOUD (IT IS ASSUMED THAT ALL KTOP AND KBTM'S HAVE
!   BEEN DEFINED!).
      DO 1361 KK=1,KCLDS
      KMIN=LP1
      KMAX=0
      DO 1362 I=MYIS,MYIE
        J1=KTOP(I,KK+1)
!       IF (J1.EQ.1) GO TO 1362
        J3=KBTM(I,KK+1)
        IF (J3.GT.J1) THEN
          PTOP(I)=P(I,J1)
          PBOT(I)=P(I,J3+1)
          FTOP(I)=FLXNET(I,J1)
          FBOT(I)=FLXNET(I,J3+1)
!***OBTAIN THE "FLUX DERIVATIVE" DF/DP (DELPTC)
          DELPTC(I)=(FTOP(I)-FBOT(I))/(PTOP(I)-PBOT(I))
          KMIN=MIN(KMIN,J1)
          KMAX=MAX(KMAX,J3)
        ENDIF
1362  CONTINUE
      KMIN=KMIN+1
!***CALCULATE THE TOT. FLUX CHG. FROM THE TOP OF THE CLOUD, FOR
!   ALL LEVELS.
      DO 1365 K=KMIN,KMAX
      DO 1363 I=MYIS,MYIE
!       IF (KTOP(I,KK+1).EQ.1) GO TO 1363
        IF(KTOP(I,KK+1).LT.K .AND. K.LE.KBTM(I,KK+1)) THEN
          Z1(I,K)=(P(I,K)-PTOP(I))*DELPTC(I)+FTOP(I)
!ORIGINAL FLXNET(I,K)=FLXNET(I,K)*(ONE-CAMT(I,KK+1)) +
!ORIGINAL1            Z1(I,K)*CAMT(I,KK+1)
          FLXNET(I,K)=Z1(I,K)
        ENDIF
1363  CONTINUE
1365  CONTINUE
1361  CONTINUE
!***USING THIS FLUX CHG. IN THE CLOUDY PART OF THE GRID BOX, OBTAIN
!   THE NEW FLUXES, WEIGHTING THE CLEAR AND CLOUDY FLUXES:AGAIN, ONLY
!    THE FLUXES IN THICK-CLOUD LEVELS WILL EVENTUALLY BE USED.
!     DO 6051 K=1,LP1
!     DO 6051 I=MYIS,MYIE
!     FLXNET(I,K)=FLXNET(I,K)*(ONE-CAMT(I,NC)) +
!    1            Z1(I,K)*CAMT(I,NC)
!051  CONTINUE
!***MERGE FLXTHK INTO FLXNET FOR APPROPRIATE LEVELS.
!     DO 1401 K=1,LP1
!     DO 1401 I=MYIS,MYIE
!     IF (K.GT.ITOP(I) .AND. K.LE.IBOT(I)
!    1  .AND.  (NC-1).LE.NCLDS(I))  THEN
!          FLXNET(I,K)=FLXTHK(I,K)
!     ENDIF
!401  CONTINUE
!
!******END OF CLOUD LOOP*****
6001  CONTINUE
6999  CONTINUE
!***THE FINAL STEP IS TO RECOMPUTE THE HEATING RATES BASED ON THE
!   REVISED FLUXES:
      DO 6101 K=1,L
      DO 6101 I=MYIS,MYIE
      HEATRA(I,K)=RADCON*(FLXNET(I,K+1)-FLXNET(I,K))*DELP(I,K)
6101  CONTINUE
!     THE THICK CLOUD SECTION ENDS HERE.

  END SUBROUTINE FST88

!----------------------------------------------------------------------

  SUBROUTINE E1E290(G1,G2,G3,G4,G5,EMISS,FXOE1,DTE1,FXOE2,DTE2,      &
                       AVEPHI,TEMP,T,                                &
!                      T1,T2,T4,EM1V,EM1VW,                          &
                       H16E1,TEN,HP1,H28E1,HAF,                      &
                       ids,ide, jds,jde, kds,kde,                    &
                       ims,ime, jms,jme, kms,kme,                    &
                       its,ite, jts,jte, kts,kte                     )
!---------------------------------------------------------------------
 IMPLICIT NONE
!----------------------------------------------------------------------
      INTEGER, INTENT(IN)        :: ids,ide, jds,jde, kds,kde ,      &
                                    ims,ime, jms,jme, kms,kme ,      &
                                    its,ite, jts,jte, kts,kte
      REAL,INTENT(IN) :: H16E1,TEN,HP1,H28E1,HAF

      REAL,INTENT(OUT),DIMENSION(its:ite,kts:kte+1) :: G1,G4,G3,EMISS
      REAL,INTENT(IN),DIMENSION(its:ite,kts:kte+1) :: FXOE1,DTE1,FXOE2,DTE2
      REAL,INTENT(IN),DIMENSION(its:ite,kts:kte+1) :: AVEPHI,TEMP,T
      REAL,INTENT(OUT),DIMENSION(its:ite,kts:kte)   :: G2,G5
!     REAL,INTENT(IN),DIMENSION(5040):: T1,T2,T4 ,EM1V,EM1VW

      REAL,DIMENSION(its:ite,kts:kte+1) :: TMP3,DU,FYO,WW1,WW2
      INTEGER,DIMENSION(its:ite,kts:kte*3+2)   :: IT1
      INTEGER,DIMENSION(its:ite,kts:kte+1) :: IVAL

!     REAL,DIMENSION(28,180):: EM1,EM1WDE,TABLE1,TABLE2, &
!                              TABLE3
!     EQUIVALENCE (EM1V(1),EM1(1,1)),(EM1VW(1),EM1WDE(1,1))
!     EQUIVALENCE (T1(1),TABLE1(1,1)),(T2(1),TABLE2(1,1)), &
!      (T4(1),TABLE3(1,1))

      INTEGER :: K, I,KP,LLM2,J1,J3,KMAX,KMIN,KCLDS,ICNT,LLM1
      INTEGER :: L,LP1,LP2,LP3,LM1,LM2,LM3,MYIS,MYIE,LLP1,LL,KK,KLEN

      L=kte
      LP1=L+1;  LP2=L+2;  LP3=L+3; LLP1 = 2*L + 1
      LM1=L-1;  LM2=L-2;  LM3=L-3; LL = 2*L
      LLM2 = LL-2; LLM1=LL-1
      MYIS=its; MYIE=ite

!---FIRST WE OBTAIN THE EMISSIVITIES AS A FUNCTION OF TEMPERATURE
!   (INDEX FXO) AND WATER AMOUNT (INDEX FYO). THIS PART OF THE CODE
!   THUS GENERATES THE E2 FUNCTION. THE FXO INDICES HAVE BEEN
!   OBTAINED IN FST88, FOR CONVENIENCE.
!
!---THIS SUBROUTINE EVALUATES THE K=1 CASE ONLY--
!
!---THIS LOOP REPLACES LOOPS GOING FROMI=1,IMAX AND KP=2,LP1 PLUS
!   THE SPECIAL CASE FOR THE LP1TH LAYER.

      DO 1322 K=1,LP1
      DO 1322 I=MYIS,MYIE
      TMP3(I,K)=LOG10(AVEPHI(I,K))+H16E1
      FYO(I,K)=AINT(TMP3(I,K)*TEN)
      DU(I,K)=TMP3(I,K)-HP1*FYO(I,K)
      FYO(I,K)=H28E1*FYO(I,K)
      IVAL(I,K)=FYO(I,K)+FXOE2(I,K)
      EMISS(I,K)=T1(IVAL(I,K))+DU(I,K)*T2(IVAL(I,K)) &
                              +DTE2(I,K)*T4(IVAL(I,K))
1322  CONTINUE
!
!---THE SPECIAL CASE EMISS(I,L) (LAYER KP) IS OBTAINED NOW
!   BY AVERAGING THE VALUES FOR L AND LP1:
      DO 1344 I=MYIS,MYIE
      EMISS(I,L)=HAF*(EMISS(I,L)+EMISS(I,LP1))
1344  CONTINUE
!
!   CALCULATIONS FOR THE KP=1 LAYER ARE NOT PERFORMED, AS
!   THE RADIATION CODE ASSUMES THAT THE TOP FLUX LAYER (ABOVE THE
!   TOP DATA LEVEL) IS ISOTHERMAL, AND HENCE CONTRIBUTES NOTHING
!   TO THE FLUXES AT OTHER LEVELS.
!
!***THE FOLLOWING IS THE CALCULATION FOR THE E1 FUNCTION, FORMERLY
!    DONE IN SUBROUTINE E1V88. THE MOVE TO E1E288 IS DUE TO THE
!    SAVINGS IN OBTAINING INDEX VALUES (THE TEMP. INDICES HAVE
!    BEEN OBTAINED IN FST88, WHILE THE U-INDICES ARE OBTAINED
!    IN THE E2 CALCS.,WITH K=1).
!
!
!   FOR TERMS INVOLVING TOP LAYER, DU IS NOT KNOWN; IN FACT, WE
!   USE INDEX 2 TO REPERSENT INDEX 1 IN PREV. CODE. THIS MEANS THAT
!    THE IT1 INDEX 1 AND LLP1 HAS TO BE CALCULATED SEPARATELY. THE
!   INDEX LLP2 GIVES THE SAME VALUE AS 1; IT CAN BE OMITTED.
      DO 208 I=MYIS,MYIE
      IT1(I,1)=FXOE1(I,1)
      WW1(I,1)=TEN-DTE1(I,1)
      WW2(I,1)=HP1
208   CONTINUE
      DO 209 K=1,L
      DO 209 I=MYIS,MYIE
      IT1(I,K+1)=FYO(I,K)+FXOE1(I,K+1)
      IT1(I,LP2+K-1)=FYO(I,K)+FXOE1(I,K)
      WW1(I,K+1)=TEN-DTE1(I,K+1)
      WW2(I,K+1)=HP1-DU(I,K)
209   CONTINUE
      DO 211 KP=1,L
      DO 211 I=MYIS,MYIE
      IT1(I,KP+LLP1)=FYO(I,KP)+FXOE1(I,1)
211   CONTINUE
!
!
!  G3(I,1) HAS THE SAME VALUES AS G1 (AND DID ALL ALONG)
      DO 230 I=MYIS,MYIE
      G1(I,1)=WW1(I,1)*WW2(I,1)*EM1V(IT1(I,1))+ &
              WW2(I,1)*DTE1(I,1)*EM1V(IT1(I,1)+1)
      G3(I,1)=G1(I,1)
230   CONTINUE
      DO 240 K=1,L
      DO 240 I=MYIS,MYIE
      G1(I,K+1)=WW1(I,K+1)*WW2(I,K+1)*EM1V(IT1(I,K+1))+ &
              WW2(I,K+1)*DTE1(I,K+1)*EM1V(IT1(I,K+1)+1)+ &
              WW1(I,K+1)*DU(I,K)*EM1V(IT1(I,K+1)+28)+ &
              DTE1(I,K+1)*DU(I,K)*EM1V(IT1(I,K+1)+29)
      G2(I,K)=WW1(I,K)*WW2(I,K+1)*EM1V(IT1(I,K+LP2-1))+ &
              WW2(I,K+1)*DTE1(I,K)*EM1V(IT1(I,K+LP2-1)+1)+ &
              WW1(I,K)*DU(I,K)*EM1V(IT1(I,K+LP2-1)+28)+ &
              DTE1(I,K)*DU(I,K)*EM1V(IT1(I,K+LP2-1)+29)
240   CONTINUE
      DO 241 KP=2,LP1
      DO 241 I=MYIS,MYIE
      G3(I,KP)=WW1(I,1)*WW2(I,KP)*EM1V(IT1(I,LL+KP))+ &
              WW2(I,KP)*DTE1(I,1)*EM1V(IT1(I,LL+KP)+1)+ &
              WW1(I,1)*DU(I,KP-1)*EM1V(IT1(I,LL+KP)+28)+ &
              DTE1(I,1)*DU(I,KP-1)*EM1V(IT1(I,LL+KP)+29)
241   CONTINUE
!
      DO 244 I=MYIS,MYIE
      G4(I,1)=WW1(I,1)*WW2(I,1)*EM1VW(IT1(I,1))+ &
              WW2(I,1)*DTE1(I,1)*EM1VW(IT1(I,1)+1)
244   CONTINUE
      DO 242 K=1,L
      DO 242 I=MYIS,MYIE
      G4(I,K+1)=WW1(I,K+1)*WW2(I,K+1)*EM1VW(IT1(I,K+1))+ &
              WW2(I,K+1)*DTE1(I,K+1)*EM1VW(IT1(I,K+1)+1)+ &
              WW1(I,K+1)*DU(I,K)*EM1VW(IT1(I,K+1)+28)+ &
              DTE1(I,K+1)*DU(I,K)*EM1VW(IT1(I,K+1)+29)
      G5(I,K)=WW1(I,K)*WW2(I,K+1)*EM1VW(IT1(I,K+LP2-1))+ &
              WW2(I,K+1)*DTE1(I,K)*EM1VW(IT1(I,K+LP2-1)+1)+ &
              WW1(I,K)*DU(I,K)*EM1VW(IT1(I,K+LP2-1)+28)+ &
              DTE1(I,K)*DU(I,K)*EM1VW(IT1(I,K+LP2-1)+29)
242   CONTINUE
!
  END SUBROUTINE E1E290

!----------------------------------------------------------------------

 SUBROUTINE SPA88(EXCTS,CTSO3,GXCTS,SORC,CSOUR,                      &
                       CLDFAC,TEMP,PRESS,VAR1,VAR2,                  &
                       P,DELP,DELP2,TOTVO2,TO3SP,TO3SPC,             &
                       CO2SP1,CO2SP2,CO2SP,                          &
                       APCM,BPCM,ATPCM,BTPCM,ACOMB,BCOMB,BETACM,     &
                       H25E2,ONE,H44194M2,H1P41819,HAF,HM1EZ,TWO,    &
!                      SKO2D,RADCON,                                 &
                       RADCON,                                 &
                       ids,ide, jds,jde, kds,kde,                    &
                       ims,ime, jms,jme, kms,kme,                    &
                       its,ite, jts,jte, kts,kte                     )
!---------------------------------------------------------------------
 IMPLICIT NONE
!----------------------------------------------------------------------
!     INTEGER, PARAMETER :: NBLY=15
      INTEGER, INTENT(IN)        :: ids,ide, jds,jde, kds,kde ,      &
                                    ims,ime, jms,jme, kms,kme ,      &
                                    its,ite, jts,jte, kts,kte

      REAL,INTENT(IN) :: H25E2,ONE,H44194M2,H1P41819,HAF,HM1EZ,TWO, &
                         RADCON
!                        SKO2D,RADCON

      REAL,INTENT(IN),DIMENSION(its:ite,kts:kte+1) :: CSOUR
      REAL,INTENT(OUT),DIMENSION(its:ite,kts:kte)  :: CTSO3
      REAL,INTENT(OUT),DIMENSION(its:ite,kts:kte)  :: EXCTS
      REAL,INTENT(OUT),DIMENSION(its:ite)          :: GXCTS
      REAL,INTENT(IN),DIMENSION(its:ite,kts:kte+1,NBLY) :: SORC
      REAL,INTENT(IN),DIMENSION(its:ite,kts:kte+1,kts:kte+1) :: CLDFAC
      REAL,INTENT(IN), DIMENSION(its:ite,kts:kte+1) :: PRESS,TEMP

      REAL,INTENT(IN),DIMENSION(its:ite,kts:kte) :: VAR1,VAR2 
      REAL,INTENT(IN),DIMENSION(its:ite,kts:kte+1) :: P
      REAL,INTENT(IN),DIMENSION(its:ite,kts:kte)   :: DELP,DELP2,TO3SPC
      REAL,INTENT(IN),DIMENSION(its:ite,kts:kte+1) ::TOTVO2,TO3SP,CO2SP1,&
                                                     CO2SP2,CO2SP
      REAL,INTENT(IN),DIMENSION(NBLY) :: APCM,BPCM,ATPCM,BTPCM,ACOMB, &
                                         BCOMB,BETACM

      REAL,DIMENSION(its:ite,kts:kte+1) ::CTMP,CTMP2,CTMP3
      REAL,DIMENSION(its:ite,kts:kte)   ::X,Y,FAC1,FAC2,F,FF,AG,AGG, &
                                          PHITMP,PSITMP,TOPM,TOPPHI,TT

      INTEGER :: K, I,KP,LLM2,J1,J3,KMAX,KMIN,KCLDS,ICNT,LLM1
      INTEGER :: L,LP1,LP2,LP3,LM1,LM2,LM3,MYIS,MYIE,LLP1,LL,KK,KLEN

      L=kte
      LP1=L+1;  LP2=L+2;  LP3=L+3; LLP1 = 2*L + 1
      LM1=L-1;  LM2=L-2;  LM3=L-3; LL = 2*L
      LLM2 = LL-2; LLM1=LL-1
      MYIS=its; MYIE=ite

!--!COMPUTE TEMPERATURE QUANTITIES FOR USE IN PROGRAM

      DO 101 K=1,L
      DO 101 I=MYIS,MYIE
      X(I,K)=TEMP(I,K)-H25E2
      Y(I,K)=X(I,K)*X(I,K)
101   CONTINUE
!---INITIALIZE CTMP(I,1),CTMP2(I,1),CTMP3(I,1) TO UNITY; THESE ARE
!   TRANSMISSION FCTNS AT THE TOP.
      DO 345 I=MYIS,MYIE
      CTMP(I,1)=ONE
      CTMP2(I,1)=1.
      CTMP3(I,1)=1.
345   CONTINUE
!***BEGIN LOOP ON FREQUENCY BANDS (1)***
!
!---CALCULATION FOR BAND 1 (COMBINED BAND 1)
!
!---OBTAIN TEMPERATURE CORRECTION (CAPPHI,CAPPSI),THEN MULTIPLY
!   BY OPTICAL PATH (VAR1,VAR2) TO COMPUTE TEMPERATURE-CORRECTED
!   OPTICAL PATH AND MEAN PRESSURE FOR A LAYER (PHITMP,PSITMP)
      DO 301 K=1,L
      DO 301 I=MYIS,MYIE
      F(I,K)=H44194M2*(APCM(1)*X(I,K)+BPCM(1)*Y(I,K))
      FF(I,K)=H44194M2*(ATPCM(1)*X(I,K)+BTPCM(1)*Y(I,K))
      AG(I,K)=(H1P41819+F(I,K))*F(I,K)+ONE
      AGG(I,K)=(H1P41819+FF(I,K))*FF(I,K)+ONE
      PHITMP(I,K)=VAR1(I,K)*(((( AG(I,K)*AG(I,K))**2)**2)**2)
      PSITMP(I,K)=VAR2(I,K)*(((( AGG(I,K)*AGG(I,K))**2)**2)**2)
301   CONTINUE
!---OBTAIN OPTICAL PATH,MEAN PRESSURE FROM THE TOP TO THE PRESSURE
!   P(K) (TOPM,TOPPHI)
      DO 315 I=MYIS,MYIE
      TOPM(I,1)=PHITMP(I,1)
      TOPPHI(I,1)=PSITMP(I,1)
315   CONTINUE
      DO 319 K=2,L
      DO 317 I=MYIS,MYIE
      TOPM(I,K)=TOPM(I,K-1)+PHITMP(I,K)
      TOPPHI(I,K)=TOPPHI(I,K-1)+PSITMP(I,K)
317   CONTINUE
319   CONTINUE
!---TT IS THE CLOUD-FREE CTS TRANSMISSION FUNCTION
      DO 321 K=1,L
      DO 321 I=MYIS,MYIE
      FAC1(I,K)=ACOMB(1)*TOPM(I,K)
      FAC2(I,K)=FAC1(I,K)*TOPM(I,K)/(BCOMB(1)*TOPPHI(I,K))
      TT(I,K)=EXP(HM1EZ*FAC1(I,K)/SQRT(1.+FAC2(I,K)))
      CTMP(I,K+1)=TT(I,K)*CLDFAC(I,K+1,1)
321   CONTINUE
!---EXCTS IS THE CTS COOLING RATE ACCUMULATED OVER FREQUENCY BANDS
      DO 353 K=1,L
      DO 353 I=MYIS,MYIE
      EXCTS(I,K)=SORC(I,K,1)*(CTMP(I,K+1)-CTMP(I,K))
353   CONTINUE
!---GXCTS IS THE EXACT CTS TOP FLUX ACCUMULATED OVER FREQUENCY BANDS
      DO 361 I=MYIS,MYIE
      GXCTS(I)=CLDFAC(I,LP1,1)*(TT(I,L)*SORC(I,L,1)+ &
         (HAF*DELP(I,L)*(TT(I,LM1)*(P(I,LP1)-PRESS(I,L)) + &
         TT(I,L)*(P(I,LP1)+PRESS(I,L)-TWO*P(I,L)))) * &
         (SORC(I,LP1,1)-SORC(I,L,1)))
361   CONTINUE
!
!
!-----CALCULATION FOR BAND 2 (COMBINED BAND 2)
!
!
!---OBTAIN TEMPERATURE CORRECTION (CAPPHI,CAPPSI),THEN MULTIPLY
!   BY OPTICAL PATH (VAR1,VAR2) TO COMPUTE TEMPERATURE-CORRECTED
!   OPTICAL PATH AND MEAN PRESSURE FOR A LAYER (PHITMP,PSITMP)
      DO 401 K=1,L
      DO 401 I=MYIS,MYIE
      F(I,K)=H44194M2*(APCM(2)*X(I,K)+BPCM(2)*Y(I,K))
      FF(I,K)=H44194M2*(ATPCM(2)*X(I,K)+BTPCM(2)*Y(I,K))
      AG(I,K)=(H1P41819+F(I,K))*F(I,K)+ONE
      AGG(I,K)=(H1P41819+FF(I,K))*FF(I,K)+ONE
      PHITMP(I,K)=VAR1(I,K)*(((( AG(I,K)*AG(I,K))**2)**2)**2)
      PSITMP(I,K)=VAR2(I,K)*(((( AGG(I,K)*AGG(I,K))**2)**2)**2)
401   CONTINUE
!---OBTAIN OPTICAL PATH,MEAN PRESSURE FROM THE TOP TO THE PRESSURE
!   P(K) (TOPM,TOPPHI)
      DO 415 I=MYIS,MYIE
      TOPM(I,1)=PHITMP(I,1)
      TOPPHI(I,1)=PSITMP(I,1)
415   CONTINUE
      DO 419 K=2,L
      DO 417 I=MYIS,MYIE
      TOPM(I,K)=TOPM(I,K-1)+PHITMP(I,K)
      TOPPHI(I,K)=TOPPHI(I,K-1)+PSITMP(I,K)
417   CONTINUE
419   CONTINUE
!---TT IS THE CLOUD-FREE CTS TRANSMISSION FUNCTION
      DO 421 K=1,L
      DO 421 I=MYIS,MYIE
      FAC1(I,K)=ACOMB(2)*TOPM(I,K)
      FAC2(I,K)=FAC1(I,K)*TOPM(I,K)/(BCOMB(2)*TOPPHI(I,K))
      TT(I,K)=EXP(HM1EZ*FAC1(I,K)/SQRT(1.+FAC2(I,K)))
      CTMP(I,K+1)=TT(I,K)*CLDFAC(I,K+1,1)
421   CONTINUE
!---EXCTS IS THE CTS COOLING RATE ACCUMULATED OVER FREQUENCY BANDS
      DO 453 K=1,L
      DO 453 I=MYIS,MYIE
      EXCTS(I,K)=EXCTS(I,K)+SORC(I,K,2)* & 
                   (CTMP(I,K+1)-CTMP(I,K))
453   CONTINUE
!---GXCTS IS THE EXACT CTS TOP FLUX ACCUMULATED OVER FREQUENCY BANDS
      DO 461 I=MYIS,MYIE
      GXCTS(I)=GXCTS(I)+CLDFAC(I,LP1,1)*(TT(I,L)*SORC(I,L,2)+ &
         (HAF*DELP(I,L)*(TT(I,LM1)*(P(I,LP1)-PRESS(I,L)) + &
         TT(I,L)*(P(I,LP1)+PRESS(I,L)-TWO*P(I,L)))) * &
         (SORC(I,LP1,2)-SORC(I,L,2)))
461   CONTINUE
!
!-----CALCULATION FOR BAND 3 (COMBINED BAND 3)
!
!
!---OBTAIN TEMPERATURE CORRECTION (CAPPHI,CAPPSI),THEN MULTIPLY
!   BY OPTICAL PATH (VAR1,VAR2) TO COMPUTE TEMPERATURE-CORRECTED
!   OPTICAL PATH AND MEAN PRESSURE FOR A LAYER (PHITMP,PSITMP)
      DO 501 K=1,L
      DO 501 I=MYIS,MYIE
      F(I,K)=H44194M2*(APCM(3)*X(I,K)+BPCM(3)*Y(I,K))
      FF(I,K)=H44194M2*(ATPCM(3)*X(I,K)+BTPCM(3)*Y(I,K))
      AG(I,K)=(H1P41819+F(I,K))*F(I,K)+ONE
      AGG(I,K)=(H1P41819+FF(I,K))*FF(I,K)+ONE
      PHITMP(I,K)=VAR1(I,K)*(((( AG(I,K)*AG(I,K))**2)**2)**2)
      PSITMP(I,K)=VAR2(I,K)*(((( AGG(I,K)*AGG(I,K))**2)**2)**2)
501   CONTINUE
!---OBTAIN OPTICAL PATH,MEAN PRESSURE FROM THE TOP TO THE PRESSURE
!   P(K) (TOPM,TOPPHI)
      DO 515 I=MYIS,MYIE
      TOPM(I,1)=PHITMP(I,1)
      TOPPHI(I,1)=PSITMP(I,1)
515   CONTINUE
      DO 519 K=2,L
      DO 517 I=MYIS,MYIE
      TOPM(I,K)=TOPM(I,K-1)+PHITMP(I,K)
      TOPPHI(I,K)=TOPPHI(I,K-1)+PSITMP(I,K)
517   CONTINUE
519   CONTINUE
!---TT IS THE CLOUD-FREE CTS TRANSMISSION FUNCTION
      DO 521 K=1,L
      DO 521 I=MYIS,MYIE
      FAC1(I,K)=ACOMB(3)*TOPM(I,K)
      FAC2(I,K)=FAC1(I,K)*TOPM(I,K)/(BCOMB(3)*TOPPHI(I,K))
      TT(I,K)=EXP(HM1EZ*FAC1(I,K)/SQRT(1.+FAC2(I,K)))
      CTMP(I,K+1)=TT(I,K)*CLDFAC(I,K+1,1)
521   CONTINUE
!---EXCTS IS THE CTS COOLING RATE ACCUMULATED OVER FREQUENCY BANDS
      DO 553 K=1,L
      DO 553 I=MYIS,MYIE
      EXCTS(I,K)=EXCTS(I,K)+SORC(I,K,3)* &
                   (CTMP(I,K+1)-CTMP(I,K))
553   CONTINUE
!---GXCTS IS THE EXACT CTS TOP FLUX ACCUMULATED OVER FREQUENCY BANDS
      DO 561 I=MYIS,MYIE
      GXCTS(I)=GXCTS(I)+CLDFAC(I,LP1,1)*(TT(I,L)*SORC(I,L,3)+ &
         (HAF*DELP(I,L)*(TT(I,LM1)*(P(I,LP1)-PRESS(I,L)) + &
         TT(I,L)*(P(I,LP1)+PRESS(I,L)-TWO*P(I,L)))) * &
         (SORC(I,LP1,3)-SORC(I,L,3)))
561   CONTINUE
!
!-----CALCULATION FOR BAND 4 (COMBINED BAND 4)
!
!
!---OBTAIN TEMPERATURE CORRECTION (CAPPHI,CAPPSI),THEN MULTIPLY
!   BY OPTICAL PATH (VAR1,VAR2) TO COMPUTE TEMPERATURE-CORRECTED
!   OPTICAL PATH AND MEAN PRESSURE FOR A LAYER (PHITMP,PSITMP)
      DO 601 K=1,L
      DO 601 I=MYIS,MYIE
      F(I,K)=H44194M2*(APCM(4)*X(I,K)+BPCM(4)*Y(I,K))
      FF(I,K)=H44194M2*(ATPCM(4)*X(I,K)+BTPCM(4)*Y(I,K))
      AG(I,K)=(H1P41819+F(I,K))*F(I,K)+ONE
      AGG(I,K)=(H1P41819+FF(I,K))*FF(I,K)+ONE
      PHITMP(I,K)=VAR1(I,K)*(((( AG(I,K)*AG(I,K))**2)**2)**2)
      PSITMP(I,K)=VAR2(I,K)*(((( AGG(I,K)*AGG(I,K))**2)**2)**2)
601   CONTINUE
!---OBTAIN OPTICAL PATH,MEAN PRESSURE FROM THE TOP TO THE PRESSURE
!   P(K) (TOPM,TOPPHI)
      DO 615 I=MYIS,MYIE
      TOPM(I,1)=PHITMP(I,1)
      TOPPHI(I,1)=PSITMP(I,1)
615   CONTINUE
      DO 619 K=2,L
      DO 617 I=MYIS,MYIE
      TOPM(I,K)=TOPM(I,K-1)+PHITMP(I,K)
      TOPPHI(I,K)=TOPPHI(I,K-1)+PSITMP(I,K)
617   CONTINUE
619   CONTINUE
!---TT IS THE CLOUD-FREE CTS TRANSMISSION FUNCTION
      DO 621 K=1,L
      DO 621 I=MYIS,MYIE
      FAC1(I,K)=ACOMB(4)*TOPM(I,K)
      FAC2(I,K)=FAC1(I,K)*TOPM(I,K)/(BCOMB(4)*TOPPHI(I,K))
      TT(I,K)=EXP(HM1EZ*FAC1(I,K)/SQRT(1.+FAC2(I,K)))
      CTMP(I,K+1)=TT(I,K)*CLDFAC(I,K+1,1)
621   CONTINUE
!---EXCTS IS THE CTS COOLING RATE ACCUMULATED OVER FREQUENCY BANDS
      DO 653 K=1,L
      DO 653 I=MYIS,MYIE
      EXCTS(I,K)=EXCTS(I,K)+SORC(I,K,4)* &
                   (CTMP(I,K+1)-CTMP(I,K))
653   CONTINUE
!---GXCTS IS THE EXACT CTS TOP FLUX ACCUMULATED OVER FREQUENCY BANDS
      DO 661 I=MYIS,MYIE
      GXCTS(I)=GXCTS(I)+CLDFAC(I,LP1,1)*(TT(I,L)*SORC(I,L,4)+ &
         (HAF*DELP(I,L)*(TT(I,LM1)*(P(I,LP1)-PRESS(I,L)) + &
         TT(I,L)*(P(I,LP1)+PRESS(I,L)-TWO*P(I,L)))) * &
         (SORC(I,LP1,4)-SORC(I,L,4)))
661   CONTINUE
!
!-----CALCULATION FOR BAND 5 (COMBINED BAND 5)
!
!
!---OBTAIN TEMPERATURE CORRECTION (CAPPHI,CAPPSI),THEN MULTIPLY
!   BY OPTICAL PATH (VAR1,VAR2) TO COMPUTE TEMPERATURE-CORRECTED
!   OPTICAL PATH AND MEAN PRESSURE FOR A LAYER (PHITMP,PSITMP)
      DO 701 K=1,L
      DO 701 I=MYIS,MYIE
      F(I,K)=H44194M2*(APCM(5)*X(I,K)+BPCM(5)*Y(I,K))
      FF(I,K)=H44194M2*(ATPCM(5)*X(I,K)+BTPCM(5)*Y(I,K))
      AG(I,K)=(H1P41819+F(I,K))*F(I,K)+ONE
      AGG(I,K)=(H1P41819+FF(I,K))*FF(I,K)+ONE
      PHITMP(I,K)=VAR1(I,K)*(((( AG(I,K)*AG(I,K))**2)**2)**2)
      PSITMP(I,K)=VAR2(I,K)*(((( AGG(I,K)*AGG(I,K))**2)**2)**2)
701   CONTINUE
!---OBTAIN OPTICAL PATH,MEAN PRESSURE FROM THE TOP TO THE PRESSURE
!   P(K) (TOPM,TOPPHI)
      DO 715 I=MYIS,MYIE
      TOPM(I,1)=PHITMP(I,1)
      TOPPHI(I,1)=PSITMP(I,1)
715   CONTINUE
      DO 719 K=2,L
      DO 717 I=MYIS,MYIE
      TOPM(I,K)=TOPM(I,K-1)+PHITMP(I,K)
      TOPPHI(I,K)=TOPPHI(I,K-1)+PSITMP(I,K)
717   CONTINUE
719   CONTINUE
!---TT IS THE CLOUD-FREE CTS TRANSMISSION FUNCTION
      DO 721 K=1,L
      DO 721 I=MYIS,MYIE
      FAC1(I,K)=ACOMB(5)*TOPM(I,K)
      FAC2(I,K)=FAC1(I,K)*TOPM(I,K)/(BCOMB(5)*TOPPHI(I,K))
      TT(I,K)=EXP(HM1EZ*(FAC1(I,K)/SQRT(ONE+FAC2(I,K))+ &
                 BETACM(5)*TOTVO2(I,K+1)*SKO2D))
      CTMP(I,K+1)=TT(I,K)*CLDFAC(I,K+1,1)
721   CONTINUE
!---EXCTS IS THE CTS COOLING RATE ACCUMULATED OVER FREQUENCY BANDS
      DO 753 K=1,L
      DO 753 I=MYIS,MYIE
      EXCTS(I,K)=EXCTS(I,K)+SORC(I,K,5)* &
                   (CTMP(I,K+1)-CTMP(I,K))
753   CONTINUE
!---GXCTS IS THE EXACT CTS TOP FLUX ACCUMULATED OVER FREQUENCY BANDS
      DO 761 I=MYIS,MYIE
      GXCTS(I)=GXCTS(I)+CLDFAC(I,LP1,1)*(TT(I,L)*SORC(I,L,5)+ &
         (HAF*DELP(I,L)*(TT(I,LM1)*(P(I,LP1)-PRESS(I,L)) + &
         TT(I,L)*(P(I,LP1)+PRESS(I,L)-TWO*P(I,L)))) * &
         (SORC(I,LP1,5)-SORC(I,L,5)))
761   CONTINUE
!
!-----CALCULATION FOR BAND 6 (COMBINED BAND 6)
!
!
!---OBTAIN TEMPERATURE CORRECTION (CAPPHI,CAPPSI),THEN MULTIPLY
!   BY OPTICAL PATH (VAR1,VAR2) TO COMPUTE TEMPERATURE-CORRECTED
!   OPTICAL PATH AND MEAN PRESSURE FOR A LAYER (PHITMP,PSITMP)
      DO 801 K=1,L
      DO 801 I=MYIS,MYIE
      F(I,K)=H44194M2*(APCM(6)*X(I,K)+BPCM(6)*Y(I,K))
      FF(I,K)=H44194M2*(ATPCM(6)*X(I,K)+BTPCM(6)*Y(I,K))
      AG(I,K)=(H1P41819+F(I,K))*F(I,K)+ONE
      AGG(I,K)=(H1P41819+FF(I,K))*FF(I,K)+ONE
      PHITMP(I,K)=VAR1(I,K)*(((( AG(I,K)*AG(I,K))**2)**2)**2)
      PSITMP(I,K)=VAR2(I,K)*(((( AGG(I,K)*AGG(I,K))**2)**2)**2)
801   CONTINUE
!---OBTAIN OPTICAL PATH,MEAN PRESSURE FROM THE TOP TO THE PRESSURE
!   P(K) (TOPM,TOPPHI)
      DO 815 I=MYIS,MYIE
      TOPM(I,1)=PHITMP(I,1)
      TOPPHI(I,1)=PSITMP(I,1)
815   CONTINUE
      DO 819 K=2,L
      DO 817 I=MYIS,MYIE
      TOPM(I,K)=TOPM(I,K-1)+PHITMP(I,K)
      TOPPHI(I,K)=TOPPHI(I,K-1)+PSITMP(I,K)
817   CONTINUE
819   CONTINUE
!---TT IS THE CLOUD-FREE CTS TRANSMISSION FUNCTION
      DO 821 K=1,L
      DO 821 I=MYIS,MYIE
      FAC1(I,K)=ACOMB(6)*TOPM(I,K)
      FAC2(I,K)=FAC1(I,K)*TOPM(I,K)/(BCOMB(6)*TOPPHI(I,K))
      TT(I,K)=EXP(HM1EZ*(FAC1(I,K)/SQRT(ONE+FAC2(I,K))+ &
                 BETACM(6)*TOTVO2(I,K+1)*SKO2D))
      CTMP(I,K+1)=TT(I,K)*CLDFAC(I,K+1,1)
821   CONTINUE
!---EXCTS IS THE CTS COOLING RATE ACCUMULATED OVER FREQUENCY BANDS
      DO 853 K=1,L
      DO 853 I=MYIS,MYIE
      EXCTS(I,K)=EXCTS(I,K)+SORC(I,K,6)* &
                   (CTMP(I,K+1)-CTMP(I,K))
853   CONTINUE
!---GXCTS IS THE EXACT CTS TOP FLUX ACCUMULATED OVER FREQUENCY BANDS
      DO 861 I=MYIS,MYIE
      GXCTS(I)=GXCTS(I)+CLDFAC(I,LP1,1)*(TT(I,L)*SORC(I,L,6)+ &
         (HAF*DELP(I,L)*(TT(I,LM1)*(P(I,LP1)-PRESS(I,L)) + &
         TT(I,L)*(P(I,LP1)+PRESS(I,L)-TWO*P(I,L)))) * &
         (SORC(I,LP1,6)-SORC(I,L,6)))
861   CONTINUE
!
!-----CALCULATION FOR BAND 7 (COMBINED BAND 7)
!
!
!---OBTAIN TEMPERATURE CORRECTION (CAPPHI,CAPPSI),THEN MULTIPLY
!   BY OPTICAL PATH (VAR1,VAR2) TO COMPUTE TEMPERATURE-CORRECTED
!   OPTICAL PATH AND MEAN PRESSURE FOR A LAYER (PHITMP,PSITMP)
      DO 901 K=1,L
      DO 901 I=MYIS,MYIE
      F(I,K)=H44194M2*(APCM(7)*X(I,K)+BPCM(7)*Y(I,K))
      FF(I,K)=H44194M2*(ATPCM(7)*X(I,K)+BTPCM(7)*Y(I,K))
      AG(I,K)=(H1P41819+F(I,K))*F(I,K)+ONE
      AGG(I,K)=(H1P41819+FF(I,K))*FF(I,K)+ONE
      PHITMP(I,K)=VAR1(I,K)*(((( AG(I,K)*AG(I,K))**2)**2)**2)
      PSITMP(I,K)=VAR2(I,K)*(((( AGG(I,K)*AGG(I,K))**2)**2)**2)
901   CONTINUE
!---OBTAIN OPTICAL PATH,MEAN PRESSURE FROM THE TOP TO THE PRESSURE
!   P(K) (TOPM,TOPPHI)
      DO 915 I=MYIS,MYIE
      TOPM(I,1)=PHITMP(I,1)
      TOPPHI(I,1)=PSITMP(I,1)
915   CONTINUE
      DO 919 K=2,L
      DO 917 I=MYIS,MYIE
      TOPM(I,K)=TOPM(I,K-1)+PHITMP(I,K)
      TOPPHI(I,K)=TOPPHI(I,K-1)+PSITMP(I,K)
917   CONTINUE
919   CONTINUE
!---TT IS THE CLOUD-FREE CTS TRANSMISSION FUNCTION
      DO 921 K=1,L
      DO 921 I=MYIS,MYIE
      FAC1(I,K)=ACOMB(7)*TOPM(I,K)
      FAC2(I,K)=FAC1(I,K)*TOPM(I,K)/(BCOMB(7)*TOPPHI(I,K))
      TT(I,K)=EXP(HM1EZ*(FAC1(I,K)/SQRT(ONE+FAC2(I,K))+ &
                 BETACM(7)*TOTVO2(I,K+1)*SKO2D))
      CTMP(I,K+1)=TT(I,K)*CLDFAC(I,K+1,1)
921   CONTINUE
!---EXCTS IS THE CTS COOLING RATE ACCUMULATED OVER FREQUENCY BANDS
      DO 953 K=1,L
      DO 953 I=MYIS,MYIE
      EXCTS(I,K)=EXCTS(I,K)+SORC(I,k,7)* &
                   (CTMP(I,K+1)-CTMP(I,K))
953   CONTINUE
!---GXCTS IS THE EXACT CTS TOP FLUX ACCUMULATED OVER FREQUENCY BANDS
      DO 961 I=MYIS,MYIE
      GXCTS(I)=GXCTS(I)+CLDFAC(I,LP1,1)*(TT(I,L)*SORC(I,L,7)+ &
         (HAF*DELP(I,L)*(TT(I,LM1)*(P(I,LP1)-PRESS(I,L)) + &
         TT(I,L)*(P(I,LP1)+PRESS(I,L)-TWO*P(I,L)))) * &
         (SORC(I,LP1,7)-SORC(I,L,7)))
961   CONTINUE
!
!-----CALCULATION FOR BAND 8 (COMBINED BAND 8)
!
!
!---OBTAIN TEMPERATURE CORRECTION (CAPPHI,CAPPSI),THEN MULTIPLY
!   BY OPTICAL PATH (VAR1,VAR2) TO COMPUTE TEMPERATURE-CORRECTED
!   OPTICAL PATH AND MEAN PRESSURE FOR A LAYER (PHITMP,PSITMP)
      DO 1001 K=1,L
      DO 1001 I=MYIS,MYIE
      F(I,K)=H44194M2*(APCM(8)*X(I,K)+BPCM(8)*Y(I,K))
      FF(I,K)=H44194M2*(ATPCM(8)*X(I,K)+BTPCM(8)*Y(I,K))
      AG(I,K)=(H1P41819+F(I,K))*F(I,K)+ONE
      AGG(I,K)=(H1P41819+FF(I,K))*FF(I,K)+ONE
      PHITMP(I,K)=VAR1(I,K)*(((( AG(I,K)*AG(I,K))**2)**2)**2)
      PSITMP(I,K)=VAR2(I,K)*(((( AGG(I,K)*AGG(I,K))**2)**2)**2)
1001  CONTINUE
!---OBTAIN OPTICAL PATH,MEAN PRESSURE FROM THE TOP TO THE PRESSURE
!   P(K) (TOPM,TOPPHI)
      DO 1015 I=MYIS,MYIE
      TOPM(I,1)=PHITMP(I,1)
      TOPPHI(I,1)=PSITMP(I,1)
1015  CONTINUE
      DO 1019 K=2,L
      DO 1017 I=MYIS,MYIE
      TOPM(I,K)=TOPM(I,K-1)+PHITMP(I,K)
      TOPPHI(I,K)=TOPPHI(I,K-1)+PSITMP(I,K)
1017  CONTINUE
1019  CONTINUE
!---TT IS THE CLOUD-FREE CTS TRANSMISSION FUNCTION
      DO 1021 K=1,L
      DO 1021 I=MYIS,MYIE
      FAC1(I,K)=ACOMB(8)*TOPM(I,K)
      FAC2(I,K)=FAC1(I,K)*TOPM(I,K)/(BCOMB(8)*TOPPHI(I,K))
      TT(I,K)=EXP(HM1EZ*(FAC1(I,K)/SQRT(ONE+FAC2(I,K))+ &
                 BETACM(8)*TOTVO2(I,K+1)*SKO2D))
      CTMP(I,K+1)=TT(I,K)*CLDFAC(I,K+1,1)
1021  CONTINUE
!---EXCTS IS THE CTS COOLING RATE ACCUMULATED OVER FREQUENCY BANDS
      DO 1053 K=1,L
      DO 1053 I=MYIS,MYIE
      EXCTS(I,K)=EXCTS(I,K)+SORC(I,K,8)* &
                   (CTMP(I,K+1)-CTMP(I,K))
1053  CONTINUE
!---GXCTS IS THE EXACT CTS TOP FLUX ACCUMULATED OVER FREQUENCY BANDS
      DO 1061 I=MYIS,MYIE
      GXCTS(I)=GXCTS(I)+CLDFAC(I,LP1,1)*(TT(I,L)*SORC(I,L,8)+ &
         (HAF*DELP(I,L)*(TT(I,LM1)*(P(I,LP1)-PRESS(I,L)) + &
         TT(I,L)*(P(I,LP1)+PRESS(I,L)-TWO*P(I,L)))) * &
         (SORC(I,LP1,8)-SORC(I,L,8)))
1061  CONTINUE
!
!-----CALCULATION FOR BAND 9 ( 560-670 CM-1; INCLUDES CO2)
!
!
!---OBTAIN TEMPERATURE CORRECTION (CAPPHI,CAPPSI),THEN MULTIPLY
!   BY OPTICAL PATH (VAR1,VAR2) TO COMPUTE TEMPERATURE-CORRECTED
!   OPTICAL PATH AND MEAN PRESSURE FOR A LAYER (PHITMP,PSITMP)
      DO 1101 K=1,L
      DO 1101 I=MYIS,MYIE
      F(I,K)=H44194M2*(APCM(9)*X(I,K)+BPCM(9)*Y(I,K))
      FF(I,K)=H44194M2*(ATPCM(9)*X(I,K)+BTPCM(9)*Y(I,K))
      AG(I,K)=(H1P41819+F(I,K))*F(I,K)+ONE
      AGG(I,K)=(H1P41819+FF(I,K))*FF(I,K)+ONE
      PHITMP(I,K)=VAR1(I,K)*(((( AG(I,K)*AG(I,K))**2)**2)**2)
      PSITMP(I,K)=VAR2(I,K)*(((( AGG(I,K)*AGG(I,K))**2)**2)**2)
1101  CONTINUE
!---OBTAIN OPTICAL PATH,MEAN PRESSURE FROM THE TOP TO THE PRESSURE
!   P(K) (TOPM,TOPPHI)
      DO 1115 I=MYIS,MYIE
      TOPM(I,1)=PHITMP(I,1)
      TOPPHI(I,1)=PSITMP(I,1)
1115  CONTINUE
      DO 1119 K=2,L
      DO 1117 I=MYIS,MYIE
      TOPM(I,K)=TOPM(I,K-1)+PHITMP(I,K)
      TOPPHI(I,K)=TOPPHI(I,K-1)+PSITMP(I,K)
1117  CONTINUE
1119  CONTINUE
!---TT IS THE CLOUD-FREE CTS TRANSMISSION FUNCTION
      DO 1121 K=1,L
      DO 1121 I=MYIS,MYIE
      FAC1(I,K)=ACOMB(9)*TOPM(I,K)
      FAC2(I,K)=FAC1(I,K)*TOPM(I,K)/(BCOMB(9)*TOPPHI(I,K))
      TT(I,K)=EXP(HM1EZ*(FAC1(I,K)/SQRT(ONE+FAC2(I,K))+ &
                 BETACM(9)*TOTVO2(I,K+1)*SKO2D))*CO2SP1(I,K+1)
      CTMP(I,K+1)=TT(I,K)*CLDFAC(I,K+1,1)
1121  CONTINUE
!---EXCTS IS THE CTS COOLING RATE ACCUMULATED OVER FREQUENCY BANDS
      DO 1153 K=1,L
      DO 1153 I=MYIS,MYIE
      EXCTS(I,K)=EXCTS(I,K)+SORC(I,K,9)* &
                   (CTMP(I,K+1)-CTMP(I,K))
1153  CONTINUE
!---GXCTS IS THE EXACT CTS TOP FLUX ACCUMULATED OVER FREQUENCY BANDS
      DO 1161 I=MYIS,MYIE
      GXCTS(I)=GXCTS(I)+CLDFAC(I,LP1,1)*(TT(I,L)*SORC(I,L,9)+ &
         (HAF*DELP(I,L)*(TT(I,LM1)*(P(I,LP1)-PRESS(I,L)) + &
         TT(I,L)*(P(I,LP1)+PRESS(I,L)-TWO*P(I,L)))) * &
         (SORC(I,LP1,9)-SORC(I,L,9)))
1161  CONTINUE
!
!-----CALCULATION FOR BAND 10 (670-800 CM-1; INCLUDES CO2)
!
!
!---OBTAIN TEMPERATURE CORRECTION (CAPPHI,CAPPSI),THEN MULTIPLY
!   BY OPTICAL PATH (VAR1,VAR2) TO COMPUTE TEMPERATURE-CORRECTED
!   OPTICAL PATH AND MEAN PRESSURE FOR A LAYER (PHITMP,PSITMP)
      DO 1201 K=1,L
      DO 1201 I=MYIS,MYIE
      F(I,K)=H44194M2*(APCM(10)*X(I,K)+BPCM(10)*Y(I,K))
      FF(I,K)=H44194M2*(ATPCM(10)*X(I,K)+BTPCM(10)*Y(I,K))
      AG(I,K)=(H1P41819+F(I,K))*F(I,K)+ONE
      AGG(I,K)=(H1P41819+FF(I,K))*FF(I,K)+ONE
      PHITMP(I,K)=VAR1(I,K)*(((( AG(I,K)*AG(I,K))**2)**2)**2)
      PSITMP(I,K)=VAR2(I,K)*(((( AGG(I,K)*AGG(I,K))**2)**2)**2)
1201  CONTINUE
!---OBTAIN OPTICAL PATH,MEAN PRESSURE FROM THE TOP TO THE PRESSURE
!   P(K) (TOPM,TOPPHI)
      DO 1215 I=MYIS,MYIE
      TOPM(I,1)=PHITMP(I,1)
      TOPPHI(I,1)=PSITMP(I,1)
1215  CONTINUE
      DO 1219 K=2,L
      DO 1217 I=MYIS,MYIE
      TOPM(I,K)=TOPM(I,K-1)+PHITMP(I,K)
      TOPPHI(I,K)=TOPPHI(I,K-1)+PSITMP(I,K)
1217  CONTINUE
1219  CONTINUE
!---TT IS THE CLOUD-FREE CTS TRANSMISSION FUNCTION
      DO 1221 K=1,L
      DO 1221 I=MYIS,MYIE
      FAC1(I,K)=ACOMB(10)*TOPM(I,K)
      FAC2(I,K)=FAC1(I,K)*TOPM(I,K)/(BCOMB(10)*TOPPHI(I,K))
      TT(I,K)=EXP(HM1EZ*(FAC1(I,K)/SQRT(ONE+FAC2(I,K))+ &
                 BETACM(10)*TOTVO2(I,K+1)*SKO2D))*CO2SP2(I,K+1)
      CTMP(I,K+1)=TT(I,K)*CLDFAC(I,K+1,1)
1221  CONTINUE
!---EXCTS IS THE CTS COOLING RATE ACCUMULATED OVER FREQUENCY BANDS
      DO 1253 K=1,L
      DO 1253 I=MYIS,MYIE
      EXCTS(I,K)=EXCTS(I,K)+SORC(I,K,10)* &
                   (CTMP(I,K+1)-CTMP(I,K))
1253  CONTINUE
!---GXCTS IS THE EXACT CTS TOP FLUX ACCUMULATED OVER FREQUENCY BANDS
      DO 1261 I=MYIS,MYIE
      GXCTS(I)=GXCTS(I)+CLDFAC(I,LP1,1)*(TT(I,L)*SORC(I,L,10)+ &
         (HAF*DELP(I,L)*(TT(I,LM1)*(P(I,LP1)-PRESS(I,L)) + &
         TT(I,L)*(P(I,LP1)+PRESS(I,L)-TWO*P(I,L)))) * &
         (SORC(I,LP1,10)-SORC(I,L,10)))
1261  CONTINUE
!
!-----CALCULATION FOR BAND 11 (800-900 CM-1)
!
!
!---OBTAIN TEMPERATURE CORRECTION (CAPPHI,CAPPSI),THEN MULTIPLY
!   BY OPTICAL PATH (VAR1,VAR2) TO COMPUTE TEMPERATURE-CORRECTED
!   OPTICAL PATH AND MEAN PRESSURE FOR A LAYER (PHITMP,PSITMP)
      DO 1301 K=1,L
      DO 1301 I=MYIS,MYIE
      F(I,K)=H44194M2*(APCM(11)*X(I,K)+BPCM(11)*Y(I,K))
      FF(I,K)=H44194M2*(ATPCM(11)*X(I,K)+BTPCM(11)*Y(I,K))
      AG(I,K)=(H1P41819+F(I,K))*F(I,K)+ONE
      AGG(I,K)=(H1P41819+FF(I,K))*FF(I,K)+ONE
      PHITMP(I,K)=VAR1(I,K)*(((( AG(I,K)*AG(I,K))**2)**2)**2)
      PSITMP(I,K)=VAR2(I,K)*(((( AGG(I,K)*AGG(I,K))**2)**2)**2)
1301  CONTINUE
!---OBTAIN OPTICAL PATH,MEAN PRESSURE FROM THE TOP TO THE PRESSURE
!   P(K) (TOPM,TOPPHI)
      DO 1315 I=MYIS,MYIE
      TOPM(I,1)=PHITMP(I,1)
      TOPPHI(I,1)=PSITMP(I,1)
1315  CONTINUE
      DO 1319 K=2,L
      DO 1317 I=MYIS,MYIE
      TOPM(I,K)=TOPM(I,K-1)+PHITMP(I,K)
      TOPPHI(I,K)=TOPPHI(I,K-1)+PSITMP(I,K)
1317  CONTINUE
1319  CONTINUE
!---TT IS THE CLOUD-FREE CTS TRANSMISSION FUNCTION
      DO 1321 K=1,L
      DO 1321 I=MYIS,MYIE
      FAC1(I,K)=ACOMB(11)*TOPM(I,K)
      FAC2(I,K)=FAC1(I,K)*TOPM(I,K)/(BCOMB(11)*TOPPHI(I,K))
      TT(I,K)=EXP(HM1EZ*(FAC1(I,K)/SQRT(ONE+FAC2(I,K))+ &
                 BETACM(11)*TOTVO2(I,K+1)*SKO2D))
      CTMP(I,K+1)=TT(I,K)*CLDFAC(I,K+1,1)
1321  CONTINUE
!---EXCTS IS THE CTS COOLING RATE ACCUMULATED OVER FREQUENCY BANDS
      DO 1353 K=1,L
      DO 1353 I=MYIS,MYIE
      EXCTS(I,K)=EXCTS(I,K)+SORC(I,K,11)* &
                   (CTMP(I,K+1)-CTMP(I,K))
1353  CONTINUE
!---GXCTS IS THE EXACT CTS TOP FLUX ACCUMULATED OVER FREQUENCY BANDS
      DO 1361 I=MYIS,MYIE
      GXCTS(I)=GXCTS(I)+CLDFAC(I,LP1,1)*(TT(I,L)*SORC(I,L,11)+ &
         (HAF*DELP(I,L)*(TT(I,LM1)*(P(I,LP1)-PRESS(I,L)) + &
         TT(I,L)*(P(I,LP1)+PRESS(I,L)-TWO*P(I,L)))) * &
         (SORC(I,LP1,11)-SORC(I,L,11)))
1361  CONTINUE
!
!-----CALCULATION FOR BAND 12 (900-990 CM-1)
!
!
!---OBTAIN TEMPERATURE CORRECTION (CAPPHI,CAPPSI),THEN MULTIPLY
!   BY OPTICAL PATH (VAR1,VAR2) TO COMPUTE TEMPERATURE-CORRECTED
!   OPTICAL PATH AND MEAN PRESSURE FOR A LAYER (PHITMP,PSITMP)
      DO 1401 K=1,L
      DO 1401 I=MYIS,MYIE
      F(I,K)=H44194M2*(APCM(12)*X(I,K)+BPCM(12)*Y(I,K))
      FF(I,K)=H44194M2*(ATPCM(12)*X(I,K)+BTPCM(12)*Y(I,K))
      AG(I,K)=(H1P41819+F(I,K))*F(I,K)+ONE
      AGG(I,K)=(H1P41819+FF(I,K))*FF(I,K)+ONE
      PHITMP(I,K)=VAR1(I,K)*(((( AG(I,K)*AG(I,K))**2)**2)**2)
      PSITMP(I,K)=VAR2(I,K)*(((( AGG(I,K)*AGG(I,K))**2)**2)**2)
1401  CONTINUE
!---OBTAIN OPTICAL PATH,MEAN PRESSURE FROM THE TOP TO THE PRESSURE
!   P(K) (TOPM,TOPPHI)
      DO 1415 I=MYIS,MYIE
      TOPM(I,1)=PHITMP(I,1)
      TOPPHI(I,1)=PSITMP(I,1)
1415  CONTINUE
      DO 1419 K=2,L
      DO 1417 I=MYIS,MYIE
      TOPM(I,K)=TOPM(I,K-1)+PHITMP(I,K)
      TOPPHI(I,K)=TOPPHI(I,K-1)+PSITMP(I,K)
1417  CONTINUE
1419  CONTINUE
!---TT IS THE CLOUD-FREE CTS TRANSMISSION FUNCTION
      DO 1421 K=1,L
      DO 1421 I=MYIS,MYIE
      FAC1(I,K)=ACOMB(12)*TOPM(I,K)
      FAC2(I,K)=FAC1(I,K)*TOPM(I,K)/(BCOMB(12)*TOPPHI(I,K))
      TT(I,K)=EXP(HM1EZ*(FAC1(I,K)/SQRT(ONE+FAC2(I,K))+ &
                 BETACM(12)*TOTVO2(I,K+1)*SKO2D))
      CTMP(I,K+1)=TT(I,K)*CLDFAC(I,K+1,1)
1421  CONTINUE
!---EXCTS IS THE CTS COOLING RATE ACCUMULATED OVER FREQUENCY BANDS
      DO 1453 K=1,L
      DO 1453 I=MYIS,MYIE
      EXCTS(I,K)=EXCTS(I,K)+SORC(I,K,12)* &
                   (CTMP(I,K+1)-CTMP(I,K))
1453  CONTINUE
!---GXCTS IS THE EXACT CTS TOP FLUX ACCUMULATED OVER FREQUENCY BANDS
      DO 1461 I=MYIS,MYIE
      GXCTS(I)=GXCTS(I)+CLDFAC(I,LP1,1)*(TT(I,L)*SORC(I,L,12)+ &
         (HAF*DELP(I,L)*(TT(I,LM1)*(P(I,LP1)-PRESS(I,L)) + &
         TT(I,L)*(P(I,LP1)+PRESS(I,L)-TWO*P(I,L)))) * &
         (SORC(I,LP1,12)-SORC(I,L,12)))
1461  CONTINUE
!
!-----CALCULATION FOR BAND 13 (990-1070 CM-1; INCLUDES O3))
!
!
!---OBTAIN TEMPERATURE CORRECTION (CAPPHI,CAPPSI),THEN MULTIPLY
!   BY OPTICAL PATH (VAR1,VAR2) TO COMPUTE TEMPERATURE-CORRECTED
!   OPTICAL PATH AND MEAN PRESSURE FOR A LAYER (PHITMP,PSITMP)
      DO 1501 K=1,L
      DO 1501 I=MYIS,MYIE
      F(I,K)=H44194M2*(APCM(13)*X(I,K)+BPCM(13)*Y(I,K))
      FF(I,K)=H44194M2*(ATPCM(13)*X(I,K)+BTPCM(13)*Y(I,K))
      AG(I,K)=(H1P41819+F(I,K))*F(I,K)+ONE
      AGG(I,K)=(H1P41819+FF(I,K))*FF(I,K)+ONE
      PHITMP(I,K)=VAR1(I,K)*(((( AG(I,K)*AG(I,K))**2)**2)**2)
      PSITMP(I,K)=VAR2(I,K)*(((( AGG(I,K)*AGG(I,K))**2)**2)**2)
1501  CONTINUE
!---OBTAIN OPTICAL PATH,MEAN PRESSURE FROM THE TOP TO THE PRESSURE
!   P(K) (TOPM,TOPPHI)
      DO 1515 I=MYIS,MYIE
      TOPM(I,1)=PHITMP(I,1)
      TOPPHI(I,1)=PSITMP(I,1)
1515  CONTINUE
      DO 1519 K=2,L
      DO 1517 I=MYIS,MYIE
      TOPM(I,K)=TOPM(I,K-1)+PHITMP(I,K)
      TOPPHI(I,K)=TOPPHI(I,K-1)+PSITMP(I,K)
1517  CONTINUE
1519  CONTINUE
!---TT IS THE CLOUD-FREE CTS TRANSMISSION FUNCTION
      DO 1521 K=1,L
      DO 1521 I=MYIS,MYIE
      FAC1(I,K)=ACOMB(13)*TOPM(I,K)
      FAC2(I,K)=FAC1(I,K)*TOPM(I,K)/(BCOMB(13)*TOPPHI(I,K))
      TT(I,K)=EXP(HM1EZ*(FAC1(I,K)/SQRT(ONE+FAC2(I,K))+ &
                 BETACM(13)*TOTVO2(I,K+1)*SKO2D+TO3SPC(I,K)))
      CTMP(I,K+1)=TT(I,K)*CLDFAC(I,K+1,1)
1521  CONTINUE
!---EXCTS IS THE CTS COOLING RATE ACCUMULATED OVER FREQUENCY BANDS
      DO 1553 K=1,L
      DO 1553 I=MYIS,MYIE
      EXCTS(I,K)=EXCTS(I,K)+SORC(I,K,13)* &
                   (CTMP(I,K+1)-CTMP(I,K))
1553  CONTINUE
!---GXCTS IS THE EXACT CTS TOP FLUX ACCUMULATED OVER FREQUENCY BANDS
      DO 1561 I=MYIS,MYIE
      GXCTS(I)=GXCTS(I)+CLDFAC(I,LP1,1)*(TT(I,L)*SORC(I,L,13)+ &
         (HAF*DELP(I,L)*(TT(I,LM1)*(P(I,LP1)-PRESS(I,L)) + &
         TT(I,L)*(P(I,LP1)+PRESS(I,L)-TWO*P(I,L)))) * &
         (SORC(I,LP1,13)-SORC(I,L,13)))
1561  CONTINUE
!
!-----CALCULATION FOR BAND 14 (1070-1200 CM-1)
!
!
!---OBTAIN TEMPERATURE CORRECTION (CAPPHI,CAPPSI),THEN MULTIPLY
!   BY OPTICAL PATH (VAR1,VAR2) TO COMPUTE TEMPERATURE-CORRECTED
!   OPTICAL PATH AND MEAN PRESSURE FOR A LAYER (PHITMP,PSITMP)
      DO 1601 K=1,L
      DO 1601 I=MYIS,MYIE
      F(I,K)=H44194M2*(APCM(14)*X(I,K)+BPCM(14)*Y(I,K))
      FF(I,K)=H44194M2*(ATPCM(14)*X(I,K)+BTPCM(14)*Y(I,K))
      AG(I,K)=(H1P41819+F(I,K))*F(I,K)+ONE
      AGG(I,K)=(H1P41819+FF(I,K))*FF(I,K)+ONE
      PHITMP(I,K)=VAR1(I,K)*(((( AG(I,K)*AG(I,K))**2)**2)**2)
      PSITMP(I,K)=VAR2(I,K)*(((( AGG(I,K)*AGG(I,K))**2)**2)**2)
1601  CONTINUE
!---OBTAIN OPTICAL PATH,MEAN PRESSURE FROM THE TOP TO THE PRESSURE
!   P(K) (TOPM,TOPPHI)
      DO 1615 I=MYIS,MYIE
      TOPM(I,1)=PHITMP(I,1)
      TOPPHI(I,1)=PSITMP(I,1)
1615  CONTINUE
      DO 1619 K=2,L
      DO 1617 I=MYIS,MYIE
      TOPM(I,K)=TOPM(I,K-1)+PHITMP(I,K)
      TOPPHI(I,K)=TOPPHI(I,K-1)+PSITMP(I,K)
1617  CONTINUE
1619  CONTINUE
!---TT IS THE CLOUD-FREE CTS TRANSMISSION FUNCTION
      DO 1621 K=1,L
      DO 1621 I=MYIS,MYIE
      FAC1(I,K)=ACOMB(14)*TOPM(I,K)
      FAC2(I,K)=FAC1(I,K)*TOPM(I,K)/(BCOMB(14)*TOPPHI(I,K))
      TT(I,K)=EXP(HM1EZ*(FAC1(I,K)/SQRT(ONE+FAC2(I,K))+ &
                 BETACM(14)*TOTVO2(I,K+1)*SKO2D))
      CTMP(I,K+1)=TT(I,K)*CLDFAC(I,K+1,1)
1621  CONTINUE
!---EXCTS IS THE CTS COOLING RATE ACCUMULATED OVER FREQUENCY BANDS
      DO 1653 K=1,L
      DO 1653 I=MYIS,MYIE
      EXCTS(I,K)=EXCTS(I,K)+SORC(I,K,14)* &
                   (CTMP(I,K+1)-CTMP(I,K))
1653  CONTINUE
!---GXCTS IS THE EXACT CTS TOP FLUX ACCUMULATED OVER FREQUENCY BANDS
      DO 1661 I=MYIS,MYIE
      GXCTS(I)=GXCTS(I)+CLDFAC(I,LP1,1)*(TT(I,L)*SORC(I,L,14)+ &
         (HAF*DELP(I,L)*(TT(I,LM1)*(P(I,LP1)-PRESS(I,L)) + &
         TT(I,L)*(P(I,LP1)+PRESS(I,L)-TWO*P(I,L)))) * &
         (SORC(I,LP1,14)-SORC(I,L,14)))
1661  CONTINUE
!
!
!   OBTAIN CTS FLUX AT THE TOP BY INTEGRATION OF HEATING RATES AND
!   USING CTS FLUX AT THE BOTTOM (CURRENT VALUE OF GXCTS). NOTE
!   THAT THE PRESSURE QUANTITIES AND CONVERSION FACTORS HAVE NOT
!   BEEN INCLUDED EITHER IN EXCTS OR IN GXCTS. THESE CANCEL OUT, THUS
!   REDUCING COMPUTATIONS!
      DO 1731 K=1,L
      DO 1731 I=MYIS,MYIE
      GXCTS(I)=GXCTS(I)-EXCTS(I,K)
1731  CONTINUE
!
!   NOW SCALE THE COOLING RATE (EXCTS) BY INCLUDING THE PRESSURE
!   FACTOR (DELP) AND THE CONVERSION FACTOR (RADCON)
      DO 1741 K=1,L
      DO 1741 I=MYIS,MYIE
      EXCTS(I,K)=EXCTS(I,K)*RADCON*DELP(I,K)
1741  CONTINUE
!---THIS IS THE END OF THE EXACT CTS COMPUTATIONS; AT THIS POINT
!   EXCTS HAS ITS APPROPRIATE VALUE.
!
!*** COMPUTE APPROXIMATE CTS HEATING RATES FOR 15UM AND 9.6 UM BANDS
!     (CTSO3)
      DO 1711 K=1,L
      DO 1711 I=MYIS,MYIE
      CTMP2(I,K+1)=CO2SP(I,K+1)*CLDFAC(I,K+1,1)
      CTMP3(I,K+1)=TO3SP(I,K)*CLDFAC(I,K+1,1)
1711  CONTINUE
      DO 1701 K=1,L
      DO 1701 I=MYIS,MYIE
      CTSO3(I,K)=RADCON*DELP(I,K)* &
           (CSOUR(I,K)*(CTMP2(I,K+1)-CTMP2(I,K)) + &
            SORC(I,K,13)*(CTMP3(I,K+1)-CTMP3(I,K)))
1701  CONTINUE

 END SUBROUTINE SPA88
!----------------------------------------------------------------------

 SUBROUTINE E290(EMISSB,EMISS,AVEPHI,KLEN,FXOE2,DTE2, &
!                      T1,T2,T4,                                     &
                       H16E1,HP1,H28E1,HAF,TEN,                      &
                       ids,ide, jds,jde, kds,kde,                    &
                       ims,ime, jms,jme, kms,kme,                    &
                       its,ite, jts,jte, kts,kte                     )
!---------------------------------------------------------------------
 IMPLICIT NONE
!----------------------------------------------------------------------
      INTEGER, INTENT(IN)        :: ids,ide, jds,jde, kds,kde ,      &
                                    ims,ime, jms,jme, kms,kme ,      &
                                    its,ite, jts,jte, kts,kte
      INTEGER, INTENT(IN)        :: KLEN
      REAL, INTENT(IN) :: H16E1,HP1,H28E1,HAF ,TEN
      REAL, INTENT(OUT),DIMENSION(its:ite,kts:kte+1) :: EMISSB
      REAL, INTENT(IN ),DIMENSION(its:ite,kts:kte+1) :: AVEPHI,FXOE2,DTE2

!     REAL, INTENT(IN ), DIMENSION(5040) :: T1,T2,T4

      REAL, INTENT(INOUT), DIMENSION(its:ite,kts:kte+1) :: EMISS

      REAL, DIMENSION(its:ite,kts:kte+1) :: TMP3,DT,FYO,DU
      INTEGER, DIMENSION(its:ite,kts:kte+1) :: IVAL

!     REAL,    DIMENSION(28,180) :: TABLE1,TABLE2,TABLE3
!     EQUIVALENCE (T1(1),TABLE1(1,1)),(T2(1),TABLE2(1,1)), &
!                 (T4(1),TABLE3(1,1))
!     EQUIVALENCE (TMP3,DT)

      INTEGER :: K, I,KP,LLM2,J1,J3,KMAX,KMIN,KCLDS,ICNT,LLM1
      INTEGER :: L,LP1,LP2,LP3,LM1,LM2,LM3,MYIS,MYIE,LLP1,LL,KK

      L=kte
      LP1=L+1;  LP2=L+2;  LP3=L+3; LLP1 = 2*L + 1
      LM1=L-1;  LM2=L-2;  LM3=L-3; LL = 2*L
      LLM2 = LL-2; LLM1=LL-1
      MYIS=its; MYIE=ite


!---FIRST WE OBTAIN THE EMISSIVITIES AS A FUNCTION OF TEMPERATURE
!   (INDEX FXO) AND WATER AMOUNT (INDEX FYO). THIS PART OF THE CODE
!   THUS GENERATES THE E2 FUNCTION.
!
!---CALCULATIONS FOR VARYING KP (FROM KP=K+1 TO LP1, INCLUDING SPECIAL
!   CASE: RESULTS ARE IN EMISS



      DO 132 K=1,LP2-KLEN
      DO 132 I=MYIS,MYIE
      TMP3(I,K)=LOG10(AVEPHI(I,KLEN+K-1))+H16E1
      FYO(I,K)=AINT(TMP3(I,K)*TEN)
      DU(I,K)=TMP3(I,K)-HP1*FYO(I,K)
      FYO(I,K)=H28E1*FYO(I,K)
      IVAL(I,K)=FYO(I,K)+FXOE2(I,KLEN+K-1)
      EMISS(I,KLEN+K-1)=T1(IVAL(I,K))+DU(I,K)*T2(IVAL(I,K)) & 
                                 +DTE2(I,KLEN+K-1)*T4(IVAL(I,K))
132   CONTINUE
!---THE SPECIAL CASE EMISS(I,L) (LAYER KP) IS OBTAINED NOW
!   BY AVERAGING THE VALUES FOR L AND LP1:
      DO 1344 I=MYIS,MYIE
      EMISS(I,L)=HAF*(EMISS(I,L)+EMISS(I,LP1))
1344  CONTINUE
!---NOTE THAT EMISS(I,LP1) IS NOT USEFUL AFTER THIS POINT.
!
!---CALCULATIONS FOR KP=KLEN AND VARYING K; RESULTS ARE IN EMISSB.
!  IN THIS CASE, THE TEMPERATURE INDEX IS UNCHANGED, ALWAYS BEING
!  FXO(I,KLEN-1); THE WATER INDEX CHANGES, BUT IS SYMMETRICAL WITH
!  THAT FOR THE VARYING KP CASE.NOTE THAT THE SPECIAL CASE IS NOT
!  INVOLVED HERE.
!     (FIXED LEVEL) K VARIES FROM (KLEN+1) TO LP1; RESULTS ARE IN
!   EMISSB(I,(KLEN) TO L)
      DO 142 K=1,LP1-KLEN
      DO 142 I=MYIS,MYIE
      DT(I,K)=DTE2(I,KLEN-1)
      IVAL(I,K)=FYO(I,K)+FXOE2(I,KLEN-1)
142   CONTINUE
!
      DO 234 K=1,LP1-KLEN
      DO 234 I=MYIS,MYIE
      EMISSB(I,KLEN+K-1)=T1(IVAL(I,K))+DU(I,K)*T2(IVAL(I,K)) &
                                      +DT(I,K)*T4(IVAL(I,K))
234   CONTINUE

 END SUBROUTINE E290

!---------------------------------------------------------------------

  SUBROUTINE E2SPEC(EMISS,AVEPHI,FXOSP,DTSP,                         &
!                      T1,T2,T4,                                     &
                       H16E1,TEN,H28E1,HP1,                          &
                       ids,ide, jds,jde, kds,kde,                    &
                       ims,ime, jms,jme, kms,kme,                    &
                       its,ite, jts,jte, kts,kte                     )
!---------------------------------------------------------------------
 IMPLICIT NONE
!----------------------------------------------------------------------
      INTEGER, INTENT(IN)        :: ids,ide, jds,jde, kds,kde ,      &
                                    ims,ime, jms,jme, kms,kme ,      &
                                    its,ite, jts,jte, kts,kte
      REAL,INTENT(IN ) :: H16E1,TEN,H28E1,HP1  
      REAL,INTENT(INOUT),DIMENSION(its:ite,kts:kte+1) :: EMISS
      REAL,INTENT(IN ),DIMENSION(its:ite,kts:kte+1) :: AVEPHI
      REAL,INTENT(IN ),DIMENSION(its:ite,2) :: FXOSP,DTSP

!     REAL, INTENT(IN ),DIMENSION(5040) :: T1,T2,T4

!     REAL, DIMENSION(28,180) :: TABLE1,TABLE2,TABLE3
!     EQUIVALENCE (T1(1),TABLE1(1,1)),(T2(1),TABLE2(1,1)), &
!                 (T4(1),TABLE3(1,1))

      INTEGER :: K,I,MYIS,MYIE

      REAL,    DIMENSION(its:ite,kts:kte+1) :: TMP3,FYO,DU
      INTEGER, DIMENSION(its:ite,kts:kte+1) :: IVAL

      MYIS=its
      MYIE=ite

      DO 132 K=1,2
      DO 132 I=MYIS,MYIE
      TMP3(I,K)=LOG10(AVEPHI(I,K))+H16E1
      FYO(I,K)=AINT(TMP3(I,K)*TEN)
      DU(I,K)=TMP3(I,K)-HP1*FYO(I,K)
      IVAL(I,K)=H28E1*FYO(I,K)+FXOSP(I,K)
      EMISS(I,K)=T1(IVAL(I,K))+DU(I,K)*T2(IVAL(I,K))+ &
                               DTSP(I,K)*T4(IVAL(I,K))
132   CONTINUE

  END SUBROUTINE E2SPEC

!---------------------------------------------------------------------

! SUBROUTINE E3V88(EMV,TV,AV,EM3V,            &
  SUBROUTINE E3V88(EMV,TV,AV, &
                       TEN,HP1,H28E1,H16E1,  &
                       ids,ide, jds,jde, kds,kde,                    &
                       ims,ime, jms,jme, kms,kme,                    &
                       its,ite, jts,jte, kts,kte                     )
!---------------------------------------------------------------------
 IMPLICIT NONE
!----------------------------------------------------------------------
      INTEGER, INTENT(IN)        :: ids,ide, jds,jde, kds,kde ,      &
                                    ims,ime, jms,jme, kms,kme ,      &
                                    its,ite, jts,jte, kts,kte
      REAL,    INTENT(IN)  :: TEN,HP1,H28E1,H16E1 
!-----------------------------------------------------------------------
      REAL, INTENT(OUT), DIMENSION(its:ite,kts:kte*2+1) :: EMV
      REAL, INTENT(IN),  DIMENSION(its:ite,kts:kte*2+1) :: TV,AV
!     REAL, INTENT(IN),  DIMENSION(5040) :: EM3V

      REAL,DIMENSION(its:ite,kts:kte*2+1) ::FXO,TMP3,DT,WW1,WW2,DU,&
                                            FYO
!     REAL, DIMENSION(5040) :: EM3V

!     EQUIVALENCE (EM3V(1),EM3(1,1))

      INTEGER,DIMENSION(its:ite,kts:kte*2+1) ::IT

      INTEGER :: LLP1,I,K,MYIS,MYIE ,L
      L = kte
      LLP1 = 2*L + 1
      MYIS=its; MYIE=ite

!---THE FOLLOWING LOOP REPLACES A DOUBLE LOOP OVER I (1-IMAX) AND
!   K (1-LLP1)

      DO 203 K=1,LLP1
      DO 203 I=MYIS,MYIE
        FXO(I,K)=AINT(TV(I,K)*HP1)
        TMP3(I,K)=LOG10(AV(I,K))+H16E1
        DT(I,K)=TV(I,K)-TEN*FXO(I,K)
        FYO(I,K)=AINT(TMP3(I,K)*TEN)
        DU(I,K)=TMP3(I,K)-HP1*FYO(I,K)
!---OBTAIN INDEX FOR TABLE LOOKUP; THIS VALUE WILL HAVE TO BE
!   DECREMENTED BY 9 TO ACCOUNT FOR TABLE TEMPS STARTING AT 100K.
        IT(I,K)=FXO(I,K)+FYO(I,K)*H28E1
        WW1(I,K)=TEN-DT(I,K)
        WW2(I,K)=HP1-DU(I,K)
	if (I .eq. 50) then
!	write(0,*) 'WW1, WW2: ', I,K,WW1(I,K), WW2(I,K)
!	write(0,*) 'DT, DU: ', I,K, DT(I,K), DU(I,K)
!	write(0,*) 'EM3Vs: ', EM3V(IT(I,K)-9), EM3V(IT(I,K)-8), EM3V(IT(I,K)+19), EM3V(IT(I,K)+20)
	endif
        EMV(I,K)=WW1(I,K)*WW2(I,K)*EM3V(IT(I,K)-9)+ &
                 WW2(I,K)*DT(I,K)*EM3V(IT(I,K)-8)+ & 
                 WW1(I,K)*DU(I,K)*EM3V(IT(I,K)+19)+ & 
                 DT(I,K)*DU(I,K)*EM3V(IT(I,K)+20)
	if (I .eq. 50) then
!	write(0,*) 'I,K, EMV(I,K): ', I,K, EMV(I,K)
	endif
203   CONTINUE

  END SUBROUTINE E3V88
!-----------------------------------------------------------------------

  SUBROUTINE SWR93(FSWC,HSWC,UFSWC,DFSWC,FSWL,HSWL,UFSWL,             &
                       DFSWL,                                         &
                       PRESS,COSZRO,TAUDAR,RH2O,RRCO2,SSOLAR,QO3,     &
                       NCLDS,KTOPSW,KBTMSW,CAMT,CRR,CTT,              &
                       ALVB,ALNB,ALVD,ALND,GDFVB,GDFNB,GDFVD,GDFND,   &
!                      UCO2,UO3,TUCO2,TUO3,TDO3,TDCO2,                &
                       ABCFF,PWTS,                                    &
                       H35E1,H1224E3,ONE,ZERO,HAF,H69766E5,HP219,     &
                       HP816,RRAYAV,GINV,CFCO2,CFO3,                  &
                       TWO,H235M3,HP26,H129M2,H75826M4,H1036E2,       &
                       H1P082,HMP805,H1386E2,H658M2,H2118M2,H42M2,    &
                       H323M4,HM1EZ,DIFFCTR,O3DIFCTR,FIFTY,RADCON,    &
                       ids,ide, jds,jde, kds,kde,                     &
                       ims,ime, jms,jme, kms,kme,                     &
                       its,ite, jts,jte, kts,kte,jndx                 )
!----------------------------------------------------------------------
 IMPLICIT NONE
!----------------------------------------------------------------------
      INTEGER, INTENT(IN)        :: ids,ide, jds,jde, kds,kde ,      &
                                    ims,ime, jms,jme, kms,kme ,      &
                                    its,ite, jts,jte, kts,kte ,jndx
      REAL,INTENT(IN) :: RRCO2,SSOLAR
      REAL,INTENT(IN) :: H35E1,H1224E3,ONE,ZERO,HAF,H69766E5,HP219,HP816,RRAYAV,&
                         GINV,CFCO2,CFO3
      REAL,INTENT(IN) :: TWO,H235M3,HP26,H129M2,H75826M4,H1036E2  
      REAL,INTENT(IN) :: H1P082,HMP805,H1386E2,H658M2,H2118M2,H42M2,H323M4,HM1EZ
      REAL,INTENT(IN) :: DIFFCTR,O3DIFCTR,FIFTY,RADCON
!----------------------------------------------------------------------
      INTEGER, PARAMETER :: NB=12
      REAL,    INTENT(IN ),DIMENSION(its:ite,kts:kte+1) :: PRESS,CAMT
      REAL,    INTENT(IN ),DIMENSION(its:ite,kts:kte) :: RH2O,QO3
      REAL,    INTENT(IN ),DIMENSION(its:ite) :: COSZRO,TAUDAR,ALVB,ALVD,ALNB,ALND
      INTEGER, INTENT(IN ),DIMENSION(its:ite) :: NCLDS
      INTEGER, INTENT(IN ),DIMENSION(its:ite,kts:kte+1) ::KTOPSW,KBTMSW
      REAL, INTENT(IN ),DIMENSION(its:ite,NB,kts:kte+1) ::CRR,CTT
           
      REAL, INTENT(OUT),DIMENSION(its:ite,kts:kte+1) ::     &
                                       FSWC,HSWC,UFSWC,DFSWC,FSWL,HSWL,UFSWL,DFSWL
      REAL, INTENT(OUT),DIMENSION(its:ite) :: GDFVB,GDFVD,GDFNB,GDFND
      REAL, INTENT(IN), DIMENSION(NB) :: ABCFF,PWTS

!     REAL, INTENT(IN), DIMENSION(its:ite,kts:kte*2+2) :: UCO2,UO3
!     REAL, INTENT(IN), DIMENSION(its:ite,kts:kte+1)   :: TUCO2,TUO3,TDO3,TDCO2

      REAL, DIMENSION(its:ite,kts:kte*2+2) :: UCO2,UO3
      REAL, DIMENSION(its:ite,kts:kte+1)   :: TUCO2,TUO3,TDO3,TDCO2

      REAL, DIMENSION(its:ite,kts:kte*2+2) :: TCO2,TO3
      REAL, DIMENSION(its:ite,kts:kte+1) :: PP,DP,PR2,DU,DUCO2,DUO3,UD,TTD
      REAL, DIMENSION(its:ite,kts:kte+1) :: UDCO2,UDO3,UR,URCO2,URO3,TTU
      REAL, DIMENSION(its:ite,kts:kte+1) :: DFN,UFN
      REAL, DIMENSION(its:ite,kts:kte+1) :: XAMT,FF,FFCO2,FFO3,CR,CT
      REAL, DIMENSION(its:ite,kts:kte+1) :: PPTOP,DPCLD,TTDB1,TTUB1
      REAL, DIMENSION(its:ite,kts:kte+1) :: TDCL1,TUCL1,TDCL2,DFNTRN,  &
                                            UFNTRN,TCLU,TCLD,ALFA,ALFAU, &
                                            UFNCLU,DFNCLU

      REAL, DIMENSION(its:ite,NB) :: DFNTOP
      REAL, DIMENSION(its:ite) :: SECZ,TMP1,RRAY,REFL,REFL2,CCMAX

!                    EQUIVALENCE &
!       (UDO3,UO3(its,1),DFNCLU), (URO3,UO3(its,kte+2), UFNCLU) &
!     , (UDCO2,UCO2(its,1),TCLD), (URCO2,UCO2(its,kte+2), TCLU) &
!     , (TDO3 ,TO3(its,1),DFNTRN),(TUO3,TO3(its,kte+2), UFNTRN) &
!     , (TDCO2,TCO2(its,1)      ),(TUCO2,TCO2(its,kte+2)        ) &
!     , (FF   , ALFA ),   (FFCO2 , ALFAU ),   (FFO3  , TTDB1 ) &
!     , (DU   , TTUB1),   (DUCO2 , TUCL1 ),   (DUO3  , TDCL1 ) &
!     , (PR2  , TDCL2)

!                    EQUIVALENCE &
!       (UDO3,DFNCLU), (URO3,UFNCLU) &
!     , (UDCO2,TCLD ), (URCO2,TCLU) &
!     , (TDO3 ,DFNTRN),(TUO3,UFNTRN) &
!!    , (TDCO2,TCO2(its,1)      ),(TUCO2,TCO2(its,kte+2)        ) &
!     , (FF   , ALFA ),   (FFCO2 , ALFAU ),   (FFO3  , TTDB1 ) &
!     , (DU   , TTUB1),   (DUCO2 , TUCL1 ),   (DUO3  , TDCL1 ) &
!     , (PR2  , TDCL2)

      INTEGER :: K,I,KP,N,IP,MYIS1,KCLDS,NNCLDS,JTOP,KK,J2,J3,J1
      INTEGER :: L,LP1,LP2,LP3,LM1,LM2,LM3,MYIS,MYIE,LLP1,LL
      REAL    :: DENOM,HTEMP,TEMPF,TEMPG

      L=kte
      LP1=L+1;  LP2=L+2;  LP3=L+3; LLP1 = 2*L + 1
      LM1=L-1;  LM2=L-2;  LM3=L-3; LL = 2*L
      MYIS=its; MYIE=ite
      MYIS1=MYIS+1    ! ??

      DO 100 I=MYIS,MYIE
        SECZ(I) = H35E1/SQRT(H1224E3*COSZRO(I)*COSZRO(I)+ONE)
        PP(I,1)   = ZERO
        PP(I,LP1) = PRESS(I,LP1)
        TMP1(I)  = ONE/PRESS(I,LP1)
100   CONTINUE
      DO 110 K=1,LM1
      DO 110 I=MYIS,MYIE
        PP(I,K+1) = HAF*(PRESS(I,K+1)+PRESS(I,K))
110   CONTINUE
      DO 120 K=1,L
      DO 120 I=MYIS,MYIE
        DP (I,K) = PP(I,K+1)-PP(I,K)
        PR2(I,K) = HAF*(PP(I,K)+PP(I,K+1))
120   CONTINUE
      DO 130 K=1,L
      DO 130 I=MYIS,MYIE
        PR2(I,K) = PR2(I,K)*TMP1(I)
130   CONTINUE
!     CALCULATE ENTERING FLUX AT THE TOP FOR EACH BAND(IN CGS UNITS)
      DO 140 N=1,NB
      DO 140 IP=MYIS,MYIE
        DFNTOP(IP,N) = SSOLAR*H69766E5*COSZRO(IP)*TAUDAR(IP)*PWTS(N)
140   CONTINUE
!     EXECUTE THE LACIS-HANSEN REFLECTIVITY PARAMETERIZATION
!     FOR THE VISIBLE BAND
      DO 150 I=MYIS,MYIE
        RRAY(I) = HP219/(ONE+HP816*COSZRO(I))
        REFL(I) = RRAY(I) + (ONE-RRAY(I))*(ONE-RRAYAV)*ALVB(I)/ &
                  (ONE-ALVD(I)*RRAYAV)
150   CONTINUE
      DO 155 I=MYIS,MYIE
        RRAY(I) = 0.104/(ONE+4.8*COSZRO(I))
        REFL2(I)= RRAY(I) + (ONE-RRAY(I))*(ONE-0.093)*ALVB(I)/ &
                  (ONE-ALVD(I)*0.093)
155   CONTINUE
!     CALCULATE PRESSURE-WEIGHTED OPTICAL PATHS FOR EACH LAYER
!     IN UNITS OF CM-ATM. PRESSURE WEIGHTING IS USING PR2.
!     DU= VALUE FOR H2O;DUCO2 FOR CO2;DUO3 FOR O3.
      DO 160 K=1,L
      DO 160 I=MYIS,MYIE
        DU   (I,K) = GINV*RH2O(I,K)*DP(I,K)*PR2(I,K)
        DUCO2(I,K) = (RRCO2*GINV*CFCO2)*DP(I,K)*PR2(I,K)
        DUO3 (I,K) = (GINV*CFO3)*QO3(I,K)*DP(I,K)
160   CONTINUE
!
!                 CALCULATE CLEAR SKY SW FLUX
!
!     OBTAIN THE OPTICAL PATH FROM THE TOP OF THE ATMOSPHERE TO THE
!     FLUX PRESSURE. ANGULAR FACTORS ARE NOW INCLUDED. UD=DOWNWARD
!     PATH FOR H2O,WIGTH UR THE UPWARD PATH FOR H2O. CORRESPONDING
!     QUANTITIES FOR CO2,O3 ARE UDCO2/URCO2 AND UDO3/URO3.
      DO 200 IP=MYIS,MYIE
        UD   (IP,1) = ZERO
        UDCO2(IP,1) = ZERO
        UDO3 (IP,1) = ZERO
! SH
        UO3  (IP,1) = UDO3 (IP,1)
        UCO2 (IP,1) = UDCO2(IP,1)

200   CONTINUE
      DO 210 K=2,LP1
      DO 210 I=MYIS,MYIE
        UD   (I,K) = UD   (I,K-1)+DU   (I,K-1)*SECZ(I)
        UDCO2(I,K) = UDCO2(I,K-1)+DUCO2(I,K-1)*SECZ(I)
        UDO3 (I,K) = UDO3 (I,K-1)+DUO3 (I,K-1)*SECZ(I)
! SH
        UO3  (I,K) = UDO3 (I,K)
        UCO2 (I,K) = UDCO2(I,K)

210   CONTINUE
      DO 220 IP=MYIS,MYIE
        UR   (IP,LP1) = UD   (IP,LP1)
        URCO2(IP,LP1) = UDCO2(IP,LP1)
        URO3 (IP,LP1) = UDO3 (IP,LP1)
! SH
        UO3  (IP,LP1+LP1) = URO3 (IP,LP1) 
        UCO2 (IP,LP1+LP1) = URCO2(IP,LP1)

220   CONTINUE
      DO 230 K=L,1,-1
      DO 230 IP=MYIS,MYIE
        UR   (IP,K) = UR   (IP,K+1)+DU   (IP,K)*DIFFCTR
        URCO2(IP,K) = URCO2(IP,K+1)+DUCO2(IP,K)*DIFFCTR
        URO3 (IP,K) = URO3 (IP,K+1)+DUO3 (IP,K)*O3DIFCTR
! SH
        UO3 (IP,LP1+K) = URO3 (IP,K)
        UCO2(IP,LP1+K) = URCO2(IP,K)

230   CONTINUE
!     CALCULATE CO2 ABSORPTIONS . THEY WILL BE USED IN NEAR INFRARED
!     BANDS.SINCE THE ABSORPTION AMOUNT IS GIVEN (IN THE FORMULA USED
!     BELOW, DERIVED FROM SASAMORI) IN TERMS OF THE TOTAL SOLAR FLUX,
!     AND THE ABSORPTION IS ONLY INCLUDED IN THE NEAR IR (50 PERCENT
!     OF THE SOLAR SPECTRUM), THE ABSORPTIONS ARE MULTIPLIED BY 2.
!       SINCE CODE ACTUALLY REQUIRES TRANSMISSIONS, THESE ARE THE
!     VALUES ACTUALLY STORED IN TCO2.
      DO 240 K=1,LL
      DO 240 I=MYIS,MYIE
       TCO2(I,K+1)=ONE-TWO*(H235M3*EXP(HP26*LOG(UCO2(I,K+1)+H129M2)) &
                             -H75826M4)
240   CONTINUE

! SH
      DO 241 K=1,L
      DO 241 I=MYIS,MYIE
        TDCO2(I,K+1)=TCO2(I,K+1)
241   CONTINUE
      DO 242 K=1,L
      DO 242 I=MYIS,MYIE
        TUCO2(I,K)=TCO2(I,LP1+K)
242   CONTINUE

!     NOW CALCULATE OZONE ABSORPTIONS. THESE WILL BE USED IN
!     THE VISIBLE BAND.JUST AS IN THE CO2 CASE, SINCE THIS BAND IS
!     50 PERCENT OF THE SOLAR SPECTRUM,THE ABSORPTIONS ARE MULTIPLIED
!     BY 2. THE TRANSMISSIONS ARE STORED IN TO3.
      HTEMP = H1036E2*H1036E2*H1036E2
      DO 250 K=1,LL
      DO 250 I=MYIS,MYIE
        TO3(I,K+1)=ONE-TWO*UO3(I,K+1)* &
                  (H1P082*EXP(HMP805*LOG(ONE+H1386E2*UO3(I,K+1)))+ &
                  H658M2/(ONE+HTEMP*UO3(I,K+1)*UO3(I,K+1)*UO3(I,K+1))+ &
                  H2118M2/(ONE+UO3(I,K+1)*(H42M2+H323M4*UO3(I,K+1))))
250   CONTINUE

! SH
      DO 251 K=1,L
      DO 251 I=MYIS,MYIE
        TDO3(I,K+1)=TO3(I,K+1)
251   CONTINUE
      DO 252 K=1,L
      DO 252 I=MYIS,MYIE
        TUO3(I,K)=TO3(I,LP1+K)
252   CONTINUE


!   START FREQUENCY LOOP (ON N) HERE
!
!--- BAND 1 (VISIBLE) INCLUDES O3 AND H2O ABSORPTION
      DO 260 K=1,L
      DO 260 I=MYIS,MYIE
        TTD(I,K+1) = EXP(HM1EZ*MIN(FIFTY,ABCFF(1)*UD(I,K+1)))
        TTU(I,K) = EXP(HM1EZ*MIN(FIFTY,ABCFF(1)*UR(I,K)))
        DFN(I,K+1) = TTD(I,K+1)*TDO3(I,K+1)
        UFN(I,K) = TTU(I,K)*TUO3(I,K)
260   CONTINUE
      DO 270 I=MYIS,MYIE
        DFN(I,1)   = ONE
        UFN(I,LP1) = DFN(I,LP1)
270   CONTINUE
!     SCALE VISIBLE BAND FLUXES BY SOLAR FLUX AT THE TOP OF THE
!     ATMOSPHERE (DFNTOP(I,1))
!     DFSW/UFSW WILL BE THE FLUXES, SUMMED OVER ALL BANDS
      DO 280  K=1,LP1
      DO 280  I=MYIS,MYIE
        DFSWL(I,K) =         DFN(I,K)*DFNTOP(I,1)
        UFSWL(I,K) = REFL(I)*UFN(I,K)*DFNTOP(I,1)
280   CONTINUE
      DO 285 I=MYIS,MYIE
        GDFVB(I) = DFSWL(I,LP1)*EXP(-0.15746*SECZ(I))
        GDFVD(I) = ((ONE-REFL2(I))*DFSWL(I,LP1) - &
                    (ONE-ALVB(I)) *GDFVB(I)) / (ONE-ALVD(I))
        GDFNB(I) = ZERO
        GDFND(I) = ZERO
285   CONTINUE
!---NOW OBTAIN FLUXES FOR THE NEAR IR BANDS. THE METHODS ARE THE SAME
!   AS FOR THE VISIBLE BAND, EXCEPT THAT THE REFLECTION AND
!   TRANSMISSION COEFFICIENTS (OBTAINED BELOW) ARE DIFFERENT, AS
!   RAYLEIGH SCATTERING NEED NOT BE CONSIDERED.
      DO 350 N=2,NB
        IF (N.EQ.2) THEN
!   THE WATER VAPOR TRANSMISSION FUNCTION FOR BAND 2 IS EQUAL TO
!   THAT OF BAND 1 (SAVED AS TTD,TTU)
!--- BAND 2-9 (NEAR-IR) INCLUDES O3, CO2 AND H2O ABSORPTION
          DO 290 K=1,L
          DO 290 I=MYIS,MYIE
            DFN(I,K+1) = TTD(I,K+1)*TDCO2(I,K+1)
            UFN(I,K) = TTU(I,K)*TUCO2(I,K)
290       CONTINUE
        ELSE
!   CALCULATE WATER VAPOR TRANSMISSION FUNCTIONS FOR NEAR INFRARED
!   BANDS. INCLUDE CO2 TRANSMISSION (TDCO2/TUCO2), WHICH
!   IS THE SAME FOR ALL INFRARED BANDS.
          DO 300 K=1,L
          DO 300 I=MYIS,MYIE
            DFN(I,K+1)=EXP(HM1EZ*MIN(FIFTY,ABCFF(N)*UD(I,K+1))) &
                       *TDCO2(I,K+1)
            UFN(I,K)=EXP(HM1EZ*MIN(FIFTY,ABCFF(N)*UR(I,K))) &
                     *TUCO2(I,K)
300       CONTINUE
        ENDIF
!---AT THIS POINT,INCLUDE DFN(1),UFN(LP1), NOTING THAT DFN(1)=1 FOR
!   ALL BANDS, AND THAT UFN(LP1)=DFN(LP1) FOR ALL BANDS.
        DO 310 I=MYIS,MYIE
          DFN(I,1)   = ONE
          UFN(I,LP1) = DFN(I,LP1)
310     CONTINUE
!     SCALE THE PREVIOUSLY COMPUTED FLUXES BY THE FLUX AT THE TOP
!     AND SUM OVER BANDS
        DO 320 K=1,LP1
        DO 320 I=MYIS,MYIE
          DFSWL(I,K) = DFSWL(I,K) +         DFN(I,K)*DFNTOP(I,N)
          UFSWL(I,K) = UFSWL(I,K) + ALNB(I)*UFN(I,K)*DFNTOP(I,N)
320     CONTINUE
        DO 330 I=MYIS,MYIE
          GDFNB(I) = GDFNB(I) + DFN(I,LP1)*DFNTOP(I,N)
330     CONTINUE
350   CONTINUE
      DO 360 K=1,LP1
      DO 360 I=MYIS,MYIE
        FSWL(I,K) = UFSWL(I,K)-DFSWL(I,K)
360   CONTINUE
      DO 370 K=1,L
      DO 370 I=MYIS,MYIE
        HSWL(I,K)=RADCON*(FSWL(I,K+1)-FSWL(I,K))/DP(I,K)
370   CONTINUE
!
!---END OF FREQUENCY LOOP (OVER N)
!
!                 CALCULATE CLOUDY SKY SW FLUX
!
      KCLDS=NCLDS(MYIS)
      DO 400 I=MYIS1,MYIE
        KCLDS=MAX(NCLDS(I),KCLDS)
400   CONTINUE
        DO 410 K=1,LP1
        DO 410 I=MYIS,MYIE
          DFSWC(I,K) = DFSWL(I,K)
          UFSWC(I,K) = UFSWL(I,K)
          FSWC (I,K) = FSWL (I,K)
410     CONTINUE
        DO 420 K=1,L
        DO 420 I=MYIS,MYIE
          HSWC(I,K) = HSWL(I,K)
420     CONTINUE
!*******************************************************************
      IF (KCLDS .EQ. 0)  RETURN
!*******************************************************************
      DO 430 K=1,LP1
      DO 430 I=MYIS,MYIE
        XAMT(I,K) = CAMT(I,K)
430   CONTINUE
      DO 470 I=MYIS,MYIE
        NNCLDS   = NCLDS(I)
        CCMAX(I) = ZERO
        IF (NNCLDS .LE. 0) GO TO 470
        CCMAX(I) = ONE
        DO 450 K=1,NNCLDS
          CCMAX(I) = CCMAX(I) * (ONE - CAMT(I,K+1))
450     CONTINUE
        CCMAX(I) = ONE - CCMAX(I)
        IF (CCMAX(I) .GT. ZERO) THEN
          DO 460 K=1,NNCLDS
            XAMT(I,K+1) = CAMT(I,K+1)/CCMAX(I)
460       CONTINUE
        END IF
470   CONTINUE
      DO 480 K=1,LP1
      DO 480 I=MYIS,MYIE
        FF   (I,K) = DIFFCTR
        FFCO2(I,K) = DIFFCTR
        FFO3 (I,K) = O3DIFCTR
480   CONTINUE
      DO 490 IP=MYIS,MYIE
        JTOP = KTOPSW(IP,NCLDS(IP)+1)
      DO 490 K=1,JTOP
        FF   (IP,K) = SECZ(IP)
        FFCO2(IP,K) = SECZ(IP)
        FFO3 (IP,K) = SECZ(IP)
490   CONTINUE
      DO 500 I=MYIS,MYIE
        RRAY(I) = HP219/(ONE+HP816*COSZRO(I))
        REFL(I) = RRAY(I) + (ONE-RRAY(I))*(ONE-RRAYAV)*ALVD(I)/ &
                  (ONE-ALVD(I)*RRAYAV)
500   CONTINUE
      DO 510 IP=MYIS,MYIE
        UD   (IP,1) = ZERO
        UDCO2(IP,1) = ZERO
        UDO3 (IP,1) = ZERO
! SH
        UO3  (IP,1) = UDO3 (IP,1)
        UCO2 (IP,1) = UDCO2(IP,1)

510   CONTINUE
      DO 520 K=2,LP1
      DO 520 I=MYIS,MYIE
        UD   (I,K) = UD   (I,K-1)+DU   (I,K-1)*FF   (I,K)
        UDCO2(I,K) = UDCO2(I,K-1)+DUCO2(I,K-1)*FFCO2(I,K)
        UDO3 (I,K) = UDO3 (I,K-1)+DUO3 (I,K-1)*FFO3 (I,K)
! SH
        UO3 (I,K)  = UDO3 (I,K)
        UCO2(I,K)  = UDCO2(I,K)

520   CONTINUE
      DO 530 IP=MYIS,MYIE
        UR   (IP,LP1) = UD   (IP,LP1)
        URCO2(IP,LP1) = UDCO2(IP,LP1)
        URO3 (IP,LP1) = UDO3 (IP,LP1)
! SH
        UO3  (IP,LP1+LP1) = URO3 (IP,LP1)
        UCO2 (IP,LP1+LP1) = URCO2(IP,LP1)

530   CONTINUE
      DO 540 K=L,1,-1
      DO 540 IP=MYIS,MYIE
        UR   (IP,K) = UR   (IP,K+1)+DU   (IP,K)*DIFFCTR
        URCO2(IP,K) = URCO2(IP,K+1)+DUCO2(IP,K)*DIFFCTR
        URO3 (IP,K) = URO3 (IP,K+1)+DUO3 (IP,K)*O3DIFCTR
! SH
        UO3 (IP,LP1+K) = URO3 (IP,K)
        UCO2(IP,LP1+K) = URCO2(IP,K)

540   CONTINUE
      DO 550 K=1,LL
      DO 550 I=MYIS,MYIE
        TCO2(I,K+1)=ONE-TWO*(H235M3*EXP(HP26*LOG(UCO2(I,K+1)+H129M2)) &
                              -H75826M4)
550   CONTINUE
! SH
      DO 551 K=1,L
      DO 551 I=MYIS,MYIE
        TDCO2(I,K+1)=TCO2(I,K+1)
551   CONTINUE
      DO 552 K=1,L
      DO 552 I=MYIS,MYIE
        TUCO2(I,K)=TCO2(I,LP1+K)
552   CONTINUE

      DO 560 K=1,LL
      DO 560 I=MYIS,MYIE
        TO3(I,K+1)=ONE-TWO*UO3(I,K+1)* &
                 (H1P082*EXP(HMP805*LOG(ONE+H1386E2*UO3(I,K+1)))+ &
                H658M2/(ONE+HTEMP*UO3(I,K+1)*UO3(I,K+1)*UO3(I,K+1))+ &
                H2118M2/(ONE+UO3(I,K+1)*(H42M2+H323M4*UO3(I,K+1))))
560   CONTINUE
! SH
      DO 561 K=1,L
      DO 561 I=MYIS,MYIE
        TDO3(I,K+1)=TO3(I,K+1)
561   CONTINUE
      DO 562 K=1,L
      DO 562 I=MYIS,MYIE
        TUO3(I,K)=TO3(I,LP1+K)
562   CONTINUE

!********************************************************************
!---THE FIRST CLOUD IS THE GROUND; ITS PROPERTIES ARE GIVEN
!   BY REFL (THE TRANSMISSION (0) IS IRRELEVANT FOR NOW!).
!********************************************************************
      DO 570 I=MYIS,MYIE
        CR(I,1) = REFL(I)
570   CONTINUE
!***OBTAIN CLOUD REFLECTION AND TRANSMISSION COEFFICIENTS FOR
!   REMAINING CLOUDS (IF ANY) IN THE VISIBLE BAND
!---THE MAXIMUM NO OF CLOUDS IN THE ROW (KCLDS) IS USED. THIS CREATES
!   EXTRA WORK (MAY BE REMOVED IN A SUBSEQUENT UPDATE).
      DO 581 I=MYIS,MYIE
      KCLDS=NCLDS(I)
      IF(KCLDS.EQ.0) GO TO 581
      DO 580 KK=2,KCLDS+1
        CR(I,KK) = CRR(I,1,KK)*XAMT(I,KK)
        CT(I,KK) = ONE - (ONE-CTT(I,1,KK))*XAMT(I,KK)
580   CONTINUE
581   CONTINUE
!---OBTAIN THE PRESSURE AT THE TOP,BOTTOM AND THE THICKNESS OF
!   "THICK" CLOUDS (THOSE AT LEAST 2 LAYERS THICK). THIS IS USED
!   LATER IS OBTAINING FLUXES INSIDE THE THICK CLOUDS, FOR ALL
!   FREQUENCY BANDS.
      DO 591 I=MYIS,MYIE
      KCLDS=NCLDS(I)
      IF(KCLDS.EQ.0) GO TO 591
      DO 590 KK=1,KCLDS
        IF ((KBTMSW(I,KK+1)-1).GT.KTOPSW(I,KK+1)) THEN
           PPTOP(I,KK)=PP(I,KTOPSW(I,KK+1))
           DPCLD(I,KK)=ONE/(PPTOP(I,KK)-PP(I,KBTMSW(I,KK+1)))
        ENDIF
590   CONTINUE
591   CONTINUE
      DO 600 K=1,L
      DO 600 I=MYIS,MYIE
        TTDB1(I,K+1) = EXP(HM1EZ*MIN(FIFTY,ABCFF(1)*UD(I,K+1)))
        TTUB1(I,K) = EXP(HM1EZ*MIN(FIFTY,ABCFF(1)*UR(I,K)))
        TTD  (I,K+1) = TTDB1(I,K+1)*TDO3(I,K+1)
        TTU  (I,K) = TTUB1(I,K)*TUO3(I,K)
600   CONTINUE
      DO 610 I=MYIS,MYIE
        TTD(I,1)   = ONE
        TTU(I,LP1) = TTD(I,LP1)
610   CONTINUE
!***FOR EXECUTION OF THE CLOUD LOOP, IT IS NECESSARY TO SEPARATE OUT
!   TRANSMISSION FCTNS AT THE TOP AND BOTTOM OF THE CLOUDS, FOR
!   EACH BAND N. THE REQUIRED QUANTITIES ARE:
!      TTD(I,KTOPSW(I,K),N)  K RUNS FROM 1 TO NCLDS(I)+1:
!      TTU(I,KTOPSW(I,K),N)  K RUNS FROM 1 TO NCLDS(I)+1:
!      TTD(I,KBTMSW(I,K),N)  K RUNS FROM 1 TO NCLDS(I)+1:
!      AND INVERSES OF THE FIRST TWO. THE ABOVE QUANTITIES ARE
!      STORED IN TDCL1,TUCL1,TDCL2, AND DFNTRN,UFNTRN, RESPECTIVELY,
!      AS THEY HAVE MULTIPLE USE IN THE PGM.
!---FOR FIRST CLOUD LAYER (GROUND) TDCL1,TUCL1 ARE KNOWN:
      DO 620 I=MYIS,MYIE
        TDCL1 (I,1) = TTD(I,LP1)
        TUCL1 (I,1) = TTU(I,LP1)
        TDCL2 (I,1) = TDCL1(I,1)
        DFNTRN(I,1) = ONE/TDCL1(I,1)
        UFNTRN(I,1) = DFNTRN(I,1)
620   CONTINUE
      DO 631 I=MYIS,MYIE
      KCLDS=NCLDS(I)
      IF(KCLDS.EQ.0) GO TO 631
      DO 630 KK=2,KCLDS+1
        TDCL1(I,KK) = TTD(I,KTOPSW(I,KK))
        TUCL1(I,KK) = TTU(I,KTOPSW(I,KK))
        TDCL2(I,KK) = TTD(I,KBTMSW(I,KK))
630   CONTINUE
631   CONTINUE
!---COMPUTE INVERSES
      DO 641 I=MYIS,MYIE
      KCLDS=NCLDS(I)
      IF(KCLDS.EQ.0) GO TO 641
! SH
      DO 640 KK=2,KCLDS+1
        DFNTRN(I,KK) = ONE/TDCL1(I,KK)
        UFNTRN(I,KK) = ONE/TUCL1(I,KK)
640   CONTINUE
641   CONTINUE
!---COMPUTE THE TRANSMISSIVITY FROM THE TOP OF CLOUD (K+1) TO THE
!   TOP OF CLOUD (K). THE CLOUD TRANSMISSION (CT) IS INCLUDED. THIS
!   QUANTITY IS CALLED TCLU (INDEX K). ALSO, OBTAIN THE TRANSMISSIVITY
!   FROM THE BOTTOM OF CLOUD (K+1) TO THE TOP OF CLOUD (K)(A PATH
!   ENTIRELY OUTSIDE CLOUDS). THIS QUANTITY IS CALLED TCLD (INDEX K).
      DO 651 I=MYIS,MYIE
      KCLDS=NCLDS(I)
      IF(KCLDS.EQ.0) GO TO 651
      DO 650 KK=1,KCLDS
        TCLU(I,KK) = TDCL1(I,KK)*DFNTRN(I,KK+1)*CT(I,KK+1)
        TCLD(I,KK) = TDCL1(I,KK)/TDCL2(I,KK+1)
650   CONTINUE
651   CONTINUE
!***THE FOLLOWING IS THE RECURSION RELATION FOR ALFA: THE REFLECTION
!   COEFFICIENT FOR A SYSTEM INCLUDING THE CLOUD IN QUESTION AND THE
!   FLUX COMING OUT OF THE CLOUD SYSTEM INCLUDING ALL CLOUDS BELOW
!   THE CLOUD IN QUESTION.
!---ALFAU IS ALFA WITHOUT THE REFLECTION OF THE CLOUD IN QUESTION
      DO 660 I=MYIS,MYIE
      KCLDS=NCLDS(I)
      IF(KCLDS.EQ.0) GO TO 660
        ALFA (I,1)=CR(I,1)
        ALFAU(I,1)=ZERO
660   CONTINUE
!---AGAIN,EXCESSIVE CALCULATIONS-MAY BE CHANGED LATER!
      DO 671 I=MYIS,MYIE
      KCLDS=NCLDS(I)
      IF(KCLDS.EQ.0) GO TO 671
      DO 670 KK=2,KCLDS+1
        ALFAU(I,KK)= TCLU(I,KK-1)*TCLU(I,KK-1)*ALFA(I,KK-1)/ &
              (ONE - TCLD(I,KK-1)*TCLD(I,KK-1)*ALFA(I,KK-1)*CR(I,KK))
        ALFA (I,KK)= ALFAU(I,KK)+CR(I,KK)
670   CONTINUE
671   CONTINUE
!     CALCULATE UFN AT CLOUD TOPS AND DFN AT CLOUD BOTTOMS
!---NOTE THAT UFNCLU(I,KCLDS+1) GIVES THE UPWARD FLUX AT THE TOP
!   OF THE HIGHEST REAL CLOUD (IF NCLDS(I)=KCLDS). IT GIVES THE FLUX
!   AT THE TOP OF THE ATMOSPHERE IF NCLDS(I) < KCLDS. IN THE FIRST
!   CASE, TDCL1 EQUALS THE TRANSMISSION FCTN TO THE TOP OF THE
!   HIGHEST CLOUD, AS WE WANT. IN THE SECOND CASE, TDCL1=1, SO UFNCLU
!   EQUALS ALFA. THIS IS ALSO CORRECT.
      DO 680 I=MYIS,MYIE
      KCLDS=NCLDS(I)
      IF(KCLDS.EQ.0) GO TO 680
        UFNCLU(I,KCLDS+1) = ALFA(I,KCLDS+1)*TDCL1(I,KCLDS+1)
        DFNCLU(I,KCLDS+1) = TDCL1(I,KCLDS+1)
680   CONTINUE
!---THIS CALCULATION IS THE REVERSE OF THE RECURSION RELATION USED
!  ABOVE
      DO 691 I=MYIS,MYIE
      KCLDS=NCLDS(I)
      IF(KCLDS.EQ.0) GO TO 691
      DO 690 KK=KCLDS,1,-1
        UFNCLU(I,KK) = UFNCLU(I,KK+1)*ALFAU(I,KK+1)/(ALFA(I,KK+1)* &
                       TCLU(I,KK))
        DFNCLU(I,KK) = UFNCLU(I,KK)/ALFA(I,KK)
690   CONTINUE
691   CONTINUE
      DO 701 I=MYIS,MYIE
      KCLDS=NCLDS(I)
      IF(KCLDS.EQ.0) GO TO 701
      DO 700 KK=1,KCLDS+1
        UFNTRN(I,KK) = UFNCLU(I,KK)*UFNTRN(I,KK)
        DFNTRN(I,KK) = DFNCLU(I,KK)*DFNTRN(I,KK)
700   CONTINUE
701   CONTINUE
!---CASE OF KK=1( FROM THE GROUND TO THE BOTTOM OF THE LOWEST CLOUD)
      DO 720 I=MYIS,MYIE
      KCLDS=NCLDS(I)
      IF(KCLDS.EQ.0) GO TO 720
        J2=KBTMSW(I,2)
        DO 710 K=J2,LP1
          UFN(I,K) = UFNTRN(I,1)*TTU(I,K)
          DFN(I,K) = DFNTRN(I,1)*TTD(I,K)
710     CONTINUE
720   CONTINUE
!---REMAINING LEVELS (IF ANY!)
      DO 760 I=MYIS,MYIE
      KCLDS=NCLDS(I)
      IF(KCLDS.EQ.0) GO TO 760
      DO 755 KK=2,KCLDS+1
        J1=KTOPSW(I,KK)
        J2=KBTMSW(I,KK+1)
        IF (J1.EQ.1) GO TO 755
        DO 730 K=J2,J1
          UFN(I,K) = UFNTRN(I,KK)*TTU(I,K)
          DFN(I,K) = DFNTRN(I,KK)*TTD(I,K)
730     CONTINUE
!---FOR THE THICK CLOUDS, THE FLUX DIVERGENCE THROUGH THE CLOUD
!   LAYER IS ASSUMED TO BE CONSTANT. THE FLUX DERIVATIVE IS GIVEN BY
!   TEMPF (FOR THE UPWARD FLUX) AND TEMPG (FOR THE DOWNWARD FLUX).
        J3=KBTMSW(I,KK)
        IF ((J3-J1).GT.1) THEN
          TEMPF = (UFNCLU(I,KK)-UFN(I,J3))*DPCLD(I,KK-1)
          TEMPG = (DFNCLU(I,KK)-DFN(I,J3))*DPCLD(I,KK-1)
          DO 740 K=J1+1,J3-1
            UFN(I,K) = UFNCLU(I,KK)+TEMPF*(PP(I,K)-PPTOP(I,KK-1))
            DFN(I,K) = DFNCLU(I,KK)+TEMPG*(PP(I,K)-PPTOP(I,KK-1))
740       CONTINUE
        ENDIF
755   CONTINUE
760   CONTINUE
      DO 770 I=MYIS,MYIE
      KCLDS=NCLDS(I)
      IF(KCLDS.EQ.0) GO TO 770
      DO 771 K=1,LP1
        DFSWC(I,K) = DFN(I,K)*DFNTOP(I,1)
        UFSWC(I,K) = UFN(I,K)*DFNTOP(I,1)
771   CONTINUE
770   CONTINUE
      DO 780 I=MYIS,MYIE
      KCLDS=NCLDS(I)
      IF(KCLDS.EQ.0) GO TO 780
        TMP1(I) = ONE - CCMAX(I)
        GDFVB(I) = TMP1(I)*GDFVB(I)
        GDFNB(I) = TMP1(I)*GDFNB(I)
        GDFVD(I) = TMP1(I)*GDFVD(I) + CCMAX(I)*DFSWC(I,LP1)
780   CONTINUE
!---NOW OBTAIN FLUXES FOR THE NEAR IR BANDS. THE METHODS ARE THE SAME
!   AS FOR THE VISIBLE BAND, EXCEPT THAT THE REFLECTION AND
!   TRANSMISSION COEFFICIENTS ARE DIFFERENT, AS
!   RAYLEIGH SCATTERING NEED NOT BE CONSIDERED.
!
      DO 1000 N=2,NB
!YH93
        DO 791 I=MYIS,MYIE
        KCLDS=NCLDS(I)
        IF(KCLDS.EQ.0) GO TO 791
        DO 790 K=1,KCLDS+1
          CR(I,K) = CRR(I,N,K)*XAMT(I,K)
          CT(I,K) = ONE - (ONE-CTT(I,N,K))*XAMT(I,K)
790     CONTINUE
791     CONTINUE
!YH93
        IF (N.EQ.2) THEN
!   THE WATER VAPOR TRANSMISSION FUNCTION FOR BAND 2 IS EQUAL TO
!   THAT OF BAND 1 (SAVED AS TTDB1,TTUB1)
          DO 800 I=MYIS,MYIE
        KCLDS=NCLDS(I)
        IF(KCLDS.EQ.0) GO TO 800
        DO 801 KK=2,LP1
            TTD(I,KK) = TTDB1(I,KK)*TDCO2(I,KK)
801     CONTINUE
        DO 802 KK=1,L
            TTU(I,KK) = TTUB1(I,KK)*TUCO2(I,KK)
802     CONTINUE
800       CONTINUE
        ELSE
          DO 810 I=MYIS,MYIE
        KCLDS=NCLDS(I)
        IF(KCLDS.EQ.0) GO TO 810
        DO 811 KK=2,LP1
            TTD(I,KK) = EXP(HM1EZ*MIN(FIFTY,ABCFF(N)*UD(I,KK))) &
                     * TDCO2(I,KK)
811     CONTINUE
        DO 812 KK=1,L
            TTU(I,KK) = EXP(HM1EZ*MIN(FIFTY,ABCFF(N)*UR(I,KK))) &
                     * TUCO2(I,KK)
812     CONTINUE
810       CONTINUE
        ENDIF
!---AT THIS POINT,INCLUDE TTD(1),TTU(LP1), NOTING THAT TTD(1)=1 FOR
!   ALL BANDS, AND THAT TTU(LP1)=TTD(LP1) FOR ALL BANDS.
        DO 820 I=MYIS,MYIE
        KCLDS=NCLDS(I)
        IF(KCLDS.EQ.0) GO TO 820
          TTU(I,LP1) = TTD(I,LP1)
          TTD(I,1)   = ONE
820     CONTINUE
!***FOR EXECUTION OF THE CLOUD LOOP, IT IS NECESSARY TO SEPARATE OUT
!   TRANSMISSION FCTNS AT THE TOP AND BOTTOM OF THE CLOUDS, FOR
!   EACH BAND N. THE REQUIRED QUANTITIES ARE:
!      TTD(I,KTOPSW(I,K),N)  K RUNS FROM 1 TO NCLDS(I)+1:
!      TTD(I,KBTMSW(I,K),N)  K RUNS FROM 2 TO NCLDS(I)+1:
!      TTU(I,KTOPSW(I,K),N)  K RUNS FROM 1 TO NCLDS(I)+1:
!      AND INVERSES OF THE ABOVE. THE ABOVE QUANTITIES ARE STORED
!      IN TDCL1,TDCL2,TUCL1,AND DFNTRN,UFNTRN,RESPECTIVELY, AS
!      THEY HAVE MULTIPLE USE IN THE PGM.
!---FOR FIRST CLOUD LAYER (GROUND) TDCL1,TUCL1 ARE KNOWN:
        DO 830 I=MYIS,MYIE
        KCLDS=NCLDS(I)
        IF(KCLDS.EQ.0) GO TO 830
          TDCL1 (I,1) = TTD(I,LP1)
          TUCL1 (I,1) = TTU(I,LP1)
          TDCL2 (I,1) = TDCL1(I,1)
          DFNTRN(I,1) = ONE/TDCL1(I,1)
          UFNTRN(I,1) = DFNTRN(I,1)
830     CONTINUE
        DO 841 I=MYIS,MYIE
        KCLDS=NCLDS(I)
        IF(KCLDS.EQ.0) GO TO 841
        DO 840 KK=2,KCLDS+1
          TDCL1(I,KK) = TTD(I,KTOPSW(I,KK))
          TUCL1(I,KK) = TTU(I,KTOPSW(I,KK))
          TDCL2(I,KK) = TTD(I,KBTMSW(I,KK))
840     CONTINUE
841     CONTINUE
        DO 851 I=MYIS,MYIE
        KCLDS=NCLDS(I)
        IF(KCLDS.EQ.0) GO TO 851
        DO 850 KK=2,KCLDS+1
          DFNTRN(I,KK) = ONE/TDCL1(I,KK)
          UFNTRN(I,KK) = ONE/TUCL1(I,KK)
850     CONTINUE
851     CONTINUE
        DO 861 I=MYIS,MYIE
        KCLDS=NCLDS(I)
        IF(KCLDS.EQ.0) GO TO 861
        DO 860 KK=1,KCLDS
          TCLU(I,KK) = TDCL1(I,KK)*DFNTRN(I,KK+1)*CT(I,KK+1)
          TCLD(I,KK) = TDCL1(I,KK)/TDCL2(I,KK+1)
860     CONTINUE
861     CONTINUE
!***THE FOLLOWING IS THE RECURSION RELATION FOR ALFA: THE REFLECTION
!   COEFFICIENT FOR A SYSTEM INCLUDING THE CLOUD IN QUESTION AND THE
!   FLUX COMING OUT OF THE CLOUD SYSTEM INCLUDING ALL CLOUDS BELOW
!   THE CLOUD IN QUESTION.
        DO 870 I=MYIS,MYIE
        KCLDS=NCLDS(I)
        IF(KCLDS.EQ.0) GO TO 870
          ALFA (I,1) = CR(I,1)
          ALFAU(I,1) = ZERO
870     CONTINUE
!---AGAIN,EXCESSIVE CALCULATIONS-MAY BE CHANGED LATER!
        DO 881 I=MYIS,MYIE
        KCLDS=NCLDS(I)
        IF(KCLDS.EQ.0) GO TO 881
        DO 880 KK=2,KCLDS+1
          ALFAU(I,KK) = TCLU(I,KK-1)*TCLU(I,KK-1)*ALFA(I,KK-1)/(ONE - &
                   TCLD(I,KK-1)*TCLD(I,KK-1)*ALFA(I,KK-1)*CR(I,KK))
          ALFA (I,KK) = ALFAU(I,KK)+CR(I,KK)
880     CONTINUE
881     CONTINUE
!     CALCULATE UFN AT CLOUD TOPS AND DFN AT CLOUD BOTTOMS
!---NOTE THAT UFNCLU(I,KCLDS+1) GIVES THE UPWARD FLUX AT THE TOP
!   OF THE HIGHEST REAL CLOUD (IF NCLDS(I)=KCLDS). IT GIVES THE FLUX
!   AT THE TOP OF THE ATMOSPHERE IF NCLDS(I) < KCLDS. IT THE FIRST
!   CASE, TDCL1 EQUALS THE TRANSMISSION FCTN TO THE TOP OF THE
!   HIGHEST CLOUD, AS WE WANT. IN THE SECOND CASE, TDCL1=1, SO UFNCLU
!   EQUALS ALFA. THIS IS ALSO CORRECT.
        DO 890 I=MYIS,MYIE
        KCLDS=NCLDS(I)
        IF(KCLDS.EQ.0) GO TO 890
          UFNCLU(I,KCLDS+1) = ALFA(I,KCLDS+1)*TDCL1(I,KCLDS+1)
          DFNCLU(I,KCLDS+1) = TDCL1(I,KCLDS+1)
890     CONTINUE
        DO 901 I=MYIS,MYIE
        KCLDS=NCLDS(I)
        IF(KCLDS.EQ.0) GO TO 901
        DO 900 KK=KCLDS,1,-1
!
!***  ACCOUNT FOR UNREALISTICALLY SMALL CLOUD AMOUNT
!
        DENOM=ALFA(I,KK+1)*TCLU(I,KK)
        IF(DENOM.GT.RTHRESH)THEN
          UFNCLU(I,KK)=UFNCLU(I,KK+1)*ALFAU(I,KK+1)/DENOM
        ELSE
          UFNCLU(I,KK)=0.
        ENDIF
        IF(ALFA(I,KK).GT.RTHRESH)THEN
          DFNCLU(I,KK)=UFNCLU(I,KK)/ALFA(I,KK)
        ELSE
          DFNCLU(I,KK)=0.
        ENDIF
900     CONTINUE
901     CONTINUE
!     NOW OBTAIN DFN AND UFN FOR LEVELS BETWEEN THE CLOUDS
        DO 911 I=MYIS,MYIE
        KCLDS=NCLDS(I)
        IF(KCLDS.EQ.0) GO TO 911
        DO 910 KK=1,KCLDS+1
          UFNTRN(I,KK) = UFNCLU(I,KK)*UFNTRN(I,KK)
          DFNTRN(I,KK) = DFNCLU(I,KK)*DFNTRN(I,KK)
910     CONTINUE
911     CONTINUE
        DO 930 I=MYIS,MYIE
        KCLDS=NCLDS(I)
        IF(KCLDS.EQ.0) GO TO 930
          J2=KBTMSW(I,2)
          DO 920 K=J2,LP1
            UFN(I,K) = UFNTRN(I,1)*TTU(I,K)
            DFN(I,K) = DFNTRN(I,1)*TTD(I,K)
920       CONTINUE
930     CONTINUE
        DO 970  I=MYIS,MYIE
        KCLDS=NCLDS(I)
        IF(KCLDS.EQ.0) GO TO 970
        DO 965  KK=2,KCLDS+1
          J1 = KTOPSW(I,KK)
          J2 = KBTMSW(I,KK+1)
          IF (J1.EQ.1) GO TO 965
          DO 940 K=J2,J1
            UFN(I,K) = UFNTRN(I,KK)*TTU(I,K)
            DFN(I,K) = DFNTRN(I,KK)*TTD(I,K)
940       CONTINUE
          J3 = KBTMSW(I,KK)
          IF ((J3-J1).GT.1) THEN
            TEMPF = (UFNCLU(I,KK)-UFN(I,J3))*DPCLD(I,KK-1)
            TEMPG = (DFNCLU(I,KK)-DFN(I,J3))*DPCLD(I,KK-1)
            DO 950 K=J1+1,J3-1
              UFN(I,K) = UFNCLU(I,KK)+TEMPF*(PP(I,K)-PPTOP(I,KK-1))
              DFN(I,K) = DFNCLU(I,KK)+TEMPG*(PP(I,K)-PPTOP(I,KK-1))
950         CONTINUE
          ENDIF
965     CONTINUE
970     CONTINUE
        DO 980 I=MYIS,MYIE
        KCLDS=NCLDS(I)
        IF(KCLDS.EQ.0) GO TO 980
        DO 981 K=1,LP1
          DFSWC(I,K) = DFSWC(I,K) + DFN(I,K)*DFNTOP(I,N)
          UFSWC(I,K) = UFSWC(I,K) + UFN(I,K)*DFNTOP(I,N)
981     CONTINUE
980     CONTINUE
        DO 990 I=MYIS,MYIE
        KCLDS=NCLDS(I)
        IF(KCLDS.EQ.0) GO TO 990
          GDFND(I) = GDFND(I) + CCMAX(I)*DFN(I,LP1)*DFNTOP(I,N)
990     CONTINUE
1000  CONTINUE
      DO 1100 I=MYIS,MYIE
        KCLDS=NCLDS(I)
        IF(KCLDS.EQ.0) GO TO 1100
      DO 1101 K=1,LP1
        DFSWC(I,K) = TMP1(I)*DFSWL(I,K) + CCMAX(I)*DFSWC(I,K)
        UFSWC(I,K) = TMP1(I)*UFSWL(I,K) + CCMAX(I)*UFSWC(I,K)
1101  CONTINUE
1100  CONTINUE
      DO 1200 I=MYIS,MYIE
        KCLDS=NCLDS(I)
        IF(KCLDS.EQ.0) GO TO 1200
        DO 1201 KK=1,LP1
        FSWC(I,KK) = UFSWC(I,KK)-DFSWC(I,KK)
1201    CONTINUE
1200  CONTINUE
      DO 1250 I=MYIS,MYIE
        KCLDS=NCLDS(I)
        IF(KCLDS.EQ.0) GO TO 1250
        DO 1251 KK=1, L
        HSWC(I,KK) = RADCON*(FSWC(I,KK+1)-FSWC(I,KK))/DP(I,KK)
1251    CONTINUE
1250  CONTINUE

  END SUBROUTINE SWR93
!-----------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!-----------------------------------------------------------------------

  SUBROUTINE RADFS & 

!     *****************************************************************
!     *                                                               *
!     *   THE INTERNAL DRIVE FOR GFDL RADIATION                       *
!     *   THIS SUBROUTINE WAS FROM Y.H AND K.A.C (1993)               *
!     *   AND MODIFIED BY Q. ZHAO FOR USE IN THE ETA MODEL            *
!     *                   NOV. 18,  1993                              *
!     *                                                               *
!     * UPDATE: THIS SUBROUTINE WAS MODIFIED TO USE CLOUD FRACTION    *
!     *         ON EACH MODEL LAYER.                                  *
!     *                                QINGYUN  ZHAO   95-3-22        *
!     *****************************************************************
!***
!***  REQUIRED INPUT:
!***
                (QS,PP,PPI,QQH2O,TT,O3QO3,TSFC,SLMSK,ALBEDO,XLAT &
!BSF => for NAMX changes, pass in surface emissivity (SFCEMS) [different for snow]
      ,          CAMT,KTOP,KBTM,NCLDS,EMCLD,RRCL,TTCL &
      ,          COSZRO,TAUDAR,IBEG &
      ,          KO3,KALB &
      ,          ITIMSW,ITIMLW &
!***************************************************************************
!*              IX IS THE LENGTH OF A ROW IN THE DOMAIN
!
!*   QS(IX):		THE SURFACE PRESSURE (PA)
!*   PP(IX,L):		THE MIDLAYER PRESSURES (PA)  (L IS THE VERT. DIMEN.)
!*   PPI(IX,LP1)	THE INTERFACE PRESSURES (PA)
!*   QQH2O(IX,L):	THE MIDLAYER WATER VAPOR MIXING RATIO (KG/KG)
!*   TT(IX,L):		THE MIDLAYER TEMPERATURE (K)
!*   O3QO3(IX,L):	THE MIDLAYER OZONE MIXING RATIO
!*   TSFC(IX):		THE SKIN TEMP. (K); NEGATIVE OVER WATER
!*   SLMSK(IX):		THE SEA MASK (LAND=0,SEA=1)
!*   ALBEDO(IX):	THE SURFACE ALBEDO (EXPRESSED AS A FRACTION)
!*   XLAT(IX):		THE GEODETIC LATITUDES OF EACH COLUMN IN DEGREES
!*				(N.H.> 0)
!* THE FOLLOWING ARE CLOUD INFORMATION FOR EACH CLOUD LAYER
!*                      LAYER=1:SURFACE
!*                      LAYER=2:FIRST LAYER ABOVE GROUND, AND SO ON
!*   CAMT(IX,LP1):      CLOUD FRACTION OF EACH CLOUD LAYER
!*   ITYP(IX,LP1):      CLOUD TYPE(=1: STRATIFORM, =2:CONVECTIVE)
!*   KTOP(IX,LP1):      HEIGHT OF CLOUD TOP OF EACH CLOUD LAYER (IN ETA LEVEL)
!*   KBTM(IX,LP1):      BOTTOM OF EACH CLOUD LAYER
!*   NCLDS(IX):         NUMBER OF CLOUD LAYERS
!*   EMCLD(IX,LP1):     CLOUD EMISSIVITY
!*   RRCL(IX,NB,LP1)    CLOUD REFLECTTANCES FOR SW SPECTRAL BANDS
!*   TTCL(IX,NB,LP1)    CLOUD TRANSMITANCES FOR SW SPECTRAL BANDS
!* THE ABOVE ARE CLOUD INFORMATION FOR EACH CLOUD LAYER
!*
!*   COSZRO(IX):	THE COSINE OF THE SOLAR ZENITH ANGLE
!*   TAUDAR:		=1.0
!*   IBEG:		=1
!*   KO3:		=1 ( READ IN THE QZONE DATA)
!*   KALB:		=0
!*   ITIMSW:		=1/0 (SHORTWAVE CALC. ARE DESIRED/NOT DESIRED)
!*   ITIMLW:		=1/0 (LONGWAVE CALC. ARE DESIRED/NOT DESIRED)
!************************************************************************
!***
!*** GENERATED OUTPUT REQUIRED BY THE ETA MODEL
!***
      ,          SWH,HLW &
      ,          FLWUP,FSWUP,FSWDN,FSWDNS,FSWUPS,FLWDNS,FLWUPS,FSWDNSC  &
      ,          ids,ide, jds,jde, kds,kde                      &
      ,          ims,ime, jms,jme, kms,kme                      &
! begin debugging radiation
      ,          its,ite, jts,jte, kts,kte                      &
      ,          imd,jmd, Jndx                                  )
! end debugging radiation
!************************************************************************
!*    SWH: ATMOSPHERIC SHORTWAVE HEATING RATES IN K/S.
!*         SWH IS A REAL ARRAY DIMENSIONED (NCOL X LM).
!*    HLW: ATMOSPHERIC LONGWAVE HEATING RATES IN K/S.
!*         HLW IS A REAL ARRAY DIMENSIONED (NCOL X LM).
!*  FLWUP: UPWARD LONGWAVE FLUX AT TOP OF THE ATMOSPHERE IN W/M**2.
!*         FLWUP IS A REAL ARRAY DIMENSIONED (NCOL).
!*  FSWUP: UPWARD SHORTWAVE FLUX AT TOP OF THE ATMOSPHERE IN W/M**2.
!*         FSWUP IS A REAL ARRAY DIMENSIONED (NCOL).
!*  FSWDN: DOWNWARD SHORTWAVE FLUX AT TOP OF THE ATMOSPHERE IN W/M**2.
!*         FSWDN IS A REAL ARRAY DIMENSIONED (NCOL).
!* FSWDNS: DOWNWARD SHORTWAVE FLUX AT THE SURFACE IN W/M**2.
!*         FSWDNS IS A REAL ARRAY DIMENSIONED (NCOL).
!* FSWUPS: UPWARD SHORTWAVE FLUX AT THE SURFACE IN W/M**2.
!*         FSWUPS IS A REAL ARRAY DIMENSIONED (NCOL).
!* FLWDNS: DOWNWARD LONGWAVE FLUX AT THE SURFACE IN W/M**2.
!*         FLWDNS IS A REAL ARRAY DIMENSIONED (NCOL).
!* FLWUPS: UPWARD LONGWAVE FLUX AT THE SURFACE IN W/M**2.
!*         FLWUPS IS A REAL ARRAY DIMENSIONED (NCOL).
!* FSWDNSC: CLEAR-SKY DOWNWARD SHORTWAVE FLUX AT THE SURFACE IN W/M**2.
!*         FSWDNSC IS A REAL ARRAY DIMENSIONED (NCOL).
!************************************************************************
!***
!*** THE FOLLOWING OUTPUTS ARE NOT REQUIRED BY THE ETA MODEL
!***
!----------------------------------------------------------------------
 IMPLICIT NONE
!----------------------------------------------------------------------
!INTEGER, PARAMETER :: NBLY=15
 INTEGER, PARAMETER :: NB=12
 INTEGER, PARAMETER :: NBLX=47
 INTEGER , PARAMETER:: NBLW = 163

 REAL,PARAMETER ::      AMOLWT=28.9644
 REAL,PARAMETER ::      CSUBP=1.00484E7
 REAL,PARAMETER ::      DIFFCTR=1.66
 REAL,PARAMETER ::      G=980.665
 REAL,PARAMETER ::      GINV=1./G
 REAL,PARAMETER ::      GRAVDR=980.0
 REAL,PARAMETER ::      O3DIFCTR=1.90
 REAL,PARAMETER ::      P0=1013250.
 REAL,PARAMETER ::      P0INV=1./P0
 REAL,PARAMETER ::      GP0INV=GINV*P0INV
 REAL,PARAMETER ::      P0XZP2=202649.902
 REAL,PARAMETER ::      P0XZP8=810600.098
 REAL,PARAMETER ::      P0X2=2.*1013250.
 REAL,PARAMETER ::      RADCON=8.427
 REAL,PARAMETER ::      RADCON1=1./8.427
 REAL,PARAMETER ::      RATCO2MW=1.519449738
 REAL,PARAMETER ::      RATH2OMW=.622
 REAL,PARAMETER ::      RGAS=8.3142E7
 REAL,PARAMETER ::      RGASSP=8.31432E7
 REAL,PARAMETER ::      SECPDA=8.64E4
!
!******THE FOLLOWING ARE MATHEMATICAL CONSTANTS*******
!        ARRANGED IN DECREASING ORDER
 REAL,PARAMETER ::      HUNDRED=100.
 REAL,PARAMETER ::      HNINETY=90.
 REAL,PARAMETER ::      HNINE=9.0
 REAL,PARAMETER ::      SIXTY=60.
 REAL,PARAMETER ::      FIFTY=50.
 REAL,PARAMETER ::      TEN=10.
 REAL,PARAMETER ::      EIGHT=8.
 REAL,PARAMETER ::      FIVE=5.
 REAL,PARAMETER ::      FOUR=4.
 REAL,PARAMETER ::      THREE=3.
 REAL,PARAMETER ::      TWO=2.
 REAL,PARAMETER ::      ONE=1.
 REAL,PARAMETER ::      HAF=0.5
 REAL,PARAMETER ::      QUARTR=0.25
 REAL,PARAMETER ::      ZERO=0.
!
!******FOLLOWING ARE POSITIVE FLOATING POINT CONSTANTS(H'S)
!       ARRANGED IN DECREASING ORDER
 REAL,PARAMETER ::      H83E26=8.3E26
 REAL,PARAMETER ::      H71E26=7.1E26
 REAL,PARAMETER ::      H1E15=1.E15
 REAL,PARAMETER ::      H1E13=1.E13
 REAL,PARAMETER ::      H1E11=1.E11
 REAL,PARAMETER ::      H1E8=1.E8
 REAL,PARAMETER ::      H2E6=2.0E6
 REAL,PARAMETER ::      H1E6=1.0E6
 REAL,PARAMETER ::      H69766E5=6.97667E5
 REAL,PARAMETER ::      H4E5=4.E5
 REAL,PARAMETER ::      H165E5=1.65E5
 REAL,PARAMETER ::      H5725E4=57250.
 REAL,PARAMETER ::      H488E4=48800.
 REAL,PARAMETER ::      H1E4=1.E4
 REAL,PARAMETER ::      H24E3=2400.
 REAL,PARAMETER ::      H20788E3=2078.8
 REAL,PARAMETER ::      H2075E3=2075.
 REAL,PARAMETER ::      H18E3=1800.
 REAL,PARAMETER ::      H1224E3=1224.
 REAL,PARAMETER ::      H67390E2=673.9057
 REAL,PARAMETER ::      H5E2=500.
 REAL,PARAMETER ::      H3082E2=308.2
 REAL,PARAMETER ::      H3E2=300.
 REAL,PARAMETER ::      H2945E2=294.5
 REAL,PARAMETER ::      H29316E2=293.16
 REAL,PARAMETER ::      H26E2=260.0
 REAL,PARAMETER ::      H25E2=250.
 REAL,PARAMETER ::      H23E2=230.
 REAL,PARAMETER ::      H2E2=200.0
 REAL,PARAMETER ::      H15E2=150.
 REAL,PARAMETER ::      H1386E2=138.6
 REAL,PARAMETER ::      H1036E2=103.6
 REAL,PARAMETER ::      H8121E1=81.21
 REAL,PARAMETER ::      H35E1=35.
 REAL,PARAMETER ::      H3116E1=31.16
 REAL,PARAMETER ::      H28E1=28.
 REAL,PARAMETER ::      H181E1=18.1
 REAL,PARAMETER ::      H18E1=18.
 REAL,PARAMETER ::      H161E1=16.1
 REAL,PARAMETER ::      H16E1=16.
 REAL,PARAMETER ::      H1226E1=12.26
 REAL,PARAMETER ::      H9P94=9.94
 REAL,PARAMETER ::      H6P08108=6.081081081
 REAL,PARAMETER ::      H3P6=3.6
 REAL,PARAMETER ::      H3P5=3.5
 REAL,PARAMETER ::      H2P9=2.9
 REAL,PARAMETER ::      H2P8=2.8
 REAL,PARAMETER ::      H2P5=2.5
 REAL,PARAMETER ::      H1P8=1.8
 REAL,PARAMETER ::      H1P4387=1.4387
 REAL,PARAMETER ::      H1P41819=1.418191
 REAL,PARAMETER ::      H1P4=1.4
 REAL,PARAMETER ::      H1P25892=1.258925411
 REAL,PARAMETER ::      H1P082=1.082
 REAL,PARAMETER ::      HP816=0.816
 REAL,PARAMETER ::      HP805=0.805
 REAL,PARAMETER ::      HP8=0.8
 REAL,PARAMETER ::      HP60241=0.60241
 REAL,PARAMETER ::      HP602409=0.60240964
 REAL,PARAMETER ::      HP6=0.6
 REAL,PARAMETER ::      HP526315=0.52631579
 REAL,PARAMETER ::      HP518=0.518
 REAL,PARAMETER ::      HP5048=0.5048
 REAL,PARAMETER ::      HP3795=0.3795
 REAL,PARAMETER ::      HP369=0.369
 REAL,PARAMETER ::      HP26=0.26
 REAL,PARAMETER ::      HP228=0.228
 REAL,PARAMETER ::      HP219=0.219
 REAL,PARAMETER ::      HP166666=.166666
 REAL,PARAMETER ::      HP144=0.144
 REAL,PARAMETER ::      HP118666=0.118666192
 REAL,PARAMETER ::      HP1=0.1
!        (NEGATIVE EXPONENTIALS BEGIN HERE)
 REAL,PARAMETER ::      H658M2=0.0658
 REAL,PARAMETER ::      H625M2=0.0625
 REAL,PARAMETER ::      H44871M2=4.4871E-2
 REAL,PARAMETER ::      H44194M2=.044194
 REAL,PARAMETER ::      H42M2=0.042
 REAL,PARAMETER ::      H41666M2=0.0416666
 REAL,PARAMETER ::      H28571M2=.02857142857
 REAL,PARAMETER ::      H2118M2=0.02118
 REAL,PARAMETER ::      H129M2=0.0129
 REAL,PARAMETER ::      H1M2=.01
 REAL,PARAMETER ::      H559M3=5.59E-3
 REAL,PARAMETER ::      H3M3=0.003
 REAL,PARAMETER ::      H235M3=2.35E-3
 REAL,PARAMETER ::      H1M3=1.0E-3
 REAL,PARAMETER ::      H987M4=9.87E-4
 REAL,PARAMETER ::      H323M4=0.000323
 REAL,PARAMETER ::      H3M4=0.0003
 REAL,PARAMETER ::      H285M4=2.85E-4
 REAL,PARAMETER ::      H1M4=0.0001
 REAL,PARAMETER ::      H75826M4=7.58265E-4
 REAL,PARAMETER ::      H6938M5=6.938E-5
 REAL,PARAMETER ::      H394M5=3.94E-5
 REAL,PARAMETER ::      H37412M5=3.7412E-5
 REAL,PARAMETER ::      H15M5=1.5E-5
 REAL,PARAMETER ::      H1439M5=1.439E-5
 REAL,PARAMETER ::      H128M5=1.28E-5
 REAL,PARAMETER ::      H102M5=1.02E-5
 REAL,PARAMETER ::      H1M5=1.0E-5
 REAL,PARAMETER ::      H7M6=7.E-6
 REAL,PARAMETER ::      H4999M6=4.999E-6
 REAL,PARAMETER ::      H451M6=4.51E-6
 REAL,PARAMETER ::      H25452M6=2.5452E-6
 REAL,PARAMETER ::      H1M6=1.E-6
 REAL,PARAMETER ::      H391M7=3.91E-7
 REAL,PARAMETER ::      H1174M7=1.174E-7
 REAL,PARAMETER ::      H8725M8=8.725E-8
 REAL,PARAMETER ::      H327M8=3.27E-8
 REAL,PARAMETER ::      H257M8=2.57E-8
 REAL,PARAMETER ::      H1M8=1.0E-8
 REAL,PARAMETER ::      H23M10=2.3E-10
 REAL,PARAMETER ::      H14M10=1.4E-10
 REAL,PARAMETER ::      H11M10=1.1E-10
 REAL,PARAMETER ::      H1M10=1.E-10
 REAL,PARAMETER ::      H83M11=8.3E-11
 REAL,PARAMETER ::      H82M11=8.2E-11
 REAL,PARAMETER ::      H8M11=8.E-11
 REAL,PARAMETER ::      H77M11=7.7E-11
 REAL,PARAMETER ::      H72M11=7.2E-11
 REAL,PARAMETER ::      H53M11=5.3E-11
 REAL,PARAMETER ::      H48M11=4.8E-11
 REAL,PARAMETER ::      H44M11=4.4E-11
 REAL,PARAMETER ::      H42M11=4.2E-11
 REAL,PARAMETER ::      H37M11=3.7E-11
 REAL,PARAMETER ::      H35M11=3.5E-11
 REAL,PARAMETER ::      H32M11=3.2E-11
 REAL,PARAMETER ::      H3M11=3.0E-11
 REAL,PARAMETER ::      H28M11=2.8E-11
 REAL,PARAMETER ::      H24M11=2.4E-11
 REAL,PARAMETER ::      H23M11=2.3E-11
 REAL,PARAMETER ::      H2M11=2.E-11
 REAL,PARAMETER ::      H18M11=1.8E-11
 REAL,PARAMETER ::      H15M11=1.5E-11
 REAL,PARAMETER ::      H14M11=1.4E-11
 REAL,PARAMETER ::      H114M11=1.14E-11
 REAL,PARAMETER ::      H11M11=1.1E-11
 REAL,PARAMETER ::      H1M11=1.E-11
 REAL,PARAMETER ::      H96M12=9.6E-12
 REAL,PARAMETER ::      H93M12=9.3E-12
 REAL,PARAMETER ::      H77M12=7.7E-12
 REAL,PARAMETER ::      H74M12=7.4E-12
 REAL,PARAMETER ::      H65M12=6.5E-12
 REAL,PARAMETER ::      H62M12=6.2E-12
 REAL,PARAMETER ::      H6M12=6.E-12
 REAL,PARAMETER ::      H45M12=4.5E-12
 REAL,PARAMETER ::      H44M12=4.4E-12
 REAL,PARAMETER ::      H4M12=4.E-12
 REAL,PARAMETER ::      H38M12=3.8E-12
 REAL,PARAMETER ::      H37M12=3.7E-12
 REAL,PARAMETER ::      H3M12=3.E-12
 REAL,PARAMETER ::      H29M12=2.9E-12
 REAL,PARAMETER ::      H28M12=2.8E-12
 REAL,PARAMETER ::      H24M12=2.4E-12
 REAL,PARAMETER ::      H21M12=2.1E-12
 REAL,PARAMETER ::      H16M12=1.6E-12
 REAL,PARAMETER ::      H14M12=1.4E-12
 REAL,PARAMETER ::      H12M12=1.2E-12
 REAL,PARAMETER ::      H8M13=8.E-13
 REAL,PARAMETER ::      H46M13=4.6E-13
 REAL,PARAMETER ::      H36M13=3.6E-13
 REAL,PARAMETER ::      H135M13=1.35E-13
 REAL,PARAMETER ::      H12M13=1.2E-13
 REAL,PARAMETER ::      H1M13=1.E-13
 REAL,PARAMETER ::      H3M14=3.E-14
 REAL,PARAMETER ::      H15M14=1.5E-14
 REAL,PARAMETER ::      H14M14=1.4E-14
!
!******FOLLOWING ARE NEGATIVE FLOATING POINT CONSTANTS (HM'S)
!          ARRANGED IN DESCENDING ORDER
 REAL,PARAMETER ::      HM2M2=-.02
 REAL,PARAMETER ::      HM6666M2=-.066667
 REAL,PARAMETER ::      HMP5=-0.5
 REAL,PARAMETER ::      HMP575=-0.575
 REAL,PARAMETER ::      HMP66667=-.66667
 REAL,PARAMETER ::      HMP805=-0.805
 REAL,PARAMETER ::      HM1EZ=-1.
 REAL,PARAMETER ::      HM13EZ=-1.3
 REAL,PARAMETER ::      HM19EZ=-1.9
 REAL,PARAMETER ::      HM1E1=-10.
 REAL,PARAMETER ::      HM1597E1=-15.97469413
 REAL,PARAMETER ::      HM161E1=-16.1
 REAL,PARAMETER ::      HM1797E1=-17.97469413
 REAL,PARAMETER ::      HM181E1=-18.1
 REAL,PARAMETER ::      HM8E1=-80.
 REAL,PARAMETER ::      HM1E2=-100.
!
 REAL,PARAMETER ::      H1M16=1.0E-16
 REAL,PARAMETER ::      H1M20=1.E-20
 REAL,PARAMETER ::      Q19001=19.001
 REAL,PARAMETER ::      DAYSEC=1.1574E-5
 REAL,PARAMETER ::      HSIGMA=5.673E-8
 REAL,PARAMETER ::      TWENTY=20.0
 REAL,PARAMETER ::      HP537=0.537
 REAL,PARAMETER ::      HP2=0.2
 REAL,PARAMETER ::      RCO2=3.3E-4
 REAL,PARAMETER ::      H3M6=3.0E-6
 REAL,PARAMETER ::      PI=3.1415927
 REAL,PARAMETER ::      DEGRAD1=180.0/PI
 REAL,PARAMETER ::      H74E1=74.0
 REAL,PARAMETER ::      H15E1=15.0

 REAL, PARAMETER:: B0 = -.51926410E-4
 REAL, PARAMETER:: B1 = -.18113332E-3
 REAL, PARAMETER:: B2 = -.10680132E-5
 REAL, PARAMETER:: B3 = -.67303519E-7
 REAL, PARAMETER:: AWIDE = 0.309801E+01
 REAL, PARAMETER:: BWIDE = 0.495357E-01
 REAL, PARAMETER:: BETAWD = 0.347839E+02
 REAL, PARAMETER:: BETINW = 0.766811E+01


      INTEGER, INTENT(IN)        :: ids,ide, jds,jde, kds,kde ,      &
                                    ims,ime, jms,jme, kms,kme ,      &
                                    its,ite, jts,jte, kts,kte
      INTEGER, INTENT(IN)        :: IBEG,KO3,KALB,ITIMSW,ITIMLW
!----------------------------------------------------------------------
!      ****************************************************************
!      *  GENERALIZED FOR PLUG-COMPATIBILITY -                        *
!      *    ORIGINAL CODE WAS CLEANED-UP GFDL CODE...K.CAMPANA MAR89..*
!......*  EXAMPLE FOR MRF:                                            *
!      *    KO3  =0  AND O3QO3=DUMMY ARRAY.   (GFDL CLIMO O3 USED)    *
!      *    KEMIS=0  AND HI CLD EMIS COMPUTED HERE (CEMIS=DUMMY INPUT)*
!      *    KALB =0  AND SFC ALBEDO OVER OPEN WATER COMPUTED BELOW... *
!      *    KCCO2=0,CO2 OBTAINED FROM BLOCK DATA                      *
!      *         =1,CO2 COMPUTED IN HERE --- NOT AVAILABLE YET...     *
!      *  UPDATED FOR YUTAI HOU SIB SW RADIATION....KAC 6 MAR 92      *
!      *    OCEAN ALBEDO FOR BEAM SET TO BULK SFCALB, SINCE           *
!      *       COSINE ZENITH ANGLE EFFECTS ALREADY THERE(REF:PAYNE)   *
!      *       SLMSK = 0.                                             *
!      *    SNOW ICE ALBEDO FOR BEAM NOT ENHANCED VIA COSINE ZENITH   *
!      *       ANGLE EITHER CAUSE VALU ALREADY HIGH (WE SEE POLAR     *
!      *       COOLING IF WE DO BEAM CALCULATION)....KAC 17MAR92      *
!      *       ALBEDO GE .5                                           *
!      *   UPDATED TO OBTAIN CLEAR SKY FLUXES "ON THE FLY" FOR        *
!      *       CLOUD FORCING DIAGNOSTICS ELSEWHERE...KAC 7AUG92       *
!      *       SEE ##CLR LINES...RADFS,LWR88,FST88,SPA88 .......      *
!      *  UPDATED FOR USE NEW CLD SCHEME      ......YH  DEC 92        *
!      *    INPUT CLD MAY BE AS ORIGINAL IN 3 DOMAIN (CLD,MTOP,MBOT)  *
!      *       OR IN A VERTICAL ARRAY OF 18 MDL LAYERS (CLDARY)       *
!      *    IEMIS=0  USE THE ORG. CLD EMIS SCHEME                     *
!      *         =1  USE TEMP DEP. CLD EMIS SCHEME                    *
!      *  UPDATED TO COMPUTE CLD LAYER REFLECTTANCE AND TRANSMITTANCE *
!      *    INPUT CLD EMISSIVITY AND OPTICAL THICKNESS 'EMIS0,TAUC0'  *
!      *                                      ......YH FEB 93         *
!      ****************************************************************
!--------------------------------
!     INTEGER, PARAMETER:: LNGTH=37*kte
!--------------------------------
     
!     REAL, INTENT(IN) :: SKO3R,AB15WD,SKC1R,SKO2D

      REAL,    INTENT(IN), DIMENSION(its:ite,kts:kte):: PP,TT
      REAL,    INTENT(IN), DIMENSION(its:ite,kts:kte):: QQH2O
      REAL,    INTENT(IN), DIMENSION(its:ite,kts:kte+1):: PPI,CAMT,EMCLD
      REAL,    INTENT(IN), DIMENSION(its:ite):: QS,TSFC,SLMSK,ALBEDO,XLAT
      REAL,    INTENT(IN), DIMENSION(its:ite):: COSZRO,TAUDAR
      REAL,    INTENT(OUT), DIMENSION(its:ite):: FLWUPS
      INTEGER, INTENT(IN), DIMENSION(its:ite):: NCLDS
      INTEGER, INTENT(IN), DIMENSION(its:ite,kts:kte+1):: KTOP,KBTM
      REAL,    INTENT(INOUT), DIMENSION(its:ite,NB,kts:kte+1):: TTCL,RRCL
      REAL, intent(IN), DIMENSION(its:ite,kts:kte):: O3QO3
!     REAL,  INTENT(IN),  DIMENSION(5040):: T1,T2,T4,EM1V,EM1VW
!     REAL,  INTENT(IN),  DIMENSION(5040) :: EM3V

!     REAL, DIMENSION(its:ite)::ALVBR,ALNBR, ALVDR,ALNDR

! TABLE ???

      REAL,  DIMENSION(3) :: BO3RND,AO3RND
      REAL,  DIMENSION(NBLY) :: APCM,BPCM,ATPCM,BTPCM,ACOMB, &
                                BCOMB,BETACM

      DATA AO3RND / 0.543368E+02,  0.234676E+04,  0.384881E+02/ 
      DATA BO3RND / 0.526064E+01,  0.922424E+01,  0.496515E+01/

      DATA ACOMB  / &
         0.152070E+05,  0.332194E+04,  0.527177E+03,  0.163124E+03, &
         0.268808E+03,  0.534591E+02,  0.268071E+02,  0.123133E+02, &
         0.600199E+01,  0.640803E+00,  0.501549E-01,  0.167961E-01, &
         0.178110E-01,  0.170166E+00,  0.537083E-02/
      DATA BCOMB  / &
         0.152538E+00,  0.118677E+00,  0.103660E+00,  0.100119E+00, &
         0.127518E+00,  0.118409E+00,  0.904061E-01,  0.642011E-01, &
         0.629660E-01,  0.643346E-01,  0.717082E-01,  0.629730E-01, &
         0.875182E-01,  0.857907E-01,  0.214005E+00/
      DATA APCM   / &
        -0.671879E-03,  0.654345E-02,  0.143657E-01,  0.923593E-02, &
         0.117022E-01,  0.159596E-01,  0.181600E-01,  0.145013E-01, &
         0.170062E-01,  0.233303E-01,  0.256735E-01,  0.274745E-01, &
         0.279259E-01,  0.197002E-01,  0.349782E-01/
      DATA BPCM   / &
        -0.113520E-04, -0.323965E-04, -0.448417E-04, -0.230779E-04, &
        -0.361981E-04, -0.145117E-04,  0.198349E-04, -0.486529E-04, &
        -0.550050E-04, -0.684057E-04, -0.447093E-04, -0.778390E-04, &
        -0.982953E-04, -0.772497E-04, -0.748263E-04/
      DATA ATPCM  / &
        -0.106346E-02,  0.641531E-02,  0.137362E-01,  0.922513E-02, &
         0.136162E-01,  0.169791E-01,  0.206959E-01,  0.166223E-01, &
         0.171776E-01,  0.229724E-01,  0.275530E-01,  0.302731E-01, &
         0.281662E-01,  0.199525E-01,  0.370962E-01/
      DATA BTPCM  / &
        -0.735731E-05, -0.294149E-04, -0.505592E-04, -0.280894E-04, &
        -0.492972E-04, -0.341508E-04, -0.362947E-04, -0.250487E-04, &
        -0.521369E-04, -0.746260E-04, -0.744124E-04, -0.881905E-04, &
        -0.933645E-04, -0.664045E-04, -0.115290E-03/
      DATA BETACM / &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.188625E+03,  0.144293E+03,  0.174098E+03,  0.909366E+02, &
         0.497489E+02,  0.221212E+02,  0.113124E+02,  0.754174E+01, &
         0.589554E+01,  0.495227E+01,  0.000000E+00/


!        *********************************************
!====>   *   OUTPUT TO CALLING PROGRAM               *
!        *********************************************

       REAL, INTENT(INOUT),DIMENSION(its:ite,kts:kte)::SWH,HLW
       REAL, INTENT(OUT), DIMENSION(its:ite):: FSWUP,FSWUPS,FSWDN, &
                           FSWDNS,FLWUP,FLWDNS,FSWDNSC
      
!        *********************************************
!====>   *   POSSIBLE OUTPUT TO CALLING PROGRAM      *
!        *********************************************

      REAL, DIMENSION(its:ite):: GDFVBR,GDFNBR,GDFVDR,GDFNDR

!        ************************************************************
!====>   *   ARRAYS NEEDED BY SWR91SIB..FOR CLEAR SKY DATA(EG.FSWL) *
!        ************************************************************

      REAL, DIMENSION(its:ite,kts:kte+1)::FSWL,HSWL,UFL,DFL

!        ******************************************************
!====>   *   ARRAYS NEEDED BY CLO88, LWR88, SWR89 OR SWR91SIB *
!        ******************************************************

       REAL, DIMENSION(its:ite,kts:kte+1,kts:kte+1)::CLDFAC
       REAL, DIMENSION(its:ite,kts:kte+1)::EQCMT,PRESS,TEMP,FSW,HSW,UF,DF
       REAL, DIMENSION(its:ite,kts:kte)::RH2O,QO3,HEATRA
       REAL, DIMENSION(its:ite):: COSZEN,TAUDA,GRNFLX,TOPFLX,GRDFLX
       REAL, DIMENSION(kts:kte+1)::PHALF
!..... ADD PRESSURE INTERFACE

       REAL,    DIMENSION(NB) :: ABCFF,PWTS

       DATA ABCFF/2*4.0E-5,.002,.035,.377,1.95,9.40,44.6,190., &
                  989.,2706.,39011./
       DATA PWTS/.5000,.121416,.0698,.1558,.0631,.0362,.0243,.0158,.0087, &
                 .001467,.002342,.001075/

       REAL     :: CFCO2,CFO3,REFLO3,RRAYAV

       DATA CFCO2,CFO3/508.96,466.64/
       DATA REFLO3/1.9/
       DATA RRAYAV/0.144/

!        *********************************************
!====>   *   VECTOR TEMPORARIES FOR CLOUD CALC.      *
!        *********************************************

       REAL,    DIMENSION(its:ite):: TTHAN
       REAL,    DIMENSION(its:ite,kts:kte):: DO3V,DO3VP
       INTEGER, DIMENSION(its:ite):: JJROW

!====>    **************************************************************
!--     SEASONAL CLIMATOLOGIES OF O3 (OBTAINED FROM A PREVIOUSLY RUN
!             CODE WHICH INTERPOLATES O3 TO USER VERTICAL COORDINATE).
!         DEFINED AS 5 DEG LAT MEANS N.P.->S.P.
!         COMMON /SAVMEM/ &
!-       ...WINTER....  ...SPRING....  ...SUMMER....  ....FALL.....
!        DDUO3N(37,L), DDO3N2(37,L), DDO3N3(37,L), DDO3N4(37,L)

       REAL, DIMENSION(37,kte) :: DDUO3N,DDO3N2,DDO3N3,DDO3N4

!====>    **************************************************************
!
      REAL,   DIMENSION(21,20) :: ALBD
      REAL,   DIMENSION(20)    :: ZA
      REAL,   DIMENSION(21)    :: TRN
      REAL,   DIMENSION(19)    :: DZA

      REAL    :: YEAR,TPI,SSOLAR,DATE,TH2,ZEN,DZEN,ALB1,ALB2
      INTEGER :: IR,IQ,JX
      DATA TRN/.00,.05,.10,.15,.20,.25,.30,.35,.40,.45,.50,.55,.60,.65, &
               .70,.75,.80,.85,.90,.95,1.00/

      REAL ::  ALB11(21,7),ALB22(21,7),ALB33(21,6)

      EQUIVALENCE (ALB11(1,1),ALBD(1,1)),(ALB22(1,1),ALBD(1,8)), &
                  (ALB33(1,1),ALBD(1,15))
      DATA ALB11/ .061,.062,.072,.087,.115,.163,.235,.318,.395,.472,.542, &
       .604,.655,.693,.719,.732,.730,.681,.581,.453,.425,.061,.062,.070, &
       .083,.108,.145,.198,.263,.336,.415,.487,.547,.595,.631,.656,.670, &
       .652,.602,.494,.398,.370,.061,.061,.068,.079,.098,.130,.174,.228, &
       .290,.357,.424,.498,.556,.588,.603,.592,.556,.488,.393,.342,.325, &
       .061,.061,.065,.073,.086,.110,.150,.192,.248,.306,.360,.407,.444, &
       .469,.480,.474,.444,.386,.333,.301,.290,.061,.061,.065,.070,.082, &
       .101,.131,.168,.208,.252,.295,.331,.358,.375,.385,.377,.356,.320, &
       .288,.266,.255,.061,.061,.063,.068,.077,.092,.114,.143,.176,.210, &
       .242,.272,.288,.296,.300,.291,.273,.252,.237,.266,.220,.061,.061, &
       .062,.066,.072,.084,.103,.127,.151,.176,.198,.219,.236,.245,.250, &
       .246,.235,.222,.211,.205,.200/
      DATA ALB22/ .061,.061,.061,.065,.071,.079,.094,.113,.134,.154,.173, &
       .185,.190,.193,.193,.190,.188,.185,.182,.180,.178,.061,.061,.061, &
       .064,.067,.072,.083,.099,.117,.135,.150,.160,.164,.165,.164,.162, &
       .160,.159,.158,.157,.157,.061,.061,.061,.062,.065,.068,.074,.084, &
       .097,.111,.121,.127,.130,.131,.131,.130,.129,.127,.126,.125,.122, &
       .061,.061,.061,.061,.062,.064,.070,.076,.085,.094,.101,.105,.107, &
       .106,.103,.100,.097,.096,.095,.095,.095,.061,.061,.061,.060,.061, &
       .062,.065,.070,.075,.081,.086,.089,.090,.088,.084,.080,.077,.075, &
       .074,.074,.074,.061,.061,.060,.060,.060,.061,.063,.065,.068,.072, &
       .076,.077,.076,.074,.071,.067,.064,.062,.061,.061,.061,.061,.061, &
       .060,.060,.060,.060,.061,.062,.065,.068,.069,.069,.068,.065,.061, &
       .058,.055,.054,.053,.052,.052/
      DATA ALB33/ .061,.061,.060,.060,.060,.060,.060,.060,.062,.065,.065, &
       .063,.060,.057,.054,.050,.047,.046,.045,.044,.044,.061,.061,.060, &
       .060,.060,.059,.059,.059,.059,.059,.058,.055,.051,.047,.043,.039, &
       .035,.033,.032,.031,.031,.061,.061,.060,.060,.060,.059,.059,.058, &
       .057,.056,.054,.051,.047,.043,.039,.036,.033,.030,.028,.027,.026, &
       .061,.061,.060,.060,.060,.059,.059,.058,.057,.055,.052,.049,.045, &
       .040,.036,.032,.029,.027,.026,.025,.025,.061,.061,.060,.060,.060, &
       .059,.059,.058,.056,.053,.050,.046,.042,.038,.034,.031,.028,.026, &
       .025,.025,.025,.061,.061,.060,.060,.059,.058,.058,.057,.055,.053, &
       .050,.046,.042,.038,.034,.030,.028,.029,.025,.025,.025/
      DATA ZA/90.,88.,86.,84.,82.,80.,78.,76.,74.,70.,66.,62.,58.,54., &
              50.,40.,30.,20.,10.,0.0/
      DATA DZA/8*2.0,6*4.0,5*10.0/

!    ***********************************************************
!

       REAL,    DIMENSION(its:ite)        :: ALVB,ALNB,ALVD,ALND, &
                                             GDFVB,   &
                                             GDFNB,GDFVD,GDFND,   &
                                             SFCALB

       REAL    :: RRVCO2,RRCO2,TDUM
       REAL    :: ALBD0,ALVD1,ALND1
       INTEGER :: N
!
!***  The following two lines are for debugging.
       integer :: imd,jmd, Jndx
       real :: FSWrat,FSWrat1,FSWDNS1
!***

!====>    BEGIN HERE             .......................
!
!--- SSOLAR IS THE SOLAR CONSTANT SCALED TO A MORE CURRENT VALUE;
!          I.E. IF SOLC=2.0 LY/MIN THEN SSOLAR=1.96 LY/MIN.
      REAL,PARAMETER :: H196=1.96

      INTEGER :: K, I,KP,LLM2,J1,J3,KMAX,KMIN,KCLDS,ICNT,LLM1
      INTEGER :: L,LP1,LP2,LP3,LM1,LM2,LM3,MYIS,MYIE,LLP1,LL,KK,KLEN

      L=kte
      LP1=L+1;  LP2=L+2;  LP3=L+3; LLP1 = 2*L + 1
      LM1=L-1;  LM2=L-2;  LM3=L-3; LL = 2*L
      LLM2 = LL-2; LLM1=LL-1
      MYIS=its; MYIE=ite

!******ZHAO
!  NOTE: XLAT IS IN DEGREE HERE
!*****ZHAO
!-- Formerly =>  SOLC=2./(R1*R1), SSOLAR=0.98*SOLC
      SSOLAR=H196/(R1*R1)
!*********************************************************
! Special note: The solar constant is reduced extra 3 percent to account
!               for the lack of aerosols in the shortwave radiation
!               parameterization.       Q. Zhao    96-7-23
! ### May also be due not accounting for reduction in solar constant due to
!     absorption by ozone above the top of the model domain (Ferrier, Apr-2005)
!*********************************************************
      SSOLAR=SSOLAR*0.97
!
      DO 40 I=MYIS,MYIE
        IR = I + IBEG - 1
        TH2=HP2*XLAT(IR)
        JJROW(I)=Q19001-TH2
        TTHAN(I)=(19-JJROW(I))-TH2
!.....  NOTE THAT THE NMC VARIABLES ARE IN MKS (THUS PRESSURE IS IN
!          CENTIBARS)WHILE ALL GFDL VARIABLES ARE IN CGS UNITS
        SFCALB(I) = ALBEDO(IR)
!.....  NOW PUT SFC TEMP,PRESSURES, ZENITH ANGLE INTO SW COMMON BLOCK...
!***ZHAO
!  NOTE: ALL PRESSURES INPUT FROM THE ETA MODEL ARE IN PA
!        THE UNIT FOR PRESS IS MICRO BAR 
!        SURFACE TEMPERATURE ARE NEGATIVE OVER OCEANS IN THE ETA MODEL
!***ZHAO
        PRESS(I,LP1)=QS(IR)*10.0
        TEMP(I,LP1)=ABS(TSFC(IR))
        COSZEN(I) = COSZRO(IR)
        TAUDA(I) = TAUDAR(IR)
   40 CONTINUE
!***ZHAO
!.....  ALL GFDL VARIABLES HAVE K=1 AT THE TOP OF THE ATMOSPHERE.NMC
!       ETA MODEL HAS THE SAME STRUCTURE
!***ZHAO
!     if(jndx==123)then
!       write(0,*)' RADTN before 50 loop l=',l,' myis=',myis,' myie=',myie &
!                ,' ibeg=',ibeg
!       write(0,*)' temp lbound=',lbound(temp),' ubound=',ubound(temp) &
!                ,' size=',size(temp),' shape=',shape(temp)
!       write(0,*)' tt lbound=',lbound(tt),' ubound=',ubound(tt) &
!                ,' size=',size(tt),' shape=',shape(tt)
!     endif
      DO 50 K=1,L
       DO 50 I=MYIS,MYIE
        IR = I + IBEG - 1
!.....  NOW PUT TEMP,PRESSURES, INTO SW COMMON BLOCK..........
        TEMP(I,K) = TT(IR,K)

!mep-test
        if (K .eq. L) then
        TEMP(I,K+1)=TT(IR,K)   ! TEMP @ LM+1 passed as zero into LWR88
        endif
!mep-endtest

!     if(i==174.and.jndx==123.and.k==33)then
!       write(0,*)' RADTN ir=',ir,' tt=',tt(ir,k),' temp=',temp(i,k)
!     endif
        PRESS(I,K) = 10.0 * PP(IR,K)
!.... STORE LYR MOISTURE AND ADD TO SW COMMON BLOCK
        RH2O(I,K)=QQH2O(IR,K)
        IF(RH2O(I,K).LT.H3M6) RH2O(I,K)=H3M6
   50 CONTINUE
!...    *************************
      IF (KO3.EQ.0) GO TO 65
!...    *************************
      DO 60 K=1,L
       DO 60 I=MYIS,MYIE
        QO3(I,K) = O3QO3(I+IBEG-1,K)
   60 CONTINUE
   65 CONTINUE
!...   ************************************
      IF (KALB.GT.0) GO TO 110
!...   ************************************
!..... THE FOLLOWING CODE GETS ALBEDO FROM PAYNE,1972 TABLES IF
!         1) OPEN SEA POINT (SLMSK=1);2) KALB=0
      IQ=INT(TWENTY*HP537+ONE)
      DO 105 I=MYIS,MYIE
         IF(COSZEN(I).GT.0.0 .AND. SLMSK(I+IBEG-1).GT.0.5) THEN
           ZEN=DEGRAD1*ACOS(MAX(COSZEN(I),0.0))
           IF(ZEN.GE.H74E1) JX=INT(HAF*(HNINETY-ZEN)+ONE)
           IF(ZEN.LT.H74E1.AND.ZEN.GE.FIFTY) &
              JX=INT(QUARTR*(H74E1-ZEN)+HNINE)
           IF(ZEN.LT.FIFTY) JX=INT(HP1*(FIFTY-ZEN)+H15E1)
           DZEN=-(ZEN-ZA(JX))/DZA(JX)
           ALB1=ALBD(IQ,JX)+DZEN*(ALBD(IQ,JX+1)-ALBD(IQ,JX))
           ALB2=ALBD(IQ+1,JX)+DZEN*(ALBD(IQ+1,JX+1)-ALBD(IQ+1,JX))
           SFCALB(I)=ALB1+TWENTY*(ALB2-ALB1)*(HP537-TRN(IQ))
         ENDIF
  105 CONTINUE
  110 CONTINUE
!        **********************************
      IF (KO3.GT.0) GO TO 135
!        **********************************
!.... COMPUTE CLIMATOLOGICAL ZONAL MEAN OZONE,
!....   SEASONAL AND SPATIAL INTERPOLATION DONE BELOW.
      DO 125 I=MYIS,MYIE

         PHALF(1)=0.
         PHALF(LP1)=PPI(I,kme)
         DO K=1,LM1
            PHALF(K+1)=PP(I,K) !  AETA(K)*PDIF+PT ! BSF index was erroneously L
         ENDDO

         CALL O3INT(PHALF,DDUO3N,DDO3N2,DDO3N3,DDO3N4, &
                 ids,ide, jds,jde, kds,kde,            &
                 ims,ime, jms,jme, kms,kme,            &
                 its,ite, jts,jte, kts,kte             )

         DO 130 K=1,L
          DO3V(I,K)  = DDUO3N(JJROW(I),K) + RSIN1*DDO3N2(JJROW(I),K) &
                      +RCOS1*DDO3N3(JJROW(I),K) &
                      +RCOS2*DDO3N4(JJROW(I),K)
          DO3VP(I,K) = DDUO3N(JJROW(I)+1,K) + RSIN1*DDO3N2(JJROW(I)+1,K) &
                     +RCOS1*DDO3N3(JJROW(I)+1,K) &
                     +RCOS2*DDO3N4(JJROW(I)+1,K)
!...   NOW LATITUDINAL INTERPOLATION, AND
!          CONVERT O3 INTO MASS MIXING RATIO(ORIGINAL DATA MPY BY 1.E4)
          QO3(I,K) = H1M4 * (DO3V(I,K)+TTHAN(I)*(DO3VP(I,K)-DO3V(I,K)))
  130   CONTINUE
  125 CONTINUE
  135 CONTINUE
!.............
      DO 195 I=MYIS,MYIE
!.....     VISIBLE AND NEAR IR DIFFUSE ALBEDO
        ALVD(I) = SFCALB(I)
        ALND(I) = SFCALB(I)
!.....     VISIBLE AND NEAR IR DIRECT BEAM ALBEDO
        ALVB(I) = SFCALB(I)
        ALNB(I) = SFCALB(I)
!
!--- Remove diurnal variation of land surface albedos (Ferrier, 6/28/05)
!--- Turn back on to mimic NAM 8/17/05
!
!.....     VISIBLE AND NEAR IR DIRECT BEAM ALBEDO,IF NOT OCEAN NOR SNOW
!        ..FUNCTION OF COSINE SOLAR ZENITH ANGLE..
        IF (SLMSK(I+IBEG-1).LT.0.5) THEN
         IF (SFCALB(I).LE.0.5) THEN
          ALBD0 = -18.0 * (0.5 - ACOS(COSZEN(I))/PI)
          ALBD0 = EXP (ALBD0)
          ALVD1 = (ALVD(I) - 0.054313) / 0.945687
          ALND1 = (ALND(I) - 0.054313) / 0.945687
          ALVB(I) = ALVD1 + (1.0 - ALVD1) * ALBD0
          ALNB(I) = ALND1 + (1.0 - ALND1) * ALBD0
 !-- Put in an upper limit on beam albedos
          ALVB(I) = MIN(0.5,ALVB(I))
          ALNB(I) = MIN(0.5,ALNB(I))
         END IF
        END IF
  195 CONTINUE
!.....SURFACE VALUES OF RRCL AND TTCL
      DO 200 N=1,2
        DO 200 I=MYIS,MYIE
      RRCL(I,N,1)=ALVD(I)
      TTCL(I,N,1)=ZERO
  200 CONTINUE
      DO 220 N=3,NB
      DO 220 I=MYIS,MYIE
         RRCL(I,N,1)=ALND(I)
         TTCL(I,N,1)=ZERO
  220 CONTINUE
!...     **************************
!...     *  END OF CLOUD SECTION  *
!...     **************************
!... THE FOLLOWING CODE CONVERTS RRVCO2,THE VOLUME MIXING RATIO OF CO2
!   INTO RRCO2,THE MASS MIXING RATIO.
      RRVCO2=RCO2
      RRCO2=RRVCO2*RATCO2MW
  250 IF(ITIMLW .EQ. 0) GO TO 300
!
!             ***********************
!====>        * LONG WAVE RADIATION *
!             ***********************
!
!....     ACCOUNT FOR REDUCED EMISSIVITY OF ANY CLDS
      DO 240 K=1,LP1
      DO 240 I=MYIS,MYIE
        EQCMT(I,K)=CAMT(I,K)*EMCLD(I,K)
  240 CONTINUE
!....    GET CLD FACTOR FOR LW CALCULATIONS
!....

! shuhua

      CALL CLO89(CLDFAC,EQCMT,NCLDS,KBTM,KTOP, &
                 ids,ide, jds,jde, kds,kde,    &
                 ims,ime, jms,jme, kms,kme,    &
                 its,ite, jts,jte, kts,kte     )

! shuhua
!===>        LONG WAVE RADIATION
!     CALL LWR88(HEATRA,GRNFLX,TOPFLX,         &
!                PRESS,TEMP,RH2O,QO3,CLDFAC,   &
!                EQCMT,NCLDS,KTOP,KBTM,        &
!
!!               BO3RND,AO3RND,T1,T2,T4,EM1V,EM1VW,EM3V, &
!                BO3RND,AO3RND, &
!                APCM,BPCM,ATPCM,BTPCM,ACOMB,BCOMB,BETACM,     &
!                ZERO,ONE,H18E3,P0INV,H6P08108,DIFFCTR,        &
!                GINV,H3M4,BETINW,RATH2OMW,GP0INV,P0,P0XZP8,   &
!                P0XZP2,H3M3,H1M3,H1M2,H25E2,B0,B2,B1,B3,HAF,  &
!                TEN,HP1,FOUR,HM1EZ,SKO3R,                     &
!                AB15WD,SKC1R,RADCON,QUARTR,TWO,               &
!                HM6666M2,HMP66667,HMP5, HP166666,H41666M2,    &
!                RADCON1,H16E1, H28E1,H44194M2,H1P41819,SKO2D, &
!                ids,ide, jds,jde, kds,kde,                    &
!                ims,ime, jms,jme, kms,kme,                    &
!                its,ite, jts,jte, kts,kte                    )


      CALL LWR88(HEATRA,GRNFLX,TOPFLX,         &
                 PRESS,TEMP,RH2O,QO3,CLDFAC,   &
                 EQCMT,NCLDS,KTOP,KBTM,        &
!
!                BO3RND,AO3RND,T1,T2,T4,EM1V,EM1VW,EM3V, &
                 BO3RND,AO3RND, &
                 APCM,BPCM,ATPCM,BTPCM,ACOMB,BCOMB,BETACM,     &
                 ZERO,ONE,H18E3,P0INV,H6P08108,DIFFCTR,        &
                 GINV,H3M4,BETINW,RATH2OMW,GP0INV,P0,P0XZP8,   &
                 P0XZP2,H3M3,H1M3,H1M2,H25E2,B0,B2,B1,B3,HAF,  &
                 TEN,HP1,FOUR,HM1EZ,                           &
                 RADCON,QUARTR,TWO,                            &
                 HM6666M2,HMP66667,HMP5, HP166666,H41666M2,    &
                 RADCON1,H16E1, H28E1,H44194M2,H1P41819,       &
                 ids,ide, jds,jde, kds,kde,                    &
                 ims,ime, jms,jme, kms,kme,                    &
                  its,ite, jts,jte, kts,kte ,Jndx              )

!....
!================================================================================
!--- IMPORTANT!!  Y.-T Hou advised Ferrier, Mitchell, & Ek on 7/28/05 to use 
!    the following algorithm, because the GFDL code calculates NET longwave flux 
!    (GRNFLX, Up - Down) as its fundamental quantity.  
!
!    1.  Calculate upward LW at surface (FLWUPS)
!    2.  Calculate downward LW at surface (FLWDNS) = FLWUPS - .001*GRNFLX
!
!--- Note:  The following fluxes must be multipled by .001 to convert to mks
!       => GRNFLX, or GRound Net FLuX 
!       => TOPFLX, or top of the atmosphere fluxes (FLWUP)
!
!--- IMPORTANT!!  If the surface emissivity (SFCEMS) differs from 1.0, then 
!    uncomment the line below starting with "!BSF"
!================================================================================
      DO 280 I=MYIS,MYIE
        IR = I + IBEG - 1
        FLWUP(IR) = .001*TOPFLX(I)
!        TDUM=TEMP(I,LP1)
!--- Use an average of the skin & lowest model level temperature
        TDUM=.5*(TEMP(I,LP1)+TEMP(I,L))
        FLWUPS(IR)=HSIGMA*TDUM*TDUM*TDUM*TDUM
	if (IR .eq. 50) then
!	write(0,*) 'TDUM, FLWUPS: ', TDUM, FLWUPS(IR)
	endif
!BSF        FLWUPS(IR)=SFCEMS*HSIGMA*TDUM*TDUM*TDUM*TDUM
!     if(grnflx(i)/=grnflx(i))then
!       write(0,*)' grnflx i=',i,' ir=',ir,' ibeg=',ibeg,' jndx=',jndx
!       write(0,*)' grnflx=',grnflx(i)
!     endif
!     if(flwups(ir)/=flwups(ir))then
!       write(0,*)' flwups i=',i,' ir=',ir,' ibeg=',ibeg,' lp1=',lp1,' jndx=',jndx
!       write(0,*)' hsigma=',hsigma
!       write(0,*)' temp(l)=',temp(i,l)
!       write(0,*)' temp(lp1)=',temp(i,lp1)
!       write(0,*)' tdum=',tdum
!       write(0,*)' flwups=',flwups(ir)
!     endif
        FLWDNS(IR)=FLWUPS(IR)-.001*GRNFLX(I)
	if (IR .eq. 50) then
!	write(0,*) 'GRNFLX(I), FLWDNS(IR): ', GRNFLX(I), FLWDNS(IR)
	endif
  280 CONTINUE
!ratko-wrf
! Remove LW modification for June 2006 NAM implementation
!....  Average LW heating/cooling rates over the lowest 2 atmospheric layers,
!      which may be necessary for when dealing with thin layers near the surface
!     DO I=MYIS,MYIE
!        TDUM=.5*(HEATRA(I,L)+HEATRA(I,LM1))
!        HEATRA(I,L)=TDUM
!        HEATRA(I,LM1)=TDUM
!     ENDDO
!ratko-wrf
!....      CONVERT HEATING RATES TO DEG/SEC
      DO 290 K=1,L
        DO 290 I=MYIS,MYIE
          HLW(I+IBEG-1,K)=HEATRA(I,K)*DAYSEC
  290 CONTINUE
  300 CONTINUE
      IF(ITIMSW .EQ. 0) GO TO 350
!SW
      CALL SWR93(FSW,HSW,UF,DF,FSWL,HSWL,UFL,DFL, &
                 PRESS,COSZEN,TAUDA,RH2O,RRCO2,SSOLAR,QO3, &
                 NCLDS,KTOP,KBTM,CAMT,RRCL,TTCL, &
                 ALVB,ALNB,ALVD,ALND,GDFVB,GDFNB,GDFVD,GDFND, &
!
!                UCO2,UO3,TUCO2,TUO3,TDO3,TDCO2,                &
                 ABCFF,PWTS,                                    &
                 H35E1,H1224E3,ONE,ZERO,HAF,H69766E5,HP219,     &
                 HP816,RRAYAV,GINV,CFCO2,CFO3,                  &
                 TWO,H235M3,HP26,H129M2,H75826M4,H1036E2,       &
                 H1P082,HMP805,H1386E2,H658M2,H2118M2,H42M2,    &
                 H323M4,HM1EZ,DIFFCTR,O3DIFCTR,FIFTY,RADCON,    &
                 ids,ide, jds,jde, kds,kde,                     &
                 ims,ime, jms,jme, kms,kme,                     &
                 its,ite, jts,jte, kts,kte,jndx                )

!SW
!
!.....    GET SW FLUXES IN WATTS/M**2
      DO 320 I=MYIS,MYIE
       IR = I + IBEG - 1
       FSWUP(IR) = UF(I,1) * 1.E-3
       FSWDN(IR) = DF(I,1) * 1.E-3
       FSWUPS(IR) = UF(I,LP1) * 1.E-3
!-- FSWDNS is more accurate using array DF than summing the GDFxx arrays
!C..COUPLE W/M2 DIFF, IF FSWDNS(IR)=DF(I,LP1)*1.#E-3
!!       FSWDNS(IR) = (GDFVB(I)+GDFNB(I)+GDFVD(I)+GDFND(I)) * 1.E-3
       FSWDNS(IR) = DF(I,LP1) * 1.E-3
       FSWDNSC(IR) = DFL(I,LP1) * 1.E-3
!...    DOWNWARD SFC FLUX FOR THE SIB PARAMETERATION
!.....     VISIBLE AND NEAR IR DIFFUSE
       GDFVDR(IR) = GDFVD(I) * 1.E-3
       GDFNDR(IR) = GDFND(I) * 1.E-3
!.....     VISIBLE AND NEAR IR DIRECT BEAM
       GDFVBR(IR) = GDFVB(I) * 1.E-3
       GDFNBR(IR) = GDFNB(I) * 1.E-3
  320 CONTINUE
!....      CONVERT HEATING RATES TO DEG/SEC
      DO 330 K=1,L
        DO 330 I=MYIS,MYIE
          SWH(I+IBEG-1,K)=HSW(I,K)*DAYSEC
  330 CONTINUE
  350 CONTINUE
! begin debugging radiation

!     if (Jndx .eq. jmd) then
!       FSWDNS1=(GDFVB(imd)+GDFNB(imd)+GDFVD(imd)+GDFND(imd))*.001
!       write(6,"(3a,2i5,7f9.2)") '{rad2 imd,Jndx,'  &
!      ,'GSW=FSWDNS-FSWUPS,RSWIN=FSWDNS,RSWIN_1=FSWDNS1,' &
!      ,'FSWDNS-FSWDNS1,RSWOUT=FSWUPS,RSWINC=FSWDNSC,GLW=FLWDNS = ' &
!      ,imd,Jndx, FSWDNS(imd)-FSWUPS(imd),FSWDNS(imd),FSWDNS1  &
!      ,FSWDNS(imd)-FSWDNS1,FSWUPS(imd),FSWDNSC(imd),FLWDNS(imd)
!       FSWrat=0.
!       if (FSWDNS(imd) .ne. 0.) FSWrat=FSWUPS(imd)/FSWDNS(imd)
!       FSWrat1=0.
!       if (FSWDNS1 .ne. 0.) FSWrat1=FSWUPS(imd)/FSWDNS1
!       write(6,"(2a,10f8.4)") '{rad2a ALBEDO,SFCALB,ALVD,ALND,ALVB,' &
!      ,'ALNB,CZEN,SLMSK,FSWUPS/FSWDNS,FSWUPS/FSWDNS1 = ' &
!      ,ALBEDO(imd),SFCALB(imd),ALVD(imd),ALND(imd),ALVB(imd)  &
!      ,ALNB(imd),COSZEN(imd),SLMSK(imd),FSWrat,FSWrat1
!     endif
! end debugging radiation
      RETURN
 1000 FORMAT(1H ,' YOU ARE CALLING GFDL RADIATION CODE FOR',I5,' PTS', &
                 'AND',I4,' LYRS,WITH KDAPRX,KO3,KCZ,KEMIS,KALB = ',5I2)
 
  END SUBROUTINE RADFS 

!-----------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!-----------------------------------------------------------------------
    SUBROUTINE O3CLIM
!                (XDUO3N,XDO3N2,XDO3N3,XDO3N4,PRGFDL,         &
!                ids,ide, jds,jde, kds,kde,                   &
!                ims,ime, jms,jme, kms,kme,                   &
!                its,ite, jts,jte, kts,kte                    )
!----------------------------------------------------------------------
 IMPLICIT NONE
!----------------------------------------------------------------------
!     INTEGER, INTENT(IN)        :: ids,ide, jds,jde, kds,kde ,      &
!                                   ims,ime, jms,jme, kms,kme ,      &
!                                   its,ite, jts,jte, kts,kte

!     ******************************************************************
!$$$  SUBPROGRAM DOCUMENTATION BLOCK
!                .      .    .     
! SUBPROGRAM:    O3CLIM      GENERATE SEASONAL OZONE DISTRIBUTION
!   PRGRMMR: GFDL/CAMPANA    ORG: W/NP22     DATE: ??-??-??
!     
! ABSTRACT:
!     O3CLIM COMPUTES THE SEASONAL CLIMATOLOGY OF OZONE USING
!     81-LAYER DATA FROM GFDL.
!     
! PROGRAM HISTORY LOG:
!   ??-??-??  GFDL/KC    - ORIGINATOR
!   96-07-26  BLACK      - MODIFIED FOR ETA MODEL
!     
! USAGE: CALL O3CLIM FROM SUBROUTINE RADTN
!   INPUT ARGUMENT LIST:
!     NONE     
!  
!   OUTPUT ARGUMENT LIST: 
!     NONE
!     
!   OUTPUT FILES:
!     NONE
!     
!   SUBPROGRAMS CALLED:
!  
!     UNIQUE:
!        NONE
!  
!     LIBRARY:
!        NONE
!  
!   COMMON BLOCKS: SEASO3
!                  O3DATA
!   
! ATTRIBUTES:
!   LANGUAGE: FORTRAN 90
!   MACHINE : IBM SP
!$$$  
!----------------------------------------------------------------------
!      INTEGER   :: NL,NLP1,NLGTH,NKK,NK,NKP
       INTEGER, PARAMETER :: NL=81,NLP1=NL+1,NLGTH=37*NL,NKK=41,NK=81,NKP=NK+1
!----------------------------------------------------------------------
!     INCLUDE "SEASO3.comm"
!---------------------------------------------------------------------
!     REAL, INTENT(OUT), DIMENSION(37,NL) :: XDUO3N,XDO3N2,XDO3N3,XDO3N4
!     REAL, INTENT(OUT), DIMENSION(NL)    :: PRGFDL

!      COMMON /SEASO3/
!      ...WINTER....  ...SPRING....  ...SUMMER....  ....FALL.....
!    & XDUO3N(37,NL), XDO3N2(37,NL), XDO3N3(37,NL), XDO3N4(37,NL)
!
!    &,PRGFDL(NL)
!---------------------------------------------------------------------
       REAL :: PH1(45),PH2(37),P1(48),P2(33),O3HI1(10,16),O3HI2(10,9) &
              ,O3LO1(10,16),O3LO2(10,16),O3LO3(10,16),O3LO4(10,16)
!----------------------------------------------------------------------
       REAL    :: AVG,A1,B1,B2
       INTEGER :: K,N,NCASE,IPLACE,KK,NKM,NKMM,KI,KQ,JJ,KEN,I,iindex,jindex
!----------------------------------------------------------------------
       REAL :: PSTD(NL),TEMPN(19),O3O3(37,NL,4),O35DEG(37,NL) &
      ,XRAD1(NLGTH),XRAD2(NLGTH),XRAD3(NLGTH),XRAD4(NLGTH) &
      ,DDUO3N(19,NL),DUO3N(19,41) &
      ,RO3(10,41),RO3M(10,40),RO31(10,41),RO32(10,41) &
      ,O3HI(10,25) &
      ,RSTD(81),RBAR(NL),RDATA(81) &
      ,PHALF(NL),P(81),PH(82)
       REAL   :: PXX(81),PYY(82)                       !  fix for nesting
!----------------------------------------------------------------------
!gopal                           EQUIVALENCE &
!gopal       (O3HI1(1,1),O3HI(1,1)),(O3HI2(1,1),O3HI(1,17)) &
!gopal      ,(PH1(1),PH(1)),(PH2(1),PH(46)) &
!gopal      ,(P1(1),P(1)),(P2(1),P(49))
                           EQUIVALENCE &
       (O3HI1(1,1),O3HI(1,1)),(O3HI2(1,1),O3HI(1,17)) &
      ,(PH1(1),PYY(1)),(PH2(1),PYY(46)) &               ! fix for nesting
      ,(P1(1),PXX(1)),(P2(1),PXX(49))                   ! fix for nesting
!----------------------------------------------------------------------
!                          EQUIVALENCE &
!      (XRAD1(1),XDUO3N(1,1),O3O3(1,1,1)) &
!     ,(XRAD2(1),XDO3N2(1,1)) &
!     ,(XRAD3(1),XDO3N3(1,1)),(XRAD4(1),XDO3N4(1,1),)
                           EQUIVALENCE &
       (XRAD1(1),O3O3(1,1,1)) &
      ,(XRAD2(1),O3O3(1,1,2)) &
      ,(XRAD3(1),O3O3(1,1,3)),(XRAD4(1),O3O3(1,1,4))
!----------------------------------------------------------------------
!---------------------------------------------------------------------
      DATA PH1/      0.,     &
           0.1027246E-04, 0.1239831E-04, 0.1491845E-04, 0.1788053E-04,     &
           0.2135032E-04, 0.2540162E-04, 0.3011718E-04, 0.3558949E-04,     &
           0.4192172E-04, 0.4922875E-04, 0.5763817E-04, 0.6729146E-04,     &
           0.7834518E-04, 0.9097232E-04, 0.1053635E-03, 0.1217288E-03,     &
           0.1402989E-03, 0.1613270E-03, 0.1850904E-03, 0.2119495E-03,     &
           0.2423836E-03, 0.2768980E-03, 0.3160017E-03, 0.3602623E-03,     &
           0.4103126E-03, 0.4668569E-03, 0.5306792E-03, 0.6026516E-03,     &
           0.6839018E-03, 0.7759249E-03, 0.8803303E-03, 0.9987843E-03,     &
           0.1133178E-02, 0.1285955E-02, 0.1460360E-02, 0.1660001E-02,     &
           0.1888764E-02, 0.2151165E-02, 0.2452466E-02, 0.2798806E-02,     &
           0.3197345E-02, 0.3656456E-02, 0.4185934E-02, 0.4797257E-02/     
      DATA PH2/     &
           0.5503893E-02, 0.6321654E-02, 0.7269144E-02, 0.8368272E-02,     &
           0.9644873E-02, 0.1112946E-01, 0.1285810E-01, 0.1487354E-01,     &
           0.1722643E-01, 0.1997696E-01, 0.2319670E-01, 0.2697093E-01,     &
           0.3140135E-01, 0.3660952E-01, 0.4274090E-01, 0.4996992E-01,     &
           0.5848471E-01, 0.6847525E-01, 0.8017242E-01, 0.9386772E-01,     &
           0.1099026E+00, 0.1286765E+00, 0.1506574E+00, 0.1763932E+00,     &
           0.2065253E+00, 0.2415209E+00, 0.2814823E+00, 0.3266369E+00,     &
           0.3774861E+00, 0.4345638E+00, 0.4984375E+00, 0.5697097E+00,     &
           0.6490189E+00, 0.7370409E+00, 0.8344896E+00, 0.9421190E+00,     &
           0.1000000E+01/     
      DATA P1/     &
           0.9300000E-05, 0.1129521E-04, 0.1360915E-04, 0.1635370E-04,     &
           0.1954990E-04, 0.2331653E-04, 0.2767314E-04, 0.3277707E-04,     &
           0.3864321E-04, 0.4547839E-04, 0.5328839E-04, 0.6234301E-04,     &
           0.7263268E-04, 0.8450696E-04, 0.9793231E-04, 0.1133587E-03,     &
           0.1307170E-03, 0.1505832E-03, 0.1728373E-03, 0.1982122E-03,     &
           0.2266389E-03, 0.2592220E-03, 0.2957792E-03, 0.3376068E-03,     &
           0.3844381E-03, 0.4379281E-03, 0.4976965E-03, 0.5658476E-03,     &
           0.6418494E-03, 0.7287094E-03, 0.8261995E-03, 0.9380076E-03,     &
           0.1063498E-02, 0.1207423E-02, 0.1369594E-02, 0.1557141E-02,     &
           0.1769657E-02, 0.2015887E-02, 0.2295520E-02, 0.2620143E-02,     &
           0.2989651E-02, 0.3419469E-02, 0.3909867E-02, 0.4481491E-02,     &
           0.5135272E-02, 0.5898971E-02, 0.6774619E-02, 0.7799763E-02/     
      DATA P2/     &
           0.8978218E-02, 0.1036103E-01, 0.1195488E-01, 0.1382957E-01,     &
           0.1599631E-01, 0.1855114E-01, 0.2151235E-01, 0.2501293E-01,     &
           0.2908220E-01, 0.3390544E-01, 0.3952926E-01, 0.4621349E-01,     &
           0.5403168E-01, 0.6330472E-01, 0.7406807E-01, 0.8677983E-01,     &
           0.1015345E+00, 0.1189603E+00, 0.1391863E+00, 0.1630739E+00,     &
           0.1908004E+00, 0.2235461E+00, 0.2609410E+00, 0.3036404E+00,     &
           0.3513750E+00, 0.4055375E+00, 0.4656677E+00, 0.5335132E+00,     &
           0.6083618E+00, 0.6923932E+00, 0.7845676E+00, 0.8875882E+00,     &
           0.1000000E+01/     
      DATA O3HI1/     &
       .55,.50,.45,.45,.40,.35,.35,.30,.30,.30,     &
       .55,.51,.46,.47,.42,.38,.37,.36,.35,.35,     &
       .55,.53,.48,.49,.44,.42,.41,.40,.38,.38,     &
       .60,.55,.52,.52,.50,.47,.46,.44,.42,.41,     &
       .65,.60,.55,.56,.53,.52,.50,.48,.45,.45,     &
       .75,.65,.60,.60,.55,.55,.55,.50,.48,.47,     &
       .80,.75,.75,.75,.70,.70,.65,.63,.60,.60,     &
       .90,.85,.85,.80,.80,.75,.75,.74,.72,.71,     &
       1.10,1.05,1.00,.90,.90,.90,.85,.83,.80,.80,        &
       1.40,1.30,1.25,1.25,1.25,1.20,1.15,1.10,1.05,1.00, &
       1.7,1.7,1.6,1.6,1.6,1.6,1.6,1.6,1.5,1.5,     &
       2.1,2.0,1.9,1.9,1.9,1.8,1.8,1.8,1.7,1.7,     &
       2.4,2.3,2.2,2.2,2.2,2.1,2.1,2.1,2.0,2.0,     &
       2.7,2.5,2.5,2.5,2.5,2.5,2.4,2.4,2.3,2.3,     &
       2.9,2.8,2.7,2.7,2.7,2.7,2.7,2.7,2.6,2.6,     &
       3.1,3.1,3.0,3.0,3.0,3.0,3.0,3.0,2.9,2.8/     
      DATA O3HI2/     &
       3.3,3.4,3.4,3.6,3.7,3.9,4.0,4.1,4.0,3.8,     &
       3.6,3.8,3.9,4.2,4.7,5.3,5.6,5.7,5.5,5.2,     &
       4.1,4.3,4.7,5.2,6.0,6.7,7.0,6.8,6.4,6.2,     &
       5.4,5.7,6.0,6.6,7.3,8.0,8.4,7.7,7.1,6.7,     &
       6.7,6.8,7.0,7.6,8.3,10.0,9.6,8.2,7.5,7.2,     &
       9.2,9.3,9.4,9.6,10.3,10.6,10.0,8.5,7.7,7.3,     &
       12.6,12.1,12.0,12.1,11.7,11.0,10.0,8.6,7.8,7.4, &
       14.2,13.5,13.1,12.8,11.9,10.9,9.8,8.5,7.8,7.5,  &
       14.3,14.0,13.4,12.7,11.6,10.6,9.3,8.4,7.6,7.3/     
      DATA O3LO1/     &
       14.9,14.2,13.3,12.5,11.2,10.3,9.5,8.6,7.5,7.4,  &
       14.5,14.1,13.0,11.8,10.5,9.8,9.2,7.9,7.4,7.4,   &
       11.8,11.5,10.9,10.5,9.9,9.6,8.9,7.5,7.2,7.2,    &
       7.3,7.7,7.8,8.4,8.4,8.5,7.9,7.4,7.1,7.1,     &
       4.1,4.4,5.3,6.6,6.9,7.5,7.4,7.2,7.0,6.9,     &
       1.8,1.9,2.5,3.3,4.5,5.8,6.3,6.3,6.4,6.1,     &
       0.4,0.5,0.8,1.2,2.7,3.6,4.6,4.7,5.0,5.2,     &
       .10,.15,.20,.50,1.4,2.1,3.0,3.2,3.5,3.9,     &
       .07,.10,.12,.30,1.0,1.4,1.8,1.9,2.3,2.5,     &
       .06,.08,.10,.15,.60,.80,1.4,1.5,1.5,1.6,     &
       .05,.05,.06,.09,.20,.40,.70,.80,.90,.90,     &
       .05,.05,.06,.08,.10,.13,.20,.25,.30,.40,     &
       .05,.05,.05,.06,.07,.07,.08,.09,.10,.13,     &
       .05,.05,.05,.05,.06,.06,.06,.06,.07,.07,     &
       .05,.05,.05,.05,.05,.05,.05,.06,.06,.06,     &
       .04,.04,.04,.04,.04,.04,.04,.05,.05,.05/     
      DATA O3LO2/     &
       14.8,14.2,13.8,12.2,11.0,9.8,8.5,7.8,7.4,6.9,   &
       13.2,13.0,12.5,11.3,10.4,9.0,7.8,7.5,7.0,6.6,   &
       10.6,10.6,10.7,10.1,9.4,8.6,7.5,7.0,6.5,6.1,    &
       7.0,7.3,7.5,7.5,7.5,7.3,6.7,6.4,6.0,5.8,     &
       3.8,4.0,4.7,5.0,5.2,5.9,5.8,5.6,5.5,5.5,     &
       1.4,1.6,2.4,3.0,3.7,4.1,4.6,4.8,5.1,5.0,     &
       .40,.50,.90,1.2,2.0,2.7,3.2,3.6,4.3,4.1,     &
       .07,.10,.20,.30,.80,1.4,2.1,2.4,2.7,3.0,     &
       .06,.07,.09,.15,.30,.70,1.2,1.4,1.6,2.0,     &
       .05,.05,.06,.12,.15,.30,.60,.70,.80,.80,     &
       .04,.05,.06,.08,.09,.15,.30,.40,.40,.40,     &
       .04,.04,.05,.055,.06,.09,.12,.13,.15,.15,    &
       .03,.03,.045,.052,.055,.06,.07,.07,.06,.07,  &
       .03,.03,.04,.051,.052,.052,.06,.06,.05,.05,  &
       .02,.02,.03,.05,.05,.05,.04,.04,.04,.04,     &
       .02,.02,.02,.04,.04,.04,.03,.03,.03,.03/     
      DATA O3LO3/     &
       14.5,14.0,13.5,11.3,11.0,10.0,9.0,8.3,7.5,7.3,    &
       13.5,13.2,12.5,11.1,10.4,9.7,8.2,7.8,7.4,6.8,     &
       10.8,10.9,11.0,10.4,10.0,9.6,7.9,7.5,7.0,6.7,     &
       7.3,7.5,7.8,8.5,9.0,8.5,7.7,7.4,6.9,6.5,     &
       4.1,4.5,5.3,6.2,7.3,7.7,7.3,7.0,6.6,6.4,     &
       1.8,2.0,2.2,3.8,4.3,5.6,6.2,6.2,6.4,6.2,     &
       .30,.50,.60,1.5,2.8,3.7,4.5,4.7,5.5,5.6,     &
       .09,.10,.15,.60,1.2,2.1,3.0,3.5,4.0,4.3,     &
       .06,.08,.10,.30,.60,1.1,1.9,2.2,2.9,3.0,     &
       .04,.05,.06,.15,.45,.60,1.1,1.3,1.6,1.8,     &
       .04,.04,.04,.08,.20,.30,.55,.60,.75,.90,     &
       .04,.04,.04,.05,.06,.10,.12,.15,.20,.25,     &
       .04,.04,.03,.04,.05,.06,.07,.07,.07,.08,     &
       .03,.03,.04,.05,.05,.05,.05,.05,.05,.05,     &
       .03,.03,.03,.04,.04,.04,.05,.05,.04,.04,     &
       .02,.02,.02,.04,.04,.04,.04,.04,.03,.03/      
      DATA O3LO4/     &
       14.2,13.8,13.2,12.5,11.7,10.5,8.6,7.8,7.5,6.6,  &
       12.5,12.4,12.2,11.7,10.8,9.8,7.8,7.2,6.5,6.1,   &
       10.6,10.5,10.4,10.1,9.6,9.0,7.1,6.8,6.1,5.9,    &
       7.0,7.4,7.9,7.8,7.6,7.3,6.2,6.1,5.8,5.6,     &
       4.2,4.6,5.1,5.6,5.9,5.9,5.9,5.8,5.6,5.3,     &
       2.1,2.3,2.6,2.9,3.5,4.3,4.8,4.9,5.1,5.1,     &
       0.7,0.8,1.0,1.5,2.0,2.8,3.5,3.6,3.7,4.0,     &
       .15,.20,.40,.50,.60,1.4,2.1,2.2,2.3,2.5,     &
       .08,.10,.15,.25,.30,.90,1.2,1.3,1.4,1.6,     &
       .07,.08,.10,.14,.20,.50,.70,.90,.90,.80,     &
       .05,.06,.08,.12,.14,.20,.35,.40,.60,.50,     &
       .05,.05,.08,.09,.09,.09,.11,.12,.15,.18,     &
       .04,.05,.06,.07,.07,.08,.08,.08,.08,.08,     &
       .04,.04,.05,.07,.07,.07,.07,.07,.06,.05,     &
       .02,.02,.04,.05,.05,.05,.05,.05,.04,.04,     &
       .02,.02,.03,.04,.04,.04,.04,.04,.03,.03/     
!----------------------------------------------------------------------
!***
!***  COMPUTE DETAILED O3 PROFILE FROM THE ORIGINAL GFDL PRESSURES
!***  WHERE OUTPUT FROM O3INT (PSTD) IS TOP DOWN IN MB*1.E3
!***  AND PSFC=1013.25 MB    ......K.A.C. DEC94
!***
      DO K=1,NK
!        PH(K)=PH(K)*1013250.
!        P(K)=P(K)*1013250.
        PH(K)=PYY(K)*1013250.         ! fix for nesting
        P(K)=PXX(K)*1013250.          ! fix for nesting
      ENDDO
!
!      PH(NKP)=PH(NKP)*1013250.
      PH(NKP)=PYY(NKP)*1013250.       ! fix for nesting
!
      DO K=1,NL
        PSTD(K)=P(K)
      ENDDO
!
      DO K=1,25
      DO N=1,10
        RO31(N,K)=O3HI(N,K)
        RO32(N,K)=O3HI(N,K)
      ENDDO
      ENDDO
!----------------------------------------------------------------------
      DO 100 NCASE=1,4
!
!***  NCASE=1: SPRING (IN N.H.)
!***  NCASE=2: FALL   (IN N.H.)
!***  NCASE=3: WINTER (IN N.H.)
!***  NCASE=4: SUMMER (IN N.H.)
!
      IPLACE=2
      IF(NCASE.EQ.2)IPLACE=4
      IF(NCASE.EQ.3)IPLACE=1
      IF(NCASE.EQ.4)IPLACE=3
!
      IF(NCASE.EQ.1.OR.NCASE.EQ.2)THEN
        DO K=26,41
        DO N=1,10
          RO31(N,K)=O3LO1(N,K-25)
          RO32(N,K)=O3LO2(N,K-25)
        ENDDO
        ENDDO
      ENDIF
!
      IF(NCASE.EQ.3.OR.NCASE.EQ.4)THEN
        DO K=26,41
        DO N=1,10
          RO31(N,K)=O3LO3(N,K-25)
          RO32(N,K)=O3LO4(N,K-25)
        ENDDO
        ENDDO
      ENDIF
!
      DO 25 KK=1,NKK
      DO N=1,10
        DUO3N(N,KK)=RO31(11-N,KK)
        DUO3N(N+9,KK)=RO32(N,KK)
      ENDDO
      DUO3N(10,KK)=0.5*(RO31(1,KK)+RO32(1,KK))
   25 CONTINUE
!
!***FOR NCASE=2 OR NCASE=4,REVERSE LATITUDE ARRANGEMENT OF CORR. SEASON
!
      IF(NCASE.EQ.2.OR.NCASE.EQ.4)THEN
        DO 50 KK=1,NKK
        DO N=1,19
          TEMPN(N)=DUO3N(20-N,KK)
        ENDDO
         DO N=1,19
           DUO3N(N,KK)=TEMPN(N)
         ENDDO
   50   CONTINUE
      ENDIF
!
!***  DUO3N NOW IS O3 PROFILE FOR APPROPRIATE SEASON AT STD PRESSURE
!***  LEVELS
!
!***  BEGIN LATITUDE (10 DEG) LOOP
!
      DO 75 N=1,19
!
      DO KK=1,NKK
        RSTD(KK)=DUO3N(N,KK)
      ENDDO
!
      NKM=NK-1
      NKMM=NK-3
!***
!***  BESSELS HALF-POINT INTERPOLATION FORMULA
!***
      DO K=4,NKMM,2
        KI=K/2
        RDATA(K)=0.5*(RSTD(KI)+RSTD(KI+1))-(RSTD(KI+2)-RSTD(KI+1) &
                                           -RSTD(KI)+RSTD(KI-1))/16.
      ENDDO
!
      RDATA(2)=0.5*(RSTD(2)+RSTD(1))
      RDATA(NKM)=0.5*(RSTD(NKK)+RSTD(NKK-1))
!
!***  PUT UNCHANGED DATA INTO NEW ARRAY
!
      DO K=1,NK,2
        KQ=(K+1)/2
        RDATA(K)=RSTD(KQ)
      ENDDO
!
      DO KK=1,NL
        DDUO3N(N,KK)=RDATA(KK)*.01
      ENDDO
!
   75 CONTINUE
!
!***  END OF LATITUDE LOOP
!
!----------------------------------------------------------------------
!***
!***  CREATE 5 DEG OZONE QUANTITIES BY LINEAR INTERPOLATION OF
!***  10 DEG VALUES
!***
      DO 90 KK=1,NL
!
      DO N=1,19
        O35DEG(2*N-1,KK)=DDUO3N(N,KK)
      ENDDO
!
      DO N=1,18
        O35DEG(2*N,KK)=0.5*(DDUO3N(N,KK)+DDUO3N(N+1,KK))
      ENDDO
!
   90 CONTINUE
!
      DO JJ=1,37
      DO KEN=1,NL
        O3O3(JJ,KEN,IPLACE)=O35DEG(JJ,KEN)
      ENDDO
      ENDDO
!
  100 CONTINUE
!----------------------------------------------------------------------
!***  END OF LOOP OVER CASES
!----------------------------------------------------------------------
!***
!***  AVERAGE CLIMATOLOGICAL VALUS OF O3 FROM 5 DEG LAT MEANS, SO THAT
!***  TIME AND SPACE INTERPOLATION WILL WORK (SEE SUBR OZON2D)
!***
      DO I=1,NLGTH
        AVG=0.25*(XRAD1(I)+XRAD2(I)+XRAD3(I)+XRAD4(I))
        A1=0.5*(XRAD2(I)-XRAD4(I))
        B1=0.5*(XRAD1(I)-XRAD3(I))
        B2=0.25*((XRAD1(I)+XRAD3(I))-(XRAD2(I)+XRAD4(I)))

!       XRAD1(I)=AVG
!       XRAD2(I)=A1
!       XRAD3(I)=B1
!       XRAD4(I)=B2

        iindex = 1+mod((I-1),37)
        jindex = 1+(I-1)/37
        XDUO3N(iindex,jindex)=AVG
        XDO3N2(iindex,jindex)=A1
        XDO3N3(iindex,jindex)=B1
        XDO3N4(iindex,jindex)=B2
      ENDDO
!***
!***  CONVERT GFDL PRESSURE (MICROBARS) TO PA 
!***
      DO N=1,NL
        PRGFDL(N)=PSTD(N)*1.E-1
      ENDDO
!
    END SUBROUTINE O3CLIM

!---------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!---------------------------------------------------------------------
      SUBROUTINE TABLE 
!                     (TABLE1,TABLE2,TABLE3,EM1,EM1WDE,EM3,          &
!                      SOURCE,DSRCE                                  )
!---------------------------------------------------------------------
 IMPLICIT NONE
!----------------------------------------------------------------------

!INTEGER, PARAMETER :: NBLY=15
 INTEGER, PARAMETER :: NB=12
 INTEGER, PARAMETER :: NBLX=47
 INTEGER , PARAMETER:: NBLW = 163

 REAL,PARAMETER ::      AMOLWT=28.9644
 REAL,PARAMETER ::      CSUBP=1.00484E7
 REAL,PARAMETER ::      DIFFCTR=1.66
 REAL,PARAMETER ::      G=980.665
 REAL,PARAMETER ::      GINV=1./G
 REAL,PARAMETER ::      GRAVDR=980.0
 REAL,PARAMETER ::      O3DIFCTR=1.90
 REAL,PARAMETER ::      P0=1013250.
 REAL,PARAMETER ::      P0INV=1./P0
 REAL,PARAMETER ::      GP0INV=GINV*P0INV
 REAL,PARAMETER ::      P0XZP2=202649.902
 REAL,PARAMETER ::      P0XZP8=810600.098
 REAL,PARAMETER ::      P0X2=2.*1013250.
 REAL,PARAMETER ::      RADCON=8.427
 REAL,PARAMETER ::      RADCON1=1./8.427
 REAL,PARAMETER ::      RATCO2MW=1.519449738
 REAL,PARAMETER ::      RATH2OMW=.622
 REAL,PARAMETER ::      RGAS=8.3142E7
 REAL,PARAMETER ::      RGASSP=8.31432E7
 REAL,PARAMETER ::      SECPDA=8.64E4
!
!******THE FOLLOWING ARE MATHEMATICAL CONSTANTS*******
!        ARRANGED IN DECREASING ORDER
 REAL,PARAMETER ::      HUNDRED=100.
 REAL,PARAMETER ::      HNINETY=90.
 REAL,PARAMETER ::      HNINE=9.0
 REAL,PARAMETER ::      SIXTY=60.
 REAL,PARAMETER ::      FIFTY=50.
 REAL,PARAMETER ::      TEN=10.
 REAL,PARAMETER ::      EIGHT=8.
 REAL,PARAMETER ::      FIVE=5.
 REAL,PARAMETER ::      FOUR=4.
 REAL,PARAMETER ::      THREE=3.
 REAL,PARAMETER ::      TWO=2.
 REAL,PARAMETER ::      ONE=1.
 REAL,PARAMETER ::      HAF=0.5
 REAL,PARAMETER ::      QUARTR=0.25
 REAL,PARAMETER ::      ZERO=0.
!
!******FOLLOWING ARE POSITIVE FLOATING POINT CONSTANTS(H'S)
!       ARRANGED IN DECREASING ORDER
 REAL,PARAMETER ::      H83E26=8.3E26
 REAL,PARAMETER ::      H71E26=7.1E26
 REAL,PARAMETER ::      H1E15=1.E15
 REAL,PARAMETER ::      H1E13=1.E13
 REAL,PARAMETER ::      H1E11=1.E11
 REAL,PARAMETER ::      H1E8=1.E8
 REAL,PARAMETER ::      H2E6=2.0E6
 REAL,PARAMETER ::      H1E6=1.0E6
 REAL,PARAMETER ::      H69766E5=6.97667E5
 REAL,PARAMETER ::      H4E5=4.E5
 REAL,PARAMETER ::      H165E5=1.65E5
 REAL,PARAMETER ::      H5725E4=57250.
 REAL,PARAMETER ::      H488E4=48800.
 REAL,PARAMETER ::      H1E4=1.E4
 REAL,PARAMETER ::      H24E3=2400.
 REAL,PARAMETER ::      H20788E3=2078.8
 REAL,PARAMETER ::      H2075E3=2075.
 REAL,PARAMETER ::      H18E3=1800.
 REAL,PARAMETER ::      H1224E3=1224.
 REAL,PARAMETER ::      H67390E2=673.9057
 REAL,PARAMETER ::      H5E2=500.
 REAL,PARAMETER ::      H3082E2=308.2
 REAL,PARAMETER ::      H3E2=300.
 REAL,PARAMETER ::      H2945E2=294.5
 REAL,PARAMETER ::      H29316E2=293.16
 REAL,PARAMETER ::      H26E2=260.0
 REAL,PARAMETER ::      H25E2=250.
 REAL,PARAMETER ::      H23E2=230.
 REAL,PARAMETER ::      H2E2=200.0
 REAL,PARAMETER ::      H15E2=150.
 REAL,PARAMETER ::      H1386E2=138.6
 REAL,PARAMETER ::      H1036E2=103.6
 REAL,PARAMETER ::      H8121E1=81.21
 REAL,PARAMETER ::      H35E1=35.
 REAL,PARAMETER ::      H3116E1=31.16
 REAL,PARAMETER ::      H28E1=28.
 REAL,PARAMETER ::      H181E1=18.1
 REAL,PARAMETER ::      H18E1=18.
 REAL,PARAMETER ::      H161E1=16.1
 REAL,PARAMETER ::      H16E1=16.
 REAL,PARAMETER ::      H1226E1=12.26
 REAL,PARAMETER ::      H9P94=9.94
 REAL,PARAMETER ::      H6P08108=6.081081081
 REAL,PARAMETER ::      H3P6=3.6
 REAL,PARAMETER ::      H3P5=3.5
 REAL,PARAMETER ::      H2P9=2.9
 REAL,PARAMETER ::      H2P8=2.8
 REAL,PARAMETER ::      H2P5=2.5
 REAL,PARAMETER ::      H1P8=1.8
 REAL,PARAMETER ::      H1P4387=1.4387
 REAL,PARAMETER ::      H1P41819=1.418191
 REAL,PARAMETER ::      H1P4=1.4
 REAL,PARAMETER ::      H1P25892=1.258925411
 REAL,PARAMETER ::      H1P082=1.082
 REAL,PARAMETER ::      HP816=0.816
 REAL,PARAMETER ::      HP805=0.805
 REAL,PARAMETER ::      HP8=0.8
 REAL,PARAMETER ::      HP60241=0.60241
 REAL,PARAMETER ::      HP602409=0.60240964
 REAL,PARAMETER ::      HP6=0.6
 REAL,PARAMETER ::      HP526315=0.52631579
 REAL,PARAMETER ::      HP518=0.518
 REAL,PARAMETER ::      HP5048=0.5048
 REAL,PARAMETER ::      HP3795=0.3795
 REAL,PARAMETER ::      HP369=0.369
 REAL,PARAMETER ::      HP26=0.26
 REAL,PARAMETER ::      HP228=0.228
 REAL,PARAMETER ::      HP219=0.219
 REAL,PARAMETER ::      HP166666=.166666
 REAL,PARAMETER ::      HP144=0.144
 REAL,PARAMETER ::      HP118666=0.118666192
 REAL,PARAMETER ::      HP1=0.1
!        (NEGATIVE EXPONENTIALS BEGIN HERE)
 REAL,PARAMETER ::      H658M2=0.0658
 REAL,PARAMETER ::      H625M2=0.0625
 REAL,PARAMETER ::      H44871M2=4.4871E-2
 REAL,PARAMETER ::      H44194M2=.044194
 REAL,PARAMETER ::      H42M2=0.042
 REAL,PARAMETER ::      H41666M2=0.0416666
 REAL,PARAMETER ::      H28571M2=.02857142857
 REAL,PARAMETER ::      H2118M2=0.02118
 REAL,PARAMETER ::      H129M2=0.0129
 REAL,PARAMETER ::      H1M2=.01
 REAL,PARAMETER ::      H559M3=5.59E-3
 REAL,PARAMETER ::      H3M3=0.003
 REAL,PARAMETER ::      H235M3=2.35E-3
 REAL,PARAMETER ::      H1M3=1.0E-3
 REAL,PARAMETER ::      H987M4=9.87E-4
 REAL,PARAMETER ::      H323M4=0.000323
 REAL,PARAMETER ::      H3M4=0.0003
 REAL,PARAMETER ::      H285M4=2.85E-4
 REAL,PARAMETER ::      H1M4=0.0001
 REAL,PARAMETER ::      H75826M4=7.58265E-4
 REAL,PARAMETER ::      H6938M5=6.938E-5
 REAL,PARAMETER ::      H394M5=3.94E-5
 REAL,PARAMETER ::      H37412M5=3.7412E-5
 REAL,PARAMETER ::      H15M5=1.5E-5
 REAL,PARAMETER ::      H1439M5=1.439E-5
 REAL,PARAMETER ::      H128M5=1.28E-5
 REAL,PARAMETER ::      H102M5=1.02E-5
 REAL,PARAMETER ::      H1M5=1.0E-5
 REAL,PARAMETER ::      H7M6=7.E-6
 REAL,PARAMETER ::      H4999M6=4.999E-6
 REAL,PARAMETER ::      H451M6=4.51E-6
 REAL,PARAMETER ::      H25452M6=2.5452E-6
 REAL,PARAMETER ::      H1M6=1.E-6
 REAL,PARAMETER ::      H391M7=3.91E-7
 REAL,PARAMETER ::      H1174M7=1.174E-7
 REAL,PARAMETER ::      H8725M8=8.725E-8
 REAL,PARAMETER ::      H327M8=3.27E-8
 REAL,PARAMETER ::      H257M8=2.57E-8
 REAL,PARAMETER ::      H1M8=1.0E-8
 REAL,PARAMETER ::      H23M10=2.3E-10
 REAL,PARAMETER ::      H14M10=1.4E-10
 REAL,PARAMETER ::      H11M10=1.1E-10
 REAL,PARAMETER ::      H1M10=1.E-10
 REAL,PARAMETER ::      H83M11=8.3E-11
 REAL,PARAMETER ::      H82M11=8.2E-11
 REAL,PARAMETER ::      H8M11=8.E-11
 REAL,PARAMETER ::      H77M11=7.7E-11
 REAL,PARAMETER ::      H72M11=7.2E-11
 REAL,PARAMETER ::      H53M11=5.3E-11
 REAL,PARAMETER ::      H48M11=4.8E-11
 REAL,PARAMETER ::      H44M11=4.4E-11
 REAL,PARAMETER ::      H42M11=4.2E-11
 REAL,PARAMETER ::      H37M11=3.7E-11
 REAL,PARAMETER ::      H35M11=3.5E-11
 REAL,PARAMETER ::      H32M11=3.2E-11
 REAL,PARAMETER ::      H3M11=3.0E-11
 REAL,PARAMETER ::      H28M11=2.8E-11
 REAL,PARAMETER ::      H24M11=2.4E-11
 REAL,PARAMETER ::      H23M11=2.3E-11
 REAL,PARAMETER ::      H2M11=2.E-11
 REAL,PARAMETER ::      H18M11=1.8E-11
 REAL,PARAMETER ::      H15M11=1.5E-11
 REAL,PARAMETER ::      H14M11=1.4E-11
 REAL,PARAMETER ::      H114M11=1.14E-11
 REAL,PARAMETER ::      H11M11=1.1E-11
 REAL,PARAMETER ::      H1M11=1.E-11
 REAL,PARAMETER ::      H96M12=9.6E-12
 REAL,PARAMETER ::      H93M12=9.3E-12
 REAL,PARAMETER ::      H77M12=7.7E-12
 REAL,PARAMETER ::      H74M12=7.4E-12
 REAL,PARAMETER ::      H65M12=6.5E-12
 REAL,PARAMETER ::      H62M12=6.2E-12
 REAL,PARAMETER ::      H6M12=6.E-12
 REAL,PARAMETER ::      H45M12=4.5E-12
 REAL,PARAMETER ::      H44M12=4.4E-12
 REAL,PARAMETER ::      H4M12=4.E-12
 REAL,PARAMETER ::      H38M12=3.8E-12
 REAL,PARAMETER ::      H37M12=3.7E-12
 REAL,PARAMETER ::      H3M12=3.E-12
 REAL,PARAMETER ::      H29M12=2.9E-12
 REAL,PARAMETER ::      H28M12=2.8E-12
 REAL,PARAMETER ::      H24M12=2.4E-12
 REAL,PARAMETER ::      H21M12=2.1E-12
 REAL,PARAMETER ::      H16M12=1.6E-12
 REAL,PARAMETER ::      H14M12=1.4E-12
 REAL,PARAMETER ::      H12M12=1.2E-12
 REAL,PARAMETER ::      H8M13=8.E-13
 REAL,PARAMETER ::      H46M13=4.6E-13
 REAL,PARAMETER ::      H36M13=3.6E-13
 REAL,PARAMETER ::      H135M13=1.35E-13
 REAL,PARAMETER ::      H12M13=1.2E-13
 REAL,PARAMETER ::      H1M13=1.E-13
 REAL,PARAMETER ::      H3M14=3.E-14
 REAL,PARAMETER ::      H15M14=1.5E-14
 REAL,PARAMETER ::      H14M14=1.4E-14
!
!******FOLLOWING ARE NEGATIVE FLOATING POINT CONSTANTS (HM'S)
!          ARRANGED IN DESCENDING ORDER
 REAL,PARAMETER ::      HM2M2=-.02
 REAL,PARAMETER ::      HM6666M2=-.066667
 REAL,PARAMETER ::      HMP5=-0.5
 REAL,PARAMETER ::      HMP575=-0.575
 REAL,PARAMETER ::      HMP66667=-.66667
 REAL,PARAMETER ::      HMP805=-0.805
 REAL,PARAMETER ::      HM1EZ=-1.
 REAL,PARAMETER ::      HM13EZ=-1.3
 REAL,PARAMETER ::      HM19EZ=-1.9
 REAL,PARAMETER ::      HM1E1=-10.
 REAL,PARAMETER ::      HM1597E1=-15.97469413
 REAL,PARAMETER ::      HM161E1=-16.1
 REAL,PARAMETER ::      HM1797E1=-17.97469413
 REAL,PARAMETER ::      HM181E1=-18.1
 REAL,PARAMETER ::      HM8E1=-80.
 REAL,PARAMETER ::      HM1E2=-100.
!
 REAL,PARAMETER ::      H1M16=1.0E-16
 REAL,PARAMETER ::      H1M20=1.E-20
 REAL,PARAMETER ::      HP98=0.98
 REAL,PARAMETER ::      Q19001=19.001
 REAL,PARAMETER ::      DAYSEC=1.1574E-5
 REAL,PARAMETER ::      HSIGMA=5.673E-5
 REAL,PARAMETER ::      TWENTY=20.0
 REAL,PARAMETER ::      HP537=0.537
 REAL,PARAMETER ::      HP2=0.2
 REAL,PARAMETER ::      RCO2=3.3E-4
 REAL,PARAMETER ::      H3M6=3.0E-6
 REAL,PARAMETER ::      PI=3.1415927
 REAL,PARAMETER ::      DEGRAD1=180.0/PI
 REAL,PARAMETER ::      H74E1=74.0
 REAL,PARAMETER ::      H15E1=15.0

 REAL, PARAMETER:: B0 = -.51926410E-4
 REAL, PARAMETER:: B1 = -.18113332E-3
 REAL, PARAMETER:: B2 = -.10680132E-5
 REAL, PARAMETER:: B3 = -.67303519E-7
 REAL, PARAMETER:: AWIDE = 0.309801E+01
 REAL, PARAMETER:: BWIDE = 0.495357E-01
 REAL, PARAMETER:: BETAWD = 0.347839E+02
 REAL, PARAMETER:: BETINW = 0.766811E+01


!     REAL, INTENT(OUT) :: EM1(28,180),EM1WDE(28,180),TABLE1(28,180), &
!                          TABLE2(28,180),TABLE3(28,180),EM3(28,180), &
!                          SOURCE(28,NBLY), DSRCE(28,NBLY)

!
      REAL :: ARNDM(NBLW),BRNDM(NBLW),BETAD(NBLW)
      REAL :: BANDLO(NBLW),BANDHI(NBLW)

      INTEGER :: IBAND(40)

      REAL :: BANDL1(64),BANDL2(64),BANDL3(35)
      REAL :: BANDH1(64),BANDH2(64),BANDH3(35) 
!     REAL :: AB15WD,SKO2D,SKC1R,SKO3R

!     REAL :: AWIDE,BWIDE,BETAWD,BETINW

!     DATA AWIDE  / 0.309801E+01/
!     DATA BWIDE  / 0.495357E-01/
!     DATA BETAWD / 0.347839E+02/
!     DATA BETINW / 0.766811E+01/

!
!% #NPADL = #PAGE*#NPAGE -  4*28*180  -  2*181 - 7*28 - 180 ;
!% #NPADL = #NPADL       -  11*28  - 2*180 - 2*30 ;

!     PARAMETER (NPADL = #NPADL - 28*NBLX - 2*28*NBLW - 7*NBLW)

      REAL,DIMENSION(28,180) :: SUM,PERTSM,SUM3,SUMWDE
      REAL,DIMENSION(28,NBLX) :: SRCWD
      REAL,DIMENSION(28,NBLW) :: SRC1NB,DBDTNB
      REAL,DIMENSION(181) :: ZMASS,ZROOT
      REAL,DIMENSION(180) :: EXPO,FAC,X2
      REAL,DIMENSION(30) :: CNUSB,DNUSB
      REAL,DIMENSION(28) :: SC,DSC,XTEMV,TFOUR,FORTCU,X,X1,SRCS &
                           ,SUM4,SUM6,SUM7,SUM8,SUM4WD     &
                           ,R1T,R2,S2,T3,R1WD
      REAL,dimension(NBLW) ::  ALFANB,AROTNB,ANB,BNB,CENTNB,DELNB,BETANB

      REAL,DIMENSION(2) :: AB15
      REAL,DIMENSION(64) :: ARNDM1,ARNDM2,BRNDM1,BRNDM2,BETAD1,BETAD2
      REAL,DIMENSION(35) :: ARNDM3,BRNDM3,BETAD3

      EQUIVALENCE (ARNDM1(1),ARNDM(1)),(ARNDM2(1),ARNDM(65)), &
                  (ARNDM3(1),ARNDM(129))
      EQUIVALENCE (BRNDM1(1),BRNDM(1)),(BRNDM2(1),BRNDM(65)), &
                  (BRNDM3(1),BRNDM(129))
      EQUIVALENCE (BETAD1(1),BETAD(1)),(BETAD2(1),BETAD(65)), &
                  (BETAD3(1),BETAD(129))

!---------------------------------------------------------------
      REAL    :: CENT,DEL,BDLO,BDHI,C1,ANU,tmp
      INTEGER :: N,I,ICNT,I1,I2E,I2
      INTEGER :: J,JP,NSUBDS,NSB,IA

!---------------------------------------------------------------

      DATA IBAND  / &
          2,   1,   2,   2,   1,   2,   1,   3,   2,   2, &
          3,   2,   2,   4,   2,   4,   2,   3,   3,   2, &
          4,   3,   4,   3,   7,   5,   6,   7,   6,   5, &
          7,   6,   7,   8,   6,   6,   8,   8,   8,   8/

      DATA BANDL1 / &
         0.000000E+00,  0.100000E+02,  0.200000E+02,  0.300000E+02, &
         0.400000E+02,  0.500000E+02,  0.600000E+02,  0.700000E+02, &
         0.800000E+02,  0.900000E+02,  0.100000E+03,  0.110000E+03, &
         0.120000E+03,  0.130000E+03,  0.140000E+03,  0.150000E+03, &
         0.160000E+03,  0.170000E+03,  0.180000E+03,  0.190000E+03, &
         0.200000E+03,  0.210000E+03,  0.220000E+03,  0.230000E+03, &
         0.240000E+03,  0.250000E+03,  0.260000E+03,  0.270000E+03, &
         0.280000E+03,  0.290000E+03,  0.300000E+03,  0.310000E+03, &
         0.320000E+03,  0.330000E+03,  0.340000E+03,  0.350000E+03, &
         0.360000E+03,  0.370000E+03,  0.380000E+03,  0.390000E+03, &
         0.400000E+03,  0.410000E+03,  0.420000E+03,  0.430000E+03, &
         0.440000E+03,  0.450000E+03,  0.460000E+03,  0.470000E+03, &
         0.480000E+03,  0.490000E+03,  0.500000E+03,  0.510000E+03, &
         0.520000E+03,  0.530000E+03,  0.540000E+03,  0.550000E+03, &
         0.560000E+03,  0.670000E+03,  0.800000E+03,  0.900000E+03, &
         0.990000E+03,  0.107000E+04,  0.120000E+04,  0.121000E+04/
      DATA BANDL2 / &
         0.122000E+04,  0.123000E+04,  0.124000E+04,  0.125000E+04, &
         0.126000E+04,  0.127000E+04,  0.128000E+04,  0.129000E+04, &
         0.130000E+04,  0.131000E+04,  0.132000E+04,  0.133000E+04, &
         0.134000E+04,  0.135000E+04,  0.136000E+04,  0.137000E+04, &
         0.138000E+04,  0.139000E+04,  0.140000E+04,  0.141000E+04, &
         0.142000E+04,  0.143000E+04,  0.144000E+04,  0.145000E+04, &
         0.146000E+04,  0.147000E+04,  0.148000E+04,  0.149000E+04, &
         0.150000E+04,  0.151000E+04,  0.152000E+04,  0.153000E+04, &
         0.154000E+04,  0.155000E+04,  0.156000E+04,  0.157000E+04, &
         0.158000E+04,  0.159000E+04,  0.160000E+04,  0.161000E+04, &
         0.162000E+04,  0.163000E+04,  0.164000E+04,  0.165000E+04, &
         0.166000E+04,  0.167000E+04,  0.168000E+04,  0.169000E+04, &
         0.170000E+04,  0.171000E+04,  0.172000E+04,  0.173000E+04, &
         0.174000E+04,  0.175000E+04,  0.176000E+04,  0.177000E+04, &
         0.178000E+04,  0.179000E+04,  0.180000E+04,  0.181000E+04, &
         0.182000E+04,  0.183000E+04,  0.184000E+04,  0.185000E+04/
      DATA BANDL3 / &
         0.186000E+04,  0.187000E+04,  0.188000E+04,  0.189000E+04, &
         0.190000E+04,  0.191000E+04,  0.192000E+04,  0.193000E+04, &
         0.194000E+04,  0.195000E+04,  0.196000E+04,  0.197000E+04, &
         0.198000E+04,  0.199000E+04,  0.200000E+04,  0.201000E+04, &
         0.202000E+04,  0.203000E+04,  0.204000E+04,  0.205000E+04, &
         0.206000E+04,  0.207000E+04,  0.208000E+04,  0.209000E+04, &
         0.210000E+04,  0.211000E+04,  0.212000E+04,  0.213000E+04, &
         0.214000E+04,  0.215000E+04,  0.216000E+04,  0.217000E+04, &
         0.218000E+04,  0.219000E+04,  0.227000E+04/

      DATA BANDH1 / &
         0.100000E+02,  0.200000E+02,  0.300000E+02,  0.400000E+02, &
         0.500000E+02,  0.600000E+02,  0.700000E+02,  0.800000E+02, &
         0.900000E+02,  0.100000E+03,  0.110000E+03,  0.120000E+03, &
         0.130000E+03,  0.140000E+03,  0.150000E+03,  0.160000E+03, &
         0.170000E+03,  0.180000E+03,  0.190000E+03,  0.200000E+03, &
         0.210000E+03,  0.220000E+03,  0.230000E+03,  0.240000E+03, &
         0.250000E+03,  0.260000E+03,  0.270000E+03,  0.280000E+03, &
         0.290000E+03,  0.300000E+03,  0.310000E+03,  0.320000E+03, &
         0.330000E+03,  0.340000E+03,  0.350000E+03,  0.360000E+03, &
         0.370000E+03,  0.380000E+03,  0.390000E+03,  0.400000E+03, &
         0.410000E+03,  0.420000E+03,  0.430000E+03,  0.440000E+03, &
         0.450000E+03,  0.460000E+03,  0.470000E+03,  0.480000E+03, &
         0.490000E+03,  0.500000E+03,  0.510000E+03,  0.520000E+03, &
         0.530000E+03,  0.540000E+03,  0.550000E+03,  0.560000E+03, &
         0.670000E+03,  0.800000E+03,  0.900000E+03,  0.990000E+03, &
         0.107000E+04,  0.120000E+04,  0.121000E+04,  0.122000E+04/
      DATA BANDH2 / &
         0.123000E+04,  0.124000E+04,  0.125000E+04,  0.126000E+04, &
         0.127000E+04,  0.128000E+04,  0.129000E+04,  0.130000E+04, &
         0.131000E+04,  0.132000E+04,  0.133000E+04,  0.134000E+04, &
         0.135000E+04,  0.136000E+04,  0.137000E+04,  0.138000E+04, &
         0.139000E+04,  0.140000E+04,  0.141000E+04,  0.142000E+04, &
         0.143000E+04,  0.144000E+04,  0.145000E+04,  0.146000E+04, &
         0.147000E+04,  0.148000E+04,  0.149000E+04,  0.150000E+04, &
         0.151000E+04,  0.152000E+04,  0.153000E+04,  0.154000E+04, &
         0.155000E+04,  0.156000E+04,  0.157000E+04,  0.158000E+04, &
         0.159000E+04,  0.160000E+04,  0.161000E+04,  0.162000E+04, &
         0.163000E+04,  0.164000E+04,  0.165000E+04,  0.166000E+04, &
         0.167000E+04,  0.168000E+04,  0.169000E+04,  0.170000E+04, &
         0.171000E+04,  0.172000E+04,  0.173000E+04,  0.174000E+04, &
         0.175000E+04,  0.176000E+04,  0.177000E+04,  0.178000E+04, &
         0.179000E+04,  0.180000E+04,  0.181000E+04,  0.182000E+04, &
         0.183000E+04,  0.184000E+04,  0.185000E+04,  0.186000E+04/
      DATA BANDH3 / &
         0.187000E+04,  0.188000E+04,  0.189000E+04,  0.190000E+04, &
         0.191000E+04,  0.192000E+04,  0.193000E+04,  0.194000E+04, &
         0.195000E+04,  0.196000E+04,  0.197000E+04,  0.198000E+04, &
         0.199000E+04,  0.200000E+04,  0.201000E+04,  0.202000E+04, &
         0.203000E+04,  0.204000E+04,  0.205000E+04,  0.206000E+04, &
         0.207000E+04,  0.208000E+04,  0.209000E+04,  0.210000E+04, &
         0.211000E+04,  0.212000E+04,  0.213000E+04,  0.214000E+04, &
         0.215000E+04,  0.216000E+04,  0.217000E+04,  0.218000E+04, &
         0.219000E+04,  0.220000E+04,  0.238000E+04/

!
!***THE FOLLOWING DATA STATEMENTS ARE BAND PARAMETERS OBTAINED USING
!   THE 1982 AFGL CATALOG ON THE SPECIFIED BANDS
      DATA ARNDM1  / &
         0.354693E+00,  0.269857E+03,  0.167062E+03,  0.201314E+04, &
         0.964533E+03,  0.547971E+04,  0.152933E+04,  0.599429E+04, &
         0.699329E+04,  0.856721E+04,  0.962489E+04,  0.233348E+04, &
         0.127091E+05,  0.104383E+05,  0.504249E+04,  0.181227E+05, &
         0.856480E+03,  0.136354E+05,  0.288635E+04,  0.170200E+04, &
         0.209761E+05,  0.126797E+04,  0.110096E+05,  0.336436E+03, &
         0.491663E+04,  0.863701E+04,  0.540389E+03,  0.439786E+04, &
         0.347836E+04,  0.130557E+03,  0.465332E+04,  0.253086E+03, &
         0.257387E+04,  0.488041E+03,  0.892991E+03,  0.117148E+04, &
         0.125880E+03,  0.458852E+03,  0.142975E+03,  0.446355E+03, &
         0.302887E+02,  0.394451E+03,  0.438112E+02,  0.348811E+02, &
         0.615503E+02,  0.143165E+03,  0.103958E+02,  0.725108E+02, &
         0.316628E+02,  0.946456E+01,  0.542675E+02,  0.351557E+02, &
         0.301797E+02,  0.381010E+01,  0.126319E+02,  0.548010E+01, &
         0.600199E+01,  0.640803E+00,  0.501549E-01,  0.167961E-01, &
         0.178110E-01,  0.170166E+00,  0.273514E-01,  0.983767E+00/
      DATA ARNDM2  / &
         0.753946E+00,  0.941763E-01,  0.970547E+00,  0.268862E+00, &
         0.564373E+01,  0.389794E+01,  0.310955E+01,  0.128235E+01, &
         0.196414E+01,  0.247113E+02,  0.593435E+01,  0.377552E+02, &
         0.305173E+02,  0.852479E+01,  0.116780E+03,  0.101490E+03, &
         0.138939E+03,  0.324228E+03,  0.683729E+02,  0.471304E+03, &
         0.159684E+03,  0.427101E+03,  0.114716E+03,  0.106190E+04, &
         0.294607E+03,  0.762948E+03,  0.333199E+03,  0.830645E+03, &
         0.162512E+04,  0.525676E+03,  0.137739E+04,  0.136252E+04, &
         0.147164E+04,  0.187196E+04,  0.131118E+04,  0.103975E+04, &
         0.621637E+01,  0.399459E+02,  0.950648E+02,  0.943161E+03, &
         0.526821E+03,  0.104150E+04,  0.905610E+03,  0.228142E+04, &
         0.806270E+03,  0.691845E+03,  0.155237E+04,  0.192241E+04, &
         0.991871E+03,  0.123907E+04,  0.457289E+02,  0.146146E+04, &
         0.319382E+03,  0.436074E+03,  0.374214E+03,  0.778217E+03, &
         0.140227E+03,  0.562540E+03,  0.682685E+02,  0.820292E+02, &
         0.178779E+03,  0.186150E+03,  0.383864E+03,  0.567416E+01/ 
      DATA ARNDM3  / &
         0.225129E+03,  0.473099E+01,  0.753149E+02,  0.233689E+02, &
         0.339802E+02,  0.108855E+03,  0.380016E+02,  0.151039E+01, &
         0.660346E+02,  0.370165E+01,  0.234169E+02,  0.440206E+00, &
         0.615283E+01,  0.304077E+02,  0.117769E+01,  0.125248E+02, &
         0.142652E+01,  0.241831E+00,  0.483721E+01,  0.226357E-01, &
         0.549835E+01,  0.597067E+00,  0.404553E+00,  0.143584E+01, &
         0.294291E+00,  0.466273E+00,  0.156048E+00,  0.656185E+00, &
         0.172727E+00,  0.118349E+00,  0.141598E+00,  0.588581E-01, &
         0.919409E-01,  0.155521E-01,  0.537083E-02/
      DATA BRNDM1  / &
         0.789571E-01,  0.920256E-01,  0.696960E-01,  0.245544E+00, &
         0.188503E+00,  0.266127E+00,  0.271371E+00,  0.330917E+00, &
         0.190424E+00,  0.224498E+00,  0.282517E+00,  0.130675E+00, &
         0.212579E+00,  0.227298E+00,  0.138585E+00,  0.187106E+00, &
         0.194527E+00,  0.177034E+00,  0.115902E+00,  0.118499E+00, &
         0.142848E+00,  0.216869E+00,  0.149848E+00,  0.971585E-01, &
         0.151532E+00,  0.865628E-01,  0.764246E-01,  0.100035E+00, &
         0.171133E+00,  0.134737E+00,  0.105173E+00,  0.860832E-01, &
         0.148921E+00,  0.869234E-01,  0.106018E+00,  0.184865E+00, &
         0.767454E-01,  0.108981E+00,  0.123094E+00,  0.177287E+00, &
         0.848146E-01,  0.119356E+00,  0.133829E+00,  0.954505E-01, &
         0.155405E+00,  0.164167E+00,  0.161390E+00,  0.113287E+00, &
         0.714720E-01,  0.741598E-01,  0.719590E-01,  0.140616E+00, &
         0.355356E-01,  0.832779E-01,  0.128680E+00,  0.983013E-01, &
         0.629660E-01,  0.643346E-01,  0.717082E-01,  0.629730E-01, &
         0.875182E-01,  0.857907E-01,  0.358808E+00,  0.178840E+00/
      DATA BRNDM2  / &
         0.254265E+00,  0.297901E+00,  0.153916E+00,  0.537774E+00, &
         0.267906E+00,  0.104254E+00,  0.400723E+00,  0.389670E+00, &
         0.263701E+00,  0.338116E+00,  0.351528E+00,  0.267764E+00, &
         0.186419E+00,  0.238237E+00,  0.210408E+00,  0.176869E+00, &
         0.114715E+00,  0.173299E+00,  0.967770E-01,  0.172565E+00, &
         0.162085E+00,  0.157782E+00,  0.886832E-01,  0.242999E+00, &
         0.760298E-01,  0.164248E+00,  0.221428E+00,  0.166799E+00, &
         0.312514E+00,  0.380600E+00,  0.353828E+00,  0.269500E+00, &
         0.254759E+00,  0.285408E+00,  0.159764E+00,  0.721058E-01, &
         0.170528E+00,  0.231595E+00,  0.307184E+00,  0.564136E-01, &
         0.159884E+00,  0.147907E+00,  0.185666E+00,  0.183567E+00, &
         0.182482E+00,  0.230650E+00,  0.175348E+00,  0.195978E+00, &
         0.255323E+00,  0.198517E+00,  0.195500E+00,  0.208356E+00, &
         0.309603E+00,  0.112011E+00,  0.102570E+00,  0.128276E+00, &
         0.168100E+00,  0.177836E+00,  0.105533E+00,  0.903330E-01, &
         0.126036E+00,  0.101430E+00,  0.124546E+00,  0.221406E+00/ 
      DATA BRNDM3  / &
         0.137509E+00,  0.911365E-01,  0.724508E-01,  0.795788E-01, &
         0.137411E+00,  0.549175E-01,  0.787714E-01,  0.165544E+00, &
         0.136484E+00,  0.146729E+00,  0.820496E-01,  0.846211E-01, &
         0.785821E-01,  0.122527E+00,  0.125359E+00,  0.101589E+00, &
         0.155756E+00,  0.189239E+00,  0.999086E-01,  0.480993E+00, &
         0.100233E+00,  0.153754E+00,  0.130780E+00,  0.136136E+00, &
         0.159353E+00,  0.156634E+00,  0.272265E+00,  0.186874E+00, &
         0.192090E+00,  0.135397E+00,  0.131497E+00,  0.127463E+00, &
         0.227233E+00,  0.190562E+00,  0.214005E+00/ 
      DATA BETAD1  / &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.234879E+03,  0.217419E+03,  0.201281E+03,  0.186364E+03, &
         0.172576E+03,  0.159831E+03,  0.148051E+03,  0.137163E+03, &
         0.127099E+03,  0.117796E+03,  0.109197E+03,  0.101249E+03, &
         0.939031E+02,  0.871127E+02,  0.808363E+02,  0.750349E+02, &
         0.497489E+02,  0.221212E+02,  0.113124E+02,  0.754174E+01, &
         0.589554E+01,  0.495227E+01,  0.000000E+00,  0.000000E+00/ 
      DATA BETAD2  / &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00/ 
      DATA BETAD3  / &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00,  0.000000E+00, &
         0.000000E+00,  0.000000E+00,  0.000000E+00/ 
!---------------------------------------------------------------
!     EQUIVALENCE (BANDL1(1),BANDLO(1)),(BANDL2(1),BANDLO(65)), &
!                 (BANDL3(1),BANDLO(129))

!     L     = kme-1
!     LP1   = L+1
!     LP1V  = LP1*(1+2*L/2)
!     IMAX  = ite
!     LP2   = L + 2
 
      DO I = 1,64
         BANDLO(I)=BANDL1(I)
      ENDDO

      DO I = 65,128
         BANDLO(I)=BANDL2(I-64)
      ENDDO

      DO I = 129,163
         BANDLO(I)=BANDL3(I-128)
      ENDDO

      DO I = 1,64
         BANDHI(I)=BANDH1(I)
      ENDDO

      DO I = 65,128
         BANDHI(I)=BANDH2(I-64)
      ENDDO

      DO I = 129,163
         BANDHI(I)=BANDH3(I-128)
      ENDDO

!****************************************
!***COMPUTE LOCAL QUANTITIES AND AO3,BO3,AB15
!....FOR NARROW-BANDS...
      DO 101 N=1,NBLW
      ANB(N)=ARNDM(N)
      BNB(N)=BRNDM(N)
      CENTNB(N)=HAF*(BANDLO(N)+BANDHI(N))
      DELNB(N)=BANDHI(N)-BANDLO(N)
      BETANB(N)=BETAD(N)
101   CONTINUE
      AB15(1)=ANB(57)*BNB(57)
      AB15(2)=ANB(58)*BNB(58)
!....FOR WIDE BANDS...
      AB15WD=AWIDE*BWIDE
!
!***COMPUTE INDICES: IND,INDX2,KMAXV
!SH   ICNT=0
!SH   DO 113 I1=1,L
!SH     I2E=LP1-I1
!SH     DO 115 I2=1,I2E
!SH       ICNT=ICNT+1
!SH       INDX2(ICNT)=LP1*(I2-1)+LP2*I1
!SH115     CONTINUE
!SH113   CONTINUE
!SH   KMAXV(1)=1
!SH   DO 117 I=2,L
!SH   KMAXV(I)=KMAXV(I-1)+(LP2-I)
117   CONTINUE
!SH   KMAXVM=KMAXV(L)
!***COMPUTE RATIOS OF CONT. COEFFS
      SKC1R=BETAWD/BETINW
      SKO3R=BETAD(61)/BETINW
      SKO2D=ONE/BETINW
!
!****BEGIN TABLE COMPUTATIONS HERE***
!***COMPUTE TEMPS, MASSES FOR TABLE ENTRIES
!---NOTE: THE DIMENSIONING AND INITIALIZATION OF XTEMV AND OTHER ARRAYS
!   WITH DIMENSION OF 28 IMPLY A RESTRICTION OF MODEL TEMPERATURES FROM
!   100K TO 370K.
!---THE DIMENSIONING OF ZMASS,ZROOT AND OTHER ARRAYS WITH DIMENSION OF
!   180 IMPLY A RESTRICTION OF MODEL H2O AMOUNTS SUCH THAT OPTICAL PATHS
!   ARE BETWEEN 10**-16 AND 10**2, IN CGS UNITS.
      ZMASS(1)=H1M16
      DO 201 J=1,180
      JP=J+1
      ZROOT(J)=SQRT(ZMASS(J))
      ZMASS(JP)=ZMASS(J)*H1P25892
201   CONTINUE
      DO 203 I=1,28
      XTEMV(I)=HNINETY+TEN*I
      TFOUR(I)=XTEMV(I)*XTEMV(I)*XTEMV(I)*XTEMV(I)
      FORTCU(I)=FOUR*XTEMV(I)*XTEMV(I)*XTEMV(I)
203   CONTINUE
!******THE COMPUTATION OF SOURCE,DSRCE IS  NEEDED ONLY
!   FOR THE COMBINED WIDE-BAND CASE.TO OBTAIN THEM,THE SOURCE
!   MUST BE COMPUTED FOR EACH OF THE (NBLX) WIDE BANDS(=SRCWD)
!   THEN COMBINED (USING IBAND) INTO SOURCE.
      DO 205 N=1,NBLY
      DO 205 I=1,28
      SOURCE(I,N)=ZERO
205   CONTINUE
      DO 207 N=1,NBLX
      DO 207 I=1,28
      SRCWD(I,N)=ZERO
207   CONTINUE
!---BEGIN FREQ. LOOP (ON N)
      DO 211 N=1,NBLX
        IF (N.LE.46) THEN
!***THE 160-1200 BAND CASES
          CENT=CENTNB(N+16)
          DEL=DELNB(N+16)
          BDLO=BANDLO(N+16)
          BDHI=BANDHI(N+16)
        ENDIF
        IF (N.EQ.NBLX) THEN
!***THE 2270-2380 BAND CASE
          CENT=CENTNB(NBLW)
          DEL=DELNB(NBLW)
          BDLO=BANDLO(NBLW)
          BDHI=BANDHI(NBLW)
        ENDIF
!***FOR PURPOSES OF ACCURACY, ALL EVALUATIONS OF PLANCK FCTNS ARE MADE
!  ON 10 CM-1 INTERVALS, THEN SUMMED INTO THE (NBLX) WIDE BANDS.
      NSUBDS=(DEL-H1M3)/10+1
      DO 213 NSB=1,NSUBDS
      IF (NSB.NE.NSUBDS) THEN
        CNUSB(NSB)=TEN*(NSB-1)+BDLO+FIVE
        DNUSB(NSB)=TEN
      ELSE
        CNUSB(NSB)=HAF*(TEN*(NSB-1)+BDLO+BDHI)
        DNUSB(NSB)=BDHI-(TEN*(NSB-1)+BDLO)
      ENDIF
      C1=(H37412M5)*CNUSB(NSB)**3
!---BEGIN TEMP. LOOP (ON I)
      DO 215 I=1,28
      X(I)=H1P4387*CNUSB(NSB)/XTEMV(I)
      X1(I)=EXP(X(I))
      SRCS(I)=C1/(X1(I)-ONE)
      SRCWD(I,N)=SRCWD(I,N)+SRCS(I)*DNUSB(NSB)
215   CONTINUE
213   CONTINUE
211   CONTINUE
!***THE FOLLOWING LOOPS CREATE THE COMBINED WIDE BAND QUANTITIES SOURCE
!   AND DSRCE
      DO 221 N=1,40
      DO 221 I=1,28
      SOURCE(I,IBAND(N))=SOURCE(I,IBAND(N))+SRCWD(I,N)
221   CONTINUE
      DO 223 N=9,NBLY
      DO 223 I=1,28
      SOURCE(I,N)=SRCWD(I,N+32)
223   CONTINUE
      DO 225 N=1,NBLY
      DO 225 I=1,27
      DSRCE(I,N)=(SOURCE(I+1,N)-SOURCE(I,N))*HP1
225   CONTINUE
      DO 231 N=1,NBLW
      ALFANB(N)=BNB(N)*ANB(N)
      AROTNB(N)=SQRT(ALFANB(N))
231   CONTINUE
!***FIRST COMPUTE PLANCK FCTNS (SRC1NB) AND DERIVATIVES (DBDTNB) FOR
!   USE IN TABLE EVALUATIONS. THESE ARE DIFFERENT FROM SOURCE,DSRCE
!   BECAUSE DIFFERENT FREQUENCY PTS ARE USED IN EVALUATION, THE FREQ.
!   RANGES ARE DIFFERENT, AND THE DERIVATIVE ALGORITHM IS DIFFERENT.
!
      DO 301 N=1,NBLW
      CENT=CENTNB(N)
      DEL=DELNB(N)
!---NOTE: AT PRESENT, THE IA LOOP IS ONLY USED FOR IA=2. THE LOOP STRUCT
!   IS KEPT SO THAT IN THE FUTURE, WE MAY USE A QUADRATURE SCHEME FOR
!   THE PLANCK FCTN EVALUATION, RATHER THAN USE THE MID-BAND FREQUENCY.
#if 0
      DO 303 IA=1,3
#else
!jm -- getting floating point exceptions for IA=1, since 2 is only
!      used anyway, I disabled the looping.
      DO 303 IA=2,2
#endif
      ANU=CENT+HAF*(IA-2)*DEL
      C1=(H37412M5)*ANU*ANU*ANU+H1M20
!---TEMPERATURE LOOP---
      DO 305 I=1,28
         X(I)=H1P4387*ANU/XTEMV(I)
         X1(I)=EXP(X(I))
!#$      tmp=max((X1(I)-ONE),H1M20)
!#$      SC(I)=C1/tmp
         SC(I)=C1/((X1(I)-ONE)+H1M20)
!#$      DSC(I)=X(I)*SC(I)*SC(I)*X1(I)/(XTEMV(I)*C1)
         DSC(I)=SC(I)*SC(I)*X(I)*X1(I)/(XTEMV(I)*C1)
305      CONTINUE
      IF (IA.EQ.2) THEN
         DO 307 I=1,28
         SRC1NB(I,N)=DEL*SC(I)
         DBDTNB(I,N)=DEL*DSC(I)
307      CONTINUE
      ENDIF
303   CONTINUE
301   CONTINUE
!***NEXT COMPUTE R1T,R2,S2,AND T3- COEFFICIENTS USED FOR E3 FUNCTION
!   WHEN THE OPTICAL PATH IS LESS THAN 10-4. IN THIS CASE, WE ASSUME A
!   DIFFERENT DEPENDENCE ON (ZMASS).
!---ALSO OBTAIN R1WD, WHICH IS R1T SUMMED OVER THE 160-560 CM-1 RANGE
      DO 311 I=1,28
      SUM4(I)=ZERO
      SUM6(I)=ZERO
      SUM7(I)=ZERO
      SUM8(I)=ZERO
      SUM4WD(I)=ZERO
311   CONTINUE
      DO 313 N=1,NBLW
      CENT=CENTNB(N)
!***PERFORM SUMMATIONS FOR FREQ. RANGES OF 0-560,1200-2200 CM-1 FOR SUM4
!   SUM6,SUM7,SUM8
      IF (CENT.LT.560. .OR. CENT.GT.1200..AND.CENT.LE.2200.) THEN
         DO 315 I=1,28
         SUM4(I)=SUM4(I)+SRC1NB(I,N)
         SUM6(I)=SUM6(I)+DBDTNB(I,N)
         SUM7(I)=SUM7(I)+DBDTNB(I,N)*AROTNB(N)
         SUM8(I)=SUM8(I)+DBDTNB(I,N)*ALFANB(N)
315      CONTINUE
      ENDIF
!***PERFORM SUMMATIONS OVER 160-560 CM-1 FREQ RANGE FOR E1 CALCS (SUM4WD
      IF (CENT.GT.160. .AND. CENT.LT.560.) THEN
         DO 316 I=1,28
         SUM4WD(I)=SUM4WD(I)+SRC1NB(I,N)
316      CONTINUE
      ENDIF
313   CONTINUE
      DO 317 I=1,28
      R1T(I)=SUM4(I)/TFOUR(I)
      R2(I)=SUM6(I)/FORTCU(I)
      S2(I)=SUM7(I)/FORTCU(I)
      T3(I)=SUM8(I)/FORTCU(I)
      R1WD(I)=SUM4WD(I)/TFOUR(I)
317   CONTINUE
      DO 401 J=1,180
      DO 401 I=1,28
      SUM(I,J)=ZERO
      PERTSM(I,J)=ZERO
      SUM3(I,J)=ZERO
      SUMWDE(I,J)=ZERO
401   CONTINUE
!---FREQUENCY LOOP BEGINS---
      DO 411 N=1,NBLW
      CENT=CENTNB(N)
!***PERFORM CALCULATIONS FOR FREQ. RANGES OF 0-560,1200-2200 CM-1
      IF (CENT.LT.560. .OR. CENT.GT.1200..AND.CENT.LE.2200.) THEN
         DO 413 J=1,180
         X2(J)=AROTNB(N)*ZROOT(J)
         EXPO(J)=EXP(-X2(J))
413      CONTINUE
         DO 415 J=1,180
         IF (X2(J).GE.HUNDRED) THEN
              EXPO(J)=ZERO
         ENDIF
415      CONTINUE
         DO 417 J=121,180
         FAC(J)=ZMASS(J)*(ONE-(ONE+X2(J))*EXPO(J))/(X2(J)*X2(J))
417      CONTINUE
         DO 419 J=1,180
         DO 419 I=1,28
         SUM(I,J)=SUM(I,J)+SRC1NB(I,N)*EXPO(J)
         PERTSM(I,J)=PERTSM(I,J)+DBDTNB(I,N)*EXPO(J)
419      CONTINUE
         DO 421 J=121,180
         DO 421 I=1,28
         SUM3(I,J)=SUM3(I,J)+DBDTNB(I,N)*FAC(J)
421      CONTINUE
      ENDIF
!---COMPUTE SUM OVER 160-560 CM-1 RANGE FOR USE IN E1 CALCS (SUMWDE)
      IF (CENT.GT.160. .AND. CENT.LT.560.) THEN
         DO 420 J=1,180
         DO 420 I=1,28
         SUMWDE(I,J)=SUMWDE(I,J)+SRC1NB(I,N)*EXPO(J)
420      CONTINUE
      ENDIF
411   CONTINUE
      DO 431 J=1,180
      DO 431 I=1,28
      EM1(I,J)=SUM(I,J)/TFOUR(I)
      TABLE1(I,J)=PERTSM(I,J)/FORTCU(I)
431   CONTINUE
      DO 433 J=121,180
      DO 433 I=1,28
        N = 28*(J-1)+I
        EM3V(N)=SUM3(I,J)/FORTCU(I)
433   CONTINUE
      DO 441 J=1,179
      DO 441 I=1,28
      TABLE2(I,J)=(TABLE1(I,J+1)-TABLE1(I,J))*TEN
441   CONTINUE
      DO 443 J=1,180
      DO 443 I=1,27
      TABLE3(I,J)=(TABLE1(I+1,J)-TABLE1(I,J))*HP1
443   CONTINUE
      DO 445 I=1,28
      TABLE2(I,180)=ZERO
445   CONTINUE
      DO 447 J=1,180
      TABLE3(28,J)=ZERO
447   CONTINUE
      DO 449 J=1,2
      DO 449 I=1,28
      EM1(I,J)=R1T(I)
449   CONTINUE
      DO 451 J=1,120
      DO 451 I=1,28
        N = 28*(J-1)+I
        EM3V(N)=R2(I)/TWO-S2(I)*SQRT(ZMASS(J))/THREE+T3(I)*ZMASS(J)/EIGHT
451   CONTINUE
      DO 453 J=121,180
      DO 453 I=1,28
       N = 28*(J-1)+I
       EM3V(N)=EM3V(N)/ZMASS(J)
453   CONTINUE
!***NOW COMPUTE E1 TABLES FOR 160-560 CM-1 BANDS ONLY.
!   WE USE R1WD AND SUMWDE OBTAINED ABOVE.
      DO 501 J=1,180
      DO 501 I=1,28
      EM1WDE(I,J)=SUMWDE(I,J)/TFOUR(I)
501   CONTINUE
      DO 503 J=1,2
      DO 503 I=1,28
      EM1WDE(I,J)=R1WD(I)
503   CONTINUE
   
      END SUBROUTINE TABLE
!---------------------------------------------------------------------
!*********************************************************************
!---------------------------------------------------------------------
    SUBROUTINE SOLARD(IHRST,IDAY,MONTH,JULYR)
!---------------------------------------------------------------------
    IMPLICIT NONE
!---------------------------------------------------------------------
!$$$  SUBPROGRAM DOCUMENTATION BLOCK
!                .      .    .                               .
! SUBPROGRAM:    SOLARD      COMPUTE THE SOLAR-EARTH DISTANCE
!   PRGRMMR: Q.ZHAO           ORG: W/NMC2     DATE: 96-7-23       
!     
! ABSTRACT:
!     SOLARD CALCULATES THE SOLAR-EARTH DISTANCE ON EACH DAY
!     FOR USE IN SHORT-WAVE RADIATION.
!     
! PROGRAM HISTORY LOG:
!   96-07-23  Q.ZHAO      - ORIGINATOR
!   98-10-09  Q.ZHAO      - CHANGED TO USE IW3JDN IN W3LIB TO
!                           CALCULATE JD.
!   04-11-18  Y.-T. HOU   - FIXED ERROR IN JULIAN DAY CALCULATION
!     
! USAGE: CALL SOLARD FROM SUBROUTINE INIT
!
!   INPUT ARGUMENT LIST:
!       NONE
!  
!   OUTPUT ARGUMENT LIST: 
!       R1   - THE NON-DIMENSIONAL DISTANCE BETWEEN SUN AND THE EARTH
!              (LESS THAN 1.0 IN SUMMER AND LARGER THAN 1.0 IN WINTER).
!     
!   INPUT FILES:
!     NONE
!        
!   OUTPUT FILES:
!     NONE
!     
!   SUBPROGRAMS CALLED:
!  
!     UNIQUE: NONE
!  
!     LIBRARY: IW3JDN
!  
!   COMMON BLOCKS: CTLBLK
!   
! ATTRIBUTES:
!   LANGUAGE: FORTRAN 90
!   MACHINE : IBM SP
!***********************************************************************
     REAL, PARAMETER :: PI=3.1415926,PI2=2.*PI
!-----------------------------------------------------------------------
!     INTEGER, INTENT(IN ) :: IHRST,IDAT(3)
      INTEGER, INTENT(IN ) :: IHRST,IDAY,MONTH,JULYR
!     REAL   , INTENT(OUT) :: R1
!-----------------------------------------------------------------------
      INTEGER :: NDM(12),JYR19,JMN
      REAL    :: CCR

      DATA JYR19/1900/, JMN/0/, CCR/1.3E-6/
      DATA NDM/0,31,59,90,120,151,181,212,243,273,304,334/
 
!.....TPP = DAYS BETWEEN EPOCH AND PERIHELION PASSAGE OF 1900
!.....JDOR1 = JD OF DECEMBER 30, 1899 AT 12 HOURS UT
!.....JDOR2 = JD OF EPOCH WHICH IS JANUARY 0, 1990 AT 12 HOURS UT
!
      REAL    :: TPP
      DATA TPP/1.55/

      INTEGER :: JDOR2,JDOR1
      DATA JDOR2/2415020/, JDOR1/2415019/

      REAL    :: DAYINC,DAT,T,YEAR,DATE,EM,E,EC,EP,CR,FJD,FJD1
      INTEGER :: JHR,JD,ITER
!
!     LIBRARY: IW3JDN
!
!    --------------------------------------------------------------------
!     COMPUTES JULIAN DAY AND FRACTION FROM YEAR, MONTH, DAY AND TIME UT
!     ACCURATE ONLY BETWEEN MARCH 1, 1900 AND FEBRUARY 28, 2100
!     BASED ON JULIAN CALENDAR CORRECTED TO CORRESPOND TO GREGORIAN
!     CALENDAR DURING THIS PERIOD
!    --------------------------------------------------------------------
      MYPE=MYPE_SHARE
      JHR=IHRST
!
      JD=IDAY-32075                                                     &
             +1461*(JULYR+4800+(MONTH-14)/12)/4                         &
             +367*(MONTH-2-(MONTH-14)/12*12)/12                         &
             -3*((JULYR+4900+(MONTH-14)/12)/100)/4
      IF(JHR.LT.12)THEN
        JD=JD-1
        FJD=.5+.041666667*REAL(JHR)+.00069444444*REAL(JMN)
      ELSE
  7     FJD=.041666667E0*FLOAT(JHR-12)+.00069444444E0*FLOAT(JMN)
      END IF
      DAYINC=JHR/24.0
      FJD1=JD+FJD+DAYINC
      JD=FJD1
      FJD=FJD1-JD
!***
!*** CALCULATE THE SOLAR-EARTH DISTANCE
!***
      DAT=REAL(JD-JDOR2)-TPP+FJD
!***
!    COMPUTES TIME IN JULIAN CENTURIES AFTER EPOCH
!***
      T=FLOAT(JD-JDOR2)/36525.E0
!***
!    COMPUTES LENGTH OF ANOMALISTIC AND TROPICAL YEARS (MINUS 365 DAYS)
!***
      YEAR=.25964134E0+.304E-5*T
!***
!    COMPUTES ORBIT ECCENTRICITY FROM T
!***
      EC=.01675104E0-(.418E-4+.126E-6*T)*T
      YEAR=YEAR+365.E0
!***
!    DATE=DAYS SINCE LAST PERIHELION PASSAGE
!***
      DATE = MOD(DAT,YEAR)
!***
!    SOLVE ORBIT EQUATIONS BY NEWTON'S METHOD
!***
      EM=PI2*DATE/YEAR
      E=1.E0
      ITER = 0
 31   EP=E-(E-EC*SIN(E)-EM)/(1.E0-EC*COS(E))
      CR=ABS(E-EP)
      E=EP
      ITER = ITER + 1
      IF(ITER.GT.10) GOTO 1031
      IF(CR.GT.CCR) GO TO 31
 1031 CONTINUE
      R1=1.E0-EC*COS(E)
!
      IF(MYPE==0)THEN
      WRITE(0,1000)JULYR,MONTH,IDAY,IHRST,R1
 1000 FORMAT('SUN-EARTH DISTANCE CALCULATION FINISHED IN SOLARD'/ &
             'YEAR=',I5,'  MONTH=',I3,'  DAY=',I3,' HOUR=' &
      ,      I3,' R1=',F9.4)
      ENDIF
!***
!    RETURN TO RADTN
!***
    END SUBROUTINE SOLARD
!---------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!---------------------------------------------------------------------
    SUBROUTINE CAL_MON_DAY(JULDAY,julyr,Jmonth,Jday)     
!---------------------------------------------------------------------
    IMPLICIT NONE
!-----------------------------------------------------------------------
    INTEGER, INTENT(IN) :: JULDAY,julyr
    INTEGER, INTENT(OUT) :: Jmonth,Jday
    LOGICAL :: LEAP,NOT_FIND_DATE
    INTEGER :: MONTH (12),itmpday,itmpmon,i
!-----------------------------------------------------------------------
    DATA MONTH/31,28,31,30,31,30,31,31,30,31,30,31/
!***********************************************************************
    NOT_FIND_DATE = .true.

    itmpday = JULDAY
    itmpmon = 1
    LEAP=.FALSE.
    IF(MOD(julyr,4).EQ.0)THEN
      MONTH(2)=29
      LEAP=.TRUE.
    ENDIF

    i = 1
    DO WHILE (NOT_FIND_DATE)
       IF(itmpday.GT.MONTH(i))THEN
         itmpday=itmpday-MONTH(i)
       ELSE
         Jday=itmpday
         Jmonth=i
         NOT_FIND_DATE = .false.
       ENDIF
       i = i+1
    END DO

    END SUBROUTINE CAL_MON_DAY
!-----------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!-----------------------------------------------------------------------
      REAL FUNCTION ANTEMP(L,Z)
      INTEGER :: L,N,nlast
      REAL :: Z
      REAL,DIMENSION(10,7) :: ZB,DELTA
      REAL,DIMENSION(11,7) :: C
      REAL,DIMENSION(7) :: TSTAR
      real :: expo,expp,fac,faclog,temp,x,y,zlog
! ************** TROPICAL SOUNDING **************************
      DATA (ZB(N,1),N=1,10)/  2.0,   3.0,   16.5,  21.5,  45.0, &
                              51.0,  70.0,  100.,  200.,  300./
      DATA (C(N,1),N=1,11)/ -6.0,  -4.0,  -6.7,   4.0,   2.2,   &
                         1.0,  -2.8,  -.27,   0.0,   0.0,  0.0/
      DATA (DELTA(N,1),N=1,10)/.5,    .5,    .3,    .5,    1.0, &
                              1.0,   1.0,   1.0,   1.0,    1.0/
! ************** SUB-TROPICAL SUMMER ************************
      DATA (ZB(N,2),N=1,10)/ 1.5,   6.5,  13.0,  18.0,  26.0, &
                              36.0,  48.0,  50.0, 70.0,  100./
      DATA (C(N,2),N=1,11)/ -4.0,  -6.0,  -6.5,   0.0,   1.2, &
                        2.2,   2.5,   0.0,  -3.0,  -0.25,  0.0/
      DATA (DELTA(N,2),N=1,10)/ .5,  1.0,    .5,    .5,   1.0, &
                              1.0,  2.5,    .5,   1.0,   1.0/
! ************** SUB-TROPICAL WINTER ************************
      DATA (ZB(N,3),N=1,10)/ 3.0,  10.0,  19.0,  25.0,  32.0, &
                              44.5, 50.0,  71.0,  98.0,  200.0/
      DATA (C(N,3),N=1,11)/ -3.5,  -6.0,  -0.5,  0.0,   0.4, &
                              3.2,   1.6,  -1.8, -0.7,   0.0,   0.0/
      DATA (DELTA(N,3),N=1,10)/ .5,   .5,  1.0,   1.0,   1.0, &
                              1.0,  1.0,  1.0,   1.0,   1.0/
! *************  SUB-ARCTIC SUMMER *************************
      DATA (ZB(N,4),N=1,10)/ 4.7, 10.0,  23.0,  31.8,  44.0, &
                              50.2, 69.2, 100.0, 102.0, 103.0/
      DATA (C(N,4),N=1,11)/ -5.3, -7.0,   0.0,  1.4,   3.0, &
                               0.7, -3.3,  -0.2,  0.0,   0.0,  0.0/
      DATA (DELTA(N,4),N=1,10)/ .5,   .3,  1.0,   1.0,   2.0, &
                              1.0,  1.5,  1.0,   1.0,   1.0/
! ************ SUB-ARCTIC WINTER *****************************
      DATA (ZB(N,5),N=1,10)/ 1.0,   3.2,   8.5,   15.5,   25.0, &
                              30.0,  35.0,  50.0,  70.0,  100.0/
      DATA (C(N,5),N=1,11)/ 3.0,  -3.2,  -6.8,  0.0,  -0.6, &
                              1.0,   1.2,   2.5, -0.7,  -1.2,  0.0/
      DATA (DELTA(N,5),N=1,10)/ .4,   1.5,    .3 ,   .5,   1.0, &
                              1.0,   1.0,   1.0,   1.0,   1.0/
! ************ US STANDARD 1976 ******************************
      DATA (ZB(N,6),N=1,10)/ 11.0,  20.0,  32.0,  47.0,  51.0, & 
                             71.0,  84.8520,  90.0,  91.0,  92.0/
      DATA (C(N,6),N=1,11)/ -6.5,   0.0,   1.0,   2.80,  0.0, &
                             -2.80, -2.00,  0.0,   0.0,   0.0,  0.0/
      DATA (DELTA(N,6),N=1,10)/ 0.3,   1.0,   1.0,   1.0,   1.0, &
                              1.0,   1.0,   1.0,   1.0,   1.0/
!
! ************ ENLARGED US STANDARD 1976 **********************
      DATA (ZB(N,7),N=1,10)/ 11.0,  20.0,  32.0,  47.0,  51.0, &
                             71.0,  84.8520,  90.0,  91.0,  92.0/
      DATA (C(N,7),N=1,11)/ -6.5,   0.0,   1.0,   2.80,  0.0, &
                             -2.80, -2.00,  0.0,   0.0,   0.0,  0.0/
      DATA (DELTA(N,7),N=1,10)/ 0.3,   1.0,   1.0,   1.0,   1.0, &
                              1.0,   1.0,   1.0,   1.0,   1.0/
!
      DATA TSTAR/ 300.0,  294.0,  272.2,  287.0,  257.1, 2*288.15/
!
      NLAST=10
      TEMP=TSTAR(L)+C(1,L)*Z
      DO 20 N=1,NLAST
      EXPO=(Z-ZB(N,L))/DELTA(N,L)
      EXPP=ZB(N,L)/DELTA(N,L)
!JD single-precision change
!      FAC=EXP(EXPP)+EXP(-EXPP)
!mp	write(6,*) '.........................................'
!mp what in the hell does the next line do?
!mp	
!mp	apparently if statement <0 or =0 then 23, else 24
!mp     IF(ABS(EXPO)-100.0) 23,23,24
!
! changed to a more reasonable value for the workstation	
!
      IF(ABS(EXPO)-50.0) 23,23,24
   23 X=EXP(EXPO)
      Y=X+1.0/X
      ZLOG=ALOG(Y)
      GO TO 25
   24 ZLOG=ABS(EXPO)
!mp   25 IF(EXPP-100.0) 27,27,28
   25 IF(EXPP-50.0) 27,27,28
!JD single-precision change
   27 FAC=EXP(EXPP)+EXP(-EXPP)
      FACLOG=ALOG(FAC)
      GO TO 29
   28 FACLOG=EXPP
!     TEMP=TEMP+(C(N+1,L)-C(N,L))*0.5*(Z+DELTA(N,L)*
!    1     ALOG((EXP(EXPO)+EXP(-EXPO))/FAC))
   29 TEMP=TEMP+(C(N+1,L)-C(N,L))*0.5*(Z+DELTA(N,L)* &
           (ZLOG-FACLOG))
!mp	write(6,*) 'ANTEMP pieces (C,C,ZLOG,FACLOG)', C(N+1,L),C(N,L),
!mp     +	ZLOG,FACLOG
   20 CONTINUE
      ANTEMP=TEMP

      END FUNCTION ANTEMP
!-----------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!-----------------------------------------------------------------------

      SUBROUTINE COEINT(RAT,IR)
! **********************************************************************
!
!
!            THE TRANSMISSION FUNCTION BETWEEN P1 AND P2 IS ASSUMED TO
!       THE  FUNCTIONAL FORM
!                     TAU(P1,P2)= 1.0-SQRT(C*LOG(1.0+X*PATH)),
!               WHERE
!                     PATH(P1,P2)=((P1-P2)**2)*(P1+P2+CORE)/
!                                 (ETA*(P1+P2+CORE)+(P1-P2))
!
!
!        THE PARAMETERS C AND X ARE FUNCTIONS OF P2, AND ARE TO BE DETER
!        WHILE CORE IS A PRESPECIFIED NUMBER.ETA IS A FUNCTION OF THE TH
!        PRODUCT (CX);IT IS OBTAITED ITERATIVELY. THE DERIVATION OF ALL
!        VALUES WILL BE EXPLAINED IN A FORTHCOMING PAPER.
!            SUBROUTINE COEINT DETERMINES C(I) AND X(I) BY USING THE ACT
!        VALUES OF TAU(P(I-2),P(I)) AND TAU(P(I-1),P(I)) AND THE PREVIOU
!        ITERATION VALUE OF ETA.
!             DEFINE:
!                PATHA=PATH(P(I),P(I-2),CORE,ETA)
!                PATHB=PATH(P(I),P(I-1),CORE,ETA);
!        THEN
!                R=(1-TAU(P(I),P(I-2)))/(1-TAU(P(I),P(I-1)))
!                 = SQRT(LOG(1+X*PATHA)/LOG(1+X*PATHB)),
!        SO THAT
!                R**2= LOG(1+X*PATHA)/LOG(1+X*PATHB).
!        THIS EQUATION CAN BE SOLVED BY NEWTON S METHOD FOR X AND THEN T
!        RESULT USED TO FIND C. THIS IS REPEATED FOR EACH VALUE OF I GRE
!        THAN 2 TO GIVE THE ARRAYS X(I) AND C(I).
!             NEWTON S METHOD FOR SOLVING THE EQUATION
!                 F(X)=0
!        MAKES USE OF THE LOOP XNEW= XOLD-F(XOLD)/FPRIME(XOLD).
!        THIS IS ITERATED 20 TIMES, WHICH IS PROBABLY EXCESSIVE.
!        THE FIRST GUESS FOR ETA IS 3.2E-4*EXP(-P(I)/1000),WHICH HAS
!        BEEN FOUND TO BE FAIRLY REALISTIC BY EXPERIMENT; WE ITERATE 5 T
!        (AGAIN,PROBABLY EXCESSIVELY) TO OBTAIN THE VALUES FOR C,X,ETA T
!        USED FOR INTERPOLATION.
!           THERE ARE SEVERAL POSSIBLE PITFALLS:
!              1) IN THE COURSE OF ITERATION, X MAY REACH A VALUE WHICH
!                 1+X*PATHA NEGATIVE; IN THIS CASE THE ITERATION IS STOP
!                 AND AN ERROR MESSAGE IS PRINTED OUT.
!              2) EVEN IF (1) DOES NOT OCCUR, IT IS STILL POSSIBLE THAT
!                 BE NEGATIVE AND LARGE ENOUGH TO MAKE 1+X*PATH(P(I),0,C
!                 NEGATIVE. THIS IS CHECKED FOR IN A FINAL LOOP, AND IF
!                 A WARNING IS PRINTED OUT.
!
!  *********************************************************************
!....
!     IMPLICIT DOUBLE PRECISION (A-H,O-Z)
!     COMMON/PRESS/PA(109)
      INTEGER :: IR
      REAL RAT
!     REAL PA,CORE,TRANSA,PATH,UEXP,SEXP,ETA,SEXPV
      REAL PA2
!     COMMON/TRAN/ TRANSA(109,109)
!     COMMON/COEFS/XA(109),CA(109),ETA(109),SEXPV(109),CORE,UEXP,SEXP
      REAL,DIMENSION(109) :: PATH0,ETAP,XAP,CAP
      REAL,DIMENSION(4),SAVE :: SINV=(/2.74992,2.12731,4.38111,0.0832926/)
      INTEGER :: IERR
      integer :: i,ll,np
      real :: arg1,arg2,check,f,f1,f2,fprime,patha,pathb,r,rexp,xx
!NOV89   DIMENSION SINV(3)
!NOV89   DATA SINV/2.74992,2.12731,4.38111/
!O222  OLD CODE USED 2.7528 RATHER THAN 2.74992 ---K.A.C. OCTOBER 1988
!O222   WHEN 2.7528 WAS USED,WE EXACTLY REPRODUCED THE MRF CO2 ARRAYS
      CORE=5.000
      UEXP=0.90
!      P0=0.7
      DO 902 I=1,109
      PA2=PA(I)*PA(I)
      SEXPV(I)=.505+2.0E-5*PA(I)+.035*(PA2-.25)/(PA2+.25)
902   CONTINUE
      DO 900 I=1,109
      ETA(I)=3.2E-4*EXP(-PA(I)/500.)
      ETAP(I)=ETA(I)
900   CONTINUE
      DO 1200 NP=1,10
      DO 1000 I=3,109
      SEXP=SEXPV(I)
      R=(1.0D0-TRANSA(I,I-2))/(1.0D0-TRANSA(I,I-1))
      REXP=R**(UEXP/SEXP)
      arg1=path(pa(i),pa(i-2),core,eta(i))
      arg2=path(pa(i),pa(i-1),core,eta(i))
      PATHA=(PATH(PA(I),PA(I-2),CORE,ETA(I)))**UEXP
      PATHB=(PATH(PA(I),PA(I-1),CORE,ETA(I)))**UEXP
      XX=2.0D0*(PATHB*REXP-PATHA)/(PATHB*PATHB*REXP-PATHA*PATHA)
      DO 1010 LL=1,20
      F1=DLOG(1.0D0+XX*PATHA)
      F2=DLOG(1.0D0+XX*PATHB)
      F=F1/F2-REXP
      FPRIME=(F2*PATHA/(1.0D0+XX*PATHA)-F1*PATHB/(1.0D0+XX*PATHB))/ &
          (F2*F2)
      XX=XX-F/FPRIME
      CHECK=1.0D0+XX*PATHA
!!!!  IF (CHECK) 1020,1020,1025
      IF(CHECK.LE.0.)THEN
        WRITE(0,360)I,LL,CHECK
        WRITE(0,*)' xx=',xx,' patha=',patha
  360   FORMAT(' ERROR,I=',I3,'LL=',I3,'CHECK=',F20.10)
!!!     CALL ESMF_Finalize(terminationflag=ESMF_ABORT)
        CALL NMMB_FINALIZE
      ENDIF
 1010 CONTINUE
      CA(I)=(1.0D0-TRANSA(I,I-2))**(UEXP/SEXP)/ &
       (DLOG(1.0D0+XX*PATHA)+1.0D-20)
      XA(I)=XX
1000  CONTINUE
      XA(2)=XA(3)
      XA(1)=XA(3)
      CA(2)=CA(3)
      CA(1)=CA(3)
      DO 1100 I=3,109
      PATH0(I)=(PATH(PA(I),0.,CORE,ETA(I)))**UEXP
      PATH0(I)=1.0D0+XA(I)*PATH0(I)
!+++  IF (PATH0(I).LT.0.) WRITE (6,361) I,PATH0(I),XA(I)
1100  CONTINUE
      DO 1035 I=1,109
      SEXP=SEXPV(I)
      ETAP(I)=ETA(I)
      ETA(I)=(SINV(IR)/RAT)**(1./SEXP)* &
        (CA(I)*XA(I))**(1./UEXP)
1035  CONTINUE
!
!     THE ETA FORMULATION IS DETAILED IN SCHWARZKOPF AND FELS(1985).
!        THE QUANTITY SINV=(G*DELTANU)/(RCO2*D*S)
!      IN CGS UNITS,WITH D,THE DIFFUSICITY FACTOR=2, AND
!      S,THE SUM OF CO2 LINE STRENGTHS OVER THE 15UM CO2 BAND
!       ALSO,THE DENOMINATOR IS MULTIPLIED BY
!      1000 TO PERMIT USE OF MB UNITS FOR PRESSURE.
!        S IS ACTUALLY WEIGHTED BY B(250) AT 10 CM-1 WIDE INTERVALS,IN
!      ORDER TO BE CONSISTENT WITH THE METHODS USED TO OBTAIN THE LBL
!      1-BAND CONSOLIDATED TRANCMISSION FUNCTIONS.
!      FOR THE 490-850 INTERVAL (DELTANU=360,IR=1) SINV=2.74992.
!      (SLIGHTLY DIFFERENT FROM 2.7528 USED IN EARLIER VERSIONS)
!      FOR THE 490-670 INTERVAL (IR=2) SINV=2.12731
!      FOR THE 670-850 INTERVAL (IR=3) SINV=4.38111
!      FOR THE 2270-2380 INTERVAL (IR=4) SINV=0.0832926
!      SINV HAS BEEN OBTAINED USING THE 1982 AFGL CATALOG FOR CO2
!        RAT IS THE ACTUAL CO2 MIXING RATIO IN UNITS OF 330 PPMV,
!      LETTING USE OF THIS FORMULATION FOR ANY CO2 CONCENTRATION.
!
!     WRITE (6,366) (NP,I,CA(I),XA(I),ETA(I),SEXPV(I),I=1,109)
!366   FORMAT (2I4,4E20.12)
1200  CONTINUE
 361  FORMAT (' **WARNING:** 1+XA*PATH(PA(I),0) IS NEGATIVE,I= ',I3,/ &
       20X,'PATH0(I)=',F16.6,' XA(I)=',F16.6)
      RETURN
      END SUBROUTINE COEINT
!-----------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!-----------------------------------------------------------------------
      SUBROUTINE CO2INS(T22,T23,T66,IQ,L,LP1,iflag)
!     *********************************************************
!       SAVE DATA ON PERMANENT DATA SET DENOTED BY CO222 ******
!          ..... K.CAMPANA   MARCH 1988,OCTOBER 1988...
!          ..... K.CAMPANA   DECEMBER 1988-CLEANED UP FOR LAUNCHER
!          ..... K.CAMPANA   NOVEMBER 1989-ALTERED FOR NEW RADIATION
!     *********************************************************
      INTEGER :: IQ,L,LP1,IFLAG
      REAL,DIMENSION(LP1,LP1,3) :: T22,T23
      REAL,DIMENSION(LP1,LP1,6) :: T66
      REAL,DIMENSION(LP1,LP1) :: DCDT8,DCDT10,CO2PO, &
       CO2800,CO2PO1,CO2801,CO2PO2, &
       CO2802,D2CT8,D2CT10
      REAL,DIMENSION(LP1) :: N
      integer :: i,j
      real :: c1,c2x
!CC   ITIN=22
!CC   ITIN1=23
!O222  LATEST CODE HAD  IQ=1
!CC      IQ=4
1011  FORMAT (4F20.14)
!CC      READ (ITIN,1011) ((CO2PO(I,J),I=1,LP1),J=1,LP1)
!CC      READ (ITIN1,1011) ((CO2800(I,J),I=1,LP1),J=1,LP1)
!CC      READ (ITIN,1011) ((CO2PO1(I,J),I=1,LP1),J=1,LP1)
!CC      READ (ITIN1,1011) ((CO2801(I,J),I=1,LP1),J=1,LP1)
!CC      READ (ITIN,1011) ((CO2PO2(I,J),I=1,LP1),J=1,LP1)
!CC      READ (ITIN1,1011) ((CO2802(I,J),I=1,LP1),J=1,LP1)
      DO 300 J=1,LP1
        DO 300 I=1,LP1
          CO2PO(I,J) = T22(I,J,1)
!NOV89
          IF (IQ.EQ.5) GO TO 300
!NOV89
          CO2PO1(I,J) = T22(I,J,2)
          CO2PO2(I,J) = T22(I,J,3)
  300 CONTINUE
      DO 301 J=1,LP1
        DO 301 I=1,LP1
          CO2800(I,J) = T23(I,J,1)
!NOV89
          IF (IQ.EQ.5) GO TO 301
!NOV89
          CO2801(I,J) = T23(I,J,2)
          CO2802(I,J) = T23(I,J,3)
  301 CONTINUE
!***THE FOLLOWING CODE IS REWRITTEN SO THAT THE RADIATIVE BANDS
!   ARE:
!        IQ=1    560-800     (CONSOL.=490-850)
!        IQ=2    560-670     (CONSOL.=490-670)
!        IQ=3    670-800     (CONSOL.=670-850)
!        IQ=4    560-760 (ORIGINAL CODE)   (CONSOL.=490-850)
!NOV89
!        IQ=5   2270-2380    (CONSOL.=2270-2380)
!NOV89
!  THE FOLLOWING LOOP OBTAINS TRANSMISSION FUNCTIONS FOR BANDS
!  USED IN RADIATIVE MODEL CALCULATIONS,WITH THE EQUIVALENT
!  WIDTHS KEPT FROM THE ORIGINAL CONSOLIDATED CO2 TF S.
!NOV89
!      NOTE: ALTHOUGH THE BAND TRANSMISSION FUNCTIONS ARE
!  COMPUTED FOR ALL RADIATIVE BANDS, AS OF 9/28/88, THEY
!  ARE WRITTEN OUT IN FULL ONLY FOR THE FULL 15 UM BAND CASES
!  (IQ=1,4).  IN OTHER CASES, THE TRANSMISSIVITIES (1,K) ARE
!  WRITTEN OUT, AS THESE ARE THE ONLY ONES NEEDED FOR CTS
!  CALCULATIONS.  ALSO, FOR THE 4.3 UM BAND (IQ=5) THE TEMP.
!  DERIVATIVE TERMS ARE NOT WRITTEN OUT, AS THEY ARE UNUSED.
!NOV89
      IF (IQ.EQ.1) THEN
         C1=1.5
         C2x=0.5
      ENDIF
      IF (IQ.EQ.2) THEN
        C1=18./11.
        C2x=7./11.
      ENDIF
      IF (IQ.EQ.3) THEN
        C1=18./13.
        C2x=5./13.
      ENDIF
      IF (IQ.EQ.4) THEN
        C1=1.8
        C2x=0.8
      ENDIF
!NOV89
      IF (IQ.EQ.5) THEN
        C1=1.0
        C2x=0.0
      ENDIF
!NOV89
      DO 1021 I=1,LP1
      DO 1021 J=1,LP1
      CO2PO(J,I)=C1*CO2PO(J,I)-C2x
      CO2800(J,I)=C1*CO2800(J,I)-C2x
!NOV89
      IF (IQ.EQ.5) GO TO 1021
!NOV89
      CO2PO1(J,I)=C1*CO2PO1(J,I)-C2x
      CO2801(J,I)=C1*CO2801(J,I)-C2x
      CO2PO2(J,I)=C1*CO2PO2(J,I)-C2x
      CO2802(J,I)=C1*CO2802(J,I)-C2x
1021  CONTINUE
!NOV89
      IF (IQ.GE.1.AND.IQ.LE.4) THEN
!NOV89
      DO 1 J=1,LP1
      DO 1 I=1,LP1
      DCDT8(I,J)=.02*(CO2801(I,J)-CO2802(I,J))*100.
      DCDT10(I,J)=.02*(CO2PO1(I,J)-CO2PO2(I,J))*100.
      D2CT8(I,J)=.0016*(CO2801(I,J)+CO2802(I,J)-2.*CO2800(I,J))*1000.
      D2CT10(I,J)=.0016*(CO2PO1(I,J)+CO2PO2(I,J)-2.*CO2PO(I,J))*1000.
1     CONTINUE
!NOV89
      ENDIF
!NOV89
!O222 *********************************************************
!CC       REWIND 66
!        SAVE CDT51,CO251,C2D51,CDT58,CO258,C2D58..ON TEMPO FILE
!CC       WRITE (66) DCDT10
!CC       WRITE (66) CO2PO
!CC       WRITE (66) D2CT10
!CC       WRITE (66) DCDT8
!CC       WRITE (66) CO2800
!CC       WRITE (66) D2CT8
!CC       REWIND 66
!NOV89
      IF (IQ.EQ.1.OR.IQ.EQ.4) THEN
!NOV89
      DO 400 J=1,LP1
       DO 400 I=1,LP1
        T66(I,J,1) = DCDT10(I,J)
        T66(I,J,2) = CO2PO(I,J)
        T66(I,J,3) = D2CT10(I,J)
        T66(I,J,4) = DCDT8(I,J)
        T66(I,J,5) = CO2800(I,J)
        T66(I,J,6) = D2CT8(I,J)
  400 CONTINUE
!NOV89
      ELSE
      DO 409 I=1,LP1
        T66(I,1,2) = CO2PO(1,I)
        T66(I,1,5) = CO2800(1,I)
        IF (IQ.EQ.5) GO TO 409
        T66(I,1,1) = DCDT10(1,I)
        T66(I,1,3) = D2CT10(1,I)
        T66(I,1,4) = DCDT8(1,I)
        T66(I,1,6) = D2CT8(1,I)
  409 CONTINUE
      ENDIF
!NOV89
!O222 *********************************************************
      RETURN
      END SUBROUTINE CO2INS
!-----------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!-----------------------------------------------------------------------
      SUBROUTINE CO2INT(ITAPE,T15A,T15B,T22,RATIO,IR,NMETHD,NLEVLS,NLP1,NLP2)
!NOV89
!     *********************************************************
!       CHANGES TO DATA READ  AND FORMAT SEE CO222     ***
!          ..... K.CAMPANA   MARCH 1988,OCTOBER 1988
!       CHANGES TO PASS ITAPE,AND IF IR=4,READ 1 CO2 REC..KAC NOV89
!     *********************************************************
!       CO2INT INTERPOLATES CARBON DIOXIDE TRANSMISSION FUNCTIONS
!  FROM THE 109 LEVEL GRID,FOR WHICH THE TRANSMISSION FUNCTIONS
!  HAVE BEEN PRE-CALCULATED, TO THE GRID STRUCTURE SPECIFIED BY THE
!  USER.
!
!        METHOD:
!
!      CO2INT IS EMPLOYABLE FOR TWO PURPOSES: 1) TO OBTAIN TRANSMIS-
!  SIVITIES BETWEEN ANY 2 OF AN ARRAY OF USER-DEFINED PRESSURES; AND
!  2) TO OBTAIN LAYER-MEAN TRANSMISSIVITIES BETWEEN ANY 2 OF AN ARRAY
!  OF USER-DEFINED PRESSURE LAYERS.TO CLARIFY THESE TWO PURPOSES,SEE
!  THE DIAGRAM AND DISCUSSION BELOW.
!      CO2INT MAY BE USED TO EXECUTE ONLY ONE PURPOSE AT ONE TIME.
!
!     LET P BE AN ARRAY OF USER-DEFINED PRESSURES
!     AND PD BE USER-DEFINED PRESSURE LAYERS.
!
!       - - - - - - - - -   PD(I-1) ---
!                                     ^
!       -----------------   P(I)      ^  PRESSURE LAYER I  (PLM(I))
!                                     ^
!       - - - - - - - - -   PD(I)  ---
!                                     ^
!       -----------------   P(I+1)    ^  PRESSURE LAYER I+1 (PLM(I+1))
!                                     ^
!       - - - - - - - - -   PD(I+1)---
!            ...                          (THE NOTATION USED IS
!            ...                          CONSISTENT WITH THE CODE)
!            ...
!      - - - - - - - - -    PD(J-1)
!
!      -----------------    P(J)
!
!      - - - - - - - - -    PD(J)
!
!      PURPOSE 1:   THE TRANSMISSIVITY BETWEEN SPECIFIC PRESSURES
!      P(I) AND P(J) ,TAU(P(I),P(J))  IS COMPUTED BY THIS PROGRAM.
!      IN THIS MODE,THERE IS NO REFERENCE TO LAYER PRESSURES PD
!      (PD,PLM ARE NOT INPUTTED).
!
!      PURPOSE 2:   THE LAYER-MEAN TRANSMISSIVITY BETWEEN A LAYER-
!      MEAN PRESSURE PLM(J) AND PRESSURE LAYER I IS GIVEN BY
!         TAULM(PLM(I),PLM(J)). IT IS COMPUTED BY THE INTEGRAL
!
!                           PD(I)
!                           ----
!             1             ^
!        -------------  *   ^   TAU ( P',PLM(J) )  DP'
!        PD(I)-PD(I-1)      ^
!                        ----
!                        PD(I-1)
!
!           THE LAYER-MEAN PRESSURE PLM(I) IS SPECIFIED BY THE USER.
!        FOR MANY PURPOSES,PLM WILL BE CHOSEN TO BE THE AVERAGE
!        PRESSURE IN THE LAYER-IE,PLM(I)=0.5*(PD(I-1)+PD(I)).
!           FOR LAYER-MEAN TRANSMISSIVITIES,THE USER THUS INPUTS
!        A PRESSURE ARRAY (PD) DEFINING THE PRESSURE LAYERS AND AN
!        ARRAY (PLM) DEFINING THE LAYER-MEAN PRESSURES.THE CALCULATION
!        DOES NOT DEPEND ON THE P ARRAY USED FOR PURPOSE 1 (P IS NOT
!        INPUTTED).
!
!            THE FOLLOWING PARAGRAPHS DEPICT THE UTILIZATION OF THIS
!       CODE WHEN USED TO COMPUTE TRANSMISSIVITIES BETWEEN SPECIFIC
!       PRESSURES. LATER PARAGRAPHS DESCRIBE ADDITIONAL FEATURES NEEDED
!       FOR LAYER-MEAN TRANSMISSIVITIES.
!
!          FOR A GIVEN CO2 MIXING RATIO AND STANDARD TEMPERATURE
!      PROFILE,A TABLE OF TRANSMISSION FUNCTIONS FOR A FIXED GRID
!     OF ATMOSPHERIC PRESSURES HAS BEEN PRE-CALCULATED.
!      THE STANDARD TEMPERATURE PROFILE IS COMPUTED FROM THE US
!     STANDARD ATMOSPHERE (1977) TABLE.ADDITIONALLY, THE
!     SAME TRANSMISSION FUNCTIONS HAVE BEEN PRE-CALCULATED FOR A
!     TEMPERATURE PROFILE INCREASED AND DECREASED (AT ALL LEVELS)
!     BY 25 DEGREES.
!         THIS PROGRAM READS IN THE PRESPECIFIED TRANSMISSION FUNCTIONS
!     AND A USER-SUPPLIED PRESSURE GRID (P(I)) AND CALCULATES TRANS-
!     MISSION FUNCTIONS ,TAU(P(I),P(J)), FOR ALL P(I) S AND P(J) S.
!     A LOGARITHMIC INTERPOLATION SCHEME IS USED.
!         THIS METHOD IS REPEATED FOR THE THREE TEMPERATURE PROFILES
!     GIVEN ABOVE .THEREFORE OUTPUTS FROM THE PROGRAM ARE THREE TABLES
!     OF TRANSMISSION FUNCTIONS FOR THE USER-SUPPLIED PRESSURE GRID.
!     THE EXISTENCE OF THE THREE TABLES PERMITS SUBSEQUENT INTERPO-
!     LATION TO A USER-SUPPLIED TEMPERATURE PROFILE USING THE METHOD
!     DESCRIBED IN THE REFERENCE.SEE LIMITATIONS SECTION IF THE
!     USER DESIRES TO OBTAIN ONLY 1 TABLE OF TRANSMISSIVITIES.
!
!     MODIFICATIONS FOR LAYER-MEAN TRANSMISSIVITIES:
!          THE PRESSURES INPUTTED ARE THE LAYER-MEAN PRESSURES,PD,
!     AND THE LAYER-MEAN PRESSURES ,PLM. A SERIES OF TRANSMISSIVITIES
!     (TAU(P'',PLM(J)) ARE COMPUTED AND THE INTEGRAL GIVEN IN THE
!     DISCUSSION OF PURPOSE 2 IS COMPUTED.FOR PLM(I) NOT EQUAL TO
!     PLM(J) SIMPSON S RULE IS USED WITH 5 POINTS. IF PLM(I)=PLM(J)
!     (THE -NEARBY LAYER- CASE) A 49-POINT QUADRATURE IS USED FOR
!     GREATER ACCURACY.THE OUTPUT IS IN TAULM(PLM(I),PLM(J)).
!        NOTE:
!     TAULM IS NOT A SYMMETRICAL MATRIX. FOR THE ARRAY ELEMENT
!     TAULM(PLM(I),PLM(J)),THE INNER(FIRST,MOST RAPIDLY VARYING)
!     DIMENSION IS THE VARYING LAYER-MEAN PRESSURE,PLM(I);THE OUTER
!     (SECOND) DIMENSION IS THE FIXED LAYER-MEAN PRESSURE PLM(J).
!     THUS THE ELEMENT TAULM(2,3) IS THE TRANSMISSION FUNCTION BETWEEN
!     THE FIXED PRESSURE PLM(3)  AND THE PRESSURE LAYER HAVING AN AVERAG
!     PRESSURE OF PLM(2).
!         ALSO NOTE THAT NO QUADRATURE IS PERFORMED OVER THE LAYER
!     BETWEEN THE SMALLEST NONZERO PRESSURE AND ZERO PRESSURE;
!     TAULM IS TAULM(0,PLM(J)) IN THIS CASE,AND TAULM(0,0)=1.
!
!
!             REFERENCE:
!         S.B.FELS AND M.D.SCHWARZKOPF,-AN EFFICIENT ACCURATE
!     ALGORITHM FOR CALCULATING CO2 15 UM BAND COOLING RATES-,JOURNAL
!     OF GEOPHYSICAL RESEARCH,VOL.86,NO. C2, PP.1205-1232,1981.
!        MODIFICATIONS TO THE ALGORITHM HAVE BEEN MADE BY THE AUTHORS;
!     CONTACT S.B.F.OR M.D.S. FOR FURTHER DETAILS.A NOTE TO J.G.R.
!     IS PLANNED TO DOCUMENT THESE CHANGES.
!
!            AUTHOR:    M.DANIEL SCHWARZKOPF
!
!            DATE:      14 JULY 1983
!
!            ADDRESS:
!
!                      G.F.D.L.
!                      P.O.BOX 308
!                      PRINCETON,N.J.08540
!                      U.S.A.
!            TELEPHONE:  (609) 452-6521
!
!            INFORMATION ON TAPE: THIS SOURCE IS THE FIRST FILE
!        ON THIS TAPE.THE SIX FILES THAT FOLLOW ARE CO2 TRANS-
!        MISSIVITIES FOR THE 500-850 CM-1 INTERVAL FOR CO2
!        CONCENTRATIONS OF 330 PPMV (1X) ,660 PPMV (2X), AND
!        1320 PPMV (4X). THE FILES ARE ARRANGED AS FOLLOWS:
!          FILE 2   1X,CONSOLIDATED USING B(250) WEIGHTING FCTN.
!          FILE 3   1X,CONSOLIDATED WITH NO WEIGHTING FCTN.
!          FILE 4   2X,CONSOLIDATED USING B(250) WEIGHTING FCTN.
!          FILE 5   2X,CONSOLIDATED WITH NO WEIGHTING FCTN.
!          FILE 6   4X,CONSOLIDATED USING B(250) WEIGHTING FCTN.
!          FILE 7   4X,CONSOLIDATED WITH NO WEIGHTING FCTN.
!            FILES 2,4,6 ARE RECOMMENDED FOR USE IN OBTAINING
!        TRANSMISSION FUNCTIONS FOR USE IN HEATING RATE
!        COMPUTATIONS;THEY CORRESPOND TO THE TRANSMISSIVITIES
!        DISCUSSED IN THE 1980 PAPER.FILES 3,5,7 ARE PROVIDED
!        TO FACILITATE COMPARISON WITH OBSERVATION AND WITH OTHER
!        CALCULATIONS.
!
!            PROGRAM LANGUAGE: FORTRAN 1977,INCLUDING PARAMETER
!        AND PROGRAM STATEMENTS.THE PROGRAM IS WRITTEN ON A
!        CYBER 170-730.SEE THE SECTION ON LIMITATIONS FOR
!        ADAPTATIONS TO OTHER MACHINES.
!
!          INPUT UNITS,FORMATS AND FORMAT STATEMENT NOS:
!
!   UNIT NO    VARIABLES       FORMAT      STATEMENT NO.    TYPE
!      5        P (PURPOSE 1)  (5E16.9)        201         CARDS
!      5        PD (PURPOSE 2) (5E16.9)        201         CARDS
!      5        PLM(PURPOSE 2) (5E16.9)        201         CARDS
!      5        NMETHD         (I3)            202         CARDS
!      20       TRANSA         (4F20.14)       102          TAPE
!NOV89
!      ITAPE    TRANSA         (4F20.14)       102          TAPE
!NOV89
!
!         OUTPUT UNITS,FORMATS AND FORMAT STATEMENT NOS:
!
!   UNIT NO    VARIABLES       FORMAT     STATEMENT NO.
!      6         TRNFCT        (1X,8F15.8)     301         PRINT
!      22        TRNFCT        (4F20.14)       102          TAPE
!
!            PARAMETER INPUTS:
!     A) NLEVLS    : NLEVLS IS AN (INTEGER) PARAMETER DENOTING
!        THE NUMBER OF NONZERO PRESSURE LEVELS FOR PURPOSE 1
!        OR THE NUMBER OF NONZERO LAYER PRESSURES NEEDED TO
!        SPECIFY THE PRESSURE LAYERS(PURPOSE 2) IN THE OUTPUT
!        GRID. FOR EXAMPLE,IN PURPOSE 1,IF P=0,100,1000,NLEVLS=2.
!        IF,IN PURPOSE 2,PD=0,100,500,1000,THE NUMBER OF NONZERO
!        PRESSURE LAYERS=2,SO NLEVLS=2
!           IN THE CODE AS WRITTEN,NLEVLS=40; THE USER SHOULD
!        CHANGE THIS VALUE TO A USER-SPECIFIED VALUE.
!     B) NLP1,NLP2 : INTEGER PARAMETERS DEFINED AS: NLP1=NLEVLS+1;
!        NLP2=NLEVLS+2.
!           SEE LIMITATIONS FOR CODE MODIFICATIONS IF PARAMETER
!        STATEMENTS ARE NOT ALLOWED ON YOUR MACHINE.
!
!            INPUTS:
!
!     A) TRANSA    : THE 109X109 GRID OF TRANSMISSION FUNCTIONS
!            TRANSA IS A  DOUBLE PRECISION REAL ARRAY.
!
!           TRANSA  IS READ FROM FILE 20. THIS FILE CONTAINS 3
!     RECORDS,AS FOLLOWS:
!        1)   TRANSA, STANDARD TEMPERATURE PROFILE
!        3)   TRANSA, STANDARD TEMPERATURES + 25 DEG
!        5)   TRANSA, STANDARD TEMPERATURES - 25 DEG
!
!     B)   NMETHD: AN INTEGER WHOSE VALUE IS EITHER 1 (IF CO2INT IS
!       TO BE USED FOR PURPOSE 1) OR 2 (IF CO2INT IS TO BE USED FOR
!       PURPOSE 2).
!
!     C)     P,PD,PLM :
!          P IS A REAL ARRAY (LENGTH NLP1) SPECIFYING THE PRESSURE
!       GRID AT WHICH TRANSMISSION FUNCTIONS ARE TO BE COMPUTED FOR
!       PURPOSE 1.THE DIMENSION  OF P IS  IN MILLIBARS.THE
!       FOLLOWING LIMITATIONS WILL BE EXPLAINED MORE
!       IN THE SECTION ON LIMITATIONS: P(1) MUST BE ZERO; P(NLP1),THE
!       LARGEST PRESSURE, MUST NOT EXCEED 1165 MILLIBARS.
!         PD IS A REAL ARRAY (LENGTH NLP2) SPECIFYING THE PRESSURE
!       LAYERS FOR WHICH LAYER-AVERAGED TRANSMISSION FUNCTIONS ARE
!       TO BE COMPUTED.THE DIMENSION OF PD IS MILLIBARS.THE LIMITATIONS
!       FOR PD ARE THE SAME AS FOR P,AND ARE GIVEN IN THE SECTION ON
!       LIMITATIONS.
!         PLM IS A REAL ARRAY (LENGTH NLP2) SPECIFYING THE LAYER-MEAN
!       PRESSURES. THE DIMENSION OF PLM IS MILLIBARS. THE LIMITATIONS
!       FOR PLM ARE THE SAME AS FOR P,AND ARE GIVEN IN THE SECTION ON
!       LIMITATIONS.PD IS READ IN BEFORE PLM.
!
!          NOTE: AGAIN,WE NOTE THAT THE USER WILL INPUT EITHER P (FOR
!       PURPOSE 1) OR PD AND PLM(FOR PURPOSE 2) BUT NOT BOTH.
!
!
!
!
!           LIMITATIONS:
!     1)       P(1)=0.,PD(1)=0.,PLM(1)=0. THE TOP PRESSURE LEVEL
!       MUST BE ZERO,OR THE TOP PRESSURE LAYER MUST BE BOUNDED BY ZERO.
!       THE TOP LAYER-MEAN PRESSURE (PLM(1)) MUST BE ZERO; NO
!       QUADRATURE IS DONE ON THE TOP PRESSURE LAYER.EVEN IF ONE IS
!       NOT INTERESTED IN THE TRANSMISSION FUNCTION BETWEEN 0 AND P(J),
!       ONE MUST INCLUDE SUCH A LEVEL.
!     2)      PD(NLP2)=P(NLP1) IS LESS THAN OR EQUAL TO 1165 MB.
!       EXTRAPOLATION TO HIGHER PRESSURES IS NOT POSSIBLE.
!     3)      IF PROGRAM IS NOT PERMITTED ON YOUR COMPILER,
!       SIMPLY DELETE THE LINE.
!     4)      IF PARAMETER IS NOT PERMITTED,DO THE FOLLOWING:
!            1) DELETE ALL PARAMETER STATEMENTS IN CO2INT
!            2) AT THE POINT WHERE NMETHOD IS READ IN,ADD:
!                READ (5,202) NLEVLS
!                NLP1=NLEVLS+1
!                NLP2=NLEVLS+2
!            3) CHANGE DIMENSION AND/OR COMMON STATEMENTS DEFINING
!              ARRAYS TRNS,DELTA,P,PD,TRNFCT,PS,PDS,PLM IN CO2INT.
!              THE NUMERICAL VALUE OF (NLEVLS+1) SHOULD BE INSERTED
!              IN DIMENSION OR COMMON STATEMENTS FOR TRNS,DELTA,
!              P,TRNFCT,PS,PLM; THE NUMERICAL VALUE OF (NLEVLS+2)
!              IN DIMENSION OR COMMON STATEMENTS FOR PD,PDS.
!      5)    PARAMETER (NLEVLS=40) AND THE OTHER PARAMETER
!       STATEMENTS ARE WRITTEN IN CDC FORTRAN; ON OTHER MACHINES THE
!       SAME STATEMENT MAY BE WRITTEN DIFFERENTLY,FOR EXAMPLE AS
!       PARAMETER   NLEVLS=40
!      6) -DOUBLE PRECISION- IS USED INSTEAD OF -REAL*8- ,DUE TO
!       REQUIREMENTS OF CDC FORTAN.
!      7) THE STATEMENT -DO 400 KKK=1,3- CONTROLS THE NUMBER OF
!       TRANSMISSIVITY OUTPUT MATRICES PORDUCED BY THE PROGRAM.TO
!       PRODUCE 1 OUTPUT MATRIX,DELETE THIS STATEMENT.
!
!     OUTPUT:
!         A) TRNFCT IS AN (NLP1,NLP1) REAL ARRAY OF THE TRANSMISSION
!     FUNCTIONS APPROPRIATE TO YOUR ARRAY. IT IS TO BE SAVED ON FILE 22.
!     THE PROCEDURE FOR SAVING MAY BE MODIFIED; AS GIVEN HERE,THE
!     OUTPUT IS IN CARD IMAGE FORM WITH A FORMAT OF (4F20.14).
!
!         B)  PRINTED  OUTPUT IS A LISTING OF TRNFCT ON UNIT 6, IN
!     THE FORMAT (1X,8F15.8) (FORMAT STATEMENT 301). THE USER MAY
!     MODIFY OR ELIMINATE THIS AT WILL.
!
!      ************   FUNCTION INTERPOLATER ROUTINE  *****************
!
!
!     ******   THE FOLLOWING PARAMETER GIVES THE NUMBER OF     *******
!     ******           DATA LEVELS IN THE MODEL                *******
!     ****************************************************************
!     ****************************************************************
      COMMON/INPUT/P1,P2,TRNSLO,IA,JA,N
!     COMMON/PRESS/PA(109)
!     COMMON/TRAN/ TRANSA(109,109)
!     COMMON / OUTPUT / TRNS(NLP1,NLP1)
!     COMMON/INPUTP/P(NLP1),PD(NLP2)
      INTEGER :: IR,ITAPE,NLEVLS,NLP1,NLP2,NMETHD
      REAL :: RATIO
      REAL,DIMENSION(NLP1,NLP1) :: TRNS
      REAL,DIMENSION(NLP1) :: P,PS,PLM,T15B
      REAL,DIMENSION(NLP2) :: PD,PDS
      INTEGER,DIMENSION(3),SAVE :: NRTAB=(/1,2,4/)
      REAL,DIMENSION(NLP2,2) :: T15A
      REAL,DIMENSION(NLP1,NLP1,3) :: T22
      integer :: i,ia,iap,icloop,irtn,itap1,j,ja,kkk,n,nlv,nlp1v,nlp2v &
                ,ntap
      real :: fact15,fact30,p1,p2,trnslo
!***********************************
!   THE FOLLOWING ARE THE INPUT FORMATS
100   FORMAT (4F20.14)
743   FORMAT (F20.14)
201   FORMAT (5E16.9)
202   FORMAT (I3)
!O222   203   FORMAT (F12.6,I2)
203   FORMAT (F12.6)
!    THE FOLLOWING ARE THE OUTPUT FORMATS
102   FORMAT (4F20.14)
301   FORMAT (1X,8F15.8)
!
!CC   REWIND 15
!CC   REWIND 20
!NOV89
      REWIND ITAPE
!NOV89
!CC   REWIND 22
!
!     CALCULATION OF PA -THE -TABLE- OF 109 GRID PRESSURES
!     NOTE-THIS CODE MUST NOT BE CHANGED BY THE USER^^^^^^^^^
      PA(1)=0.
      FACT15=10.**(1./15.)
      FACT30=10.**(1./30.)
      PA(2)=1.0E-3
      DO 231 I=2,76
      PA(I+1)=PA(I)*FACT15
231   CONTINUE
      DO 232 I=77,108
      PA(I+1)=PA(I)*FACT30
232   CONTINUE
!
      N=25
      NLV=NLEVLS
      NLP1V=NLP1
      NLP2V=NLP2
!     READ IN THE CO2 MIXING RATIO(IN UNITS OF 330 PPMV),AND AN INDEX
!     GIVING THE FREQUENCY RANGE OF THE LBL DATA
!O222    READ (5,203) RATIO,IR
!CC         IR = 1
!CC         READ (5,203) RATIO
!O222   ***********************************
!***VALUES FOR IR*****
!          IR=1     CONSOL. LBL TRANS. =490-850
!          IR=2     CONSOL. LBL TRANS. =490-670
!          IR=3     CONSOL. LBL TRANS. =670-850
!          IR=4     CONSOL. LBL TRANS. =2270-2380
!*** IR MUST BE 1,2,3 OR 4 FOR THE PGM. TO WORK
!     ALSO READ IN THE METHOD NO.(1 OR 2)
!CC         READ (5,202) NMETHD
      IF (RATIO.EQ.1.0) GO TO 621
      WRITE(0,*)'SUBROUTINE CO2INT: 8746'
!!!   CALL ESMF_Finalize(terminationflag=ESMF_ABORT)
      CALL NMMB_FINALIZE
!NOV89  621   ITAP1=20
621   ITAP1=ITAPE
!NOV89
      NTAP=1
      IF (NMETHD.EQ.2) GO TO 502
!   *****CARDS FOR PURPOSE 1(NMETHD=1)
!CC         READ (15,201) (P(I),I=1,NLP1)
      DO 300 I=1,NLP1
        P(I)=T15B(I)
  300 CONTINUE
      DO 801 I=1,NLP1
      PS(I)=P(I)
801   CONTINUE
      GO TO 503
502   CONTINUE
!  *****CARDS FOR PURPOSE 2(NMETHD=2)
!CC         READ (15,201) (PD(I),I=1,NLP2)
!CC         READ (15,201) (PLM(I),I=1,NLP1)
      DO 303 I=1,NLP2
        PD(I)=T15A(I,1)
  303 CONTINUE
      DO 302 I=1,NLP1
        PLM(I)=T15A(I,2)
  302 CONTINUE
      DO 802 I=1,NLP1
      PDS(I)=PD(I+1)
      PS(I)=PLM(I)
802   CONTINUE
!
503   CONTINUE
!  *****DO LOOP CONTROLLING NUMBER OF OUTPUT MATRICES
!NOV89
!NOV89    DO 400 KKK=1,3
      ICLOOP = 3
      IF (IR.EQ.4) ICLOOP = 1
      DO 400 KKK=1,ICLOOP
!NOV89
!  **********************
      IF (NMETHD.EQ.2) GO TO 505
!   *****CARDS FOR PURPOSE 1(NMETHD=1)
      DO 803 I=1,NLP1
      P(I)=PS(I)
803   CONTINUE
      GO TO 506
505   CONTINUE
!  *****CARDS FOR PURPOSE 2(NMETHD=2)
      DO 804 I=1,NLP1
      PD(I)=PDS(I)
      P(I)=PS(I)
804   CONTINUE
!
506   CONTINUE
      IA=108
      IAP=IA+1
!NOV89   IF (NTAP.EQ.1) READ (20,100) ((TRANSA(I,J),I=1,109),J=1,109)
!mp       IF (NTAP.EQ.1) READ (ITAPE,100) ((TRANSA(I,J),I=1,109),J=1,109)
        IF (NTAP.EQ.1) THEN
           IF (MYPE==0) READ (ITAPE,743) ((TRANSA(I,J),I=1,109),J=1,109)
           if(mype==0)write(0,*)' CO2INT Successfully read CO2 data'
           CALL MPI_BCAST(TRANSA,SIZE(TRANSA),MPI_REAL,0   &
                         ,MPI_COMM_COMP,IRTN)
        ENDIF
!mp	IF (NTAP.EQ.1) READ (ITAPE,100) (tmp(I),I=1,11881
!mp
!zj	do J=109,1,-6
!mp	write(6,697)(TRANSA(I,J),I=5,105,10)
!zj   	write(0,697)(TRANSA(I,J),I=5,105,10)
!zj	enddo
 697	format(11(f5.3,1x))
!mp
!NOV89
      DO 4 I=1,IAP
      TRANSA(I,I)=1.0
    4 CONTINUE
      CALL COEINT(RATIO,IR)
      DO 805 I=1,NLP1
      DO 805 J=1,NLP1
      TRNS(J,I)=1.00
805   CONTINUE
      DO 10 I=1,NLP1
      DO 20 J=1,I
      P1=P(J)
      P2=P(I)
      CALL SINTR2
      TRNS(J,I)=TRNSLO
20    CONTINUE
10    CONTINUE
      DO 47 I=1,NLP1
      DO 47 J=I,NLP1
      TRNS(J,I)=TRNS(I,J)
47    CONTINUE
!  *****THIS IS THE END OF PURPOSE 1 CALCULATIONS
      IF (NMETHD.EQ.1) GO TO 2872
!
      DO 51 J=1,NLP1
      DO 52 I=2,NLP1
      IA=I
      JA=J
      N=25
      IF (I.NE.J) N=3
      CALL QUADSR(NLV,NLP1V,NLP2V,P,PD,TRNS)
52    CONTINUE
51    CONTINUE
!  *****THIS IS THE END OF PURPOSE 2 CALCULATIONS
2872  CONTINUE
!
!+++  WRITE (6,301) ((TRNS(I,J),I=1,NLP1),J=1,NLP1)
!CC         WRITE (22,102) ((TRNS(I,J),I=1,NLP1),J=1,NLP1)
      DO 304 J=1,NLP1
       DO 304 I=1,NLP1
        T22(I,J,KKK) = TRNS(I,J)
  304 CONTINUE
400   CONTINUE
      RETURN
      END SUBROUTINE CO2INT
!-----------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!-----------------------------------------------------------------------
      SUBROUTINE CO2IN1(T20,T21,T66,IQ,L,LP1)
!    CO2IN1=CO2INS FOR METHOD 1
!     *********************************************************
!       SAVE DATA ON PERMANENT DATA SET DENOTED BY CO222 ***
!          ..... K.CAMPANA   MARCH 1988,OCTOBER 1988
!          ..... K.CAMPANA   DECEMBER 88 CLEANED UP FOR LAUNCHER
!     *********************************************************
      INTEGER :: IQ,L,LP1
      REAL,DIMENSION(L,6) :: T66
      REAL,DIMENSION(LP1,LP1,3) :: T20,T21
      REAL,DIMENSION(LP1,LP1) :: DCDT8,DCDT10,CO2PO, &
       CO2800,CO2PO1,CO2801,CO2PO2, &
       CO2802,D2CT8,D2CT10
      REAL,DIMENSION(LP1) :: N
      integer :: i,itin,itin1,j
      real :: c1,c2x
      ITIN=20
      ITIN1=21
!O222 LATEST CODE HAS IQ=1
!CC         IQ=4
1011  FORMAT (4F20.14)
!CC        READ (ITIN,1011) ((CO2PO(I,J),I=1,LP1),J=1,LP1)
!CC        READ (ITIN1,1011) ((CO2800(I,J),I=1,LP1),J=1,LP1)
!CC        READ (ITIN,1011) ((CO2PO1(I,J),I=1,LP1),J=1,LP1)
!CC        READ (ITIN1,1011) ((CO2801(I,J),I=1,LP1),J=1,LP1)
!CC        READ (ITIN,1011) ((CO2PO2(I,J),I=1,LP1),J=1,LP1)
!CC        READ (ITIN1,1011) ((CO2802(I,J),I=1,LP1),J=1,LP1)
      DO 300 J=1,LP1
        DO 300 I=1,LP1
          CO2PO(I,J) = T20(I,J,1)
!NOV89
          IF (IQ.EQ.5) GO TO 300
!NOV89
          CO2PO1(I,J) = T20(I,J,2)
          CO2PO2(I,J) = T20(I,J,3)
  300 CONTINUE
      DO 301 J=1,LP1
        DO 301 I=1,LP1
          CO2800(I,J) = T21(I,J,1)
!NOV89
          IF (IQ.EQ.5) GO TO 301
!NOV89
          CO2801(I,J) = T21(I,J,2)
          CO2802(I,J) = T21(I,J,3)
  301 CONTINUE
!***THE FOLLOWING CODE IS REWRITTEN SO THAT THE RADIATIVE BANDS
!   ARE:
!        IQ=1    560-800     (CONSOL.=490-850)
!        IQ=2    560-670     (CONSOL.=490-670)
!        IQ=3    670-800     (CONSOL.=670-850)
!        IQ=4    560-760 (ORIGINAL CODE)   (CONSOL.=490-850)
!NOV89
!        IQ=5   2270-2380    (CONSOL.=2270-2380)
!NOV89
!  THE FOLLOWING LOOP OBTAINS TRANSMISSION FUNCTIONS FOR BANDS
!  USED IN RADIATIVE MODEL CALCULATIONS,WITH THE EQUIVALENT
!  WIDTHS KEPT FROM THE ORIGINAL CONSOLIDATED CO2 TF S.
      IF (IQ.EQ.1) THEN
         C1=1.5
         C2x=0.5
      ENDIF
      IF (IQ.EQ.2) THEN
        C1=18./11.
        C2x=7./11.
      ENDIF
      IF (IQ.EQ.3) THEN
        C1=18./13.
        C2x=5./13.
      ENDIF
      IF (IQ.EQ.4) THEN
        C1=1.8
        C2x=0.8
      ENDIF
!NOV89
      IF (IQ.EQ.5) THEN
        C1=1.0
        C2x=0.0
      ENDIF
!NOV89
      DO 1021 I=1,LP1
      DO 1021 J=1,LP1
      CO2PO(J,I)=C1*CO2PO(J,I)-C2x
      CO2800(J,I)=C1*CO2800(J,I)-C2x
!NOV89
      IF (IQ.EQ.5) GO TO 1021
!NOV89
      CO2PO1(J,I)=C1*CO2PO1(J,I)-C2x
      CO2801(J,I)=C1*CO2801(J,I)-C2x
      CO2PO2(J,I)=C1*CO2PO2(J,I)-C2x
      CO2802(J,I)=C1*CO2802(J,I)-C2x
1021  CONTINUE
!NOV89
      IF (IQ.GE.1.AND.IQ.LE.4) THEN
!NOV89
      DO 1 J=1,LP1
      DO 1 I=1,LP1
      DCDT8(I,J)=.02*(CO2801(I,J)-CO2802(I,J))*100.
      DCDT10(I,J)=.02*(CO2PO1(I,J)-CO2PO2(I,J))*100.
      D2CT8(I,J)=.0016*(CO2801(I,J)+CO2802(I,J)-2.*CO2800(I,J))*1000.
      D2CT10(I,J)=.0016*(CO2PO1(I,J)+CO2PO2(I,J)-2.*CO2PO(I,J))*1000.
1     CONTINUE
!NOV89
      ENDIF
!NOV89
!O222 *********************************************************
!CC          REWIND 66
!        SAVE CDTM51,CO2M51,C2DM51,CDTM58,CO2M58,C2DM58..ON TEMPO FILE
!CC          WRITE (66) (DCDT10(I,I+1),I=1,L)
!CC          WRITE (66) (CO2PO(I,I+1),I=1,L)
!CC          WRITE (66) (D2CT10(I,I+1),I=1,L)
!CC          WRITE (66) (DCDT8(I,I+1),I=1,L)
!CC          WRITE (66) (CO2800(I,I+1),I=1,L)
!CC          WRITE (66) (D2CT8(I,I+1),I=1,L)
!CC          REWIND 66
!O222 *********************************************************
      DO 400 I=1,L
        T66(I,2) = CO2PO(I,I+1)
        T66(I,5) = CO2800(I,I+1)
!NOV89
        IF (IQ.EQ.5) GO TO 400
!NOV89
        T66(I,1) = DCDT10(I,I+1)
        T66(I,3) = D2CT10(I,I+1)
        T66(I,4) = DCDT8(I,I+1)
        T66(I,6) = D2CT8(I,I+1)
  400 CONTINUE
      RETURN
      END SUBROUTINE CO2IN1
!CCC  PROGRAM PTZ - COURTESY OF DAN SCHWARZKOPF,GFDL DEC 1987....
      SUBROUTINE CO2PTZ(SGTEMP,T41,T42,T43,T44,SGLVNU,SIGLNU, &
                        SFULL,SHALF,PPTOP,LREAD,NL,NLP,NLP2)
!
! **         THIS PROGRAM CALCULATES TEMPERATURES ,H2O MIXING RATIOS
! **         AND O3 MIXING RATIOS BY USING AN ANALYTICAL
! **         FUNCTION WHICH APPROXIMATES
! **         THE US STANDARD (1976).  THIS IS
! **         CALCULATED IN FUNCTION 'ANTEMP', WHICH IS CALLED BY THE
! **         MAIN PROGRAM.  THE FORM OF THE ANALYTICAL FUNCTION WAS
! **         SUGGESTED TO ME IN 1971 BY RICHARD S. LINDZEN.
! ******************************************************************
!         CODE TO SAVE STEMP,GTEMP ON DATA SET,BRACKETED BY CO222  **
!             ....K. CAMPANA MARCH 88,OCTOBER 88
      INTEGER :: LREAD,NL,NLP,NLP2
      REAL,DIMENSION(NLP) :: SFULL,SGLVNU,T42,T44
      REAL,DIMENSION(NLP,2) :: SGTEMP,T41,T43
      REAL,DIMENSION(NL) :: SHALF,SIGLNU
! ******************************************************************
!
!*****THIS VERSION IS ONLY USABLE FOR 1976 US STD ATM AND OBTAINS
!     QUANTITIES FOR CO2 INTERPOLATION AND INSERTION INTO OPERA-
!     TIONAL RADIATION CODES
!
      REAL :: PPTOP
      REAL,SAVE :: PSMAX=1013.25
      CHARACTER(20),SAVE :: PROFIL='US STANDARD 1976'
      REAL,DIMENSION(NLP) :: GTEMP,PRESS,PRS,PRSINT,TEMP,TEMPS,ALT,WMIX,O3MIX
      REAL,DIMENSION(NLP2) :: OMXOUT,PD,PROUT,TMPFLX,TMPMID,TMPOUT,WMXOUT
      REAL,DIMENSION(NLP,4) :: WMXINT,OMXINT
      REAL,DIMENSION(NLP,4) :: TMPINT,A
      integer :: m,n,nint,nlm,nq,ntype,nlev
      real :: aa,delzap,r,g0,zmass,pcld,rk1,rk2,rk3,rk4,pstar &
             ,dlogp,znint,ht,dz
!
! **         NTYPE IS AN INTEGER VARIABLE WHICH HAS THE FOLLOWING
! **        VALUES:    0 =SIGMA LEVELS ARE USED;   1= SKYHI L40 LEVELS
! **        ARE USED;   2 = SKYHI L80 LEVELS ARE USED. DEFAULT: 0
!
      NTYPE=0
!O222 READ (*,*) NTYPE
    5 NLEV=NL
      DELZAP=0.5
      R=8.31432
      G0=9.80665
      ZMASS=28.9644
      AA=6356.766
         ALT(1)=0.0
         TEMP(1)=ANTEMP(6,0.0)
!*******DETERMINE THE PRESSURES (PRESS)
      PSTAR=PSMAX
!
!***  LTOP COMPUTATION MOVED FROM MODEL INITIALIZATION
!
      LTOP(1)=0
      LTOP(2)=0
      LTOP(3)=0
      DO 30 N=1,NL
        PCLD=(PSTAR-PPTOP*10.)*SHALF(N)+PPTOP*10.
        IF(PCLD.GE.642.)LTOP(1)=N
        IF(PCLD.GE.350.)LTOP(2)=N
        IF(PCLD.GE.150.)LTOP(3)=N
!       PRINT *,N,PCLD,SHALF(N),PSTAR,PPTOP
   30 CONTINUE
!
!O222 IF (NTYPE.EQ.1) CALL SKYP(PSTAR,PD,GTEMP)
!O222 IF (NTYPE.EQ.2) CALL SKY80P(PSTAR,PD,GTEMP)
!O222 IF (NTYPE.EQ.0) CALL SIGP(PSTAR,PD,GTEMP)
!CC----      CALL SIGP(PSTAR,PD,GTEMP)
      NLM=NL-1
      CALL SIGP(PSTAR,PD,GTEMP,T41,T42,T43,T44,SGLVNU,SIGLNU, &
                SFULL,SHALF,PPTOP,LREAD,NL,NLP,NLM,NLP2)
      PD(NLP2)=PSTAR
      DO 40 N=1,NLP
      PRSINT(N)=PD(NLP2+1-N)
 40   CONTINUE
!    *** CALCULATE TEMPS FOR SEVERAL PRESSURES TO DO QUADRATURE
      DO 504 NQ=1,4
      DO 505 N=2,NLP
 505  PRESS(N)=PRSINT(N)+0.25*(NQ-1)*(PRSINT(N-1)-PRSINT(N))
      PRESS(1)=PRSINT(1)
!*********************
      DO 100 N=1,NLEV
!
! **         ESTABLISH COMPUTATATIONAL LEVELS BETWEEN USER LEVELS AT
! **         INTERVALS OF APPROXIMATELY 'DELZAP' KM.
!
      DLOGP=7.0*ALOG(PRESS(N)/PRESS(N+1))
      NINT=DLOGP/DELZAP
      NINT=NINT+1
      ZNINT=NINT
!     G=G0
      DZ=R*DLOGP/(7.0*ZMASS*G0*ZNINT)
      HT=ALT(N)
!
! **         CALCULATE HEIGHT AT NEXT USER LEVEL BY MEANS OF
! **                   RUNGE-KUTTA INTEGRATION.
!
      DO 200 M=1,NINT
      RK1=ANTEMP(6,HT)*DZ
      RK2=ANTEMP(6,HT+0.5*RK1)*DZ
      RK3=ANTEMP(6,HT+0.5*RK2)*DZ
      RK4=ANTEMP(6,HT+RK3)*DZ
!mp	write(6,*) 'RK values,DZ ', RK1,RK2,RK3,RK4,DZ
      HT=HT+0.16666667*(RK1+RK2+RK2+RK3+RK3+RK4)
  200 CONTINUE
      ALT(N+1)=HT
      TEMP(N+1)=ANTEMP(6,HT)
  100 CONTINUE
      DO 506 N=1,NLP
      TMPINT(N,NQ)=TEMP(N)
      A(N,NQ)=ALT(N)
506   CONTINUE
504   CONTINUE
!O222   *****************************************************
!***OUTPUT TEMPERATURES
!O222   *****************************************************
      DO 901 N=1,NLP
        SGTEMP(N,1) = TMPINT(NLP2-N,1)
  901 CONTINUE
!O222   *****************************************************
!***OUTPUT GTEMP
!O222   *****************************************************
      DO 902 N=1,NLP
        SGTEMP(N,2) = GTEMP(N)
  902 CONTINUE
!O222   *****************************************************
      RETURN
      END SUBROUTINE CO2PTZ
      REAL FUNCTION PATH(A,B,C,E)
!....
!     DOUBLE PRECISION XA,CA
!     COMMON/COEFS/XA(109),CA(109),ETA(109),SEXPV(109),CORE,UEXP,SEXP
      REAL :: A,B,C,E
      real :: pexp
      PEXP=1./SEXP
      PATH=((A-B)**PEXP*(A+B+C))/(E*(A+B+C)+(A-B)**(PEXP-1.))
      RETURN
      END FUNCTION PATH
!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
      SUBROUTINE QINTRP(XM,X0,XP,FM,F0,FP,X,F)
!....
!     DOUBLE PRECISION FM,F0,FP,F,D1,D2,B,A,DEL
      real :: a,b,d1,d2,del
      REAL :: F,F0,FM,FP,X,X0,XM,XP
      D1=(FP-F0)/(XP-X0)
      D2=(FM-F0)/(XM-X0)
      B=(D1-D2)/(XP-XM)
      A=D1-B*(XP-X0)
      DEL=(X-X0)
      F=F0+DEL*(A+DEL*B)
      RETURN
      END SUBROUTINE QINTRP
      SUBROUTINE QUADSR(NLV,NLP1V,NLP2V,P,PD,TRNS)
      COMMON/INPUT/P1,P2,TRNSLO,IA,JA,N
      INTEGER :: NLV,NLP1V,NLP2V
      REAL,DIMENSION(NLP1V) :: P
      REAL,DIMENSION(NLP2V) :: PD
      REAL,DIMENSION(NLP1V,NLP1V) :: TRNS
      REAL,DIMENSION(101) :: WT
      integer :: i,ia,ja,kk,n,n2,n2p
      real :: dp,trnslo,trnsnb,p1,p2,p3,p4,pfix,pvary
      N2=2*N
      N2P=2*N+1
!  *****WEIGHTS ARE CALCULATED
      WT(1)=1.
      DO 21 I=1,N
      WT(2*I)=4.
      WT(2*I+1)=1.
21    CONTINUE
      IF (N.EQ.1) GO TO 25
      DO 22 I=2,N
      WT(2*I-1)=2.
22    CONTINUE
25    CONTINUE
      TRNSNB=0.
      DP=(PD(IA)-PD(IA-1))/N2
      PFIX=P(JA)
      DO 1 KK=1,N2P
      PVARY=PD(IA-1)+(KK-1)*DP
      IF (PVARY.GE.PFIX) P2=PVARY
      IF (PVARY.GE.PFIX) P1=PFIX
      IF (PVARY.LT.PFIX) P1=PVARY
      IF (PVARY.LT.PFIX) P2=PFIX
      CALL SINTR2
      TRNSNB=TRNSNB+TRNSLO*WT(KK)
1     CONTINUE
      TRNS(IA,JA)=TRNSNB*DP/(3.*(PD(IA)-PD(IA-1)))
      RETURN
      END SUBROUTINE QUADSR
!---------------------------------------------------------------------
      SUBROUTINE SIGP(PSTAR,PD,GTEMP,T41,T42,T43,T44,SGLVNU,SIGLNU, &
                      SIGLV,SIGLY,PPTOP,LREAD,KD,KP,KM,KP2)
      INTEGER :: KD,KM,KP,KP2,LREAD
      REAL :: PPTOP,PSTAR
      REAL,DIMENSION(KD) :: CL,DEL,Q,SIGLNU,SIGLY
      REAL,DIMENSION(KM) :: RPI
      REAL,DIMENSION(KP) :: CI,GTEMP,PLM,QMH,SIGLV,SGLVNU
      REAL,DIMENSION(KP2) :: PD,PDT
      INTEGER,DIMENSION(4) :: IDATE
      REAL,DIMENSION(KP) :: T42,T44
      REAL,DIMENSION(KP2,2) :: T41,T43
      real :: psfc,pss
      integer :: i,k
!     integer :: retval
!     character(50) :: prsmid='prsmid'
!CC   18 LEVEL SIGMAS FOR NMC MRF(NEW) MODEL
!CC   DATA Q/.021,.074,.124,.175,.225,.275,.325,.375,.425,.497, &
!CC          .594,.688,.777,.856,.920,.960,.981,.995/
!     FOR SIGMA MODELS,Q=SIGMA,QMH=0.5(Q(I)+Q(I+1),
!     PD=Q*PSS,PLM=QMH*PSS.PSS=SURFACE PRESSURE(SPEC.)
!
!.....   GET NMC SIGMA STRUCTURE
!CC   IF (LREAD.GT.0) GO TO 914
!---   PPTOP IS MODEL TOP PRESSURE IN CB....
!        SIGMA DATA IS BOTTOM OF ATMOSPHERE TO T.O.A.....
!cccc PPTOP=5.0
!     READ(11,PPTOP,END=12321)
12321 CONTINUE
!     WRITE(6,88221)PPTOP,KD,KP
!88221 FORMAT(' ENTER SIGP PPTOP=',E12.5,' KD=',I2,' KP=',I2)
!     open(unit=23,file='fort.23',form='unformatted' &
!     ,    access='sequential')
!     REWIND 23
!     READ(23)SIGLY
!     DO KKK=1,KD
!      SIGLY(KKK)=1.-(FLOAT(KKK)-0.5)/KD
!     END DO
!     WRITE(6,88222)
!88222 FORMAT(' READ AETA')
!     DO 37821 LLL=1,KD
!     WRITE(6,37820)LLL,SIGLY(LLL)
!37820 FORMAT(' L=',I2,' AETA=',E12.5)
!37821 CONTINUE
!     READ(23)SIGLV
!     DO KKK=1,KP
!      SIGLV(KKK)=1.-(FLOAT(KKK-1))/KD
!     END DO
!     WRITE(6,88223)
!88223 FORMAT(' READ ETA')
!     PRINT 704,(SIGLY(K),K=1,KD)
!     PRINT 704,(SIGLV(K),K=1,KP)
!      DO 37823 LLL=1,KP
!      WRITE(6,37822)LLL,SIGLV(LLL)
!37822 FORMAT(' L=',I2,' ETA=',E12.5)
!37823 CONTINUE
  701 FORMAT(F6.2)
  702 FORMAT(7F10.6)
      IF (PPTOP.LE.0.) GO TO 708
      PSFC=100.
!--- IF PTOP NOT EQUAL TO ZERO ADJUST SIGMA SO AS TO GET PROPER STD ATM
!      VERTICAL LOCATION
      DO 706 K=1,KD
       SIGLY(K) = (SIGLY(K)*(PSFC-PPTOP)+PPTOP)/PSFC
  706 CONTINUE
      DO 707 K=1,KP
       SIGLV(K) = (SIGLV(K)*(PSFC-PPTOP)+PPTOP)/PSFC
  707 CONTINUE
  708 CONTINUE
!     PRINT 703,PPTOP
!     PRINT 704,(SIGLY(K),K=1,KD)
!     PRINT 704,(SIGLV(K),K=1,KP)
  703 FORMAT(1H ,'PTOP =',F6.2)
  704 FORMAT(1H ,7F10.6)
      DO 913 K=1,KP
       SGLVNU(K) = SIGLV(K)
       IF (K.LE.KD) SIGLNU(K) = SIGLY(K)
  913 CONTINUE
      DO 77 K=1,KD
         Q(K) = SIGLNU(KD+1-K)
   77 CONTINUE
      PSS=    1013250.
      QMH(1)=0.
      QMH(KP)=1.
      DO 1 K=2,KD
      QMH(K)=0.5*(Q(K-1)+Q(K))
1     CONTINUE
      PD(1)=0.
      PD(KP2)=PSS
      DO 2 K=2,KP
      PD(K)=Q(K-1)*PSS
2     CONTINUE
!       call int_get_fresh_handle(retval)
!       close(retval)
!       write(0,*)' before open in CO2O3'
!       open(unit=retval,file=prsmid,form='UNFORMATTED',iostat=ier)
!       write(0,*)' after open1'
!       do k=1,62
!         write(retval)pd(k)
!       enddo
!       close(retval)
      PLM(1)=0.
      DO 3 K=1,KM
      PLM(K+1)=0.5*(PD(K+1)+PD(K+2))
3     CONTINUE
      PLM(KP)=PSS
      DO 4 K=1,KD
      GTEMP(K)=PD(K+1)**0.2*(1.+PD(K+1)/30000.)**0.8/1013250.
4     CONTINUE
      GTEMP(KP)=0.
!+++  WRITE (6,100) (GTEMP(K),K=1,KD)
!+++  WRITE (6,100) (PD(K),K=1,KP2)
!+++  WRITE (6,100) (PLM(K),K=1,KP)
!***TAPES 41,42 ARE OUTPUT TO THE CO2 INTERPOLATION PROGRAM (PS=1013MB)
!  THE FOLLOWING PUTS P-DATA INTO MB
      DO 11 I=1,KP
      PD(I)=PD(I)*1.0E-3
      PLM(I)=PLM(I)*1.0E-3
11    CONTINUE
      PD(KP2)=PD(KP2)*1.0E-3
!CC         WRITE (41,101) (PD(K),K=1,KP2)
!CC         WRITE (41,101) (PLM(K),K=1,KP)
!CC         WRITE (42,101) (PLM(K),K=1,KP)
      DO 300 K=1,KP2
       T41(K,1) = PD(K)
  300 CONTINUE
      DO 301 K=1,KP
       T41(K,2) = PLM(K)
       T42(K) = PLM(K)
  301 CONTINUE
!***STORE AS PDT,SO THAT RIGHT PD IS RETURNED TO PTZ
      DO 12 I=1,KP2
      PDT(I)=PD(I)
12    CONTINUE
!***SECOND PASS: PSS=810MB,GTEMP NOT COMPUTED
      PSS=0.8*1013250.
      QMH(1)=0.
      QMH(KP)=1.
      DO 201 K=2,KD
      QMH(K)=0.5*(Q(K-1)+Q(K))
201   CONTINUE
      PD(1)=0.
      PD(KP2)=PSS
      DO 202 K=2,KP
      PD(K)=Q(K-1)*PSS
202   CONTINUE
      PLM(1)=0.
      DO 203 K=1,KM
      PLM(K+1)=0.5*(PD(K+1)+PD(K+2))
203   CONTINUE
      PLM(KP)=PSS
!+++  WRITE (6,100) (PD(K),K=1,KP2)
!+++  WRITE (6,100) (PLM(K),K=1,KP)
!***TAPES 43,44 ARE OUTPUT TO THE CO2 INTERPOLATION PROGRAM(PS=810 MB)
!  THE FOLLOWING PUTS P-DATA INTO MB
      DO 211 I=1,KP
      PD(I)=PD(I)*1.0E-3
      PLM(I)=PLM(I)*1.0E-3
211   CONTINUE
      PD(KP2)=PD(KP2)*1.0E-3
!CC       WRITE (43,101) (PD(K),K=1,KP2)
!CC       WRITE (43,101) (PLM(K),K=1,KP)
!CC       WRITE (44,101) (PLM(K),K=1,KP)
      DO 302 K=1,KP2
       T43(K,1) = PD(K)
  302 CONTINUE
      DO 303 K=1,KP
       T43(K,2) = PLM(K)
       T44(K) = PLM(K)
  303 CONTINUE
!***RESTORE PD
      DO 212 I=1,KP2
      PD(I)=PDT(I)
212   CONTINUE
100   FORMAT (1X,5E20.13)
101   FORMAT (5E16.9)
      RETURN
      END SUBROUTINE SIGP
!---------------------------------------------------------------------
      SUBROUTINE SINTR2
!....
!     IMPLICIT DOUBLE PRECISION (A-H,O-Z)
!     REAL P1,P2,PA,TRNSLO,CORE,TRANSA,PATH,UEXP,SEXP,ETA,SEXPV
      COMMON/INPUT/P1,P2,TRNSLO,IA,JA,N
!     COMMON/PRESS/ PA(109)
!     COMMON/TRAN/ TRANSA(109,109)
!     COMMON/COEFS/XA(109),CA(109),ETA(109),SEXPV(109),CORE,UEXP,SEXP
      integer :: i,ia,iii,ieta,ietap1,ip1,j,ja,jjj,jp1,l,n,nmethd
      real :: etap,peta,pipmpi,up2p1,tri,trip,tij,tipj,tipjp,uij,uipj &
             ,uijp,uipjp,prodi,prodip,prod,xint,cint,aij,aijp,aipj &
             ,aipjp,eij,eipj,eipjp,dtdj,dtdpj,epip1,epip1epipp1,epp2p1 &
             ,trnslo,tip2j,tip2jpti2j2,tijp2,tipjp2,uip2j,uijp2,uipjp2 &
             ,ui2j2,uip2jp,aijp2,aipjp2,aipj2,aip2jp,ai2j2,eip2j,eip2jp &
             ,eijp2,ei2j2,ep,ep2,epsil,ratio,aip2j,eipjp2,ei,epipp1 &
             ,tip2jp,ti2j2,tijp,eijp,p1,p2
      DO 70 L=1,109
      IP1=L
      IF (P2-PA(L)) 65,65,70
   70 CONTINUE
   65 I=IP1-1
      IF (IP1.EQ.1) IP1=2
      IF (I.EQ.0) I=1
      DO 80 L=1,109
      JP1=L
      IF (P1-PA(L)) 75,75,80
   80 CONTINUE
   75 J=JP1-1
      IF (JP1.EQ.1) JP1=2
      IF (J.EQ.0) J=1
      JJJ=J
      III=I
      J=JJJ
      JP1=J+1
      I=III
      IP1=I+1
!  DETERMINE ETAP,THE VALUE OF ETA TO USE BY LINEAR INTERPOLATION
!    FOR PETA(=0.5*(P1+P2))
      PETA=P2
      DO 90 L=1,109
      IETAP1=L
      IF (PETA-PA(L)) 85,85,90
90    CONTINUE
85    IETA=IETAP1-1
      IF (IETAP1.EQ.1) IETAP1=2
      IF (IETA.EQ.0) IETA=1
      ETAP=ETA(IETA)+(PETA-PA(IETA))*(ETA(IETAP1)-ETA(IETA))/ &
       (PA(IETAP1)-PA(IETA))
      SEXP=SEXPV(IETA)+(PETA-PA(IETA))*(SEXPV(IETAP1)- &
       SEXPV(IETA))/ (PA(IETAP1)-PA(IETA))
      PIPMPI=PA(IP1)-PA(I)
      UP2P1=(PATH(P2,P1,CORE,ETAP))**UEXP
      IF (I-J) 126,126,127
  126 CONTINUE
      TRIP=(CA(IP1)*DLOG(1.0D0+XA(IP1)*UP2P1))**(SEXP/UEXP)
      TRI=(CA(I)*DLOG(1.0D0+XA(I)*UP2P1))**(SEXP/UEXP)
      TRNSLO=1.0D0-((PA(IP1)-P2)*TRI+(P2-PA(I))*TRIP)/PIPMPI
      GO TO 128
  127 TIJ=TRANSA(I,J)
      TIPJ=TRANSA(I+1,J)
      TIJP=TRANSA(I,J+1)
      TIPJP=TRANSA(I+1,J+1)
      UIJ=(PATH(PA(I),PA(J),CORE,ETAP))**UEXP
      UIPJ=(PATH(PA(I+1),PA(J),CORE,ETAP))**UEXP
      UIJP=(PATH(PA(I),PA(J+1),CORE,ETAP))**UEXP
      UIPJP=(PATH(PA(I+1),PA(J+1),CORE,ETAP))**UEXP
      PRODI=CA(I)*XA(I)
      PRODIP=CA(I+1)*XA(I+1)
      PROD=((PA(I+1)-P2)*PRODI+(P2-PA(I))*PRODIP)/PIPMPI
      XINT=((PA(I+1)-P2)*XA(I)+(P2-PA(I))*XA(I+1))/PIPMPI
      CINT=PROD/XINT
      AIJ=(CINT*DLOG(1.0D0+XINT*UIJ))**(SEXP/UEXP)
      AIJP=(CINT*DLOG(1.0D0+XINT*UIJP))**(SEXP/UEXP)
      AIPJ=(CINT*DLOG(1.0D0+XINT*UIPJ))**(SEXP/UEXP)
      AIPJP=(CINT*DLOG(1.0D0+XINT*UIPJP))**(SEXP/UEXP)
      EIJ=TIJ+AIJ
      EIPJ=TIPJ+AIPJ
      EIJP=TIJP+AIJP
      EIPJP=TIPJP+AIPJP
      DTDJ=(EIJP-EIJ)/(PA(J+1)-PA(J))
      DTDPJ=(EIPJP-EIPJ)/(PA(J+1)-PA(J))
      EPIP1=EIJ+DTDJ*(P1-PA(J))
      EPIPP1=EIPJ+DTDPJ*(P1-PA(J))
      EPP2P1=((PA(I+1)-P2)*EPIP1+(P2-PA(I))*EPIPP1)/PIPMPI
      TRNSLO=EPP2P1-(CINT*DLOG(1.0D0+XINT*UP2P1))**(SEXP/UEXP)
      IF (I.GE.108.OR.J.GE.108) GO TO 350
      IF (I-J-2) 350,350,355
355   CONTINUE
      TIP2J=TRANSA(I+2,J)
      TIP2JP=TRANSA(I+2,J+1)
      TI2J2=TRANSA(I+2,J+2)
      TIJP2=TRANSA(I,J+2)
      TIPJP2=TRANSA(I+1,J+2)
      UIP2J=(PATH(PA(I+2),PA(J),CORE,ETAP))**UEXP
      UIJP2=(PATH(PA(I),PA(J+2),CORE,ETAP))**UEXP
      UIPJP2=(PATH(PA(I+1),PA(J+2),CORE,ETAP))**UEXP
      UI2J2=(PATH(PA(I+2),PA(J+2),CORE,ETAP))**UEXP
      UIP2JP=(PATH(PA(I+2),PA(J+1),CORE,ETAP))**UEXP
      AIJP2=(CINT*DLOG(1.0D0+XINT*UIJP2))**(SEXP/UEXP)
      AIPJP2=(CINT*DLOG(1.0D0+XINT*UIPJP2))**(SEXP/UEXP)
      AIP2J=(CINT*DLOG(1.0D0+XINT*UIP2J))**(SEXP/UEXP)
      AIP2JP=(CINT*DLOG(1.0D0+XINT*UIP2JP))**(SEXP/UEXP)
      AI2J2=(CINT*DLOG(1.0D0+XINT*UI2J2))**(SEXP/UEXP)
      EIP2J=TIP2J+AIP2J
      EIP2JP=TIP2JP+AIP2JP
      EIJP2=TIJP2+AIJP2
      EIPJP2=TIPJP2+AIPJP2
      EI2J2=TI2J2+AI2J2
      CALL QINTRP(PA(J),PA(J+1),PA(J+2),EIJ,EIJP,EIJP2,P1,EI)
      CALL QINTRP(PA(J),PA(J+1),PA(J+2),EIPJ,EIPJP,EIPJP2,P1,EP)
      CALL QINTRP(PA(J),PA(J+1),PA(J+2),EIP2J,EIP2JP,EI2J2,P1,EP2)
      CALL QINTRP(PA(I),PA(I+1),PA(I+2),EI,EP,EP2,P2,EPSIL)
      TRNSLO=EPSIL-(CINT*DLOG(1.0D0+XINT*UP2P1))**(SEXP/UEXP)
  350 CONTINUE
  128 CONTINUE
  205 CONTINUE
      RETURN
      END SUBROUTINE SINTR2
      SUBROUTINE CO2O3(SFULL,SHALF,PPTOP,L,LP1,LP2)
!CCC  PROGRAM CO2O3 = CONSOLIDATION OF A NUMBER OF DAN SCHWARZKOPF,GFDL
!                     CODES TO PRODUCE A FILE OF CO2 HGT DATA
!                     FOR ANY VERTICAL COORDINATE (READ BY SUBROUTINE
!                     CONRAD IN THE GFDL RADIATION CODES)-K.A.C. JUN89.
!NOV89--UPDATED (NOV 89) FOR LATEST GFDL LW RADIATION.....K.A.C.
      LOGICAL                 :: opened
!     integer :: retval,kk,ka,kb
!     character(50) :: co2='co2'
      INTEGER etarad_unit61, etarad_unit62, etarad_unit63,IERROR
      INTEGER :: I,L,LP1,LP2,iq,ir,irtn,lread,ico2tp,k,k1,k2,nmethd
      REAL :: PPTOP,ratio
      REAL,DIMENSION(L) :: SIGLNU,SHALF
      REAL,DIMENSION(L,6) :: CO2D1D
      REAL,DIMENSION(LP1,2) :: SGTEMP
      REAL,DIMENSION(LP1,LP1,6) :: CO2D2D
!NOV89
      REAL,DIMENSION(LP1,LP1,6) :: CO2IQ2,CO2IQ3,CO2IQ5
!NOV89
      REAL,DIMENSION(LP1) :: SFULL,SGLVNU,T42,T44
      REAL,DIMENSION(LP2,2) :: T41,T43
      REAL,DIMENSION(LP1,LP1,3) :: T20,T21,T22,T23
!     DIMENSION STEMP(LP1),GTEMP(LP1)
!     DIMENSION CDTM51(L),CO2M51(L),C2DM51(L)
!     DIMENSION CDTM58(L),CO2M58(L),C2DM58(L)
!     DIMENSION CDT51(LP1,LP1),CO251(LP1,LP1),C2D51(LP1,LP1)
!     DIMENSION CDT58(LP1,LP1),CO258(LP1,LP1),C2D58(LP1,LP1)
!NOV89
!     DIMENSION CDT31(LP1),CO231(LP1),C2D31(LP1)
!     DIMENSION CDT38(LP1),CO238(LP1),C2D38(LP1)
!     DIMENSION CDT71(LP1),CO271(LP1),C2D71(LP1)
!     DIMENSION CDT78(LP1),CO278(LP1),C2D78(LP1)
!     DIMENSION CO211(LP1),CO218(LP1)
!     EQUIVALENCE (CDT31(1),CO2IQ2(1,1,1)),(CO231(1),CO2IQ2(1,1,2))
!     EQUIVALENCE (C2D31(1),CO2IQ2(1,1,3)),(CDT38(1),CO2IQ2(1,1,4))
!     EQUIVALENCE (CO238(1),CO2IQ2(1,1,5)),(C2D38(1),CO2IQ2(1,1,6))
!     EQUIVALENCE (CDT71(1),CO2IQ3(1,1,1)),(CO271(1),CO2IQ3(1,1,2))
!     EQUIVALENCE (C2D71(1),CO2IQ3(1,1,3)),(CDT78(1),CO2IQ3(1,1,4))
!     EQUIVALENCE (CO278(1),CO2IQ3(1,1,5)),(C2D78(1),CO2IQ3(1,1,6))
!     EQUIVALENCE (CO211(1),CO2IQ5(1,1,2)),(CO218(1),CO2IQ5(1,1,5))
!NOV89
!     EQUIVALENCE (STEMP(1),SGTEMP(1,1)),(GTEMP(1),SGTEMP(1,2))
!     EQUIVALENCE (CDTM51(1),CO2D1D(1,1)),(CO2M51(1),CO2D1D(1,2))
!     EQUIVALENCE (C2DM51(1),CO2D1D(1,3)),(CDTM58(1),CO2D1D(1,4))
!     EQUIVALENCE (CO2M58(1),CO2D1D(1,5)),(C2DM58(1),CO2D1D(1,6))
!     EQUIVALENCE (CDT51(1,1),CO2D2D(1,1,1)),(CO251(1,1),CO2D2D(1,1,2))
!     EQUIVALENCE (C2D51(1,1),CO2D2D(1,1,3)),(CDT58(1,1),CO2D2D(1,1,4))
!     EQUIVALENCE (CO258(1,1),CO2D2D(1,1,5)),(C2D58(1,1),CO2D2D(1,1,6))

!
!***  DEALLOCATE BEFORE READING. THIS IS REQUIRED FOR NESTED DOMAIN INIT.
!
      IF(ALLOCATED (CO251))DEALLOCATE(CO251)
      IF(ALLOCATED (CDT51))DEALLOCATE(CDT51)
      IF(ALLOCATED (C2D51))DEALLOCATE(C2D51)
      IF(ALLOCATED (CO258))DEALLOCATE(CO258)
      IF(ALLOCATED (CDT58))DEALLOCATE(CDT58)
      IF(ALLOCATED (C2D58))DEALLOCATE(C2D58)
      IF(ALLOCATED (STEMP))DEALLOCATE(STEMP)
      IF(ALLOCATED (GTEMP))DEALLOCATE(GTEMP)
      IF(ALLOCATED (CO231))DEALLOCATE(CO231)
      IF(ALLOCATED (CDT31))DEALLOCATE(CDT31)
      IF(ALLOCATED (C2D31))DEALLOCATE(C2D31)
      IF(ALLOCATED (CO238))DEALLOCATE(CO238)
      IF(ALLOCATED (CDT38))DEALLOCATE(CDT38)
      IF(ALLOCATED (C2D38))DEALLOCATE(C2D38)
      IF(ALLOCATED (CO271))DEALLOCATE(CO271)
      IF(ALLOCATED (CDT71))DEALLOCATE(CDT71)
      IF(ALLOCATED (C2D71))DEALLOCATE(C2D71)
      IF(ALLOCATED (CO278))DEALLOCATE(CO278)
      IF(ALLOCATED (CDT78))DEALLOCATE(CDT78)
      IF(ALLOCATED (C2D78))DEALLOCATE(C2D78)
      IF(ALLOCATED (CO2M51))DEALLOCATE(CO2M51)
      IF(ALLOCATED (CDTM51))DEALLOCATE(CDTM51)
      IF(ALLOCATED (C2DM51))DEALLOCATE(C2DM51)
      IF(ALLOCATED (CO2M58))DEALLOCATE(CO2M58)
      IF(ALLOCATED (CDTM58))DEALLOCATE(CDTM58)
      IF(ALLOCATED (C2DM58))DEALLOCATE(C2DM58)
!
      ALLOCATE(CO251(LP1,LP1))
      ALLOCATE(CDT51(LP1,LP1))
      ALLOCATE(C2D51(LP1,LP1))
      ALLOCATE(CO258(LP1,LP1))
      ALLOCATE(CDT58(LP1,LP1))
      ALLOCATE(C2D58(LP1,LP1))
      ALLOCATE(STEMP(LP1))
      ALLOCATE(GTEMP(LP1))
      ALLOCATE(CO231(LP1))
      ALLOCATE(CDT31(LP1))
      ALLOCATE(C2D31(LP1))
      ALLOCATE(CO238(LP1))
      ALLOCATE(CDT38(LP1))
      ALLOCATE(C2D38(LP1))
      ALLOCATE(CO271(LP1))
      ALLOCATE(CDT71(LP1))
      ALLOCATE(C2D71(LP1))
      ALLOCATE(CO278(LP1))
      ALLOCATE(CDT78(LP1))
      ALLOCATE(C2D78(LP1))
      ALLOCATE(CO2M51(L))
      ALLOCATE(CDTM51(L))
      ALLOCATE(C2DM51(L))
      ALLOCATE(CO2M58(L))
      ALLOCATE(CDTM58(L))
      ALLOCATE(C2DM58(L))
      IF (MYPE==0) THEN
        DO i = 61,99
          INQUIRE ( i , OPENED = opened )
          IF ( .NOT. opened ) THEN
            etarad_unit61 = i
            GOTO 2061
          ENDIF
        ENDDO
        etarad_unit61 = -1
 2061   CONTINUE
        DO i = 62,99
          INQUIRE ( i , OPENED = opened )
          IF ( .NOT. opened ) THEN
            etarad_unit62 = i
            GOTO 2062
          ENDIF
        ENDDO
        etarad_unit62 = -1
 2062   CONTINUE
        DO i = 63,99
          INQUIRE ( i , OPENED = opened )
          IF ( .NOT. opened ) THEN
            etarad_unit63 = i
            GOTO 2063
          ENDIF
        ENDDO
        etarad_unit63 = -1
 2063   CONTINUE
      ENDIF
      CALL MPI_BCAST(etarad_unit61,1,MPI_INTEGER,0  &
                    ,MPI_COMM_COMP,IRTN)
      IF ( etarad_unit61 < 0 ) THEN
        WRITE(0,*)'module_ra_gfdleta: co2o3: Can not find unused fortran unit to read in lookup table.' 
!!!     CALL ESMF_Finalize(terminationflag=ESMF_ABORT)
        CALL NMMB_FINALIZE
      ENDIF
      CALL MPI_BCAST(etarad_unit62,1,MPI_INTEGER,0  &
                    ,MPI_COMM_COMP,IRTN)
      IF ( etarad_unit62 < 0 ) THEN
        WRITE(0,*)'module_ra_gfdleta: co2o3: Can not find unused fortran unit to read in lookup table.' 
!!!     CALL ESMF_Finalize(terminationflag=ESMF_ABORT)
        CALL NMMB_FINALIZE
      ENDIF
      CALL MPI_BCAST(etarad_unit63,1,MPI_INTEGER,0  &
                    ,MPI_COMM_COMP,IRTN)
      IF ( etarad_unit63 < 0 ) THEN
        WRITE(0,*)'module_ra_gfdleta: co2o3: Can not find unused fortran unit to read in lookup table.'
!!!     CALL ESMF_Finalize(terminationflag=ESMF_ABORT)
        CALL NMMB_FINALIZE
      ENDIF
        IF (MYPE==0) THEN
          OPEN(etarad_unit61,FILE='tr49t85',                  &
               FORM='FORMATTED',STATUS='OLD',ERR=9061,IOSTAT=IERROR)
          IF(IERROR/=0)WRITE(0,*)' CO2O3 Failed to open tr49t85'
        ENDIF
        IF (MYPE==0) THEN
          OPEN(etarad_unit62,FILE='tr49t67',                  &
               FORM='FORMATTED',STATUS='OLD',ERR=9062,IOSTAT=IERROR)
          IF(IERROR/=0)WRITE(0,*)' CO2O3 Failed to open tr49t67'
        ENDIF
        IF (MYPE==0) THEN
          OPEN(etarad_unit63,FILE='tr67t85',                  &
               FORM='FORMATTED',STATUS='OLD',ERR=9063,IOSTAT=IERROR)
          IF(IERROR/=0)WRITE(0,*)' CO2O3 Failed to open tr67t85'
        ENDIF


!===>  GET SGTEMP AND OUTPUT WHICH USED TO BE ON UNITS 41,42,43,44....
      LREAD = 0
!     DO KKK=1,L
!JD      READ(23)SIGLNU(KKK)
!      SIGLNU(KKK)=1.-FLOAT(KKK)/LP1
!     END DO
      CALL CO2PTZ(SGTEMP,T41,T42,T43,T44,SGLVNU,SIGLNU, &
                  SFULL,SHALF,PPTOP,LREAD,L,LP1,LP2)
!       call int_get_fresh_handle(retval)
!       close(retval)
!       open(unit=retval,file=co2,form='UNFORMATTED',iostat=ier)
!       do kk=1,2
!         write(retval)(sgtemp(k,kk),k=1,61)
!       enddo
      DO K=1,LP1
        STEMP(K)=SGTEMP(K,1)
        GTEMP(K)=SGTEMP(K,2)
      ENDDO
!===>  INTERPOLATE DESIRED CO2 DATA FROM THE DETAILED(109,109) GRID..
!         IR=1,IQ=1 IS FOR COMMON /CO2BD3/ IN RADIATION CODE...
!           FOR THE CONSOLIDATED 490-850 CM-1 BAND...
!NOV89
!     ICO2TP=61
      ICO2TP=etarad_unit61
!NOV89
      IR = 1
      RATIO = 1.0
      NMETHD = 2
      CALL CO2INT(ICO2TP,T41,T42,T22,RATIO,IR,NMETHD,L,LP1,LP2)
      IR = 1
      RATIO = 1.0
      NMETHD = 1
      CALL CO2INT(ICO2TP,T41,T42,T20,RATIO,IR,NMETHD,L,LP1,LP2)
      IR = 1
      RATIO = 1.0
      NMETHD = 2
      CALL CO2INT(ICO2TP,T43,T44,T23,RATIO,IR,NMETHD,L,LP1,LP2)
      IR = 1
      RATIO = 1.0
      NMETHD = 1
      CALL CO2INT(ICO2TP,T43,T44,T21,RATIO,IR,NMETHD,L,LP1,LP2)
!===>    FILL UP THE CO2D1D ARRAY
!       THE FOLLOWING GETS CO2 TRANSMISSION FUNCTIONS AND
!         THEIR DERIVATIVES FOR TAU(I,I+1),I=1,LEVS,
!         WHERE THE VALUES ARE NOT OBTAINED BY QUADRATURE BUT ARE THE
!         ACTUAL TRANSMISSIVITIES,ETC,BETWEEN A PAIR OF PRESSURES. THESE
!         ARE USED ONLY FOR NEARBY LAYER CALCULATIONS INCLUDING H2O..
!
      IQ = 1
      CALL CO2IN1(T20,T21,CO2D1D,IQ,L,LP1)
!       do kk=1,6
!         write(retval)(co2d1d(k,kk),k=1,60)
!       enddo
      DO K=1,L
        CDTM51(K)=CO2D1D(K,1)
        CO2M51(K)=CO2D1D(K,2)
        C2DM51(K)=CO2D1D(K,3)
        CDTM58(K)=CO2D1D(K,4)
        CO2M58(K)=CO2D1D(K,5)
        C2DM58(K)=CO2D1D(K,6)
      ENDDO
!
!===>    FILL UP THE CO2D2D ARRAY
!    THE FOLLOWING GETS CO2 TRANSMISSION FUNCTIONS AND THEIR DERIVATIVES
!        FROM 109-LEVEL LINE-BY-LINE CALCULATIONS MADE USING THE 1982
!        MCCLATCHY TAPE (12511 LINES),CONSOLIDATED,INTERPOLATED
!        TO THE MRF VERTICAL COORDINATE,AND RE-CONSOLIDATED TO A
!        200 CM-1 BANDWIDTH. THE INTERPOLATION METHOD IS DESCRIBED IN
!        SCHWARZKOPF AND FELS (J.G.R.,1985).
!
      CALL CO2INS(T22,T23,CO2D2D,IQ,L,LP1,1)
!       do kk=1,6
!         write(retval)((co2d2d(ka,kb,kk),ka=1,61),kb=1,61)
!       enddo
      DO K1=1,LP1
      DO K2=1,LP1
        CDT51(K1,K2)=CO2D2D(K1,K2,1)
        CO251(K1,K2)=CO2D2D(K1,K2,2)
        C2D51(K1,K2)=CO2D2D(K1,K2,3)
        CDT58(K1,K2)=CO2D2D(K1,K2,4)
        CO258(K1,K2)=CO2D2D(K1,K2,5)
        C2D58(K1,K2)=CO2D2D(K1,K2,6)
      ENDDO
      ENDDO
!
!NOV89
!===>  INTERPOLATE DESIRED CO2 DATA FROM THE DETAILED(109,109) GRID..
!         IR=2,IQ=2 IS FOR COMMON /CO2BD2/ IN RADIATION CODE...
!           FOR THE CONSOLIDATED 490-670 CM-1 BAND...
!     ICO2TP=62
      ICO2TP=etarad_unit62
      IR = 2
      RATIO = 1.0
      NMETHD = 2
      CALL CO2INT(ICO2TP,T41,T42,T22,RATIO,IR,NMETHD,L,LP1,LP2)
      CALL CO2INT(ICO2TP,T43,T44,T23,RATIO,IR,NMETHD,L,LP1,LP2)
      IQ = 2
      CALL CO2INS(T22,T23,CO2IQ2,IQ,L,LP1,2)
!       do kk=1,6
!         write(retval)(co2iq2(k,1,kk),k=1,61)
!       enddo
      DO K=1,LP1
        CDT31(K)=CO2IQ2(K,1,1)
        CO231(K)=CO2IQ2(K,1,2)
        C2D31(K)=CO2IQ2(K,1,3)
        CDT38(K)=CO2IQ2(K,1,4)
        CO238(K)=CO2IQ2(K,1,5)
        C2D38(K)=CO2IQ2(K,1,6)
      ENDDO
!===>  INTERPOLATE DESIRED CO2 DATA FROM THE DETAILED(109,109) GRID..
!         IR=3,IQ=3 IS FOR COMMON /CO2BD4/ IN RADIATION CODE...
!           FOR THE CONSOLIDATED 670-850 CM-1 BAND...
!     ICO2TP=63
      ICO2TP=etarad_unit63
      IR = 3
      RATIO = 1.0
      NMETHD = 2
      CALL CO2INT(ICO2TP,T41,T42,T22,RATIO,IR,NMETHD,L,LP1,LP2)
      CALL CO2INT(ICO2TP,T43,T44,T23,RATIO,IR,NMETHD,L,LP1,LP2)
      IQ = 3
      CALL CO2INS(T22,T23,CO2IQ3,IQ,L,LP1,3)
!       do kk=1,6
!         write(retval)(co2iq3(k,1,kk),k=1,61)
!       enddo
!       close(retval)
      DO K=1,LP1
        CDT71(K)=CO2IQ3(K,1,1)
        CO271(K)=CO2IQ3(K,1,2)
        C2D71(K)=CO2IQ3(K,1,3)
        CDT78(K)=CO2IQ3(K,1,4)
        CO278(K)=CO2IQ3(K,1,5)
        C2D78(K)=CO2IQ3(K,1,6)
      ENDDO
!---      FOLLOWING CODE NOT WORKING AND NOT NEEDED YET
!===>  INTERPOLATE DESIRED CO2 DATA FROM THE DETAILED(109,109) GRID..
!         IR=4,IQ=5 IS FOR COMMON /CO2BD5/ IN RADIATION CODE...
!           FOR THE 4.3 MICRON BAND...
! NOT USED YET      ICO2TP=65
! NOT USED YET      IR = 4
! NOT USED YET      RATIO = 1.0
! DAN SCHWARZ --- USE 300PPMV  RATIO = 0.9091   (NOT TESTED YET).....
! NOT USED YET      NMETHD = 2
! NOT USED YET      CALL CO2INT(ICO2TP,T41,T42,T22,RATIO,IR,NMETHD)
! NOT USED YET      CALL CO2INT(ICO2TP,T43,T44,T23,RATIO,IR,NMETHD)
! NOT USED YET      IQ = 5
! NOT USED YET      CALL CO2INS(T22,T23,CO2IQ5,IQ)
!NOV89
!...     WRITE DATA TO DISK..
!            ...SINCE THESE CODES ARE COMPILED WITH AUTODBL,THE CO2 DATA
!               IS CONVERTED TO SINGLE PRECISION IN A LATER JOB STEP..

! NOT USED YET      WRITE(66) CO211
! NOT USED YET      WRITE(66) CO218
!NOV89
         IF (MYPE==0) THEN
           CLOSE (etarad_unit61)
           CLOSE (etarad_unit62)
           CLOSE (etarad_unit63)
         ENDIF

      RETURN
9061 CONTINUE
     WRITE(0,*) 'module_ra_gfdleta: error reading tr49t85 on unit ',etarad_unit61
!!!  CALL ESMF_Finalize(terminationflag=ESMF_ABORT)
     CALL NMMB_FINALIZE
9062 CONTINUE
     WRITE(0,*) 'module_ra_gfdleta: error reading tr49t67 on unit ',etarad_unit62
!!!  CALL ESMF_Finalize(terminationflag=ESMF_ABORT)
     CALL NMMB_FINALIZE
9063 CONTINUE
     WRITE(0,*) 'module_ra_gfdleta: error reading tr67t85 on unit ',etarad_unit63
!!!  CALL ESMF_Finalize(terminationflag=ESMF_ABORT)
     CALL NMMB_FINALIZE
      END SUBROUTINE CO2O3


!!================================================================================
!----------------------------------------------------------------------
!----------------------------------------------------------------------
      SUBROUTINE CONRAD(KDS,KDE,KMS,KME,KTS,KTE)
!----------------------------------------------------------------------
!    *******************************************************************
!    *                           C O N R A D                           *
!    *    READ CO2 TRANSMISSION DATA FROM UNIT(NFILE)FOR NEW VERTICAL  *
!    *      COORDINATE TESTS      ...                                  *
!    *    THESE ARRAYS USED TO BE IN BLOCK DATA    ...K.CAMPANA-MAR 90 *
!    *******************************************************************
!
!----------------------------------------------------------------------
      IMPLICIT NONE
!----------------------------------------------------------------------
      INTEGER,INTENT(IN) :: KDS,KDE,KMS,KME,KTS,KTE
!----------------------------------------------------------------------
!
      INTEGER :: I,I1,I2,IERROR,IRTN,J,K,KK,L,LP1,N,NUNIT_CO2,RSIZE
      INTEGER,DIMENSION(3) :: RSZE
!
      REAL,DIMENSION(KMS:KME-1,6) :: CO21D
      REAL,DIMENSION(KMS:KME,2) :: SGTMP
      REAL,DIMENSION(KMS:KME,6) :: CO21D3,CO21D7
      REAL,DIMENSION(KMS:KME,KMS:KME,6) :: CO22D
      REAL,DIMENSION((KME-KMS+1)*(KME-KMS+1)) :: DATA2
      LOGICAL :: OPENED
!
!----------------------------------------------------------------------
!
!                 CO2 DATA TABLES FOR USER'S VERTICAL COORDINATE
!
!   THE FOLLOWING COMMON BLOCKS CONTAIN PRETABULATED CO2 TRANSMISSION
!       FUNCTIONS, EVALUATED USING THE METHODS OF FELS AND
!       SCHWARZKOPF (1981) AND SCHWARZKOPF AND FELS (1985),
!-----  THE 2-DIMENSIONAL ARRAYS ARE
!                    CO2 TRANSMISSION FUNCTIONS AND THEIR DERIVATIVES
!        FROM 109-LEVEL LINE-BY-LINE CALCULATIONS MADE USING THE 1982
!        MCCLATCHY TAPE (12511 LINES),CONSOLIDATED,INTERPOLATED
!        TO THE NMC MRF VERTICAL COORDINATTE,AND RE-CONSOLIDATED TO A
!        200 CM-1 BANDWIDTH. THE INTERPOLATION METHOD IS DESCRIBED IN
!        SCHWARZKOPF AND FELS (J.G.R.,1985).
!-----  THE 1-DIM ARRAYS ARE
!                  CO2 TRANSMISSION FUNCTIONS AND THEIR DERIVATIVES
!          FOR TAU(I,I+1),I=1,L,
!            WHERE THE VALUES ARE NOT OBTAINED BY QUADRATURE,BUT ARE THE
!            ACTUAL TRANSMISSIVITIES,ETC,BETWEEN A PAIR OF PRESSURES.
!          THESE USED ONLY FOR NEARBY LAYER CALCULATIONS INCLUDING QH2O.
!-----  THE WEIGHTING FUNCTION GTEMP=P(K)**0.2*(1.+P(K)/30000.)**0.8/
!         1013250.,WHERE P(K)=PRESSURE,NMC MRF(NEW)  L18 DATA LEVELS FOR
!         PSTAR=1013250.
!-----  STEMP IS US STANDARD ATMOSPHERES,1976,AT DATA PRESSURE LEVELS
!        USING NMC MRF SIGMAS,WHERE PSTAR=1013.25 MB (PTZ PROGRAM)
!
!***CO2 TRANSMISSION FUNCTIONS AND TEMPERATURE
!   AND PRESSURE DERIVATIVES FOR THE 560-800 CM-1 BAND. ALSO INCLUDED
!   ARE THE STANDARD TEMPERATURES AND THE WEIGHTING FUNCTION. THESE
!   DATA ARE IN BLOCK DATA BD3:
!         CO251    =  TRANSMISSION FCTNS FOR T0 (STD. PROFILE)
!                       WITH P(SFC)=1013.25 MB
!         CO258    =  TRANSMISSION FCTNS. FOR T0 (STD. PROFILE)
!                       WITH P(SFC)= 810 MB
!         CDT51    =  FIRST TEMPERATURE DERIVATIVE OF CO251
!         CDT58    =  FIRST TEMPERATURE DERIVATIVE OF CO258
!         C2D51    =  SECOND TEMPERATURE DERIVATIVE OF CO251
!         C2D58    =  SECOND TEMPERATURE DERIVATIVE OF CO251
!         CO2M51   =  TRANSMISSION FCTNS FOR T0 FOR ADJACENT PRESSURE
!                        LEVELS, WITH NO PRESSURE QUADRATURE. USED FOR
!                        NEARBY LAYER COMPUTATIONS. P(SFC)=1013.25 MB
!         CO2M58   =  SAME AS CO2M51,WITH P(SFC)= 810 MB
!         CDTM51   =  FIRST TEMPERATURE DERIVATIVE OF CO2M51
!         CDTM58   =  FIRST TEMPERATURE DERIVATIVE OF CO2M58
!         C2DM51   =  SECOND TEMPERATURE DERIVATIVE OF CO2M51
!         C2DM58   =  SECOND TEMPERATURE DERIVATIVE OF CO2M58
!         STEMP    =  STANDARD TEMPERATURES FOR MODEL PRESSURE LEVEL
!                        STRUCTURE WITH P(SFC)=1013.25 MB
!         GTEMP    =  WEIGHTING FUNCTION FOR MODEL PRESSURE LEVEL
!                        STRUCTURE WITH P(SFC)=1013.25 MB.
!-----       THE FOLLOWING ARE STILL IN BLOCK DATA
!         B0       =  TEMP. COEFFICIENT USED FOR CO2 TRANS. FCTN.
!                        CORRECTION FOR T(K). (SEE REF. 4 AND BD3)
!         B1       =  TEMP. COEFFICIENT, USED ALONG WITH B0
!         B2       =  TEMP. COEFFICIENT, USED ALONG WITH B0
!         B3       =  TEMP. COEFFICIENT, USED ALONG WITH B0
!
!***CO2 TRANSMISSION FUNCTIONS AND TEMPERATURE
!   AND PRESSURE DERIVATIVES FOR THE 560-670 CM-1 PART OF THE 15 UM
!   CO2 BAND.  THESE DATA ARE IN BLOCK DATA BD2.
!     FOR THE 560-670 CM-1 BAND,ONLY THE (1,I) VALUES ARE USED , SINCE
!     THESE ARE USED FOR CTS COMPUTATIONS.
!         CO231    =  TRANSMISSION FCTNS FOR T0 (STD. PROFILE)
!                       WITH P(SFC)=1013.25 MB
!         CO238    =  TRANSMISSION FCTNS. FOR T0 (STD. PROFILE)
!                       WITH P(SFC)= 810 MB
!         CDT31    =  FIRST TEMPERATURE DERIVATIVE OF CO231
!         CDT38    =  FIRST TEMPERATURE DERIVATIVE OF CO238
!         C2D31    =  SECOND TEMPERATURE DERIVATIVE OF CO231
!         C2D38    =  SECOND TEMPERATURE DERIVATIVE OF CO231
!
!***CO2 TRANSMISSION FUNCTIONS AND TEMPERATURE
!   AND PRESSURE DERIVATIVES FOR THE 670-800 CM-1 PART OF THE 15 UM
!   CO2 BAND.  THESE DATA ARE IN BLOCK DATA BD4.
!         CO271    =  TRANSMISSION FCTNS FOR T0 (STD. PROFILE)
!                       WITH P(SFC)=1013.25 MB
!         CO278    =  TRANSMISSION FCTNS. FOR T0 (STD. PROFILE)
!                       WITH P(SFC)= 810 MB
!         CDT71    =  FIRST TEMPERATURE DERIVATIVE OF CO271
!         CDT78    =  FIRST TEMPERATURE DERIVATIVE OF CO278
!         C2D71    =  SECOND TEMPERATURE DERIVATIVE OF CO271
!         C2D78    =  SECOND TEMPERATURE DERIVATIVE OF CO271
!
! *****THE FOLLOWING NOT USED IN CURRENT VERSION OF RADIATION *******
!
! --CO2 TRANSMISSION FUNCTIONS FOR THE 2270-
!       2380 PART OF THE 4.3 UM CO2 BAND.
!              THESE DATA ARE IN BLOCK DATA BD5.
!         CO211    =  TRANSMISSION FCTNS FOR T0 (STD. PROFILE)
!                        WITH P(SFC)=1013.25 MB
!         CO218    =  TRANSMISSION FCTNS. FOR T0 (STD. PROFILE)
!                       WITH P(SFC)= 810 MB
!
! *****THE ABOVE NOT USED IN CURRENT VERSION OF RADIATION ***********
!----------------------------------------------------------------------
!
      L=KME-KMS
      LP1=KME-KMS+1
!
!----------------------------------------------------------------------
      IF (MYPE==0) THEN
        DO i = 14,99
          INQUIRE ( i , OPENED = opened )
          IF ( .NOT. opened ) THEN
            nunit_co2 = i
            GOTO 2014
          ENDIF
        ENDDO
        nunit_co2 = -1
 2014   CONTINUE
      ENDIF
!
      IF (MYPE==0) THEN
        OPEN(nunit_co2,FILE='co2_trans',                  &
             FORM='UNFORMATTED',STATUS='OLD',ERR=9014,IOSTAT=IERROR)
        REWIND NUNIT_CO2
      ENDIF
!
!----------------------------------------------------------------------
!
!***  READ IN PRE-COMPUTED CO2 TRANSMISSION DATA.
!
      RSZE(1) = LP1
      RSZE(2) = L
      RSZE(3) = LP1*LP1
!----------------------------------------------------------------------
!
      RSIZE = RSZE(1)
!
      DO KK=1,2
        IF(MYPE==0)READ(NUNIT_CO2)(SGTMP(I,KK),I=1,RSIZE)
        CALL MPI_BCAST(SGTMP(1,KK),RSIZE,MPI_REAL,0                    &
                      ,MPI_COMM_COMP,IRTN)
      ENDDO
!
!----------------------------------------------------------------------
!
      RSIZE = RSZE(2)
!
      DO KK=1,6
        IF(MYPE==0)READ(NUNIT_CO2)(CO21D(I,KK),I=1,RSIZE)
        CALL MPI_BCAST(CO21D(1,KK),RSIZE,MPI_REAL,0                    &
                      ,MPI_COMM_COMP,IRTN)
      ENDDO
!
!----------------------------------------------------------------------
!
      RSIZE = RSZE(3)
!
      DO KK=1,6
        IF(MYPE==0)READ(NUNIT_CO2)(DATA2(I),I=1,RSIZE)
        CALL MPI_BCAST(DATA2(1),RSIZE,MPI_REAL,0                       &
                      ,MPI_COMM_COMP,IRTN)
        N=0
!
        DO I1=1,LP1
        DO I2=1,LP1
          N=N+1
          CO22D(I1,I2,KK)=DATA2(N)
        ENDDO
        ENDDO
!
      ENDDO
!
!***  DEALLOCATE BEFORE READING. THIS IS REQUIRED FOR NESTED DOMAIN INIT.
!
      IF(ALLOCATED (CO251))DEALLOCATE(CO251)
      IF(ALLOCATED (CDT51))DEALLOCATE(CDT51)
      IF(ALLOCATED (C2D51))DEALLOCATE(C2D51)
      IF(ALLOCATED (CO258))DEALLOCATE(CO258)
      IF(ALLOCATED (CDT58))DEALLOCATE(CDT58)
      IF(ALLOCATED (C2D58))DEALLOCATE(C2D58)
      IF(ALLOCATED (STEMP))DEALLOCATE(STEMP)
      IF(ALLOCATED (GTEMP))DEALLOCATE(GTEMP)
      IF(ALLOCATED (CO231))DEALLOCATE(CO231)
      IF(ALLOCATED (CDT31))DEALLOCATE(CDT31)
      IF(ALLOCATED (C2D31))DEALLOCATE(C2D31)
      IF(ALLOCATED (CO238))DEALLOCATE(CO238)
      IF(ALLOCATED (CDT38))DEALLOCATE(CDT38)
      IF(ALLOCATED (C2D38))DEALLOCATE(C2D38)
      IF(ALLOCATED (CO271))DEALLOCATE(CO271)
      IF(ALLOCATED (CDT71))DEALLOCATE(CDT71)
      IF(ALLOCATED (C2D71))DEALLOCATE(C2D71)
      IF(ALLOCATED (CO278))DEALLOCATE(CO278)
      IF(ALLOCATED (CDT78))DEALLOCATE(CDT78)
      IF(ALLOCATED (C2D78))DEALLOCATE(C2D78)
      IF(ALLOCATED (CO2M51))DEALLOCATE(CO2M51)
      IF(ALLOCATED (CDTM51))DEALLOCATE(CDTM51)
      IF(ALLOCATED (C2DM51))DEALLOCATE(C2DM51)
      IF(ALLOCATED (CO2M58))DEALLOCATE(CO2M58)
      IF(ALLOCATED (CDTM58))DEALLOCATE(CDTM58)
      IF(ALLOCATED (C2DM58))DEALLOCATE(C2DM58)
!
!----------------------------------------------------------------------
!
      RSIZE = RSZE(1)
!
      DO KK=1,6
        IF(MYPE==0)READ(NUNIT_CO2)(CO21D3(I,KK),I=1,RSIZE)
        CALL MPI_BCAST(CO21D3(1,KK),RSIZE,MPI_REAL,0                   &
                      ,MPI_COMM_COMP,IRTN)
      ENDDO
!
!----------------------------------------------------------------------
!
      DO KK=1,6
        IF(MYPE==0)READ(NUNIT_CO2)(CO21D7(I,KK),I=1,RSIZE)
        CALL MPI_BCAST(CO21D7(1,KK),RSIZE,MPI_REAL,0                   &
                      ,MPI_COMM_COMP,IRTN)
      ENDDO
!
!----------------------------------------------------------------------
      ALLOCATE(CO251(LP1,LP1))
      ALLOCATE(CDT51(LP1,LP1))
      ALLOCATE(C2D51(LP1,LP1))
      ALLOCATE(CO258(LP1,LP1))
      ALLOCATE(CDT58(LP1,LP1))
      ALLOCATE(C2D58(LP1,LP1))
      ALLOCATE(STEMP(LP1))
      ALLOCATE(GTEMP(LP1))
      ALLOCATE(CO231(LP1))
      ALLOCATE(CDT31(LP1))
      ALLOCATE(C2D31(LP1))
      ALLOCATE(CO238(LP1))
      ALLOCATE(CDT38(LP1))
      ALLOCATE(C2D38(LP1))
      ALLOCATE(CO271(LP1))
      ALLOCATE(CDT71(LP1))
      ALLOCATE(C2D71(LP1))
      ALLOCATE(CO278(LP1))
      ALLOCATE(CDT78(LP1))
      ALLOCATE(C2D78(LP1))
      ALLOCATE(CO2M51(L))
      ALLOCATE(CDTM51(L))
      ALLOCATE(C2DM51(L))
      ALLOCATE(CO2M58(L))
      ALLOCATE(CDTM58(L))
      ALLOCATE(C2DM58(L))
!----------------------------------------------------------------------
!
      DO K=1,LP1
        STEMP(K) = SGTMP(K,1)
        GTEMP(K) = SGTMP(K,2)
      ENDDO
!
      DO K=1,L
        CDTM51(K) = CO21D(K,1)
        CO2M51(K) = CO21D(K,2)
        C2DM51(K) = CO21D(K,3)
        CDTM58(K) = CO21D(K,4)
        CO2M58(K) = CO21D(K,5)
        C2DM58(K) = CO21D(K,6)
      ENDDO
!
      DO J=1,LP1
      DO I=1,LP1
        CDT51(I,J) = CO22D(I,J,1)
        CO251(I,J) = CO22D(I,J,2)
        C2D51(I,J) = CO22D(I,J,3)
        CDT58(I,J) = CO22D(I,J,4)
        CO258(I,J) = CO22D(I,J,5)
        C2D58(I,J) = CO22D(I,J,6)
      ENDDO
      ENDDO
!
      DO K=1,LP1
        CDT31(K) = CO21D3(K,1)
        CO231(K) = CO21D3(K,2)
        C2D31(K) = CO21D3(K,3)
        CDT38(K) = CO21D3(K,4)
        CO238(K) = CO21D3(K,5)
        C2D38(K) = CO21D3(K,6)
      ENDDO
!
      DO K=1,LP1
        CDT71(K) = CO21D7(K,1)
        CO271(K) = CO21D7(K,2)
        C2D71(K) = CO21D7(K,3)
        CDT78(K) = CO21D7(K,4)
        CO278(K) = CO21D7(K,5)
        C2D78(K) = CO21D7(K,6)
      ENDDO
!
!----------------------------------------------------------------------
      IF(MYPE==0)WRITE(0,66)NUNIT_CO2
   66 FORMAT('----READ CO2 TRANSMISSION FUNCTIONS FROM UNIT ',I2)
!----------------------------------------------------------------------
      IF(MYPE==0)THEN
        CLOSE(nunit_co2)
      ENDIF
      RETURN
!
9014 CONTINUE
     WRITE(0,*)'module_ra_gfdleta: error reading co2_trans on unit ',nunit_co2
!!!  CALL ESMF_Finalize(terminationflag=ESMF_ABORT)
     CALL NMMB_FINALIZE
!----------------------------------------------------------------------
!
      END SUBROUTINE CONRAD
!
!----------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!******************  THE DUDHIA SHORTWAVE PACKAGE **********************
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!-----------------------------------------------------------------------
   SUBROUTINE SWRAD(dt,RTHRATEN,GSW,XLAT,XLONG,ALBEDO,            &
                    rho_phy,T3D,QV3D,QC3D,QR3D,                   &
                    QI3D,QS3D,QG3D,P3D,pi3D,dz8w,GMT,             &
                    R,CP,G,JULDAY,                                &
                    XTIME,DECLIN,SOLCON,                          &
                    F_QV,F_QC,F_QR,F_QI,F_QS,F_QG,                &
                    pm2_5_dry,pm2_5_water,pm2_5_dry_ec,           &
                    RADFRQ,ICLOUD,DEGRAD,warm_rain,               &
                    ids,ide, jds,jde, kds,kde,                    & 
                    ims,ime, jms,jme, kms,kme,                    &
                    its,ite, jts,jte, kts,kte                     &
                    )
!------------------------------------------------------------------
   IMPLICIT NONE
!------------------------------------------------------------------
   INTEGER,    INTENT(IN   ) ::        ids,ide, jds,jde, kds,kde, &
                                       ims,ime, jms,jme, kms,kme, &
                                       its,ite, jts,jte, kts,kte

   LOGICAL,    INTENT(IN   ) ::        warm_rain
   INTEGER,    INTENT(IN   ) ::        icloud

   REAL, INTENT(IN    )      ::        RADFRQ,DEGRAD,             &
                                       XTIME,DECLIN,SOLCON
!
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                  &
         INTENT(IN    ) ::                                   P3D, &
                                                            pi3D, &
                                                         rho_phy, &
                                                            dz8w, &
                                                             T3D
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), OPTIONAL ,       &
         INTENT(IN    ) ::                             pm2_5_dry, &
                                                     pm2_5_water, &
                                                    pm2_5_dry_ec


   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                  &
         INTENT(INOUT)  ::                              RTHRATEN
!
   REAL, DIMENSION( ims:ime, jms:jme ),                           &
         INTENT(IN   )  ::                                  XLAT, &
                                                           XLONG, &
                                                          ALBEDO
!
   REAL, DIMENSION( ims:ime, jms:jme ),                           &
         INTENT(INOUT)  ::                                   GSW
!
   REAL, INTENT(IN   )   ::                        GMT,R,CP,G,dt
!
   INTEGER, INTENT(IN  ) ::                               JULDAY  
!
! Optional
!
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                  &
         OPTIONAL,                                                &
         INTENT(IN    ) ::                                        &
                                                            QV3D, &
                                                            QC3D, &
                                                            QR3D, &
                                                            QI3D, &
                                                            QS3D, &
                                                            QG3D

   LOGICAL, OPTIONAL, INTENT(IN )      ::        F_QV,F_QC,F_QR,F_QI,F_QS,F_QG
 
! LOCAL VARS
 
   REAL, DIMENSION( kts:kte ) ::                                  &
                                                          TTEN1D, &
                                                          RHO01D, &
                                                             P1D, &
                                                              DZ, &
                                                             T1D, &
                                                            QV1D, &
                                                            QC1D, &
                                                            QR1D, &
                                                            QI1D, &
                                                            QS1D, &
                                                            QG1D
!
   REAL::      XLAT0,XLONG0,ALB0,GSW0
!
   INTEGER :: i,j,K,NK
   LOGICAL :: predicate
   real :: aer_dry1(kts:kte),aer_water1(kts:kte)

!------------------------------------------------------------------
      write(0,*)' enter Dudhia shortwave'
   j_loop: DO J=jts,jte
   i_loop: DO I=its,ite

! reverse vars 
         DO K=kts,kte
            QV1D(K)=0.
            QC1D(K)=0.
            QR1D(K)=0.
            QI1D(K)=0.
            QS1D(K)=0.
            QG1D(K)=0.
         ENDDO

         DO K=kts,kte
            NK=kme-1-K+kms
            TTEN1D(K)=0.

            T1D(K)=T3D(I,NK,J)
            P1D(K)=P3D(I,NK,J)
            RHO01D(K)=rho_phy(I,NK,J)
            DZ(K)=dz8w(I,NK,J)
         ENDDO

         IF( PRESENT(pm2_5_dry) .AND. PRESENT(pm2_5_water) )THEN
            DO K=kts,kte
               NK=kme-1-K+kms
               aer_dry1(k)   = pm2_5_dry(i,nk,j)
               aer_water1(k) = pm2_5_water(i,nk,j)
            ENDDO
         ELSE
            DO K=kts,kte
               aer_dry1(k)   = 0.
               aer_water1(k) = 0.
            ENDDO
         ENDIF

         IF (PRESENT(F_QV) .AND. PRESENT(QV3D)) THEN
            IF (F_QV) THEN
               DO K=kts,kte
                  NK=kme-1-K+kms
                  QV1D(K)=QV3D(I,NK,J)
                  QV1D(K)=max(0.,QV1D(K))
               ENDDO
            ENDIF
         ENDIF

         IF (PRESENT(F_QC) .AND. PRESENT(QC3D)) THEN
            IF (F_QC) THEN
               DO K=kts,kte
                  NK=kme-1-K+kms
                  QC1D(K)=QC3D(I,NK,J)
                  QC1D(K)=max(0.,QC1D(K))
               ENDDO
            ENDIF
         ENDIF

         IF (PRESENT(F_QR) .AND. PRESENT(QR3D)) THEN
            IF (F_QR) THEN
               DO K=kts,kte
                  NK=kme-1-K+kms
                  QR1D(K)=QR3D(I,NK,J)
                  QR1D(K)=max(0.,QR1D(K))
               ENDDO
            ENDIF
         ENDIF

!
         IF ( PRESENT( F_QI ) ) THEN
            predicate = F_QI
         ELSE
            predicate = .FALSE.
         ENDIF

         IF ( predicate .AND. PRESENT( QI3D ) ) THEN
            DO K=kts,kte
               NK=kme-1-K+kms
               QI1D(K)=QI3D(I,NK,J)
               QI1D(K)=max(0.,QI1D(K))
            ENDDO
         ELSE
            IF (.not. warm_rain) THEN
               DO K=kts,kte
               IF(T1D(K) .lt. 273.15) THEN
                  QI1D(K)=QC1D(K)
                  QC1D(K)=0.
                  QS1D(K)=QR1D(K)
                  QR1D(K)=0.
               ENDIF
               ENDDO
            ENDIF
         ENDIF

         IF (PRESENT(F_QS) .AND. PRESENT(QS3D)) THEN
            IF (F_QS) THEN
               DO K=kts,kte          
                  NK=kme-1-K+kms
                  QS1D(K)=QS3D(I,NK,J)
                  QS1D(K)=max(0.,QS1D(K))
               ENDDO
            ENDIF
         ENDIF

         IF (PRESENT(F_QG) .AND. PRESENT(QG3D)) THEN
            IF (F_QG) THEN
               DO K=kts,kte          
                  NK=kme-1-K+kms
                  QG1D(K)=QG3D(I,NK,J)
                  QG1D(K)=max(0.,QG1D(K))
               ENDDO
            ENDIF
         ENDIF

         XLAT0=XLAT(I,J)
         XLONG0=XLONG(I,J)
         ALB0=ALBEDO(I,J)

         CALL SWPARA(TTEN1D,GSW0,XLAT0,XLONG0,ALB0,              &
                     T1D,QV1D,QC1D,QR1D,QI1D,QS1D,QG1D,P1D,      &
                     XTIME,GMT,RHO01D,DZ,                        &
                     R,CP,G,DECLIN,SOLCON,                       &
                     RADFRQ,ICLOUD,DEGRAD,aer_dry1,aer_water1,   &
                     kts,kte                                     )

         GSW(I,J)=GSW0
         DO K=kts,kte          
            NK=kme-1-K+kms
            RTHRATEN(I,K,J)=RTHRATEN(I,K,J)+TTEN1D(NK)/pi3D(I,K,J)
         ENDDO
!
   ENDDO i_loop
   ENDDO j_loop                                          

   END SUBROUTINE SWRAD

!------------------------------------------------------------------
   SUBROUTINE SWPARA(TTEN,GSW,XLAT,XLONG,ALBEDO,                  &
                     T,QV,QC,QR,QI,QS,QG,P,            		  &
                     XTIME, GMT, RHO0, DZ,             		  &
                     R,CP,G,DECLIN,SOLCON,             		  &
                     RADFRQ,ICLOUD,DEGRAD,aer_dry1,aer_water1,    &
                     kts,kte                            	  )
!------------------------------------------------------------------
!     TO CALCULATE SHORT-WAVE ABSORPTION AND SCATTERING IN CLEAR
!     AIR AND REFLECTION AND ABSORPTION IN CLOUD LAYERS (STEPHENS,
!     1984)
!     CHANGES:
!       REDUCE EFFECTS OF ICE CLOUDS AND PRECIP ON LIQUID WATER PATH
!       ADD EFFECT OF GRAUPEL
!------------------------------------------------------------------

  INTEGER, INTENT(IN ) ::     ICLOUD,     kts,kte
!
  REAL, DIMENSION( kts:kte ), INTENT(IN   )  ::                   &
                                                            RHO0, &
                                                               T, &
                                                               P, &
                                                              DZ, &
                                                              QV, &
                                                              QC, &
                                                              QR, &
                                                              QI, &
                                                              QS, &
                                                              QG

   REAL, DIMENSION( kts:kte ), INTENT(INOUT)::              TTEN
!
   REAL, INTENT(IN  )   ::               XTIME,GMT,R,CP,G,DECLIN, &
                                        SOLCON,XLAT,XLONG,ALBEDO, &
                                                  RADFRQ, DEGRAD
!
   REAL, INTENT(INOUT)  ::                                   GSW
!
! LOCAL VARS
!
   REAL, DIMENSION( kts:kte+1 ) ::                         SDOWN

   REAL, DIMENSION( kts:kte )   ::                          XLWP, &
						            XATP, &
						            XWVP, &
                                             aer_dry1,aer_water1, &
						              RO
!
   REAL, DIMENSION( 4, 5 ) ::                             ALBTAB, &
                                                          ABSTAB

   REAL, DIMENSION( 4    ) ::                             XMUVAL

   REAL :: beta
   integer :: ii,iil,iu,jjl,ju,k
   real :: absc,alba,alw,bext340,bexth2o,soltop,xt24,tloctm,hrang,xxlat,csza &
          ,xmu,ww,uv,oldalb,oldabc,oldabs,totabs,dsca,wgm,ugcm,dabs &
          ,dscld,dabsa,xsca,xabs,xabsa,xabsc,xalb,xi,yj,trans0,ff
!------------------------------------------------------------------

      DATA ALBTAB/0.,0.,0.,0., &
           69.,58.,40.,15.,    &
           90.,80.,70.,60.,    &
           94.,90.,82.,78.,    &
           96.,92.,85.,80./

      DATA ABSTAB/0.,0.,0.,0., &
           0.,2.5,4.,5.,       &
           0.,2.6,7.,10.,      &
           0.,3.3,10.,14.,     &
           0.,3.7,10.,15./

      DATA XMUVAL/0.,0.2,0.5,1.0/

      GSW=0.0
      bext340=5.E-6
      bexth2o=5.E-6
      SOLTOP=SOLCON
      XT24=AMOD(XTIME+RADFRQ*0.5,1440.)
      TLOCTM=GMT+XT24/60.+XLONG/15.
      HRANG=15.*(TLOCTM-12.)*DEGRAD
      XXLAT=XLAT*DEGRAD
      CSZA=SIN(XXLAT)*SIN(DECLIN)+COS(XXLAT)*COS(DECLIN)*COS(HRANG)

!     RETURN IF NIGHT
      IF(CSZA.LE.1.E-9)GOTO 7
!
      DO K=kts, kte

! P in the unit of 10mb
         RO(K)=P(K)/(R*T(K))
         XWVP(K)=RO(K)*QV(K)*DZ(K)*1000.
! KG/M**2
          XATP(K)=RO(K)*DZ(K)
      ENDDO
!
!     G/M**2
!     REDUCE WEIGHT OF LIQUID AND ICE IN SHORT-WAVE SCHEME
!     ADD GRAUPEL EFFECT (ASSUMED SAME AS RAIN)
!
      IF (ICLOUD.EQ.0)THEN
         DO K=kts, kte
            XLWP(K)=0.
         ENDDO
      ELSE
         DO K=kts, kte
            XLWP(K)=RO(K)*1000.*DZ(K)*(QC(K)+0.1*QI(K)+0.05* &
                    QR(K)+0.02*QS(K)+0.05*QG(K))
         ENDDO
      ENDIF
!
      XMU=CSZA
      SDOWN(1)=SOLTOP*XMU
!     SET WW (G/M**2) LIQUID WATER PATH INTEGRATED DOWN
!     SET UV (G/M**2) WATER VAPOR PATH INTEGRATED DOWN
      WW=0.
      UV=0.
      OLDALB=0.
      OLDABC=0.
      TOTABS=0.
!     CONTRIBUTIONS DUE TO CLEAR AIR AND CLOUD
      DSCA=0.
      DABS=0.
      DSCLD=0.
!
! CONTRIBUTION DUE TO AEROSOLS (FOR CHEMISTRY)
      DABSA=0.
!
      DO 200 K=kts,kte
         WW=WW+XLWP(K)
         UV=UV+XWVP(K)
!     WGM IS WW/COS(THETA) (G/M**2)
!     UGCM IS UV/COS(THETA) (G/CM**2)
         WGM=WW/XMU
         UGCM=UV*0.0001/XMU
!
         OLDABS=TOTABS
!     WATER VAPOR ABSORPTION AS IN LACIS AND HANSEN (1974)
         TOTABS=2.9*UGCM/((1.+141.5*UGCM)**0.635+5.925*UGCM)
!     APPROXIMATE RAYLEIGH + AEROSOL SCATTERING
!        XSCA=1.E-5*XATP(K)/XMU
!          XSCA=(1.E-5*XATP(K)+aer_dry1(K)*bext340+aer_water1(K)*bexth2o)/XMU
         beta=0.4*(1.0-XMU)+0.1
!     CSSCA - CLEAR-SKY SCATTERING SET FROM NAMELIST SWRAD_SCAT
         XSCA=(cssca*XATP(K)+beta*aer_dry1(K)*bext340*DZ(K) &
              +beta*aer_water1(K)*bexth2o*DZ(K))/XMU   

!     LAYER VAPOR ABSORPTION DONE FIRST
         XABS=(TOTABS-OLDABS)*(SDOWN(1)-DSCLD-DSCA-DABSA)/SDOWN(K)
!rs   AEROSOL ABSORB (would be elemental carbon). So far XABSA = 0.
         XABSA=0.
         IF(XABS.LT.0.)XABS=0.
!
         ALW=ALOG10(WGM+1.)
         IF(ALW.GT.3.999)ALW=3.999
!
         DO II=1,3
            IF(XMU.GT.XMUVAL(II))THEN
              IIL=II
              IU=II+1
              XI=(XMU-XMUVAL(II))/(XMUVAL(II+1)-XMUVAL(II))+FLOAT(IIL)
            ENDIF
         ENDDO
!
         JJL=IFIX(ALW)+1
         JU=JJL+1
         YJ=ALW+1.
!     CLOUD ALBEDO
         ALBA=(ALBTAB(IU,JU)*(XI-IIL)*(YJ-JJL)   &
              +ALBTAB(IIL,JU)*(IU-XI)*(YJ-JJL)   &
              +ALBTAB(IU,JJL)*(XI-IIL)*(JU-YJ)   &
              +ALBTAB(IIL,JJL)*(IU-XI)*(JU-YJ))  &
             /((IU-IIL)*(JU-JJL))
!     CLOUD ABSORPTION
         ABSC=(ABSTAB(IU,JU)*(XI-IIL)*(YJ-JJL)   &
              +ABSTAB(IIL,JU)*(IU-XI)*(YJ-JJL)   &
              +ABSTAB(IU,JJL)*(XI-IIL)*(JU-YJ)   &
              +ABSTAB(IIL,JJL)*(IU-XI)*(JU-YJ))  &
             /((IU-IIL)*(JU-JJL))
!     LAYER ALBEDO AND ABSORPTION
         XALB=(ALBA-OLDALB)*(SDOWN(1)-DSCA-DABS)/SDOWN(K)
         XABSC=(ABSC-OLDABC)*(SDOWN(1)-DSCA-DABS)/SDOWN(K)
         IF(XALB.LT.0.)XALB=0.
         IF(XABSC.LT.0.)XABSC=0.
         DSCLD=DSCLD+(XALB+XABSC)*SDOWN(K)*0.01
         DSCA=DSCA+XSCA*SDOWN(K)
         DABS=DABS+XABS*SDOWN(K)
         DABSA=DABSA+XABSA*SDOWN(K)
         OLDALB=ALBA
         OLDABC=ABSC
!     LAYER TRANSMISSIVITY
         TRANS0=100.-XALB-XABSC-XABS*100.-XSCA*100.
         IF(TRANS0.LT.1.)THEN
           FF=99./(XALB+XABSC+XABS*100.+XSCA*100.)
           XALB=XALB*FF
           XABSC=XABSC*FF
           XABS=XABS*FF
           XSCA=XSCA*FF
           TRANS0=1.
         ENDIF
         SDOWN(K+1)=AMAX1(1.E-9,SDOWN(K)*TRANS0*0.01)
         TTEN(K)=SDOWN(K)*(XABSC+XABS*100.+XABSA*100.)*0.01/( &
                 RO(K)*CP*DZ(K))
  200   CONTINUE
!
        GSW=(1.-ALBEDO)*SDOWN(kte+1)

    7 CONTINUE
!
   END SUBROUTINE SWPARA

!====================================================================
!! SUBROUTINE swinit(RTHRATEN,RTHRATENSW,swrad_scat,restart,        &
   SUBROUTINE swinit(swrad_scat,restart,                            &
                     allowed_to_read ,                              &
                     ids, ide, jds, jde, kds, kde,                  &
                     ims, ime, jms, jme, kms, kme,                  &
                     its, ite, jts, jte, kts, kte                   )
!--------------------------------------------------------------------
   IMPLICIT NONE
!--------------------------------------------------------------------
   LOGICAL , INTENT(IN)           :: restart
   LOGICAL , INTENT(IN)           :: allowed_to_read 
   INTEGER , INTENT(IN)           :: ids, ide, jds, jde, kds, kde,  &
                                     ims, ime, jms, jme, kms, kme,  &
                                     its, ite, jts, jte, kts, kte

!  REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) ::        &
!                                                         RTHRATEN, &
!                                                       RTHRATENSW
   REAL , INTENT(IN)              :: swrad_scat
   INTEGER :: i, j, k, itf, jtf, ktf

   jtf=min0(jte,jde-1)
   ktf=min0(kte,kde-1)
   itf=min0(ite,ide-1)

!     CSSCA - CLEAR-SKY SCATTERING SET FROM NAMELIST SWRAD_SCAT
   cssca = swrad_scat * 1.e-5

   IF(.not.restart)THEN
!    DO j=jts,jtf
!    DO k=kts,ktf
!    DO i=its,itf
!       RTHRATEN(i,k,j)=0.
!       RTHRATENSW(i,k,j)=0.
!    ENDDO
!    ENDDO
!    ENDDO
   ENDIF

   END SUBROUTINE swinit
!-----------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!*******************  THE GODDARD SHORTWAVE PACKAGE ********************
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!-----------------------------------------------------------------------
!!Comment the following out to turn off aerosol-radiation
!!feedback between MOSAIC and GSFCSW. wig, 21-Feb-2005
!#ifdef WRF_CHEM
!#define AER_RA_FEEDBACK   
!#endif
!------------------------------------------------------------------
   SUBROUTINE GSFCSWRAD(rthraten,gsw,xlat,xlong                   &
                   ,dz8w,rho_phy                                  &
                   ,alb,t3d,qv3d,qc3d,qr3d                        &
                   ,qi3d,qs3d,qg3d                                &
                   ,p3d,p8w3d,pi3d,cldfra3d                       &
                   ,gmt,cp,g,julday,xtime,declin,solcon           &
                   ,radfrq,degrad,taucldi,taucldc,warm_rain       &
                   ,tauaer300,tauaer400,tauaer600,tauaer999       & ! jcb
                   ,gaer300,gaer400,gaer600,gaer999               & ! jcb
                   ,waer300,waer400,waer600,waer999               & ! jcb
                   ,f_qv,f_qc,f_qr,f_qi,f_qs,f_qg                 &
                   ,ids,ide, jds,jde, kds,kde                     & 
                   ,ims,ime, jms,jme, kms,kme                     &
                   ,its,ite, jts,jte, kts,kte                     ) 
!------------------------------------------------------------------
   IMPLICIT NONE
!------------------------------------------------------------------
   INTEGER,    PARAMETER     ::        np    = 75

   INTEGER,    INTENT(IN   ) ::        ids,ide, jds,jde, kds,kde, &
                                       ims,ime, jms,jme, kms,kme, &
                                       its,ite, jts,jte, kts,kte
   LOGICAL,    INTENT(IN   ) ::        warm_rain

   INTEGER,    INTENT(IN  )  ::                           JULDAY  


   REAL, INTENT(IN    )      ::        RADFRQ,DEGRAD,             &
                                       XTIME,DECLIN,SOLCON
!
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                  &
         INTENT(IN    ) ::                                   P3D, &
                                                           P8W3D, &
                                                            pi3D, &
                                                             T3D, &
                                                            dz8w, &
                                                         rho_phy, &
                                                        CLDFRA3D


   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                  &
         INTENT(INOUT)  ::                              RTHRATEN
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                  &
         INTENT(INOUT)  ::                               taucldi, &
                                                         taucldc
!
   REAL, DIMENSION( ims:ime, jms:jme ),                           &
         INTENT(IN   )  ::                                  XLAT, &
                                                           XLONG, &
                                                             ALB
!
   REAL, DIMENSION( ims:ime, jms:jme ),                           &
         INTENT(INOUT)  ::                                   GSW
!
   REAL, INTENT(IN   )  ::                              GMT,CP,G
!

!
! Optional
!
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), OPTIONAL ,       &
         INTENT(IN    ) :: tauaer300,tauaer400,tauaer600,tauaer999, & ! jcb
                                 gaer300,gaer400,gaer600,gaer999, & ! jcb
                                 waer300,waer400,waer600,waer999    ! jcb

   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                  &
         OPTIONAL,                                                &           
         INTENT(IN    ) ::                                        &
                                                            QV3D, &
                                                            QC3D, &
                                                            QR3D, &
                                                            QI3D, &
                                                            QS3D, &
                                                            QG3D

   LOGICAL, OPTIONAL, INTENT(IN )      ::        F_QV,F_QC,F_QR,F_QI,F_QS,F_QG

! LOCAL VARS
 
   REAL, DIMENSION( its:ite ) ::                                  &
                                                              ts, &
                                                            cosz, &
                                                          rsuvbm, &
                                                          rsuvdf, &
                                                          rsirbm, &
                                                          rsirdf, &
                                                            p400, &
                                                            p700

   INTEGER, DIMENSION( its:ite ) ::                               &
                                                             ict, &
                                                             icb   

   REAL, DIMENSION( its:ite, kts-1:kte, 2 ) ::            taucld

   REAL, DIMENSION( its:ite, kts-1:kte+1 )  ::               flx, &
                                                            flxd
!
   REAL, DIMENSION( its:ite, kts-1:kte ) ::                     O3
!
   REAL, DIMENSION( its:ite, kts-1:kte, 11 ) ::                   &
                                                           taual, &
                                                           ssaal, &
                                                           asyal

   REAL, DIMENSION( its:ite, kts-1:kte, 2 ) ::                    &
                                                            reff, &    
                                                             cwc    
   REAL, DIMENSION( its: ite, kts-1:kte+1 ) ::                    &
                                                           P8W2D
   REAL, DIMENSION( its: ite, kts-1:kte ) ::                      &
                                                          TTEN2D, &
                                                            SH2D, &
                                                             P2D, &
                                                             T2D, &
                                                          fcld2D
   real, DIMENSION( its:ite , kts:kte+1 ) :: phyd
   real, DIMENSION( its:ite , kts:kte   ) :: phydmid

   REAL, DIMENSION( np, 5 ) ::                              pres, &
                                                           ozone
   REAL, DIMENSION( np )    ::                                 p

   LOGICAL :: cldwater,overcast, predicate
!
   INTEGER :: i,j,K,NK,ib,kk,mix,mkx

!  iprof = 1  :  mid-latitude summer profile
!        = 2  :  mid-latitude winter profile
!        = 3  :  sub-arctic   summer profile
!        = 4  :  sub-arctic   winter profile
!        = 5  :  tropical profile
!

   INTEGER  ::                                             iprof, &
                                                       is_summer, &
                                                       ie_summer, &
                                                          lattmp


!
   REAL    :: XLAT0,XLONG0
   REAL    :: fac,latrmp
   REAL    :: xt24,tloctm,hrang,xxlat
   real, dimension(11) :: midbands  ! jcb
   data midbands/.2,.235,.27,.2875,.3025,.305,.3625,.55,1.92,1.745,6.135/   ! jcb
   real :: ang,slope ! jcb
   character(len=200) :: msg !wig
!
!--------------------------------------------------------------------------------
!   data set 1
!     mid-latitude summer (75 levels) :  p(mb)  o3(g/g)
!     surface temp = 294.0
!
      data (pres(i,1),i=1,np)/ &
          0.0006244,   0.0008759,   0.0012286,   0.0017234,   0.0024174, &
          0.0033909,   0.0047565,   0.0066720,   0.0093589,   0.0131278, &
          0.0184145,   0.0258302,   0.0362323,   0.0508234,   0.0712906, &
          0.1000000,   0.1402710,   0.1967600,   0.2759970,   0.3871430, &
          0.5430,    0.7617,    1.0685,    1.4988,    2.1024,    2.9490, &
          4.1366,    5.8025,    8.1392,   11.4170,   16.0147,   22.4640, &
         31.5105,   44.2001,   62.0000,   85.7750,  109.5500,  133.3250, &
        157.1000,  180.8750,  204.6500,  228.4250,  252.2000,  275.9750, &
        299.7500,  323.5250,  347.3000,  371.0750,  394.8500,  418.6250, &
        442.4000,  466.1750,  489.9500,  513.7250,  537.5000,  561.2750, &
        585.0500,  608.8250,  632.6000,  656.3750,  680.1500,  703.9250, &
        727.7000,  751.4750,  775.2500,  799.0250,  822.8000,  846.5750, &
        870.3500,  894.1250,  917.9000,  941.6750,  965.4500,  989.2250, &
       1013.0000/
!
      data (ozone(i,1),i=1,np)/ &
        0.1793E-06,  0.2228E-06,  0.2665E-06,  0.3104E-06,  0.3545E-06, &
        0.3989E-06,  0.4435E-06,  0.4883E-06,  0.5333E-06,  0.5786E-06, &
        0.6241E-06,  0.6698E-06,  0.7157E-06,  0.7622E-06,  0.8557E-06, &
        0.1150E-05,  0.1462E-05,  0.1793E-05,  0.2143E-05,  0.2512E-05, &
        0.2902E-05,  0.3313E-05,  0.4016E-05,  0.5193E-05,  0.6698E-05, &
        0.8483E-05,  0.9378E-05,  0.9792E-05,  0.1002E-04,  0.1014E-04, &
        0.9312E-05,  0.7834E-05,  0.6448E-05,  0.5159E-05,  0.3390E-05, &
        0.1937E-05,  0.1205E-05,  0.8778E-06,  0.6935E-06,  0.5112E-06, &
        0.3877E-06,  0.3262E-06,  0.2770E-06,  0.2266E-06,  0.2020E-06, &
        0.1845E-06,  0.1679E-06,  0.1519E-06,  0.1415E-06,  0.1317E-06, &
        0.1225E-06,  0.1137E-06,  0.1055E-06,  0.1001E-06,  0.9487E-07, &
        0.9016E-07,  0.8641E-07,  0.8276E-07,  0.7930E-07,  0.7635E-07, &
        0.7347E-07,  0.7065E-07,  0.6821E-07,  0.6593E-07,  0.6368E-07, &
        0.6148E-07,  0.5998E-07,  0.5859E-07,  0.5720E-07,  0.5582E-07, &
        0.5457E-07,  0.5339E-07,  0.5224E-07,  0.5110E-07,  0.4999E-07/

!--------------------------------------------------------------------------------
!   data set 2
!   mid-latitude winter (75 levels) :  p(mb)  o3(g/g)
!   surface temp = 272.2
!
      data (pres(i,2),i=1,np)/ &
          0.0006244,   0.0008759,   0.0012286,   0.0017234,   0.0024174, &
          0.0033909,   0.0047565,   0.0066720,   0.0093589,   0.0131278, &
          0.0184145,   0.0258302,   0.0362323,   0.0508234,   0.0712906, &
          0.1000000,   0.1402710,   0.1967600,   0.2759970,   0.3871430, &
          0.5430,    0.7617,    1.0685,    1.4988,    2.1024,    2.9490, &
          4.1366,    5.8025,    8.1392,   11.4170,   16.0147,   22.4640, &
         31.5105,   44.2001,   62.0000,   85.9000,  109.8000,  133.7000, &
        157.6000,  181.5000,  205.4000,  229.3000,  253.2000,  277.1000, &
        301.0000,  324.9000,  348.8000,  372.7000,  396.6000,  420.5000, &
        444.4000,  468.3000,  492.2000,  516.1000,  540.0000,  563.9000, &
        587.8000,  611.7000,  635.6000,  659.5000,  683.4000,  707.3000, &
        731.2000,  755.1000,  779.0000,  802.9000,  826.8000,  850.7000, &
        874.6000,  898.5000,  922.4000,  946.3000,  970.2000,  994.1000, &
       1018.0000/
!
      data (ozone(i,2),i=1,np)/ &
        0.2353E-06,  0.3054E-06,  0.3771E-06,  0.4498E-06,  0.5236E-06, &
        0.5984E-06,  0.6742E-06,  0.7511E-06,  0.8290E-06,  0.9080E-06, &
        0.9881E-06,  0.1069E-05,  0.1152E-05,  0.1319E-05,  0.1725E-05, &
        0.2145E-05,  0.2581E-05,  0.3031E-05,  0.3497E-05,  0.3980E-05, &
        0.4478E-05,  0.5300E-05,  0.6725E-05,  0.8415E-05,  0.1035E-04, &
        0.1141E-04,  0.1155E-04,  0.1143E-04,  0.1093E-04,  0.1060E-04, &
        0.9720E-05,  0.8849E-05,  0.7424E-05,  0.6023E-05,  0.4310E-05, &
        0.2820E-05,  0.1990E-05,  0.1518E-05,  0.1206E-05,  0.9370E-06, &
        0.7177E-06,  0.5450E-06,  0.4131E-06,  0.3277E-06,  0.2563E-06, &
        0.2120E-06,  0.1711E-06,  0.1524E-06,  0.1344E-06,  0.1199E-06, &
        0.1066E-06,  0.9516E-07,  0.8858E-07,  0.8219E-07,  0.7598E-07, &
        0.6992E-07,  0.6403E-07,  0.5887E-07,  0.5712E-07,  0.5540E-07, &
        0.5370E-07,  0.5214E-07,  0.5069E-07,  0.4926E-07,  0.4785E-07, &
        0.4713E-07,  0.4694E-07,  0.4676E-07,  0.4658E-07,  0.4641E-07, &
        0.4634E-07,  0.4627E-07,  0.4619E-07,  0.4612E-07,  0.4605E-07/


!--------------------------------------------------------------------------------
!   data set 3
!   sub-arctic summer (75 levels) :  p(mb)  o3(g/g)
!   surface temp = 287.0
!
      data (pres(i,3),i=1,np)/ &
          0.0006244,   0.0008759,   0.0012286,   0.0017234,   0.0024174, &
          0.0033909,   0.0047565,   0.0066720,   0.0093589,   0.0131278, &
          0.0184145,   0.0258302,   0.0362323,   0.0508234,   0.0712906, &
          0.1000000,   0.1402710,   0.1967600,   0.2759970,   0.3871430, &
          0.5430,    0.7617,    1.0685,    1.4988,    2.1024,    2.9490, &
          4.1366,    5.8025,    8.1392,   11.4170,   16.0147,   22.4640, &
         31.5105,   44.2001,   62.0000,   85.7000,  109.4000,  133.1000, &
        156.8000,  180.5000,  204.2000,  227.9000,  251.6000,  275.3000, &
        299.0000,  322.7000,  346.4000,  370.1000,  393.8000,  417.5000, &
        441.2000,  464.9000,  488.6000,  512.3000,  536.0000,  559.7000, &
        583.4000,  607.1000,  630.8000,  654.5000,  678.2000,  701.9000, &
        725.6000,  749.3000,  773.0000,  796.7000,  820.4000,  844.1000, &
        867.8000,  891.5000,  915.2000,  938.9000,  962.6000,  986.3000, &
       1010.0000/
!
      data (ozone(i,3),i=1,np)/ &
        0.1728E-06,  0.2131E-06,  0.2537E-06,  0.2944E-06,  0.3353E-06, &
        0.3764E-06,  0.4176E-06,  0.4590E-06,  0.5006E-06,  0.5423E-06, &
        0.5842E-06,  0.6263E-06,  0.6685E-06,  0.7112E-06,  0.7631E-06, &
        0.1040E-05,  0.1340E-05,  0.1660E-05,  0.2001E-05,  0.2362E-05, &
        0.2746E-05,  0.3153E-05,  0.3762E-05,  0.4988E-05,  0.6518E-05, &
        0.8352E-05,  0.9328E-05,  0.9731E-05,  0.8985E-05,  0.7632E-05, &
        0.6814E-05,  0.6384E-05,  0.5718E-05,  0.4728E-05,  0.4136E-05, &
        0.3033E-05,  0.2000E-05,  0.1486E-05,  0.1121E-05,  0.8680E-06, &
        0.6474E-06,  0.5164E-06,  0.3921E-06,  0.2996E-06,  0.2562E-06, &
        0.2139E-06,  0.1723E-06,  0.1460E-06,  0.1360E-06,  0.1267E-06, &
        0.1189E-06,  0.1114E-06,  0.1040E-06,  0.9678E-07,  0.8969E-07, &
        0.8468E-07,  0.8025E-07,  0.7590E-07,  0.7250E-07,  0.6969E-07, &
        0.6694E-07,  0.6429E-07,  0.6208E-07,  0.5991E-07,  0.5778E-07, &
        0.5575E-07,  0.5403E-07,  0.5233E-07,  0.5067E-07,  0.4904E-07, &
        0.4721E-07,  0.4535E-07,  0.4353E-07,  0.4173E-07,  0.3997E-07/


!--------------------------------------------------------------------------------
!   data set 3
!   sub-arctic winter (75 levels) :   p(mb)  o3(g/g)
!   surface temp = 257.1
!
      data (pres(i,4),i=1,np)/ &
          0.0006244,   0.0008759,   0.0012286,   0.0017234,   0.0024174, &
          0.0033909,   0.0047565,   0.0066720,   0.0093589,   0.0131278, &
          0.0184145,   0.0258302,   0.0362323,   0.0508234,   0.0712906, &
          0.1000000,   0.1402710,   0.1967600,   0.2759970,   0.3871430, &
          0.5430,    0.7617,    1.0685,    1.4988,    2.1024,    2.9490, &
          4.1366,    5.8025,    8.1392,   11.4170,   16.0147,   22.4640, &
         31.5105,   44.2001,   62.0000,   85.7750,  109.5500,  133.3250, &
        157.1000,  180.8750,  204.6500,  228.4250,  252.2000,  275.9750, &
        299.7500,  323.5250,  347.3000,  371.0750,  394.8500,  418.6250, &
        442.4000,  466.1750,  489.9500,  513.7250,  537.5000,  561.2750, &
        585.0500,  608.8250,  632.6000,  656.3750,  680.1500,  703.9250, &
        727.7000,  751.4750,  775.2500,  799.0250,  822.8000,  846.5750, &
        870.3500,  894.1250,  917.9000,  941.6750,  965.4500,  989.2250, &
       1013.0000/
!
      data (ozone(i,4),i=1,np)/ &
        0.2683E-06,  0.3562E-06,  0.4464E-06,  0.5387E-06,  0.6333E-06, &
        0.7301E-06,  0.8291E-06,  0.9306E-06,  0.1034E-05,  0.1140E-05, &
        0.1249E-05,  0.1360E-05,  0.1474E-05,  0.1855E-05,  0.2357E-05, &
        0.2866E-05,  0.3383E-05,  0.3906E-05,  0.4437E-05,  0.4975E-05, &
        0.5513E-05,  0.6815E-05,  0.8157E-05,  0.1008E-04,  0.1200E-04, &
        0.1242E-04,  0.1250E-04,  0.1157E-04,  0.1010E-04,  0.9063E-05, &
        0.8836E-05,  0.8632E-05,  0.8391E-05,  0.7224E-05,  0.6054E-05, &
        0.4503E-05,  0.3204E-05,  0.2278E-05,  0.1833E-05,  0.1433E-05, &
        0.9996E-06,  0.7440E-06,  0.5471E-06,  0.3944E-06,  0.2852E-06, &
        0.1977E-06,  0.1559E-06,  0.1333E-06,  0.1126E-06,  0.9441E-07, &
        0.7678E-07,  0.7054E-07,  0.6684E-07,  0.6323E-07,  0.6028E-07, &
        0.5746E-07,  0.5468E-07,  0.5227E-07,  0.5006E-07,  0.4789E-07, &
        0.4576E-07,  0.4402E-07,  0.4230E-07,  0.4062E-07,  0.3897E-07, &
        0.3793E-07,  0.3697E-07,  0.3602E-07,  0.3506E-07,  0.3413E-07, &
        0.3326E-07,  0.3239E-07,  0.3153E-07,  0.3069E-07,  0.2987E-07/ 

!--------------------------------------------------------------------------------
!   data set 4
!   tropical (75 levels) :   p(mb)  o3(g/g)
!   surface temp = 300.0
!
      data (pres(i,5),i=1,np)/ &
          0.0006244,   0.0008759,   0.0012286,   0.0017234,   0.0024174, &
          0.0033909,   0.0047565,   0.0066720,   0.0093589,   0.0131278, &
          0.0184145,   0.0258302,   0.0362323,   0.0508234,   0.0712906, &
          0.1000000,   0.1402710,   0.1967600,   0.2759970,   0.3871430, &
          0.5430,    0.7617,    1.0685,    1.4988,    2.1024,    2.9490, &
          4.1366,    5.8025,    8.1392,   11.4170,   16.0147,   22.4640, &
         31.5105,   44.2001,   62.0000,   85.7750,  109.5500,  133.3250, &
        157.1000,  180.8750,  204.6500,  228.4250,  252.2000,  275.9750, &
        299.7500,  323.5250,  347.3000,  371.0750,  394.8500,  418.6250, &
        442.4000,  466.1750,  489.9500,  513.7250,  537.5000,  561.2750, &
        585.0500,  608.8250,  632.6000,  656.3750,  680.1500,  703.9250, &
        727.7000,  751.4750,  775.2500,  799.0250,  822.8000,  846.5750, &
        870.3500,  894.1250,  917.9000,  941.6750,  965.4500,  989.2250, &
       1013.0000/
!
      data (ozone(i,5),i=1,np)/ &
        0.1993E-06,  0.2521E-06,  0.3051E-06,  0.3585E-06,  0.4121E-06, &
        0.4661E-06,  0.5203E-06,  0.5748E-06,  0.6296E-06,  0.6847E-06, &
        0.7402E-06,  0.7959E-06,  0.8519E-06,  0.9096E-06,  0.1125E-05, &
        0.1450E-05,  0.1794E-05,  0.2156E-05,  0.2538E-05,  0.2939E-05, &
        0.3362E-05,  0.3785E-05,  0.4753E-05,  0.6005E-05,  0.7804E-05, &
        0.9635E-05,  0.1023E-04,  0.1067E-04,  0.1177E-04,  0.1290E-04, &
        0.1134E-04,  0.9223E-05,  0.6667E-05,  0.3644E-05,  0.1545E-05, &
        0.5355E-06,  0.2523E-06,  0.2062E-06,  0.1734E-06,  0.1548E-06, &
        0.1360E-06,  0.1204E-06,  0.1074E-06,  0.9707E-07,  0.8960E-07, &
        0.8419E-07,  0.7962E-07,  0.7542E-07,  0.7290E-07,  0.7109E-07, &
        0.6940E-07,  0.6786E-07,  0.6635E-07,  0.6500E-07,  0.6370E-07, &
        0.6244E-07,  0.6132E-07,  0.6022E-07,  0.5914E-07,  0.5884E-07, &
        0.5855E-07,  0.5823E-07,  0.5772E-07,  0.5703E-07,  0.5635E-07, &
        0.5570E-07,  0.5492E-07,  0.5412E-07,  0.5335E-07,  0.5260E-07, &
        0.5167E-07,  0.5063E-07,  0.4961E-07,  0.4860E-07,  0.4761E-07/

!--------------------------------------------------------------------------------

#ifdef AER_RA_FEEDBACK   
   IF ( .NOT. &
      ( PRESENT(tauaer300) .AND. &
        PRESENT(tauaer400) .AND. &
        PRESENT(tauaer600) .AND. &
        PRESENT(tauaer999) .AND. &
        PRESENT(gaer300) .AND. &
        PRESENT(gaer400) .AND. &
        PRESENT(gaer600) .AND. &
        PRESENT(gaer999) .AND. &
        PRESENT(waer300) .AND. &
        PRESENT(waer400) .AND. &
        PRESENT(waer600) .AND. &
        PRESENT(waer999) ) ) THEN
        WRITE(0,*)' Warning: missing fields required for aerosol radiation'
!!!     CALL ESMF_Finalize(terminationflag=ESMF_ABORT)
        CALL NMMB_FINALIZE
   ENDIF
#endif
   cldwater = .true.
   overcast = .false.

   mix=ite-its+1 
   mkx=kte-kts+1 

   is_summer=80
   ie_summer=265

! testing, need to change iprof, which is function of lat and julian day
!  iprof = 1  :  mid-latitude summer profile
!        = 2  :  mid-latitude winter profile
!        = 3  :  sub-arctic   summer profile
!        = 4  :  sub-arctic   winter profile
!        = 5  :  tropical profile

   IF (abs(center_lat) .le. 30. ) THEN ! tropic
      iprof = 5
   ELSE
      IF (center_lat .gt.  0.) THEN
         IF (center_lat .gt. 60. ) THEN !  arctic
            IF (JULDAY .gt. is_summer .and. JULDAY .lt. ie_summer ) THEN
               ! arctic summer
               iprof = 3
            ELSE
               ! arctic winter
               iprof = 4
            ENDIF
         ELSE        ! midlatitude
            IF (JULDAY .gt. is_summer .and. JULDAY .lt. ie_summer ) THEN
               ! north midlatitude summer
               iprof = 1
            ELSE
               ! north midlatitude winter
               iprof = 2
            ENDIF
         ENDIF

      ELSE
         IF (center_lat .lt. -60. ) THEN !  antarctic
            IF (JULDAY .lt. is_summer .or. JULDAY .gt. ie_summer ) THEN
               ! antarctic summer
               iprof = 3
            ELSE
               ! antarctic winter
               iprof = 4
            ENDIF
         ELSE        ! midlatitude
            IF (JULDAY .lt. is_summer .or. JULDAY .gt. ie_summer ) THEN
               ! south midlatitude summer
               iprof = 1
            ELSE
               ! south midlatitude winter
               iprof = 2
            ENDIF
         ENDIF

      ENDIF
   ENDIF


   j_loop: DO J=jts,jte

      DO K=kts,kte          
      DO I=its,ite          
         cwc(i,k,1) = 0.
         cwc(i,k,2) = 0.
      ENDDO
      ENDDO

      DO K=1,np
         p(k)=pres(k,iprof)
      ENDDO

      do k = kts,kte+1
      do i = its,ite
      if(k.eq.kts)then
        phyd(i,k)=p8w3d(i,kts,j)
      else
        phyd(i,k)=phyd(i,k-1) - g*rho_phy(i,k-1,j)*dz8w(i,k-1,j)
        phydmid(i,k-1)=0.5*(phyd(i,k-1)+phyd(i,k))
      endif
      enddo
      enddo

! reverse vars 
!
      DO K=kts,kte+1
      DO I=its,ite
         NK=kme-K+kms
         P8W2D(I,K)=phyd(I,NK)*0.01   ! P8w2D is in mb
      ENDDO
      ENDDO

      DO I=its,ite
         P8W2D(I,0)=.0
      ENDDO
!
      DO K=kts,kte
      DO I=its,ite
         NK=kme-1-K+kms
         TTEN2D(I,K)=0.
         T2D(I,K)=T3D(I,NK,J)

! SH2D specific humidity
         SH2D(I,K)=QV3D(I,NK,J)/(1.+QV3D(I,NK,J))
         SH2D(I,K)=max(0.,SH2D(I,K))
         cwc(I,K,2)=QC3D(I,NK,J)
         cwc(I,K,2)=max(0.,cwc(I,K,2))

         P2D(I,K)=phydmid(I,NK)*0.01      ! P2D is in mb
         fcld2D(I,K)=CLDFRA3D(I,NK,J)
      ENDDO
      ENDDO

! This logic is tortured because cannot test F_QI unless
! it is present, and order of evaluation of expressions
! is not specified in Fortran

      IF ( PRESENT ( F_QI ) ) THEN
	predicate = F_QI
      ELSE
        predicate = .FALSE.
      ENDIF

      IF (.NOT. warm_rain .AND. .NOT. predicate ) THEN
         DO K=kts,kte
         DO I=its,ite
            IF (T2D(I,K) .lt. 273.15) THEN
               cwc(I,K,1)=cwc(I,K,2)
               cwc(I,K,2)=0.
            ENDIF
         ENDDO
         ENDDO
      ENDIF

      DO I=its,ite
         TTEN2D(I,0)=0.
         T2D(I,0)=T2D(I,1)
! SH2D specific humidity
         SH2D(I,0)=0.5*SH2D(i,1)
         cwc(I,0,2)=0.
         cwc(I,0,1)=0.
         P2D(I,0)=0.5*(P8W2D(I,0)+P8W2D(I,1))
         fcld2D(I,0)=0.
      ENDDO
!
      IF ( PRESENT( F_QI ) .AND. PRESENT( qi3d)  ) THEN
	 IF ( (F_QI) ) THEN
            DO K=kts,kte          
            DO I=its,ite          
               NK=kme-1-K+kms
               cwc(I,K,1)=QI3D(I,NK,J)
               cwc(I,K,1)=max(0.,cwc(I,K,1))
            ENDDO
            ENDDO
         ENDIF
      ENDIF
!
! ... Vertical profiles for ozone
!
      call o3prof (np, p, ozone(1,iprof), its, ite, kts-1, kte, P2D, O3)

! ... Vertical profiles for effective particle size
!
      do k = kts-1, kte
      do i = its, ite
         reff(i,k,2) = 10.
         reff(i,k,1) = 80.
      end do
      end do
!
! ... Level indices separating high, middle and low clouds
!
      do i = its, ite
         p400(i) = 1.e5
         p700(i) = 1.e5
      enddo

      do k = kts-1,kte+1
         do i = its, ite
            if (abs(P8W2D(i,k) - 400.) .lt. p400(i)) then
               p400(i) = abs(P8W2D(i,k) - 400.)
               ict(i) = k
            endif
            if (abs(P8W2D(i,k) - 700.) .lt. p700(i)) then
               p700(i) = abs(P8W2D(i,k) - 700.)
               icb(i) = k
            endif
        end do
      end do

!wig beg
! ... Aerosol effects. Added aerosol feedbacks with MOSAIC, Dec. 2005.
!
      do ib = 1, 11
      do k = kts-1,kte
      do i = its,ite
         taual(i,k,ib) = 0.
         ssaal(i,k,ib) = 0.
         asyal(i,k,ib) = 0.
      end do
      end do
      end do

#ifdef AER_RA_FEEDBACK
!wig end
      do ib = 1, 11
      do k = kts-1,kte-1      !wig
      do i = its,ite

!        taual(i,kte-k,ib) = 0.
!        ssaal(i,kte-k,ib) = 0.
!        asyal(i,kte-k,ib) = 0.

!jcb beg
! convert optical properties at 300,400,600, and 999 to conform to the band wavelengths
! these are: 200,235,270,287.5,302.5,305,362.5,550,1920,1745,6135; why the emphasis on the UV?
! taual - use angstrom exponent
        if(tauaer300(i,k+1,j).gt.thresh .and. tauaer999(i,k+1,j).gt.thresh) then
           ang=log(tauaer300(i,k+1,j)/tauaer999(i,k+1,j))/log(999./300.)
!       write(6,*)i,k,ang,tauaer300(i,k+1,j),tauaer999(i,k+1,j)
           taual(i,kte-k,ib)=tauaer400(i,k+1,j)*(0.4/midbands(ib))**ang ! notice reserved variable
!       write(6,10001)i,k,ang,tauaer300(i,k+1,j),tauaer999(i,k+1,j),midbands(ib),taual(i,k,ib)
!10001      format(i3,i3,5f12.6)

! ssa - linear interpolation; extrapolation
           slope=(waer600(i,k+1,j)-waer400(i,k+1,j))/.2
           ssaal(i,kte-k,ib) = slope*(midbands(ib)-.6)+waer600(i,k+1,j) ! notice reversed variables
           if(ssaal(i,kte-k,ib).lt.0.4) ssaal(i,kte-k,ib)=0.4
           if(ssaal(i,kte-k,ib).ge.0.9) ssaal(i,kte-k,ib)=0.9

! g - linear interpolation;extrapolation
           slope=(gaer600(i,k+1,j)-gaer400(i,k+1,j))/.2
           asyal(i,kte-k,ib) = slope*(midbands(ib)-.6)+gaer600(i,k+1,j) ! notice reversed varaibles
           if(asyal(i,kte-k,ib).lt.0.5) asyal(i,kte-k,ib)=0.5
           if(asyal(i,kte-k,ib).ge.1.0) asyal(i,kte-k,ib)=1.0
        endif
!jcb end
      end do
      end do
      end do

!wig beg
      do ib = 1, 11
      do i = its,ite
         slope = 0.  !use slope as a sum holder
         do k = kts-1,kte
            slope = slope + taual(i,k,ib)
         end do
         if( slope < 0. ) then
            WRITE(0,*)' ERROR: Negative total optical depth of ',slope,' at point i,j,ib=',i,j,ib
!!!         CALL ESMF_Finalize(terminationflag=ESMF_ABORT)
            CALL NMMB_FINALIZE

         else if( slope > 5. ) then
            WRITE(0,*)' -------------------------'
            WRITE(0,*)' WARNING: Large total optical depth of ',slope,' at point i,j,ib=',i,j,ib
            WRITE(0,*)' Diagnostics 1: k, tauaer300, tauaer400, tauaer600, tauaer999'

            do k=kts,kte
               WRITE(0,*)k, tauaer300(i,k,ib), tauaer400(i,k,ib),tauaer600(i,k,ib), tauaer999(i,k,ib)
            end do

            WRITE(0,*)'Diagnostics 2: k, gaer300, gaer400, gaer600, gaer999'
            do k=kts,kte
               WRITE(0,*)k, gaer300(i,k,ib), gaer400(i,k,ib),gaer600(i,k,ib), gaer999(i,k,ib)
            end do

            WRITE(0,*)'Diagnostics 3: k, waer300, waer400, waer600, waer999'
            do k=kts,kte
               WRITE(0,*)k, waer300(i,k,ib), waer400(i,k,ib),waer600(i,k,ib), waer999(i,k,ib)
            end do

            WRITE(0,*)'Diagnostics 4: k, ssaal, asyal, taual'
            do k=kts-1,kte
               WRITE(0,*)k, ssaal(i,k,ib), asyal(i,k,ib), taual(i,k,ib)
            end do
            WRITE(0,*)'-------------------------'
         end if
      end do
      end do
!wig end
#endif
!
! ... Initialize output arrays
!
      do ib = 1, 2
      do k = kts-1, kte
      do i = its, ite
         taucld(i,k,ib) = 0.
      end do
      end do
      end do
!
      do k = kts-1,kte+1
      do i = its,ite
         flx(i,k)   = 0.
         flxd(i,k)  = 0.
      end do
      end do
!
! ... Solar zenith angle
!
      do i = its,ite
        xt24 = amod(xtime + radfrq * 0.5, 1440.)
        tloctm = GMT + xt24 / 60. + XLONG(i,j) / 15.
        hrang = 15. * (tloctm - 12.) * degrad
        xxlat = XLAT(i,j) * degrad
        cosz(i) = sin(xxlat) * sin(declin) + &
                  cos(xxlat) * cos(declin) * cos(hrang)

	if (I .eq. its+1) then
	write(0,*) 'I,J, GMT, xtime, xxlat: ', I,J,GMT,XTIME,XXLAT
	write(0,*) 'cosz(i): ', cosz(i)
	endif

        rsuvbm(i) = ALB(i,j)
        rsuvdf(i) = ALB(i,j)
        rsirbm(i) = ALB(i,j)
        rsirdf(i) = ALB(i,j)
      end do
                                  
      call sorad (mix,1,1,mkx+1,p8w2D,t2D,sh2D,o3,                 &
                  overcast,cldwater,cwc,taucld,reff,fcld2D,ict,icb,&
                  taual,ssaal,asyal,                               &
                  cosz,rsuvbm,rsuvdf,rsirbm,rsirdf,                &
                  flx,flxd)
!
! ... Convert the units of flx and flc from fraction to w/m^2
!
      do k = kts, kte
      do i = its, ite
         nk=kme-1-k+kms
         taucldc(i,nk,j)=taucld(i,k,2)
         taucldi(i,nk,j)=taucld(i,k,1)
      enddo
      enddo
 
      do k = kts, kte+1
        do i = its, ite
          if (cosz(i) .lt. thresh) then
            flx(i,k) = 0.
          else
            flx(i,k) = flx(i,k) * SOLCON * cosz(i)
          endif
        end do
      end do
!
! ... Calculate heating rate (deg/sec)
!
      fac = .01 * g / Cp
      do k = kts, kte
      do i = its, ite
         if (cosz(i) .gt. thresh) then
             TTEN2D(i,k) = - fac * (flx(i,k) - flx(i,k+1))/ &
                           (p8w2d(i,k)-p8w2d(i,k+1))
         endif
      end do
      end do

!
! ... Absorbed part in surface energy budget
!
      do i = its, ite
        if (cosz(i) .le. thresh) then
          GSW(i,j) = 0.
        else
          GSW(i,j) = (1. - rsuvbm(i)) * flxd(i,kte+1) * SOLCON * cosz(i)
        endif
	if (I .eq. its+1) then
	write(0,*) 'I,J,cosz, gsw: ',I,J, cosz(i),gsw(i,j)
	endif
      end do

      DO K=kts,kte          
         NK=kme-1-K+kms
         DO I=its,ite
            RTHRATEN(I,K,J)=RTHRATEN(I,K,J)+TTEN2D(I,NK)/pi3D(I,K,J)
         ENDDO
      ENDDO
!
   ENDDO j_loop                                          

   END SUBROUTINE GSFCSWRAD

!*********************   Version Solar-6 (May 8, 1997)  *****************

      subroutine sorad (m,n,ndim,np,pl,ta,wa,oa,                        &
                        overcast,cldwater,cwc,taucld,reff,fcld,ict,icb, &
                        taual,ssaal,asyal,                              &
                        cosz,rsuvbm,rsuvdf,rsirbm,rsirdf,               &
                        flx,flxd)

!************************************************************************
!
!                        Version Solar-6 (May 8, 1997)
!
!  New feature of this version is:
!   (1) An option is added for scaling the cloud optical thickness. If
!       the fractional cloud cover, fcld, in an atmospheric model is alway 
!       either 1 or 0 (i.e. partly cloudy sky is not allowed), it does
!       not require the scaling of cloud optical thickness, and the
!       option "overcast" can be set to .true.  Computation is faster
!       with this option than with overcast=.false.
!
!**********************************************************************
!
!                        Version Solar-5 (April 1997)
!
!  New features of this version are:
!   (1) Cloud optical properties can be computed from cloud water/ice
!       amount and the effective particle size.
!   (2) Aerosol optical properties are functions of height and band.
!   (3) A maximum-random cloud overlapping approximation is applied.
!
!*********************************************************************
!  
! This routine computes solar fluxes due to the absoption by water
!  vapor, ozone, co2, o2, clouds, and aerosols and due to the
!  scattering by clouds, aerosols, and gases.
!
! The solar spectrum is divided into one UV+visible band and three IR
!  bands separated by the wavelength 0.7 micron.  The UV+visible band
!  is further divided into eight sub-bands.
!
! This is a vectorized code. It computes fluxes simultaneously for
!  (m x n) soundings, which is a subset of (m x ndim) soundings.
!  In a global climate model, m and ndim correspond to the numbers of
!  grid boxes in the zonal and meridional directions, respectively.
!
! Ice and liquid cloud particles are allowed to co-exist in a layer. 
!
! There is an option of providing either cloud ice/water mixing ratio 
!  (cwc) or thickness (taucld).  If the former is provided, set
!  cldwater=.true., and taucld will be computed from cwc and reff as a
!  function of spectra band. Otherwise, set cldwater=.false., and
!  specify taucld, independent of spectral band.
!
! If no information is available for reff, a default value of
!  10 micron for liquid water and 75 micron for ice can be used.
!  For a clear layer, reff can be set to any values except zero.
!
! The maximum-random assumption is applied for treating cloud
!  overlapping.

! Clouds are grouped into high, middle, and low clouds separated by
!  the level indices ict and icb.  For detail, see subroutine cldscale.
!
! In a high spatial-resolution atmospheric model, fractional cloud cover
!  might be computed to be either 0 or 1.  In such a case, scaling of the
!  cloud optical thickness is not necessary, and the computation can be
!  made faster by setting overcast=.true.  The option overcast=.false.
!  can be applied to any values of the fractional cloud cover, but the
!  computation is slower.
!
! Aerosol optical thickness, single-scattering albaedo, and asymmtry
!  factor can be specified as functions of height and spectral band.
!
!----- Input parameters:                           
!                                                   units      size
!  number of soundings in zonal direction (m)       n/d        1
!  number of soundings in meridional direction (n)  n/d        1
!  maximum number of soundings in                   n/d        1
!         meridional direction (ndim>=n)
!  number of atmospheric layers (np)                n/d        1
!  level pressure (pl)                              mb     m*ndim*(np+1)
!  layer temperature (ta)                           k        m*ndim*np
!  layer specific humidity (wa)                     gm/gm    m*ndim*np
!  layer ozone concentration (oa)                   gm/gm    m*ndim*np
!  co2 mixing ratio by volumn (co2)                 pppv       1
!  option for scaling cloud optical thickness       n/d        1
!        overcast="true" if scaling is NOT required
!        overcast="fasle" if scaling is required
!  option for cloud optical thickness               n/d        1
!        cldwater="true" if cwc is provided
!        cldwater="false" if taucld is provided
!  cloud water mixing ratio (cwc)                  gm/gm     m*ndim*np*2
!        index 1 for ice particles
!        index 2 for liquid drops
!  cloud optical thickness (taucld)                 n/d      m*ndim*np*2
!        index 1 for ice particles
!        index 2 for liquid drops
!  effective cloud-particle size (reff)          micrometer m*ndim*np*2
!        index 1 for ice particles
!        index 2 for liquid drops
!  cloud amount (fcld)                            fraction   m*ndim*np
!  level index separating high and middle           n/d        1
!        clouds (ict)
!  level index separating middle and low            n/d        1
!          clouds (icb)
!  aerosol optical thickness (taual)                n/d    m*ndim*np*11
!  aerosol single-scattering albedo (ssaal)         n/d    m*ndim*np*11
!  aerosol asymmetry factor (asyal)                 n/d    m*ndim*np*11
!        in the uv region :
!           index  1 for the 0.175-0.225 micron band
!           index  2 for the 0.225-0.245; 0.260-0.280 micron band
!           index  3 for the 0.245-0.260 micron band
!           index  4 for the 0.280-0.295 micron band
!           index  5 for the 0.295-0.310 micron band
!           index  6 for the 0.310-0.320 micron band
!           index  7 for the 0.325-0.400 micron band
!        in the par region :
!           index  8 for the 0.400-0.700 micron band
!        in the infrared region :
!           index  9 for the 0.700-1.220 micron band
!           index 10 for the 1.220-2.270 micron band
!           index 11 for the 2.270-10.00 micron band
!   cosine of solar zenith angle (cosz)              n/d      m*ndim
!   uv+visible sfc albedo for beam radiation
!        for wavelengths<0.7 micron (rsuvbm)    fraction   m*ndim
!   uv+visible sfc albedo for diffuse radiation
!        for wavelengths<0.7 micron (rsuvdf)    fraction   m*ndim
!   ir sfc albedo for beam radiation
!        for wavelengths>0.7 micron  (rsirbm)   fraction   m*ndim
!   ir sfc albedo for diffuse radiation (rsirdf)   fraction   m*ndim
!
!----- Output parameters
!
!   all-sky flux (downward minus upward) (flx)    fraction m*ndim*(np+1)
!   clear-sky flux (downward minus upward) (flc)  fraction m*ndim*(np+1)
!   all-sky direct downward uv (0.175-0.4 micron)
!                flux at the surface (fdiruv)      fraction   m*ndim
!   all-sky diffuse downward uv flux at
!                the surface (fdifuv)              fraction   m*ndim
!   all-sky direct downward par (0.4-0.7 micron)
!                flux at the surface (fdirpar)     fraction   m*ndim
!   all-sky diffuse downward par flux at
!                the surface (fdifpar)             fraction   m*ndim
!   all-sky direct downward ir (0.7-10 micron)
!                flux at the surface (fdirir)      fraction   m*ndim
!   all-sky diffuse downward ir flux at
!                the surface (fdifir)              fraction   m*ndim
!
!----- Notes:
!
!    (1) The unit of "flux" is fraction of the incoming solar radiation
!        at the top of the atmosphere.  Therefore, fluxes should
!        be equal to "flux" multiplied by the extra-terrestrial solar
!        flux and the cosine of solar zenith angle.
!    (2) pl(i,j,1) is the pressure at the top of the model, and
!        pl(i,j,np+1) is the surface pressure.
!    (3) the pressure levels ict and icb correspond approximately
!        to 400 and 700 mb.
!    (4) if overcast='true', the clear-sky flux, flc, is not computed.
!        
!**************************************************************************
      implicit none
!**************************************************************************

!-----input parameters

      integer m,n,ndim,np
      integer ict(m,ndim),icb(m,ndim)
      real pl(m,ndim,np+1),ta(m,ndim,np),wa(m,ndim,np),oa(m,ndim,np)
      real cwc(m,ndim,np,2),taucld(m,ndim,np,2),reff(m,ndim,np,2), &
             fcld(m,ndim,np)
      real taual(m,ndim,np,11),ssaal(m,ndim,np,11),asyal(m,ndim,np,11)
      real cosz(m,ndim),rsuvbm(m,ndim),rsuvdf(m,ndim), &
             rsirbm(m,ndim),rsirdf(m,ndim)           
      logical overcast,cldwater

!-----output parameters

      real flx(m,ndim,np+1),flc(m,ndim,np+1)
      real flxu(m,ndim,np+1),flxd(m,ndim,np+1)
      real fdiruv (m,ndim),fdifuv (m,ndim)
      real fdirpar(m,ndim),fdifpar(m,ndim)
      real fdirir (m,ndim),fdifir (m,ndim)

!-----temporary array
 
      integer i,j,k
      real cwp(m,n,np,2)
      real dp(m,n,np),wh(m,n,np),oh(m,n,np),scal(m,n,np)
      real swh(m,n,np+1),so2(m,n,np+1),df(m,n,np+1)
      real sdf(m,n),sclr(m,n),csm(m,n),x
 
      do j= 1, n 
       do i= 1, m 
          if (pl(i,j,1) .eq. 0.0) then
              pl(i,j,1)=1.0e-4
          endif
       enddo
      enddo

      do j= 1, n 
       do i= 1, m 

         swh(i,j,1)=0. 
         so2(i,j,1)=0. 

!-----csm is the effective secant of the solar zenith angle
!     see equation (12) of Lacis and Hansen (1974, JAS)    
 
         csm(i,j)=35./sqrt(1224.*cosz(i,j)*cosz(i,j)+1.)

       enddo 
      enddo

      do k= 1, np
       do j= 1, n
         do i= 1, m

!-----compute layer thickness and pressure-scaling function. 
!     indices for the surface level and surface layer
!     are np+1 and np, respectively.
 
          dp(i,j,k)=pl(i,j,k+1)-pl(i,j,k)
          scal(i,j,k)=dp(i,j,k)*(.5*(pl(i,j,k)+pl(i,j,k+1))/300.)**.8
 
!-----compute scaled water vapor amount, unit is g/cm**2
!     note: the sign prior to the constant 0.00135 was incorrectly 
!           set to negative in the previous version

          wh(i,j,k)=1.02*wa(i,j,k)*scal(i,j,k)* &
                    (1.+0.00135*(ta(i,j,k)-240.)) +1.e-11
          swh(i,j,k+1)=swh(i,j,k)+wh(i,j,k)

!-----compute ozone amount, unit is (cm-atm)stp
!     the number 466.7 is a conversion factor from g/cm**2 to (cm-atm)stp
 
          oh(i,j,k)=1.02*oa(i,j,k)*dp(i,j,k)*466.7 +1.e-11

!-----compute layer cloud water amount (gm/m**2)
!     the index is 1 for ice crystals and 2 for liquid drops

          cwp(i,j,k,1)=1.02*10000.*cwc(i,j,k,1)*dp(i,j,k)
          cwp(i,j,k,2)=1.02*10000.*cwc(i,j,k,2)*dp(i,j,k)

        enddo
       enddo
      enddo

!-----initialize fluxes for all-sky (flx), clear-sky (flc), and
!     flux reduction (df)

      do k=1, np+1
       do j=1, n
        do i=1, m
          flx(i,j,k)=0.
          flc(i,j,k)=0.
          flxu(i,j,k)=0.
          flxd(i,j,k)=0.
          df(i,j,k)=0.
        enddo
       enddo
      enddo

!-----compute solar uv and par fluxes

      call soluv (m,n,ndim,np,oh,dp,overcast,cldwater,  &
                  cwp,taucld,reff,ict,icb,fcld,cosz,    &
                  taual,ssaal,asyal,csm,rsuvbm,rsuvdf,  &
                  flx,flc,flxu,flxd,fdiruv,fdifuv,fdirpar,fdifpar)

!-----compute and update solar ir fluxes

      call solir (m,n,ndim,np,wh,overcast,cldwater,     &
                  cwp,taucld,reff,ict,icb,fcld,cosz,    &
                  taual,ssaal,asyal,csm,rsirbm,rsirdf,  &
                  flx,flc,flxu,flxd,fdirir,fdifir)

!-----compute scaled o2 amount, unit is (cm-atm)stp.

      do k= 1, np
       do j= 1, n
        do i= 1, m
          so2(i,j,k+1)=so2(i,j,k)+165.22*scal(i,j,k)
        enddo
       enddo
      enddo

!-----compute flux reduction due to oxygen following
!      chou (J. climate, 1990). The fraction 0.0287 is the
!      extraterrestrial solar flux in the o2 bands.

       do k= 2, np+1
        do j= 1, n
         do i= 1, m
           x=so2(i,j,k)*csm(i,j)
           df(i,j,k)=df(i,j,k)+0.0287*(1.-exp(-0.00027*sqrt(x)))
         enddo
        enddo
       enddo          

!-----compute scaled co2 amounts. unit is (cm-atm)stp.

      do k= 1, np
       do j= 1, n
        do i= 1, m
         so2(i,j,k+1)=so2(i,j,k)+co2*789.*scal(i,j,k)+1.e-11
        enddo
       enddo
      enddo

!-----compute and update flux reduction due to co2 following
!     chou (J. Climate, 1990)

      call flxco2(m,n,np,so2,swh,csm,df)

!-----adjust for the effect of o2 cnd co2 on clear-sky fluxes.

      do k= 2, np+1
       do j= 1, n
        do i= 1, m
          flc(i,j,k)=flc(i,j,k)-df(i,j,k)
        enddo
       enddo
      enddo

!-----adjust for the all-sky fluxes due to o2 and co2.  It is
!     assumed that o2 and co2 have no effects on solar radiation
!     below clouds.

      do j=1,n
       do i=1,m
        sdf(i,j)=0.0
        sclr(i,j)=1.0
       enddo
      enddo

      do k=1,np
       do j=1,n
        do i=1,m

!-----sclr is the fraction of clear sky.
!     sdf is the flux reduction below clouds.

         if(fcld(i,j,k).gt.0.01) then
          sdf(i,j)=sdf(i,j)+df(i,j,k)*sclr(i,j)*fcld(i,j,k)
          sclr(i,j)=sclr(i,j)*(1.-fcld(i,j,k))
         endif
          flx(i,j,k+1)=flx(i,j,k+1)-sdf(i,j)-df(i,j,k+1)*sclr(i,j)
          flxu(i,j,k+1)=flxu(i,j,k+1)-sdf(i,j)-df(i,j,k+1)*sclr(i,j)
          flxd(i,j,k+1)=flxd(i,j,k+1)-sdf(i,j)-df(i,j,k+1)*sclr(i,j)

        enddo
       enddo
      enddo

!-----adjustment for the direct downward ir flux.

      do j= 1, n
       do i= 1, m
        flc(i,j,np+1)=flc(i,j,np+1)+df(i,j,np+1)*rsirbm(i,j)
        flx(i,j,np+1)=flx(i,j,np+1)+(sdf(i,j)+ &
                         df(i,j,np+1)*sclr(i,j))*rsirbm(i,j)
        flxu(i,j,np+1)=flxu(i,j,np+1)+(sdf(i,j)+ &
                         df(i,j,np+1)*sclr(i,j))*rsirbm(i,j)
        flxd(i,j,np+1)=flxd(i,j,np+1)+(sdf(i,j)+ &
                         df(i,j,np+1)*sclr(i,j))*rsirbm(i,j)
        fdirir(i,j)=fdirir(i,j)-(sdf(i,j)+df(i,j,np+1)*sclr(i,j))
       enddo
      enddo

      end subroutine sorad 

!************************************************************************

      subroutine soluv (m,n,ndim,np,oh,dp,overcast,cldwater,            &
                cwp,taucld,reff,ict,icb,fcld,cosz,                      &
                taual,ssaal,asyal,csm,rsuvbm,rsuvdf,                    &
                flx,flc,flxu,flxd,fdiruv,fdifuv,fdirpar,fdifpar)

!************************************************************************
!  compute solar fluxes in the uv+par region. the spectrum is
!  grouped into 8 bands:
!  
!              Band     Micrometer
!
!       UV-C    1.     .175 - .225
!               2.     .225 - .245
!                      .260 - .280
!               3.     .245 - .260
!
!       UV-B    4.     .280 - .295
!               5.     .295 - .310
!               6.     .310 - .320
!      
!       UV-A    7.     .320 - .400
!      
!       PAR     8.     .400 - .700
!
!----- Input parameters:                            units      size
!
!  number of soundings in zonal direction (m)       n/d        1
!  number of soundings in meridional direction (n)  n/d        1
!  maximum number of soundings in                   n/d        1
!        meridional direction (ndim)
!  number of atmospheric layers (np)                n/d        1
!  layer ozone content (oh)                      (cm-atm)stp m*n*np
!  layer pressure thickness (dp)                    mb       m*n*np
!  option for scaling cloud optical thickness       n/d        1
!        overcast="true" if scaling is NOT required
!        overcast="fasle" if scaling is required
!  input option for cloud optical thickness         n/d        1
!        cldwater="true" if taucld is provided
!        cldwater="false" if cwp is provided
!  cloud water amount (cwp)                        gm/m**2   m*n*np*2
!        index 1 for ice particles
!        index 2 for liquid drops
!  cloud optical thickness (taucld)                 n/d     m*ndim*np*2
!       index 1 for ice paticles
!       index 2 for liquid particles
!  effective cloud-particle size (reff)          micrometer m*ndim*np*2
!       index 1 for ice paticles
!       index 2 for liquid particles
!  level indiex separating high and                 n/d      m*n
!       middle clouds (ict)
!  level indiex separating middle and               n/d      m*n
!       low clouds (icb)
!  cloud amount (fcld)                            fraction   m*ndim*np
!  cosine of solar zenith angle (cosz)              n/d      m*ndim
!  aerosol optical thickness (taual)                n/d    m*ndim*np*11
!  aerosol single-scattering albedo (ssaal)         n/d    m*ndim*np*11
!  aerosol asymmetry factor (asyal)                 n/d    m*ndim*np*11
!  cosecant of the solar zenith angle (csm)         n/d      m*n
!  uv+par surface albedo for beam                 fraction   m*ndim
!       radiation (rsuvbm)
!  uv+par surface albedo for diffuse              fraction   m*ndim
!       radiation (rsuvdf)
!
!---- temporary array
!
!  scaled cloud optical thickness                   n/d      m*n*np
!       for beam radiation (tauclb)
!  scaled cloud optical thickness                   n/d      m*n*np
!       for diffuse radiation  (tauclf)     
!
!----- output (updated) parameters:
!
!  all-sky net downward flux (flx)               fraction  m*ndim*(np+1)
!  clear-sky net downward flux (flc)             fraction  m*ndim*(np+1)
!  all-sky direct downward uv flux at
!       the surface (fdiruv)                     fraction    m*ndim
!  all-sky diffuse downward uv flux at
!       the surface (fdifuv)                     fraction    m*ndim
!  all-sky direct downward par flux at
!       the surface (fdirpar)                    fraction    m*ndim
!  all-sky diffuse downward par flux at
!       the surface (fdifpar)                    fraction    m*ndim
!
!***********************************************************************
      implicit none
!***********************************************************************

!-----input parameters

      integer m,n,ndim,np
      integer ict(m,ndim),icb(m,ndim)
      real taucld(m,ndim,np,2),reff(m,ndim,np,2),fcld(m,ndim,np)
      real cc(m,n,3),cosz(m,ndim)
      real cwp(m,n,np,2),oh(m,n,np),dp(m,n,np)
      real taual(m,ndim,np,11),ssaal(m,ndim,np,11),asyal(m,ndim,np,11)
      real rsuvbm(m,ndim),rsuvdf(m,ndim),csm(m,n)
      logical overcast,cldwater

!-----output (updated) parameter

      real flx(m,ndim,np+1),flc(m,ndim,np+1)
      real flxu(m,ndim,np+1),flxd(m,ndim,np+1)
      real fdiruv (m,ndim),fdifuv (m,ndim)
      real fdirpar(m,ndim),fdifpar(m,ndim)

!-----static parameters

      integer nband
      parameter (nband=8)
      real hk(nband),xk(nband),ry(nband)
      real aig(3),awg(3)

!-----temporary array

      integer i,j,k,ib
      real tauclb(m,n,np),tauclf(m,n,np),asycl(m,n,np)
      real taurs,tauoz,tausto,ssatau,asysto,tauto,ssato,asyto
      real taux,reff1,reff2,g1,g2
      real td(m,n,np+1,2),rr(m,n,np+1,2),tt(m,n,np+1,2), &
             rs(m,n,np+1,2),ts(m,n,np+1,2)
      real fall(m,n,np+1),fclr(m,n,np+1),fsdir(m,n),fsdif(m,n)
      real fallu(m,n,np+1),falld(m,n,np+1)
      real asyclt(m,n)
      real rr1t(m,n),tt1t(m,n),td1t(m,n),rs1t(m,n),ts1t(m,n)
      real rr2t(m,n),tt2t(m,n),td2t(m,n),rs2t(m,n),ts2t(m,n)

!-----hk is the fractional extra-terrestrial solar flux in each
!     of the 8 bands.  the sum of hk is 0.47074.

      data hk/.00057, .00367, .00083, .00417,  &
              .00600, .00556, .05913, .39081/

!-----xk is the ozone absorption coefficient. unit: /(cm-atm)stp

      data xk /30.47, 187.2,  301.9,   42.83, &
               7.09,  1.25,   0.0345,  0.0539/

!-----ry is the extinction coefficient for Rayleigh scattering.
!     unit: /mb.

      data ry /.00604, .00170, .00222, .00132, &
               .00107, .00091, .00055, .00012/

!-----coefficients for computing the asymmetry factor of ice clouds
!     from asycl=aig(*,1)+aig(*,2)*reff+aig(*,3)*reff**2, independent
!     of spectral band.

      data aig/.74625000,.00105410,-.00000264/

!-----coefficients for computing the asymmetry factor of liquid
!     clouds from asycl=awg(*,1)+awg(*,2)*reff+awg(*,3)*reff**2,
!     independent of spectral band.

      data awg/.82562000,.00529000,-.00014866/

!-----initialize fdiruv, fdifuv, surface reflectances and transmittances.
!     cc is the maximum cloud cover in each of the three cloud groups.
            
      do j= 1, n
       do i= 1, m                    
         fdiruv(i,j)=0.0
         fdifuv(i,j)=0.0
         rr(i,j,np+1,1)=rsuvbm(i,j)
         rr(i,j,np+1,2)=rsuvbm(i,j)
         rs(i,j,np+1,1)=rsuvdf(i,j)
         rs(i,j,np+1,2)=rsuvdf(i,j)
         td(i,j,np+1,1)=0.0
         td(i,j,np+1,2)=0.0
         tt(i,j,np+1,1)=0.0
         tt(i,j,np+1,2)=0.0
         ts(i,j,np+1,1)=0.0
         ts(i,j,np+1,2)=0.0
         cc(i,j,1)=0.0
         cc(i,j,2)=0.0
         cc(i,j,3)=0.0
       enddo
      enddo


!-----compute cloud optical thickness

      if (cldwater) then

       do k= 1, np
        do j= 1, n
         do i= 1, m
          taucld(i,j,k,1)=cwp(i,j,k,1)*( 3.33e-4+2.52/reff(i,j,k,1))
          taucld(i,j,k,2)=cwp(i,j,k,2)*(-6.59e-3+1.65/reff(i,j,k,2))
         enddo
        enddo
       enddo

      endif

!-----options for scaling cloud optical thickness

      if (overcast) then

       do k= 1, np
        do j= 1, n
         do i= 1, m
          tauclb(i,j,k)=taucld(i,j,k,1)+taucld(i,j,k,2)
          tauclf(i,j,k)=tauclb(i,j,k)
         enddo
        enddo
       enddo

       do k= 1, 3
        do j= 1, n
         do i= 1, m
           cc(i,j,k)=1.0
         enddo
        enddo
       enddo

      else

!-----scale cloud optical thickness in each layer from taucld (with
!     cloud amount fcld) to tauclb and tauclf (with cloud amount cc).
!     tauclb is the scaled optical thickness for beam radiation and
!     tauclf is for diffuse radiation.

       call cldscale(m,n,ndim,np,cosz,fcld,taucld,ict,icb,  &
                    cc,tauclb,tauclf)

      endif

!-----compute cloud asymmetry factor for a mixture of
!     liquid and ice particles.  unit of reff is micrometers.

      do k= 1, np

       do j= 1, n
        do i= 1, m

           asyclt(i,j)=1.0

           taux=taucld(i,j,k,1)+taucld(i,j,k,2)
          if (taux.gt.0.05 .and. fcld(i,j,k).gt.0.01) then

           reff1=min(reff(i,j,k,1),130.)
           reff2=min(reff(i,j,k,2),20.0)

           g1=(aig(1)+(aig(2)+aig(3)*reff1)*reff1)*taucld(i,j,k,1)
           g2=(awg(1)+(awg(2)+awg(3)*reff2)*reff2)*taucld(i,j,k,2)
           asyclt(i,j)=(g1+g2)/taux

          endif

        enddo
       enddo

       do j=1,n
        do i=1,m
           asycl(i,j,k)=asyclt(i,j)
        enddo
       enddo

      enddo

!-----integration over spectral bands

      do 100 ib=1,nband

       do 300 k= 1, np

        do j= 1, n
         do i= 1, m

!-----compute ozone and rayleigh optical thicknesses

          taurs=ry(ib)*dp(i,j,k)
          tauoz=xk(ib)*oh(i,j,k)
 
!-----compute clear-sky optical thickness, single scattering albedo,
!     and asymmetry factor

          tausto=taurs+tauoz+taual(i,j,k,ib)+1.0e-8
          ssatau=ssaal(i,j,k,ib)*taual(i,j,k,ib)+taurs
          asysto=asyal(i,j,k,ib)*ssaal(i,j,k,ib)*taual(i,j,k,ib)

          tauto=tausto
          ssato=ssatau/tauto+1.0e-8
          ssato=min(ssato,0.999999)
          asyto=asysto/(ssato*tauto)

!-----compute reflectance and transmittance for cloudless layers

!-                 for direct incident radiation

          call deledd (tauto,ssato,asyto,csm(i,j),  &
                       rr1t(i,j),tt1t(i,j),td1t(i,j))

!-                 for diffuse incident radiation

          call sagpol (tauto,ssato,asyto,rs1t(i,j),ts1t(i,j))

!-----compute reflectance and transmittance for cloud layers

         if (tauclb(i,j,k).lt.0.01 .or. fcld(i,j,k).lt.0.01) then

          rr2t(i,j)=rr1t(i,j)
          tt2t(i,j)=tt1t(i,j)
          td2t(i,j)=td1t(i,j)
          rs2t(i,j)=rs1t(i,j)
          ts2t(i,j)=ts1t(i,j)

         else

!--                for direct incident radiation

          tauto=tausto+tauclb(i,j,k)
          ssato=(ssatau+tauclb(i,j,k))/tauto+1.0e-8
          ssato=min(ssato,0.999999)
          asyto=(asysto+asycl(i,j,k)*tauclb(i,j,k))/(ssato*tauto)

          call deledd (tauto,ssato,asyto,csm(i,j),  &
                       rr2t(i,j),tt2t(i,j),td2t(i,j))

!--                for diffuse incident radiation

          tauto=tausto+tauclf(i,j,k)
          ssato=(ssatau+tauclf(i,j,k))/tauto+1.0e-8
          ssato=min(ssato,0.999999)
          asyto=(asysto+asycl(i,j,k)*tauclf(i,j,k))/(ssato*tauto)

          call sagpol (tauto,ssato,asyto,rs2t(i,j),ts2t(i,j))

         endif

        enddo
       enddo

        do j=1,n
         do i=1,m
            rr(i,j,k,1)=rr1t(i,j)
         enddo
        enddo
        do j=1,n
         do i=1,m
            tt(i,j,k,1)=tt1t(i,j)
         enddo
        enddo
        do j=1,n
         do i=1,m
            td(i,j,k,1)=td1t(i,j)
         enddo
        enddo
        do j=1,n
         do i=1,m
            rs(i,j,k,1)=rs1t(i,j)
         enddo
        enddo
        do j=1,n
         do i=1,m
            ts(i,j,k,1)=ts1t(i,j)
         enddo
        enddo

        do j=1,n
         do i=1,m
            rr(i,j,k,2)=rr2t(i,j)
         enddo
        enddo
        do j=1,n
         do i=1,m
            tt(i,j,k,2)=tt2t(i,j)
         enddo
        enddo
        do j=1,n
         do i=1,m
            td(i,j,k,2)=td2t(i,j)
         enddo
        enddo
        do j=1,n
         do i=1,m
            rs(i,j,k,2)=rs2t(i,j)
         enddo
        enddo
        do j=1,n
         do i=1,m
            ts(i,j,k,2)=ts2t(i,j)
         enddo
        enddo

 300  continue

!-----flux calculations
 
        call cldflx (m,n,np,ict,icb,overcast,cc,rr,tt,td,rs,ts, &
                     fclr,fall,fallu,falld,fsdir,fsdif)

       do k= 1, np+1
        do j= 1, n
         do i= 1, m
          flx(i,j,k)=flx(i,j,k)+fall(i,j,k)*hk(ib)
          flxu(i,j,k)=flxu(i,j,k)+fallu(i,j,k)*hk(ib)
          flxd(i,j,k)=flxd(i,j,k)+falld(i,j,k)*hk(ib)
         enddo
        enddo
        do j= 1, n
         do i= 1, m
          flc(i,j,k)=flc(i,j,k)+fclr(i,j,k)*hk(ib)
         enddo
        enddo
       enddo

!-----compute downward surface fluxes in the UV and par regions

       if(ib.lt.8) then
         do j=1,n
          do i=1,m
           fdiruv(i,j)=fdiruv(i,j)+fsdir(i,j)*hk(ib)
           fdifuv(i,j)=fdifuv(i,j)+fsdif(i,j)*hk(ib)
         enddo
        enddo
       else
         do j=1,n
          do i=1,m
           fdirpar(i,j)=fsdir(i,j)*hk(ib)
           fdifpar(i,j)=fsdif(i,j)*hk(ib)
         enddo
        enddo
       endif

 100  continue

      end subroutine soluv

!************************************************************************

      subroutine solir (m,n,ndim,np,wh,overcast,cldwater,               &
                        cwp,taucld,reff,ict,icb,fcld,cosz,              &
                        taual,ssaal,asyal,csm,rsirbm,rsirdf,            &
                        flx,flc,flxu,flxd,fdirir,fdifir)

!************************************************************************
!  compute solar flux in the infrared region. The spectrum is divided
!   into three bands:
!
!          band   wavenumber(/cm)  wavelength (micron)
!          1( 9)    14300-8200         0.70-1.22
!          2(10)     8200-4400         1.22-2.27
!          3(11)     4400-1000         2.27-10.0
!
!----- Input parameters:                            units      size
!
!  number of soundings in zonal direction (m)       n/d        1
!  number of soundings in meridional direction (n)  n/d        1
!  maximum number of soundings in                   n/d        1
!         meridional direction (ndim)
!  number of atmospheric layers (np)                n/d        1
!  layer scaled-water vapor content (wh)          gm/cm^2    m*n*np
!  option for scaling cloud optical thickness       n/d        1
!        overcast="true" if scaling is NOT required
!        overcast="fasle" if scaling is required
!  input option for cloud optical thickness         n/d        1
!        cldwater="true" if taucld is provided
!        cldwater="false" if cwp is provided
!  cloud water concentration (cwp)                gm/m**2    m*n*np*2
!        index 1 for ice particles
!        index 2 for liquid drops
!  cloud optical thickness (taucld)                 n/d      m*ndim*np*2
!        index 1 for ice paticles
!  effective cloud-particle size (reff)           micrometer m*ndim*np*2
!        index 1 for ice paticles
!        index 2 for liquid particles
!  level index separating high and                  n/d      m*n
!        middle clouds (ict)
!  level index separating middle and                n/d      m*n
!        low clouds (icb)
!  cloud amount (fcld)                            fraction   m*ndim*np
!  aerosol optical thickness (taual)                n/d      m*ndim*np*11
!  aerosol single-scattering albedo (ssaal)         n/d      m*ndim*np*11
!  aerosol asymmetry factor (asyal)                 n/d      m*ndim*np*11 
!  cosecant of the solar zenith angle (csm)         n/d      m*n
!  near ir surface albedo for beam                fraction   m*ndim
!        radiation (rsirbm)
!  near ir surface albedo for diffuse             fraction   m*ndim
!        radiation (rsirdf)
!
!---- temporary array
!
!  scaled cloud optical thickness                   n/d      m*n*np
!          for beam radiation (tauclb)
!  scaled cloud optical thickness                   n/d      m*n*np
!          for diffuse radiation  (tauclf)     
!
!----- output (updated) parameters:
!
!  all-sky flux (downward-upward) (flx)           fraction   m*ndim*(np+1)
!  clear-sky flux (downward-upward) (flc)         fraction   m*ndim*(np+1)
!  all-sky direct downward ir flux at
!          the surface (fdirir)                    fraction   m*ndim
!  all-sky diffuse downward ir flux at
!          the surface (fdifir)                    fraction   m*ndim
!
!**********************************************************************
      implicit none
!**********************************************************************

!-----input parameters

      integer m,n,ndim,np
      integer ict(m,ndim),icb(m,ndim)
      real cwp(m,n,np,2),taucld(m,ndim,np,2),reff(m,ndim,np,2)
      real fcld(m,ndim,np),cc(m,n,3),cosz(m,ndim)
      real rsirbm(m,ndim),rsirdf(m,ndim)
      real taual(m,ndim,np,11),ssaal(m,ndim,np,11),asyal(m,ndim,np,11)
      real wh(m,n,np),csm(m,n)
      logical overcast,cldwater

!-----output (updated) parameters

      real flx(m,ndim,np+1),flc(m,ndim,np+1)
      real flxu(m,ndim,np+1),flxd(m,ndim,np+1)
      real fdirir(m,ndim),fdifir(m,ndim)

!-----static parameters

      integer nk,nband
      parameter (nk=10,nband=3)
      real xk(nk),hk(nband,nk),aib(nband,2),awb(nband,2)
      real aia(nband,3),awa(nband,3),aig(nband,3),awg(nband,3)

!-----temporary array

      integer ib,iv,ik,i,j,k
      real tauclb(m,n,np),tauclf(m,n,np)
      real ssacl(m,n,np),asycl(m,n,np)
      real rr(m,n,np+1,2),tt(m,n,np+1,2),td(m,n,np+1,2), &
             rs(m,n,np+1,2),ts(m,n,np+1,2)
      real fall(m,n,np+1),fclr(m,n,np+1)
      real fallu(m,n,np+1),falld(m,n,np+1)
      real fsdir(m,n),fsdif(m,n)

      real tauwv,tausto,ssatau,asysto,tauto,ssato,asyto
      real taux,reff1,reff2,w1,w2,g1,g2
      real ssaclt(m,n),asyclt(m,n)
      real rr1t(m,n),tt1t(m,n),td1t(m,n),rs1t(m,n),ts1t(m,n)
      real rr2t(m,n),tt2t(m,n),td2t(m,n),rs2t(m,n),ts2t(m,n)

!-----water vapor absorption coefficient for 10 k-intervals.
!     unit: cm^2/gm

      data xk/  &
        0.0010, 0.0133, 0.0422, 0.1334, 0.4217, &
        1.334,  5.623,  31.62,  177.8,  1000.0/  

!-----water vapor k-distribution function,
!     the sum of hk is 0.52926. unit: fraction

      data hk/  &
       .20673,.08236,.01074,  .03497,.01157,.00360, &
       .03011,.01133,.00411,  .02260,.01143,.00421, &
       .01336,.01240,.00389,  .00696,.01258,.00326, &
       .00441,.01381,.00499,  .00115,.00650,.00465, &
       .00026,.00244,.00245,  .00000,.00094,.00145/

!-----coefficients for computing the extinction coefficient of
!     ice clouds from b=aib(*,1)+aib(*,2)/reff

      data aib/ &
        .000333, .000333, .000333, &
           2.52,    2.52,    2.52/

!-----coefficients for computing the extinction coefficient of
!     water clouds from b=awb(*,1)+awb(*,2)/reff

      data awb/ &
        -0.0101, -0.0166, -0.0339, &
           1.72,    1.85,    2.16/


!-----coefficients for computing the single scattering albedo of
!     ice clouds from ssa=1-(aia(*,1)+aia(*,2)*reff+aia(*,3)*reff**2)

      data aia/ &
       -.00000260, .00215346, .08938331, &
        .00000746, .00073709, .00299387, &
        .00000000,-.00000134,-.00001038/

!-----coefficients for computing the single scattering albedo of
!     liquid clouds from ssa=1-(awa(*,1)+awa(*,2)*reff+awa(*,3)*reff**2)

      data awa/ &
        .00000007,-.00019934, .01209318, &
        .00000845, .00088757, .01784739, &
       -.00000004,-.00000650,-.00036910/

!-----coefficients for computing the asymmetry factor of ice clouds
!     from asycl=aig(*,1)+aig(*,2)*reff+aig(*,3)*reff**2

      data aig/ &
        .74935228, .76098937, .84090400, &
        .00119715, .00141864, .00126222, &
       -.00000367,-.00000396,-.00000385/

!-----coefficients for computing the asymmetry factor of liquid clouds
!     from asycl=awg(*,1)+awg(*,2)*reff+awg(*,3)*reff**2

      data awg/ &
        .79375035, .74513197, .83530748, &
        .00832441, .01370071, .00257181, &
       -.00023263,-.00038203, .00005519/

!-----initialize surface fluxes, reflectances, and transmittances.
!     cc is the maximum cloud cover in each of the three cloud groups.

      do j= 1, n
       do i= 1, m
         fdirir(i,j)=0.0
         fdifir(i,j)=0.0
         rr(i,j,np+1,1)=rsirbm(i,j)
         rr(i,j,np+1,2)=rsirbm(i,j)
         rs(i,j,np+1,1)=rsirdf(i,j)
         rs(i,j,np+1,2)=rsirdf(i,j)
         td(i,j,np+1,1)=0.0
         td(i,j,np+1,2)=0.0
         tt(i,j,np+1,1)=0.0
         tt(i,j,np+1,2)=0.0
         ts(i,j,np+1,1)=0.0
         ts(i,j,np+1,2)=0.0
         cc(i,j,1)=0.0
         cc(i,j,2)=0.0
         cc(i,j,3)=0.0
       enddo
      enddo

!-----integration over spectral bands

      do 100 ib=1,nband

       iv=ib+8

!-----compute cloud optical thickness

      if (cldwater) then

       do k= 1, np
        do j= 1, n
         do i= 1, m
          taucld(i,j,k,1)=cwp(i,j,k,1)*(aib(ib,1) &
                          +aib(ib,2)/reff(i,j,k,1))
          taucld(i,j,k,2)=cwp(i,j,k,2)*(awb(ib,1) &
                          +awb(ib,2)/reff(i,j,k,2))
         enddo
        enddo
       enddo

      endif

!-----options for scaling cloud optical thickness

      if (overcast) then

       do k= 1, np
        do j= 1, n
         do i= 1, m
          tauclb(i,j,k)=taucld(i,j,k,1)+taucld(i,j,k,2)
          tauclf(i,j,k)=tauclb(i,j,k)
         enddo
        enddo
       enddo

       do k= 1, 3
        do j= 1, n
         do i= 1, m
           cc(i,j,k)=1.0
         enddo
        enddo
       enddo

      else

!-----scale cloud optical thickness in each layer from taucld (with
!     cloud amount fcld) to tauclb and tauclf (with cloud amount cc).
!     tauclb is the scaled optical thickness for beam radiation and
!     tauclf is for diffuse radiation.

       call cldscale(m,n,ndim,np,cosz,fcld,taucld,ict,icb, &
                    cc,tauclb,tauclf)

      endif

!-----compute cloud single scattering albedo and asymmetry factor
!     for a mixture of ice and liquid particles.

       do k= 1, np

        do j= 1, n
         do i= 1, m

           ssaclt(i,j)=1.0
           asyclt(i,j)=1.0

           taux=taucld(i,j,k,1)+taucld(i,j,k,2)
          if (taux.gt.0.05 .and. fcld(i,j,k).gt.0.01) then

           reff1=min(reff(i,j,k,1),130.)
           reff2=min(reff(i,j,k,2),20.0)

           w1=(1.-(aia(ib,1)+(aia(ib,2)+ &
               aia(ib,3)*reff1)*reff1))*taucld(i,j,k,1)
           w2=(1.-(awa(ib,1)+(awa(ib,2)+ &
               awa(ib,3)*reff2)*reff2))*taucld(i,j,k,2)
           ssaclt(i,j)=(w1+w2)/taux

           g1=(aig(ib,1)+(aig(ib,2)+aig(ib,3)*reff1)*reff1)*w1
           g2=(awg(ib,1)+(awg(ib,2)+awg(ib,3)*reff2)*reff2)*w2
           asyclt(i,j)=(g1+g2)/(w1+w2)

          endif

         enddo
        enddo

        do j=1,n
         do i=1,m
            ssacl(i,j,k)=ssaclt(i,j)
         enddo
        enddo
        do j=1,n
         do i=1,m
            asycl(i,j,k)=asyclt(i,j)
         enddo
        enddo

       enddo

!-----integration over the k-distribution function

         do 200 ik=1,nk

          do 300 k= 1, np

           do j= 1, n
            do i= 1, m

             tauwv=xk(ik)*wh(i,j,k)
 
!-----compute clear-sky optical thickness, single scattering albedo,
!     and asymmetry factor.
 
             tausto=tauwv+taual(i,j,k,iv)+1.0e-8
             ssatau=ssaal(i,j,k,iv)*taual(i,j,k,iv)
             asysto=asyal(i,j,k,iv)*ssaal(i,j,k,iv)*taual(i,j,k,iv)
 
!-----compute reflectance and transmittance for cloudless layers

             tauto=tausto
             ssato=ssatau/tauto+1.0e-8

            if (ssato .gt. 0.001) then

             ssato=min(ssato,0.999999)
             asyto=asysto/(ssato*tauto)

!-                 for direct incident radiation

             call deledd (tauto,ssato,asyto,csm(i,j),  &
                          rr1t(i,j),tt1t(i,j),td1t(i,j))

!-                 for diffuse incident radiation

             call sagpol (tauto,ssato,asyto,rs1t(i,j),ts1t(i,j))

            else

             td1t(i,j)=exp(-tauto*csm(i,j))
             ts1t(i,j)=exp(-1.66*tauto)
             tt1t(i,j)=0.0
             rr1t(i,j)=0.0
             rs1t(i,j)=0.0

            endif

!-----compute reflectance and transmittance for cloud layers

            if (tauclb(i,j,k).lt.0.01 .or. fcld(i,j,k).lt.0.01) then

             rr2t(i,j)=rr1t(i,j)
             tt2t(i,j)=tt1t(i,j)
             td2t(i,j)=td1t(i,j)
             rs2t(i,j)=rs1t(i,j)
             ts2t(i,j)=ts1t(i,j)

            else

!-                 for direct incident radiation

             tauto=tausto+tauclb(i,j,k)
             ssato=(ssatau+ssacl(i,j,k)*tauclb(i,j,k))/tauto+1.0e-8
             ssato=min(ssato,0.999999)
             asyto=(asysto+asycl(i,j,k)*ssacl(i,j,k)*tauclb(i,j,k))/ &
                   (ssato*tauto)

             call deledd (tauto,ssato,asyto,csm(i,j),  &
                          rr2t(i,j),tt2t(i,j),td2t(i,j))

!-                 for diffuse incident radiation

             tauto=tausto+tauclf(i,j,k)
             ssato=(ssatau+ssacl(i,j,k)*tauclf(i,j,k))/tauto+1.0e-8
             ssato=min(ssato,0.999999)
             asyto=(asysto+asycl(i,j,k)*ssacl(i,j,k)*tauclf(i,j,k))/ &
                   (ssato*tauto)

             call sagpol (tauto,ssato,asyto,rs2t(i,j),ts2t(i,j))

            endif

           enddo
          enddo

           do j=1,n
            do i=1,m
               rr(i,j,k,1)=rr1t(i,j)
            enddo
           enddo
           do j=1,n
            do i=1,m
               tt(i,j,k,1)=tt1t(i,j)
            enddo
           enddo
           do j=1,n
            do i=1,m
               td(i,j,k,1)=td1t(i,j)
            enddo
           enddo
           do j=1,n
            do i=1,m
               rs(i,j,k,1)=rs1t(i,j)
            enddo
           enddo
           do j=1,n
            do i=1,m
               ts(i,j,k,1)=ts1t(i,j)
            enddo
           enddo
 
           do j=1,n
            do i=1,m
               rr(i,j,k,2)=rr2t(i,j)
            enddo
           enddo
           do j=1,n
            do i=1,m
               tt(i,j,k,2)=tt2t(i,j)
            enddo
           enddo
           do j=1,n
            do i=1,m
               td(i,j,k,2)=td2t(i,j)
            enddo
           enddo
           do j=1,n
            do i=1,m
               rs(i,j,k,2)=rs2t(i,j)
            enddo
           enddo
           do j=1,n
            do i=1,m
               ts(i,j,k,2)=ts2t(i,j)
            enddo
           enddo

 300  continue

!-----flux calculations

        call cldflx (m,n,np,ict,icb,overcast,cc,rr,tt,td,rs,ts, &
                     fclr,fall,fallu,falld,fsdir,fsdif)

       do k= 1, np+1
        do j= 1, n
         do i= 1, m
          flx(i,j,k) = flx(i,j,k)+fall(i,j,k)*hk(ib,ik)
          flxu(i,j,k) = flxu(i,j,k)+fallu(i,j,k)*hk(ib,ik)
          flxd(i,j,k) = flxd(i,j,k)+falld(i,j,k)*hk(ib,ik)
         enddo
        enddo
        do j= 1, n
         do i= 1, m
          flc(i,j,k) = flc(i,j,k)+fclr(i,j,k)*hk(ib,ik)
         enddo
        enddo
       enddo

!-----compute downward surface fluxes in the ir region

       do j= 1, n
        do i= 1, m
          fdirir(i,j) = fdirir(i,j)+fsdir(i,j)*hk(ib,ik)
          fdifir(i,j) = fdifir(i,j)+fsdif(i,j)*hk(ib,ik)
        enddo
       enddo

  200 continue
  100 continue
 
      end subroutine solir 

!********************************************************************

      subroutine cldscale (m,n,ndim,np,cosz,fcld,taucld,ict,icb,    &
                           cc,tauclb,tauclf)

!********************************************************************
!
!   This subroutine computes the high, middle, and
!    low cloud amounts and scales the cloud optical thickness.
!
!   To simplify calculations in a cloudy atmosphere, clouds are
!    grouped into high, middle and low clouds separated by the levels
!    ict and icb (level 1 is the top of the model atmosphere).
!
!   Within each of the three groups, clouds are assumed maximally
!    overlapped, and the cloud cover (cc) of a group is the maximum
!    cloud cover of all the layers in the group.  The optical thickness
!    (taucld) of a given layer is then scaled to new values (tauclb and
!    tauclf) so that the layer reflectance corresponding to the cloud
!    cover cc is the same as the original reflectance with optical
!    thickness taucld and cloud cover fcld.
!
!---input parameters
!
!    number of grid intervals in zonal direction (m)
!    number of grid intervals in meridional direction (n)
!    maximum number of grid intervals in meridional direction (ndim)
!    number of atmospheric layers (np)
!    cosine of the solar zenith angle (cosz)
!    fractional cloud cover (fcld)
!    cloud optical thickness (taucld)
!    index separating high and middle clouds (ict)
!    index separating middle and low clouds (icb)
!
!---output parameters
!
!    fractional cover of high, middle, and low clouds (cc)
!    scaled cloud optical thickness for beam radiation (tauclb)
!    scaled cloud optical thickness for diffuse radiation (tauclf)
!
!********************************************************************
      implicit none
!********************************************************************

!-----input parameters

      integer m,n,ndim,np
      integer ict(m,ndim),icb(m,ndim)
      real cosz(m,ndim),fcld(m,ndim,np),taucld(m,ndim,np,2)

!-----output parameters

      real cc(m,n,3),tauclb(m,n,np),tauclf(m,n,np)

!-----temporary variables

      integer i,j,k,im,it,ia,kk
      real  fm,ft,fa,xai,taux

!-----pre-computed table

      integer   nm,nt,na
      parameter (nm=11,nt=9,na=11) 
      real  dm,dt,da,t1,caib(nm,nt,na),caif(nt,na)
      parameter (dm=0.1,dt=0.30103,da=0.1,t1=-0.9031)

!-----include the pre-computed table of mcai for scaling the cloud optical
!     thickness under the assumption that clouds are maximally overlapped
!
!     caib is for scaling the cloud optical thickness for direct radiation
!     caif is for scaling the cloud optical thickness for diffuse radiation


      data ((caib(1,i,j),j=1,11),i=1,9)/  &
       .000,0.068,0.140,0.216,0.298,0.385,0.481,0.586,0.705,0.840,1.000, &
       .000,0.052,0.106,0.166,0.230,0.302,0.383,0.478,0.595,0.752,1.000, &
       .000,0.038,0.078,0.120,0.166,0.218,0.276,0.346,0.438,0.582,1.000, &
       .000,0.030,0.060,0.092,0.126,0.164,0.206,0.255,0.322,0.442,1.000, &
       .000,0.025,0.051,0.078,0.106,0.136,0.170,0.209,0.266,0.462,1.000, &
       .000,0.023,0.046,0.070,0.095,0.122,0.150,0.187,0.278,0.577,1.000, &
       .000,0.022,0.043,0.066,0.089,0.114,0.141,0.187,0.354,0.603,1.000, &
       .000,0.021,0.042,0.063,0.086,0.108,0.135,0.214,0.349,0.565,1.000, &
       .000,0.021,0.041,0.062,0.083,0.105,0.134,0.202,0.302,0.479,1.000/
      data ((caib(2,i,j),j=1,11),i=1,9)/ &
       .000,0.088,0.179,0.272,0.367,0.465,0.566,0.669,0.776,0.886,1.000, &
       .000,0.079,0.161,0.247,0.337,0.431,0.531,0.637,0.749,0.870,1.000, &
       .000,0.065,0.134,0.207,0.286,0.372,0.466,0.572,0.692,0.831,1.000, &
       .000,0.049,0.102,0.158,0.221,0.290,0.370,0.465,0.583,0.745,1.000, &
       .000,0.037,0.076,0.118,0.165,0.217,0.278,0.354,0.459,0.638,1.000, &
       .000,0.030,0.061,0.094,0.130,0.171,0.221,0.286,0.398,0.631,1.000, &
       .000,0.026,0.052,0.081,0.111,0.146,0.189,0.259,0.407,0.643,1.000, &
       .000,0.023,0.047,0.072,0.098,0.129,0.170,0.250,0.387,0.598,1.000, &
       .000,0.022,0.044,0.066,0.090,0.118,0.156,0.224,0.328,0.508,1.000/
      data ((caib(3,i,j),j=1,11),i=1,9)/ &
       .000,0.094,0.189,0.285,0.383,0.482,0.582,0.685,0.788,0.894,1.000, &
       .000,0.088,0.178,0.271,0.366,0.465,0.565,0.669,0.776,0.886,1.000, &
       .000,0.079,0.161,0.247,0.337,0.431,0.531,0.637,0.750,0.870,1.000, &
       .000,0.066,0.134,0.209,0.289,0.375,0.470,0.577,0.697,0.835,1.000, &
       .000,0.050,0.104,0.163,0.227,0.300,0.383,0.483,0.606,0.770,1.000, &
       .000,0.038,0.080,0.125,0.175,0.233,0.302,0.391,0.518,0.710,1.000, &
       .000,0.031,0.064,0.100,0.141,0.188,0.249,0.336,0.476,0.689,1.000, &
       .000,0.026,0.054,0.084,0.118,0.158,0.213,0.298,0.433,0.638,1.000, &
       .000,0.023,0.048,0.074,0.102,0.136,0.182,0.254,0.360,0.542,1.000/
      data ((caib(4,i,j),j=1,11),i=1,9)/ &
       .000,0.096,0.193,0.290,0.389,0.488,0.589,0.690,0.792,0.896,1.000, &
       .000,0.092,0.186,0.281,0.378,0.477,0.578,0.680,0.785,0.891,1.000, &
       .000,0.086,0.174,0.264,0.358,0.455,0.556,0.660,0.769,0.882,1.000, &
       .000,0.074,0.153,0.235,0.323,0.416,0.514,0.622,0.737,0.862,1.000, &
       .000,0.061,0.126,0.195,0.271,0.355,0.449,0.555,0.678,0.823,1.000, &
       .000,0.047,0.098,0.153,0.215,0.286,0.370,0.471,0.600,0.770,1.000, &
       .000,0.037,0.077,0.120,0.170,0.230,0.303,0.401,0.537,0.729,1.000, &
       .000,0.030,0.062,0.098,0.138,0.187,0.252,0.343,0.476,0.673,1.000, &
       .000,0.026,0.053,0.082,0.114,0.154,0.207,0.282,0.391,0.574,1.000/
      data ((caib(5,i,j),j=1,11),i=1,9)/ &
       .000,0.097,0.194,0.293,0.392,0.492,0.592,0.693,0.794,0.897,1.000, &
       .000,0.094,0.190,0.286,0.384,0.483,0.584,0.686,0.789,0.894,1.000, &
       .000,0.090,0.181,0.274,0.370,0.468,0.569,0.672,0.778,0.887,1.000, &
       .000,0.081,0.165,0.252,0.343,0.439,0.539,0.645,0.757,0.874,1.000, &
       .000,0.069,0.142,0.218,0.302,0.392,0.490,0.598,0.717,0.850,1.000, &
       .000,0.054,0.114,0.178,0.250,0.330,0.422,0.529,0.656,0.810,1.000, &
       .000,0.042,0.090,0.141,0.200,0.269,0.351,0.455,0.589,0.764,1.000, &
       .000,0.034,0.070,0.112,0.159,0.217,0.289,0.384,0.515,0.703,1.000, &
       .000,0.028,0.058,0.090,0.128,0.174,0.231,0.309,0.420,0.602,1.000/
      data ((caib(6,i,j),j=1,11),i=1,9)/ &
       .000,0.098,0.196,0.295,0.394,0.494,0.594,0.695,0.796,0.898,1.000, &
       .000,0.096,0.193,0.290,0.389,0.488,0.588,0.690,0.792,0.895,1.000, &
       .000,0.092,0.186,0.281,0.378,0.477,0.577,0.680,0.784,0.891,1.000, &
       .000,0.086,0.174,0.264,0.358,0.455,0.556,0.661,0.769,0.882,1.000, &
       .000,0.075,0.154,0.237,0.325,0.419,0.518,0.626,0.741,0.865,1.000, &
       .000,0.062,0.129,0.201,0.279,0.366,0.462,0.571,0.694,0.836,1.000, &
       .000,0.049,0.102,0.162,0.229,0.305,0.394,0.501,0.631,0.793,1.000, &
       .000,0.038,0.080,0.127,0.182,0.245,0.323,0.422,0.550,0.730,1.000, &
       .000,0.030,0.064,0.100,0.142,0.192,0.254,0.334,0.448,0.627,1.000/
      data ((caib(7,i,j),j=1,11),i=1,9)/ &
       .000,0.098,0.198,0.296,0.396,0.496,0.596,0.696,0.797,0.898,1.000, &
       .000,0.097,0.194,0.293,0.392,0.491,0.591,0.693,0.794,0.897,1.000, &
       .000,0.094,0.190,0.286,0.384,0.483,0.583,0.686,0.789,0.894,1.000, &
       .000,0.089,0.180,0.274,0.369,0.467,0.568,0.672,0.778,0.887,1.000, &
       .000,0.081,0.165,0.252,0.344,0.440,0.541,0.646,0.758,0.875,1.000, &
       .000,0.069,0.142,0.221,0.306,0.397,0.496,0.604,0.722,0.854,1.000, &
       .000,0.056,0.116,0.182,0.256,0.338,0.432,0.540,0.666,0.816,1.000, &
       .000,0.043,0.090,0.143,0.203,0.273,0.355,0.455,0.583,0.754,1.000, &
       .000,0.034,0.070,0.111,0.157,0.210,0.276,0.359,0.474,0.650,1.000/
      data ((caib(8,i,j),j=1,11),i=1,9)/ &
       .000,0.099,0.198,0.298,0.398,0.497,0.598,0.698,0.798,0.899,1.000, &
       .000,0.098,0.196,0.295,0.394,0.494,0.594,0.695,0.796,0.898,1.000, &
       .000,0.096,0.193,0.290,0.390,0.489,0.589,0.690,0.793,0.896,1.000, &
       .000,0.093,0.186,0.282,0.379,0.478,0.578,0.681,0.786,0.892,1.000, &
       .000,0.086,0.175,0.266,0.361,0.458,0.558,0.663,0.771,0.883,1.000, &
       .000,0.076,0.156,0.240,0.330,0.423,0.523,0.630,0.744,0.867,1.000, &
       .000,0.063,0.130,0.203,0.282,0.369,0.465,0.572,0.694,0.834,1.000, &
       .000,0.049,0.102,0.161,0.226,0.299,0.385,0.486,0.611,0.774,1.000, &
       .000,0.038,0.078,0.122,0.172,0.229,0.297,0.382,0.498,0.672,1.000/
      data ((caib(9,i,j),j=1,11),i=1,9)/ &
       .000,0.099,0.199,0.298,0.398,0.498,0.598,0.699,0.799,0.899,1.000, &
       .000,0.099,0.198,0.298,0.398,0.497,0.598,0.698,0.798,0.899,1.000, &
       .000,0.098,0.196,0.295,0.394,0.494,0.594,0.695,0.796,0.898,1.000, &
       .000,0.096,0.193,0.290,0.389,0.488,0.588,0.690,0.792,0.895,1.000, &
       .000,0.092,0.185,0.280,0.376,0.474,0.575,0.678,0.782,0.890,1.000, &
       .000,0.084,0.170,0.259,0.351,0.447,0.547,0.652,0.762,0.878,1.000, &
       .000,0.071,0.146,0.224,0.308,0.398,0.494,0.601,0.718,0.850,1.000, &
       .000,0.056,0.114,0.178,0.248,0.325,0.412,0.514,0.638,0.793,1.000, &
       .000,0.042,0.086,0.134,0.186,0.246,0.318,0.405,0.521,0.691,1.000/
      data ((caib(10,i,j),j=1,11),i=1,9)/ &
       .000,0.100,0.200,0.300,0.400,0.500,0.600,0.700,0.800,0.900,1.000, &
       .000,0.100,0.200,0.300,0.400,0.500,0.600,0.700,0.800,0.900,1.000, &
       .000,0.100,0.200,0.300,0.400,0.500,0.600,0.700,0.800,0.900,1.000, &
       .000,0.100,0.199,0.298,0.398,0.498,0.598,0.698,0.798,0.899,1.000, &
       .000,0.098,0.196,0.294,0.392,0.491,0.590,0.691,0.793,0.896,1.000, &
       .000,0.092,0.185,0.278,0.374,0.470,0.570,0.671,0.777,0.886,1.000, &
       .000,0.081,0.162,0.246,0.333,0.424,0.521,0.625,0.738,0.862,1.000, &
       .000,0.063,0.128,0.196,0.270,0.349,0.438,0.540,0.661,0.809,1.000, &
       .000,0.046,0.094,0.146,0.202,0.264,0.337,0.426,0.542,0.710,1.000/ 
      data ((caib(11,i,j),j=1,11),i=1,9)/ &
       .000,0.101,0.202,0.302,0.402,0.502,0.602,0.702,0.802,0.901,1.000, &
       .000,0.102,0.202,0.303,0.404,0.504,0.604,0.703,0.802,0.902,1.000, &
       .000,0.102,0.205,0.306,0.406,0.506,0.606,0.706,0.804,0.902,1.000, &
       .000,0.104,0.207,0.309,0.410,0.510,0.609,0.707,0.805,0.902,1.000, &
       .000,0.106,0.208,0.309,0.409,0.508,0.606,0.705,0.803,0.902,1.000, &
       .000,0.102,0.202,0.298,0.395,0.493,0.590,0.690,0.790,0.894,1.000, &
       .000,0.091,0.179,0.267,0.357,0.449,0.545,0.647,0.755,0.872,1.000, &
       .000,0.073,0.142,0.214,0.290,0.372,0.462,0.563,0.681,0.822,1.000, &
       .000,0.053,0.104,0.158,0.217,0.281,0.356,0.446,0.562,0.726,1.000/
      data ((caif(i,j),j=1,11),i=1,9)/ &
       .000,0.099,0.198,0.297,0.397,0.496,0.597,0.697,0.798,0.899,1.000, &
       .000,0.098,0.196,0.294,0.394,0.494,0.594,0.694,0.796,0.898,1.000, &
       .000,0.096,0.192,0.290,0.388,0.487,0.587,0.689,0.792,0.895,1.000, &
       .000,0.092,0.185,0.280,0.376,0.476,0.576,0.678,0.783,0.890,1.000, &
       .000,0.085,0.173,0.263,0.357,0.454,0.555,0.659,0.768,0.881,1.000, &
       .000,0.076,0.154,0.237,0.324,0.418,0.517,0.624,0.738,0.864,1.000, &
       .000,0.063,0.131,0.203,0.281,0.366,0.461,0.567,0.688,0.830,1.000, &
       .000,0.052,0.107,0.166,0.232,0.305,0.389,0.488,0.610,0.770,1.000, &
       .000,0.043,0.088,0.136,0.189,0.248,0.317,0.400,0.510,0.675,1.000/

!-----clouds within each of the high, middle, and low clouds are assumed
!     to be maximally overlapped, and the cloud cover (cc) for a group
!     (high, middle, or low) is the maximum cloud cover of all the layers
!     within a group

      do j=1,n
       do i=1,m
         cc(i,j,1)=0.0
         cc(i,j,2)=0.0
         cc(i,j,3)=0.0
       enddo
      enddo
      do j=1,n
       do i=1,m
        do k=1,ict(i,j)-1
          cc(i,j,1)=max(cc(i,j,1),fcld(i,j,k))
        enddo
       enddo
      enddo

      do j=1,n
       do i=1,m
        do k=ict(i,j),icb(i,j)-1
          cc(i,j,2)=max(cc(i,j,2),fcld(i,j,k))
        enddo
       enddo
      enddo

      do j=1,n
       do i=1,m
        do k=icb(i,j),np
          cc(i,j,3)=max(cc(i,j,3),fcld(i,j,k))
        enddo
       enddo
      enddo

!-----scale the cloud optical thickness.
!     taucld(i,j,k,1) is the optical thickness for ice particles, and
!     taucld(i,j,k,2) is the optical thickness for liquid particles.
      
      do j=1,n
       do i=1,m

        do k=1,np

         if(k.lt.ict(i,j)) then
            kk=1
         elseif(k.ge.ict(i,j) .and. k.lt.icb(i,j)) then
            kk=2
         else
            kk=3
         endif

         tauclb(i,j,k) = 0.0
         tauclf(i,j,k) = 0.0

         taux=taucld(i,j,k,1)+taucld(i,j,k,2)
         if (taux.gt.0.05 .and. fcld(i,j,k).gt.0.01) then

!-----normalize cloud cover

           fa=fcld(i,j,k)/cc(i,j,kk)

!-----table look-up

           taux=min(taux,32.)

           fm=cosz(i,j)/dm
           ft=(log10(taux)-t1)/dt
           fa=fa/da
 
           im=int(fm+1.5)
           it=int(ft+1.5)
           ia=int(fa+1.5)
  
           im=max(im,2)
           it=max(it,2)
           ia=max(ia,2)
     
           im=min(im,nm-1)
           it=min(it,nt-1)
           ia=min(ia,na-1)

           fm=fm-float(im-1)
           ft=ft-float(it-1)
           fa=fa-float(ia-1)

!-----scale cloud optical thickness for beam radiation.
!     the scaling factor, xai, is a function of the solar zenith
!     angle, optical thickness, and cloud cover.
 
           xai=    (-caib(im-1,it,ia)*(1.-fm)+ &
            caib(im+1,it,ia)*(1.+fm))*fm*.5+caib(im,it,ia)*(1.-fm*fm)
         
           xai=xai+(-caib(im,it-1,ia)*(1.-ft)+ &
            caib(im,it+1,ia)*(1.+ft))*ft*.5+caib(im,it,ia)*(1.-ft*ft)

           xai=xai+(-caib(im,it,ia-1)*(1.-fa)+ &
           caib(im,it,ia+1)*(1.+fa))*fa*.5+caib(im,it,ia)*(1.-fa*fa)

           xai= xai-2.*caib(im,it,ia)
           xai=max(xai,0.0)
     
           tauclb(i,j,k) = taux*xai

!-----scale cloud optical thickness for diffuse radiation.
!     the scaling factor, xai, is a function of the cloud optical
!     thickness and cover but not the solar zenith angle.

           xai=    (-caif(it-1,ia)*(1.-ft)+ &
            caif(it+1,ia)*(1.+ft))*ft*.5+caif(it,ia)*(1.-ft*ft)

           xai=xai+(-caif(it,ia-1)*(1.-fa)+ &
            caif(it,ia+1)*(1.+fa))*fa*.5+caif(it,ia)*(1.-fa*fa)

           xai= xai-caif(it,ia)
           xai=max(xai,0.0)
     
           tauclf(i,j,k) = taux*xai

         endif

        enddo
       enddo
      enddo

      end subroutine cldscale

!*********************************************************************

      subroutine deledd(tau,ssc,g0,csm,rr,tt,td)

!*********************************************************************
!
!-----uses the delta-eddington approximation to compute the
!     bulk scattering properties of a single layer
!     coded following King and Harshvardhan (JAS, 1986)
!
!  inputs:
!
!     tau: the effective optical thickness
!     ssc: the effective single scattering albedo
!     g0:  the effective asymmetry factor
!     csm: the effective secant of the zenith angle
!
!  outputs:
!
!     rr: the layer reflection of the direct beam
!     tt: the layer diffuse transmission of the direct beam
!     td: the layer direct transmission of the direct beam
!
!*********************************************************************
      implicit none
!*********************************************************************

      real zero,one,two,three,four,fourth,seven,thresh
      parameter (one =1., three=3.)
      parameter (two =2., seven=7.)
      parameter (four=4., fourth=.25)
      parameter (zero=0., thresh=1.e-8)

!-----input parameters
      real tau,ssc,g0,csm

!-----output parameters
      real rr,tt,td

!-----temporary parameters

      real zth,ff,xx,taup,sscp,gp,gm1,gm2,gm3,akk,alf1,alf2, &
           all,bll,st7,st8,cll,dll,fll,ell,st1,st2,st3,st4
 
!---------------------------------------------------------------------

                zth = one / csm
 
!  delta-eddington scaling of single scattering albedo,
!  optical thickness, and asymmetry factor,
!  K & H eqs(27-29)

                ff  = g0*g0
                xx  = one-ff*ssc
                taup= tau*xx
                sscp= ssc*(one-ff)/xx
                gp  = g0/(one+g0)
 
!  gamma1, gamma2, and gamma3. see table 2 and eq(26) K & H
!  ssc and gp are the d-s single scattering
!  albedo and asymmetry factor.

                xx  =  three*gp 
                gm1 =  (seven - sscp*(four+xx))*fourth
                gm2 = -(one   - sscp*(four-xx))*fourth
 
!  akk is k as defined in eq(25) of K & H
 
                akk = sqrt((gm1+gm2)*(gm1-gm2))
 
                xx  = akk * zth
                st7 = one - xx
                st8 = one + xx
                st3 = st7 * st8

                if (abs(st3) .lt. thresh) then
                    zth = zth + 0.001
                    xx  = akk * zth
                    st7 = one - xx
                    st8 = one + xx
                    st3 = st7 * st8
                endif

!  extinction of the direct beam transmission
 
                td  = exp(-taup/zth)

!  alf1 and alf2 are alpha1 and alpha2 from eqs (23) & (24) of K & H
 
                gm3  = (two - zth*three*gp)*fourth
                xx   = gm1 - gm2
                alf1 = gm1 - gm3 * xx
                alf2 = gm2 + gm3 * xx
 
!  all is last term in eq(21) of K & H
!  bll is last term in eq(22) of K & H
 
                xx  = akk * two
                all = (gm3 - alf2 * zth    )*xx*td
                bll = (one - gm3 + alf1*zth)*xx
 
                xx  = akk * gm3
                cll = (alf2 + xx) * st7
                dll = (alf2 - xx) * st8
 
                xx  = akk * (one-gm3)
                fll = (alf1 + xx) * st8
                ell = (alf1 - xx) * st7
  
                st2 = exp(-akk*taup)
                st4 = st2 * st2
 
                st1 =  sscp / ((akk+gm1 + (akk-gm1)*st4) * st3)
 
!  rr is r-hat of eq(21) of K & H
!  tt is diffuse part of t-hat of eq(22) of K & H
 
                rr =   ( cll-dll*st4    -all*st2)*st1
                tt = - ((fll-ell*st4)*td-bll*st2)*st1
 
                rr = max(rr,zero)
                tt = max(tt,zero)

      end subroutine deledd

!*********************************************************************

      subroutine sagpol(tau,ssc,g0,rll,tll)

!*********************************************************************
!-----transmittance (tll) and reflectance (rll) of diffuse radiation
!     follows Sagan and Pollock (JGR, 1967).
!     also, eq.(31) of Lacis and Hansen (JAS, 1974).
!
!-----input parameters:
!
!      tau: the effective optical thickness
!      ssc: the effective single scattering albedo
!      g0:  the effective asymmetry factor
!
!-----output parameters:
!
!      rll: the layer reflection of diffuse radiation
!      tll: the layer transmission of diffuse radiation
!
!*********************************************************************
      implicit none
!*********************************************************************

      real one,three,four
      parameter (one=1., three=3., four=4.)

!-----output parameters:

      real tau,ssc,g0

!-----output parameters:

      real rll,tll

!-----temporary arrays

      real xx,uuu,ttt,emt,up1,um1,st1

             xx  = one-ssc*g0
             uuu = sqrt( xx/(one-ssc))
             ttt = sqrt( xx*(one-ssc)*three )*tau
             emt = exp(-ttt)
             up1 = uuu + one
             um1 = uuu - one
             xx  = um1*emt
             st1 = one / ((up1+xx) * (up1-xx))
             rll = up1*um1*(one-emt*emt)*st1
             tll = uuu*four*emt         *st1

      end subroutine sagpol

!*******************************************************************

      subroutine cldflx (m,n,np,ict,icb,overcast,cc,rr,tt,td,rs,ts,&
                 fclr,fall,fallu,falld,fsdir,fsdif)

!*******************************************************************
!  compute upward and downward fluxes using a two-stream adding method
!  following equations (3)-(5) of Chou (1992, JAS).
!
!  clouds are grouped into high, middle, and low clouds which are 
!  assumed randomly overlapped. It involves eight sets of calculations.
!  In each set of calculations, each atmospheric layer is homogeneous,
!  either totally filled with clouds or without clouds.

!  input parameters:
!
!     m:   number of soundings in zonal direction
!     n:   number of soundings in meridional direction
!     np:  number of atmospheric layers
!     ict: the level separating high and middle clouds
!     icb: the level separating middle and low clouds
!     cc:  effective cloud covers for high, middle and low clouds
!     tt:  diffuse transmission of a layer illuminated by beam radiation
!     td:  direct beam tranmssion
!     ts:  transmission of a layer illuminated by diffuse radiation
!     rr:  reflection of a layer illuminated by beam radiation
!     rs:  reflection of a layer illuminated by diffuse radiation
!
!  output parameters:
!
!     fclr:  clear-sky flux (downward minus upward)
!     fall:  all-sky flux (downward minus upward)
!     fsdir: surface direct downward flux
!     fsdif: surface diffuse downward flux
!
!*********************************************************************c
      implicit none
!*********************************************************************c

!-----input parameters

      integer m,n,np
      integer ict(m,n),icb(m,n)

      real rr(m,n,np+1,2),tt(m,n,np+1,2),td(m,n,np+1,2)
      real rs(m,n,np+1,2),ts(m,n,np+1,2)
      real cc(m,n,3)
      logical overcast

!-----temporary array

      integer i,j,k,ih,im,is,itm
      real rra(m,n,np+1,2,2),tta(m,n,np+1,2,2),tda(m,n,np+1,2,2)
      real rsa(m,n,np+1,2,2),rxa(m,n,np+1,2,2)
      real ch(m,n),cm(m,n),ct(m,n),flxdn(m,n,np+1)
      real flxdnu(m,n,np+1),flxdnd(m,n,np+1)
      real fdndir(m,n),fdndif(m,n),fupdif
      real denm,xx

!-----output parameters

      real fclr(m,n,np+1),fall(m,n,np+1)
      real fallu(m,n,np+1),falld(m,n,np+1)
      real fsdir(m,n),fsdif(m,n)

!-----initialize all-sky flux (fall) and surface downward fluxes

      do k=1,np+1
       do j=1,n
        do i=1,m
           fclr(i,j,k)=0.0
           fall(i,j,k)=0.0
           fallu(i,j,k)=0.0
           falld(i,j,k)=0.0
        enddo
       enddo
      enddo

       do j=1,n
        do i=1,m
           fsdir(i,j)=0.0
           fsdif(i,j)=0.0
        enddo
       enddo

!-----compute transmittances and reflectances for a composite of
!     layers. layers are added one at a time, going down from the top.
!     tda is the composite transmittance illuminated by beam radiation
!     tta is the composite diffuse transmittance illuminated by
!         beam radiation
!     rsa is the composite reflectance illuminated from below
!         by diffuse radiation
!     tta and rsa are computed from eqs. (4b) and (3b) of Chou

      itm=1

!-----if overcas.=.true., set itm=2, and only one set of fluxes is computed

      if (overcast) itm=2

!-----for high clouds. indices 1 and 2 denote clear and cloudy
!     situations, respectively.

      do 10 ih=itm,2

       do j= 1, n
        do i= 1, m
          tda(i,j,1,ih,1)=td(i,j,1,ih)
          tta(i,j,1,ih,1)=tt(i,j,1,ih)
          rsa(i,j,1,ih,1)=rs(i,j,1,ih)
          tda(i,j,1,ih,2)=td(i,j,1,ih)
          tta(i,j,1,ih,2)=tt(i,j,1,ih)
          rsa(i,j,1,ih,2)=rs(i,j,1,ih)
        enddo
       enddo

       do j= 1, n
        do i= 1, m
         do k= 2, ict(i,j)-1
          denm = ts(i,j,k,ih)/( 1.-rsa(i,j,k-1,ih,1)*rs(i,j,k,ih))
          tda(i,j,k,ih,1)= tda(i,j,k-1,ih,1)*td(i,j,k,ih)
          tta(i,j,k,ih,1)= tda(i,j,k-1,ih,1)*tt(i,j,k,ih) &
                        +(tda(i,j,k-1,ih,1)*rr(i,j,k,ih)  &
                        *rsa(i,j,k-1,ih,1)+tta(i,j,k-1,ih,1))*denm
          rsa(i,j,k,ih,1)= rs(i,j,k,ih)+ts(i,j,k,ih) &
                        *rsa(i,j,k-1,ih,1)*denm
          tda(i,j,k,ih,2)= tda(i,j,k,ih,1)
          tta(i,j,k,ih,2)= tta(i,j,k,ih,1)
          rsa(i,j,k,ih,2)= rsa(i,j,k,ih,1)
         enddo
        enddo
       enddo

!-----for middle clouds

      do 10 im=itm,2

      do j= 1, n
       do i= 1, m
        do k= ict(i,j), icb(i,j)-1
          denm = ts(i,j,k,im)/( 1.-rsa(i,j,k-1,ih,im)*rs(i,j,k,im))
          tda(i,j,k,ih,im)= tda(i,j,k-1,ih,im)*td(i,j,k,im)
          tta(i,j,k,ih,im)= tda(i,j,k-1,ih,im)*tt(i,j,k,im) &
                        +(tda(i,j,k-1,ih,im)*rr(i,j,k,im)   &
                        *rsa(i,j,k-1,ih,im)+tta(i,j,k-1,ih,im))*denm
          rsa(i,j,k,ih,im)= rs(i,j,k,im)+ts(i,j,k,im)  &
                        *rsa(i,j,k-1,ih,im)*denm
         enddo
        enddo
       enddo

  10  continue

!-----layers are added one at a time, going up from the surface.
!     rra is the composite reflectance illuminated by beam radiation
!     rxa is the composite reflectance illuminated from above
!         by diffuse radiation
!     rra and rxa are computed from eqs. (4a) and (3a) of Chou
 
!-----for the low clouds

      do 20 is=itm,2

       do j= 1, n
        do i= 1, m
         rra(i,j,np+1,1,is)=rr(i,j,np+1,is)
         rxa(i,j,np+1,1,is)=rs(i,j,np+1,is)
         rra(i,j,np+1,2,is)=rr(i,j,np+1,is)
         rxa(i,j,np+1,2,is)=rs(i,j,np+1,is)
        enddo
       enddo

       do j= 1, n
        do i= 1, m
         do k=np,icb(i,j),-1
          denm=ts(i,j,k,is)/( 1.-rs(i,j,k,is)*rxa(i,j,k+1,1,is) )
          rra(i,j,k,1,is)=rr(i,j,k,is)+(td(i,j,k,is) &
              *rra(i,j,k+1,1,is)+tt(i,j,k,is)*rxa(i,j,k+1,1,is))*denm
          rxa(i,j,k,1,is)= rs(i,j,k,is)+ts(i,j,k,is) &
              *rxa(i,j,k+1,1,is)*denm
          rra(i,j,k,2,is)=rra(i,j,k,1,is)
          rxa(i,j,k,2,is)=rxa(i,j,k,1,is)
         enddo
        enddo
       enddo

!-----for middle clouds

      do 20 im=itm,2

       do j= 1, n
        do i= 1, m
         do k= icb(i,j)-1,ict(i,j),-1
          denm=ts(i,j,k,im)/( 1.-rs(i,j,k,im)*rxa(i,j,k+1,im,is) )
          rra(i,j,k,im,is)= rr(i,j,k,im)+(td(i,j,k,im)  &
              *rra(i,j,k+1,im,is)+tt(i,j,k,im)*rxa(i,j,k+1,im,is))*denm
          rxa(i,j,k,im,is)= rs(i,j,k,im)+ts(i,j,k,im)   &
              *rxa(i,j,k+1,im,is)*denm
         enddo
        enddo
       enddo

  20  continue

!-----integration over eight sky situations.
!     ih, im, is denotes high, middle and low cloud groups.

      do 100 ih=itm,2

!-----clear portion 

         if(ih.eq.1) then
           do j=1,n
            do i=1,m
             ch(i,j)=1.0-cc(i,j,1)
            enddo
           enddo

          else

!-----cloudy portion

           do j=1,n
            do i=1,m
             ch(i,j)=cc(i,j,1)
            enddo
           enddo

          endif

      do 100 im=itm,2

!-----clear portion

         if(im.eq.1) then

           do j=1,n
            do i=1,m
              cm(i,j)=ch(i,j)*(1.0-cc(i,j,2))
            enddo
           enddo

         else

!-----cloudy portion

           do j=1,n
            do i=1,m
              cm(i,j)=ch(i,j)*cc(i,j,2) 
            enddo
           enddo

         endif

      do 100 is=itm,2

!-----clear portion

         if(is.eq.1) then

           do j=1,n
            do i=1,m
             ct(i,j)=cm(i,j)*(1.0-cc(i,j,3)) 
            enddo
           enddo

         else

!-----cloudy portion

           do j=1,n
            do i=1,m
             ct(i,j)=cm(i,j)*cc(i,j,3)
            enddo
           enddo

         endif

!-----add one layer at a time, going down.

       do j= 1, n
        do i= 1, m
         do k= icb(i,j), np
          denm = ts(i,j,k,is)/( 1.-rsa(i,j,k-1,ih,im)*rs(i,j,k,is) )
          tda(i,j,k,ih,im)= tda(i,j,k-1,ih,im)*td(i,j,k,is)
          tta(i,j,k,ih,im)=  tda(i,j,k-1,ih,im)*tt(i,j,k,is) &
               +(tda(i,j,k-1,ih,im)*rr(i,j,k,is) &
               *rsa(i,j,k-1,ih,im)+tta(i,j,k-1,ih,im))*denm
          rsa(i,j,k,ih,im)= rs(i,j,k,is)+ts(i,j,k,is) &
               *rsa(i,j,k-1,ih,im)*denm
         enddo
        enddo
       enddo

!-----add one layer at a time, going up.

       do j= 1, n
        do i= 1, m
         do k= ict(i,j)-1,1,-1
          denm =ts(i,j,k,ih)/(1.-rs(i,j,k,ih)*rxa(i,j,k+1,im,is))
          rra(i,j,k,im,is)= rr(i,j,k,ih)+(td(i,j,k,ih)  &
              *rra(i,j,k+1,im,is)+tt(i,j,k,ih)*rxa(i,j,k+1,im,is))*denm
          rxa(i,j,k,im,is)= rs(i,j,k,ih)+ts(i,j,k,ih)   &
              *rxa(i,j,k+1,im,is)*denm
         enddo
        enddo
       enddo

!-----compute fluxes following eq (5) of Chou (1992)
 
!     fdndir is the direct  downward flux
!     fdndif is the diffuse downward flux
!     fupdif is the diffuse upward flux

      do k=2,np+1
       do j=1, n
        do i=1, m
         denm= 1./(1.- rxa(i,j,k,im,is)*rsa(i,j,k-1,ih,im))
         fdndir(i,j)= tda(i,j,k-1,ih,im)
         xx = tda(i,j,k-1,ih,im)*rra(i,j,k,im,is)
         fdndif(i,j)= (xx*rsa(i,j,k-1,ih,im)+tta(i,j,k-1,ih,im))*denm
         fupdif= (xx+tta(i,j,k-1,ih,im)*rxa(i,j,k,im,is))*denm
         flxdn(i,j,k)=fdndir(i,j)+fdndif(i,j)-fupdif
         flxdnu(i,j,k)=-fupdif
         flxdnd(i,j,k)=fdndir(i,j)+fdndif(i,j)
        enddo
       enddo
      enddo

       do j=1, n
        do i=1, m
         flxdn(i,j,1)=1.0-rra(i,j,1,im,is)
         flxdnu(i,j,1)=-rra(i,j,1,im,is)
         flxdnd(i,j,1)=1.0
        enddo
       enddo

!-----summation of fluxes over all (eight) sky situations.

       do k=1,np+1
        do j=1,n
         do i=1,m
           if(ih.eq.1 .and. im.eq.1 .and. is.eq.1) then
             fclr(i,j,k)=flxdn(i,j,k)
           endif
             fall(i,j,k)=fall(i,j,k)+flxdn(i,j,k)*ct(i,j)
             fallu(i,j,k)=fallu(i,j,k)+flxdnu(i,j,k)*ct(i,j)
             falld(i,j,k)=falld(i,j,k)+flxdnd(i,j,k)*ct(i,j)
         enddo
        enddo
       enddo

        do j=1,n
         do i=1,m
            fsdir(i,j)=fsdir(i,j)+fdndir(i,j)*ct(i,j)
            fsdif(i,j)=fsdif(i,j)+fdndif(i,j)*ct(i,j)
         enddo
        enddo

  100 continue

      end subroutine cldflx

!*****************************************************************

      subroutine flxco2(m,n,np,swc,swh,csm,df)

!*****************************************************************

!-----compute the reduction of clear-sky downward solar flux
!     due to co2 absorption.

      implicit none

!-----input parameters

      integer m,n,np
      real csm(m,n),swc(m,n,np+1),swh(m,n,np+1),cah(22,19)

!-----output (undated) parameter

      real df(m,n,np+1)

!-----temporary array

      integer i,j,k,ic,iw 
      real xx,clog,wlog,dc,dw,x1,x2,y2

!********************************************************************
!-----include co2 look-up table

      data ((cah(i,j),i=1,22),j= 1, 5)/ &                                     
       0.9923, 0.9922, 0.9921, 0.9920, 0.9916, 0.9910, 0.9899, 0.9882, &      
       0.9856, 0.9818, 0.9761, 0.9678, 0.9558, 0.9395, 0.9188, 0.8945, &      
       0.8675, 0.8376, 0.8029, 0.7621, 0.7154, 0.6647, 0.9876, 0.9876, &      
       0.9875, 0.9873, 0.9870, 0.9864, 0.9854, 0.9837, 0.9811, 0.9773, &      
       0.9718, 0.9636, 0.9518, 0.9358, 0.9153, 0.8913, 0.8647, 0.8350, &      
       0.8005, 0.7599, 0.7133, 0.6627, 0.9808, 0.9807, 0.9806, 0.9805, &      
       0.9802, 0.9796, 0.9786, 0.9769, 0.9744, 0.9707, 0.9653, 0.9573, &      
       0.9459, 0.9302, 0.9102, 0.8866, 0.8604, 0.8311, 0.7969, 0.7565, &      
       0.7101, 0.6596, 0.9708, 0.9708, 0.9707, 0.9705, 0.9702, 0.9697, &      
       0.9687, 0.9671, 0.9647, 0.9612, 0.9560, 0.9483, 0.9372, 0.9221, &      
       0.9027, 0.8798, 0.8542, 0.8253, 0.7916, 0.7515, 0.7054, 0.6551, &      
       0.9568, 0.9568, 0.9567, 0.9565, 0.9562, 0.9557, 0.9548, 0.9533, &      
       0.9510, 0.9477, 0.9428, 0.9355, 0.9250, 0.9106, 0.8921, 0.8700, &      
       0.8452, 0.8171, 0.7839, 0.7443, 0.6986, 0.6486/                        
 
      data ((cah(i,j),i=1,22),j= 6,10)/  &                                    
       0.9377, 0.9377, 0.9376, 0.9375, 0.9372, 0.9367, 0.9359, 0.9345, &      
       0.9324, 0.9294, 0.9248, 0.9181, 0.9083, 0.8948, 0.8774, 0.8565, &      
       0.8328, 0.8055, 0.7731, 0.7342, 0.6890, 0.6395, 0.9126, 0.9126, &      
       0.9125, 0.9124, 0.9121, 0.9117, 0.9110, 0.9098, 0.9079, 0.9052, &      
       0.9012, 0.8951, 0.8862, 0.8739, 0.8579, 0.8385, 0.8161, 0.7900, &      
       0.7585, 0.7205, 0.6760, 0.6270, 0.8809, 0.8809, 0.8808, 0.8807, &      
       0.8805, 0.8802, 0.8796, 0.8786, 0.8770, 0.8747, 0.8712, 0.8659, &      
       0.8582, 0.8473, 0.8329, 0.8153, 0.7945, 0.7697, 0.7394, 0.7024, &      
       0.6588, 0.6105, 0.8427, 0.8427, 0.8427, 0.8426, 0.8424, 0.8422, &      
       0.8417, 0.8409, 0.8397, 0.8378, 0.8350, 0.8306, 0.8241, 0.8148, &      
       0.8023, 0.7866, 0.7676, 0.7444, 0.7154, 0.6796, 0.6370, 0.5897, &      
       0.7990, 0.7990, 0.7990, 0.7989, 0.7988, 0.7987, 0.7983, 0.7978, &      
       0.7969, 0.7955, 0.7933, 0.7899, 0.7846, 0.7769, 0.7664, 0.7528, &      
       0.7357, 0.7141, 0.6866, 0.6520, 0.6108, 0.5646/                        
 
      data ((cah(i,j),i=1,22),j=11,15)/  &                                    
       0.7515, 0.7515, 0.7515, 0.7515, 0.7514, 0.7513, 0.7511, 0.7507, &      
       0.7501, 0.7491, 0.7476, 0.7450, 0.7409, 0.7347, 0.7261, 0.7144, &      
       0.6992, 0.6793, 0.6533, 0.6203, 0.5805, 0.5357, 0.7020, 0.7020, &      
       0.7020, 0.7019, 0.7019, 0.7018, 0.7017, 0.7015, 0.7011, 0.7005, &      
       0.6993, 0.6974, 0.6943, 0.6894, 0.6823, 0.6723, 0.6588, 0.6406, &      
       0.6161, 0.5847, 0.5466, 0.5034, 0.6518, 0.6518, 0.6518, 0.6518, &      
       0.6518, 0.6517, 0.6517, 0.6515, 0.6513, 0.6508, 0.6500, 0.6485, &      
       0.6459, 0.6419, 0.6359, 0.6273, 0.6151, 0.5983, 0.5755, 0.5458, &      
       0.5095, 0.4681, 0.6017, 0.6017, 0.6017, 0.6017, 0.6016, 0.6016, &      
       0.6016, 0.6015, 0.6013, 0.6009, 0.6002, 0.5989, 0.5967, 0.5932, &      
       0.5879, 0.5801, 0.5691, 0.5535, 0.5322, 0.5043, 0.4700, 0.4308, &      
       0.5518, 0.5518, 0.5518, 0.5518, 0.5518, 0.5518, 0.5517, 0.5516, &      
       0.5514, 0.5511, 0.5505, 0.5493, 0.5473, 0.5441, 0.5393, 0.5322, &      
       0.5220, 0.5076, 0.4878, 0.4617, 0.4297, 0.3929/                        
 
      data ((cah(i,j),i=1,22),j=16,19)/ &                                     
       0.5031, 0.5031, 0.5031, 0.5031, 0.5031, 0.5030, 0.5030, 0.5029, &      
       0.5028, 0.5025, 0.5019, 0.5008, 0.4990, 0.4960, 0.4916, 0.4850, &      
       0.4757, 0.4624, 0.4441, 0.4201, 0.3904, 0.3564, 0.4565, 0.4565, &      
       0.4565, 0.4564, 0.4564, 0.4564, 0.4564, 0.4563, 0.4562, 0.4559, &      
       0.4553, 0.4544, 0.4527, 0.4500, 0.4460, 0.4400, 0.4315, 0.4194, &      
       0.4028, 0.3809, 0.3538, 0.3227, 0.4122, 0.4122, 0.4122, 0.4122, &      
       0.4122, 0.4122, 0.4122, 0.4121, 0.4120, 0.4117, 0.4112, 0.4104, &      
       0.4089, 0.4065, 0.4029, 0.3976, 0.3900, 0.3792, 0.3643, 0.3447, &      
       0.3203, 0.2923, 0.3696, 0.3696, 0.3696, 0.3696, 0.3696, 0.3696, &      
       0.3695, 0.3695, 0.3694, 0.3691, 0.3687, 0.3680, 0.3667, 0.3647, &      
       0.3615, 0.3570, 0.3504, 0.3409, 0.3279, 0.3106, 0.2892, 0.2642/        

!********************************************************************
!-----table look-up for the reduction of clear-sky solar
!     radiation due to co2. The fraction 0.0343 is the
!     extraterrestrial solar flux in the co2 bands.

      do k= 2, np+1
       do j= 1, n
        do i= 1, m
          xx=1./.3
          clog=log10(swc(i,j,k)*csm(i,j))
          wlog=log10(swh(i,j,k)*csm(i,j))
          ic=int( (clog+3.15)*xx+1.)
          iw=int( (wlog+4.15)*xx+1.)
          if(ic.lt.2)ic=2
          if(iw.lt.2)iw=2
          if(ic.gt.22)ic=22
          if(iw.gt.19)iw=19     
          dc=clog-float(ic-2)*.3+3.
          dw=wlog-float(iw-2)*.3+4.   
          x1=cah(1,iw-1)+(cah(1,iw)-cah(1,iw-1))*xx*dw
          x2=cah(ic-1,iw-1)+(cah(ic-1,iw)-cah(ic-1,iw-1))*xx*dw
          y2=x2+(cah(ic,iw-1)-cah(ic-1,iw-1))*xx*dc
          if (x1.lt.y2) x1=y2
          df(i,j,k)=df(i,j,k)+0.0343*(x1-y2)
        enddo     
       enddo      
      enddo      

      end subroutine flxco2

!*****************************************************************

      subroutine o3prof (np, pres, ozone, its, ite, kts, kte, p, o3)

!*****************************************************************
      implicit none
!*****************************************************************
!
      integer iprof,m,np,its,ite,kts,kte
      integer i,k,ko,kk
      real pres(np),ozone(np)
      real p(its:ite,kts:kte),o3(its:ite,kts:kte)
 
!     Statement function 
 
      real Linear, x1, y1, x2, y2, x
      Linear(x1, y1, x2, y2, x) =  &
            (y1 * (x2 - x) + y2 * (x - x1)) / (x2 - x1)
!
      do k = 1,np
        pres(k) = alog(pres(k))
      enddo
      do k = kts,kte
        do i = its, ite
          p(i,k) = alog(p(i,k))
        end do
      end do

! assume the pressure at model top is greater than pres(1)
! if it is not, this part needs to change

      do i = its, ite
        ko = 1
        do k = kts+1, kte
          do while (ko .lt. np .and. p(i,k) .gt. pres(ko))
            ko = ko + 1
          end do
          o3(i,k) =  Linear (pres(ko),   ozone(ko),    &
                             pres(ko-1), ozone(ko-1),  &
                             p(i,k))
          ko = ko - 1
        end do
      end do

! calculate top lay O3

      do i = its, ite
        ko = 1
        k = kts
        do while (ko .le. np .and. p(i,k) .gt. pres(ko))
           ko = ko + 1
        end do
        IF (ko-1 .le. 1) then
           O3(i,k)=ozone(k)
        ELSE
           O3(i,k)=0.
           do kk=ko-2,1,-1
              O3(i,k)=O3(i,k)+ozone(kk)*(pres(kk+1)-pres(kk))
           enddo
           O3(i,k)=O3(i,k)/(pres(ko-1)-pres(1))
        ENDIF
!       print*,'O3=',i,k,ko,O3(i,k),p(i,k),ko,pres(ko),pres(ko-1)
      end do
      
      end subroutine o3prof

!-----------------------------------------
    SUBROUTINE gsfc_swinit(cen_lat, allowed_to_read)

    REAL, INTENT(IN    )      ::        cen_lat
    LOGICAL, INTENT(IN    )   ::       allowed_to_read

        center_lat=cen_lat

    END SUBROUTINE gsfc_swinit
!-----------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!*********************  THE RRTM LONGWAVE PACKAGE **********************
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!-----------------------------------------------------------------------
   SUBROUTINE RRTMLWRAD(rthraten,glw,emiss                        &
                       ,p8w,p3d,pi3d                              &
                       ,dz8w,t3d,t8w,rho3d,r,g                    &
                       ,icloud, warm_rain                         &
                       ,ids,ide, jds,jde, kds,kde                 & 
                       ,ims,ime, jms,jme, kms,kme                 &
                       ,its,ite, jts,jte, kts,kte                 &
                       ,qv3d,qc3d,qr3d                            &
                       ,qi3d,qs3d,qg3d,cldfra3d                   &
                       ,f_qv,f_qc,f_qr,f_qi,f_qs,f_qg             &
                                                                  )
!------------------------------------------------------------------
   IMPLICIT NONE
!------------------------------------------------------------------
   LOGICAL, INTENT(IN )      ::        warm_rain
!
   INTEGER, INTENT(IN )      ::        ids,ide, jds,jde, kds,kde, &
                                       ims,ime, jms,jme, kms,kme, &
                                       its,ite, jts,jte, kts,kte

   INTEGER, INTENT(IN )      ::        ICLOUD
!
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme )                 , &
         INTENT(IN   ) ::                                   dz8w, &
                                                             T3D, &
                                                             t8w, &
                                                             p8w, &
                                                             P3D, &
                                                            pi3D, &
                                                           rho3D
!
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme )                 , &
         INTENT(INOUT)  ::                              RTHRATEN
!
   REAL, DIMENSION( ims:ime, jms:jme )                          , &
         INTENT(IN   )  ::                                 EMISS
!
   REAL, DIMENSION( ims:ime, jms:jme )                          , &
         INTENT(INOUT)  ::                                   GLW
!
   REAL, INTENT(IN  )   ::                                   R,G
!
! Optional
!
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme )                 , &
         OPTIONAL                                               , &
         INTENT(IN   ) ::                                         &
                                                        CLDFRA3D, &
                                                            QV3D, &
                                                            QC3D, &
                                                            QR3D, &
                                                            QI3D, &
                                                            QS3D, &
                                                            QG3D

   LOGICAL, OPTIONAL, INTENT(IN )      ::        F_QV,F_QC,F_QR,F_QI,F_QS,F_QG

!  LOCAL VARS
 
   REAL, DIMENSION( kts:kte+1 ) ::                          Pw1D, &
                                                            Tw1D, &
                                                            PHYD

   REAL, DIMENSION( kts:kte ) ::                          TTEN1D, &
                                                        CLDFRA1D, &
                                                            DZ1D, &
                                                             P1D, &
                                                         PHYDMID, &
                                                             T1D, &
                                                            QV1D, &
                                                            QC1D, &
                                                            QR1D, &
                                                            QI1D, &
                                                            QS1D, &
                                                            QG1D
!
    REAL   ::                                   TSFC,GLW0,EMISS0,FP
!
    INTEGER:: i,j,K,NK
    LOGICAL :: predicate

!------------------------------------------------------------------
      write(0,*)' enter RRTM'

!-----CALCULATE LONG WAVE RADIATION
!                                                              
   j_loop: DO J=jts,jte
   i_loop: DO I=its,ite

! reverse vars 
! p1D pw1D are in mb

! NEED HYDROSTATIC PRESSURE HERE (MONOTONIC CHANGE WITH HEIGHT)
! PHYD REPLACES P8W, PHYDMID REPLACES P3D
         PHYD(kts) = p8w(I,kts,J)
! first guess
         DO K = KTS,KTE
            PHYD(K+1) = PHYD(K) - G*RHO3D(I,K,J)*DZ8W(I,K,J)
         ENDDO
! correction factor FP to match p8w(I,kts,J)-p8w(I,kte,J)
         FP = (p8w(I,kts,J)-p8w(I,kte,J))/(PHYD(KTS)-PHYD(KTE))
! final pass
         DO K = KTS,KTE
            PHYD(K+1) = PHYD(K) - G*RHO3D(I,K,J)*DZ8W(I,K,J)*FP
            PHYDMID(K)= 0.5*(PHYD(K)+PHYD(K+1))
         ENDDO

         do k=kts,kte+1
            NK=kme-k+kms
!           Pw1D(K) = p8w(I,NK,J)/100.
            Pw1D(K) = PHYD(NK)/100.
            Tw1D(K) = t8w(I,NK,J)
         enddo

         DO K=kts,kte
            QV1D(K)=0.
            QC1D(K)=0.
            QR1D(K)=0.
            QI1D(K)=0.
            QS1D(K)=0.
            CLDFRA1D(k)=0.
         ENDDO

         DO K=kts,kte
            NK=kme-1-K+kms
            QV1D(K)=QV3D(I,NK,J)
            QV1D(K)=max(0.,QV1D(K))
         ENDDO

         DO K=kts,kte
            NK=kme-1-K+kms
            TTEN1D(K)=0.
            T1D(K)=T3D(I,NK,J)
!           P1D(K)=P3D(I,NK,J)/100.
            P1D(K)=PHYDMID(NK)/100.
            DZ1D(K)=dz8w(I,NK,J)
         ENDDO

         IF (ICLOUD .ne. 0) THEN
            IF ( PRESENT( CLDFRA3D ) ) THEN
              DO K=kts,kte
                 NK=kme-1-K+kms
                 CLDFRA1D(k)=CLDFRA3D(I,NK,J)
              ENDDO
            ENDIF

            IF (PRESENT(F_QC) .AND. PRESENT(QC3D)) THEN
              IF ( F_QC) THEN
                 DO K=kts,kte
                    NK=kme-1-K+kms
                    QC1D(K)=QC3D(I,NK,J)
                    QC1D(K)=max(0.,QC1D(K))
                 ENDDO
              ENDIF
            ENDIF

            IF (PRESENT(F_QR) .AND. PRESENT(QR3D)) THEN
              IF ( F_QR) THEN
                 DO K=kts,kte
                    NK=kme-1-K+kms
                    QR1D(K)=QR3D(I,NK,J)
                    QR1D(K)=max(0.,QR1D(K))
                 ENDDO
              ENDIF
            ENDIF

! This logic is tortured because cannot test F_QI unless
! it is present, and order of evaluation of expressions
! is not specified in Fortran

            IF ( PRESENT ( F_QI ) ) THEN
              predicate = F_QI
            ELSE
              predicate = .FALSE.
            ENDIF

            IF (.NOT. predicate .and. .not. warm_rain) THEN
               DO K=kts,kte
                  IF (T1D(K) .lt. 273.15) THEN
                  QI1D(K)=QC1D(K)
                  QS1D(K)=QR1D(K)
                  QC1D(K)=0.
                  QR1D(K)=0.
                  ENDIF
               ENDDO
            ENDIF

            IF (PRESENT(F_QI) .AND. PRESENT(QI3D)) THEN
               DO K=kts,kte
                  NK=kme-1-K+kms
                  QI1D(K)=QI3D(I,NK,J)
                  QI1D(K)=max(0.,QI1D(K))
               ENDDO
            ENDIF

            IF (PRESENT(F_QS) .AND. PRESENT(QS3D)) THEN
               IF (F_QS) THEN
                  DO K=kts,kte
                     NK=kme-1-K+kms
                     QS1D(K)=QS3D(I,NK,J)
                     QS1D(K)=max(0.,QS1D(K))
                  ENDDO
               ENDIF
            ENDIF

            IF (PRESENT(F_QG) .AND. PRESENT(QG3D)) THEN
               IF (F_QG) THEN
                  DO K=kts,kte
                     NK=kme-1-K+kms
                     QG1D(K)=QG3D(I,NK,J)
                     QG1D(K)=max(0.,QG1D(K))
                  ENDDO
               ENDIF
            ENDIF

         ENDIF

         EMISS0=EMISS(I,J)
         GLW0=0. 
         TSFC=Tw1D(kme)

         CALL RRTM(tten1d,glw0,tsfc,cldfra1d,t1d,tw1d,qv1d,qc1d,   &
                   qr1d,qi1d,qs1d,qg1d,p1d,pW1d,dz1d,              &
                   emiss0,r,g,                                     &
                   kts,kte                                         )
 
         GLW(I,J)=GLW0

         DO K=kts,kte
            nk=kme-1-k+kms
            rthraten(i,k,j)=rthraten(i,k,j)+tten1d(nk)/pi3d(i,k,j)
         ENDDO

      END DO i_loop
   END DO j_loop                                           

!-------------------------------------------------------------------

   END SUBROUTINE RRTMLWRAD


!****************************************************************************    
!*                                                                          *    
!*                               RRTM                                       *    
!*                                                                          *    
!*                                                                          *    
!*                                                                          *    
!*                   RAPID RADIATIVE TRANSFER MODEL                         *    
!*                                                                          *    
!*                                                                          *    
!*            ATMOSPHERIC AND ENVIRONMENTAL RESEARCH, INC.                  *    
!*                        840 MEMORIAL DRIVE                                *    
!*                        CAMBRIDGE, MA 02139                               *    
!*                                                                          *    
!*                                                                          *    
!*                           ELI J. MLAWER                                  *    
!*                         STEVEN J. TAUBMAN~                               *    
!*                         SHEPARD A. CLOUGH                                *    
!*                                                                          *    
!*                                                                          *    
!*                         ~currently at GFDL                               *    
!*                                                                          *    
!*                                                                          *    
!*                                                                          *    
!*                       email:  mlawer@aer.com                             *    
!*                                                                          *    
!*        The authors wish to acknowledge the contributions of the          *    
!*        following people:  Patrick D. Brown, Michael J. Iacono,           *    
!*        Ronald E. Farren, Luke Chen, Robert Bergstrom.                    *    
!*                                                                          *    
!****************************************************************************    
                                                                                 
! *** This version of RRTM has been altered to interface with the                
! *** NCAR MM5 mesoscale model for the calculation of longwave radiative         
! *** transfer (based on a code for interface with CCM model by M. J. Iacono)    
! *** J. Dudhia ; March, 1999                                                    
!---------------------------------------------------------------------
   SUBROUTINE RRTM(TTEN,GLW,TSFC,CLDFRA,T,Tw,QV,QC,                  &
                   QR,QI,QS,QG,P,Pw,DZ,                              &
                   EMISS,R,G,                                        &
                   kts,kte                                           )
!---------------------------------------------------------------------
! *** This program is the driver for RRTM, the AER LW radiation model.           
!     This routine:                                                              
!     Calls MM5ATM to provide atmosphere in column and boundary values           
!     a) calls GASABS to calculate gaseous optical depths                        
!     b) calls SETCOEF to calculate various quantities needed for                
!        the radiative transfer algorithm                                        
!     c) calls RTRN (for both clear and cloudy columns) to do the                
!        radiative transfer calculation                                          
!     d) passes the necessary flux and cooling rate back to MM5                  
!---------------------------------------------------------------------
      IMPLICIT NONE
!---------------------------------------------------------------------

      INTEGER, INTENT(IN ) ::      kts, kte
!
      REAL, DIMENSION( kts:kte+1 ), INTENT(IN   ) ::             Pw, &
                                                                 Tw

      REAL, DIMENSION( kts:kte ), INTENT(IN   ) ::           CLDFRA, &
                                                                  T, &
                                                                  P, &
                                                                 DZ
!
      REAL, DIMENSION( kts:kte ), INTENT(INOUT) ::                   &
                                                                 QV
      REAL, DIMENSION( kts:kte ), INTENT(IN   ) ::                   &
                                                                 QC, &
                                                                 QR, &
                                                                 QI, &
                                                                 QS, &
                                                                 QG
!
      REAL, DIMENSION( kts:kte ), INTENT(INOUT)::              TTEN
!   
      REAL, INTENT(IN  )   ::                           R, G, EMISS
!
      REAL, INTENT(INOUT)  ::                              TSFC,GLW

! LOCAL VAR

      INTEGER, DIMENSION( NGPT,kts:kte+1 ) ::                   ITR

      REAL,    DIMENSION( NGPT,kts:kte+1 ) ::                  PFRAC, &
                                                               TAUG

      REAL,    DIMENSION( 35,kts:kte+1 )       ::               WKL

      REAL,    DIMENSION( MAXXSEC,kts:kte+1 )  ::                WX

      REAL, DIMENSION( kts:kte )  ::                         O3PROF

      REAL, DIMENSION( kts:kte+1 )  ::                        PAVEL, &
                                                              TAVEL, &
                                                            CLDFRAC, &
                                                           TAUCLOUD, &   
                                                             COLDRY, & 
                                                             COLH2O, &
                                                             COLCO2, &
                                                              COLO3, &
                                                             COLN2O, &
                                                             COLCH4, &
                                                              COLO2, &
                                                            CO2MULT, &
                                                              FAC00, &
                                                              FAC01, &
                                                              FAC10, &
                                                              FAC11, &
                                                             FORFAC, &
                                                            SELFFAC, &
                                                           SELFFRAC
                                                
!                       
      INTEGER, DIMENSION( kts:kte+1 ) ::                    ICLDLYR, &
                                                                 JP, &
                                                                 JT, &
                                                                JT1, &
                                                            INDSELF

      REAL, DIMENSION(   0:kte+1 )  ::                           PZ, &
                                                                 TZ, &
                                                           TOTDFLUX, &
                                                                HTR
!     
      INTEGER ::  I,K,ktep1
      INTEGER ::  LAYTROP,LAYSWTCH,LAYLOW
      REAL    ::  TBOUND
      REAL, DIMENSION(NBANDS) ::  SEMISS


!---------------------------------------------------------------------------
! RRTM Definitions                                                               
!    NGPT                         ! Total number of g-point subintervals         
!    MXLAY                        ! Maximum number of model layers               
!    NBANDS                       ! Number of longwave spectral bands            
!    PI                           ! Geometric constant                           
!    FLUXFAC                      ! Radiance to flux conversion factor           
!    HEATFAC                      ! Heating rate conversion factor               
!    NG(NBANDS)                   ! Number of g-points per band for input        
!                                   absorption coefficient data                  
!    NSPA(NBANDS),NSPB(NBANDS)    ! Number of reference atmospheres per band     
!    WAVENUM1(NBANDS)             ! Longwave band lower limit (wavenumbers)      
!    WAVENUM2(NBANDS)             ! Longwave band upper limit (wavenumbers)      
!    DELWAVE                      ! Longwave band width (wavenumbers)            
!    NLAYERS                      ! Number of model layers (mkx+1)               
!    PAVEL(MXLAY)                 ! Layer pressures (mb)                         
!    PZ(0:MXLAY)                  ! Level (interface) pressures (mb)             
!    TAVEL(MXLAY)                 ! Layer temperatures (K)                       
!    TZ(0:MXLAY)                  ! Level (interface) temperatures(mb)           
!    TBOUND                       ! Surface temperature (K)                      
!    CLDFRAC(MXLAY)               ! Layer cloud fraction                         
!    TAUCLOUD(MXLAY)              ! Layer cloud optical depth                    
!    ITR(NGPT,MXLAY)              ! Integer look-up table index                  
!    PFRAC(NGPT,MXLAY)            ! Planck fractions                             
!    ICLDLYR(MXLAY)               ! Flag for cloudy layers                       
!    TOTUFLUX(0:MXLAY)            ! Upward longwave flux (W/m2)                  
!    TOTDFLUX(0:MXLAY)            ! Downward longwave flux (W/m2)                
!    FNET(0:MXLAY)                ! Net longwave flux (W/m2)                     
!    HTR(0:MXLAY)                 ! Longwave heating rate (K/day)                
!    CLRNTTOA                     ! Clear-sky TOA outgoing flux (W/m2)           
!    CLRNTSRF                     ! Clear-sky net surface flux (W/m2)            
!    TOTUCLFL(0:MXLAY)            ! Clear-sky upward longwave flux (W/m2)        
!    TOTDCLFL(0:MXLAY)            ! Clear-sky downward longwave flux (W/m2)      
!    FNETC(0:MXLAY)               ! Clear-sky net longwave flux (W/m2)           
!    HTRC(0:MXLAY)                ! Clear-sky longwave heating rate (K/day)      
!                                                                                
! This compiler directive was added to insure private common block storage       
! in multi-tasked mode on a CRAY or SGI for all commons except those that        
! carry constants.                                                               
!---------------------------------------------------------------------------

     ktep1=kte+1
!
!    CLOUD EMISSIVITIES (M^2/G)                                                  
!    THESE ARE CONSISTENT WITH LWRAD (ABCW=0.5*(ABUP+ABDOWN))                    
!     
!     ONEMINUS = 1. - 1.E-6                                                      
!     PI   = 2.*ASIN(1.)                                                           
!     FLUXFAC = PI   * 2.D4                     
!
      CALL INIRAD (O3PROF,Pw,kts,kte)
                                                                              
!  Prepare atmospheric profile from CCM for use in RRTM, and define              
!  other RRTM input parameters.  Arrays are passed back through the              
!  existing RRTM commons and arrays.                                             
         
         CALL MM5ATM(CLDFRA,O3PROF,T,Tw,TSFC,QV,QC,QR,QI,QS,QG,    &
                     P,Pw,DZ,EMISS,R,G,                            &
                     PAVEL,TAVEL,PZ,TZ,CLDFRAC,TAUCLOUD,COLDRY,    &
                     WKL,WX,TBOUND,SEMISS,                         &
                     kts,kte                                       )

!  Calculate information needed by the radiative transfer routine                
!  that is specific to this atmosphere, especially some of the                   
!  coefficients and indices needed to compute the optical depths                 
!  by interpolating data from stored reference atmospheres.                      
                                                                                 
         CALL SETCOEF(kts,ktep1,                                   &
                      PAVEL,TAVEL,COLDRY,COLH2O,COLCO2,COLO3,      &
                      COLN2O,COLCH4,COLO2,CO2MULT,                 &
                      FAC00,FAC01,FAC10,FAC11,                     &
                      FORFAC,SELFFAC,SELFFRAC,                     &
                      JP,JT,JT1,INDSELF,WKL,LAYTROP,LAYSWTCH,LAYLOW)

         CALL GASABS(kts,ktep1,                                 &
                     COLDRY,COLH2O,COLCO2,COLO3,COLN2O,COLCH4,  &
                     COLO2,CO2MULT,                             &
                     FAC00,FAC01,FAC10,FAC11,                   &
                     FORFAC,SELFFAC,SELFFRAC,                   &
                     JP,JT,JT1,INDSELF,ITR,WX,PFRAC,TAUG,       &
                     LAYTROP,LAYSWTCH,LAYLOW                    )

!  Check for cloud in column.  Use original CCM LW threshold: if total           
!  clear sky fraction < 0.999, then column is cloudy, otherwise consider         
!  it clear.  Also, set up flag array, icldlyr, for use in radiative             
!  transfer.  Set icldlyr to one for each layer with cloud.  If tclrsf           
!  is not available, icldlyr can be set from cldfrac alone.                      
                                                                                 
        do 1500 k = 1, nlayers                                                   
           if (cldfrac(k).gt.0.) then                                            
              icldlyr(k) = 1                                                     
           else                                                                  
              icldlyr(k) = 0                                                     
           endif                                                                 
 1500   continue                                                                 
                                                                                 
!  Call the radiative transfer routine.                                          
                                                                                 
           CALL RTRN(kts,ktep1,                                  &
                     TAVEL, PZ, TZ, CLDFRAC, TAUCLOUD, TOTDFLUX, &
                     HTR, ICLDLYR, ITR, PFRAC, TBOUND,SEMISS     )
                                                                                 
!  Pass total sky up and down flux profiles to CCM output arrays and             
!  convert from mks to cgs units for CCM.  Pass clear sky TOA and surface        
!  net fluxes to CCM fields for diagnostics.  Pass total sky heating rate        
!  profile to CCM output arrays and convert units to K/sec.  The vertical        
!  array index (bottom to top in RRTM) is reversed for CCM fields.               
                                                                                 
!          flntc(iiplon) = CLRNTTOA*1.e3                                         
!          flnsc(iiplon) = CLRNTSRF*1.e3                                         
!           do 2400 k = 0, NLAYERS-1                                             
!              fulc(k+1) = TOTUCLFL(NLAYERS-1-k)*1.e3                            
!              fdlc(k+1) = TOTDCLFL(NLAYERS-1-k)*1.e3                            
!              ful(k+1) = TOTUFLUX(NLAYERS-1-k)*1.e3                             
!              fdl(k+1) = TOTDFLUX(NLAYERS-1-k)*1.e3                             
! 2400      continue                                                             
           do 2450 k = 1, NLAYERS-1                                              
!              qrlc(k) = HTRC(NLAYERS-1-k)/86400.                                
!              qrl(k) = HTR(NLAYERS-1-k)/86400.                                  
              TTEN(K)=HTR(NLAYERS-1-k)/86400. 
 2450      continue                                                              
           GLW = TOTDFLUX(0)

   END SUBROUTINE RRTM


!***************************************************************************     
   SUBROUTINE CMBGB1(abscoefL, abscoefH, SELFREF,                       &
                     FRACREFA, FRACREFB, FORREF,                        &
                     SELFREFC, FORREFC, FRACREFAC, FRACREFBC            )
!***************************************************************************     
!                                                                                
!  Original version:       Michael J. Iacono; July, 1998                         
!  Revision for NCAR CCM:  Michael J. Iacono; September, 1998                    
!                                                                                
!  The subroutines CMBGB1->CMBGB16 input the absorption coefficient              
!  data for each band, which are defined for 16 g-points and 16 spectral         
!  bands. The data are combined with appropriate weighting following the         
!  g-point mapping arrays specified in RRTMINIT.  Plank fraction data            
!  in arrays FRACREFA and FRACREFB are combined without weighting.  All          
!  g-point reduced data are put into new arrays for use in RRTM.                 
!                                                                                
!  BAND 1:  10-250 cm-1 (low - H2O; high - H2O)                                  
!***************************************************************************     
                                                                                 
! Input                                                                          
      REAL abscoefL(5,13,MG),abscoefH(5,13:59,MG)
      REAL SELFREF(10,MG)              
      REAL FRACREFA(MG), FRACREFB(MG), FORREF(MG)
!     REAL RWGT(MG*NBANDS) 
! Output                                                                         
      REAL SELFREFC(10,NG1), FORREFC(NG1)
      REAL FRACREFAC(NG1), FRACREFBC(NG1)
!
      INTEGER :: NGN_IGC                                                                                 
      integer :: igc,jn,jnd,jndc,jtjt,jpjp,iprsm,ipr
      real :: sumf1,sumf2,sumk
!
      DO 2000 JTJT = 1,5                                                           
         DO 2200 JPJP = 1,13                                                       
            IPRSM = 0                                                            
            DO 2400 IGC = 1,NGC(1)                                               
               SUMK = 0.                                                         
               NGN_IGC=NGN(IGC)
!              DO 2600 IPR = 1, NGN(IGC)                                         
               DO 2600 IPR = 1, NGN_IGC                                         
                  IPRSM = IPRSM + 1                                              
                  SUMK = SUMK + abscoefL(JTJT,JPJP,IPRSM)*RWGT(IPRSM)               
 2600          CONTINUE                                                          
               ABSA1(JTJT+(JPJP-1)*5,IGC) = SUMK
 2400       CONTINUE                                                             
 2200    CONTINUE                                                                
         DO 3200 JPJP = 13,59                                                      
            IPRSM = 0                                                            
            DO 3400 IGC = 1,NGC(1)                                               
               SUMK = 0.                                                         
               NGN_IGC=NGN(IGC)
!              DO 3600 IPR = 1, NGN(IGC)                                         
               DO 3600 IPR = 1, NGN_IGC                                         
                  IPRSM = IPRSM + 1                                              
                  SUMK = SUMK + abscoefH(JTJT,JPJP,IPRSM)*RWGT(IPRSM)
 3600          CONTINUE                                                          
               ABSB1(JTJT+(JPJP-13)*5,IGC) = SUMK                                             
 3400       CONTINUE                                                             
 3200    CONTINUE                                                                
 2000 CONTINUE                                                                   
                                                                                 
      DO 4000 JTJT = 1,10                                                          
         IPRSM = 0                                                               
         DO 4400 IGC = 1,NGC(1)                                                  
            SUMK = 0.                                                            
            NGN_IGC=NGN(IGC)
!           DO 4600 IPR = 1, NGN(IGC)                                            
            DO 4600 IPR = 1, NGN_IGC                                         
               IPRSM = IPRSM + 1                                                 
               SUMK = SUMK + SELFREF(JTJT,IPRSM)*RWGT(IPRSM)
 4600       CONTINUE                                                             
            SELFREFC(JTJT,IGC) = SUMK                                              
 4400    CONTINUE                                                                
 4000 CONTINUE                                                                   
                                                                                 
      IPRSM = 0                                                                  
      DO 5400 IGC = 1,NGC(1)                                                     
         SUMK = 0.                                                               
         SUMF1 = 0.                                                              
         SUMF2 = 0.                                                              
         NGN_IGC=NGN(IGC)
!        DO 5600 IPR = 1, NGN(IGC)                                               
         DO 5600 IPR = 1, NGN_IGC                                         
            IPRSM = IPRSM + 1                                                    
            SUMK = SUMK + FORREF(IPRSM)*RWGT(IPRSM)                              
            SUMF1= SUMF1+ FRACREFA(IPRSM)                                        
            SUMF2= SUMF2+ FRACREFB(IPRSM)                                        
 5600    CONTINUE                                                                
         FORREFC(IGC) = SUMK                                                     
         FRACREFAC(IGC) = SUMF1                                                  
         FRACREFBC(IGC) = SUMF2                                                  
 5400 CONTINUE                                                                   
                                                                                 
   END SUBROUTINE CMBGB1

!***************************************************************************
  SUBROUTINE CMBGB2(abscoefL, abscoefH, SELFREF,                       &
                    FRACREFA, FRACREFB, FORREF,                        &
                    SELFREFC, FORREFC, FRACREFAC, FRACREFBC            )
!***************************************************************************     
!                                                                                
!     BAND 2:  250-500 cm-1 (low - H2O; high - H2O)                              
!***************************************************************************     
                                                                                 
! Input                                                                          
      REAL abscoefL(5,13,MG),abscoefH(5,13:59,MG)
      REAL SELFREF(10,MG)            
      REAL FRACREFA(MG,13), FRACREFB(MG), FORREF(MG)
!     REAL RWGT(MG*NBANDS) 
! Output                                                                         
      REAL SELFREFC(10,NG2), FORREFC(NG2)
      REAL FRACREFAC(NG2,13), FRACREFBC(NG2)
!
      INTEGER :: NGN_X
      integer :: igc,jn,jnd,jndc,jtjt,jpjp,iprsm,ipr
      real :: sumf,sumk
                                                                                 
      DO 2000 JTJT = 1,5                                                           
         DO 2200 JPJP = 1,13                                                       
            IPRSM = 0                                                            
            DO 2400 IGC = 1,NGC(2)                                               
               SUMK = 0.                                                         
               NGN_X=NGN(NGS(1)+IGC)
!              DO 2600 IPR = 1, NGN(NGS(1)+IGC)                                  
               DO 2600 IPR = 1, NGN_X
                  IPRSM = IPRSM + 1                                              
                  SUMK = SUMK + abscoefL(JTJT,JPJP,IPRSM)*RWGT(IPRSM+16)
 2600          CONTINUE                                                          
               ABSA2(JTJT+(JPJP-1)*5,IGC) = SUMK  
 2400       CONTINUE                                                             
 2200    CONTINUE                                                                
         DO 3200 JPJP = 13,59                                                      
            IPRSM = 0                                                            
            DO 3400 IGC = 1,NGC(2)                                               
               SUMK = 0.                                                         
               NGN_X=NGN(NGS(1)+IGC)
!              DO 3600 IPR = 1, NGN(NGS(1)+IGC)                                  
               DO 3600 IPR = 1, NGN_X
                  IPRSM = IPRSM + 1                                              
                  SUMK = SUMK + abscoefH(JTJT,JPJP,IPRSM)*RWGT(IPRSM+16)
 3600          CONTINUE                                                          
               ABSB2(JTJT+(JPJP-13)*5,IGC) = SUMK
 3400       CONTINUE                                                             
 3200    CONTINUE                                                                
 2000 CONTINUE                                                                   
                                                                                 
      DO 4000 JTJT = 1,10                                                          
         IPRSM = 0                                                               
         DO 4400 IGC = 1,NGC(2)                                                  
            SUMK = 0.                                                            
            NGN_X=NGN(NGS(1)+IGC)
!           DO 4600 IPR = 1, NGN(NGS(1)+IGC)                                     
            DO 4600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMK = SUMK + SELFREF(JTJT,IPRSM)*RWGT(IPRSM+16)
 4600       CONTINUE                                                             
            SELFREFC(JTJT,IGC) = SUMK                                              
 4400    CONTINUE                                                                
 4000 CONTINUE                                                                   
                                                                                 
      DO 5000 JPJP = 1,13                                                          
         IPRSM = 0                                                               
         DO 5400 IGC = 1,NGC(2)                                                  
            SUMF = 0.                                                            
            NGN_X=NGN(NGS(1)+IGC)
!           DO 5600 IPR = 1, NGN(NGS(1)+IGC)                                     
            DO 5600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMF = SUMF + FRACREFA(IPRSM,JPJP)                                  
 5600       CONTINUE                                                             
            FRACREFAC(IGC,JPJP) = SUMF                                             
 5400    CONTINUE                                                                
 5000 CONTINUE                                                                   
                                                                                 
      IPRSM = 0                                                                  
      DO 6400 IGC = 1,NGC(2)                                                     
         SUMK = 0.                                                               
         SUMF = 0.                                                               
         NGN_X=NGN(NGS(1)+IGC)
!        DO 6600 IPR = 1, NGN(NGS(1)+IGC)                                        
         DO 6600 IPR = 1, NGN_X
            IPRSM = IPRSM + 1                                                    
            SUMK = SUMK + FORREF(IPRSM)*RWGT(IPRSM+16)                           
            SUMF = SUMF + FRACREFB(IPRSM)                                        
 6600    CONTINUE                                                                
         FORREFC(IGC) = SUMK                                                     
         FRACREFBC(IGC) = SUMF                                                   
 6400 CONTINUE                                                                   
                                                                                 
   END SUBROUTINE CMBGB2

!***************************************************************************
   SUBROUTINE CMBGB3(abscoefL, abscoefH, SELFREF,                       &
                     FRACREFA, FRACREFB, FORREF, ABSN2OA, ABSN2OB,      &
                     SELFREFC, FORREFC,                                 &
                     ABSN2OAC, ABSN2OBC, FRACREFAC, FRACREFBC           )
!***************************************************************************     
!                                                                                
!     BAND 3:  500-630 cm-1 (low - H2O,CO2; high - H2O,CO2)                      
!***************************************************************************     
                                                                                 
! Input                                                                          
      REAL abscoefL(10,5,13,MG),abscoefH(5,5,13:59,MG)
      REAL SELFREF(10,MG)   
      REAL FRACREFA(MG,10), FRACREFB(MG,5)
      REAL FORREF(MG), ABSN2OA(MG), ABSN2OB(MG)     
!     REAL RWGT(MG*NBANDS) 
! Output                                                                         
      REAL SELFREFC(10,NG3), FORREFC(NG3),  &
           ABSN2OAC(NG3), ABSN2OBC(NG3) 
      REAL FRACREFAC(NG3,10), FRACREFBC(NG3,5) 
!
      INTEGER :: NGN_X
      integer :: igc,jn,jnd,jndc,jtjt,jpjp,iprsm,ipr
      real :: sumf,sumk,sumk1,sumk2,sumk3
                                                                                 
      DO 2000 JN = 1,10                                                          
         DO 2000 JTJT = 1,5                                                        
            DO 2200 JPJP = 1,13                                                    
               IPRSM = 0                                                         
               DO 2400 IGC = 1,NGC(3)                                            
                 SUMK = 0.                                                       
                  NGN_X=NGN(NGS(2)+IGC)
!                 DO 2600 IPR = 1, NGN(NGS(2)+IGC)                               
                  DO 2600 IPR = 1, NGN_X
                     IPRSM = IPRSM + 1                                           
                     SUMK = SUMK + abscoefL(JN,JTJT,JPJP,IPRSM)* RWGT(IPRSM+32)
 2600             CONTINUE                                                       
                  ABSA3(JN+(JTJT-1)*10+(JPJP-1)*50,IGC) = SUMK  
 2400          CONTINUE                                                          
 2200       CONTINUE                                                             
 2000 CONTINUE                                                                   
      DO 3000 JN = 1,5                                                           
         DO 3000 JTJT = 1,5                                                        
            DO 3200 JPJP = 13,59                                                   
               IPRSM = 0                                                         
               DO 3400 IGC = 1,NGC(3)                                            
                  SUMK = 0.                                                      
                  NGN_X=NGN(NGS(2)+IGC)
!                 DO 3600 IPR = 1, NGN(NGS(2)+IGC)                               
                  DO 3600 IPR = 1, NGN_X
                     IPRSM = IPRSM + 1                                           
                     SUMK = SUMK + abscoefH(JN,JTJT,JPJP,IPRSM)* RWGT(IPRSM+32)
 3600             CONTINUE                                                       
                  ABSB3(JN+(JTJT-1)*5+(JPJP-13)*25,IGC) = SUMK
 3400          CONTINUE                                                          
 3200       CONTINUE                                                             
 3000 CONTINUE                                                                   
                                                                                 
      DO 4000 JTJT = 1,10                                                          
         IPRSM = 0                                                               
         DO 4400 IGC = 1,NGC(3)                                                  
            SUMK = 0.                                                            
            SUMF = 0.                                                            
            NGN_X=NGN(NGS(2)+IGC)
!           DO 4600 IPR = 1, NGN(NGS(2)+IGC)                                     
            DO 4600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMK = SUMK + SELFREF(JTJT,IPRSM)* RWGT(IPRSM+32)
               SUMF = SUMF + FRACREFA(IPRSM,JTJT)                                  
 4600       CONTINUE                                                             
            SELFREFC(JTJT,IGC) = SUMK                                              
            FRACREFAC(IGC,JTJT) = SUMF                                             
 4400    CONTINUE                                                                
 4000 CONTINUE                                                                   
                                                                                 
      DO 5000 JPJP = 1,5                                                           
         IPRSM = 0                                                               
         DO 5400 IGC = 1,NGC(3)                                                  
            SUMF = 0.                                                            
            NGN_X=NGN(NGS(2)+IGC)
!           DO 5600 IPR = 1, NGN(NGS(2)+IGC)                                     
            DO 5600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMF = SUMF + FRACREFB(IPRSM,JPJP)                                  
 5600       CONTINUE                                                             
            FRACREFBC(IGC,JPJP) = SUMF                                             
 5400    CONTINUE                                                                
 5000 CONTINUE                                                                   
                                                                                 
      IPRSM = 0                                                                  
      DO 6400 IGC = 1,NGC(3)                                                     
         SUMK1= 0.                                                               
         SUMK2= 0.                                                               
         SUMK3= 0.                                                               
         NGN_X=NGN(NGS(2)+IGC)
!        DO 6600 IPR = 1, NGN(NGS(2)+IGC)                                        
         DO 6600 IPR = 1, NGN_X
            IPRSM = IPRSM + 1                                                    
            SUMK1= SUMK1+ FORREF(IPRSM)*RWGT(IPRSM+32)                           
            SUMK2= SUMK2+ ABSN2OA(IPRSM)*RWGT(IPRSM+32)                          
            SUMK3= SUMK3+ ABSN2OB(IPRSM)*RWGT(IPRSM+32)                          
 6600    CONTINUE                                                                
         FORREFC(IGC) = SUMK1                                                    
         ABSN2OAC(IGC) = SUMK2                                                   
         ABSN2OBC(IGC) = SUMK3                                                   
 6400 CONTINUE                                                                   
                                                                                 
   END SUBROUTINE CMBGB3

!***************************************************************************
   SUBROUTINE CMBGB4(abscoefL, abscoefH, SELFREF,                       &
                     FRACREFA, FRACREFB,                                &
                     SELFREFC, FRACREFAC, FRACREFBC                     )
!***************************************************************************     
!                                                                                
!     BAND 4:  630-700 cm-1 (low - H2O,CO2; high - O3,CO2)                       
!***************************************************************************     
                                                                                 
! Input                                                                          
      REAL abscoefL(9,5,13,MG),abscoefH(6,5,13:59,MG)
      REAL SELFREF(10,MG)            
      REAL FRACREFA(MG,9), FRACREFB(MG,6)
!     REAL RWGT(MG*NBANDS) 
! Output                                                                         
      REAL SELFREFC(10,NG4)
      REAL FRACREFAC(NG4,9), FRACREFBC(NG4,6)
!  
      INTEGER :: NGN_X
      integer :: igc,jn,jnd,jndc,jtjt,jpjp,iprsm,ipr
      real :: sumf,sumk
                                                                                 
      DO 2000 JN = 1,9                                                           
         DO 2000 JTJT = 1,5                                                        
            DO 2200 JPJP = 1,13                                                    
               IPRSM = 0                                                         
               DO 2400 IGC = 1,NGC(4)                                            
                 SUMK = 0.                                                       
                  NGN_X=NGN(NGS(3)+IGC)
!                 DO 2600 IPR = 1, NGN(NGS(3)+IGC)                               
                  DO 2600 IPR = 1, NGN_X
                     IPRSM = IPRSM + 1                                           
                     SUMK = SUMK + abscoefL(JN,JTJT,JPJP,IPRSM)*RWGT(IPRSM+48)
 2600             CONTINUE                                                       
                  ABSA4(JN+(JTJT-1)*9+(JPJP-1)*45,IGC) = SUMK                                       
 2400          CONTINUE                                                          
 2200       CONTINUE                                                             
 2000 CONTINUE                                                                   
      DO 3000 JN = 1,6                                                           
         DO 3000 JTJT = 1,5                                                        
            DO 3200 JPJP = 13,59                                                   
               IPRSM = 0                                                         
               DO 3400 IGC = 1,NGC(4)                                            
                  SUMK = 0.                                                      
                  NGN_X=NGN(NGS(3)+IGC)
!                 DO 3600 IPR = 1, NGN(NGS(3)+IGC)                               
                  DO 3600 IPR = 1, NGN_X
                     IPRSM = IPRSM + 1                                           
                     SUMK = SUMK + abscoefH(JN,JTJT,JPJP,IPRSM)*RWGT(IPRSM+48)
 3600             CONTINUE                                                       
                  ABSB4(JN+(JTJT-1)*6+(JPJP-13)*30,IGC) = SUMK
 3400          CONTINUE                                                          
 3200       CONTINUE                                                             
 3000 CONTINUE                                                                   
                                                                                 
      DO 4000 JTJT = 1,10                                                          
         IPRSM = 0                                                               
         DO 4400 IGC = 1,NGC(4)                                                  
            SUMK = 0.                                                            
            NGN_X=NGN(NGS(3)+IGC)
!           DO 4600 IPR = 1, NGN(NGS(3)+IGC)                                     
            DO 4600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMK = SUMK + SELFREF(JTJT,IPRSM)*RWGT(IPRSM+48)
 4600       CONTINUE                                                             
            SELFREFC(JTJT,IGC) = SUMK                                              
 4400    CONTINUE                                                                
 4000 CONTINUE                                                                   
                                                                                 
      DO 5000 JPJP = 1,9                                                           
         IPRSM = 0                                                               
         DO 5400 IGC = 1,NGC(4)                                                  
            SUMF = 0.                                                            
            NGN_X=NGN(NGS(3)+IGC)
!           DO 5600 IPR = 1, NGN(NGS(3)+IGC)                                     
            DO 5600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMF = SUMF + FRACREFA(IPRSM,JPJP)                                  
 5600       CONTINUE                                                             
            FRACREFAC(IGC,JPJP) = SUMF                                             
 5400    CONTINUE                                                                
 5000 CONTINUE                                                                   
                                                                                 
      DO 6000 JPJP = 1,6                                                           
         IPRSM = 0                                                               
         DO 6400 IGC = 1,NGC(4)                                                  
            SUMF = 0.                                                            
            NGN_X=NGN(NGS(3)+IGC)
!           DO 6600 IPR = 1, NGN(NGS(3)+IGC)                                     
            DO 6600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMF = SUMF + FRACREFB(IPRSM,JPJP)                                  
 6600       CONTINUE                                                             
            FRACREFBC(IGC,JPJP) = SUMF                                             
 6400    CONTINUE                                                                
 6000 CONTINUE                                                                   
                                                                                 
   END SUBROUTINE CMBGB4

!***************************************************************************
   SUBROUTINE CMBGB5(abscoefL, abscoefH, SELFREF,                      &
                     FRACREFA, FRACREFB, CCL4,                         &
                     SELFREFC, CCL4C, FRACREFAC, FRACREFBC             )
!***************************************************************************     
!                                                                                
!     BAND 5:  700-820 cm-1 (low - H2O,CO2; high - O3,CO2)                       
!***************************************************************************     
                                                                                 
! Input                                                                          
      REAL abscoefL(9,5,13,MG),abscoefH(5,5,13:59,MG)
      REAL SELFREF(10,MG)            
      REAL FRACREFA(MG,9), FRACREFB(MG,5), CCL4(MG)
!     REAL RWGT(MG*NBANDS) 
! Output                                                                         
      REAL SELFREFC(10,NG5), CCL4C(NG5) 
      REAL FRACREFAC(NG5,9), FRACREFBC(NG5,5)               
!
      INTEGER :: NGN_X
      integer :: igc,jn,jnd,jndc,jtjt,jpjp,iprsm,ipr
      real :: sumf,sumk
                                                         
      DO 2000 JN = 1,9                                                           
         DO 2000 JTJT = 1,5                                                        
            DO 2200 JPJP = 1,13                                                    
               IPRSM = 0                                                         
               DO 2400 IGC = 1,NGC(5)                                            
                 SUMK = 0.                                                       
                  NGN_X=NGN(NGS(4)+IGC)
!                 DO 2600 IPR = 1, NGN(NGS(4)+IGC)                               
                  DO 2600 IPR = 1, NGN_X
                     IPRSM = IPRSM + 1                                           
                     SUMK = SUMK + abscoefL(JN,JTJT,JPJP,IPRSM)*RWGT(IPRSM+64)
 2600             CONTINUE                                                       
                  ABSA5(JN+(JTJT-1)*9+(JPJP-1)*45,IGC) = SUMK                                       
 2400          CONTINUE                                                          
 2200       CONTINUE                                                             
 2000 CONTINUE                                                                   
      DO 3000 JN = 1,5                                                           
         DO 3000 JTJT = 1,5                                                        
            DO 3200 JPJP = 13,59                                                   
               IPRSM = 0                                                         
               DO 3400 IGC = 1,NGC(5)                                            
                  SUMK = 0.                                                      
                  NGN_X=NGN(NGS(4)+IGC)
!                 DO 3600 IPR = 1, NGN(NGS(4)+IGC)                               
                  DO 3600 IPR = 1, NGN_X
                     IPRSM = IPRSM + 1                                           
                     SUMK = SUMK + abscoefH(JN,JTJT,JPJP,IPRSM)*RWGT(IPRSM+64)
 3600             CONTINUE                                                       
                  ABSB5(JN+(JTJT-1)*5+(JPJP-13)*25,IGC) = SUMK
 3400          CONTINUE                                                          
 3200       CONTINUE                                                             
 3000 CONTINUE                                                                   
                                                                                 
      DO 4000 JTJT = 1,10                                                          
         IPRSM = 0                                                               
         DO 4400 IGC = 1,NGC(5)                                                  
            SUMK = 0.                                                            
            NGN_X=NGN(NGS(4)+IGC)
!           DO 4600 IPR = 1, NGN(NGS(4)+IGC)                                     
            DO 4600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMK = SUMK + SELFREF(JTJT,IPRSM)*RWGT(IPRSM+64)
 4600       CONTINUE                                                             
            SELFREFC(JTJT,IGC) = SUMK                                              
 4400    CONTINUE                                                                
 4000 CONTINUE                                                                   
                                                                                 
      DO 5000 JPJP = 1,9                                                           
         IPRSM = 0                                                               
         DO 5400 IGC = 1,NGC(5)                                                  
            SUMF = 0.                                                            
            NGN_X=NGN(NGS(4)+IGC)
!           DO 5600 IPR = 1, NGN(NGS(4)+IGC)                                     
            DO 5600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMF = SUMF + FRACREFA(IPRSM,JPJP)                                  
 5600       CONTINUE                                                             
            FRACREFAC(IGC,JPJP) = SUMF                                             
 5400    CONTINUE                                                                
 5000 CONTINUE                                                                   
                                                                                 
      DO 6000 JPJP = 1,5                                                           
         IPRSM = 0                                                               
         DO 6400 IGC = 1,NGC(5)                                                  
            SUMF = 0.                                                            
            NGN_X=NGN(NGS(4)+IGC)
!           DO 6600 IPR = 1, NGN(NGS(4)+IGC)                                     
            DO 6600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMF = SUMF + FRACREFB(IPRSM,JPJP)                                  
 6600       CONTINUE                                                             
            FRACREFBC(IGC,JPJP) = SUMF                                             
 6400    CONTINUE                                                                
 6000 CONTINUE                                                                   
                                                                                 
      IPRSM = 0                                                                  
      DO 7400 IGC = 1,NGC(5)                                                     
         SUMK = 0.                                                               
         NGN_X=NGN(NGS(4)+IGC)
!        DO 7600 IPR = 1, NGN(NGS(4)+IGC)                                        
         DO 7600 IPR = 1, NGN_X
            IPRSM = IPRSM + 1                                                    
            SUMK = SUMK + CCL4(IPRSM)*RWGT(IPRSM+64)                             
 7600    CONTINUE                                                                
         CCL4C(IGC) = SUMK                                                       
 7400 CONTINUE                                                                   
                                                                                 
   END SUBROUTINE CMBGB5

!***************************************************************************
   SUBROUTINE CMBGB6(abscoefL, SELFREF,                                &
                     FRACREFA, ABSCO2, CFC11ADJ, CFC12,                &
                     SELFREFC, ABSCO2C, CFC11ADJC, CFC12C,             &
                     FRACREFAC                                         )
!***************************************************************************     
!                                                                                
!     BAND 6:  820-980 cm-1 (low - H2O; high - nothing)                          
!***************************************************************************     
                                                                                 
! Input                                                                          
      REAL abscoefL(5,13,MG)                                                           
      REAL SELFREF(10,MG)  
      REAL FRACREFA(MG), ABSCO2(MG), CFC11ADJ(MG), CFC12(MG)
!     REAL RWGT(MG*NBANDS) 
! Output                                                                         
      REAL SELFREFC(10,NG6),  &
           ABSCO2C(NG6), CFC11ADJC(NG6), CFC12C(NG6) 
      REAL FRACREFAC(NG6)
!
      INTEGER :: NGN_X
      integer :: igc,jn,jnd,jndc,jtjt,jpjp,iprsm,ipr
      real :: sumf,sumk,sumk1,sumk2,sumk3
                                                                                 
      DO 2000 JTJT = 1,5                                                           
         DO 2200 JPJP = 1,13                                                       
            IPRSM = 0                                                            
            DO 2400 IGC = 1,NGC(6)                                               
               SUMK = 0.                                                         
               NGN_X=NGN(NGS(5)+IGC)
!              DO 2600 IPR = 1, NGN(NGS(5)+IGC)                                  
               DO 2600 IPR = 1, NGN_X
                  IPRSM = IPRSM + 1                                              
                  SUMK = SUMK + abscoefL(JTJT,JPJP,IPRSM)*RWGT(IPRSM+80)
 2600          CONTINUE                                                          
               ABSA6(JTJT+(JPJP-1)*5,IGC) = SUMK                                             
 2400       CONTINUE                                                             
 2200    CONTINUE                                                                
 2000 CONTINUE                                                                   
                                                                                 
      DO 4000 JTJT = 1,10                                                          
         IPRSM = 0                                                               
         DO 4400 IGC = 1,NGC(6)                                                  
            SUMK = 0.                                                            
            NGN_X=NGN(NGS(5)+IGC)
!           DO 4600 IPR = 1, NGN(NGS(5)+IGC)                                     
            DO 4600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMK = SUMK + SELFREF(JTJT,IPRSM)*RWGT(IPRSM+80) 
 4600       CONTINUE                                                             
            SELFREFC(JTJT,IGC) = SUMK                                              
 4400    CONTINUE                                                                
 4000 CONTINUE                                                                   
                                                                                 
      IPRSM = 0                                                                  
      DO 7400 IGC = 1,NGC(6)                                                     
         SUMF = 0.                                                               
         SUMK1= 0.                                                               
         SUMK2= 0.                                                               
         SUMK3= 0.                                                               
         NGN_X=NGN(NGS(5)+IGC)
!        DO 7600 IPR = 1, NGN(NGS(5)+IGC)                                        
         DO 7600 IPR = 1, NGN_X
            IPRSM = IPRSM + 1                                                    
            SUMF = SUMF + FRACREFA(IPRSM)                                        
            SUMK1= SUMK1+ ABSCO2(IPRSM)*RWGT(IPRSM+80)                           
            SUMK2= SUMK2+ CFC11ADJ(IPRSM)*RWGT(IPRSM+80)                         
            SUMK3= SUMK3+ CFC12(IPRSM)*RWGT(IPRSM+80)                            
 7600    CONTINUE                                                                
         FRACREFAC(IGC) = SUMF                                                   
         ABSCO2C(IGC) = SUMK1                                                    
         CFC11ADJC(IGC) = SUMK2                                                  
         CFC12C(IGC) = SUMK3                                                     
 7400 CONTINUE                                                                   
                                                                                 
   END SUBROUTINE CMBGB6

!***************************************************************************
   SUBROUTINE CMBGB7(abscoefL, abscoefH, SELFREF,                      &
                     FRACREFA, FRACREFB, ABSCO2,                       &
                     SELFREFC, ABSCO2C, FRACREFAC, FRACREFBC           )
!***************************************************************************     
!                                                                                
!     BAND 7:  980-1080 cm-1 (low - H2O,O3; high - O3)                           
!***************************************************************************     
                                                                                 
! Input                                                                          
      REAL abscoefL(9,5,13,MG),abscoefH(5,13:59,MG)
      REAL SELFREF(10,MG)          
      REAL FRACREFA(MG,9), FRACREFB(MG), ABSCO2(MG)
!     REAL RWGT(MG*NBANDS) 
! Output                                                                         
      REAL SELFREFC(10,NG7), ABSCO2C(NG7)
      REAL FRACREFAC(NG7,9), FRACREFBC(NG7)  
!
      INTEGER :: NGN_X
      integer :: igc,jn,jnd,jndc,jtjt,jpjp,iprsm,ipr
      real :: sumf,sumk
                                                                                 
      DO 2000 JN = 1,9                                                           
         DO 2000 JTJT = 1,5                                                        
            DO 2200 JPJP = 1,13                                                    
               IPRSM = 0                                                         
               DO 2400 IGC = 1,NGC(7)                                            
                 SUMK = 0.                                                       
                  NGN_X=NGN(NGS(6)+IGC)
!                 DO 2600 IPR = 1, NGN(NGS(6)+IGC)                               
                  DO 2600 IPR = 1, NGN_X
                     IPRSM = IPRSM + 1                                           
                     SUMK = SUMK + abscoefL(JN,JTJT,JPJP,IPRSM)*RWGT(IPRSM+96)
 2600             CONTINUE                                                       
                  ABSA7(JN+(JTJT-1)*9+(JPJP-1)*45,IGC) = SUMK                                       
 2400          CONTINUE                                                          
 2200       CONTINUE                                                             
 2000 CONTINUE                                                                   
      DO 3000 JTJT = 1,5                                                           
         DO 3200 JPJP = 13,59                                                      
            IPRSM = 0                                                            
            DO 3400 IGC = 1,NGC(7)                                               
               SUMK = 0.                                                         
               NGN_X=NGN(NGS(6)+IGC)
!              DO 3600 IPR = 1, NGN(NGS(6)+IGC)                                  
               DO 3600 IPR = 1, NGN_X
                  IPRSM = IPRSM + 1                                              
                  SUMK = SUMK + abscoefH(JTJT,JPJP,IPRSM)*RWGT(IPRSM+96)
 3600          CONTINUE                                                          
               ABSB7(JTJT+(JPJP-13)*5,IGC) = SUMK 
 3400       CONTINUE                                                             
 3200    CONTINUE                                                                
 3000 CONTINUE                                                                   
                                                                                 
      DO 4000 JTJT = 1,10                                                          
         IPRSM = 0                                                               
         DO 4400 IGC = 1,NGC(7)                                                  
            SUMK = 0.                                                            
            NGN_X=NGN(NGS(6)+IGC)
!           DO 4600 IPR = 1, NGN(NGS(6)+IGC)                                     
            DO 4600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMK = SUMK + SELFREF(JTJT,IPRSM)*RWGT(IPRSM+96)
 4600       CONTINUE                                                             
            SELFREFC(JTJT,IGC) = SUMK                                              
 4400    CONTINUE                                                                
 4000 CONTINUE                                                                   
                                                                                 
      DO 5000 JPJP = 1,9                                                           
         IPRSM = 0                                                               
         DO 5400 IGC = 1,NGC(7)                                                  
            SUMF = 0.                                                            
            NGN_X=NGN(NGS(6)+IGC)
!           DO 5600 IPR = 1, NGN(NGS(6)+IGC)                                     
            DO 5600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMF = SUMF + FRACREFA(IPRSM,JPJP)                                  
 5600       CONTINUE                                                             
            FRACREFAC(IGC,JPJP) = SUMF                                             
 5400    CONTINUE                                                                
 5000 CONTINUE                                                                   
                                                                                 
      IPRSM = 0                                                                  
      DO 7400 IGC = 1,NGC(7)                                                     
         SUMF = 0.                                                               
         SUMK = 0.                                                               
         NGN_X=NGN(NGS(6)+IGC)
!        DO 7600 IPR = 1, NGN(NGS(6)+IGC)                                        
         DO 7600 IPR = 1, NGN_X
            IPRSM = IPRSM + 1                                                    
            SUMF = SUMF + FRACREFB(IPRSM)                                        
            SUMK = SUMK + ABSCO2(IPRSM)*RWGT(IPRSM+96)                           
 7600    CONTINUE                                                                
         FRACREFBC(IGC) = SUMF                                                   
         ABSCO2C(IGC) = SUMK                                                     
 7400 CONTINUE                                                                   
                                                                                 
   END SUBROUTINE CMBGB7

!***************************************************************************
   SUBROUTINE CMBGB8(abscoefL, abscoefH, SELFREF,                     &
                     FRACREFA, FRACREFB, ABSCO2A, ABSCO2B,            &
                     ABSN2OA,  ABSN2OB,  CFC12,   CFC22ADJ,           &
                     SELFREFC, ABSCO2AC, ABSCO2BC,                    &
                     ABSN2OAC, ABSN2OBC, CFC12C, CFC22ADJC,           &
                     FRACREFAC, FRACREFBC                             )
!***************************************************************************     
!                                                                                
!     BAND 8:  1080-1180 cm-1 (low (i.e.>~300mb) - H2O; high - O3)               
!***************************************************************************     
                                                                                 
! Input                                                                          
      REAL abscoefL(5,7,MG),abscoefH(5,7:59,MG), SELFREF(10,MG)
      REAL FRACREFA(MG), FRACREFB(MG), ABSCO2A(MG), ABSCO2B(MG)
      REAL ABSN2OA(MG), ABSN2OB(MG), CFC12(MG), CFC22ADJ(MG) 
!     REAL RWGT(MG*NBANDS) 
! Output                                                                         
      REAL SELFREFC(10,NG8),               &
           ABSCO2AC(NG8), ABSCO2BC(NG8),   &
           ABSN2OAC(NG8), ABSN2OBC(NG8),   &
           CFC12C(NG8), CFC22ADJC(NG8)
      REAL FRACREFAC(NG8), FRACREFBC(NG8)
!
      INTEGER :: NGN_X
      integer :: igc,jnd,jndc,jtjt,jpjp,iprsm,ipr
      real :: sumf1,sumf2,sumk,sumk1,sumk2,sumk3,sumk4,sumk5,sumk6
                                                                                 
      DO 2000 JTJT = 1,5                                                           
         DO 2200 JPJP = 1,7                                                        
            IPRSM = 0                                                            
            DO 2400 IGC = 1,NGC(8)                                               
              SUMK = 0.                                                          
               NGN_X=NGN(NGS(7)+IGC)
!              DO 2600 IPR = 1, NGN(NGS(7)+IGC)                                  
               DO 2600 IPR = 1, NGN_X
                  IPRSM = IPRSM + 1                                              
                  SUMK = SUMK + abscoefL(JTJT,JPJP,IPRSM)*RWGT(IPRSM+112)
 2600          CONTINUE                                                          
               ABSA8(JTJT+(JPJP-1)*5,IGC) = SUMK                                             
 2400       CONTINUE                                                             
 2200    CONTINUE                                                                
 2000 CONTINUE                                                                   
      DO 3000 JTJT = 1,5                                                           
         DO 3200 JPJP = 7,59                                                       
            IPRSM = 0                                                            
            DO 3400 IGC = 1,NGC(8)                                               
               SUMK = 0.                                                         
               NGN_X=NGN(NGS(7)+IGC)
!              DO 3600 IPR = 1, NGN(NGS(7)+IGC)                                  
               DO 3600 IPR = 1, NGN_X
                  IPRSM = IPRSM + 1                                              
                  SUMK = SUMK + abscoefH(JTJT,JPJP,IPRSM)*RWGT(IPRSM+112)
 3600          CONTINUE                                                          
               ABSB8(JTJT+(JPJP-7)*5,IGC) = SUMK 
 3400       CONTINUE                                                             
 3200    CONTINUE                                                                
 3000 CONTINUE                                                                   
                                                                                 
      DO 4000 JTJT = 1,10                                                          
         IPRSM = 0                                                               
         DO 4400 IGC = 1,NGC(8)                                                  
            SUMK = 0.                                                            
            NGN_X=NGN(NGS(7)+IGC)
!           DO 4600 IPR = 1, NGN(NGS(7)+IGC)                                     
            DO 4600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMK = SUMK + SELFREF(JTJT,IPRSM)*RWGT(IPRSM+112) 
 4600       CONTINUE                                                             
            SELFREFC(JTJT,IGC) = SUMK                                              
 4400    CONTINUE                                                                
 4000 CONTINUE                                                                   
                                                                                 
      IPRSM = 0                                                                  
      DO 7400 IGC = 1,NGC(8)                                                     
         SUMF1= 0.                                                               
         SUMF2= 0.                                                               
         SUMK1= 0.                                                               
         SUMK2= 0.                                                               
         SUMK3= 0.                                                               
         SUMK4= 0.                                                               
         SUMK5= 0.                                                               
         SUMK6= 0.                                                               
         NGN_X=NGN(NGS(7)+IGC)
!        DO 7600 IPR = 1, NGN(NGS(7)+IGC)                                        
         DO 7600 IPR = 1, NGN_X
            IPRSM = IPRSM + 1                                                    
            SUMF1= SUMF1+ FRACREFA(IPRSM)                                        
            SUMF2= SUMF2+ FRACREFB(IPRSM)                                        
            SUMK1= SUMK1+ ABSCO2A(IPRSM)*RWGT(IPRSM+112)                         
            SUMK2= SUMK2+ ABSCO2B(IPRSM)*RWGT(IPRSM+112)                         
            SUMK3= SUMK3+ ABSN2OA(IPRSM)*RWGT(IPRSM+112)                         
            SUMK4= SUMK4+ ABSN2OB(IPRSM)*RWGT(IPRSM+112)                         
            SUMK5= SUMK5+ CFC12(IPRSM)*RWGT(IPRSM+112)                           
            SUMK6= SUMK6+ CFC22ADJ(IPRSM)*RWGT(IPRSM+112)                        
 7600    CONTINUE                                                                
         FRACREFAC(IGC) = SUMF1                                                  
         FRACREFBC(IGC) = SUMF2                                                  
         ABSCO2AC(IGC) = SUMK1                                                   
         ABSCO2BC(IGC) = SUMK2                                                   
         ABSN2OAC(IGC) = SUMK3                                                   
         ABSN2OBC(IGC) = SUMK4                                                   
         CFC12C(IGC) = SUMK5                                                     
         CFC22ADJC(IGC) = SUMK6                                                  
 7400 CONTINUE                                                                   
                                                                                 
   END SUBROUTINE CMBGB8

!***************************************************************************
   SUBROUTINE CMBGB9(abscoefL, abscoefH, SELFREF,                      &
                     FRACREFA, FRACREFB, ABSN2O,                       &
                     SELFREFC, ABSN2OC, FRACREFAC, FRACREFBC           )
!***************************************************************************     
!                                                                                
!     BAND 9:  1180-1390 cm-1 (low - H2O,CH4; high - CH4)                        
!***************************************************************************     
                                                                                 
! Input                                                                          
      REAL abscoefL(11,5,13,MG), abscoefH(5,13:59,MG)
      REAL SELFREF(10,MG)   
      REAL FRACREFA(MG,9), FRACREFB(MG), ABSN2O(3*MG)
!     REAL RWGT(MG*NBANDS) 
! Output                                                                         
      REAL SELFREFC(10,NG9), ABSN2OC(3*NG9)
      REAL FRACREFAC(NG9,9), FRACREFBC(NG9)
!
      INTEGER :: NGN_X
      integer :: igc,jn,jnd,jndc,jtjt,jpjp,iprsm,ipr
      real :: sumf,sumk
                                                                                 
      DO 2000 JN = 1,11                                                          
         DO 2000 JTJT = 1,5                                                        
            DO 2200 JPJP = 1,13                                                    
               IPRSM = 0                                                         
               DO 2400 IGC = 1,NGC(9)                                            
                  SUMK = 0.                                                      
                  NGN_X=NGN(NGS(8)+IGC)
!                 DO 2600 IPR = 1, NGN(NGS(8)+IGC)                               
                  DO 2600 IPR = 1, NGN_X
                     IPRSM = IPRSM + 1                                           
                     SUMK = SUMK + abscoefL(JN,JTJT,JPJP,IPRSM)*RWGT(IPRSM+128)
 2600             CONTINUE                                                       
                  ABSA9(JN+(JTJT-1)*11+(JPJP-1)*55,IGC) = SUMK                                       
 2400          CONTINUE                                                          
 2200       CONTINUE                                                             
 2000 CONTINUE                                                                   
                                                                                 
      DO 3000 JTJT = 1,5                                                           
         DO 3200 JPJP = 13,59                                                      
            IPRSM = 0                                                            
            DO 3400 IGC = 1,NGC(9)                                               
               SUMK = 0.                                                         
               NGN_X=NGN(NGS(8)+IGC)
!              DO 3600 IPR = 1, NGN(NGS(8)+IGC)                                  
               DO 3600 IPR = 1, NGN_X
                  IPRSM = IPRSM + 1                                              
                  SUMK = SUMK + abscoefH(JTJT,JPJP,IPRSM)*RWGT(IPRSM+128)
 3600          CONTINUE                                                          
               ABSB9(JTJT+(JPJP-13)*5,IGC) = SUMK
 3400       CONTINUE                                                             
 3200    CONTINUE                                                                
 3000 CONTINUE                                                                   
                                                                                 
      DO 4000 JTJT = 1,10                                                          
         IPRSM = 0                                                               
         DO 4400 IGC = 1,NGC(9)                                                  
            SUMK = 0.                                                            
            NGN_X=NGN(NGS(8)+IGC)
!           DO 4600 IPR = 1, NGN(NGS(8)+IGC)                                     
            DO 4600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMK = SUMK + SELFREF(JTJT,IPRSM)*RWGT(IPRSM+128)
 4600       CONTINUE                                                             
            SELFREFC(JTJT,IGC) = SUMK                                              
 4400    CONTINUE                                                                
 4000 CONTINUE                                                                   
                                                                                 
      DO 5000 JN = 1,3                                                           
         IPRSM = 0                                                               
         DO 5400 IGC = 1,NGC(9)                                                  
            SUMK = 0.                                                            
            NGN_X=NGN(NGS(8)+IGC)
!           DO 5600 IPR = 1, NGN(NGS(8)+IGC)                                     
            DO 5600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               JND = (JN-1)*16                                                   
               SUMK = SUMK + ABSN2O(JND+IPRSM)*RWGT(IPRSM+128)                   
 5600       CONTINUE                                                             
            JNDC = (JN-1)*NGC(9)                                                 
            ABSN2OC(JNDC+IGC) = SUMK                                             
 5400    CONTINUE                                                                
 5000 CONTINUE                                                                   
                                                                                 
      DO 6000 JPJP = 1,9                                                           
         IPRSM = 0                                                               
         DO 6400 IGC = 1,NGC(9)                                                  
            SUMF = 0.                                                            
            NGN_X=NGN(NGS(8)+IGC)
!           DO 6600 IPR = 1, NGN(NGS(8)+IGC)                                     
            DO 6600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMF = SUMF + FRACREFA(IPRSM,JPJP)                                  
 6600       CONTINUE                                                             
            FRACREFAC(IGC,JPJP) = SUMF                                             
 6400    CONTINUE                                                                
 6000 CONTINUE                                                                   
                                                                                 
      IPRSM = 0                                                                  
      DO 7400 IGC = 1,NGC(9)                                                     
         SUMF = 0.                                                               
         NGN_X=NGN(NGS(8)+IGC)
!        DO 7600 IPR = 1, NGN(NGS(8)+IGC)                                        
         DO 7600 IPR = 1, NGN_X
            IPRSM = IPRSM + 1                                                    
            SUMF = SUMF + FRACREFB(IPRSM)                                        
 7600    CONTINUE                                                                
         FRACREFBC(IGC) = SUMF                                                   
 7400 CONTINUE                                                                   
                                                                                 
   END SUBROUTINE CMBGB9

!***************************************************************************
   SUBROUTINE CMBGB10(abscoefL, abscoefH,                               &
                      FRACREFA, FRACREFB,                               &
                      FRACREFAC, FRACREFBC                              )
!***************************************************************************     
!                                                                                
!     BAND 10:  1390-1480 cm-1 (low - H2O; high - H2O)                           
!***************************************************************************     
                                                                                 
! Input                                                                          
      REAL abscoefL(5,13,MG),abscoefH(5,13:59,MG)            
      REAL FRACREFA(MG), FRACREFB(MG)
!     REAL RWGT(MG*NBANDS) 
! Output                                                                         
      REAL FRACREFAC(NG10), FRACREFBC(NG10)
!
      INTEGER :: NGN_X
      integer :: igc,jpjp,jtjt,iprsm,ipr
      real :: sumf,sumk,sumf1,sumf2
                                                                                 
      DO 2000 JTJT = 1,5                                                           
         DO 2200 JPJP = 1,13                                                       
            IPRSM = 0                                                            
            DO 2400 IGC = 1,NGC(10)                                              
               SUMK = 0.                                                         
               NGN_X=NGN(NGS(9)+IGC)
!              DO 2600 IPR = 1, NGN(NGS(9)+IGC)                                  
               DO 2600 IPR = 1, NGN_X
                  IPRSM = IPRSM + 1                                              
                  SUMK = SUMK + abscoefL(JTJT,JPJP,IPRSM)*RWGT(IPRSM+144)
 2600          CONTINUE                                                          
               ABSA10(JTJT+(JPJP-1)*5,IGC) = SUMK                                             
 2400       CONTINUE                                                             
 2200    CONTINUE                                                                
 2000 CONTINUE                                                                   
      DO 3000 JTJT = 1,5                                                           
         DO 3200 JPJP = 13,59                                                      
            IPRSM = 0                                                            
            DO 3400 IGC = 1,NGC(10)                                              
               SUMK = 0.                                                         
               NGN_X=NGN(NGS(9)+IGC)
!              DO 3600 IPR = 1, NGN(NGS(9)+IGC)                                  
               DO 3600 IPR = 1, NGN_X
                  IPRSM = IPRSM + 1                                              
                  SUMK = SUMK + abscoefH(JTJT,JPJP,IPRSM)*RWGT(IPRSM+144)
 3600          CONTINUE                                                          
               ABSB10(JTJT+(JPJP-13)*5,IGC) = SUMK
 3400       CONTINUE                                                             
 3200    CONTINUE                                                                
 3000 CONTINUE                                                                   
                                                                                 
      IPRSM = 0                                                                  
      DO 7400 IGC = 1,NGC(10)                                                    
         SUMF1= 0.                                                               
         SUMF2= 0.                                                               
         NGN_X=NGN(NGS(9)+IGC)
!        DO 7600 IPR = 1, NGN(NGS(9)+IGC)                                        
         DO 7600 IPR = 1, NGN_X
            IPRSM = IPRSM + 1                                                    
            SUMF1= SUMF1+ FRACREFA(IPRSM)                                        
            SUMF2= SUMF2+ FRACREFB(IPRSM)                                        
 7600    CONTINUE                                                                
         FRACREFAC(IGC) = SUMF1                                                  
         FRACREFBC(IGC) = SUMF2                                                  
 7400 CONTINUE                                                                   
                                                                                 
   END SUBROUTINE CMBGB10

!***************************************************************************
   SUBROUTINE CMBGB11(abscoefL, abscoefH, SELFREF,                   &
                      FRACREFA, FRACREFB,                            &
                      SELFREFC,                                      &
                      FRACREFAC, FRACREFBC                           )
!***************************************************************************     
!                                                                                
!     BAND 11:  1480-1800 cm-1 (low - H2O; high - H2O)                           
!***************************************************************************     
                                                                                 
! Input                                                                          
      REAL abscoefL(5,13,MG),abscoefH(5,13:59,MG)
      REAL SELFREF(10,MG)      
      REAL FRACREFA(MG), FRACREFB(MG)
!     REAL RWGT(MG*NBANDS) 
! Output                                                                         
      REAL SELFREFC(10,NG11)
      REAL FRACREFAC(NG11), FRACREFBC(NG11)
!
      INTEGER :: NGN_X
      integer :: igc,jpjp,jtjt,iprsm,ipr
      real :: sumf,sumk,sumf1,sumf2
                                                                                 
      DO 2000 JTJT = 1,5                                                           
         DO 2200 JPJP = 1,13                                                       
            IPRSM = 0                                                            
            DO 2400 IGC = 1,NGC(11)                                              
               SUMK = 0.                                                         
               NGN_X=NGN(NGS(10)+IGC)
!              DO 2600 IPR = 1, NGN(NGS(10)+IGC)                                 
               DO 2600 IPR = 1, NGN_X
                  IPRSM = IPRSM + 1                                              
                  SUMK = SUMK + abscoefL(JTJT,JPJP,IPRSM)*RWGT(IPRSM+160)
 2600          CONTINUE                                                          
               ABSA11(JTJT+(JPJP-1)*5,IGC) = SUMK                                             
 2400       CONTINUE                                                             
 2200    CONTINUE                                                                
 2000 CONTINUE                                                                   
      DO 3000 JTJT = 1,5                                                           
         DO 3200 JPJP = 13,59                                                      
            IPRSM = 0                                                            
            DO 3400 IGC = 1,NGC(11)                                              
               SUMK = 0.                                                         
               NGN_X=NGN(NGS(10)+IGC)
!              DO 3600 IPR = 1, NGN(NGS(10)+IGC)                                 
               DO 3600 IPR = 1, NGN_X
                  IPRSM = IPRSM + 1                                              
                  SUMK = SUMK + abscoefH(JTJT,JPJP,IPRSM)*RWGT(IPRSM+160) 
 3600          CONTINUE                                                          
               ABSB11(JTJT+(JPJP-13)*5,IGC) = SUMK
 3400       CONTINUE                                                             
 3200    CONTINUE                                                                
 3000 CONTINUE                                                                   
                                                                                 
      DO 4000 JTJT = 1,10                                                          
         IPRSM = 0                                                               
         DO 4400 IGC = 1,NGC(11)                                                 
            SUMK = 0.                                                            
            NGN_X=NGN(NGS(10)+IGC)
!           DO 4600 IPR = 1, NGN(NGS(10)+IGC)                                    
            DO 4600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMK = SUMK + SELFREF(JTJT,IPRSM)*RWGT(IPRSM+160) 
 4600       CONTINUE                                                             
            SELFREFC(JTJT,IGC) = SUMK                                              
 4400    CONTINUE                                                                
 4000 CONTINUE                                                                   
                                                                                 
      IPRSM = 0                                                                  
      DO 7400 IGC = 1,NGC(11)                                                    
         SUMF1= 0.                                                               
         SUMF2= 0.                                                               
         NGN_X=NGN(NGS(10)+IGC)
!        DO 7600 IPR = 1, NGN(NGS(10)+IGC)                                       
         DO 7600 IPR = 1, NGN_X
            IPRSM = IPRSM + 1                                                    
            SUMF1= SUMF1+ FRACREFA(IPRSM)                                        
            SUMF2= SUMF2+ FRACREFB(IPRSM)                                        
 7600    CONTINUE                                                                
         FRACREFAC(IGC) = SUMF1                                                  
         FRACREFBC(IGC) = SUMF2                                                  
 7400 CONTINUE                                                                   
                                                                                 
   END SUBROUTINE CMBGB11


!***************************************************************************
   SUBROUTINE CMBGB12(abscoefL, SELFREF,                          &
                      FRACREFA,                                   &
                      SELFREFC, FRACREFAC                         )
!***************************************************************************     
!                                                                                
!     BAND 12:  1800-2080 cm-1 (low - H2O,CO2; high - nothing)                   
!***************************************************************************     
                                                                                 
! Input                                                                          
      REAL abscoefL(9,5,13,MG)  
      REAL SELFREF(10,MG)              
      REAL FRACREFA(MG,9)
!     REAL RWGT(MG*NBANDS) 
! Output                                                                         
      REAL SELFREFC(10,NG12) 
      REAL FRACREFAC(NG12,9)
!
      INTEGER :: NGN_X
      integer :: igc,jn,jpjp,jtjt,iprsm,ipr
      real :: sumf,sumk,sumf1,sumf2
                                                                                 
      DO 2000 JN = 1,9                                                           
         DO 2000 JTJT = 1,5                                                        
            DO 2200 JPJP = 1,13                                                    
               IPRSM = 0                                                         
               DO 2400 IGC = 1,NGC(12)                                           
                  SUMK = 0.                                                      
                  NGN_X=NGN(NGS(11)+IGC)
!                 DO 2600 IPR = 1, NGN(NGS(11)+IGC)                              
                  DO 2600 IPR = 1, NGN_X
                     IPRSM = IPRSM + 1                                           
                     SUMK = SUMK + abscoefL(JN,JTJT,JPJP,IPRSM)*RWGT(IPRSM+176)
 2600             CONTINUE                                                       
                  ABSA12(JN+(JTJT-1)*9+(JPJP-1)*45,IGC) = SUMK                                       
 2400          CONTINUE                                                          
 2200       CONTINUE                                                             
 2000 CONTINUE                                                                   
                                                                                 
      DO 4000 JTJT = 1,10                                                          
         IPRSM = 0                                                               
         DO 4400 IGC = 1,NGC(12)                                                 
            SUMK = 0.                                                            
            NGN_X=NGN(NGS(11)+IGC)
!           DO 4600 IPR = 1, NGN(NGS(11)+IGC)                                    
            DO 4600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMK = SUMK + SELFREF(JTJT,IPRSM)*RWGT(IPRSM+176)
 4600       CONTINUE                                                             
            SELFREFC(JTJT,IGC) = SUMK                                              
 4400    CONTINUE                                                                
 4000 CONTINUE                                                                   
                                                                                 
      DO 7000 JPJP = 1,9                                                           
         IPRSM = 0                                                               
         DO 7400 IGC = 1,NGC(12)                                                 
            SUMF = 0.                                                            
            NGN_X=NGN(NGS(11)+IGC)
!           DO 7600 IPR = 1, NGN(NGS(11)+IGC)                                    
            DO 7600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMF = SUMF + FRACREFA(IPRSM,JPJP)                                  
 7600       CONTINUE                                                             
            FRACREFAC(IGC,JPJP) = SUMF                                             
 7400    CONTINUE                                                                
 7000 CONTINUE                                                                   
                                                                                 
   END SUBROUTINE CMBGB12

!***************************************************************************
   SUBROUTINE CMBGB13(abscoefL, SELFREF, FRACREFA,               &
                      SELFREFC, FRACREFAC                        )
!***************************************************************************     
!                                                                                
!     BAND 13:  2080-2250 cm-1 (low - H2O,N2O; high - nothing)                   
!***************************************************************************     
                                                                                 
! Input                                                                          
      REAL abscoefL(9,5,13,MG) 
      REAL SELFREF(10,MG)   
      REAL FRACREFA(MG,9)
!     REAL RWGT(MG*NBANDS) 
! Output                                                                         
      REAL SELFREFC(10,NG13) 
      REAL FRACREFAC(NG13,9)
!
      INTEGER :: NGN_X
      integer :: igc,jn,jpjp,jtjt,iprsm,ipr
      real :: sumf,sumk
                                                                                 
      DO 2000 JN = 1,9                                                           
         DO 2000 JTJT = 1,5                                                        
            DO 2200 JPJP = 1,13                                                    
               IPRSM = 0                                                         
               DO 2400 IGC = 1,NGC(13)                                           
                  SUMK = 0.                                                      
                  NGN_X=NGN(NGS(12)+IGC)
!                 DO 2600 IPR = 1, NGN(NGS(12)+IGC)                              
                  DO 2600 IPR = 1, NGN_X
                     IPRSM = IPRSM + 1                                           
                     SUMK = SUMK + abscoefL(JN,JTJT,JPJP,IPRSM)*RWGT(IPRSM+192)
 2600             CONTINUE                                                       
                  ABSA13(JN+(JTJT-1)*9+(JPJP-1)*45,IGC) = SUMK 
 2400          CONTINUE                                                          
 2200       CONTINUE                                                             
 2000 CONTINUE                                                                   
                                                                                 
      DO 4000 JTJT = 1,10                                                          
         IPRSM = 0                                                               
         DO 4400 IGC = 1,NGC(13)                                                 
            SUMK = 0.                                                            
            NGN_X=NGN(NGS(12)+IGC)
!           DO 4600 IPR = 1, NGN(NGS(12)+IGC)                                    
            DO 4600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMK = SUMK + SELFREF(JTJT,IPRSM)*RWGT(IPRSM+192)
 4600       CONTINUE                                                             
            SELFREFC(JTJT,IGC) = SUMK                                              
 4400    CONTINUE                                                                
 4000 CONTINUE                                                                   
                                                                                 
      DO 7000 JPJP = 1,9                                                           
         IPRSM = 0                                                               
         DO 7400 IGC = 1,NGC(13)                                                 
            SUMF = 0.                                                            
            NGN_X=NGN(NGS(12)+IGC)
!           DO 7600 IPR = 1, NGN(NGS(12)+IGC)                                    
            DO 7600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMF = SUMF + FRACREFA(IPRSM,JPJP)                                  
 7600       CONTINUE                                                             
            FRACREFAC(IGC,JPJP) = SUMF                                             
 7400    CONTINUE                                                                
 7000 CONTINUE                                                                   
                                                                                 
   END SUBROUTINE CMBGB13

!***************************************************************************
   SUBROUTINE CMBGB14(abscoefL, abscoefH, SELFREF,                     &
                      FRACREFA, FRACREFB,                              &
                      SELFREFC, FRACREFAC, FRACREFBC                   )
!***************************************************************************     
!                                                                                
!     BAND 14:  2250-2380 cm-1 (low - CO2; high - CO2)                           
!***************************************************************************     
                                                                                 
! Input                                                                          
      REAL abscoefL(5,13,MG),abscoefH(5,13:59,MG)
      REAL SELFREF(10,MG)  
      REAL FRACREFA(MG), FRACREFB(MG)
!     REAL RWGT(MG*NBANDS) 
! Output                                                                         
      REAL SELFREFC(10,NG14)                              
      REAL FRACREFAC(NG14), FRACREFBC(NG14) 
!
      INTEGER :: NGN_X
      integer :: igc,jpjp,jtjt,iprsm,ipr
      real :: sumf,sumk,sumf1,sumf2
                                                                                 
      DO 2000 JTJT = 1,5                                                           
         DO 2200 JPJP = 1,13                                                       
            IPRSM = 0                                                            
            DO 2400 IGC = 1,NGC(14)                                              
               SUMK = 0.                                                         
               NGN_X=NGN(NGS(13)+IGC)
!              DO 2600 IPR = 1, NGN(NGS(13)+IGC)                                 
               DO 2600 IPR = 1, NGN_X
                  IPRSM = IPRSM + 1                                              
                  SUMK = SUMK + abscoefL(JTJT,JPJP,IPRSM)*RWGT(IPRSM+208)
 2600          CONTINUE                                                          
               ABSA14(JTJT+(JPJP-1)*5,IGC) = SUMK
 2400       CONTINUE                                                             
 2200    CONTINUE                                                                
 2000 CONTINUE                                                                   
                                                                                 
      DO 3000 JTJT = 1,5                                                           
         DO 3200 JPJP = 13,59                                                      
            IPRSM = 0                                                            
            DO 3400 IGC = 1,NGC(14)                                              
               SUMK = 0.                                                         
               NGN_X=NGN(NGS(13)+IGC)
!              DO 3600 IPR = 1, NGN(NGS(13)+IGC)                                 
               DO 3600 IPR = 1, NGN_X
                  IPRSM = IPRSM + 1                                              
                  SUMK = SUMK + abscoefH(JTJT,JPJP,IPRSM)*RWGT(IPRSM+208)
 3600          CONTINUE                                                          
               ABSB14(JTJT+(JPJP-13)*5,IGC) = SUMK
 3400       CONTINUE                                                             
 3200    CONTINUE                                                                
 3000 CONTINUE                                                                   
                                                                                 
      DO 4000 JTJT = 1,10                                                          
         IPRSM = 0                                                               
         DO 4400 IGC = 1,NGC(14)                                                 
            SUMK = 0.                                                            
            NGN_X=NGN(NGS(13)+IGC)
!           DO 4600 IPR = 1, NGN(NGS(13)+IGC)                                    
            DO 4600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMK = SUMK + SELFREF(JTJT,IPRSM)*RWGT(IPRSM+208)
 4600       CONTINUE                                                             
            SELFREFC(JTJT,IGC) = SUMK                                              
 4400    CONTINUE                                                                
 4000 CONTINUE                                                                   
                                                                                 
      IPRSM = 0                                                                  
      DO 7400 IGC = 1,NGC(14)                                                    
         SUMF1= 0.                                                               
         SUMF2= 0.                                                               
         NGN_X=NGN(NGS(13)+IGC)
!        DO 7600 IPR = 1, NGN(NGS(13)+IGC)                                       
         DO 7600 IPR = 1, NGN_X
            IPRSM = IPRSM + 1                                                    
            SUMF1= SUMF1+ FRACREFA(IPRSM)                                        
            SUMF2= SUMF2+ FRACREFB(IPRSM)                                        
 7600    CONTINUE                                                                
         FRACREFAC(IGC) = SUMF1                                                  
         FRACREFBC(IGC) = SUMF2                                                  
 7400 CONTINUE                                                                   
                                                                                 
            
   END SUBROUTINE CMBGB14

!***************************************************************************
   SUBROUTINE CMBGB15(abscoefL, SELFREF, FRACREFA,                &
                      SELFREFC, FRACREFAC                         )
!***************************************************************************
!                                                                                
!     BAND 15:  2380-2600 cm-1 (low - N2O,CO2; high - nothing)                   
!***************************************************************************     
                                                                                 
! Input                                                                          
      REAL abscoefL(9,5,13,MG)                                                         
      REAL SELFREF(10,MG)  
      REAL FRACREFA(MG,9)
!     REAL RWGT(MG*NBANDS) 
! Output                                                                         
      REAL SELFREFC(10,NG15)
      REAL FRACREFAC(NG15,9) 
!
      INTEGER :: NGN_X
      integer :: igc,jn,jpjp,jtjt,iprsm,ipr
      real :: sumf,sumk
                                                                                 
      DO 2000 JN = 1,9                                                           
         DO 2000 JTJT = 1,5                                                        
            DO 2200 JPJP = 1,13                                                    
               IPRSM = 0                                                         
               DO 2400 IGC = 1,NGC(15)                                           
                  SUMK = 0.                                                      
                  NGN_X=NGN(NGS(14)+IGC)
!                 DO 2600 IPR = 1, NGN(NGS(14)+IGC)                              
                  DO 2600 IPR = 1, NGN_X
                     IPRSM = IPRSM + 1                                           
                     SUMK = SUMK + abscoefL(JN,JTJT,JPJP,IPRSM)*RWGT(IPRSM+224)
 2600             CONTINUE                                                       
                  ABSA15(JN+(JTJT-1)*9+(JPJP-1)*45,IGC) = SUMK 
 2400          CONTINUE                                                          
 2200       CONTINUE                                                             
 2000 CONTINUE                                                                   
                                                                                 
      DO 4000 JTJT = 1,10                                                          
         IPRSM = 0                                                               
         DO 4400 IGC = 1,NGC(15)                                                 
            SUMK = 0.                                                            
            NGN_X=NGN(NGS(14)+IGC)
!           DO 4600 IPR = 1, NGN(NGS(14)+IGC)                                    
            DO 4600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMK = SUMK + SELFREF(JTJT,IPRSM)*RWGT(IPRSM+224)
 4600       CONTINUE                                                             
            SELFREFC(JTJT,IGC) = SUMK                                              
 4400    CONTINUE                                                                
 4000 CONTINUE                                                                   
                                                                                 
      DO 7000 JPJP = 1,9                                                           
         IPRSM = 0                                                               
         DO 7400 IGC = 1,NGC(15)                                                 
            SUMF = 0.                                                            
            NGN_X=NGN(NGS(14)+IGC)
!           DO 7600 IPR = 1, NGN(NGS(14)+IGC)                                    
            DO 7600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMF = SUMF + FRACREFA(IPRSM,JPJP)                                  
 7600       CONTINUE                                                             
            FRACREFAC(IGC,JPJP) = SUMF                                             
 7400    CONTINUE                                                                
 7000 CONTINUE                                                                   
                                                                                 
   END SUBROUTINE CMBGB15

!***************************************************************************
   SUBROUTINE CMBGB16(abscoefL, SELFREF, FRACREFA,               &
                      SELFREFC, FRACREFAC                        )
!***************************************************************************     
!                                                                                
!     BAND 16:  2600-3000 cm-1 (low - H2O,CH4; high - nothing)                   
!***************************************************************************     
                                                                                 
! Input                                                                          
      REAL abscoefL(9,5,13,MG)                                                         
      REAL SELFREF(10,MG)     
      REAL FRACREFA(MG,9)
!     REAL RWGT(MG*NBANDS) 
! Output                                                                         
      REAL SELFREFC(10,NG16)
      REAL FRACREFAC(NG16,9)
!
      INTEGER :: NGN_X
      integer :: igc,jn,jpjp,jtjt,iprsm,ipr
      real :: sumf,sumk
                                                                                 
      DO 2000 JN = 1,9                                                           
         DO 2000 JTJT = 1,5                                                        
            DO 2200 JPJP = 1,13                                                    
               IPRSM = 0                                                         
               DO 2400 IGC = 1,NGC(16)                                           
                  SUMK = 0.                                                      
                  NGN_X=NGN(NGS(15)+IGC)
!                 DO 2600 IPR = 1, NGN(NGS(15)+IGC)                              
                  DO 2600 IPR = 1, NGN_X
                     IPRSM = IPRSM + 1                                           
                     SUMK = SUMK + abscoefL(JN,JTJT,JPJP,IPRSM)*RWGT(IPRSM+240)
 2600             CONTINUE                                                       
                  ABSA16(JN+(JTJT-1)*9+(JPJP-1)*45,IGC) = SUMK
 2400          CONTINUE                                                          
 2200       CONTINUE                                                             
 2000 CONTINUE                                                                   
                                                                                 
      DO 4000 JTJT = 1,10                                                          
         IPRSM = 0                                                               
         DO 4400 IGC = 1,NGC(16)                                                 
            SUMK = 0.                                                            
            NGN_X=NGN(NGS(15)+IGC)
!           DO 4600 IPR = 1, NGN(NGS(15)+IGC)                                    
            DO 4600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMK = SUMK + SELFREF(JTJT,IPRSM)*RWGT(IPRSM+240)
 4600       CONTINUE                                                             
            SELFREFC(JTJT,IGC) = SUMK                                              
 4400    CONTINUE                                                                
 4000 CONTINUE                                                                   
                                                                                 
      DO 7000 JPJP = 1,9                                                           
         IPRSM = 0                                                               
         DO 7400 IGC = 1,NGC(16)                                                 
            SUMF = 0.                                                            
            NGN_X=NGN(NGS(15)+IGC)
!           DO 7600 IPR = 1, NGN(NGS(15)+IGC)                                    
            DO 7600 IPR = 1, NGN_X
               IPRSM = IPRSM + 1                                                 
               SUMF = SUMF + FRACREFA(IPRSM,JPJP)                                  
 7600       CONTINUE                                                             
            FRACREFAC(IGC,JPJP) = SUMF                                             
 7400    CONTINUE                                                                
 7000 CONTINUE                                                                   
                                                                                 
   END SUBROUTINE CMBGB16
 
!-------------------------------------------------------------------------
   SUBROUTINE INIRAD (O3PROF,Pw, kts, kte)
!-------------------------------------------------------------------------
      IMPLICIT NONE
!-------------------------------------------------------------------------
   INTEGER, INTENT(IN   )                        ::    kts,kte

   REAL, DIMENSION( kts:kte ),INTENT(INOUT)      ::    O3PROF

   REAL, DIMENSION( kts:kte+1 ),INTENT(IN   )    ::        Pw

! LOCAL VAR
  
   REAL, DIMENSION( kts:kte+1 ) :: PAVEL, TAVEL 
   REAL, DIMENSION(   0:kte+1 ) :: PZ, TZ

   INTEGER :: k


!                                                                                
!  COMPUTE OZONE MIXING RATIO DISTRIBUTION                                       
!                                                                                
   DO K=kts,kte
      O3PROF(K)=0.                                                       
   ENDDO
                                                                                 
   CALL O3DATA(O3PROF, Pw, kts, kte)
!                                                                                
   END SUBROUTINE INIRAD
                                                                                 
!-------------------------------------------------------------------------
   SUBROUTINE O3DATA (O3PROF, Pw, kts, kte)
!-------------------------------------------------------------------------
   IMPLICIT NONE
!-------------------------------------------------------------------------
!
   INTEGER, INTENT(IN   )   ::       kts, kte
!
   REAL, DIMENSION( kts:kte ),INTENT(INOUT)      ::    O3PROF

   REAL, DIMENSION( kts:kte+1 ),INTENT(IN   )    ::        Pw

! LOCAL VAR
   INTEGER :: K, JJ, NK

   REAL    ::  PRLEVH(kts:kte+1),PPWRKH(32),                       &
               O3WRK(31),PPWRK(31),O3SUM(31),PPSUM(31),          &
               O3WIN(31),PPWIN(31),O3ANN(31),PPANN(31)                                                       

   REAL    ::  PB1, PB2, PT1, PT2

   DATA O3SUM  /5.297E-8,5.852E-8,6.579E-8,7.505E-8,             &                    
        8.577E-8,9.895E-8,1.175E-7,1.399E-7,1.677E-7,2.003E-7,   &                 
        2.571E-7,3.325E-7,4.438E-7,6.255E-7,8.168E-7,1.036E-6,   &                 
        1.366E-6,1.855E-6,2.514E-6,3.240E-6,4.033E-6,4.854E-6,   &                 
        5.517E-6,6.089E-6,6.689E-6,1.106E-5,1.462E-5,1.321E-5,   &                 
        9.856E-6,5.960E-6,5.960E-6/                                              

   DATA PPSUM  /955.890,850.532,754.599,667.742,589.841,         &  
        519.421,455.480,398.085,347.171,301.735,261.310,225.360, &               
        193.419,165.490,141.032,120.125,102.689, 87.829, 75.123, &            
         64.306, 55.086, 47.209, 40.535, 34.795, 29.865, 19.122, &               
          9.277,  4.660,  2.421,  1.294,  0.647/                                 
!                                                                                
   DATA O3WIN  /4.629E-8,4.686E-8,5.017E-8,5.613E-8,             &
        6.871E-8,8.751E-8,1.138E-7,1.516E-7,2.161E-7,3.264E-7,   &               
        4.968E-7,7.338E-7,1.017E-6,1.308E-6,1.625E-6,2.011E-6,   &               
        2.516E-6,3.130E-6,3.840E-6,4.703E-6,5.486E-6,6.289E-6,   &               
        6.993E-6,7.494E-6,8.197E-6,9.632E-6,1.113E-5,1.146E-5,   &               
        9.389E-6,6.135E-6,6.135E-6/                                              

   DATA PPWIN  /955.747,841.783,740.199,649.538,568.404,         &
        495.815,431.069,373.464,322.354,277.190,237.635,203.433, &               
        174.070,148.949,127.408,108.915, 93.114, 79.551, 67.940, &               
         58.072, 49.593, 42.318, 36.138, 30.907, 26.362, 16.423, &               
          7.583,  3.620,  1.807,  0.938,  0.469/                                 
!                                                                                

   DO K=1,31                                                              
     PPANN(K)=PPSUM(K)                                                        
   ENDDO
!
   O3ANN(1)=0.5*(O3SUM(1)+O3WIN(1))                                           
!                                                                                
   DO K=2,31                                                              
      O3ANN(K)=O3WIN(K-1)+(O3WIN(K)-O3WIN(K-1))/(PPWIN(K)-PPWIN(K-1))* & 
               (PPSUM(K)-PPWIN(K-1))                                           
   ENDDO
!
   DO K=2,31                                                              
      O3ANN(K)=0.5*(O3ANN(K)+O3SUM(K))                                         
   ENDDO
!
   DO K=1,31                                                                
      O3WRK(K)=O3ANN(K)                                                        
      PPWRK(K)=PPANN(K)                                                        
   ENDDO
!                                                                                
!  CALCULATE HALF PRESSURE LEVELS FOR MODEL AND DATA LEVELS                     
!                                                                                

! Pw is total P at w level
! Pw is in mb

   DO K=kts,kte+1
      NK=kte+1-K+1
      PRLEVH(K)=Pw(NK)
   ENDDO
!                                                                                
   PPWRKH(1)=1100.                                                        
   DO K=2,31                                                           
      PPWRKH(K)=(PPWRK(K)+PPWRK(K-1))/2.                                   
   ENDDO
   PPWRKH(32)=0.                                                          
   DO K=kts,kte
      DO 25 JJ=1,31                                                        
         IF((-(PRLEVH(K)-PPWRKH(JJ))).GE.0.)THEN                            
           PB1=0.                                                           
         ELSE                                                               
           PB1=PRLEVH(K)-PPWRKH(JJ)                                         
         ENDIF                                                              
         IF((-(PRLEVH(K)-PPWRKH(JJ+1))).GE.0.)THEN                          
           PB2=0.                                                           
         ELSE                                                               
           PB2=PRLEVH(K)-PPWRKH(JJ+1)                                       
         ENDIF                                                              
         IF((-(PRLEVH(K+1)-PPWRKH(JJ))).GE.0.)THEN                          
           PT1=0.                                                           
         ELSE                                                               
           PT1=PRLEVH(K+1)-PPWRKH(JJ)                                       
         ENDIF                                                              
         IF((-(PRLEVH(K+1)-PPWRKH(JJ+1))).GE.0.)THEN                        
           PT2=0.                                                           
         ELSE                                                               
           PT2=PRLEVH(K+1)-PPWRKH(JJ+1)                                     
         ENDIF                                                              
         O3PROF(K)=O3PROF(K)+(PB2-PB1-PT2+PT1)*O3WRK(JJ)                
  25  CONTINUE                                                             
      O3PROF(K)=O3PROF(K)/(PRLEVH(K)-PRLEVH(K+1))                      

   ENDDO
!                                                                                
   END SUBROUTINE O3DATA

!---------------------------------------------------------------------------
   SUBROUTINE MM5ATM(CLDFRA,O3PROF,T,Tw,TSFC,QV,QC,QR,QI,QS,QG,    &
                     P,Pw,DELZ,EMISS,R,G,                          &
                     PAVEL,TAVEL,PZ,TZ,CLDFRAC,TAUCLOUD,COLDRY,    &
                     WKL,WX,TBOUND,SEMISS,                         &
                     kts,kte                                       )
!---------------------------------------------------------------------------
!  RRTM Longwave Radiative Transfer Model                                        
!  Atmospheric and Environmental Research, Inc., Cambridge, MA                   
!                                                                                
!  Revision for NCAR MM5:  J. Dudhia (converted from CCM code)                   
!                                                                                
!  Input atmospheric profile from NCAR MM5, and prepare it for use in RRTM.      
!  Set other RRTM input parameters.  Values are passed back through existing     
!  RRTM arrays and commons.                                                      
!---------------------------------------------------------------------------
! RRTM Definitions                                                               
!    MXLAY = kte+1                ! Maximum number of model layers               
!    MAXXSEC                      ! Maximum number of cross sections             
!    NLAYERS                      ! Number of model layers (kte+1)               
!    PAVEL(MXLAY)                 ! Layer pressures (mb)                         
!    PZ(0:MXLAY)                  ! Level (interface) pressures (mb)             
!    TAVEL(MXLAY)                 ! Layer temperatures (K)                       
!    TZ(0:MXLAY)                  ! Level (interface) temperatures(mb)           
!    TBOUND                       ! Surface temperature (K)                      
!    COLDRY(MXLAY)                ! Dry air column (molecules/cm2)               
!    WKL(35,MXLAY)                ! Molecular amounts (molecules/cm2)            
!    WBRODL(MXLAY)                ! Inactive in this version                     
!    WX(MAXXSEC)                  ! Cross-section amounts (molecules/cm2)        
!    CLDFRAC(MXLAY)               ! Layer cloud fraction                         
!    TAUCLOUD(MXLAY)              ! Layer cloud optical depth                    
!    AMD                          ! Atomic weight of dry air                     
!    AMW                          ! Atomic weight of water                       
!    AMO                          ! Atomic weight of ozone                       
!    AMCH4                        ! Atomic weight of methane                     
!    AMN2O                        ! Atomic weight of nitrous oxide               
!    AMC11                        ! Atomic weight of CFC-11                      
!    AMC12                        ! Atomic weight of CFC-12                      
!    NXMOL                        ! Number of cross-section molecules            
!    IXINDX                       ! Cross-section molecule index (see below)     
!    IXSECT                       ! On/off flag for cross-sections (inactive)    
!    IXMAX                        ! Maximum number of cross-sections (inactive)  
!                                                                                
!-----------------------------------------------------------------------------
! This compiler directive was added to insure private common block storage       
! in multi-tasked mode on a CRAY or SGI for all commons except those that        
! carry constants.                                                               
!----------------------------------------------------------------------------
!     Activate cross section molecules:                                             
!     NXMOL     - number of cross-sections input by user                         
!     IXINDX(I) - index of cross-section molecule corresponding to Ith           
!                 cross-section specified by user                                
!                 = 0 -- not allowed in RRTM                                     
!                 = 1 -- CCL4                                                    
!                 = 2 -- CFC11                                                   
!                 = 3 -- CFC12                                                   
!                 = 4 -- CFC22                                                   
!     DATA NXMOL  /2/                                                            
!     DATA IXINDX /0,2,3,0,31*0/                                                 
!                                                                                 
!    CLOUD EMISSIVITIES (M^2/G)                                                  
!    THESE ARE CONSISTENT WITH LWRAD (ABCW=0.5*(ABUP+ABDOWN))                    
!----------------------------------------------------------------------------

                                                                                 
      INTEGER, INTENT(IN ) ::  kts, kte
!
      REAL, DIMENSION( 35,kts:kte+1 ),                    &
            INTENT(INOUT)        ::                  WKL

      REAL, DIMENSION( MAXXSEC,kts:kte+1 ),               &
            INTENT(INOUT)        ::                   WX

      REAL, INTENT(INOUT)        ::               TBOUND
      REAL, DIMENSION(NBANDS), INTENT(INOUT) ::   SEMISS

      REAL, DIMENSION( kts:kte+1 ), INTENT(IN   ) ::      &
                                                      Tw, &
                                                      Pw
      REAL, DIMENSION( kts:kte ), INTENT(IN   ) ::        &
                                                  CLDFRA, &
                                                  O3PROF, &
                                                    DELZ, &
                                                       T, &
                                                       P

      REAL, DIMENSION( kts:kte ), INTENT(INOUT) ::        &
                                                      QV

      REAL, DIMENSION( kts:kte ), INTENT(IN   ) ::        &
                                                      QC, &
                                                      QR, &
                                                      QI, &
                                                      QS, &
                                                      QG

      REAL, DIMENSION( kts:kte+1 ), INTENT(INOUT) ::      &
                                                   PAVEL, &
                                                   TAVEL, &
                                                 CLDFRAC, &    
                                                TAUCLOUD, &
                                                  COLDRY 

      REAL, DIMENSION(   0:kte+1 ), INTENT(INOUT) ::      &
                                                      PZ, &
                                                      TZ

      REAL, INTENT(IN   ) ::   R,G,EMISS,TSFC

      REAL    :: GRAVIT
 
!
! LOCAL

      REAL, DIMENSION( kts:kte ) ::                 CLDFRC, &
                                                      PINT, &
                                                      TINT, &
                                                        O3, &
                                                       N2O, &
                                                       CH4, &
                                                      CLWP, &
                                                      CIWP, &
                                                      PLWP, &
                                                      PIWP
                           
      real :: amm
      real :: amd       ! Effective molecular weight of dry air (g/mol)  
      real :: amw       ! Molecular weight of water vapor (g/mol)        
      real :: amo       ! Molecular weight of ozone (g/mol)              
      real :: amch4     ! Molecular weight of methane (g/mol)            
      real :: amn2o     ! Molecular weight of nitrous oxide (g/mol)      
      real :: amc11     ! Molecular weight of CFC11 (g/mol) - CFCL3      
      real :: amc12     ! Molecular weight of CFC12 (g/mol) - CF2CL2     
      real :: avgdro    ! Avogadro's number (molecules/mole)             
                                                                                 
      integer :: ilay,imol,ix,ix_ix,ixmax,ixsect,k,l,n
! Atomic weights for conversion from mass to volume mixing ratios                

      data amd   /  28.9644   /                                                  
      data amw   /  18.0154   /                                                  
      data amo   /  47.9998   /                                                  
      data amch4 /  16.0430   /                                                  
      data amn2o /  44.0128   /                                                  
      data amc11 / 137.3684   /                                                  
      data amc12 / 120.9138   /                                                  
      data avgdro/ 6.022E23   /                                                  
                                                                                 
!     Set molecular weight ratios                                                    

      real :: amdw,  &  ! Molecular weight of dry air / water vapor      
              amdc,  &  ! Molecular weight of dry air / methane          
              amdn,  &  ! Molecular weight of dry air / nitrous oxide    
              amdc1, &  ! Molecular weight of dry air / CFC11            
              amdc2     ! Molecular weight of dry air / CFC12            
      real :: co2vmr,ro,dz
      integer :: isp
      REAL :: ABCW,ABICE,ABRN,ABSN

      data amdw /  1.607758 /                                                    
      data amdc /  1.805423 /                                                    
      data amdn /  0.658090 /                                                    
      data amdc1/  0.210852 /                                                    
      data amdc2/  0.239546 /                                                    

!     Put in CO2 volume mixing ratio here (330 ppmv)                                

      data co2vmr / 330.e-6 /                                                    
                                                                                 

      DATA ABCW /0.144/                                                          
      DATA ABICE /0.0735/                                                        
      DATA ABRN /0.330E-3/                                                       
      DATA ABSN /2.34E-3/                                                        

      GRAVIT = G*100.

!                                                                                
!  MID-LAYER VALUES                                                              
      DO K=kts,kte
          RO=P(K)/(R*T(K))*100.                                                  
          DZ=DELZ(K)
          QV(K)=AMAX1(QV(K),1.E-12) 
  
          CLDFRC(K)=CLDFRA(K)                                                   
                                                                                 
!  PATHS IN G/M^2                                                                

! QI=0 if no ice phase
! QS=0 if no ice phase

            CLWP(K)=RO*QC(K)*DZ*1000.                                            
            CIWP(K)=RO*QI(K)*DZ*1000.                                            
            PLWP(K)=(RO*QR(K))**0.75*DZ*1000.                                    
            PIWP(K)=(RO*QS(K))**0.75*DZ*1000.                                   
                                                                                 
          O3(K)=O3PROF(K)                                                      
          N2O(K)=0.                                                              
          CH4(K)=0.                                                              
                                                                                 
      ENDDO                                                                      
                                                                                 
!  Initialize all molecular amounts to zero here, then pass MM5 amounts          
!  into RRTM arrays WKL and WX below.                                            
                                                                                 
      DO 1000 ILAY = kts,kte+1
         DO 1100 ISP = 1,35                                                      
 1100       WKL(ISP,ILAY) = 0.0                                                  
         DO 1200 ISP = 1,MAXXSEC                                                 
 1200       WX(ISP,ILAY) = 0.0                                                   
 1000 CONTINUE                                                                   
                                                                                 
!  Set parameters needed for RRTM execution:                                     

      IXSECT = 1                                                                 
      IXMAX = 4                                                                  
                                                                                 
!  Set surface temperature.  The longwave upward surface flux is                 
!  computed in the Land Surface Model based on the surface                       
!  temperature and the emissivity of the surface type for each                   
!  grid point.  The bottom interface temperature, tint(kte+1), is                 
!  ground temperature consistent with this LW upward flux, and                   
!  TBOUND is set to this temperature here.                                       
                                                                                 
!     TBOUND = TINT(kte+1)                                                        
      TBOUND = Tw(kte+1)                                                        
!     TBOUND = TSFC
                                                                                 
!  Install MM5 profiles into RRTM arrays for pressure, temperature,              
!  and molecular amounts.  Pressures are converted from cb                       
!  (CCM) to mb (RRTM).  H2O and trace gas amounts are converted from             
!  mass mixing ratio to volume mixing ratio.  CO2 vmr is constant at all         
!  levels.  The dry air column COLDRY (in molec/cm2) is calculated               
!  from the level pressures PZ (in mb) based on the hydrostatic equation         
!  and includes a correction to account for H2O in the layer.  The               
!  molecular weight of moist air (amm) is calculated for each layer.             
                                                                                 
!  RRTM is executed for an additional layer (L=kte+1), which extends              
!  from the model top (ptop) to 0 mb, to calculate the downward                  
!  flux at the model top interface.  H2O, CO2, and O3 vmrs for this              
!  extra layer are set to the values in the model's top layer, though            
!  the O3 value is reduced by a fraction (0.6) based on the US Std Atm.          
!  For GCMs with a model top near 0 mb, this extra layer is not needed, and      
!  NLAYERS should be set to the number of model layers (kte in this case).       
!  Note: RRTM levels count from bottom to top, while MM5 levels count            
!  from the top down and must be reversed here.                                  
                                                                                 
!     NMOL = 6                                                                   
!     PZ(0) = pint(kte+1)                                                         
!     TZ(0) = tint(kte+1)                                                         

      PZ(0) = Pw(kte+1)                                                         
      TZ(0) = Tw(kte+1)                                                         
      DO 2000 L = 1, NLAYERS-1                                                   
         PAVEL(L) = p(kte+1-L)                                                   
         TAVEL(L) = t(kte+1-L)                                                   
!        PZ(L) = pint(kte+1-L)                                                    
!        TZ(L) = tint(kte+1-L)                                                    
         PZ(L) = Pw(kte+1-L)                                                    
         TZ(L) = Tw(kte+1-L)                                                    
         WKL(1,L) = qv(kte+1-L)*amdw                                             
         WKL(2,L) = co2vmr                                                       
         WKL(3,L) = o3(kte+1-L)                                                  
         WKL(4,L) = n2o(kte+1-L)*amdn                                            
         WKL(6,L) = ch4(kte+1-L)*amdc                                            
         amm = (1-WKL(1,L))*amd + WKL(1,L)*amw                                   
         COLDRY(L) = (PZ(L-1)-PZ(L))*1.E3*avgdro/    & 
                               (gravit*amm*(1+WKL(1,L)))                         
 2000    CONTINUE                                                                
                                                                                 
!  Set cross section molecule amounts from CCM; convert to vmr                   
      DO 2100 L=1, NLAYERS-1                                                     
!        WX(2,L) = c11mmr(kte+1-L)*amdc1                                         
!        WX(3,L) = c12mmr(kte+1-L)*amdc2                                         
         WX(2,L) = 0.                                                            
         WX(3,L) = 0.                                                            
 2100 CONTINUE                                                                   
                                                                                 
!  *****                                                                         
!  Set up values for extra layer at top of the atmosphere.                       
!  The top layer temperature for all gridpoints is set to the top layer-1        
!  temperature plus a constant (0 K) that represents an isothermal layer         
!  above ptop.  Top layer interface temperatures are                             
!  linearly interpolated from the layer temperatures.                            
!  Note: The top layer temperature and ozone amount are based on a 0-3mb         
!  top layer and must be modified if the layering is changed.                    
!  This section should be commented if the extra layer is not needed.            
                                                                                 
      PAVEL(NLAYERS) = 0.5*PZ(NLAYERS-1)                                         
      TAVEL(NLAYERS) = TAVEL(NLAYERS-1) + 0.0                                    
      PZ(NLAYERS) = 0.00                                                         
      TZ(NLAYERS-1) = 0.5*(TAVEL(NLAYERS)+TAVEL(NLAYERS-1))                      
      TZ(NLAYERS) = TZ(NLAYERS-1)+0.0                                            
      WKL(1,NLAYERS) = WKL(1,NLAYERS-1)                                          
      WKL(2,NLAYERS) = co2vmr                                                    
      WKL(3,NLAYERS) = 0.6*WKL(3,NLAYERS-1)                                      
      WKL(4,NLAYERS) = WKL(4,NLAYERS-1)                                          
      WKL(6,NLAYERS) = WKL(6,NLAYERS-1)                                          
      amm = (1-WKL(1,NLAYERS-1))*amd + WKL(1,NLAYERS-1)*amw                      
!     COLDRY(NLAYERS) = (PZ(NLAYERS-1))*1.E3*avgdro/       & 
      COLDRY(NLAYERS) = ((PZ(NLAYERS-1)-PZ(NLAYERS)))*1.E3*avgdro/       & 
                               (gravit*amm*(1+WKL(1,NLAYERS-1)))                 
      WX(2,NLAYERS) = WX(2,NLAYERS-1)                                            
      WX(3,NLAYERS) = WX(3,NLAYERS-1)                                            
!  *****                                                                         
                                                                                 
!  Here, all molecules in WKL and WX are in volume mixing ratio; convert to      
!  molec/cm2 based on COLDRY for use in RRTM                                     
                                                                                 
      DO 5000 L = 1, NLAYERS                                                     
         DO 4200 IMOL = 1, NMOL                                                  
            WKL(IMOL,L) = COLDRY(L) * WKL(IMOL,L)                                
 4200    CONTINUE                                                                
         DO 4400 IX = 1,MAXXSEC                                                  
            IX_IX=IXINDX(IX)
!           IF (IXINDX(IX) .NE. 0) THEN                                          
            IF (IX_IX .NE. 0) THEN                                          
               WX(IXINDX(IX),L) = COLDRY(L) * WX(IX,L) * 1.E-20                  
            ENDIF                                                                
 4400    CONTINUE                                                                
 5000 CONTINUE                                                                   
                                                                                 
!  Set spectral surface emissivity for each longwave band.  The default value    
!  is set here to emiss(i,j) based on land-use (taken to be constant across band 
!  Comment: if land-surface uses skin temperature, emissivity must match that    
!   used in its calculation (e.g. 1.0)                                           
      DO 5500 N=1,NBANDS                                                         
         SEMISS(N) = EMISS
 5500 CONTINUE                                                                   
                                                                                 
!  Transfer cloud fraction to RRTM array; compute cloud optical depth, TAUCLOUD, 
!  as the product of clwp and cloud mass absorption coefficient in MM5, which is 
!  a  combination of liquid and ice absorption coefficients.                     
!  Note: RRTM levels count from bottom to top, while CCM levels count from the   
!  top down and must be reversed here.  Values for the extra RRTM level (above   
!  the model top) are set to zero.                                               
                                                                                 
      DO 7000 L = 1, NLAYERS-1                                                   
         TAUCLOUD(L) = ABCW*CLWP(kte+1-L)+ABICE*CIWP(kte+1-L) & 
                      +ABRN*PLWP(kte+1-L)+ABSN*PIWP(kte+1-L)                       
         IF(TAUCLOUD(L).GT.0.01)CLDFRC(kte+1-L)=1.                                
         CLDFRAC(L) = cldfrc(kte+1-L)                                             
 7000 CONTINUE                                                                   
      CLDFRAC(NLAYERS) = 0.0                                                     
      TAUCLOUD(NLAYERS) = 0.0                                                    

   END SUBROUTINE MM5ATM

!---------------------------------------------------------------------------
      SUBROUTINE SETCOEF(kts,ktep1,                                        &
                         PAVEL,TAVEL,COLDRY,COLH2O,COLCO2,COLO3,           &
                         COLN2O,COLCH4,COLO2,CO2MULT,                      &
                         FAC00,FAC01,FAC10,FAC11,                          &
                         FORFAC,SELFFAC,SELFFRAC,                          &
                         JP,JT,JT1,INDSELF,WKL,LAYTROP,LAYSWTCH,LAYLOW     )
!---------------------------------------------------------------------------
      IMPLICIT NONE
!---------------------------------------------------------------------------
!  RRTM Longwave Radiative Transfer Model                                        
!  Atmospheric and Environmental Research, Inc., Cambridge, MA                   
!                                                                                
!  Original version:       E. J. Mlawer, et al.                                  
!  Revision for NCAR CCM:  Michael J. Iacono; September, 1998                    
!                                                                                
!  For a given atmosphere, calculate the indices and fractions related to the    
!  pressure and temperature interpolations.  Also calculate the values of the    
!  integrated Planck functions for each band at the level and layer              
!  temperatures.                                                                 
!---------------------------------------------------------------------------

      INTEGER, INTENT(IN   ) ::          kts, ktep1

      REAL, DIMENSION( 35,kts:ktep1),                    &
            INTENT(IN   )        ::                  WKL

      INTEGER, INTENT(INOUT) ::  LAYTROP,LAYSWTCH,LAYLOW

      REAL, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::      &
                                                   PAVEL, &
                                                   TAVEL, &
                                                  COLDRY

      REAL, DIMENSION( kts:ktep1 ), INTENT(INOUT) ::      &
                                                  COLH2O, &
                                                  COLCO2, &
                                                   COLO3, &
                                                  COLN2O, &
                                                  COLCH4, &
                                                   COLO2, &
                                                 CO2MULT, &
                                                   FAC00, &
                                                   FAC01, &
                                                   FAC10, &
                                                   FAC11, &
                                                  FORFAC, &
                                                 SELFFAC, &
                                                SELFFRAC

      INTEGER, DIMENSION( kts:ktep1 ), INTENT(INOUT) ::   &
                                                      JP, &
                                                      JT, &
                                                     JT1, &
                                                 INDSELF
! LOCAL 
     
      INTEGER ::   LAY, JP1 
      REAL    ::   STPFAC, PLOG, FP, FT, FT1, WATERS, WATER, &
                   CALEFAC, FACTOR, CO2REG, COMPFP, SCALEFAC 

! This compiler directive was added to insure private common block storage       
! in multi-tasked mode on a CRAY or SGI for all commons except those that        
! carry constants.                                                               
                                                                                 
      STPFAC = 296./1013.                                                        
      
      LAYTROP = 0                                                                
      LAYSWTCH = 0                                                               
      LAYLOW = 0                                                                 
      DO 7000 LAY = 1, NLAYERS                                                   
!        Find the two reference pressures on either side of the                  
!        layer pressure.  Store them in JP and JP1.  Store in FP the             
!        fraction of the difference (in ln(pressure)) between these              
!        two values that the layer pressure lies.                                
         PLOG = LOG(PAVEL(LAY))                                                  
         JP(LAY) = INT(36. - 5*(PLOG+0.04))                                      
         IF (JP(LAY) .LT. 1) THEN                                                
            JP(LAY) = 1                                                          
         ELSEIF (JP(LAY) .GT. 58) THEN                                           
            JP(LAY) = 58                                                         
         ENDIF                                                                   
         JP1 = JP(LAY) + 1                                                       
         FP = 5. * (PREFLOG(JP(LAY)) - PLOG)                                     
                                                                                 
!        Determine, for each reference pressure (JP and JP1), which              
!        reference temperature (these are different for each                     
!        reference pressure) is nearest the layer temperature but does           
!        not exceed it.  Store these indices in JT and JT1, resp.                
!        Store in FT (resp. FT1) the fraction of the way between JT              
!        (JT1) and the next highest reference temperature that the               
!        layer temperature falls.                                                
         JT(LAY) = INT(3. + (TAVEL(LAY)-TREF(JP(LAY)))/15.)                      
         IF (JT(LAY) .LT. 1) THEN                                                
            JT(LAY) = 1                                                          
         ELSEIF (JT(LAY) .GT. 4) THEN                                            
            JT(LAY) = 4                                                          
         ENDIF                                                                   
         FT = ((TAVEL(LAY)-TREF(JP(LAY)))/15.) - FLOAT(JT(LAY)-3)                
         JT1(LAY) = INT(3. + (TAVEL(LAY)-TREF(JP1))/15.)                         
         IF (JT1(LAY) .LT. 1) THEN                                               
            JT1(LAY) = 1                                                         
         ELSEIF (JT1(LAY) .GT. 4) THEN                                           
            JT1(LAY) = 4                                                         
         ENDIF                                                                   
         FT1 = ((TAVEL(LAY)-TREF(JP1))/15.) - FLOAT(JT1(LAY)-3)                  
                                                                                 
         WATER = WKL(1,LAY)/COLDRY(LAY)                                          
         SCALEFAC = PAVEL(LAY) * STPFAC / TAVEL(LAY)                             
                                                                                 
!        If the pressure is less than ~100mb, perform a different                
!        set of species interpolations.                                          
         IF (PLOG .LE. 4.56) GO TO 5300                                          
         LAYTROP =  LAYTROP + 1                                                  
!        For one band, the "switch" occurs at ~300 mb.                           
! JD: changed from (PLOG .GE. 5.76) to avoid out-of-range                        
         IF (PLOG .Gt. 5.76) LAYSWTCH = LAYSWTCH + 1                             
         IF (PLOG .GE. 6.62) LAYLOW = LAYLOW + 1                                 
!                                                                                
         FORFAC(LAY) = SCALEFAC / (1.+WATER)                                     
!        Set up factors needed to separately include the water vapor             
!        self-continuum in the calculation of absorption coefficient.            
         SELFFAC(LAY) = WATER * FORFAC(LAY)                                      
         FACTOR = (TAVEL(LAY)-188.0)/7.2                                         
         INDSELF(LAY) = MIN(9, MAX(1, INT(FACTOR)-7))                            
         SELFFRAC(LAY) = FACTOR - FLOAT(INDSELF(LAY) + 7)                        
                                                                                 
!        Calculate needed column amounts.                                        
         COLH2O(LAY) = 1.E-20 * WKL(1,LAY)                                       
         COLCO2(LAY) = 1.E-20 * WKL(2,LAY)                                       
         COLO3(LAY) = 1.E-20 * WKL(3,LAY)                                        
         COLN2O(LAY) = 1.E-20 * WKL(4,LAY)                                       
         COLCH4(LAY) = 1.E-20 * WKL(6,LAY)                                       
         COLO2(LAY) = 1.E-20 * WKL(7,LAY)                                        
         IF (COLCO2(LAY) .EQ. 0.) COLCO2(LAY) = 1.E-32 * COLDRY(LAY)             
         IF (COLN2O(LAY) .EQ. 0.) COLN2O(LAY) = 1.E-32 * COLDRY(LAY)             
         IF (COLCH4(LAY) .EQ. 0.) COLCH4(LAY) = 1.E-32 * COLDRY(LAY)             
!        Using E = 1334.2 cm-1.                                                  
         CO2REG = 3.55E-24 * COLDRY(LAY)                                         
         CO2MULT(LAY)= (COLCO2(LAY) - CO2REG) *    & 
              272.63*EXP(-1919.4/TAVEL(LAY))/(8.7604E-4*TAVEL(LAY))              
         GO TO 5400                                                              
                                                                                 
!        Above LAYTROP.                                                          
 5300    CONTINUE                                                                
                                                                                 
         FORFAC(LAY) = SCALEFAC / (1.+WATER)                                     
!        Calculate needed column amounts.                                        
         COLH2O(LAY) = 1.E-20 * WKL(1,LAY)                                       
         COLCO2(LAY) = 1.E-20 * WKL(2,LAY)                                       
         COLO3(LAY) = 1.E-20 * WKL(3,LAY)                                        
         COLN2O(LAY) = 1.E-20 * WKL(4,LAY)                                       
         COLCH4(LAY) = 1.E-20 * WKL(6,LAY)                                       
         COLO2(LAY) = 1.E-20 * WKL(7,LAY)                                        
         IF (COLCO2(LAY) .EQ. 0.) COLCO2(LAY) = 1.E-32 * COLDRY(LAY)             
         IF (COLN2O(LAY) .EQ. 0.) COLN2O(LAY) = 1.E-32 * COLDRY(LAY)             
         IF (COLCH4(LAY) .EQ. 0.) COLCH4(LAY) = 1.E-32 * COLDRY(LAY)             
         CO2REG = 3.55E-24 * COLDRY(LAY)                                         
         CO2MULT(LAY)= (COLCO2(LAY) - CO2REG) *   & 
              272.63*EXP(-1919.4/TAVEL(LAY))/(8.7604E-4*TAVEL(LAY))              
 5400    CONTINUE                                                                
                                                                                 
!        We have now isolated the layer ln pressure and temperature,             
!        between two reference pressures and two reference temperatures          
!        (for each reference pressure).  We multiply the pressure                
!        fraction FP with the appropriate temperature fractions to get           
!        the factors that will be needed for the interpolation that yields       
!        the optical depths (performed in routines TAUGBn for band n).           
                                                                                 
         COMPFP = 1. - FP                                                        
         FAC10(LAY) = COMPFP * FT                                                
         FAC00(LAY) = COMPFP * (1. - FT)                                         
         FAC11(LAY) = FP * FT1                                                   
         FAC01(LAY) = FP * (1. - FT1)                                            
                                                                                 
 7000 CONTINUE                                                                   
                                                                                 
!        Set LAYLOW for profiles with surface pressure less than 750mb.          
         IF (LAYLOW.EQ.0) LAYLOW=1                                               
!        Sometimes round-off gives wrong LAYSWTCH therefore check here (JD)
         IF (JP(LAYSWTCH+1).LE.6) THEN
           LAYSWTCH=LAYSWTCH+1
         ENDIF

   END SUBROUTINE SETCOEF

!-------------------------------------------------------------------------------
!*                                                                             * 
!*                  Optical depths developed for the                           * 
!*                                                                             * 
!*                RAPID RADIATIVE TRANSFER MODEL (RRTM)                        * 
!*                                                                             * 
!*                                                                             * 
!*            ATMOSPHERIC AND ENVIRONMENTAL RESEARCH, INC.                     * 
!*                        840 MEMORIAL DRIVE                                   * 
!*                        CAMBRIDGE, MA 02139                                  * 
!*                                                                             * 
!*                                                                             * 
!*                           ELI J. MLAWER                                     * 
!*                         STEVEN J. TAUBMAN                                   * 
!*                         SHEPARD A. CLOUGH                                   * 
!*                                                                             * 
!*                                                                             * 
!*                                                                             * 
!*                                                                             * 
!*                       email:  mlawer@aer.com                                * 
!*                                                                             * 
!*        The authors wish to acknowledge the contributions of the             * 
!*        following people:  Patrick D. Brown, Michael J. Iacono,              * 
!*        Ronald E. Farren, Luke Chen, Robert Bergstrom.                       * 
!*                                                                             * 
!-------------------------------------------------------------------------------
!*                                                                             * 
!*  Revision for NCAR CCM:  Michael J. Iacono; September, 1998                 * 
!*                                                                             * 
!*     TAUMOL                                                                  * 
!*                                                                             * 
!*     This file contains the subroutines TAUGBn (where n goes from            * 
!*     1 to 16).  TAUGBn calculates the optical depths and Planck fractions    * 
!*     per g-value and layer for band n.                                       * 
!*                                                                             * 
!*  Output:  optical depths (unitless)                                         * 
!*           fractions needed to compute Planck functions at every layer       * 
!*               and g-value                                                   * 
!*                                                                             * 
!*     COMMON /TAUGCOM/  TAUG(MXLAY,MG)                                        * 
!*     COMMON /PLANKG/   FRACS(MXLAY,MG)                                       * 
!*                                                                             * 
!*  Input                                                                      * 
!*                                                                             * 
!*     COMMON /FEATURES/ NG(NBANDS),NSPA(NBANDS),NSPB(NBANDS)                  * 
!*     COMMON /PRECISE/  ONEMINUS                                              * 
!*     COMMON /PROFILE/  NLAYERS,PAVEL(MXLAY),TAVEL(MXLAY),                    * 
!*    &                  PZ(0:MXLAY),TZ(0:MXLAY)                               * 
!*     COMMON /PROFDATA/ LAYTROP,LAYSWTCH,LAYLOW,                              * 
!*    &                  COLH2O(MXLAY),COLCO2(MXLAY),                          * 
!*    &                  COLO3(MXLAY),COLN2O(MXLAY),COLCH4(MXLAY),             * 
!*    &                  COLO2(MXLAY),CO2MULT(MXLAY)                           * 
!*     COMMON /INTFAC/   FAC00(MXLAY),FAC01(MXLAY),                            * 
!*    &                  FAC10(MXLAY),FAC11(MXLAY)                             * 
!*     COMMON /INTIND/   JP(MXLAY),JT(MXLAY),JT1(MXLAY)                        * 
!*     COMMON /SELF/     SELFFAC(MXLAY), SELFFRAC(MXLAY), INDSELF(MXLAY)       * 
!*                                                                             * 
!*     Description:                                                            * 
!*     NG(IBAND) - number of g-values in band IBAND                            * 
!*     NSPA(IBAND) - for the lower atmosphere, the number of reference         * 
!*                   atmospheres that are stored for band IBAND per            * 
!*                   pressure level and temperature.  Each of these            * 
!*                   atmospheres has different relative amounts of the         * 
!*                   key species for the band (i.e. different binary           * 
!*                   species parameters).                                      * 
!*     NSPB(IBAND) - same for upper atmosphere                                 * 
!*     ONEMINUS - since problems are caused in some cases by interpolation     * 
!*                parameters equal to or greater than 1, for these cases       * 
!*                these parameters are set to this value, slightly < 1.        * 
!*     PAVEL - layer pressures (mb)                                            * 
!*     TAVEL - layer temperatures (degrees K)                                  * 
!*     PZ - level pressures (mb)                                               * 
!*     TZ - level temperatures (degrees K)                                     * 
!*     LAYTROP - layer at which switch is made from one combination of         * 
!*               key species to another                                        * 
!*     COLH2O, COLCO2, COLO3, COLN2O, COLCH4 - column amounts of water         * 
!*               vapor,carbon dioxide, ozone, nitrous ozide, methane,          * 
!*               respectively (molecules/cm**2)                                * 
!*     CO2MULT - for bands in which carbon dioxide is implemented as a         * 
!*               trace species, this is the factor used to multiply the        * 
!*               band's average CO2 absorption coefficient to get the added    * 
!*               contribution to the optical depth relative to 355 ppm.        * 
!*     FACij(LAY) - for layer LAY, these are factors that are needed to        * 
!*                  compute the interpolation factors that multiply the        * 
!*                  appropriate reference k-values.  A value of 0 (1) for      * 
!*                  i,j indicates that the corresponding factor multiplies     * 
!*                  reference k-value for the lower (higher) of the two        * 
!*                  appropriate temperatures, and altitudes, respectively.     * 
!*     JP - the index of the lower (in altitude) of the two appropriate        * 
!*          reference pressure levels needed for interpolation                 * 
!*     JT, JT1 - the indices of the lower of the two appropriate reference     * 
!*               temperatures needed for interpolation (for pressure           * 
!*               levels JP and JP+1, respectively)                             * 
!*     SELFFAC - scale factor needed to water vapor self-continuum, equals     * 
!*               (water vapor density)/(atmospheric density at 296K and        * 
!*               1013 mb)                                                      * 
!*     SELFFRAC - factor needed for temperature interpolation of reference     * 
!*                water vapor self-continuum data                              * 
!*     INDSELF - index of the lower of the two appropriate reference           * 
!*               temperatures needed for the self-continuum interpolation      * 
!*                                                                             * 
!*  Data input                                                                 * 
!*     COMMON /Kn/ KA(NSPA(n),5,13,MG), KB(NSPB(n),5,13:59,MG), SELFREF(10,MG) * 
!*        (note:  n is the band number)                                        * 
!*                                                                             * 
!*     Description:                                                            * 
!*     KA - k-values for low reference atmospheres (no water vapor             * 
!*          self-continuum) (units: cm**2/molecule)                            * 
!*     KB - k-values for high reference atmospheres (all sources)              * 
!*          (units: cm**2/molecule)                                            * 
!*     SELFREF - k-values for water vapor self-continuum for reference         * 
!*               atmospheres (used below LAYTROP)                              * 
!*               (units: cm**2/molecule)                                       * 
!*                                                                             * 
!*     DIMENSION ABSA(65*NSPA(n),MG), ABSB(235*NSPB(n),MG)                     * 
!*     EQUIVALENCE (KA,ABSA),(KB,ABSB)                                         * 
!*                                                                             * 
!******************************************************************************* 
                                                                                 
!---------------------------------------------------------------------------    
      SUBROUTINE TAUGB1(kts,ktep1,COLH2O,FAC00,FAC01,FAC10,FAC11,          &
                        FORFAC,SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,         &
                        PFRAC,TAUG,LAYTROP                                 )
!---------------------------------------------------------------------------    
                                                                                 
      INTEGER, INTENT(IN )                      :: kts,ktep1

      INTEGER, INTENT(IN )                      ::  LAYTROP

      REAL, DIMENSION( NGPT,kts:ktep1 ),                    &
            INTENT(INOUT)        ::                  PFRAC, &
                                                      TAUG

      REAL, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::        &
                                                    COLH2O, &
                                                     FAC00, &
                                                     FAC01, &
                                                     FAC10, &
                                                     FAC11, &
                                                    FORFAC, &
                                                   SELFFAC, &
                                                  SELFFRAC 
 
      INTEGER, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::     &
                                                        JP, &
                                                        JT, &
                                                       JT1, &
                                                   INDSELF
      integer :: lay,ig,ind0,ind1,inds

!     Written by Eli J. Mlawer, Atmospheric & Environmental Research.            
!     Revised by Michael J. Iacono, Atmospheric & Environmental Research.        
                                                                                 
!     BAND 1:  10-250 cm-1 (low - H2O; high - H2O)                               
                                                                                 
! This compiler directive was added to insure private common block storage       
! in multi-tasked mode on a CRAY or SGI for all commons except those that        
! carry constants.                                                               
                                                                                 
!     Compute the optical depth by interpolating in ln(pressure) and             
!     temperature.  Below LAYTROP, the water vapor self-continuum                
!     is interpolated (in temperature) separately.                               
!cdir novector
      DO 2500 LAY = 1, LAYTROP                                                   
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(1) + 1                          
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(1) + 1                             
         INDS = INDSELF(LAY)                                                     
         DO 2000 IG = 1, NG1                                                     
            TAUG(IG,LAY) = COLH2O(LAY) *                       & 
                (FAC00(LAY) * ABSA1(IND0,IG) +                  &                 
                 FAC10(LAY) * ABSA1(IND0+1,IG) +                &                 
                 FAC01(LAY) * ABSA1(IND1,IG) +                  &                 
                 FAC11(LAY) * ABSA1(IND1+1,IG) +                &                 
                 SELFFAC(LAY) * (SELFREFC1(INDS,IG) +            &                 
                 SELFFRAC(LAY) *                               &                 
                 (SELFREFC1(INDS+1,IG) - SELFREFC1(INDS,IG))) +    &                 
                 FORFAC(LAY) * FORREFC1(IG))                                       
            PFRAC(IG,LAY) = FRACREFAC1(IG)                                         
 2000    CONTINUE                                                                
 2500 CONTINUE                                                                   
                                                                                 
!cdir novector
      DO 3500 LAY = LAYTROP+1, NLAYERS                                           
         IND0 = ((JP(LAY)-13)*5+(JT(LAY)-1))*NSPB(1) + 1                         
         IND1 = ((JP(LAY)-12)*5+(JT1(LAY)-1))*NSPB(1) + 1                        
         DO 3000 IG = 1, NG1                                                     
            TAUG(IG,LAY) = COLH2O(LAY) *                      &
                (FAC00(LAY) * ABSB1(IND0,IG) +                 &                  
                 FAC10(LAY) * ABSB1(IND0+1,IG) +               &                  
                 FAC01(LAY) * ABSB1(IND1,IG) +                 &                  
                 FAC11(LAY) * ABSB1(IND1+1,IG) +               &                  
                 FORFAC(LAY) * FORREFC1(IG))                                       
            PFRAC(IG,LAY) = FRACREFBC1(IG)                                         
 3000    CONTINUE                                                                
 3500 CONTINUE                                                                   
     
      END SUBROUTINE TAUGB1                        
                                                                                 
!----------------------------------------------------------------------------    
      SUBROUTINE TAUGB2(kts,ktep1,COLDRY,COLH2O,FAC00,FAC01,FAC10,FAC11,    &
                        FORFAC,SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,          &
                        PFRAC,TAUG,LAYTROP                                  )
!----------------------------------------------------------------------------    
                                                                                 
!     BAND 2:  250-500 cm-1 (low - H2O; high - H2O)                              
                                                                                 
      INTEGER, INTENT(IN )                      :: kts,ktep1

      INTEGER, PARAMETER :: NGS1=8                                       

      INTEGER, INTENT(IN )                      ::  LAYTROP

      REAL, DIMENSION( NGPT,kts:ktep1 ),                    &
            INTENT(INOUT)        ::                  PFRAC, &
                                                      TAUG

      REAL, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::        &
                                                    COLDRY, &   
                                                    COLH2O, &
                                                     FAC00, &
                                                     FAC01, &
                                                     FAC10, &
                                                     FAC11, &
                                                    FORFAC, &
                                                   SELFFAC, &
                                                  SELFFRAC 
 
      INTEGER, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::     &
                                                        JP, &
                                                        JT, &
                                                       JT1, &
                                                   INDSELF
      integer :: ifp,ifrac,lay,ig,ind0,ind1,inds
      real :: fp,fracint,h2oparam,water

! This compiler directive was added to insure private common block storage       
! in multi-tasked mode on a CRAY or SGI for all commons except those that        
! carry constants.                                                               
                                                                                 
      REAL,DIMENSION(kts:ktep1) :: FC00,FC01,FC10,FC11
      REAL,DIMENSION(13) :: REFPARAM
                                                                                 
!     These are the mixing ratios for H2O for a MLS atmosphere at the            
!     13 RRTM reference pressure levels:  1.8759999E-02, 1.2223309E-02,          
!     5.8908667E-03, 2.7675382E-03, 1.4065107E-03, 7.5969833E-04,                
!     3.8875898E-04, 1.6542293E-04, 3.7189537E-05, 7.4764857E-06,                
!     4.3081886E-06, 3.3319423E-06, 3.2039343E-06/                               
                                                                                 
!     The following are parameters related to the reference water vapor          
!     mixing ratios by REFPARAM(I) = REFH2O(I) / (.002+REFH2O(I)).               
!     These parameters are used for the Planck function interpolation.           
      DATA REFPARAM/  &                                                          
        0.903661, 0.859386, 0.746542, 0.580496, 0.412889, 0.275283, & 
        0.162745, 7.63929E-02, 1.82553E-02, 3.72432E-03,            &            
        2.14946E-03, 1.66320E-03, 1.59940E-03/                                   
                                                                                 
!     Compute the optical depth by interpolating in ln(pressure) and             
!     temperature.  Below LAYTROP, the water vapor self-continuum is             
!     interpolated (in temperature) separately.                                  
!cdir novector
      DO 2500 LAY = 1, LAYTROP                                                   
         WATER = 1.E20 * COLH2O(LAY) / COLDRY(LAY)                               
         H2OPARAM = WATER/(WATER +.002)                                          
         DO 1800 IFRAC = 2, 12                                                   
            IF (H2OPARAM .GE. REFPARAM(IFRAC)) GO TO 1900                        
 1800    CONTINUE                                                                
 1900    CONTINUE                                                                
         FRACINT = (H2OPARAM-REFPARAM(IFRAC))/    & 
              (REFPARAM(IFRAC-1)-REFPARAM(IFRAC))                                
                                                                                 
         FP = FAC11(LAY) + FAC01(LAY)                                            
         IFP = 2.E2*FP+0.5                                                       
         IF (IFP.LE.0) IFP = 0                                                   
         FC00(LAY) = FAC00(LAY) * CORR2(IFP)                                     
         FC10(LAY) = FAC10(LAY) * CORR2(IFP)                                     
         FC01(LAY) = FAC01(LAY) * CORR1(IFP)                                     
         FC11(LAY) = FAC11(LAY) * CORR1(IFP)                                     
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(2) + 1                          
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(2) + 1                             
         INDS = INDSELF(LAY)                                                     
         DO 2000 IG = 1, NG2                                                     
            TAUG(NGS1+IG,LAY) = COLH2O(LAY) *                   &                
                (FC00(LAY) * ABSA2(IND0,IG) +                    &                
                 FC10(LAY) * ABSA2(IND0+1,IG) +                  &                
                 FC01(LAY) * ABSA2(IND1,IG) +                    &                
                 FC11(LAY) * ABSA2(IND1+1,IG) +                  &                
                 SELFFAC(LAY) * (SELFREFC2(INDS,IG) +             &                
                 SELFFRAC(LAY) *                                &                
                 (SELFREFC2(INDS+1,IG) - SELFREFC2(INDS,IG))) +     &                
                 FORFAC(LAY) * FORREFC2(IG))                                       
            PFRAC(NGS1+IG,LAY) = FRACREFAC2(IG,IFRAC) + FRACINT * &
                 (FRACREFAC2(IG,IFRAC-1)-FRACREFAC2(IG,IFRAC))                       
 2000    CONTINUE                                                                
 2500 CONTINUE                                                                   
                                                                                 
!cdir novector
      DO 3500 LAY = LAYTROP+1, NLAYERS                                           
         FP = FAC11(LAY) + FAC01(LAY)                                            
         IFP = 2.E2*FP+0.5                                                       
         IF (IFP.LE.0) IFP = 0                                                   
         FC00(LAY) = FAC00(LAY) * CORR2(IFP)                                     
         FC10(LAY) = FAC10(LAY) * CORR2(IFP)                                     
         FC01(LAY) = FAC01(LAY) * CORR1(IFP)                                     
         FC11(LAY) = FAC11(LAY) * CORR1(IFP)                                     
         IND0 = ((JP(LAY)-13)*5+(JT(LAY)-1))*NSPB(2) + 1                         
         IND1 = ((JP(LAY)-12)*5+(JT1(LAY)-1))*NSPB(2) + 1                        
         DO 3000 IG = 1, NG2                                                     
            TAUG(NGS1+IG,LAY) = COLH2O(LAY) *                  & 
                (FC00(LAY) * ABSB2(IND0,IG) +                   &                  
                 FC10(LAY) * ABSB2(IND0+1,IG) +                 &                  
                 FC01(LAY) * ABSB2(IND1,IG) +                   &                  
                 FC11(LAY) * ABSB2(IND1+1,IG) +                 &                  
                 FORFAC(LAY) * FORREFC2(IG))                                       
            PFRAC(NGS1+IG,LAY) = FRACREFBC2(IG)                                    
 3000    CONTINUE                                                                
 3500 CONTINUE                                                                   
                                                                                 
      END SUBROUTINE TAUGB2
                                                                                 
!-----------------------------------------------------------------------------    
      SUBROUTINE TAUGB3(kts,ktep1,COLH2O,COLCO2,COLN2O,FAC00,FAC01,FAC10,    &
                        FAC11,FORFAC,SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,     &
                        PFRAC,TAUG,LAYTROP                                   )
!-----------------------------------------------------------------------------    
                                                                                 
!     BAND 3:  500-630 cm-1 (low - H2O,CO2; high - H2O,CO2)                      
                                                                                 
      INTEGER, PARAMETER :: NGS2=22                                      
                                                                                 
      INTEGER, INTENT(IN )                      :: kts,ktep1

      INTEGER, INTENT(IN )                      ::  LAYTROP

      REAL, DIMENSION( NGPT,kts:ktep1 ),                    &
            INTENT(INOUT)        ::                  PFRAC, &
                                                      TAUG

      REAL, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::        &
                                                    COLH2O, &
                                                    COLCO2, &
                                                    COLN2O, &
                                                     FAC00, &
                                                     FAC01, &
                                                     FAC10, &
                                                     FAC11, &
                                                    FORFAC, &
                                                   SELFFAC, &
                                                  SELFFRAC 
 
      INTEGER, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::     &
                                                        JP, &
                                                        JT, &
                                                       JT1, &
                                                   INDSELF
      integer :: lay,ig,ind0,ind1,inds
      integer :: js,ns
      real :: fp,fs,ratio,speccomb,specparm,specmult
      real :: fac011,fac001,fac111,fac101,fac110,fac000,fac100,fac010
      real :: colref1,colref2,currn2o,wcomb1,wcomb2
      real :: strrat

! This compiler directive was added to insure private common block storage       
! in multi-tasked mode on a CRAY or SGI for all commons except those that        
! carry constants.                                                               
                                                                                 
      REAL,DIMENSION(59) :: H2OREF,CO2REF,N2OREF(59)
      REAL,DIMENSION(10) :: ETAREF
      REAL :: N2OMULT
                                                                                 
      DATA ETAREF/  &                                                             
           0.,0.125,0.25,0.375,0.5,0.625,0.75,0.875,0.9875,1.0/                  
      DATA H2OREF/  &                                                             
           1.87599E-02,1.22233E-02,5.89086E-03,2.76753E-03,1.40651E-03, &
           7.59698E-04,3.88758E-04,1.65422E-04,3.71895E-05,7.47648E-06, &        
           4.30818E-06,3.33194E-06,3.20393E-06,3.16186E-06,3.25235E-06, &        
           3.42258E-06,3.62884E-06,3.91482E-06,4.14875E-06,4.30810E-06, &        
           4.44204E-06,4.57783E-06,4.70865E-06,4.79432E-06,4.86971E-06, &        
           4.92603E-06,4.96688E-06,4.99628E-06,5.05266E-06,5.12658E-06, &        
           5.25028E-06,5.35708E-06,5.45085E-06,5.48304E-06,5.50000E-06, &        
           5.50000E-06,5.45359E-06,5.40468E-06,5.35576E-06,5.25327E-06, &        
           5.14362E-06,5.03396E-06,4.87662E-06,4.69787E-06,4.51911E-06, &        
           4.33600E-06,4.14416E-06,3.95232E-06,3.76048E-06,3.57217E-06, &        
           3.38549E-06,3.19881E-06,3.01212E-06,2.82621E-06,2.64068E-06, &        
           2.45515E-06,2.26962E-06,2.08659E-06,1.93029E-06/                      
      DATA N2OREF/  & 
           3.20000E-07,3.20000E-07,3.20000E-07,3.20000E-07,3.20000E-07, &
           3.19652E-07,3.15324E-07,3.03830E-07,2.94221E-07,2.84953E-07, &        
           2.76714E-07,2.64709E-07,2.42847E-07,2.09547E-07,1.71945E-07, &        
           1.37491E-07,1.13319E-07,1.00354E-07,9.12812E-08,8.54633E-08, &        
           8.03631E-08,7.33718E-08,6.59754E-08,5.60386E-08,4.70901E-08, &        
           3.99774E-08,3.29786E-08,2.60642E-08,2.10663E-08,1.65918E-08, &        
           1.30167E-08,1.00900E-08,7.62490E-09,6.11592E-09,4.66725E-09, &        
           3.28574E-09,2.84838E-09,2.46198E-09,2.07557E-09,1.85507E-09, &        
           1.65675E-09,1.45843E-09,1.31948E-09,1.20716E-09,1.09485E-09, &        
           9.97803E-10,9.31260E-10,8.64721E-10,7.98181E-10,7.51380E-10, &        
           7.13670E-10,6.75960E-10,6.38250E-10,6.09811E-10,5.85998E-10, &        
           5.62185E-10,5.38371E-10,5.15183E-10,4.98660E-10/                      
      DATA CO2REF/ &                                                             
           53*3.55E-04, 3.5470873E-04, 3.5427220E-04, 3.5383567E-04,    &
           3.5339911E-04, 3.5282588E-04, 3.5079606E-04/                          
                        
      STRRAT = 1.19268                                                           
                                                                                 
!     Compute the optical depth by interpolating in ln(pressure),                
!     temperature, and appropriate species.  Below LAYTROP, the water            
!     vapor self-continuum is interpolated (in temperature) separately.          

!cdir novector
      DO 2500 LAY = 1, LAYTROP                                                   
         SPECCOMB = COLH2O(LAY) + STRRAT*COLCO2(LAY)                             
         SPECPARM = COLH2O(LAY)/SPECCOMB                                         
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS                         
         SPECMULT = 8.*(SPECPARM)                                                
         JS = 1 + INT(SPECMULT)                                                  
         FS = AMOD(SPECMULT,1.0)                                                 
         IF (JS .EQ. 8) THEN                                                     
            IF (FS .GE. 0.9) THEN                                                
               JS = 9                                                            
               FS = 10. * (FS - 0.9)                                             
            ELSE                                                                 
               FS = FS/0.9                                                       
            ENDIF                                                                
         ENDIF                                                                   
         NS = JS + INT(FS + 0.5)                                                 
         FP = FAC01(LAY) + FAC11(LAY)                                            
         FAC000 = (1. - FS) * FAC00(LAY)                                         
         FAC010 = (1. - FS) * FAC10(LAY)                                         
         FAC100 = FS * FAC00(LAY)                                                
         FAC110 = FS * FAC10(LAY)                                                
         FAC001 = (1. - FS) * FAC01(LAY)                                         
         FAC011 = (1. - FS) * FAC11(LAY)                                         
         FAC101 = FS * FAC01(LAY)                                                
         FAC111 = FS * FAC11(LAY)                                                
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(3) + JS                         
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(3) + JS                            
         INDS = INDSELF(LAY)                                                     
         COLREF1 = N2OREF(JP(LAY))                                               
         COLREF2 = N2OREF(JP(LAY)+1)                                             
         IF (NS .EQ. 10) THEN                                                    
            WCOMB1 = H2OREF(JP(LAY))                                             
            WCOMB2 = H2OREF(JP(LAY)+1)                                           
         ELSE                                                                    
            WCOMB1 = STRRAT * CO2REF(JP(LAY))/(1.-ETAREF(NS))                    
            WCOMB2 = STRRAT * CO2REF(JP(LAY)+1)/(1.-ETAREF(NS))                  
         ENDIF                                                                   
         RATIO = (COLREF1/WCOMB1)+FP*((COLREF2/WCOMB2)-(COLREF1/WCOMB1))         
         CURRN2O = SPECCOMB * RATIO                                              
         N2OMULT = COLN2O(LAY) - CURRN2O                                         
!!DIR$ VECTOR                                                                     
         DO 2000 IG = 1, NG3                                                     
            TAUG(NGS2+IG,LAY) = SPECCOMB *                     & 
                (FAC000 * ABSA3(IND0,IG) +                      &                 
                 FAC100 * ABSA3(IND0+1,IG) +                    &                 
                 FAC010 * ABSA3(IND0+10,IG) +                   &                 
                 FAC110 * ABSA3(IND0+11,IG) +                   &                 
                 FAC001 * ABSA3(IND1,IG) +                      &                 
                 FAC101 * ABSA3(IND1+1,IG) +                    &                 
                 FAC011 * ABSA3(IND1+10,IG) +                   &                 
                 FAC111 * ABSA3(IND1+11,IG)) +                  &                 
                 COLH2O(LAY) *                                 &                 
                 (SELFFAC(LAY) * (SELFREFC3(INDS,IG) +           &                 
                 SELFFRAC(LAY) *                               &                 
                 (SELFREFC3(INDS+1,IG) - SELFREFC3(INDS,IG))) +    &                 
                 FORFAC(LAY) * FORREFC3(IG))                     &                 
                 + N2OMULT * ABSN2OAC3(IG)                                         
            PFRAC(NGS2+IG,LAY) = FRACREFAC3(IG,JS) + FS *        & 
                 (FRACREFAC3(IG,JS+1) - FRACREFAC3(IG,JS))                           
 2000    CONTINUE                                                                
 2500 CONTINUE                                                                   
                                                                                 
!!DIR$ NOVECTOR                                                                   
!cdir novector
      DO 3500 LAY = LAYTROP+1, NLAYERS                                           
         SPECCOMB = COLH2O(LAY) + STRRAT*COLCO2(LAY)                             
         SPECPARM = COLH2O(LAY)/SPECCOMB                                         
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS                         
         SPECMULT = 4.*(SPECPARM)                                                
         JS = 1 + INT(SPECMULT)                                                  
         FS = AMOD(SPECMULT,1.0)                                                 
         NS = JS + INT(FS + 0.5)                                                 
         FP = FAC01(LAY) + FAC11(LAY)                                            
         FAC000 = (1. - FS) * FAC00(LAY)                                         
         FAC010 = (1. - FS) * FAC10(LAY)                                         
         FAC100 = FS * FAC00(LAY)                                                
         FAC110 = FS * FAC10(LAY)                                                
         FAC001 = (1. - FS) * FAC01(LAY)                                         
         FAC011 = (1. - FS) * FAC11(LAY)                                         
         FAC101 = FS * FAC01(LAY)                                                
         FAC111 = FS * FAC11(LAY)                                                
         IND0 = ((JP(LAY)-13)*5+(JT(LAY)-1))*NSPB(3) + JS                        
         IND1 = ((JP(LAY)-12)*5+(JT1(LAY)-1))*NSPB(3) + JS                       
         COLREF1 = N2OREF(JP(LAY))                                               
         COLREF2 = N2OREF(JP(LAY)+1)                                             
         IF (NS .EQ. 5) THEN                                                     
            WCOMB1 = H2OREF(JP(LAY))                                             
            WCOMB2 = H2OREF(JP(LAY)+1)                                           
         ELSE                                                                    
            WCOMB1 = STRRAT * CO2REF(JP(LAY))/(1.-ETAREF(NS))                    
            WCOMB2 = STRRAT * CO2REF(JP(LAY)+1)/(1.-ETAREF(NS))                  
         ENDIF                                                                   
         RATIO = (COLREF1/WCOMB1)+FP*((COLREF2/WCOMB2)-(COLREF1/WCOMB1))         
         CURRN2O = SPECCOMB * RATIO                                              
         N2OMULT = COLN2O(LAY) - CURRN2O                                         
!!DIR$ VECTOR                                                                     
         DO 3000 IG = 1, NG3                                                     
            TAUG(NGS2+IG,LAY) = SPECCOMB *                 &
                (FAC000 * ABSB3(IND0,IG) +                  &                     
                 FAC100 * ABSB3(IND0+1,IG) +                &                     
                 FAC010 * ABSB3(IND0+5,IG) +                &                     
                 FAC110 * ABSB3(IND0+6,IG) +                &                     
                 FAC001 * ABSB3(IND1,IG) +                  &                     
                 FAC101 * ABSB3(IND1+1,IG) +                &                     
                 FAC011 * ABSB3(IND1+5,IG) +                &                     
                 FAC111 * ABSB3(IND1+6,IG)) +               &                     
                 COLH2O(LAY) * FORFAC(LAY) * FORREFC3(IG)    &                     
                 + N2OMULT * ABSN2OBC3(IG)                                         
            PFRAC(NGS2+IG,LAY) = FRACREFBC3(IG,JS) + FS *    & 
                 (FRACREFBC3(IG,JS+1) - FRACREFBC3(IG,JS))                           
 3000    CONTINUE                                                                
 3500 CONTINUE                                                                   
                                                                                 
      END SUBROUTINE TAUGB3
                                                                                 
!----------------------------------------------------------------------------    
      SUBROUTINE TAUGB4(kts,ktep1,COLH2O,COLCO2,COLO3,FAC00,FAC01,FAC10,    &
                        FAC11,SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,           &
                        PFRAC,TAUG,LAYTROP                                  )
!----------------------------------------------------------------------------    
                                                                                 
!     BAND 4:  630-700 cm-1 (low - H2O,CO2; high - O3,CO2)                       
                                                                                 
      INTEGER, PARAMETER :: NGS3=38                                      
                                                                                 
      INTEGER, INTENT(IN )                      :: kts,ktep1

      INTEGER, INTENT(IN )                      ::  LAYTROP

      REAL, DIMENSION( NGPT,kts:ktep1 ),                    &
            INTENT(INOUT)        ::                  PFRAC, &
                                                      TAUG

      REAL, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::        &
                                                    COLH2O, &
                                                    COLCO2, &
                                                     COLO3, &
                                                     FAC00, &
                                                     FAC01, &
                                                     FAC10, &
                                                     FAC11, &
                                                   SELFFAC, &
                                                  SELFFRAC 
 
      INTEGER, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::     &
                                                        JP, &
                                                        JT, &
                                                       JT1, &
                                                   INDSELF
      integer :: lay,ig,ind0,ind1,inds
      integer :: js,ns
      real :: fs,ratio,speccomb,specparm,specmult
      real :: fac011,fac001,fac111,fac101,fac110,fac000,fac100,fac010
      real :: colref1,colref2,currn2o,wcomb1,wcomb2
      real :: strrat1,strrat2

! This compiler directive was added to insure private common block storage       
! in multi-tasked mode on a CRAY or SGI for all commons except those that        
! carry constants.                                                               
                                                                                 
      STRRAT1 = 850.577                                                          
      STRRAT2 = 35.7416                                                          
                                                                                 
!     Compute the optical depth by interpolating in ln(pressure),                
!     temperature, and appropriate species.  Below LAYTROP, the water            
!     vapor self-continuum is interpolated (in temperature) separately.          
!!DIR$ NOVECTOR                                                                   
!cdir novector
      DO 2500 LAY = 1, LAYTROP                                                   
         SPECCOMB = COLH2O(LAY) + STRRAT1*COLCO2(LAY)                            
         SPECPARM = COLH2O(LAY)/SPECCOMB                                         
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS                         
         SPECMULT = 8.*(SPECPARM)                                                
         JS = 1 + INT(SPECMULT)                                                  
         FS = AMOD(SPECMULT,1.0)                                                 
         FAC000 = (1. - FS) * FAC00(LAY)                                         
         FAC010 = (1. - FS) * FAC10(LAY)                                         
         FAC100 = FS * FAC00(LAY)                                                
         FAC110 = FS * FAC10(LAY)                                                
         FAC001 = (1. - FS) * FAC01(LAY)                                         
         FAC011 = (1. - FS) * FAC11(LAY)                                         
         FAC101 = FS * FAC01(LAY)                                                
         FAC111 = FS * FAC11(LAY)                                                
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(4) + JS                         
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(4) + JS                            
         INDS = INDSELF(LAY)                                                     
!!DIR$ VECTOR                                                                     
         DO 2000 IG = 1, NG4                                                     
            TAUG(NGS3+IG,LAY) = SPECCOMB *                    &
                (FAC000 * ABSA4(IND0,IG) +                     &                  
                 FAC100 * ABSA4(IND0+1,IG) +                   &                  
                 FAC010 * ABSA4(IND0+9,IG) +                   &                  
                 FAC110 * ABSA4(IND0+10,IG) +                  &                  
                 FAC001 * ABSA4(IND1,IG) +                     &                  
                 FAC101 * ABSA4(IND1+1,IG) +                   &                  
                 FAC011 * ABSA4(IND1+9,IG) +                   &                  
                 FAC111 * ABSA4(IND1+10,IG)) +                 &                  
                 COLH2O(LAY) *                                &                  
                 SELFFAC(LAY) * (SELFREFC4(INDS,IG) +           &                  
                 SELFFRAC(LAY) *                              &                  
                 (SELFREFC4(INDS+1,IG) - SELFREFC4(INDS,IG)))                        
            PFRAC(NGS3+IG,LAY) = FRACREFAC4(IG,JS) + FS *       &                  
                 (FRACREFAC4(IG,JS+1) - FRACREFAC4(IG,JS))                           
 2000    CONTINUE                                                                
 2500 CONTINUE                                                                   
                                                                                 
!!DIR$ NOVECTOR                                                                   
!cdir novector
      DO 3500 LAY = LAYTROP+1, NLAYERS                                           
         SPECCOMB = COLO3(LAY) + STRRAT2*COLCO2(LAY)                             
         SPECPARM = COLO3(LAY)/SPECCOMB                                          
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS                         
         SPECMULT = 4.*(SPECPARM)                                                
         JS = 1 + INT(SPECMULT)                                                  
         FS = AMOD(SPECMULT,1.0)                                                 
         IF (JS .GT. 1) THEN                                                     
            JS = JS + 1                                                          
         ELSEIF (FS .GE. 0.0024) THEN                                            
            JS = 2                                                               
            FS = (FS - 0.0024)/0.9976                                            
         ELSE                                                                    
            JS = 1                                                               
            FS = FS/0.0024                                                       
         ENDIF                                                                   
         FAC000 = (1. - FS) * FAC00(LAY)                                         
         FAC010 = (1. - FS) * FAC10(LAY)                                         
         FAC100 = FS * FAC00(LAY)                                                
         FAC110 = FS * FAC10(LAY)                                                
         FAC001 = (1. - FS) * FAC01(LAY)                                         
         FAC011 = (1. - FS) * FAC11(LAY)                                         
         FAC101 = FS * FAC01(LAY)                                                
         FAC111 = FS * FAC11(LAY)                                                
         IND0 = ((JP(LAY)-13)*5+(JT(LAY)-1))*NSPB(4) + JS                        
         IND1 = ((JP(LAY)-12)*5+(JT1(LAY)-1))*NSPB(4) + JS                       
!!DIR$ VECTOR                                                                     
         DO 3000 IG = 1, NG4                                                     
            TAUG(NGS3+IG,LAY) = SPECCOMB *              &                        
                (FAC000 * ABSB4(IND0,IG) +               &                        
                 FAC100 * ABSB4(IND0+1,IG) +             &                        
                 FAC010 * ABSB4(IND0+6,IG) +             &                        
                 FAC110 * ABSB4(IND0+7,IG) +             &                        
                 FAC001 * ABSB4(IND1,IG) +               &                        
                 FAC101 * ABSB4(IND1+1,IG) +             &                        
                 FAC011 * ABSB4(IND1+6,IG) +             &                        
                 FAC111 * ABSB4(IND1+7,IG))                                       
            PFRAC(NGS3+IG,LAY) = FRACREFBC4(IG,JS) + FS * &
                 (FRACREFBC4(IG,JS+1) - FRACREFBC4(IG,JS))                           
 3000    CONTINUE                                                                
 3500 CONTINUE                                                                   
                                                                                 
      END SUBROUTINE TAUGB4
                                                                                 
!----------------------------------------------------------------------------   
      SUBROUTINE TAUGB5(kts,ktep1,COLH2O,COLCO2,COLO3,FAC00,FAC01,FAC10,    &
                        FAC11,SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,WX,        &
                        PFRAC,TAUG,LAYTROP                                  )
!----------------------------------------------------------------------------   
                                                                                 
!     BAND 5:  700-820 cm-1 (low - H2O,CO2; high - O3,CO2)                       
                                                                                 
      INTEGER, PARAMETER :: NGS4=52                                      
                                                                                 
      INTEGER, INTENT(IN )                      :: kts,ktep1

      INTEGER, INTENT(IN )                      ::  LAYTROP

      REAL, DIMENSION( NGPT,kts:ktep1 ),                    &
            INTENT(INOUT)        ::                  PFRAC, &
                                                      TAUG

      REAL, DIMENSION( MAXXSEC,kts:ktep1 ),                 &
            INTENT(IN   )        ::                     WX

      REAL, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::        &
                                                    COLH2O, &
                                                    COLCO2, &
                                                     COLO3, &
                                                     FAC00, &
                                                     FAC01, &
                                                     FAC10, &
                                                     FAC11, &
                                                   SELFFAC, &
                                                  SELFFRAC 
 
      INTEGER, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::     &
                                                        JP, &
                                                        JT, &
                                                       JT1, &
                                                   INDSELF
      integer :: lay,ig,ind0,ind1,inds
      integer :: js,ns
      real :: fs,ratio,speccomb,specparm,specmult
      real :: fac011,fac001,fac111,fac101,fac110,fac000,fac100,fac010
      real :: colref1,colref2,currn2o,wcomb1,wcomb2
      real :: strrat1,strrat2

! This compiler directive was added to insure private common block storage       
! in multi-tasked mode on a CRAY or SGI for all commons except those that        
! carry constants.                                                               
                                                                                 
      STRRAT1 = 90.4894                                                          
      STRRAT2 = 0.900502                                                         
                                                                                 
!     Compute the optical depth by interpolating in ln(pressure),                
!     temperature, and appropriate species.  Below LAYTROP, the water            
!     vapor self-continuum is interpolated (in temperature) separately.          
!!DIR$ NOVECTOR                                                                   
!cdir novector
      DO 2500 LAY = 1, LAYTROP                                                   
         SPECCOMB = COLH2O(LAY) + STRRAT1*COLCO2(LAY)                            
         SPECPARM = COLH2O(LAY)/SPECCOMB                                         
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS                         
         SPECMULT = 8.*(SPECPARM)                                                
         JS = 1 + INT(SPECMULT)                                                  
         FS = AMOD(SPECMULT,1.0)                                                 
         FAC000 = (1. - FS) * FAC00(LAY)                                         
         FAC010 = (1. - FS) * FAC10(LAY)                                         
         FAC100 = FS * FAC00(LAY)                                                
         FAC110 = FS * FAC10(LAY)                                                
         FAC001 = (1. - FS) * FAC01(LAY)                                         
         FAC011 = (1. - FS) * FAC11(LAY)                                         
         FAC101 = FS * FAC01(LAY)                                                
         FAC111 = FS * FAC11(LAY)                                                
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(5) + JS                         
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(5) + JS                            
         INDS = INDSELF(LAY)                                                     
!!DIR$ VECTOR                                                                     
         DO 2000 IG = 1, NG5                                                     
            TAUG(NGS4+IG,LAY) = SPECCOMB *                    &
                (FAC000 * ABSA5(IND0,IG) +                     &                  
                 FAC100 * ABSA5(IND0+1,IG) +                   &                  
                 FAC010 * ABSA5(IND0+9,IG) +                   &                  
                 FAC110 * ABSA5(IND0+10,IG) +                  &                  
                 FAC001 * ABSA5(IND1,IG) +                     &                  
                 FAC101 * ABSA5(IND1+1,IG) +                   &                  
                 FAC011 * ABSA5(IND1+9,IG) +                   &                  
                 FAC111 * ABSA5(IND1+10,IG)) +                 &                  
                 COLH2O(LAY) *                                &                  
                 SELFFAC(LAY) * (SELFREFC5(INDS,IG) +           &                  
                 SELFFRAC(LAY) *                              &                  
                 (SELFREFC5(INDS+1,IG) - SELFREFC5(INDS,IG)))     &                  
                 + WX(1,LAY) * CCL4C5(IG)                                          
            PFRAC(NGS4+IG,LAY) = FRACREFAC5(IG,JS) + FS *       &                  
                 (FRACREFAC5(IG,JS+1) - FRACREFAC5(IG,JS))                           
 2000    CONTINUE                                                                
 2500 CONTINUE                                                                   
                                                                                 
!!DIR$ NOVECTOR                                                                   
!cdir novector
      DO 3500 LAY = LAYTROP+1, NLAYERS                                           
         SPECCOMB = COLO3(LAY) + STRRAT2*COLCO2(LAY)                             
         SPECPARM = COLO3(LAY)/SPECCOMB                                          
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS                         
         SPECMULT = 4.*(SPECPARM)                                                
         JS = 1 + INT(SPECMULT)                                                  
         FS = AMOD(SPECMULT,1.0)                                                 
         FAC000 = (1. - FS) * FAC00(LAY)                                         
         FAC010 = (1. - FS) * FAC10(LAY)                                         
         FAC100 = FS * FAC00(LAY)                                                
         FAC110 = FS * FAC10(LAY)                                                
         FAC001 = (1. - FS) * FAC01(LAY)                                         
         FAC011 = (1. - FS) * FAC11(LAY)                                         
         FAC101 = FS * FAC01(LAY)                                                
         FAC111 = FS * FAC11(LAY)                                                
         IND0 = ((JP(LAY)-13)*5+(JT(LAY)-1))*NSPB(5) + JS                        
         IND1 = ((JP(LAY)-12)*5+(JT1(LAY)-1))*NSPB(5) + JS                       
!!DIR$ VECTOR                                                                     
         DO 3000 IG = 1, NG5                                                     
            TAUG(NGS4+IG,LAY) = SPECCOMB *          &
                (FAC000 * ABSB5(IND0,IG) +           &                            
                 FAC100 * ABSB5(IND0+1,IG) +         &                            
                 FAC010 * ABSB5(IND0+5,IG) +         &                            
                 FAC110 * ABSB5(IND0+6,IG) +         &                            
                 FAC001 * ABSB5(IND1,IG) +           &                            
                 FAC101 * ABSB5(IND1+1,IG) +         &                            
                 FAC011 * ABSB5(IND1+5,IG) +         &                            
                 FAC111 * ABSB5(IND1+6,IG))          &                            
                 + WX(1,LAY) * CCL4C5(IG)                                          
            PFRAC(NGS4+IG,LAY) = FRACREFBC5(IG,JS) + FS *  &                       
                 (FRACREFBC5(IG,JS+1) - FRACREFBC5(IG,JS))                           
 3000    CONTINUE                                                                
 3500 CONTINUE                                                                   
                                                                                 
      END SUBROUTINE TAUGB5
                                                                                 
!-----------------------------------------------------------------------------    
      SUBROUTINE TAUGB6(kts,ktep1,COLH2O,CO2MULT,FAC00,FAC01,FAC10,FAC11,    &
                        SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,WX,PFRAC,TAUG,    &
                        LAYTROP                                              )
!-----------------------------------------------------------------------------    
                                                                                 
!     BAND 6:  820-980 cm-1 (low - H2O; high - nothing)                          
                                                                                 
      INTEGER, PARAMETER :: NGS5=68                                       
                                                                                 
      INTEGER, INTENT(IN )                      :: kts,ktep1

      INTEGER, INTENT(IN )                      ::  LAYTROP

      REAL, DIMENSION( NGPT,kts:ktep1 ),                    &
            INTENT(INOUT)        ::                  PFRAC, &
                                                      TAUG

      REAL, DIMENSION( MAXXSEC,kts:ktep1 ),                 &
            INTENT(IN   )        ::                     WX

      REAL, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::        &
                                                    COLH2O, &
                                                   CO2MULT, &
                                                     FAC00, &
                                                     FAC01, &
                                                     FAC10, &
                                                     FAC11, &
                                                   SELFFAC, &
                                                  SELFFRAC 
 
      INTEGER, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::     &
                                                        JP, &
                                                        JT, &
                                                       JT1, &
                                                   INDSELF
      integer :: lay,ig,ind0,ind1,inds
      integer :: js,ns
      real :: fs,ratio,speccomb,specparm,specmult
      real :: fac011,fac001,fac111,fac101,fac110,fac000,fac100,fac010
      real :: colref1,colref2,currn2o,wcomb1,wcomb2

! This compiler directive was added to insure private common block storage       
! in multi-tasked mode on a CRAY or SGI for all commons except those that        
! carry constants.                                                               
                                                                                 
!     Compute the optical depth by interpolating in ln(pressure) and             
!     temperature. The water vapor self-continuum is interpolated                
!     (in temperature) separately.                                               
!cdir novector
      DO 2500 LAY = 1, LAYTROP                                                   
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(6) + 1                          
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(6) + 1                             
         INDS = INDSELF(LAY)                                                     
         DO 2000 IG = 1, NG6                                                     
            TAUG(NGS5+IG,LAY) = COLH2O(LAY) *              & 
                (FAC00(LAY) * ABSA6(IND0,IG) +              &                     
                 FAC10(LAY) * ABSA6(IND0+1,IG) +            &                     
                 FAC01(LAY) * ABSA6(IND1,IG) +              &                     
                 FAC11(LAY) * ABSA6(IND1+1,IG) +            &                     
                 SELFFAC(LAY) * (SELFREFC6(INDS,IG) +        &                     
                 SELFFRAC(LAY)*                            &                     
                 (SELFREFC6(INDS+1,IG)-SELFREFC6(INDS,IG))))   &                     
                 + WX(2,LAY) * CFC11ADJC6(IG)                &                     
                 + WX(3,LAY) * CFC12C6(IG)                   &                     
                 + CO2MULT(LAY) * ABSCO2C6(IG)                                     
            PFRAC(NGS5+IG,LAY) = FRACREFAC6(IG)                                    
 2000    CONTINUE                                                                
 2500 CONTINUE                                                                   
                                                                                 
!     Nothing important goes on above LAYTROP in this band.                      
!cdir novector
      DO 3500 LAY = LAYTROP+1, NLAYERS                                           
         DO 3000 IG = 1, NG6                                                     
            TAUG(NGS5+IG,LAY) = 0.0                        & 
                 + WX(2,LAY) * CFC11ADJC6(IG)                &                     
                 + WX(3,LAY) * CFC12C6(IG)                                         
            PFRAC(NGS5+IG,LAY) = FRACREFAC6(IG)                                    
 3000    CONTINUE                                                                
 3500 CONTINUE                                                                   
                                                                                 
      END SUBROUTINE TAUGB6
                                                                                 
!-----------------------------------------------------------------------------    
      SUBROUTINE TAUGB7(kts,ktep1,COLH2O,COLO3,CO2MULT,FAC00,FAC01,FAC10,    &   
                        FAC11,SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,            &
                        PFRAC,TAUG,LAYTROP                                   )
!-----------------------------------------------------------------------------    
                                                                                 
!     BAND 7:  980-1080 cm-1 (low - H2O,O3; high - O3)                           
                                                                                 
      INTEGER, PARAMETER :: NGS6=76                                      
                                                                                 
      INTEGER, INTENT(IN )                      :: kts,ktep1

      INTEGER, INTENT(IN )                      ::  LAYTROP

      REAL, DIMENSION( NGPT,kts:ktep1 ),                    &
            INTENT(INOUT)        ::                  PFRAC, &
                                                      TAUG

      REAL, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::        &
                                                    COLH2O, &
                                                     COLO3, &
                                                   CO2MULT, &
                                                     FAC00, &
                                                     FAC01, &
                                                     FAC10, &
                                                     FAC11, &
                                                   SELFFAC, &
                                                  SELFFRAC 
 
      INTEGER, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::     &
                                                        JP, &
                                                        JT, &
                                                       JT1, &
                                                   INDSELF
      integer :: lay,ig,ind0,ind1,inds
      integer :: js,ns
      real :: fs,ratio,speccomb,specparm,specmult
      real :: fac011,fac001,fac111,fac101,fac110,fac000,fac100,fac010
      real :: colref1,colref2,currn2o,wcomb1,wcomb2
      real :: strrat1

! This compiler directive was added to insure private common block storage       
! in multi-tasked mode on a CRAY or SGI for all commons except those that        
! carry constants.                                                               
                                                                                 
      STRRAT1 = 8.21104E4                                                        
                                                                                 
!     Compute the optical depth by interpolating in ln(pressure),                
!     temperature, and appropriate species.  Below LAYTROP, the water            
!     vapor self-continuum is interpolated (in temperature) separately.          
!!DIR$ NOVECTOR                                                                   
!cdir novector
      DO 2500 LAY = 1, LAYTROP                                                   
         SPECCOMB = COLH2O(LAY) + STRRAT1*COLO3(LAY)                             
         SPECPARM = COLH2O(LAY)/SPECCOMB                                         
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS                         
         SPECMULT = 8.*SPECPARM                                                  
         JS = 1 + INT(SPECMULT)                                                  
         FS = AMOD(SPECMULT,1.0)                                                 
         FAC000 = (1. - FS) * FAC00(LAY)                                         
         FAC010 = (1. - FS) * FAC10(LAY)                                         
         FAC100 = FS * FAC00(LAY)                                                
         FAC110 = FS * FAC10(LAY)                                                
         FAC001 = (1. - FS) * FAC01(LAY)                                         
         FAC011 = (1. - FS) * FAC11(LAY)                                         
         FAC101 = FS * FAC01(LAY)                                                
         FAC111 = FS * FAC11(LAY)                                                
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(7) + JS                         
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(7) + JS                            
         INDS = INDSELF(LAY)                                                     
!!DIR$ VECTOR                                                                     
         DO 2000 IG = 1, NG7                                                     
            TAUG(NGS6+IG,LAY) = SPECCOMB *                   & 
                (FAC000 * ABSA7(IND0,IG) +                   &                    
                 FAC100 * ABSA7(IND0+1,IG) +                 &                    
                 FAC010 * ABSA7(IND0+9,IG) +                 &                    
                 FAC110 * ABSA7(IND0+10,IG) +                &                    
                 FAC001 * ABSA7(IND1,IG) +                   &                    
                 FAC101 * ABSA7(IND1+1,IG) +                 &                    
                 FAC011 * ABSA7(IND1+9,IG) +                 &                    
                 FAC111 * ABSA7(IND1+10,IG)) +               &                    
                 COLH2O(LAY) *                               &                    
                 SELFFAC(LAY) * (SELFREFC7(INDS,IG) +        &                    
                 SELFFRAC(LAY) *                             &                    
                 (SELFREFC7(INDS+1,IG) - SELFREFC7(INDS,IG)))&
                 + CO2MULT(LAY) * ABSCO2C7(IG)                                     
         PFRAC(NGS6+IG,LAY) = FRACREFAC7(IG,JS) + FS *        &                    
                 (FRACREFAC7(IG,JS+1) - FRACREFAC7(IG,JS))                           
 2000    CONTINUE                                                                
 2500 CONTINUE                                                                   
                                                                                 
!cdir novector
      DO 3500 LAY = LAYTROP+1, NLAYERS                                           
         IND0 = ((JP(LAY)-13)*5+(JT(LAY)-1))*NSPB(7) + 1                         
         IND1 = ((JP(LAY)-12)*5+(JT1(LAY)-1))*NSPB(7) + 1                        
         DO 3000 IG = 1, NG7                                                     
            TAUG(NGS6+IG,LAY) = COLO3(LAY) *                & 
                (FAC00(LAY) * ABSB7(IND0,IG) +               &                    
                 FAC10(LAY) * ABSB7(IND0+1,IG) +             &                    
                 FAC01(LAY) * ABSB7(IND1,IG) +               &                    
                 FAC11(LAY) * ABSB7(IND1+1,IG))              &                    
                 + CO2MULT(LAY) * ABSCO2C7(IG)                                     
            PFRAC(NGS6+IG,LAY) = FRACREFBC7(IG)                                    
 3000    CONTINUE                                                                
 3500 CONTINUE                                                                   
                                                                                 
      END SUBROUTINE TAUGB7
                                                                                 
!----------------------------------------------------------------------------    
      SUBROUTINE TAUGB8(kts,ktep1,COLH2O,COLO3,COLN2O,CO2MULT,              &
                        FAC00,FAC01,FAC10,FAC11,SELFFAC,SELFFRAC,           &
                        JP,JT,JT1,INDSELF,WX,PFRAC,TAUG,LAYSWTCH            )
!----------------------------------------------------------------------------    
                                                                                 
!     BAND 8:  1080-1180 cm-1 (low (i.e.>~300mb) - H2O; high - O3)               
                                                                                 
      INTEGER, PARAMETER :: NGS7=88                                       
                                                                                 
      INTEGER, INTENT(IN )                      :: kts,ktep1

      INTEGER, INTENT(IN )                      :: LAYSWTCH

      REAL, DIMENSION( NGPT,kts:ktep1 ),                    &
            INTENT(INOUT)        ::                  PFRAC, &
                                                      TAUG

      REAL, DIMENSION( MAXXSEC,kts:ktep1 ),                 &
            INTENT(IN   )        ::                     WX

      REAL, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::        &
                                                    COLH2O, &
                                                     COLO3, &
                                                    COLN2O, &
                                                   CO2MULT, &
                                                     FAC00, &
                                                     FAC01, &
                                                     FAC10, &
                                                     FAC11, &
                                                   SELFFAC, &
                                                  SELFFRAC 
 
      INTEGER, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::     &
                                                        JP, &
                                                        JT, &
                                                       JT1, &
                                                   INDSELF

! This compiler directive was added to insure private common block storage       
! in multi-tasked mode on a CRAY or SGI for all commons except those that        
! carry constants.                                                               
                                                                                 
      REAL,DIMENSION(59) :: H2OREF,O3REF,N2OREF
      REAL N2OMULT
      integer :: lay,ig,ind0,ind1,inds
      integer :: js,ns
      real :: fp,fs,ratio,speccomb,specparm,specmult
      real :: fac011,fac001,fac111,fac101,fac110,fac000,fac100,fac010
      real :: colref1,colref2,currn2o,wcomb1,wcomb2
                                                                                 
      DATA H2OREF/ &                                                             
           1.87599E-02,1.22233E-02,5.89086E-03,2.76753E-03,1.40651E-03, &        
           7.59698E-04,3.88758E-04,1.65422E-04,3.71895E-05,7.47648E-06, &        
           4.30818E-06,3.33194E-06,3.20393E-06,3.16186E-06,3.25235E-06, &        
           3.42258E-06,3.62884E-06,3.91482E-06,4.14875E-06,4.30810E-06, &        
           4.44204E-06,4.57783E-06,4.70865E-06,4.79432E-06,4.86971E-06, &        
           4.92603E-06,4.96688E-06,4.99628E-06,5.05266E-06,5.12658E-06, &        
           5.25028E-06,5.35708E-06,5.45085E-06,5.48304E-06,5.50000E-06, &        
           5.50000E-06,5.45359E-06,5.40468E-06,5.35576E-06,5.25327E-06, &        
           5.14362E-06,5.03396E-06,4.87662E-06,4.69787E-06,4.51911E-06, &        
           4.33600E-06,4.14416E-06,3.95232E-06,3.76048E-06,3.57217E-06, &        
           3.38549E-06,3.19881E-06,3.01212E-06,2.82621E-06,2.64068E-06, &        
           2.45515E-06,2.26962E-06,2.08659E-06,1.93029E-06/                      
      DATA N2OREF/ &                                                             
           3.20000E-07,3.20000E-07,3.20000E-07,3.20000E-07,3.20000E-07, &        
           3.19652E-07,3.15324E-07,3.03830E-07,2.94221E-07,2.84953E-07, &        
           2.76714E-07,2.64709E-07,2.42847E-07,2.09547E-07,1.71945E-07, &        
           1.37491E-07,1.13319E-07,1.00354E-07,9.12812E-08,8.54633E-08, &        
           8.03631E-08,7.33718E-08,6.59754E-08,5.60386E-08,4.70901E-08, &        
           3.99774E-08,3.29786E-08,2.60642E-08,2.10663E-08,1.65918E-08, &        
           1.30167E-08,1.00900E-08,7.62490E-09,6.11592E-09,4.66725E-09, &        
           3.28574E-09,2.84838E-09,2.46198E-09,2.07557E-09,1.85507E-09, &        
           1.65675E-09,1.45843E-09,1.31948E-09,1.20716E-09,1.09485E-09, &        
           9.97803E-10,9.31260E-10,8.64721E-10,7.98181E-10,7.51380E-10, &        
           7.13670E-10,6.75960E-10,6.38250E-10,6.09811E-10,5.85998E-10, &        
           5.62185E-10,5.38371E-10,5.15183E-10,4.98660E-10/                      
      DATA O3REF/  &                                                             
           3.01700E-08,3.47254E-08,4.24769E-08,5.27592E-08,6.69439E-08, &        
           8.71295E-08,1.13911E-07,1.56771E-07,2.17878E-07,3.24430E-07, &        
           4.65942E-07,5.68057E-07,6.96065E-07,1.11863E-06,1.76175E-06, &        
           2.32689E-06,2.95769E-06,3.65930E-06,4.59503E-06,5.31891E-06, &        
           5.96179E-06,6.51133E-06,7.06350E-06,7.69169E-06,8.25771E-06, &        
           8.70824E-06,8.83245E-06,8.71486E-06,8.09434E-06,7.33071E-06, &        
           6.31014E-06,5.36717E-06,4.48289E-06,3.83913E-06,3.28270E-06, &        
           2.82351E-06,2.49061E-06,2.16453E-06,1.83845E-06,1.66182E-06, &        
           1.50517E-06,1.34852E-06,1.19718E-06,1.04822E-06,8.99264E-07, &        
           7.63432E-07,6.53806E-07,5.44186E-07,4.34564E-07,3.64210E-07, &        
           3.11938E-07,2.59667E-07,2.07395E-07,1.91456E-07,1.93639E-07, &        
           1.95821E-07,1.98004E-07,2.06442E-07,2.81546E-07/                      
                                                                                 
!     Compute the optical depth by interpolating in ln(pressure) and             
!     temperature.                                                               
!cdir novector
      DO 2500 LAY = 1, LAYSWTCH                                                  
         FP = FAC01(LAY) + FAC11(LAY)                                            
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(8) + 1                          
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(8) + 1                             
         INDS = INDSELF(LAY)                                                     
         COLREF1 = N2OREF(JP(LAY))                                               
         COLREF2 = N2OREF(JP(LAY)+1)                                             
         WCOMB1 = H2OREF(JP(LAY))                                                
         WCOMB2 = H2OREF(JP(LAY)+1)                                              
         RATIO = (COLREF1/WCOMB1)+FP*((COLREF2/WCOMB2)-(COLREF1/WCOMB1))         
         CURRN2O = COLH2O(LAY) * RATIO                                           
         N2OMULT = COLN2O(LAY) - CURRN2O                                         
         DO 2000 IG = 1, NG8                                                     
            TAUG(NGS7+IG,LAY) = COLH2O(LAY) *                 &
                (FAC00(LAY) * ABSA8(IND0,IG) +                &                   
                 FAC10(LAY) * ABSA8(IND0+1,IG) +              &                   
                 FAC01(LAY) * ABSA8(IND1,IG) +                &                   
                 FAC11(LAY) * ABSA8(IND1+1,IG) +              &                   
                 SELFFAC(LAY) * (SELFREFC8(INDS,IG) +         &                   
                 SELFFRAC(LAY) *                              &                   
                 (SELFREFC8(INDS+1,IG) - SELFREFC8(INDS,IG))))&                   
                 + WX(3,LAY) * CFC12C8(IG)                    &                   
                 + WX(4,LAY) * CFC22ADJC8(IG)                 &                   
                 + CO2MULT(LAY) * ABSCO2AC8(IG)               &                   
                 + N2OMULT * ABSN2OAC8(IG)        
            PFRAC(NGS7+IG,LAY) = FRACREFAC8(IG)                                    
 2000    CONTINUE                                                                
 2500 CONTINUE                                                                   
                                                                                 
!cdir novector
      DO 3500 LAY = LAYSWTCH+1, NLAYERS                                          
         FP = FAC01(LAY) + FAC11(LAY)                                            
         IND0 = ((JP(LAY)-7)*5+(JT(LAY)-1))*NSPB(8) + 1                          
         IND1 = ((JP(LAY)-6)*5+(JT1(LAY)-1))*NSPB(8) + 1                         
         COLREF1 = N2OREF(JP(LAY))                                               
         COLREF2 = N2OREF(JP(LAY)+1)                                             
         WCOMB1 = O3REF(JP(LAY))                                                 
         WCOMB2 = O3REF(JP(LAY)+1)                                               
         RATIO = (COLREF1/WCOMB1)+FP*((COLREF2/WCOMB2)-(COLREF1/WCOMB1))         
         CURRN2O = COLO3(LAY) * RATIO                                            
         N2OMULT = COLN2O(LAY) - CURRN2O                                         
         DO 3000 IG = 1, NG8                                                     
            TAUG(NGS7+IG,LAY) = COLO3(LAY) *        &
                (FAC00(LAY) * ABSB8(IND0,IG) +       &                            
                 FAC10(LAY) * ABSB8(IND0+1,IG) +     &                            
                 FAC01(LAY) * ABSB8(IND1,IG) +       &                            
                 FAC11(LAY) * ABSB8(IND1+1,IG))      &                            
                 + WX(3,LAY) * CFC12C8(IG)            &                            
                 + WX(4,LAY) * CFC22ADJC8(IG)         &                            
                 + CO2MULT(LAY) * ABSCO2BC8(IG)       &                            
                 + N2OMULT * ABSN2OBC8(IG)                                         
            PFRAC(NGS7+IG,LAY) = FRACREFBC8(IG)                                    
 3000    CONTINUE                                                                
 3500 CONTINUE                                                                   
                                                                                 
      END SUBROUTINE TAUGB8
                                                                                 
!-----------------------------------------------------------------------------    
      SUBROUTINE TAUGB9(kts,ktep1,COLH2O,COLN2O,COLCH4,FAC00,FAC01,FAC10,    &
                        FAC11,SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,            &
                        PFRAC,TAUG,LAYTROP,LAYSWTCH,LAYLOW                   )
!-----------------------------------------------------------------------------    
                                                                                 
!     BAND 9:  1180-1390 cm-1 (low - H2O,CH4; high - CH4)                        
                                                                                 
      INTEGER, PARAMETER :: NGS8=96                                      
                                                                                 
      INTEGER, INTENT(IN )                      :: kts,ktep1

      INTEGER, INTENT(IN )   ::  LAYTROP,LAYSWTCH,LAYLOW

      REAL, DIMENSION( NGPT,kts:ktep1 ),                    &
            INTENT(INOUT)        ::                  PFRAC, &
                                                      TAUG

      REAL, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::        &
                                                    COLH2O, &
                                                    COLN2O, &
                                                    COLCH4, &
                                                     FAC00, &
                                                     FAC01, &
                                                     FAC10, &
                                                     FAC11, &
                                                   SELFFAC, &
                                                  SELFFRAC 
 
      INTEGER, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::     &
                                                        JP, &
                                                        JT, &
                                                       JT1, &
                                                   INDSELF

! This compiler directive was added to insure private common block storage       
! in multi-tasked mode on a CRAY or SGI for all commons except those that        
! carry constants.                                                               
                                                                                 
      REAL,DIMENSION(13) :: H2OREF,CH4REF,N2OREF
      REAL,DIMENSION(11) :: ETAREF
      REAL :: N2OMULT
      integer :: lay,ig,ind0,ind1,inds
      integer :: jfrac,js,ns,ioff
      real :: ffrac,fp,fs,ratio,speccomb,specparm,specmult
      real :: fac011,fac001,fac111,fac101,fac110,fac000,fac100,fac010
      real :: colref1,colref2,currn2o,wcomb1,wcomb2
      real :: strrat
                                                                                 
      DATA N2OREF/  &                                                            
           3.20000E-07,3.20000E-07,3.20000E-07,3.20000E-07,3.20000E-07,  &
           3.19652E-07,3.15324E-07,3.03830E-07,2.94221E-07,2.84953E-07,  &       
           2.76714E-07,2.64709E-07,2.42847E-07/                                  
      DATA H2OREF/  &                                                            
           1.8759999E-02, 1.2223309E-02, 5.8908667E-03, 2.7675382E-03,   &       
           1.4065107E-03, 7.5969833E-04, 3.8875898E-04, 1.6542293E-04,   &       
           3.7189537E-05, 7.4764857E-06, 4.3081886E-06, 3.3319423E-06,   &       
           3.2039343E-06/                                                        
      DATA CH4REF/  &                                                            
           1.7000001E-06, 1.7000001E-06, 1.6998713E-06, 1.6904165E-06,   &       
           1.6671424E-06, 1.6350652E-06, 1.6097551E-06, 1.5590465E-06,   &       
           1.5119849E-06, 1.4741138E-06, 1.4384609E-06, 1.4002215E-06,   &       
           1.3573376E-06/                                                        
      DATA ETAREF/  &                                                            
           0.,0.125,0.25,0.375,0.5,0.625,0.75,0.875,0.96,0.99,1.0/               
                                                                                 
      STRRAT = 21.6282                                                           
      IOFF = 0                                                                   
                                                                                 
!     Compute the optical depth by interpolating in ln(pressure),                
!     temperature, and appropriate species.  Below LAYTROP, the water            
!     vapor self-continuum is interpolated (in temperature) separately.          
!cdir novector
      DO 2500 LAY = 1, LAYTROP                                                   
         SPECCOMB = COLH2O(LAY) + STRRAT*COLCH4(LAY)                             
         SPECPARM = COLH2O(LAY)/SPECCOMB                                         
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS                         
         SPECMULT = 8.*(SPECPARM)                                                
         JS = 1 + INT(SPECMULT)                                                  
         JFRAC = JS                                                              
         FS = AMOD(SPECMULT,1.0)                                                 
         FFRAC = FS                                                              
         IF (JS .EQ. 8) THEN                                                     
            IF (FS .LE. 0.68) THEN                                               
               FS = FS/0.68                                                      
            ELSEIF (FS .LE. 0.92) THEN                                           
               JS = JS + 1                                                       
               FS = (FS-0.68)/0.24                                               
            ELSE                                                                 
               JS = JS + 2                                                       
               FS = (FS-0.92)/0.08                                               
            ENDIF                                                                
         ELSEIF (JS .EQ.9) THEN                                                  
            JS = 10                                                              
            FS = 1.                                                              
            JFRAC = 8                                                            
            FFRAC = 1.                                                           
         ENDIF                                                                   
         FP = FAC01(LAY) + FAC11(LAY)                                            
         NS = JS + INT(FS + 0.5)                                                 
         FAC000 = (1. - FS) * FAC00(LAY)                                         
         FAC010 = (1. - FS) * FAC10(LAY)                                         
         FAC100 = FS * FAC00(LAY)                                                
         FAC110 = FS * FAC10(LAY)                                                
         FAC001 = (1. - FS) * FAC01(LAY)                                         
         FAC011 = (1. - FS) * FAC11(LAY)                                         
         FAC101 = FS * FAC01(LAY)                                                
         FAC111 = FS * FAC11(LAY)                                                
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(9) + JS                         
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(9) + JS                            
         INDS = INDSELF(LAY)                                                     
         IF (LAY .EQ. LAYLOW) IOFF = NG9                                         
         IF (LAY .EQ. LAYSWTCH) IOFF = 2*NG9                                     
         COLREF1 = N2OREF(JP(LAY))                                               
         COLREF2 = N2OREF(JP(LAY)+1)                                             
         IF (NS .EQ. 11) THEN                                                    
            WCOMB1 = H2OREF(JP(LAY))                                             
            WCOMB2 = H2OREF(JP(LAY)+1)                                           
         ELSE                                                                    
            WCOMB1 = STRRAT * CH4REF(JP(LAY))/(1.-ETAREF(NS))                    
            WCOMB2 = STRRAT * CH4REF(JP(LAY)+1)/(1.-ETAREF(NS))                  
         ENDIF                                                                   
         RATIO = (COLREF1/WCOMB1)+FP*((COLREF2/WCOMB2)-(COLREF1/WCOMB1))         
         CURRN2O = SPECCOMB * RATIO                                              
         N2OMULT = COLN2O(LAY) - CURRN2O                                         
         DO 2000 IG = 1, NG9                                                     
            TAUG(NGS8+IG,LAY) = SPECCOMB *                      &
                (FAC000 * ABSA9(IND0,IG) +                      &                 
                 FAC100 * ABSA9(IND0+1,IG) +                    &                 
                 FAC010 * ABSA9(IND0+11,IG) +                   &                 
                 FAC110 * ABSA9(IND0+12,IG) +                   &                 
                 FAC001 * ABSA9(IND1,IG) +                      &                 
                 FAC101 * ABSA9(IND1+1,IG) +                    &                 
                 FAC011 * ABSA9(IND1+11,IG) +                   &                 
                 FAC111 * ABSA9(IND1+12,IG)) +                  &                 
                 COLH2O(LAY) *                                  &                 
                 SELFFAC(LAY) * (SELFREFC9(INDS,IG) +           &                 
                 SELFFRAC(LAY) *                                &                 
                 (SELFREFC9(INDS+1,IG) - SELFREFC9(INDS,IG)))   & 
                 + N2OMULT * ABSN2OC9(IG+IOFF)                                     
            PFRAC(NGS8+IG,LAY) = FRACREFAC9(IG,JFRAC) + FFRAC *  &                 
                 (FRACREFAC9(IG,JFRAC+1) - FRACREFAC9(IG,JFRAC))                     
 2000    CONTINUE                                                                
 2500 CONTINUE                                                                   
                                                                                 
!cdir novector
      DO 3500 LAY = LAYTROP+1, NLAYERS                                           
         IND0 = ((JP(LAY)-13)*5+(JT(LAY)-1))*NSPB(9) + 1                         
         IND1 = ((JP(LAY)-12)*5+(JT1(LAY)-1))*NSPB(9) + 1                        
         DO 3000 IG = 1, NG9                                                     
            TAUG(NGS8+IG,LAY) = COLCH4(LAY) *                  &                 
                (FAC00(LAY) * ABSB9(IND0,IG) +                  &                 
                 FAC10(LAY) * ABSB9(IND0+1,IG) +                &                 
                 FAC01(LAY) * ABSB9(IND1,IG) +                  &                 
                 FAC11(LAY) * ABSB9(IND1+1,IG))                                   
            PFRAC(NGS8+IG,LAY) = FRACREFBC9(IG)                                    
 3000    CONTINUE                                                                
 3500 CONTINUE                                                                   
                                                                                 
      END SUBROUTINE TAUGB9
                                                                                 
!--------------------------------------------------------------------------------    
      SUBROUTINE TAUGB10(kts,ktep1,COLH2O,FAC00,FAC01,FAC10,FAC11,JP,JT,JT1,    &
                         PFRAC,TAUG,LAYTROP                                     )
!--------------------------------------------------------------------------------    
                                                                                 
!     BAND 10:  1390-1480 cm-1 (low - H2O; high - H2O)                           
                                                                                 
      INTEGER, PARAMETER :: NGS9=108                                     
                                                                                 
      INTEGER, INTENT(IN )                      :: kts,ktep1

      INTEGER, INTENT(IN )                      ::  LAYTROP

      REAL, DIMENSION( NGPT,kts:ktep1 ),                    &
            INTENT(INOUT)        ::                  PFRAC, &
                                                      TAUG

      REAL, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::        &
                                                    COLH2O, &
                                                     FAC00, &
                                                     FAC01, &
                                                     FAC10, &
                                                     FAC11
 
      INTEGER, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::     &
                                                        JP, &
                                                        JT, &
                                                       JT1
      integer :: lay,ig,ind0,ind1,inds
      integer :: js,ns
      real :: fs,ratio,speccomb,specparm,specmult
      real :: fac011,fac001,fac111,fac101,fac110,fac000,fac100,fac010
      real :: colref1,colref2,currn2o,wcomb1,wcomb2

! This compiler directive was added to insure private common block storage       
! in multi-tasked mode on a CRAY or SGI for all commons except those that        
! carry constants.                                                               
                                                                                 
!     Compute the optical depth by interpolating in ln(pressure) and             
!     temperature.                                                               
!cdir novector
      DO 2500 LAY = 1, LAYTROP                                                   
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(10) + 1                         
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(10) + 1                            
         DO 2000 IG = 1, NG10                                                    
            TAUG(NGS9+IG,LAY) = COLH2O(LAY) *          &
                (FAC00(LAY) * ABSA10(IND0,IG) +        &                           
                 FAC10(LAY) * ABSA10(IND0+1,IG) +      &                           
                 FAC01(LAY) * ABSA10(IND1,IG) +        &                           
                 FAC11(LAY) * ABSA10(IND1+1,IG))                                   
            PFRAC(NGS9+IG,LAY) = FRACREFAC10(IG)                                    
 2000    CONTINUE                                                                
 2500 CONTINUE                                                                   
                                                                                 
!cdir novector
      DO 3500 LAY = LAYTROP+1, NLAYERS                                           
         IND0 = ((JP(LAY)-13)*5+(JT(LAY)-1))*NSPB(10) + 1                        
         IND1 = ((JP(LAY)-12)*5+(JT1(LAY)-1))*NSPB(10) + 1                       
         DO 3000 IG = 1, NG10                                                    
            TAUG(NGS9+IG,LAY) = COLH2O(LAY) *        &
                (FAC00(LAY) * ABSB10(IND0,IG) +        &                           
                 FAC10(LAY) * ABSB10(IND0+1,IG) +      &                           
                 FAC01(LAY) * ABSB10(IND1,IG) +        &                           
                 FAC11(LAY) * ABSB10(IND1+1,IG))                                   
            PFRAC(NGS9+IG,LAY) = FRACREFBC10(IG)                                    
 3000    CONTINUE                                                                
 3500 CONTINUE                                                                   
                                                                                 
      END SUBROUTINE TAUGB10
                                                                                 
!--------------------------------------------------------------------------    
      SUBROUTINE TAUGB11(kts,ktep1,COLH2O,FAC00,FAC01,FAC10,FAC11,        &
                         SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,PFRAC,TAUG,   &
                         LAYTROP                                          )
!--------------------------------------------------------------------------    
                                                                                 
!     BAND 11:  1480-1800 cm-1 (low - H2O; high - H2O)                           
                                                                                 
      INTEGER, PARAMETER :: NGS10=114                                    
                                                                                 
      INTEGER, INTENT(IN )                      :: kts,ktep1

      INTEGER, INTENT(IN )                      ::  LAYTROP

      REAL, DIMENSION( NGPT,kts:ktep1 ),                    &
            INTENT(INOUT)        ::                  PFRAC, &
                                                      TAUG

      REAL, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::        &
                                                    COLH2O, &
                                                     FAC00, &
                                                     FAC01, &
                                                     FAC10, &
                                                     FAC11, &
                                                   SELFFAC, &
                                                  SELFFRAC 
 
      INTEGER, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::     &
                                                        JP, &
                                                        JT, &
                                                       JT1, &
                                                   INDSELF
      integer :: lay,ig,ind0,ind1,inds
      integer :: js,ns
      real :: fs,ratio,speccomb,specparm,specmult
      real :: fac011,fac001,fac111,fac101,fac110,fac000,fac100,fac010
      real :: colref1,colref2,currn2o,wcomb1,wcomb2

! This compiler directive was added to insure private common block storage       
! in multi-tasked mode on a CRAY or SGI for all commons except those that        
! carry constants.                                                               
                                                                                 

!     Compute the optical depth by interpolating in ln(pressure) and             
!     temperature.  Below LAYTROP, the water vapor self-continuum                
!     is interpolated (in temperature) separately.                               
!cdir novector
      DO 2500 LAY = 1, LAYTROP                                                   
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(11) + 1                         
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(11) + 1                            
         INDS = INDSELF(LAY)                                                     
         DO 2000 IG = 1, NG11                                                    
            TAUG(NGS10+IG,LAY) = COLH2O(LAY) *                 &                   
                (FAC00(LAY) * ABSA11(IND0,IG) +                &                   
                 FAC10(LAY) * ABSA11(IND0+1,IG) +              &                   
                 FAC01(LAY) * ABSA11(IND1,IG) +                &                   
                 FAC11(LAY) * ABSA11(IND1+1,IG) +              &                   
                 SELFFAC(LAY) * (SELFREFC11(INDS,IG) +         & 
                 SELFFRAC(LAY) *                               &                   
                 (SELFREFC11(INDS+1,IG) - SELFREFC11(INDS,IG))))                       
            PFRAC(NGS10+IG,LAY) = FRACREFAC11(IG)                                   
 2000    CONTINUE                                                                
 2500 CONTINUE                                                                   
                                                                                 
!cdir novector
      DO 3500 LAY = LAYTROP+1, NLAYERS                                           
         IND0 = ((JP(LAY)-13)*5+(JT(LAY)-1))*NSPB(11) + 1                        
         IND1 = ((JP(LAY)-12)*5+(JT1(LAY)-1))*NSPB(11) + 1                       
         DO 3000 IG = 1, NG11                                                    
            TAUG(NGS10+IG,LAY) = COLH2O(LAY) *               &                   
                (FAC00(LAY) * ABSB11(IND0,IG) +                &                   
                 FAC10(LAY) * ABSB11(IND0+1,IG) +              &                   
                 FAC01(LAY) * ABSB11(IND1,IG) +                &                   
                 FAC11(LAY) * ABSB11(IND1+1,IG))                                   
            PFRAC(NGS10+IG,LAY) = FRACREFBC11(IG)                                   
 3000    CONTINUE                                                                
 3500 CONTINUE                                                                   
                                                                                 
      END SUBROUTINE TAUGB11
                                                                                 
!-----------------------------------------------------------------------------    
      SUBROUTINE TAUGB12(kts,ktep1,COLH2O,COLCO2,FAC00,FAC01,FAC10,FAC11,    &
                         SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,PFRAC,TAUG,      &
                         LAYTROP                                             )
!-----------------------------------------------------------------------------   
                                                                                 
!     BAND 12:  1800-2080 cm-1 (low - H2O,CO2; high - nothing)                   
                                                                                 
      INTEGER, PARAMETER :: NGS11=122                                    
                                                                                 
      INTEGER, INTENT(IN )                      :: kts,ktep1

      INTEGER, INTENT(IN )                      ::  LAYTROP

      REAL, DIMENSION( NGPT,kts:ktep1 ),                    &
            INTENT(INOUT)        ::                  PFRAC, &
                                                      TAUG

      REAL, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::        &
                                                    COLH2O, &
                                                    COLCO2, &
                                                     FAC00, &
                                                     FAC01, &
                                                     FAC10, &
                                                     FAC11, &
                                                   SELFFAC, &
                                                  SELFFRAC 
 
      INTEGER, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::     &
                                                        JP, &
                                                        JT, &
                                                       JT1, &
                                                   INDSELF
      integer :: lay,ig,ind0,ind1,inds
      integer :: js,ns
      real :: fs,ratio,speccomb,specparm,specmult
      real :: fac011,fac001,fac111,fac101,fac110,fac000,fac100,fac010
      real :: colref1,colref2,currn2o,wcomb1,wcomb2
      real :: strrat1

! This compiler directive was added to insure private common block storage       
! in multi-tasked mode on a CRAY or SGI for all commons except those that        
! carry constants.                                                               
                                                                                 
      STRRAT1 = 0.009736757                                                      
                                                                                 
!     Compute the optical depth by interpolating in ln(pressure),                
!     temperature, and appropriate species.  Below LAYTROP, the water            
!     vapor self-continuum is interpolated (in temperature) separately.          
!!DIR$ NOVECTOR                                                                   
!cdir novector
      DO 2500 LAY = 1, LAYTROP                                                   
         SPECCOMB = COLH2O(LAY) + STRRAT1*COLCO2(LAY)                            
         SPECPARM = COLH2O(LAY)/SPECCOMB                                         
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS                         
         SPECMULT = 8.*(SPECPARM)                                                
         JS = 1 + INT(SPECMULT)                                                  
         FS = AMOD(SPECMULT,1.0)                                                 
         FAC000 = (1. - FS) * FAC00(LAY)                                         
         FAC010 = (1. - FS) * FAC10(LAY)                                         
         FAC100 = FS * FAC00(LAY)                                                
         FAC110 = FS * FAC10(LAY)                                                
         FAC001 = (1. - FS) * FAC01(LAY)                                         
         FAC011 = (1. - FS) * FAC11(LAY)                                         
         FAC101 = FS * FAC01(LAY)                                                
         FAC111 = FS * FAC11(LAY)                                                
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(12) + JS                        
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(12) + JS                           
         INDS = INDSELF(LAY)                                                     
!!DIR$ VECTOR                                                                     
         DO 2000 IG = 1, NG12                                                    
            TAUG(NGS11+IG,LAY) = SPECCOMB *             & 
                (FAC000 * ABSA12(IND0,IG) +             &                          
                 FAC100 * ABSA12(IND0+1,IG) +           &                          
                 FAC010 * ABSA12(IND0+9,IG) +           &                          
                 FAC110 * ABSA12(IND0+10,IG) +          &                          
                 FAC001 * ABSA12(IND1,IG) +             &                          
                 FAC101 * ABSA12(IND1+1,IG) +           &                          
                 FAC011 * ABSA12(IND1+9,IG) +           &                          
                 FAC111 * ABSA12(IND1+10,IG)) +         &                          
                 COLH2O(LAY) *                          &                          
                 SELFFAC(LAY) * (SELFREFC12(INDS,IG) +  &                          
                 SELFFRAC(LAY) *                        &                          
                 (SELFREFC12(INDS+1,IG) - SELFREFC12(INDS,IG)))                        
            PFRAC(NGS11+IG,LAY) = FRACREFAC12(IG,JS) + FS *  & 
                 (FRACREFAC12(IG,JS+1) - FRACREFAC12(IG,JS))                           
 2000    CONTINUE                                                                
 2500 CONTINUE                                                                   
                                                                                 
!cdir novector
      DO 3500 LAY = LAYTROP+1, NLAYERS                                           
         DO 3000 IG = 1, NG12                                                    
            TAUG(NGS11+IG,LAY) = 0.0                                             
            PFRAC(NGS11+IG,LAY) = 0.0                                            
 3000    CONTINUE                                                                
 3500 CONTINUE                                                                   
                                                                                 
      END SUBROUTINE TAUGB12
                                                                                 
!-----------------------------------------------------------------------------    
      SUBROUTINE TAUGB13(kts,ktep1,COLH2O,COLN2O,FAC00,FAC01,FAC10,FAC11,    &
                         SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,PFRAC,TAUG,      &
                         LAYTROP                                             )
!-----------------------------------------------------------------------------    
                                                                                 
!     BAND 13:  2080-2250 cm-1 (low - H2O,N2O; high - nothing)                   
                                                                                 
      INTEGER, PARAMETER :: NGS12=130                                    
                                                                                 
      INTEGER, INTENT(IN )                      :: kts,ktep1

      INTEGER, INTENT(IN )                      ::  LAYTROP

      REAL, DIMENSION( NGPT,kts:ktep1 ),                    &
            INTENT(INOUT)        ::                  PFRAC, &
                                                      TAUG

      REAL, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::        &
                                                    COLH2O, &
                                                    COLN2O, &
                                                     FAC00, &
                                                     FAC01, &
                                                     FAC10, &
                                                     FAC11, &
                                                   SELFFAC, &
                                                  SELFFRAC 
 
      INTEGER, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::     &
                                                        JP, &
                                                        JT, &
                                                       JT1, &
                                                   INDSELF
      integer :: lay,ig,ind0,ind1,inds
      integer :: js,ns
      real :: fs,ratio,speccomb,specparm,specmult
      real :: fac011,fac001,fac111,fac101,fac110,fac000,fac100,fac010
      real :: colref1,colref2,currn2o,wcomb1,wcomb2
      real :: strrat1

! This compiler directive was added to insure private common block storage       
! in multi-tasked mode on a CRAY or SGI for all commons except those that        
! carry constants.                                                               
                                                                                 
      STRRAT1 = 16658.87                                                         
                                                                                 
!     Compute the optical depth by interpolating in ln(pressure),                
!     temperature, and appropriate species.  Below LAYTROP, the water            
!     vapor self-continuum is interpolated (in temperature) separately.          
      DO 2500 LAY = 1, LAYTROP                                                   
         SPECCOMB = COLH2O(LAY) + STRRAT1*COLN2O(LAY)                            
         SPECPARM = COLH2O(LAY)/SPECCOMB                                         
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS                         
         SPECMULT = 8.*(SPECPARM)                                                
         JS = 1 + INT(SPECMULT)                                                  
         FS = AMOD(SPECMULT,1.0)                                                 
         FAC000 = (1. - FS) * FAC00(LAY)                                         
         FAC010 = (1. - FS) * FAC10(LAY)                                         
         FAC100 = FS * FAC00(LAY)                                                
         FAC110 = FS * FAC10(LAY)                                                
         FAC001 = (1. - FS) * FAC01(LAY)                                         
         FAC011 = (1. - FS) * FAC11(LAY)                                         
         FAC101 = FS * FAC01(LAY)                                                
         FAC111 = FS * FAC11(LAY)                                                
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(13) + JS                        
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(13) + JS                           
         INDS = INDSELF(LAY)                                                     
         DO 2000 IG = 1, NG13                                                    
            TAUG(NGS12+IG,LAY) = SPECCOMB *                &                       
                (FAC000 * ABSA13(IND0,IG) +                &                       
                 FAC100 * ABSA13(IND0+1,IG) +              &                       
                 FAC010 * ABSA13(IND0+9,IG) +              &                       
                 FAC110 * ABSA13(IND0+10,IG) +             &                       
                 FAC001 * ABSA13(IND1,IG) +                &                       
                 FAC101 * ABSA13(IND1+1,IG) +              &                       
                 FAC011 * ABSA13(IND1+9,IG) +              &                       
                 FAC111 * ABSA13(IND1+10,IG)) +            &                       
                 COLH2O(LAY) *                           &                       
                 SELFFAC(LAY) * (SELFREFC13(INDS,IG) +      &                       
                 SELFFRAC(LAY) *                         &                       
                 (SELFREFC13(INDS+1,IG) - SELFREFC13(INDS,IG)))                        
            PFRAC(NGS12+IG,LAY) = FRACREFAC13(IG,JS) + FS * &                       
                 (FRACREFAC13(IG,JS+1) - FRACREFAC13(IG,JS))                           
 2000    CONTINUE                                                                
 2500 CONTINUE                                                                   
                                                                                 
      DO 3500 LAY = LAYTROP+1, NLAYERS                                           
         DO 3000 IG = 1, NG13                                                    
            TAUG(NGS12+IG,LAY) = 0.0                                             
            PFRAC(NGS12+IG,LAY) = 0.0                                            
 3000    CONTINUE                                                                
 3500 CONTINUE                                                                   
                                                                                 

      END SUBROUTINE TAUGB13
                                                                                 
!----------------------------------------------------------------------------    
      SUBROUTINE TAUGB14(kts,ktep1,COLCO2,FAC00,FAC01,FAC10,FAC11,          &
                         SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,PFRAC,TAUG,     &
                         LAYTROP                                            )
!----------------------------------------------------------------------------    
                                                                                 
!     BAND 14:  2250-2380 cm-1 (low - CO2; high - CO2)                           
                                                                                 
      INTEGER, PARAMETER :: NGS13=134                                    
                                                                                 
      INTEGER, INTENT(IN )                      :: kts,ktep1

      INTEGER, INTENT(IN )                      ::  LAYTROP

      REAL, DIMENSION( NGPT,kts:ktep1 ),                    &
            INTENT(INOUT)        ::                  PFRAC, &
                                                      TAUG

      REAL, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::        &
                                                    COLCO2, &
                                                     FAC00, &
                                                     FAC01, &
                                                     FAC10, &
                                                     FAC11, &
                                                   SELFFAC, &
                                                  SELFFRAC 
 
      INTEGER, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::     &
                                                        JP, &
                                                        JT, &
                                                       JT1, &
                                                   INDSELF
      integer :: lay,ig,ind0,ind1,inds
      integer :: js,ns
      real :: fs,ratio,speccomb,specparm,specmult
      real :: fac011,fac001,fac111,fac101,fac110,fac000,fac100,fac010
      real :: colref1,colref2,currn2o,wcomb1,wcomb2

! This compiler directive was added to insure private common block storage       
! in multi-tasked mode on a CRAY or SGI for all commons except those that        
! carry constants.                                                               
                                                                                 
!     Compute the optical depth by interpolating in ln(pressure) and             
!     temperature.  Below LAYTROP, the water vapor self-continuum                
!     is interpolated (in temperature) separately.                               
      DO 2500 LAY = 1, LAYTROP                                                   
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(14) + 1                         
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(14) + 1                            
         INDS = INDSELF(LAY)                                                     
         DO 2000 IG = 1, NG14                                                    
            TAUG(NGS13+IG,LAY) = COLCO2(LAY) *           &
                (FAC00(LAY) * ABSA14(IND0,IG) +          &                         
                 FAC10(LAY) * ABSA14(IND0+1,IG) +        &                         
                 FAC01(LAY) * ABSA14(IND1,IG) +          &                         
                 FAC11(LAY) * ABSA14(IND1+1,IG) +        &                         
                 SELFFAC(LAY) * (SELFREFC14(INDS,IG) +   &                         
                 SELFFRAC(LAY) *                         &                         
                 (SELFREFC14(INDS+1,IG) - SELFREFC14(INDS,IG))))                       
            PFRAC(NGS13+IG,LAY) = FRACREFAC14(IG)                                   
 2000    CONTINUE                                                                
 2500 CONTINUE                                                                   
                                                                                 
      DO 3500 LAY = LAYTROP+1, NLAYERS                                           
         IND0 = ((JP(LAY)-13)*5+(JT(LAY)-1))*NSPB(14) + 1                        
         IND1 = ((JP(LAY)-12)*5+(JT1(LAY)-1))*NSPB(14) + 1                       
         DO 3000 IG = 1, NG14                                                    
            TAUG(NGS13+IG,LAY) = COLCO2(LAY) *       &                           
                (FAC00(LAY) * ABSB14(IND0,IG) +        &                           
                 FAC10(LAY) * ABSB14(IND0+1,IG) +      &                           
                 FAC01(LAY) * ABSB14(IND1,IG) +        &                           
                 FAC11(LAY) * ABSB14(IND1+1,IG))                                   
            PFRAC(NGS13+IG,LAY) = FRACREFBC14(IG)                                   
 3000    CONTINUE                                                                
 3500 CONTINUE                                                                   
                                                                                 
      END SUBROUTINE TAUGB14
                                                                                 
!------------------------------------------------------------------------------    
      SUBROUTINE TAUGB15(kts,ktep1,COLH2O,COLCO2,COLN2O,FAC00,FAC01,FAC10,    &
                         FAC11,SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,            &
                         PFRAC,TAUG,LAYTROP                                   )
!------------------------------------------------------------------------------    
                                                                                 
!     BAND 15:  2380-2600 cm-1 (low - N2O,CO2; high - nothing)                   
                                                                                 
      INTEGER, PARAMETER :: NGS14=136                                    
                                                                                 
      INTEGER, INTENT(IN )                      :: kts,ktep1

      INTEGER, INTENT(IN )                      ::  LAYTROP

      REAL, DIMENSION( NGPT,kts:ktep1 ),                    &
            INTENT(INOUT)        ::                  PFRAC, &
                                                      TAUG

      REAL, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::        &
                                                    COLH2O, &
                                                    COLCO2, &
                                                    COLN2O, &
                                                     FAC00, &
                                                     FAC01, &
                                                     FAC10, &
                                                     FAC11, &
                                                   SELFFAC, &
                                                  SELFFRAC 
 
      INTEGER, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::     &
                                                        JP, &
                                                        JT, &
                                                       JT1, &
                                                   INDSELF
      integer :: lay,ig,ind0,ind1,inds
      integer :: js,ns
      real :: fs,ratio,speccomb,specparm,specmult
      real :: fac011,fac001,fac111,fac101,fac110,fac000,fac100,fac010
      real :: colref1,colref2,currn2o,wcomb1,wcomb2
      real :: strrat1

! This compiler directive was added to insure private common block storage       
! in multi-tasked mode on a CRAY or SGI for all commons except those that        
! carry constants.                                                               
                                                                                 
      STRRAT1 = 0.2883201                                                        
                                                                                 
!     Compute the optical depth by interpolating in ln(pressure),                
!     temperature, and appropriate species.  Below LAYTROP, the water            
!     vapor self-continuum is interpolated (in temperature) separately.          
      DO 2500 LAY = 1, LAYTROP                                                   
         SPECCOMB = COLN2O(LAY) + STRRAT1*COLCO2(LAY)                            
         SPECPARM = COLN2O(LAY)/SPECCOMB                                         
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS                         
         SPECMULT = 8.*(SPECPARM)                                                
         JS = 1 + INT(SPECMULT)                                                  
         FS = AMOD(SPECMULT,1.0)                                                 
         FAC000 = (1. - FS) * FAC00(LAY)                                         
         FAC010 = (1. - FS) * FAC10(LAY)                                         
         FAC100 = FS * FAC00(LAY)                                                
         FAC110 = FS * FAC10(LAY)                                                
         FAC001 = (1. - FS) * FAC01(LAY)                                         
         FAC011 = (1. - FS) * FAC11(LAY)                                         
         FAC101 = FS * FAC01(LAY)                                                
         FAC111 = FS * FAC11(LAY)                                                
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(15) + JS                        
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(15) + JS                           
         INDS = INDSELF(LAY)                                                     
         DO 2000 IG = 1, NG15                                                    
            TAUG(NGS14+IG,LAY) = SPECCOMB *                     &                  
                (FAC000 * ABSA15(IND0,IG) +                     &                  
                 FAC100 * ABSA15(IND0+1,IG) +                   &                  
                 FAC010 * ABSA15(IND0+9,IG) +                   &                  
                 FAC110 * ABSA15(IND0+10,IG) +                  &                  
                 FAC001 * ABSA15(IND1,IG) +                     &                  
                 FAC101 * ABSA15(IND1+1,IG) +                   &                  
                 FAC011 * ABSA15(IND1+9,IG) +                   &                  
                 FAC111 * ABSA15(IND1+10,IG)) +                 &                  
                 COLH2O(LAY) *                                &                  
                 SELFFAC(LAY) * (SELFREFC15(INDS,IG) +           &                  
                 SELFFRAC(LAY) *                              &                  
                 (SELFREFC15(INDS+1,IG) - SELFREFC15(INDS,IG)))                        
            PFRAC(NGS14+IG,LAY) = FRACREFAC15(IG,JS) + FS *      &                  
                 (FRACREFAC15(IG,JS+1) - FRACREFAC15(IG,JS))                           
 2000    CONTINUE                                                                
 2500 CONTINUE                                                                   
                                                                                 
      DO 3500 LAY = LAYTROP+1, NLAYERS                                           
         DO 3000 IG = 1, NG15                                                    
            TAUG(NGS14+IG,LAY) = 0.0                                             
            PFRAC(NGS14+IG,LAY) = 0.0                                            
 3000    CONTINUE                                                                
 3500 CONTINUE                                                                   
                                                                                 
      END SUBROUTINE TAUGB15
                                                                                 
!-----------------------------------------------------------------------------    
      SUBROUTINE TAUGB16(kts,ktep1,COLH2O,COLCH4,FAC00,FAC01,FAC10,FAC11,    &
                         SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,PFRAC,TAUG,      &
                         LAYTROP                                             )
!-----------------------------------------------------------------------------    
                                                                                 
!     BAND 16:  2600-3000 cm-1 (low - H2O,CH4; high - nothing)                   
                                                                                 
      INTEGER, PARAMETER :: NGS15=138                                    
                                                                                 
      INTEGER, INTENT(IN )                      :: kts,ktep1

      INTEGER, INTENT(IN )                      ::  LAYTROP

      REAL, DIMENSION( NGPT,kts:ktep1 ),                    &
            INTENT(INOUT)        ::                  PFRAC, &
                                                      TAUG

      REAL, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::        &
                                                    COLH2O, &
                                                    COLCH4, &
                                                     FAC00, &
                                                     FAC01, &
                                                     FAC10, &
                                                     FAC11, &
                                                   SELFFAC, &
                                                  SELFFRAC 
 
      INTEGER, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::     &
                                                        JP, &
                                                        JT, &
                                                       JT1, &
                                                   INDSELF
      integer :: lay,ig,ind0,ind1,inds
      integer :: js,ns
      real :: fs,ratio,speccomb,specparm,specmult
      real :: fac011,fac001,fac111,fac101,fac110,fac000,fac100,fac010
      real :: colref1,colref2,currn2o,wcomb1,wcomb2
      real :: strrat1

! This compiler directive was added to insure private common block storage       
! in multi-tasked mode on a CRAY or SGI for all commons except those that        
! carry constants.                                                               
                                                                                 
      STRRAT1 = 830.411                                                          
                                                                                 
!     Compute the optical depth by interpolating in ln(pressure),                
!     temperature, and appropriate species.  Below LAYTROP, the water            
!     vapor self-continuum is interpolated (in temperature) separately.          
      DO 2500 LAY = 1, LAYTROP                                                   
         SPECCOMB = COLH2O(LAY) + STRRAT1*COLCH4(LAY)                            
         SPECPARM = COLH2O(LAY)/SPECCOMB                                         
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS                         
         SPECMULT = 8.*(SPECPARM)                                                
         JS = 1 + INT(SPECMULT)                                                  
         FS = AMOD(SPECMULT,1.0)                                                 
         FAC000 = (1. - FS) * FAC00(LAY)                                         
         FAC010 = (1. - FS) * FAC10(LAY)                                         
         FAC100 = FS * FAC00(LAY)                                                
         FAC110 = FS * FAC10(LAY)                                                
         FAC001 = (1. - FS) * FAC01(LAY)                                         
         FAC011 = (1. - FS) * FAC11(LAY)                                         
         FAC101 = FS * FAC01(LAY)                                                
         FAC111 = FS * FAC11(LAY)                                                
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(16) + JS                        
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(16) + JS                           
         INDS = INDSELF(LAY)                                                     
         DO 2000 IG = 1, NG16                                                    
            TAUG(NGS15+IG,LAY) = SPECCOMB *                 &
                (FAC000 * ABSA16(IND0,IG) +                 &                      
                 FAC100 * ABSA16(IND0+1,IG) +               &                      
                 FAC010 * ABSA16(IND0+9,IG) +               &                      
                 FAC110 * ABSA16(IND0+10,IG) +              &                      
                 FAC001 * ABSA16(IND1,IG) +                 &                      
                 FAC101 * ABSA16(IND1+1,IG) +               &                      
                 FAC011 * ABSA16(IND1+9,IG) +               &                      
                 FAC111 * ABSA16(IND1+10,IG)) +             &                      
                 COLH2O(LAY) *                            &                      
                 SELFFAC(LAY) * (SELFREFC16(INDS,IG) +       &                      
                 SELFFRAC(LAY) *                          &                      
                 (SELFREFC16(INDS+1,IG) - SELFREFC16(INDS,IG)))                        
            PFRAC(NGS15+IG,LAY) = FRACREFAC16(IG,JS) + FS *  &                      
                 (FRACREFAC16(IG,JS+1) - FRACREFAC16(IG,JS))                           
 2000    CONTINUE                                                                
 2500 CONTINUE                                                                   
                                                                                 
      DO 3500 LAY = LAYTROP+1, NLAYERS                                           
         DO 3000 IG = 1, NG16                                                    
            TAUG(NGS15+IG,LAY) = 0.0                                             
            PFRAC(NGS15+IG,LAY) = 0.0                                            
 3000    CONTINUE                                                                
 3500 CONTINUE                                                                   
                                                                                 
      END SUBROUTINE TAUGB16
                                                                                 

!-------------------------------------------------------------------------
      SUBROUTINE RTRN(kts,ktep1,                                         &
                      TAVEL, PZ, TZ, CLDFRAC, TAUCLOUD, TOTDFLUX,        &
                      HTR, ICLDLYR, ITR, PFRAC, TBOUND,SEMISS            )
!-------------------------------------------------------------------------
!  RRTM Longwave Radiative Transfer Model                                        
!  Atmospheric and Environmental Research, Inc., Cambridge, MA                   
!                                                                                
!  Original version:       E. J. Mlawer, et al.                                  
!  Revision for NCAR CCM:  Michael J. Iacono; September, 1998                    
!                                                                                
!  This program calculates the upward fluxes, downward fluxes, and               
!  heating rates for an arbitrary clear or cloudy atmosphere.  The input         
!  to this program is the atmospheric profile, all Planck function               
!  information, and the cloud fraction by layer.  The diffusivity angle          
!  (SECANG=1.66) is used for the angle integration for consistency with          
!  the NCAR CCM; the Gaussian weight appropriate to this angle (WTNUM=0.5)       
!  is applied here.  Note that use of the emissivity angle for the flux          
!  integration can cause errors of 1 to 4 W/m2 within cloudy layers.             
!-------------------------------------------------------------------------
                                                                                 
      INTEGER, INTENT(IN )    ::      kts,ktep1
 
      INTEGER, DIMENSION( NGPT,kts:ktep1 ),               &
               INTENT(IN   )  ::                     ITR

      REAL, DIMENSION( NGPT,kts:ktep1 ),                  &
            INTENT(IN   )     ::                   PFRAC

      REAL, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::      &
                                                   TAVEL
      REAL, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::      &
                                                 CLDFRAC, &
                                                TAUCLOUD

      REAL, DIMENSION(   0:ktep1 ),INTENT(INOUT)::        &
                                                TOTDFLUX

      REAL, DIMENSION(   0:ktep1 ), INTENT(INOUT) ::        &
                                                     HTR  

      REAL, DIMENSION(   0:ktep1 ), INTENT(IN   ) ::      &
                                                      PZ, &
                                                      TZ
      INTEGER, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::   &
                                                 ICLDLYR

      REAL, INTENT(IN   )        ::               TBOUND
      REAL, DIMENSION(NBANDS), INTENT(IN   ) ::   SEMISS

! LOCAL VAR

      REAL, DIMENSION(   0:ktep1 )              ::        &
                                                TOTUCLFL, &
                                                TOTDCLFL, &
                                                TOTUFLUX

      REAL, DIMENSION(   0:ktep1 )              ::        &
                                                    FNET, &
                                                   FNETC, &
                                                    HTRC

      INTEGER :: kk,indbound
     
      REAL    :: CLRNTTOA,CLRNTSRF 

! Parameters                                                                     

!     INTEGER, PARAMETER :: MXLAY=101                                                      
      REAL, PARAMETER :: SECANG=1.66                                                    
      REAL, PARAMETER :: WTNUM=0.5                                                      
                                                                                 
! RRTM Definitions                                                               
! Input                                                                          
!    MXLAY                        ! Maximum number of model layers               
!    NGPT                         ! Total number of g-point subintervals         
!    NBANDS                       ! Number of longwave spectral bands            
!    SECANG                       ! Diffusivity angle                            
!    WTNUM                        ! Weight for radiance to flux conversion       
!    NLAYERS                      ! Number of model layers (plev+1)              
!    PAVEL(MXLAY)                 ! Layer pressures (mb)                         
!    PZ(0:MXLAY)                  ! Level (interface) pressures (mb)             
!    TAVEL(MXLAY)                 ! Layer temperatures (K)                       
!    TZ(0:MXLAY)                  ! Level (interface) temperatures(mb)           
!    TBOUND                       ! Surface temperature (K)                      
!    CLDFRAC(MXLAY)               ! Layer cloud fraction                         
!    TAUCLOUD(MXLAY)              ! Layer cloud optical depth                    
!    ITR(NGPT,MXLAY)              ! Integer look-up table index                  
!    PFRAC(NGPT,MXLAY)               ! Planck fractions                             
!    ICLDLYR(MXLAY)               ! Flag for cloudy layers                       
!    ICLD                         ! Flag for cloudy in column                    
!    SEMISS(NBANDS)               ! Surface emissivities for each band           
!    BPADE                        ! Pade constant                                
!    TAU                          ! Clear sky optical depth look-up table        
!    TF                           ! Tau transition function look-up table        
!    TRANS                        ! Clear sky transmittance look-up table        
! Local                                                                          
!    ABSS(NGPT*MXLAY)             ! Gaseous absorptivity                         
!    ABSCLD(MXLAY)                ! Cloud absorptivity                           
!    ATOT(NGPT*MXLAY)             ! Combined gaseous and cloud absorptivity      
!    ODCLR(NGPT,MXLAY)            ! Clear sky (gaseous) optical depth            
!    ODCLD(MXLAY)                 ! Cloud optical depth                          
!    EFCLFRAC(MXLAY)              ! Effective cloud fraction                     
!    RADLU(NGPT)                  ! Upward radiance                              
!    URAD                         ! Spectrally summed upward radiance            
!    RADCLRU(NGPT)                ! Clear sky upward radiance                    
!    CLRURAD                      ! Spectrally summed clear sky upward radiance  
!    RADLD(NGPT)                  ! Downward radiance                            
!    DRAD                         ! Spectrally summed downward radiance          
!    RADCLRD(NGPT)                ! Clear sky downward radiance                  
!    CLRDRAD                      ! Spectrally summed clear sky downward radianc 
! Output                                                                         
!    TOTUFLUX(0:MXLAY)            ! Upward longwave flux (W/m2)                  
!    TOTDFLUX(0:MXLAY)            ! Downward longwave flux (W/m2)                
!    FNET(0:MXLAY)                ! Net longwave flux (W/m2)                     
!    HTR(0:MXLAY)                 ! Longwave heating rate (K/day)                
!    CLRNTTOA                     ! Clear sky TOA outgoing flux (W/m2)           
!    CLRNTSFC                     ! Clear sky net surface flux (W/m2)            
!    TOTUCLFL(0:MXLAY)            ! Clear sky upward longwave flux (W/m2)        
!    TOTDCLFL(0:MXLAY)            ! Clear sky downward longwave flux (W/m2)      
!    FNETC(0:MXLAY)               ! Clear sky net longwave flux (W/m2)           
!    HTRC(0:MXLAY)                ! Clear sky longwave heating rate (K/day)      
!                                                                                
                                                                                 
! This compiler directive was added to insure private common block storage       
! in multi-tasked mode on a CRAY or SGI for all commons except those that        
! carry constants.                                                               

      REAL,DIMENSION(NGPT*(ktep1-kts+1)) :: BBU
      REAL,DIMENSION(NGPT*(ktep1-kts)) :: BBUTOT
      REAL,DIMENSION(NGPT) :: BGLEV
      REAL,DIMENSION(NBANDS) :: PLANKBND,PLNKEMIT
      REAL,DIMENSION(NBANDS,0:ktep1) :: PLVL
      REAL,DIMENSION(NBANDS,kts:ktep1) :: PLAY
      INTEGER,DIMENSION(kts:ktep1) :: INDLAY
      INTEGER,DIMENSION(0:ktep1) :: INDLEV
      REAL,DIMENSION(kts:ktep1) :: TLAYFRAC
      REAL,DIMENSION(0:ktep1) :: TLEVFRAC
      REAL,DIMENSION(NGPT*(ktep1-kts+1)) :: ABSS
      REAL,DIMENSION(kts:ktep1-1) :: ABSCLD
      REAL,DIMENSION(NGPT*(ktep1-kts)) :: ATOT
      REAL,DIMENSION(NGPT,kts:ktep1-1) :: ODCLR
      REAL,DIMENSION(kts:ktep1-1) :: ODCLD,EFCLFRAC
      REAL,DIMENSION(NGPT) :: RADLU,RADLD,RADCLRU,RADCLRD,SEMIS,RADUEMIT
      INTEGER :: ICLD_LEV,IND,L,LAY,lev,ipr
      real :: clrdrad,drad,tauf,transcld,odsm,factot,bglay,delbgup,bbd,bbdlevd &
             ,gassrc,delbgdn,urad,clrurad,tbndfrac,dbdtlay,dbdtlev
      integer :: iband,iclddn,ient,index
                                                                                 
      INDBOUND = TBOUND - 159.                                                   
      TBNDFRAC = TBOUND - INT(TBOUND)                                            
                                                                                 
      DO 200 LAY = 0, NLAYERS                                                    
         TOTUFLUX(LAY) = 0.0                                                     
         TOTDFLUX(LAY) = 0.0                                                     
         TOTUCLFL(LAY) = 0.0                                                     
         TOTDCLFL(LAY) = 0.0                                                     
         INDLEV(LAY) = TZ(LAY) - 159.                                            
         TLEVFRAC(LAY) = TZ(LAY) - INT(TZ(LAY))                                  
 200  CONTINUE                                                                   
                                                                                 
      DO 220 LEV = 1, NLAYERS                                                    
                                                                                 
         ICLD_LEV=ICLDLYR(LEV)
!        IF (ICLDLYR(LEV).EQ.1) THEN                                             
         IF (ICLD_LEV.EQ.1) THEN                                             
            INDLAY(LEV) = TAVEL(LEV) - 159.                                      
            TLAYFRAC(LEV) = TAVEL(LEV) - INT(TAVEL(LEV))                         
!  Cloudy sky optical depth and absorptivity.                                    
            ODCLD(LEV) = SECANG * TAUCLOUD(LEV)                                  
            TRANSCLD = EXP(-ODCLD(LEV))                                          
            ABSCLD(LEV) = 1. - TRANSCLD                                          
            EFCLFRAC(LEV) = ABSCLD(LEV) * CLDFRAC(LEV)                           
!  Get clear sky optical depth from TAU lookup table                             
            DO 250 IPR = 1, NGPT                                                 
               IND = ITR(IPR,LEV)                                                
               ODCLR(IPR,LEV) = TAU(IND)                                         
 250        CONTINUE                                                             
         ELSE                                                                    
            INDLAY(LEV) = TAVEL(LEV) - 159.                                      
            TLAYFRAC(LEV) = TAVEL(LEV) - INT(TAVEL(LEV))                         
         ENDIF                                                                   
                                                                                 
 220  CONTINUE                                                                   
                                                                                 
!      SUMPL   = 0.0                                                             
!      SUMPLEM = 0.0                                                             
! *** Loop over frequency bands.                                                 
      DO 600 IBAND = 1, NBANDS                                                   
         DBDTLEV = TOTPLNK(INDBOUND+1,IBAND)-TOTPLNK(INDBOUND,IBAND)             
         PLANKBND(IBAND) = DELWAVE(IBAND) * (TOTPLNK(INDBOUND,IBAND) +  &
              TBNDFRAC * DBDTLEV)                                                
         DBDTLEV = TOTPLNK(INDLEV(0)+1,IBAND) -                         &        
              TOTPLNK(INDLEV(0),IBAND)                                           
         PLVL(IBAND,0) = DELWAVE(IBAND) * (TOTPLNK(INDLEV(0),IBAND) +   &        
              TLEVFRAC(0)*DBDTLEV)                                               
                                                                                 
         PLNKEMIT(IBAND) = SEMISS(IBAND) * PLANKBND(IBAND)                       
!         SUMPLEM  = SUMPLEM + PLNKEMIT(IBAND)                                   
!         SUMPL    = SUMPL   + PLANKBND(IBAND)                                   
                                                                                 
         DO 300 LEV = 1, NLAYERS                                                 
!     Calculate the integrated Planck functions at the level and                 
!     layer temperatures.                                                        
            DBDTLEV = TOTPLNK(INDLEV(LEV)+1,IBAND) -          &
                 TOTPLNK(INDLEV(LEV),IBAND)                                      
            DBDTLAY = TOTPLNK(INDLAY(LEV)+1,IBAND) -          &                  
                 TOTPLNK(INDLAY(LEV),IBAND)                                      
            PLAY(IBAND,LEV) = DELWAVE(IBAND) *                &                  
                 (TOTPLNK(INDLAY(LEV),IBAND) + TLAYFRAC(LEV) * DBDTLAY)          
            PLVL(IBAND,LEV) = DELWAVE(IBAND) *                &                  
                 (TOTPLNK(INDLEV(LEV),IBAND) + TLEVFRAC(LEV) * DBDTLEV)          
 300     CONTINUE                                                                
 600  CONTINUE                                                                   
                                                                                 
!      SEMISLW = SUMPLEM / SUMPL                                                 
                                                                                 
! *** Initialize for radiative transfer.                                         
      DO 500 IPR = 1, NGPT                                                       
         RADCLRD(IPR) = 0.                                                       
         RADLD(IPR) = 0.                                                         
         SEMIS(IPR) = SEMISS(NGB(IPR))                                           
         RADUEMIT(IPR) = PFRAC(IPR,1) * PLNKEMIT(NGB(IPR))                          
         BGLEV(IPR) = PFRAC(IPR,NLAYERS) * PLVL(NGB(IPR),NLAYERS)                   
 500  CONTINUE                                                                   
                                                                                 
                                                                                 
! *** DOWNWARD RADIATIVE TRANSFER                                                
! *** DRAD holds summed radiance for total sky stream                            
! *** CLRDRAD holds summed radiance for clear sky stream                         
                                                                                 
      ICLDDN = 0                                                                 
      DO 3000 LEV = NLAYERS, 1, -1                                               
         DRAD = 0.0                                                              
         CLRDRAD = 0.0                                                           
                                                                                 
         ICLD_LEV=ICLDLYR(LEV)
!        IF (ICLDLYR(LEV).EQ.1) THEN                                             
         IF (ICLD_LEV.EQ.1) THEN                                             
                                                                                 
! *** Cloudy layer                                                               
         ICLDDN = 1                                                              
         IENT = NGPT * (LEV-1)                                                   
         DO 2000 IPR = 1, NGPT                                                   
            INDEX = IENT + IPR                                                   
!     Get lookup table index                                                     
            IND = ITR(IPR,LEV)                                                   
!     Add clear sky and cloud optical depths                                     
            ODSM = ODCLR(IPR,LEV) + ODCLD(LEV)                                   
            FACTOT = ODSM / (BPADE + ODSM)                                       
            BGLAY = PFRAC(IPR,LEV) * PLAY(NGB(IPR),LEV)                             
            DELBGUP = BGLEV(IPR) - BGLAY                                         
!     Get TF from lookup table                                                   
            TAUF = TF(IND)                                                       
            BBU(INDEX) = BGLAY + TAUF * DELBGUP                                  
            BBUTOT(INDEX) = BGLAY + FACTOT * DELBGUP                             
            BGLEV(IPR) = PFRAC(IPR,LEV) * PLVL(NGB(IPR),LEV-1)                      
            DELBGDN = BGLEV(IPR) - BGLAY                                         
            BBD = BGLAY + TAUF * DELBGDN                                         
            BBDLEVD = BGLAY + FACTOT * DELBGDN                                   
!     Get clear sky transmittance from lookup table                              
            ABSS(INDEX) = 1. - TRANS(IND)                                        
            ATOT(INDEX) = ABSS(INDEX) + ABSCLD(LEV) -      &
                ABSS(INDEX) * ABSCLD(LEV)                                        
            GASSRC = BBD * ABSS(INDEX)                                           
!     Total sky radiance                                                         
            RADLD(IPR) = RADLD(IPR) - RADLD(IPR) * (ABSS(INDEX) +  &             
               EFCLFRAC(LEV) * (1.-ABSS(INDEX))) + GASSRC +        &             
               CLDFRAC(LEV) * (BBDLEVD * ATOT(INDEX) - GASSRC)                   
            DRAD = DRAD + RADLD(IPR)                                             
!     Clear sky radiance                                                         
            RADCLRD(IPR) = RADCLRD(IPR) + (BBD - RADCLRD(IPR))     & 
                         * ABSS(INDEX)                                           
            CLRDRAD = CLRDRAD + RADCLRD(IPR)                                     
 2000    CONTINUE                                                                
                                                                                 
         ELSE                                                                    
                                                                                 
! *** Clear layer                                                                
         IENT = NGPT * (LEV-1)                                                   
         DO 2100 IPR = 1, NGPT                                                   
            INDEX = IENT + IPR                                                   
            IND = ITR(IPR,LEV)                                                   
            BGLAY = PFRAC(IPR,LEV) * PLAY(NGB(IPR),LEV)                             
            DELBGUP = BGLEV(IPR) - BGLAY                                         
!     Get TF from lookup table                                                   
            TAUF = TF(IND)                                                       
            BBU(INDEX) = BGLAY + TAUF * DELBGUP                                  
            BGLEV(IPR) = PFRAC(IPR,LEV) * PLVL(NGB(IPR),LEV-1)                      
            DELBGDN = BGLEV(IPR) - BGLAY                                         
            BBD = BGLAY + TAUF * DELBGDN                                         
!     Get clear sky transmittance from lookup table                              
            ABSS(INDEX) = 1. - TRANS(IND)                                        
!     Total sky radiance                                                         
            RADLD(IPR) = RADLD(IPR) + (BBD - RADLD(IPR)) *     & 
                         ABSS(INDEX)                                             
            DRAD = DRAD + RADLD(IPR)                                             
 2100    CONTINUE                                                                
!     Set clear sky stream to total sky stream as long as layers                 
!     remain clear.  Streams diverge when a cloud is reached.                    
            IF (ICLDDN.EQ.1) THEN                                                
         DO 2200 IPR = 1, NGPT                                                   
               RADCLRD(IPR) = RADCLRD(IPR) + (BBD - RADCLRD(IPR)) *   & 
                              ABSS(INDEX)                                        
               CLRDRAD = CLRDRAD + RADCLRD(IPR)                                  
 2200    CONTINUE                                                                
            ELSE                                                                 
         DO 2300 IPR = 1, NGPT                                                   
               RADCLRD(IPR) = RADLD(IPR)                                         
               CLRDRAD = DRAD                                                    
 2300    CONTINUE                                                                
            ENDIF                                                                
                                                                                 
! 2100    CONTINUE                                                               
                                                                                 
         ENDIF                                                                   
                                                                                 
         TOTDFLUX(LEV-1) = DRAD * WTNUM                                          
         TOTDCLFL(LEV-1) = CLRDRAD * WTNUM                                       
                                                                                 
 3000 CONTINUE                                                                   
                                                                                 
                                                                                 
! SPECTRAL EMISSIVITY & REFLECTANCE                                              
! Include the contribution of spectrally varying longwave emissivity and         
! reflection from the surface to the upward radiative transfer.                  
! Note: Spectral and Lambertian reflection are identical for the one angle       
! flux integration used here.                                                    
                                                                                 
      URAD = 0.0                                                                 
      CLRURAD = 0.0                                                              
      DO 3500 IPR = 1, NGPT                                                      
!     Total sky radiance                                                         
         RADLU(IPR) = RADUEMIT(IPR) + (1. - SEMIS(IPR)) * RADLD(IPR)             
         URAD = URAD + RADLU(IPR)                                                
!     Clear sky radiance                                                         
         RADCLRU(IPR) = RADUEMIT(IPR) + (1. - SEMIS(IPR))  & 
                        * RADCLRD(IPR)                                           
         CLRURAD = CLRURAD + RADCLRU(IPR)                                        
 3500 CONTINUE                                                                   
      TOTUFLUX(0) = URAD * WTNUM                                                 
      TOTUCLFL(0) = CLRURAD * WTNUM                                              
                                                                                 
                                                                                 
! *** UPWARD RADIATIVE TRANSFER                                                  
! *** URAD holds the summed radiance for total sky stream                        
! *** CLRURAD holds the summed radiance for clear sky stream                     
                                                                                 
      DO 5000 LEV = 1, NLAYERS                                                   
         URAD = 0.0                                                              
         CLRURAD = 0.0                                                           
                                                                                 
! Check flag for cloud in current layer                                          
                                                                                 
         ICLD_LEV=ICLDLYR(LEV)
!        IF (ICLDLYR(LEV).EQ.1) THEN                                             
         IF (ICLD_LEV.EQ.1) THEN                                             
                                                                                 
! *** Cloudy layers                                                              
         IENT = NGPT * (LEV-1)                                                   
         DO 4000 IPR = 1, NGPT                                                   
            INDEX = IENT + IPR                                                   
            GASSRC = BBU(INDEX) * ABSS(INDEX)                                    
!     Total sky radiance                                                         
            RADLU(IPR) = RADLU(IPR) - RADLU(IPR) * (ABSS(INDEX) +    &           
               EFCLFRAC(LEV) * (1.-ABSS(INDEX))) + GASSRC +          &
               CLDFRAC(LEV) * (BBUTOT(INDEX) * ATOT(INDEX) - GASSRC)             
            URAD = URAD + RADLU(IPR)                                             
!     Clear sky radiance                                                         
            RADCLRU(IPR) = RADCLRU(IPR) + (BBU(INDEX) - RADCLRU(IPR)) * &        
                           ABSS(INDEX)                                           
            CLRURAD = CLRURAD + RADCLRU(IPR)                                     
 4000    CONTINUE                                                                
                                                                                 
         ELSE                                                                    
                                                                                 
! *** Clear layer                                                                
         IENT = NGPT * (LEV-1)                                                   
         DO 4100 IPR = 1, NGPT                                                   
            INDEX = IENT + IPR                                                   
!     Total sky radiance                                                         
            RADLU(IPR) = RADLU(IPR) + (BBU(INDEX)-RADLU(IPR)) *  & 
                         ABSS(INDEX)                                             
            URAD = URAD + RADLU(IPR)                                             
!     Clear sky radiance                                                         
!     Upward clear and total sky streams must remain separate because surface    
!     reflectance is different for each.                                         
            RADCLRU(IPR) = RADCLRU(IPR) + (BBU(INDEX) - RADCLRU(IPR))   &         
                           * ABSS(INDEX)                                         
            CLRURAD = CLRURAD + RADCLRU(IPR)                                     
 4100    CONTINUE                                                                
                                                                                 
         ENDIF                                                                   
                                                                                 
         TOTUFLUX(LEV) = URAD * WTNUM                                            
         TOTUCLFL(LEV) = CLRURAD * WTNUM                                         
                                                                                 
 5000 CONTINUE                                                                   
                                                                                 
                                                                                 
! *** Convert radiances to fluxes and heating rates for total sky.  Calculates   
!     clear sky surface and TOA values.  To compute clear sky profiles, uncommen 
!     relevant lines below.                                                      
      TOTUFLUX(0) = TOTUFLUX(0) * FLUXFAC                                        
      TOTDFLUX(0) = TOTDFLUX(0) * FLUXFAC                                        
      FNET(0) = TOTUFLUX(0) - TOTDFLUX(0)                                        
      TOTUCLFL(0) = TOTUCLFL(0) * FLUXFAC                                        
      TOTDCLFL(0) = TOTDCLFL(0) * FLUXFAC                                        
      FNETC(0) = TOTUCLFL(0) - TOTDCLFL(0)                                       
      CLRNTTOA = TOTUCLFL(NLAYERS)                                               
      CLRNTSRF = TOTUFLUX(0) - TOTDCLFL(0)                                       
                                                                                 
      DO 7000 LEV = 1, NLAYERS                                                   
         TOTUFLUX(LEV) = TOTUFLUX(LEV) * FLUXFAC                                 
         TOTDFLUX(LEV) = TOTDFLUX(LEV) * FLUXFAC                                 
         FNET(LEV) = TOTUFLUX(LEV) - TOTDFLUX(LEV)                               
         TOTUCLFL(LEV) = TOTUCLFL(LEV) * FLUXFAC                                 
         TOTDCLFL(LEV) = TOTDCLFL(LEV) * FLUXFAC                                 
         FNETC(LEV) = TOTUCLFL(LEV) - TOTDCLFL(LEV)                              
         L = LEV - 1                                                             
!     Calculate Heating Rates.                                                   
         HTR(L) = HEATFAC * (FNET(L) - FNET(LEV)) / (PZ(L) - PZ(LEV))            
         HTRC(L) = HEATFAC * (FNETC(L) - FNETC(LEV)) / (PZ(L) - PZ(LEV))         
 7000 CONTINUE                                                                   
      HTR(NLAYERS) = 0.0                                                         
      HTRC(NLAYERS) = 0.0                                                        
                                                                                 

      END  SUBROUTINE RTRN

!---------------------------------------------------------------------------
      SUBROUTINE GASABS(kts,ktep1,                                         &
                        COLDRY,COLH2O,COLCO2,COLO3,COLN2O,COLCH4,          &
                        COLO2,CO2MULT,                                     &
                        FAC00,FAC01,FAC10,FAC11,                           &
                        FORFAC,SELFFAC,SELFFRAC,                           &
                        JP,JT,JT1,INDSELF,ITR,WX,PFRAC,TAUG,               &
                        LAYTROP,LAYSWTCH,LAYLOW                            )
!---------------------------------------------------------------------------
!  RRTM Longwave Radiative Transfer Model                                        
!  Atmospheric and Environmental Research, Inc., Cambridge, MA                   
!                                                                                
!  Original version:       E. J. Mlawer, et al.                                  
!  Revision for NCAR CCM:  Michael J. Iacono; September, 1998                    
!                                                                                
!  This routine calculates the gaseous optical depths for all 16 longwave        
!  spectral bands.  The optical depths are used to define the Pade               
!  approximation to the function of tau transition from tranparancy to           
!  opacity.  This function, which varies from 0 to 1, is converted to an         
!  integer that will serve as an index for the lookup tables of tau              
!  transition function and transmittance used in the radiative transfer.         
!  These lookup tables are created on initialization in routine RRTMINIT.        
!---------------------------------------------------------------------------
!                                                                                
! Definitions                                                                    
!    NGPT                         ! Total number of g-point subintervals         
!    MXLAY                        ! Maximum number of model layers               
!    SECANG                       ! Diffusivity angle for flux computation       
!    TAU(NGPT,MXLAY)              ! Gaseous optical depths                       
!    NLAYERS                      ! Number of model layers used in RRTM          
!    PAVEL(MXLAY)                 ! Model layer pressures (mb)                   
!    PZ(0:MXLAY)                  ! Model level (interface) pressures (mb)       
!    TAVEL(MXLAY)                 ! Model layer temperatures (K)                 
!    TZ(0:MXLAY)                  ! Model level (interface) temperatures (K)     
!    TBOUND                       ! Surface temperature (K)                      
!    BPADE                        ! Pade approximation constant (=1./0.278)      
!    ITR(NGPT,MXLAY)              ! Integer lookup table index                   
!                                                                                
! Parameters                                                                     
      REAL, PARAMETER :: SECANG=1.66                                                    

      INTEGER, INTENT(IN )   ::  kts,ktep1
      INTEGER, INTENT(IN )   ::  LAYTROP,LAYSWTCH,LAYLOW

      REAL, DIMENSION( NGPT,kts:ktep1 ),                  &
            INTENT(INOUT)        ::                PFRAC

      REAL, DIMENSION( NGPT,kts:ktep1 ),                  &
            INTENT(INOUT)        ::                 TAUG

      REAL, DIMENSION( MAXXSEC,kts:ktep1 ),               &
            INTENT(IN   )        ::                   WX

      INTEGER, DIMENSION( NGPT,kts:ktep1 ),               &
               INTENT(INOUT)  ::                     ITR

      REAL, DIMENSION( kts:ktep1 ), INTENT(IN   ) ::      &
                                                  COLDRY, &  
                                                  COLH2O, &
                                                  COLCO2, &
                                                   COLO3, &
                                                  COLN2O, &
                                                  COLCH4, &
                                                   COLO2, &
                                                 CO2MULT, &
                                                   FAC00, &
                                                   FAC01, &
                                                   FAC10, &
                                                   FAC11, &
                                                  FORFAC, &
                                                 SELFFAC, &
                                                SELFFRAC
 
      INTEGER, DIMENSION( kts:ktep1 ), INTENT(INOUT) ::   &
                                                      JP, &
                                                      JT, &
                                                     JT1, &
                                                 INDSELF
      integer :: ipr,lay
      real :: odepth,tff

! This compiler directive was added to insure private common block storage       
! in multi-tasked mode on a CRAY or SGI for all commons except those that        
! carry constants.                                                               
                                                                                 
! **************************************************************************     

!  Calculate optical depth for each band                                         
     
      CALL TAUGB1(kts,ktep1,COLH2O,FAC00,FAC01,FAC10,FAC11,              &
                  FORFAC,SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,PFRAC,TAUG,  &
                  LAYTROP)
      CALL TAUGB2(kts,ktep1,COLDRY,COLH2O,FAC00,FAC01,FAC10,FAC11,       &
                  FORFAC,SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,PFRAC,TAUG,  &
                  LAYTROP)
      CALL TAUGB3(kts,ktep1,COLH2O,COLCO2,COLN2O,FAC00,FAC01,FAC10,FAC11,&
                  FORFAC,SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,PFRAC,TAUG,  &
                  LAYTROP)
      CALL TAUGB4(kts,ktep1,COLH2O,COLCO2,COLO3,FAC00,FAC01,FAC10,FAC11, &
                  SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,PFRAC,TAUG,         &
                  LAYTROP)
      CALL TAUGB5(kts,ktep1,COLH2O,COLCO2,COLO3,FAC00,FAC01,FAC10,FAC11, &
                  SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,WX,PFRAC,TAUG,      &
                  LAYTROP)
      CALL TAUGB6(kts,ktep1,COLH2O,CO2MULT,FAC00,FAC01,FAC10,FAC11,      &
                  SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,WX,PFRAC,TAUG,      &
                  LAYTROP)
      CALL TAUGB7(kts,ktep1,COLH2O,COLO3,CO2MULT,FAC00,FAC01,FAC10,FAC11,&
                  SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,PFRAC,TAUG,         &
                  LAYTROP)
      CALL TAUGB8(kts,ktep1,COLH2O,COLO3,COLN2O,CO2MULT,FAC00,FAC01,FAC10,&
                  FAC11,SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,WX,PFRAC,TAUG,&
                  LAYSWTCH)
      CALL TAUGB9(kts,ktep1,COLH2O,COLN2O,COLCH4,FAC00,FAC01,FAC10,FAC11,&
                  SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,PFRAC,TAUG,         &
                  LAYTROP,LAYSWTCH,LAYLOW)
      CALL TAUGB10(kts,ktep1,COLH2O,FAC00,FAC01,FAC10,FAC11,JP,JT,JT1,&
                  PFRAC,TAUG,LAYTROP)
      CALL TAUGB11(kts,ktep1,COLH2O,FAC00,FAC01,FAC10,FAC11,             &
                  SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,PFRAC,TAUG,         &
                  LAYTROP)
      CALL TAUGB12(kts,ktep1,COLH2O,COLCO2,FAC00,FAC01,FAC10,FAC11,      &
                  SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,PFRAC,TAUG,         &
                  LAYTROP)
      CALL TAUGB13(kts,ktep1,COLH2O,COLN2O,FAC00,FAC01,FAC10,FAC11,      &
                  SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,PFRAC,TAUG,         &
                  LAYTROP)
      CALL TAUGB14(kts,ktep1,COLCO2,FAC00,FAC01,FAC10,FAC11,             &
                  SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,PFRAC,TAUG,         &
                  LAYTROP)
      CALL TAUGB15(kts,ktep1,COLH2O,COLCO2,COLN2O,FAC00,FAC01,FAC10,FAC11,&
                  SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,PFRAC,TAUG,         &
                  LAYTROP)
      CALL TAUGB16(kts,ktep1,COLH2O,COLCH4,FAC00,FAC01,FAC10,FAC11,      &
                  SELFFAC,SELFFRAC,JP,JT,JT1,INDSELF,PFRAC,TAUG,         &
                  LAYTROP)
                                                                                 
!  Compute the lookup table index from the Pade approximation of the             
!  tau transition function, which is derived from the optical depth.             
                                                                                 
      DO 6000 LAY = 1, NLAYERS                                                   
         DO 5000 IPR = 1, NGPT                                                   
            ODEPTH = SECANG * TAUG(IPR,LAY)                                       
            TFF = ODEPTH/(BPADE+ODEPTH)                                           
            IF (ODEPTH.LE.0.) TFF=0.                                              
            ITR(IPR,LAY) = INT(5.E3*TFF+0.5)
 5000    CONTINUE                                                                
 6000 CONTINUE                                                                   
      
   END SUBROUTINE GASABS

!====================================================================
!!!SUBROUTINE rrtminit(RTHRATEN,RTHRATENLW,CLDFRA,restart,          &
   SUBROUTINE rrtminit(restart,                                     &
                       allowed_to_read ,                            &
                       ids, ide, jds, jde, kds, kde,                &
                       ims, ime, jms, jme, kms, kme,                &
                       its, ite, jts, jte, kts, kte                 )
!--------------------------------------------------------------------
   IMPLICIT NONE
!--------------------------------------------------------------------

   LOGICAL , INTENT(IN)           :: restart, allowed_to_read
   INTEGER , INTENT(IN)           :: ids, ide, jds, jde, kds, kde,  &
                                     ims, ime, jms, jme, kms, kme,  &
                                     its, ite, jts, jte, kts, kte

!  REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) ::        &
!                                                         RTHRATEN, &
!                                                       RTHRATENLW, &
!                                                           CLDFRA
   REAL :: pi

   INTEGER :: i, j, k, itf, jtf, ktf

   jtf=min0(jte,jde-1)
   ktf=min0(kte,kde-1)
   itf=min0(ite,ide-1)

   IF(.not.restart)THEN
!    DO j=jts,jtf
!    DO k=kts,ktf
!    DO i=its,itf
!       RTHRATEN(i,k,j)=0.
!       RTHRATENLW(i,k,j)=0.
!       CLDFRA(i,k,j)=0. 
!    ENDDO
!    ENDDO
!    ENDDO
   ENDIF

   PI = 2.*ASIN(1.) 
   FLUXFAC  = PI   * 2.D4                     
   NLAYERS = kme

   IF ( allowed_to_read ) THEN
     CALL rrtm_lookuptable
   ENDIF

   END SUBROUTINE rrtminit


! **************************************************************************     
      SUBROUTINE rrtm_lookuptable
! **************************************************************************     

!  RRTM Longwave Radiative Transfer Model                                        
!  Atmospheric and Environmental Research, Inc., Cambridge, MA                   
!                                                                                
!  Original version:       Michael J. Iacono; July, 1998                         
!  Revision for NCAR CCM:  Michael J. Iacono; September, 1998                    
!                                                                                
!  This subroutine performs calculations necessary for the initialization        
!  of the LW model, RRTM.  Lookup tables are computed for use in the LW          
!  radiative transfer, and input absorption coefficient data for each            
!  spectral band are reduced from 256 g-points to 140 for use in RRTM.           
! **************************************************************************     
                                                                                 
! Definitions                                                                    
!     Arrays for 5000-point look-up tables:                                      
!     TAU     Clear-sky optical depth (used in cloudy radiative transfer)        
!     TF      Tau transition function; i.e. the transition of the Planck         
!             function from that for the mean layer temperature to that for      
!             the layer boundary temperature as a function of optical depth.     
!             The "linear in tau" method is used to make the table.              
!     TRANS   Transmittance                                                      
!     BPADE   Inverse of the Pade approximation constant (= 1./0.278)            

! Local                                         
      LOGICAL                 :: opened

      REAL,DIMENSION(MG) :: WTSM
      CHARACTER*80 errmess
      INTEGER rrtm_unit
      REAL :: TAU_ITRE
      INTEGER :: NG_IBND,NGC_IBND,NGN_X
      real :: fp,rtfp,tfn,wtsum
      integer :: i,ibnd,ig,igc,igcsm,ind,ipr,iprsm,irtn,itre

      IF (MYPE==0) THEN
        DO i = 10,99
          INQUIRE ( i , OPENED = opened )
          IF ( .NOT. opened ) THEN
            rrtm_unit = i
            GOTO 2010
          ENDIF
        ENDDO
        rrtm_unit = -1
 2010   CONTINUE
      ENDIF
      CALL MPI_BCAST(rrtm_unit,1,MPI_INTEGER,0  &
                    ,MPI_COMM_COMP,IRTN)
      IF ( rrtm_unit < 0 ) THEN
        WRITE(0,*)'module_ra_rrtm: rrtm_lookuptable: Can not find unused fortran unit to read in lookup table.'
!!!     CALL ESMF_Finalize(terminationflag=ESMF_ABORT)
        CALL NMMB_FINALIZE
      ENDIF

! start data 1

! **************************************************************************     
!  RRTM Longwave Radiative Transfer Model                                        
!  Atmospheric and Environmental Research, Inc., Cambridge, MA                   
!                                                                                
!  Original version:       E. J. Mlawer, et al.                                  
!  Revision for NCAR CCM:  Michael J. Iacono; September, 1998                    
!                                                                                
!  This routine contains 16 READ statements that include the                
!  absorption coefficients and other data for each of the 16 longwave            
!  spectral bands used in RRTM.  Here, the data are defined for 16               
!  g-points, or sub-intervals, per band.  These data are combined and            
!  weighted using a mapping procedure in routine RRTMINIT to reduce              
!  the total number of g-points from 256 to 140 for use in the CCM.              
! **************************************************************************     
        IF (MYPE==0) THEN
          OPEN(rrtm_unit,FILE='RRTM_DATA',                  &
               FORM='UNFORMATTED',STATUS='OLD',ERR=9009)
        ENDIF
                                                                                 
!     The array abscoefL1 contains absorption coefs at the 16 chosen g-values   
!     for a range of pressure levels > ~100mb and temperatures.  The first       
!     index in the array, JT, which runs from 1 to 5, corresponds to     
!     different temperatures.  More specifically, JT = 3 means that the          
!     data are for the corresponding TREF for this  pressure level,              
!     JT = 2 refers to the temperatureTREF-15, JT = 1 is for TREF-30,            
!     JT = 4 is for TREF+15, and JT = 5 is for TREF+30.  The second              
!     index, JP, runs from 1 to 13 and refers to the corresponding               
!     pressure level in PREF (e.g. JP = 1 is for a pressure of 1053.63 mb).      
!     The third index, IG, goes from 1 to 16, and tells us which                 
!     g-interval the absorption coefficients are for.                            


                                                                                 
!     The array abscoefH1 contains absorption coefs at the 16 chosen g-values           
!     for a range of pressure levels < ~100mb and temperatures. The first        
!     index in the array, JT, which runs from 1 to 5, corresponds to             
!     different temperatures.  More specifically, JT = 3 means that the          
!     data are for the reference temperature TREF for this pressure              
!     level, JT = 2 refers to the temperature TREF-15, JT = 1 is for             
!     TREF-30, JT = 4 is for TREF+15, and JT = 5 is for TREF+30.                 
!     The second index, JP, runs from 13 to 59 and refers to the JPth            
!     reference pressure level (see taumol.f for the value of these              
!     pressure levels in mb).  The third index, IG, goes from 1 to 16, &        
!     and tells us which g-interval the absorption coefficients are for.         

                                                                                 
!     The array SELFREF1 contains the coefficient of the water vapor              
!     self-continuum (including the energy term).  The first index               
!     refers to temperature in 7.2 degree increments.  For instance, &          
!     JT = 1 refers to a temperature of 245.6, JT = 2 refers to 252.8, &        
!     etc.  The second index runs over the g-channel (1 to 16).                  

!#define DM_BCAST_MACRO(A) CALL wrf_dm_bcast_bytes ( A , size ( A ) * RWORDSIZE )

         IF (MYPE==0) READ (rrtm_unit,ERR=9010) abscoefL1, abscoefH1, SELFREF1
!        DM_BCAST_MACRO(abscoefL1)
!        DM_BCAST_MACRO(abscoefH1)
!        DM_BCAST_MACRO(SELFREF1)
         CALL MPI_BCAST(abscoefL1,SIZE(abscoefL1),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(abscoefH1,SIZE(abscoefH1),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(SELFREF1,SIZE(SELFREF1),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)

! **************************************************************************     
!     The array abscoefL2 contains absorption coefs at the 16 chosen g-values 
!     for a range of pressure levels > ~100mb and temperatures.  The first       
!     index in the array, JT, which runs from 1 to 5, corresponds to             
!     different temperatures.  More specifically, JT = 3 means that the          
!     data are for the corresponding TREF for this  pressure level, &           
!     JT = 2 refers to the temperatureTREF-15, JT = 1 is for TREF-30, &         
!     JT = 4 is for TREF+15, and JT = 5 is for TREF+30.  The second              
!     index, JP, runs from 1 to 13 and refers to the corresponding               
!     pressure level in PREF (e.g. JP = 1 is for a pressure of 1053.63 mb).      
!     The third index, IG, goes from 1 to 16, and tells us which                 
!     g-interval the absorption coefficients are for.                            

                                                                                 
!     The array abscoefH2 contains absorption coefs at the 16 chosen g-values           
!     for a range of pressure levels < ~100mb and temperatures. The first        
!     index in the array, JT, which runs from 1 to 5, corresponds to             
!     different temperatures.  More specifically, JT = 3 means that the          
!     data are for the reference temperature TREF for this pressure              
!     level, JT = 2 refers to the temperature TREF-15, JT = 1 is for             
!     TREF-30, JT = 4 is for TREF+15, and JT = 5 is for TREF+30.                 
!     The second index, JP, runs from 13 to 59 and refers to the JPth            
!     reference pressure level (see taumol.f for the value of these              
!     pressure levels in mb).  The third index, IG, goes from 1 to 16, &        
!     and tells us which g-interval the absorption coefficients are for.         

                                                                                 
!     The array SELFREF2 contains the coefficient of the water vapor              
!     self-continuum (including the energy term).  The first index               
!     refers to temperature in 7.2 degree increments.  For instance, &          
!     JT = 1 refers to a temperature of 245.6, JT = 2 refers to 252.8, &        
!     etc.  The second index runs over the g-channel (1 to 16).                  

         IF (MYPE==0) READ (rrtm_unit,ERR=9010) abscoefL2, abscoefH2, SELFREF2
!        DM_BCAST_MACRO(abscoefL2)
!        DM_BCAST_MACRO(abscoefH2)
!        DM_BCAST_MACRO(SELFREF2)
         CALL MPI_BCAST(abscoefL2,SIZE(abscoefL2),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(abscoefH2,SIZE(abscoefH2),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(SELFREF2,SIZE(SELFREF2),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
                                                                                 
! **************************************************************************     

!     The array abscoefL3 contains absorption coefs for each of the 16 g-intervals   
!     for a range of pressure levels > ~100mb, temperatures, and ratios          
!     of water vapor to CO2.  The first index in the array, JS, runs             
!     from 1 to 10, and corresponds to different water vapor to CO2 ratios, &   
!     as expressed through the binary species parameter eta, defined as          
!     eta = h2o/(h20 + (rat) * co2), where rat is the ratio of the integrated    
!     line strength in the band of co2 to that of h2o.  For instance, &         
!     JS=1 refers to dry air (eta = 0), JS = 10 corresponds to eta = 1.0.        
!     The 2nd index in the array, JT, which runs from 1 to 5, corresponds        
!     to different temperatures.  More specifically, JT = 3 means that the       
!     data are for the reference temperature TREF for this  pressure             
!     level, JT = 2 refers to the temperature                                    
!     TREF-15, JT = 1 is for TREF-30, JT = 4 is for TREF+15, and JT = 5          
!     is for TREF+30.  The third index, JP, runs from 1 to 13 and refers         
!     to the reference pressure level (e.g. JP = 1 is for a                      
!     pressure of 1053.63 mb).  The fourth index, IG, goes from 1 to 16, &      
!     and tells us which g-interval the absorption coefficients are for.         

                                                                                 
!     The array abscoefH3 contains absorption coefs for each of the 16 g-intervals      
!     for a range of pressure levels  < ~100mb, temperatures, and ratios         
!     of H2O to CO2.  The first index in the array, JS, runs from 1 to 5, &     
!     and corresponds to different H2O to CO2 ratios, as expressed through       
!     the binary species parameter eta, defined as eta = H2O/(H2O+RAT*CO2), &   
!     where RAT is the ratio of the integrated line strength in the band         
!     of CO2 to that of H2O.  For instance, JS=1 refers to no H2O, &            
!     JS = 2 corresponds to eta = 0.25, etc.  The second index, JT, which        
!     runs from 1 to 5, corresponds to different temperatures.  More             
!     specifically, JT = 3 means that the data are for the corresponding         
!     reference temperature TREF for this  pressure level, JT = 2 refers         
!     to the TREF-15, JT = 1 is for TREF-30, JT = 4 is for TREF+15, and          
!     JT = 5 is for TREF+30.  The third index, JP, runs from 13 to 59 and        
!     refers to the corresponding pressure level in PREF (e.g. JP = 13 is        
!     for a pressure of 95.5835 mb).  The fourth index, IG, goes from 1 to       
!     16, and tells us which g-interval the absorption coefficients are for.     

                                                                                 
!     The array SELFREF3 contains the coefficient of the water vapor              
!     self-continuum (including the energy term).  The first index               
!     refers to temperature in 7.2 degree increments.  For instance, &          
!     JT = 1 refers to a temperature of 245.6, JT = 2 refers to 252.8, &        
!     etc.  The second index runs over the g-channel (1 to 16).                  

         IF (MYPE==0) READ (rrtm_unit,ERR=9010) abscoefL3, abscoefH3, SELFREF3
!        DM_BCAST_MACRO(abscoefL3)
!        DM_BCAST_MACRO(abscoefH3)
!        DM_BCAST_MACRO(SELFREF3)
         CALL MPI_BCAST(abscoefL3,SIZE(abscoefL3),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(abscoefH3,SIZE(abscoefH3),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(SELFREF3,SIZE(SELFREF3),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
                                                                                 
! **************************************************************************     
                                                                                 
!     The array abscoefL4 contains absorption coefs for each of the 16 g-intervals      
!     for a range of pressure levels > ~100mb, temperatures, and ratios          
!     of water vapor to CO2.  The first index in the array, JS, runs             
!     from 1 to 9 and corresponds to different water vapor to CO2 ratios, &     
!     as expressed through the binary species parameter eta, defined as          
!     eta = h2o/(h20 + (rat) * co2), where rat is the ratio of the integrated    
!     line strength in the band of co2 to that of h2o.  For instance, &         
!     JS=1 refers to dry air (eta = 0), JS = 9 corresponds to eta = 1.0.         
!     The 2nd index in the array, JT, which runs from 1 to 5, corresponds        
!     to different temperatures.  More specifically, JT = 3 means that the       
!     data are for the reference temperature TREF for this pressure              
!     level, JT = 2 refers to the temperature TREF-15, &                        
!     JT = 1 is for TREF-30, JT = 4 is for TREF+15, and JT = 5                   
!     is for TREF+30.  The third index, JP, runs from 1 to 13 and refers         
!     to the reference pressure level (e.g. JP = 1 is for a                      
!     pressure of 1053.63 mb).  The fourth index, IG, goes from 1 to 16, &      
!     and tells us which g-interval the absorption coefficients are for.         

                                                                                 
!     The array abscoefH4 contains absorption coefs for each of the 16 g-intervals      
!     for a range of pressure levels  < ~100mb, temperatures, and ratios         
!     of O3 to CO2.  The first index in the array, JS, runs from 1 to 6, &      
!     and corresponds to different O3 to CO2 ratios, as expressed through        
!     the binary species parameter eta, defined as eta = O3/(O3+RAT*H2O), &     
!     where RAT is the ratio of the integrated line strength in the band         
!     of CO2 to that of O3.  For instance, JS=1 refers to no O3 (eta = 0)        
!     and JS = 5 corresponds to eta = 1.0.  The second index, JT, which          
!     runs from 1 to 5, corresponds to different temperatures.  More             
!     specifically, JT = 3 means that the data are for the corresponding         
!     reference temperature TREF for this  pressure level, JT = 2 refers         
!     to the TREF-15, JT = 1 is for TREF-30, JT = 4 is for TREF+15, and          
!     JT = 5 is for TREF+30.  The third index, JP, runs from 13 to 59 and        
!     refers to the corresponding pressure level in PREF (e.g. JP = 13 is        
!     for a pressure of 95.5835 mb).  The fourth index, IG, goes from 1 to       
!     16, and tells us which g-interval the absorption coefficients are for.     

                                                                                 
!     The array SELFREF4 contains the coefficient of the water vapor              
!     self-continuum (including the energy term).  The first index               
!     refers to temperature in 7.2 degree increments.  For instance, &          
!     JT = 1 refers to a temperature of 245.6, JT = 2 refers to 252.8, &        
!     etc.  The second index runs over the g-channel (1 to 16).                  

         IF (MYPE==0) READ (rrtm_unit,ERR=9010) abscoefL4, abscoefH4, SELFREF4
!        DM_BCAST_MACRO(abscoefL4)
!        DM_BCAST_MACRO(abscoefH4)
!        DM_BCAST_MACRO(SELFREF4)
         CALL MPI_BCAST(abscoefL4,SIZE(abscoefL4),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(abscoefH4,SIZE(abscoefH4),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(SELFREF4,SIZE(SELFREF4),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
                                                                                 
! **************************************************************************     
                                                                                 
!     The array abscoefL5 contains absorption coefs for each of the 16 g-intervals
!     for a range of pressure levels > ~100mb, temperatures, and ratios          
!     of water vapor to CO2.  The first index in the array, JS, runs             
!     from 1 to 9 and corresponds to different water vapor to CO2 ratios, &     
!     as expressed through the binary species parameter eta, defined as          
!     eta = h2o/(h20 + (rat) * co2), where rat is the ratio of the integrated    
!     line strength in the band of co2 to that of h2o.  For instance, &         
!     JS=1 refers to dry air (eta = 0), JS = 9 corresponds to eta = 1.0.         
!     The 2nd index in the array, JT, which runs from 1 to 5, corresponds        
!     to different temperatures.  More specifically, JT = 3 means that the       
!     data are for the reference temperature TREF for this  pressure             
!     level, JT = 2 refers to the temperature TREF-15, &                        
!     JT = 1 is for TREF-30, JT = 4 is for TREF+15, and JT = 5                   
!     is for TREF+30.  The third index, JP, runs from 1 to 13 and refers         
!     to the reference pressure level (e.g. JP = 1 is for a                      
!     pressure of 1053.63 mb).  The fourth index, IG, goes from 1 to 16, &      
!     and tells us which g-interval the absorption coefficients are for.         

                                                                                 
!     The array abscoefH5 contains absorption coefs for each of the 16 g-intervals      
!     for a range of pressure levels  < ~100mb, temperatures, and ratios         
!     of O3 to CO2.  The first index in the array, JS, runs from 1 to 5, &      
!     and corresponds to different O3 to CO2 ratios, as expressed through        
!     the binary species parameter eta, defined as eta = O3/(O3+RAT*CO2), &     
!     where RAT is the ratio of the integrated line strength in the band         
!     of co2 to that of O3.  For instance, JS=1 refers to no O3 (eta = 0)        
!     and JS = 5 corresponds to eta = 1.0.  The second index, JT, which          
!     runs from 1 to 5, corresponds to different temperatures.  More             
!     specifically, JT = 3 means that the data are for the corresponding         
!     reference temperature TREF for this  pressure level, JT = 2 refers         
!     to the TREF-15, JT = 1 is for TREF-30, JT = 4 is for TREF+15, and          
!     JT = 5 is for TREF+30.  The third index, JP, runs from 13 to 59 and        
!     refers to the corresponding pressure level in PREF (e.g. JP = 13 is        
!     for a pressure of 95.5835 mb).  The fourth index, IG, goes from 1 to       
!     16, and tells us which g-interval the absorption coefficients are for.     

                                                                                 
!     The array SELFREF5 contains the coefficient of the water vapor              
!     self-continuum (including the energy term).  The first index               
!     refers to temperature in 7.2 degree increments.  For instance, &          
!     JT = 1 refers to a temperature of 245.6, JT = 2 refers to 252.8, &        
!     etc.  The second index runs over the g-channel (1 to 16).                  

         IF (MYPE==0) READ (rrtm_unit,ERR=9010) abscoefL5, abscoefH5, SELFREF5
!        DM_BCAST_MACRO(abscoefL5)
!        DM_BCAST_MACRO(abscoefH5)
!        DM_BCAST_MACRO(SELFREF5)
         CALL MPI_BCAST(abscoefL5,SIZE(abscoefL5),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(abscoefH5,SIZE(abscoefH5),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(SELFREF5,SIZE(SELFREF5),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
                                                                                 
! **************************************************************************     
                                                                                 
!     The array abscoefL6 contains absorption coefs at the 16 chosen g-values    
!     for a range of pressure levels > ~100mb and temperatures.  The first       
!     index in the array, JT, which runs from 1 to 5, corresponds to             
!     different temperatures.  More specifically, JT = 3 means that the          
!     data are for the corresponding TREF for this  pressure level, &           
!     JT = 2 refers to the temperatureTREF-15, JT = 1 is for TREF-30, &         
!     JT = 4 is for TREF+15, and JT = 5 is for TREF+30.  The second              
!     index, JP, runs from 1 to 13 and refers to the corresponding               
!     pressure level in PREF (e.g. JP = 1 is for a pressure of 1053.63 mb).      
!     The third index, IG, goes from 1 to 16, and tells us which                 
!     g-interval the absorption coefficients are for.                            

                                                                                 
!     The array SELFREF6 contains the coefficient of the water vapor              
!     self-continuum (including the energy term).  The first index               
!     refers to temperature in 7.2 degree increments.  For instance, &          
!     JT = 1 refers to a temperature of 245.6, JT = 2 refers to 252.8, &        
!     etc.  The second index runs over the g-channel (1 to 16).                  

         IF (MYPE==0) READ (rrtm_unit,ERR=9010) abscoefL6, SELFREF6
!        DM_BCAST_MACRO(abscoefL6)
!        DM_BCAST_MACRO(SELFREF6)
         CALL MPI_BCAST(abscoefL6,SIZE(abscoefL6),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(SELFREF6,SIZE(SELFREF6),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
                                                                                 
! **************************************************************************     
                                                                                 
!     The array abscoefL7 contains absorption coefs at the 16 chosen g-values           
!     for a range of pressure levels> ~100mb, temperatures, and binary           
!     species parameters (see taumol.f for definition).  The first               
!     index in the array, JS, runs from 1 to 9, and corresponds to               
!     different values of the binary species parameter.  For instance, &        
!     JS=1 refers to dry air, JS = 2 corresponds to the paramter value 1/8, &   
!     JS = 3 corresponds to the parameter value 2/8, etc.  The second index      
!     in the array, JT, which runs from 1 to 5, corresponds to different         
!     temperatures.  More specifically, JT = 3 means that the data are for       
!     the reference temperature TREF for this  pressure level, JT = 2 refers     
!     to TREF-15, JT = 1 is for TREF-30, JT = 4 is for TREF+15, and JT = 5       
!     is for TREF+30.  The third index, JP, runs from 1 to 13 and refers         
!     to the JPth reference pressure level (see taumol.f for these levels        
!     in mb).  The fourth index, IG, goes from 1 to 16, and indicates            
!     which g-interval the absorption coefficients are for.                      

                                                                                 
!     The array abscoefH7 contains absorption coefs at the 16 chosen g-values           
!     for a range of pressure levels < ~100mb and temperatures. The first        
!     index in the array, JT, which runs from 1 to 5, corresponds to             
!     different temperatures.  More specifically, JT = 3 means that the          
!     data are for the reference temperature TREF for this pressure              
!     level, JT = 2 refers to the temperature TREF-15, JT = 1 is for             
!     TREF-30, JT = 4 is for TREF+15, and JT = 5 is for TREF+30.                 
!     The second index, JP, runs from 13 to 59 and refers to the JPth            
!     reference pressure level (see taumol.f for the value of these              
!     pressure levels in mb).  The third index, IG, goes from 1 to 16, &        
!     and tells us which g-interval the absorption coefficients are for.         

                                                                                 
!     The array SELFREF7 contains the coefficient of the water vapor              
!     self-continuum (including the energy term).  The first index               
!     refers to temperature in 7.2 degree increments.  For instance, &          
!     JT = 1 refers to a temperature of 245.6, JT = 2 refers to 252.8, &        
!     etc.  The second index runs over the g-channel (1 to 16).                  

         IF (MYPE==0) READ (rrtm_unit,ERR=9010) abscoefL7, abscoefH7, SELFREF7
!        DM_BCAST_MACRO(abscoefL7)
!        DM_BCAST_MACRO(abscoefH7)
!        DM_BCAST_MACRO(SELFREF7)
         CALL MPI_BCAST(abscoefL7,SIZE(abscoefL7),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(abscoefH7,SIZE(abscoefH7),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(SELFREF7,SIZE(SELFREF7),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
                                                                                 
! **************************************************************************
                                                                                 
!     The array abscoefL8 contains absorption coefs at the 16 chosen g-values    
!     for a range of pressure levels > ~100mb and temperatures.  The first       
!     index in the array, JT, which runs from 1 to 5, corresponds to             
!     different temperatures.  More specifically, JT = 3 means that the          
!     data are for the corresponding TREF for this  pressure level, &           
!     JT = 2 refers to the temperatureTREF-15, JT = 1 is for TREF-30, &         
!     JT = 4 is for TREF+15, and JT = 5 is for TREF+30.  The second              
!     index, JP, runs from 1 to 13 and refers to the corresponding               
!     pressure level in PREF (e.g. JP = 1 is for a pressure of 1053.63 mb).      
!     The third index, IG, goes from 1 to 16, and tells us which                 
!     g-interval the absorption coefficients are for.                            
!     The array abscoefL8 contains absorption coef5s at the 16 chosen g-values          
!     for a range of pressure levels > ~100mb and temperatures.  The first       
!     index in the array, JT, which runs from 1 to 5, corresponds to             
!     different temperatures.  More specifically, JT = 3 means that the          
!     data are for the cooresponding TREF for this  pressure level, &           
!     JT = 2 refers to the temperature                                           
!     TREF-15, JT = 1 is for TREF-30, JT = 4 is for TREF+15, and JT = 5          
!     is for TREF+30.  The second index, JP, runs from 1 to 13 and refers        
!     to the corresponding pressure level in PREF (e.g. JP = 1 is for a          
!     pressure of 1053.63 mb).  The third index, IG, goes from 1 to 16, &       
!     and tells us which "g-channel" the absorption coefficients are for.        

                                                                                 
!     The array abscoefH8 contains absorption coefs at the 16 chosen g-values           
!     for a range of pressure levels < ~100mb and temperatures. The first        
!     index in the array, JT, which runs from 1 to 5, corresponds to             
!     different temperatures.  More specifically, JT = 3 means that the          
!     data are for the reference temperature TREF for this pressure              
!     level, JT = 2 refers to the temperature TREF-15, JT = 1 is for             
!     TREF-30, JT = 4 is for TREF+15, and JT = 5 is for TREF+30.                 
!     The second index, JP, runs from 13 to 59 and refers to the JPth            
!     reference pressure level (see taumol.f for the value of these              
!     pressure levels in mb).  The third index, IG, goes from 1 to 16, &        
!     and tells us which g-interval the absorption coefficients are for.         

!                                                                                
!       SELFREF8 is the array for the self-continuum.                                   
!                                                                                
         IF (MYPE==0) READ (rrtm_unit,ERR=9010) abscoefL8, abscoefH8, SELFREF8
!        DM_BCAST_MACRO(abscoefL8)
!        DM_BCAST_MACRO(abscoefH8)
!        DM_BCAST_MACRO(SELFREF8)
         CALL MPI_BCAST(abscoefL8,SIZE(abscoefL8),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(abscoefH8,SIZE(abscoefH8),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(SELFREF8,SIZE(SELFREF8),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
                                                                                 
! **************************************************************************
                                                                                 
!     The array abscoefL9 contains absorption coefs at the 16 chosen g-values    
!     for a range of pressure levels> ~100mb, temperatures, and binary           
!     species parameters (see taumol.f for definition).  The first               
!     index in the array, JS, runs from 1 to 11, and corresponds to              
!     different values of the binary species parameter.  For instance, &        
!     JS=1 refers to dry air, JS = 2 corresponds to the paramter value 1/8, &   
!     JS = 3 corresponds to the parameter value 2/8, etc.  The second index      
!     in the array, JT, which runs from 1 to 5, corresponds to different         
!     temperatures.  More specifically, JT = 3 means that the data are for       
!     the reference temperature TREF for this  pressure level, JT = 2 refers     
!     to TREF-15, JT = 1 is for TREF-30, JT = 4 is for TREF+15, and JT = 5       
!     is for TREF+30.  The third index, JP, runs from 1 to 13 and refers         
!     to the JPth reference pressure level (see taumol.f for these levels        
!     in mb).  The fourth index, IG, goes from 1 to 16, and indicates            
!     which g-interval the absorption coefficients are for.                      

                                                                                 
!     The array abscoefH9 contains absorption coefs at the 16 chosen g-values           
!     for a range of pressure levels < ~100mb and temperatures. The first        
!     index in the array, JT, which runs from 1 to 5, corresponds to             
!     different temperatures.  More specifically, JT = 3 means that the          
!     data are for the reference temperature TREF for this pressure              
!     level, JT = 2 refers to the temperature TREF-15, JT = 1 is for             
!     TREF-30, JT = 4 is for TREF+15, and JT = 5 is for TREF+30.                 
!     The second index, JP, runs from 13 to 59 and refers to the JPth            
!     reference pressure level (see taumol.f for the value of these              
!     pressure levels in mb).  The third index, IG, goes from 1 to 16, &        
!     and tells us which g-interval the absorption coefficients are for.         

                                                                                 
!     The array SELFREF9 contains the coefficient of the water vapor              
!     self-continuum (including the energy term).  The first index               
!     refers to temperature in 7.2 degree increments.  For instance, &          
!     JT = 1 refers to a temperature of 245.6, JT = 2 refers to 252.8, &        
!     etc.  The second index runs over the g-channel (1 to 16).                  

         IF (MYPE==0) READ (rrtm_unit,ERR=9010) abscoefL9, abscoefH9, SELFREF9
!        DM_BCAST_MACRO(abscoefL9)
!        DM_BCAST_MACRO(abscoefH9)
!        DM_BCAST_MACRO(SELFREF9)
         CALL MPI_BCAST(abscoefL9,SIZE(abscoefL9),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(abscoefH9,SIZE(abscoefH9),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(SELFREF9,SIZE(SELFREF9),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
                                                                                 
! **************************************************************************
                                                                                 
!     The array abscoefL10 contains absorption coefs at the 16 chosen g-values   
!     for a range of pressure levels > ~100mb and temperatures.  The first       
!     index in the array, JT, which runs from 1 to 5, corresponds to             
!     different temperatures.  More specifically, JT = 3 means that the          
!     data are for the corresponding TREF for this  pressure level, &           
!     JT = 2 refers to the temperatureTREF-15, JT = 1 is for TREF-30, &         
!     JT = 4 is for TREF+15, and JT = 5 is for TREF+30.  The second              
!     index, JP, runs from 1 to 13 and refers to the corresponding               
!     pressure level in PREF (e.g. JP = 1 is for a pressure of 1053.63 mb).      
!     The third index, IG, goes from 1 to 16, and tells us which                 
!     g-interval the absorption coefficients are for.                            

                                                                                 
!     The array abscoefH10 contains absorption coefs at the 16 chosen g-values           
!     for a range of pressure levels < ~100mb and temperatures. The first        
!     index in the array, JT, which runs from 1 to 5, corresponds to             
!     different temperatures.  More specifically, JT = 3 means that the          
!     data are for the reference temperature TREF for this pressure              
!     level, JT = 2 refers to the temperature TREF-15, JT = 1 is for             
!     TREF-30, JT = 4 is for TREF+15, and JT = 5 is for TREF+30.                 
!     The second index, JP, runs from 13 to 59 and refers to the JPth            
!     reference pressure level (see taumol.f for the value of these              
!     pressure levels in mb).  The third index, IG, goes from 1 to 16, &        
!     and tells us which g-interval the absorption coefficients are for.         

         IF (MYPE==0) READ (rrtm_unit,ERR=9010) abscoefL10, abscoefH10
!        DM_BCAST_MACRO(abscoefL10)
!        DM_BCAST_MACRO(abscoefH10)
         CALL MPI_BCAST(abscoefL10,SIZE(abscoefL10),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(abscoefH10,SIZE(abscoefH10),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
                                                                                 
! **************************************************************************
                                                                                 
!     The array abscoefL11 contains absorption coefs at the 16 chosen g-values   
!     for a range of pressure levels > ~100mb and temperatures.  The first       
!     index in the array, JT, which runs from 1 to 5, corresponds to             
!     different temperatures.  More specifically, JT = 3 means that the          
!     data are for the corresponding TREF for this  pressure level, &           
!     JT = 2 refers to the temperatureTREF-15, JT = 1 is for TREF-30, &         
!     JT = 4 is for TREF+15, and JT = 5 is for TREF+30.  The second              
!     index, JP, runs from 1 to 13 and refers to the corresponding               
!     pressure level in PREF (e.g. JP = 1 is for a pressure of 1053.63 mb).      
!     The third index, IG, goes from 1 to 16, and tells us which                 
!     g-interval the absorption coefficients are for.                            

                                                                                 
!     The array abscoefH11 contains absorption coefs at the 16 chosen g-values           
!     for a range of pressure levels < ~100mb and temperatures. The first        
!     index in the array, JT, which runs from 1 to 5, corresponds to             
!     different temperatures.  More specifically, JT = 3 means that the          
!     data are for the reference temperature TREF for this pressure              
!     level, JT = 2 refers to the temperature TREF-15, JT = 1 is for             
!     TREF-30, JT = 4 is for TREF+15, and JT = 5 is for TREF+30.                 
!     The second index, JP, runs from 13 to 59 and refers to the JPth            
!     reference pressure level (see taumol.f for the value of these              
!     pressure levels in mb).  The third index, IG, goes from 1 to 16, &        
!     and tells us which g-interval the absorption coefficients are for.         

                                                                                 
!     The array SELFREF11 contains the coefficient of the water vapor              
!     self-continuum (including the energy term).  The first index               
!     refers to temperature in 7.2 degree increments.  For instance, &          
!     JT = 1 refers to a temperature of 245.6, JT = 2 refers to 252.8, &        
!     etc.  The second index runs over the g-channel (1 to 16).                  

         IF (MYPE==0) READ (rrtm_unit,ERR=9010) abscoefL11, abscoefH11, SELFREF11
!        DM_BCAST_MACRO(abscoefL11)
!        DM_BCAST_MACRO(abscoefH11)
!        DM_BCAST_MACRO(SELFREF11)
         CALL MPI_BCAST(abscoefL11,SIZE(abscoefL11),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(abscoefH11,SIZE(abscoefH11),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(SELFREF11,SIZE(SELFREF11),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
                                                                                        
! **************************************************************************
                                                                                 
!     The array abscoefL12 contains absorption coefs at the 16 chosen g-values   
!     for a range of pressure levels> ~100mb, temperatures, and binary           
!     species parameters (see taumol.f for definition).  The first               
!     index in the array, JS, runs from 1 to 9, and corresponds to               
!     different values of the binary species parameter.  For instance, &        
!     JS=1 refers to dry air, JS = 2 corresponds to the paramter value 1/8, &   
!     JS = 3 corresponds to the parameter value 2/8, etc.  The second index      
!     in the array, JT, which runs from 1 to 5, corresponds to different         
!     temperatures.  More specifically, JT = 3 means that the data are for       
!     the reference temperature TREF for this  pressure level, JT = 2 refers     
!     to TREF-15, JT = 1 is for TREF-30, JT = 4 is for TREF+15, and JT = 5       
!     is for TREF+30.  The third index, JP, runs from 1 to 13 and refers         
!     to the JPth reference pressure level (see taumol.f for these levels        
!     in mb).  The fourth index, IG, goes from 1 to 16, and indicates            
!     which g-interval the absorption coefficients are for.                      

                                                                                 
!     The array SELFREF12 contains the coefficient of the water vapor              
!     self-continuum (including the energy term).  The first index               
!     refers to temperature in 7.2 degree increments.  For instance, &          
!     JT = 1 refers to a temperature of 245.6, JT = 2 refers to 252.8, &        
!     etc.  The second index runs over the g-channel (1 to 16).                  

         IF (MYPE==0) READ (rrtm_unit,ERR=9010) abscoefL12, SELFREF12
!        DM_BCAST_MACRO(abscoefL12)
!        DM_BCAST_MACRO(SELFREF12)
         CALL MPI_BCAST(abscoefL12,SIZE(abscoefL12),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(SELFREF12,SIZE(SELFREF12),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
                                                                                 
! **************************************************************************
                                                                                 
!     The array abscoefL13 contains absorption coefs at the 16 chosen g-values   
!     for a range of pressure levels> ~100mb, temperatures, and binary           
!     species parameters (see taumol.f for definition).  The first               
!     index in the array, JS, runs from 1 to 9, and corresponds to               
!     different values of the binary species parameter.  For instance, &        
!     JS=1 refers to dry air, JS = 2 corresponds to the paramter value 1/8, &   
!     JS = 3 corresponds to the parameter value 2/8, etc.  The second index      
!     in the array, JT, which runs from 1 to 5, corresponds to different         
!     temperatures.  More specifically, JT = 3 means that the data are for       
!     the reference temperature TREF for this  pressure level, JT = 2 refers     
!     to TREF-15, JT = 1 is for TREF-30, JT = 4 is for TREF+15, and JT = 5       
!     is for TREF+30.  The third index, JP, runs from 1 to 13 and refers         
!     to the JPth reference pressure level (see taumol.f for these levels        
!     in mb).  The fourth index, IG, goes from 1 to 16, and indicates            
!     which g-interval the absorption coefficients are for.                      

                                                                                 
!     The array SELFREF13 contains the coefficient of the water vapor              
!     self-continuum (including the energy term).  The first index               
!     refers to temperature in 7.2 degree increments.  For instance, &          
!     JT = 1 refers to a temperature of 245.6, JT = 2 refers to 252.8, &        
!     etc.  The second index runs over the g-channel (1 to 16).                  

         IF (MYPE==0) READ (rrtm_unit,ERR=9010) abscoefL13, SELFREF13
!        DM_BCAST_MACRO(abscoefL13)
!        DM_BCAST_MACRO(SELFREF13)
         CALL MPI_BCAST(abscoefL13,SIZE(abscoefL13),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(SELFREF13,SIZE(SELFREF13),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
                                                                                 
! **************************************************************************
                                                                                 
!     The array abscoefL14 contains absorption coefs at the 16 chosen g-values   
!     for a range of pressure levels > ~100mb and temperatures.  The first       
!     index in the array, JT, which runs from 1 to 5, corresponds to             
!     different temperatures.  More specifically, JT = 3 means that the          
!     data are for the corresponding TREF for this  pressure level, &           
!     JT = 2 refers to the temperatureTREF-15, JT = 1 is for TREF-30, &         
!     JT = 4 is for TREF+15, and JT = 5 is for TREF+30.  The second              
!     index, JP, runs from 1 to 13 and refers to the corresponding               
!     pressure level in PREF (e.g. JP = 1 is for a pressure of 1053.63 mb).      
!     The third index, IG, goes from 1 to 16, and tells us which                 
!     g-interval the absorption coefficients are for.                            

                                                                                 
!     The array abscoefH14 contains absorption coefs at the 16 chosen g-values           
!     for a range of pressure levels < ~100mb and temperatures. The first        
!     index in the array, JT, which runs from 1 to 5, corresponds to             
!     different temperatures.  More specifically, JT = 3 means that the          
!     data are for the reference temperature TREF for this pressure              
!     level, JT = 2 refers to the temperature TREF-15, JT = 1 is for             
!     TREF-30, JT = 4 is for TREF+15, and JT = 5 is for TREF+30.                 
!     The second index, JP, runs from 13 to 59 and refers to the JPth            
!     reference pressure level (see taumol.f for the value of these              
!     pressure levels in mb).  The third index, IG, goes from 1 to 16, &        
!     and tells us which g-interval the absorption coefficients are for.         

                                                                                 
!     The array SELFREF14 contains the coefficient of the water vapor              
!     self-continuum (including the energy term).  The first index               
!     refers to temperature in 7.2 degree increments.  For instance, &          
!     JT = 1 refers to a temperature of 245.6, JT = 2 refers to 252.8, &        
!     etc.  The second index runs over the g-channel (1 to 16).                  

         IF (MYPE==0) READ (rrtm_unit,ERR=9010) abscoefL14, abscoefH14, SELFREF14
!        DM_BCAST_MACRO(abscoefL14)
!        DM_BCAST_MACRO(abscoefH14)
!        DM_BCAST_MACRO(SELFREF14)
         CALL MPI_BCAST(abscoefL14,SIZE(abscoefL14),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(abscoefH14,SIZE(abscoefH14),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(SELFREF14,SIZE(SELFREF14),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
                                                                                        
! **************************************************************************
                                                                                 
!     The array abscoefL15 contains absorption coefs at the 16 chosen g-values   
!     for a range of pressure levels> ~100mb, temperatures, and binary           
!     species parameters (see taumol.f for definition).  The first               
!     index in the array, JS, runs from 1 to 9, and corresponds to               
!     different values of the binary species parameter.  For instance, &        
!     JS=1 refers to dry air, JS = 2 corresponds to the paramter value 1/8, &   
!     JS = 3 corresponds to the parameter value 2/8, etc.  The second index      
!     in the array, JT, which runs from 1 to 5, corresponds to different         
!     temperatures.  More specifically, JT = 3 means that the data are for       
!     the reference temperature TREF for this  pressure level, JT = 2 refers     
!     to TREF-15, JT = 1 is for TREF-30, JT = 4 is for TREF+15, and JT = 5       
!     is for TREF+30.  The third index, JP, runs from 1 to 13 and refers         
!     to the JPth reference pressure level (see taumol.f for these levels        
!     in mb).  The fourth index, IG, goes from 1 to 16, and indicates            
!     which g-interval the absorption coefficients are for.                      

                                                                                 
!     The array SELFREF15 contains the coefficient of the water vapor              
!     self-continuum (including the energy term).  The first index               
!     refers to temperature in 7.2 degree increments.  For instance, &          
!     JT = 1 refers to a temperature of 245.6, JT = 2 refers to 252.8, &        
!     etc.  The second index runs over the g-channel (1 to 16).                  

         IF (MYPE==0) READ (rrtm_unit,ERR=9010) abscoefL15, SELFREF15
!        DM_BCAST_MACRO(abscoefL15)
!        DM_BCAST_MACRO(SELFREF15)
         CALL MPI_BCAST(abscoefL15,SIZE(abscoefL15),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(SELFREF15,SIZE(SELFREF15),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
                                                                                 
! **************************************************************************
                                                                                 
!     The array abscoefL16 contains absorption coefs at the 16 chosen g-values  
!     for a range of pressure levels> ~100mb, temperatures, and binary           
!     species parameters (see taumol.f for definition).  The first               
!     index in the array, JS, runs from 1 to 9, and corresponds to               
!     different values of the binary species parameter.  For instance, &        
!     JS=1 refers to dry air, JS = 2 corresponds to the paramter value 1/8, &   
!     JS = 3 corresponds to the parameter value 2/8, etc.  The second index      
!     in the array, JT, which runs from 1 to 5, corresponds to different         
!     temperatures.  More specifically, JT = 3 means that the data are for       
!     the reference temperature TREF for this  pressure level, JT = 2 refers     
!     to TREF-15, JT = 1 is for TREF-30, JT = 4 is for TREF+15, and JT = 5       
!     is for TREF+30.  The third index, JP, runs from 1 to 13 and refers         
!     to the JPth reference pressure level (see taumol.f for these levels        
!     in mb).  The fourth index, IG, goes from 1 to 16, and indicates            
!     which g-interval the absorption coefficients are for.                      

                                                                                 
!     The array SELFREF16 contains the coefficient of the water vapor              
!     self-continuum (including the energy term).  The first index               
!     refers to temperature in 7.2 degree increments.  For instance, &          
!     JT = 1 refers to a temperature of 245.6, JT = 2 refers to 252.8, &        
!     etc.  The second index runs over the g-channel (1 to 16).                  

         IF (MYPE==0) READ (rrtm_unit,ERR=9010) abscoefL16, SELFREF16
!        DM_BCAST_MACRO(abscoefL16)
!        DM_BCAST_MACRO(SELFREF16)
         CALL MPI_BCAST(abscoefL16,SIZE(abscoefL16),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)
         CALL MPI_BCAST(SELFREF16,SIZE(SELFREF16),MPI_REAL,0   &
                       ,MPI_COMM_COMP,IRTN)

         IF (MYPE==0) CLOSE (rrtm_unit)
                                                                                 
!-----------------------------------------------------------------------
                                                            
                
                                                                           
!  Compute lookup tables for transmittance, tau transition function,             
!  and clear sky tau (for the cloudy sky radiative transfer).  Tau is            
!  computed as a function of the tau transition function, transmittance          
!  is calculated as a function of tau, and the tau transition function           
!  is calculated using the linear in tau formulation at values of tau            
!  above 0.01.  TF is approximated as tau/6 for tau < 0.01.  All tables          
!  are computed at intervals of 0.001.  The inverse of the constant used         
!  in the Pade approximation to the tau transition function is set to b.         
                                                                                 
      TAU(0) = 0.0                                                               
      TAU(5000) = 1.E10                                                          
      TRANS(0) = 1.0                                                             
      TRANS(5000) = 0.0                                                          
      TF(0) = 0.0                                                                
      TF(5000) = 1.0                                                             
      BPADE=1./0.278                                                             
      DO 1000 ITRE = 1,4999                                                       
         TFN = ITRE/5.E3                                                          
         TAU(ITRE) = BPADE*TFN/(1.-TFN)                                           
         TRANS(ITRE) = EXP(-TAU(ITRE))                                             
         TAU_ITRE=TAU(ITRE)
!        IF (TAU(ITRE).LT.0.1) THEN                                               
         IF (TAU_ITRE.LT.0.1) THEN                                               
            TF(ITRE) = TAU(ITRE)/6.                                                
         ELSE                                                                    
            TF(ITRE) = 1.-2.*((1./TAU(ITRE))-(TRANS(ITRE)/(1.-TRANS(ITRE))))         
         ENDIF                                                                   
 1000 CONTINUE                                                                   
!  Calculate lookup tables for functions needed in routine TAUMOL (TAUGB2)       
      CORR1(0) = 1.                                                              
      CORR1(200) = 1.                                                            
      CORR2(0) = 1.                                                              
      CORR2(200) = 1.                                                            
      DO 1200 I = 1,199                                                          
         FP = 0.005*FLOAT(I)                                                     
         RTFP = SQRT(FP)                                                         
         CORR1(I) = RTFP/FP                                                      
         CORR2(I) = (1.-RTFP)/(1.-FP)                                            
 1200 CONTINUE                                                                   
                                                                                 
!  Perform g-point reduction from 16 per band (256 total points) to              
!  a band dependant number (140 total points) for all absorption                 
!  coefficient input data and Planck fraction input data.                        
!  Compute relative weighting for new g-point combinations.                      
                                                                                 
      IGCSM = 0                                                                  
      DO 500 IBND = 1,NBANDS                                                     
         IPRSM = 0                                                               
         NGC_IBND=NGC(IBND)
!        IF (NGC(IBND).LT.16) THEN                                               
         IF (NGC_IBND.LT.16) THEN                                               
!           DO 450 IGC = 1,NGC(IBND)                                             
            DO 450 IGC = 1,NGC_IBND                                             
               IGCSM = IGCSM + 1                                                 
               WTSUM = 0.                                                        
               NGN_X=NGN(IGCSM)
!              DO 420 IPR = 1, NGN(IGCSM)                                        
               DO 420 IPR = 1, NGN_X
                  IPRSM = IPRSM + 1                                              
                  WTSUM = WTSUM + WT(IPRSM)                                      
 420           CONTINUE                                                          
               WTSM(IGC) = WTSUM                                                 
 450        CONTINUE                                                             
            NG_IBND=NG(IBND)
!           DO 400 IG = 1,NG(IBND)                                               
            DO 400 IG = 1,NG_IBND                                               
               IND = (IBND-1)*16 + IG                                            
               RWGT(IND) = WT(IG)/WTSM(NGM(IND))                                 
 400        CONTINUE                                                             
         ELSE                                                                    
            NG_IBND=NG(IBND)
!           DO 300 IG = 1,NG(IBND)                                               
            DO 300 IG = 1,NG_IBND                                               
               IGCSM = IGCSM + 1                                                 
               IND = (IBND-1)*16 + IG                                            
               RWGT(IND) = 1.0                                                   
 300        CONTINUE                                                             
         ENDIF                                                                   
 500  CONTINUE                                                                   
                                                                                 
!  Reduce g-points for relevant data in each LW spectral band.                   
                                                                                 
      CALL CMBGB1 (abscoefL1,   abscoefH1,  SELFREF1,                   &
                   FRACREFA1,   FRACREFB1,  FORREF1,                    &
                   SELFREFC1,  FORREFC1, FRACREFAC1,                    &
                   FRACREFBC1   &
                  )
      CALL CMBGB2 (abscoefL2,   abscoefH2,  SELFREF2,                   &
                   FRACREFA2,   FRACREFB2,  FORREF2,                    &
                   SELFREFC2,  FORREFC2, FRACREFAC2,                    &
                   FRACREFBC2   &
                  )
      CALL CMBGB3 (abscoefL3,   abscoefH3,  SELFREF3,                   &
                   FRACREFA3,   FRACREFB3,                              &
                   FORREF3,     ABSN2OA3,   ABSN2OB3,                   &
                   SELFREFC3,  FORREFC3,                                &
                   ABSN2OAC3,   ABSN2OBC3,  FRACREFAC3, FRACREFBC3      &
                  )
      CALL CMBGB4 (abscoefL4,   abscoefH4,  SELFREF4,                   &
                   FRACREFA4,   FRACREFB4,                              &
                   SELFREFC4,  FRACREFAC4, FRACREFBC4                   &
                  )
      CALL CMBGB5 (abscoefL5,   abscoefH5,  SELFREF5,                   &
                   FRACREFA5,   FRACREFB5,  CCL45,                      &
                   SELFREFC5,  CCL4C5, FRACREFAC5,                      &
                   FRACREFBC5   &
                  )
      CALL CMBGB6 (abscoefL6,               SELFREF6,                   &
                   FRACREFA6,   ABSCO26,    CFC11ADJ6, CFC126,          &
                   SELFREFC6, ABSCO2C6, CFC11ADJC6, CFC12C6,            &
                   FRACREFAC6   &
                  )
      CALL CMBGB7 (abscoefL7,   abscoefH7,  SELFREF7,                   &
                   FRACREFA7,   FRACREFB7,  ABSCO27,                    &
                   SELFREFC7,  ABSCO2C7, FRACREFAC7,                    &
                   FRACREFBC7   &
                  )
      CALL CMBGB8 (abscoefL8,   abscoefH8,  SELFREF8,                   &
                   FRACREFA8,   FRACREFB8,  ABSCO2A8, ABSCO2B8,         &
                   ABSN2OA8,    ABSN2OB8,   CFC128,   CFC22ADJ8,        &
                   SELFREFC8,  ABSCO2AC8, ABSCO2BC8,                    &
                   ABSN2OAC8,   ABSN2OBC8,  CFC12C8,   CFC22ADJC8,      &
                   FRACREFAC8, FRACREFBC8                               &
                  )
      CALL CMBGB9 (abscoefL9,   abscoefH9,  SELFREF9,                   &
                   FRACREFA9,   FRACREFB9,  ABSN2O9,                    &
                   SELFREFC9,  ABSN2OC9, FRACREFAC9,                    &
                   FRACREFBC9                                           &
                  )  
      CALL CMBGB10(abscoefL10, abscoefH10,                              &
                   FRACREFA10, FRACREFB10,                              &
                   FRACREFAC10, FRACREFBC10                             &
                  )
      CALL CMBGB11(abscoefL11, abscoefH11, SELFREF11,                   &
                   FRACREFA11, FRACREFB11,                              &
                   SELFREFC11,  FRACREFAC11,                            &
                   FRACREFBC11  &
                  )
      CALL CMBGB12(abscoefL12,             SELFREF12,                   &
                   FRACREFA12,                                          &
                   SELFREFC12, FRACREFAC12                              &
                  )
      CALL CMBGB13(abscoefL13,             SELFREF13,                   &
                   FRACREFA13,                                          &
                   SELFREFC13, FRACREFAC13                              &
                  )
      CALL CMBGB14(abscoefL14, abscoefH14, SELFREF14,                   &
                   FRACREFA14, FRACREFB14,                              &
                   SELFREFC14, FRACREFAC14,                             &
                   FRACREFBC14 &
                  )
      CALL CMBGB15(abscoefL15,             SELFREF15,                   &
                   FRACREFA15,                                          &
                   SELFREFC15, FRACREFAC15                              &
                  )
      CALL CMBGB16(abscoefL16,             SELFREF16,                   &
                   FRACREFA16,                                          &
                   SELFREFC16, FRACREFAC16                              &
                  )
      RETURN
9009 CONTINUE
     WRITE(0,*)'module_ra_rrtm: error opening RRTM_DATA on unit ',rrtm_unit
!!!  CALL ESMF_Finalize(terminationflag=ESMF_ABORT)
     CALL NMMB_FINALIZE
     RETURN
9010 CONTINUE
     WRITE(0,*)'module_ra_rrtm: error reading RRTM_DATA on unit ',rrtm_unit
!!!  CALL ESMF_Finalize(terminationflag=ESMF_ABORT)
     CALL NMMB_FINALIZE
      END SUBROUTINE rrtm_lookuptable

!------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!-----------------------------------------------------------------------
!
      END MODULE MODULE_RADIATION
!
!-----------------------------------------------------------------------

include ../../../conf/configure.nems

MAKEFILE = makefile

UTILINCS = -I../../share -I../libutil -I../../phys
ARCH=$(shell unmae -s)
GOCARTINCS = -I../../../chem/gocart/${ARCH}/include/Chem_Base \
             -I../../../chem/gocart/${ARCH}/include/GMAO_mpeu \
             -I../../../chem/gocart/${ARCH}/include/GEOSchem_GridComp


LIBRARY   = gfs_physics.a

OPTS     = $(FFLAGS_GFS) $(R8) -O3 $(UTILINCS)
OPTSGOCART     = $(FFLAGS_GFS) $(R8) -O3 $(UTILINCS) $(GOCARTINCS)

FFLAG90  = $(OPTS) $(FREE)
FFLAGS1  = $(OPTS) $(FIXED)
FFLAG90GOCART  = $(OPTSGOCART) $(FREE)
FFLAGS1GOCART  = $(OPTSGOCART) $(FIXED)

OBJS0   =                                      \
	  gfs_physics_err_msg_mod.o            \
	  gfs_physics_sfc_flx_mod.o	       \
	  gfs_physics_nst_var_mod.o            \
	  gfs_physics_sfc_flx_set_mod.o	       \
	  gfs_physics_gridgr_mod.o             \
	  gfs_physics_g2d_mod.o                \
	  gfs_physics_g3d_mod.o      	       \
	  gfs_physics_namelist_mod.o           \
	  gfs_physics_start_time_get_mod.o     \
	  gfs_physics_internal_state_mod.o     \
	  gfs_physics_grid_create_mod.o        \
	  gfs_physics_output.o                 \
	  gfs_physics_getcf_mod.o              \
 	  gfs_physics_initialize_mod.o         \
	  gfs_physics_run_mod.o                \
	  gfs_physics_finalize_mod.o           \
	  gfs_physics_add_get_state_ESMFField_mod.o      \
	  gfs_phy_states_mod.o                 \
	  gfs_physics_grid_comp_mod.o

OBJ_MOD	=                           \
	  resol_def.o               \
	  layout1.o                 \
	  vert_def.o                \
	  gg_def.o                  \
	  namelist_physics_def.o    \
	  coordinate_def.o          \
	  reduce_lons_grid_module.o \
	mpi_def.o		    \
	d3d_def.o        	    \
	sfcio_module.o            \
        mod_state.o               \
	nstio_module.o

OBJS    =                               \
          glats_physics.o               \
          gcycle.o                      \
          do_physics_one_step.o         \
          get_lats_node_shuff_r_fix.o   \
          setlats.o                     \
          lats_shuff.o                  \
          getcon_physics.o              \
          lon_lat_para.o                \
          compns_physics.o              \
          info.o                        \
          coundummy.o                   \
          sortrx.o                      \
          mpi_quit.o                    \
          dfi_fixwr.o                  \
          hpmdummy.o

OBJS_IO=                       \
	  fix_fields.o         \
	  read_fix.o           \
	  GFS_simple_scatter.o \
	  wrtout_physics.o     \
	  fld_collect.o        \
	  fld_collect_nst.o    \
	  para_fixio_w.o       \
	  para_nst_w.o

OBJS_RAD =                    \
	gloopr.o


OBJS_PHY = \
	gloopb.o              \
	gbphys_adv_hyb_gc.o   \
	gbphys_adv_hyb_gc_h.o

OBJS_CC=            \
	mpi_more.o  \
	cmp.comm.o  \
	atm.comm.o  \
	tiles.o

#
# *****************************************************************
#

DEPEND_FILES = ${OBJS:.o=.f} ${OBJS0:.o=.f} ${OBJ_MOD:.o=.f} ${OBJS_IO:.o=.f} ${OBJS_RAD:.o=.f} ${OBJS_PHY:.o=.f} $(OBJS_CC:.o=.f)
# DEPEND_FILES = ${OBJS0:.o=.f} ${OBJ_MOD:.o=.f} ${OBJS:.o=.f} ${OBJS_IO:.o=.f} ${OBJS_RAD:.o=.f} ${OBJS_PHY:.o=.f} $(OBJS_CC:.o=.f)

all default: depend
	@gmake -f $(MAKEFILE) $(LIBRARY)

$(LIBRARY):  $(OBJ_MOD) $(OBJS_CC) $(OBJS0) $(OBJS) $(OBJS_RAD) $(OBJS_PHY) $(OBJS_IO)
	$(AR) $(ARFLAGS) $@ $?

# .f.o: %.o: %.f
# 	$(F77) $(FFLAGS1) -c $*.f

clean:
	$(RM) -f $(LIBRARY) *.o *.mod *.lst *.f90 lm map depend

.SUFFIXES: .f .f90 .o

.f.f90:
	$(CPP) $< > $*.f90

${OBJ_MOD}: %.o: %.f
	$(CPP) $< > $*.f90
	$(F77) $(FFLAGS1) -c $*.f90

${OBJS_CC}: %.o: %.f
	$(CPP) $< > $*.f90
	$(F77) $(FFLAGS1) -c $*.f90

${OBJS0}: %.o: %.f
	${CPP} $< >$*.f90
	$(F77) $(FFLAG90) ${UTILINCS} -c $*.f90

${OBJS}: %.o: %.f
	$(CPP) $< > $*.f90
	$(F77) $(FFLAGS1) -c $*.f90

${OBJS_IO}: %.o: %.f
	$(CPP) $< > $*.f90
	$(F77) $(FFLAGS1) -c $*.f90

${OBJS_RAD}: %.o: %.f
	$(CPP) $< > $*.f90
	$(F77) $(FFLAGS1) -c $*.f90

${OBJS_PHY}: %.o: %.f
	$(CPP) $< > $*.f90
	$(F77) $(FFLAGS1) -c $*.f90


#
# *****************************************************************
#

gbphys_adv_hyb_gc.o:	gbphys_adv_hyb_gc.f90
		$(F77) $(FFLAGS1) -c gbphys_adv_hyb_gc.f90

gbphys_adv_hyb_gc_h.o:	gbphys_adv_hyb_gc_h.f90
		$(F77) $(FFLAGS1) -c gbphys_adv_hyb_gc_h.f90

# *****************************************************************

mpi_def.o:	mpi_def.f
	        ${CPP} mpi_def.f > mpi_def.f90
		$(F77) $(FFLAGS1) -c mpi_def.f90

#
# *****************************************************************
#

sfcio_module.o:	sfcio_module.f90
	        ${CPP} sfcio_module.f > sfcio_module.f90
		$(F77) $(FFLAGS) -c sfcio_module.f90

sigio_module.o:	sigio_module.f90
		$(F77) $(FFLAGSI) -c sigio_module.f90

gfsio_def.o:	gfsio_def.f90
		$(F77) $(FFLAGSI) -c gfsio_def.f90

gfsio_module.o:	gfsio_module.f90
		$(F77) $(FFLAGSI) -c gfsio_module.f90

sigio_r_module.o:	sigio_r_module.f90
		$(F77) $(FFLAGSI) -c sigio_r_module.f90

gloopr.o:	gloopr.f90
		$(F77) $(FFLAGS1) -c gloopr.f90

gloopb.o:	gloopb.f90
		$(F77) $(FFLAGS1) -c ../../phys/idea_solar_heating.o ../../phys/idea_tracer.o gloopb.f90

gcycle.o:	gcycle.f90
		$(F77) $(FFLAGS1) -c gcycle.f90

getaer.o:	getaer.f90
		$(F77) $(FFLAGS1) -c getaer.f90

gribit.o:	gribit.f90
		$(F77) $(FFLAGS1) -c gribit.f90

fld_collect.o:  fld_collect.f90
	        $(F77) $(FFLAGS1) -c fld_collect.f90

fld_collect_nst.o:  fld_collect_nst.f90
	        $(F77) $(FFLAGS1) -c fld_collect_nst.f90

read_fix.o: read_fix.f90
	        $(F77) $(FFLAGS1) -c read_fix.f90

para_fixio_w.o:  para_fixio_w.f90
		$(F77) $(FFLAGS1) -c para_fixio_w.f90

para_nst_w.o:  para_nst_w.f90
		$(F77) $(FFLAGS1) -c para_nst_w.f90

mpi_more.o:	mpi_more.f
	        ${CPP} mpi_more.f > mpi_more.f90
		$(F77) $(FFLAGxSM) -c mpi_more.f90

cmp.comm.o:	cmp.comm.f
	        ${CPP} cmp.comm.f > cmp.comm.f90
		$(F77) $(FFLAGS1) -c cmp.comm.f90

atm.comm.o:	atm.comm.f
	        ${CPP} atm.comm.f > atm.comm.f90
		$(F77) $(FFLAGS1) -c atm.comm.f90

tiles.o:	tiles.f
	        ${CPP} tiles.f > tiles.f90
		$(F77) $(FFLAGS1) -c tiles.f90

para_nstio_w.o:  para_nstio_w.f90
		$(F77) $(FFLAGS1) -c para_nstio_w.f90

wrtout_physics.o: wrtout_physics.f90
		$(F77) $(FFLAGS1) -c wrtout_physics.f90

nstio_module.o:	  nstio_module.f
	        ${CPP} nstio_module.f > nstio_module.f90
		$(F77) $(FFLAG90) -c nstio_module.f90

gfs_physics_err_msg_mod.o:      gfs_physics_err_msg_mod.f
	        ${CPP} gfs_physics_err_msg_mod.f > gfs_physics_err_msg_mod.f90
		$(F77) $(FFLAG90) -c gfs_physics_err_msg_mod.f90

#
#
#

include ../../../conf/make.rules

include depend

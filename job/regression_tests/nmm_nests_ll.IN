#!/bin/ksh
#
#@ output = out
#@ error = err
#@ job_type = parallel
#@ job_name = _JBNME_
#@ task_affinity = core(1)
#@ node_usage = not_shared
#@ tasks_per_node = _TPN_
#@ node = 4
#@ node_resources= ConsumableMemory(110GB)
#@ task_affinity=core(1)
#@ class = _CLASS_
#@ group = _CLASS_
#@ wall_clock_limit = 00:30:00
#@ parallel_threads = _THRD_
#@ preferences = Feature == "dev"
#@ network.MPI = sn_all,not_shared,us
#@ account_no=_ACCNR_
#@ queue
#
set -x
#
export BIND_TASKS=yes
export MP_EAGER_LIMIT=65536
export MP_SHARED_MEMORY=yes
export MP_SINGLE_THREAD=yes
export TARGET_CPU_RANGE=-1
export OMP_MAX_THREADS=_THRD_
export MP_LABELIO=yes
export MP_STDOUTMODE=ordered
export MP_COREFILE_FORMAT=core.txt
export TARGET_CPU_RANGE="-1"
export XLSMPOPTS=parthds=_THRD_:spins=0:yields=0:stack=128000000:schedule=static
export AIXTHREAD_SCOPE=S

RUNDIR=_RUND_
SRCDIR=_SRCD_

mkdir -p $RUNDIR
cd $RUNDIR
rm -rf $RUNDIR/*

cp _RTPWD_/NMMB_nests/input_nmmb_regional.d01        input_domain_01
cp _RTPWD_/NMMB_nests/input_nmmb_regional.d01_nemsio input_domain_01_nemsio
cp _RTPWD_/NMMB_nests/boco.* .
cp _RTPWD_/data/* .
cp _RTPWD_/NMMB_nests/GWD.bin GWD.bin

cp $SRCDIR/job/regression_tests/configure_file .
cp configure_file configure_file_01
cp _RTPWD_/NMMB_nests/configure_regional_domain_02 configure_file_02
cp _RTPWD_/NMMB_nests/configure_regional_domain_03 configure_file_03
cp _RTPWD_/NMMB_nests/configure_regional_domain_04 configure_file_04

ln -sf /nwprod/fix/global_o3prdlos.f77 fort.28
ln -sf /nwprod/fix/global_o3clim.txt fort.48


echo "Model started:  " `date`

LDR_CNTRL=DATAPSIZE=64K@TEXTPSIZE=64K@STACKPSIZE=64K \
poe $SRCDIR/exe/NMM_NEMS.x

echo "Model ended:    " `date`

exit

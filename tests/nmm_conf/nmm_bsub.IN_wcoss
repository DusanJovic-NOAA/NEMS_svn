#!/bin/sh

#BSUB -oo @[RUNDIR]/out
#BSUB -eo @[RUNDIR]/err
#BSUB -J @[JBNME]
#BSUB -n @[TASKS]
#BSUB -x
#BSUB -R span[ptile=@[TPN]]
#BSUB -R affinity[core(1):distribute=balance]
#BSUB -W 00:@[WLCLK]
#BSUB -q @[QUEUE]
#BSUB -P GFS-T2O
##BSUB -P dev
#BSUB -a poe

set -e
RUNDIR=@[RUNDIR]
cd "$RUNDIR"
set +e

source /usrx/local/Modules/default/init/sh
source @[SRCD]/src/conf/modules.nems
module list

 export KMP_STACKSIZE=1024m
 export OMP_NUM_THREADS=@[THRD]
 export MP_MPILIB=mpich2
 export MP_EUILIB=us
 export MP_TASK_AFFINITY=core:@[THRD]
 export MP_LABELIO=yes
 export MP_STDOUTMODE=unordered
 export MP_COREFILE_FORMAT=lite
#export LSB_PJL_TASK_GEOMETRY="`/u/James.A.Abeles/bin/mktjv 1536/16 12/4 768/16`"
 export LD_PRELOAD=/u/James.A.Abeles/mpi_trace_linux_x86_64/shared/libmpitrace.so

echo "Model started:  " `date`

mpirun.lsf ./NEMS.x

echo "Model ended:    " `date`

exit

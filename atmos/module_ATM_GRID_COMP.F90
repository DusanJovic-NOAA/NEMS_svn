!-----------------------------------------------------------------------
!
      MODULE MODULE_ATM_GRID_COMP
!
!-----------------------------------------------------------------------
!
!***  THIS IS THE ATM (Atmosphere) GRIDDED COMPONENT MODULE.
!***  IT WILL SET UP GRIDDED AND COUPLER SUBCOMPONENTS
!***  AND RUN THEIR INITIALIZE, RUN, AND FINALIZE ROUTINES.
!
!-----------------------------------------------------------------------
!
! PROGRAM HISTORY LOG:
!   2007-       Black - Modified from Wei-yu's version
!   2007-11-20  Black/Henderson - Created an ESMF Clock for the
!                                 ATM Component independent of
!                                 the Main Clock.
!   2007-12-11  Black - Generalized for easier use by any dynamics core.
!   2008-08     Colon - Added conditional checks multiple dynamics cores.
!   2008-10-14  Vasic - Added restart Alarm.
!
! USAGE: ATM Gridded component parts CALLed from MAIN_ESMF.F90
!
!-----------------------------------------------------------------------
!
      USE ESMF_MOD
      USE MODULE_INCLUDE
!
      USE MODULE_ATM_INTERNAL_STATE,ONLY: ATM_INTERNAL_STATE            &
                                         ,WRAP_ATM_INTERNAL_STATE
      
!
      USE MODULE_DYNAMICS_GRID_COMP  
      USE MODULE_DM_PARALLEL,ONLY : IDS,IDE,JDS,JDE                     &
                                   ,IMS,IME,JMS,JME                     &
                                   ,ITS,ITE,JTS,JTE                     &
                                   ,IHALO,JHALO                         &
                                   ,MPI_COMM_COMP                       &
                                   ,MPI_COMM_INTER_ARRAY                &
                                   ,MYPE_SHARE

!
      USE MODULE_PHYSICS_GRID_COMP,ONLY: PHY_REGISTER
!
      USE MODULE_DYN_PHY_CPL_COMP,ONLY: DYN_PHY_CPL_REGISTER 
!
      USE MODULE_GET_CONFIG_DYN
      USE MODULE_GET_CONFIG_PHY
      USE MODULE_GET_CONFIG_WRITE
      USE MODULE_CONTROL,ONLY: TIMEF
      USE MODULE_DIAGNOSE,ONLY : FIELD_STATS
!
      USE MODULE_ERR_MSG,ONLY: ERR_MSG,MESSAGE_CHECK
      
      
      USE gfs_dynamics_grid_comp_mod  ,only: gfs_dyn_setservices

      USE gfs_physics_grid_comp_mod   ,only: gfs_phy_setservices

      USE atmos_dyn_phy_cpl_comp_mod  ,only: atm_cpl_setservices
 
      USE atmos_grid_comp_mod, only: atmos_setservices, atmos_initialize, atmos_run, atmos_finalize        
                                  
                                  

!
!-----------------------------------------------------------------------
!***  LIST OTHER MODULES WITH NON_GENERIC ROUTINES USED BY ATM.
!-----------------------------------------------------------------------
!
      USE MODULE_WRITE_ROUTINES ,ONLY: WRITE_INIT,WRITE_ASYNC             !<-- These are routines used only when asynchronous
      USE MODULE_WRITE_GRID_COMP,ONLY: WRITE_SETUP                      & !    quilting is specified by the user in the
                                      ,WRITE_DESTROY                      !    configure file for history output.
!
      USE MODULE_CLOCKTIMES
!
!-----------------------------------------------------------------------
!
      IMPLICIT NONE
!
!-----------------------------------------------------------------------
#include "ESMF_LogMacros.inc"
!-----------------------------------------------------------------------
! 
      PRIVATE
!
      PUBLIC :: ATM_REGISTER

!
!-----------------------------------------------------------------------
!
      REAL(KIND=KFPT)       :: DT                                         !<-- The fundamental timestep (sec)
!
      INTEGER(KIND=KINT)    :: MYPE                                       !<-- Each MPI task ID

      INTEGER(KIND=KINT)    :: NPE_PRINT  
!
      CHARACTER(3)          :: CORE                                       !<-- The name of the selected dynamic core
!
      TYPE(ESMF_Clock),SAVE :: CLOCK_ATM                                  !<-- The ATM Component's ESMF Clock
      TYPE(ESMF_VM),SAVE    :: VM                                         !<-- The ESMF virtual machine.
!
      TYPE(ESMF_Alarm),SAVE :: ALARM_CLOCKTIME                          & !<-- The ESMF Alarm for clocktime prints
                              ,ALARM_HISTORY                            & !<-- The ESMF Alarm for history output
                              ,ALARM_RESTART                              !<-- The ESMF Alarm for restart output
!
      TYPE(ESMF_GridComp),SAVE :: GC_GFS_DYN
      TYPE(ESMF_GridComp),SAVE :: GC_GFS_PHY
      TYPE(ESMF_CplComp), SAVE :: GC_ATM_CPL

!
      TYPE(ESMF_State),SAVE :: IMP_GFS_DYN,EXP_GFS_DYN
      TYPE(ESMF_State),SAVE :: IMP_GFS_PHY,EXP_GFS_PHY
!
      INTEGER :: INPES,JNPES                                               ! MPI tasks in i and j

!      INTEGER(KIND=KINT),PUBLIC :: IM,JM,LM
!      INTEGER(KIND=KINT)        :: NUM_PES
!
!
!      LOGICAL :: ADVECT_TRACERS                                         & !<-- Flag for advecting tracers
!                ,OLD_PASSIVE                                            & !<-- Flag for old passive advection
!                ,OPERATIONAL_PHYSICS                                      !<-- Flag to designate use of operational physics suite
!
!-----------------------------------------------------------------------
!***  FOR DETERMINING CLOCKTIMES OF VARIOUS PIECES OF THE DYNAMICS.
!-----------------------------------------------------------------------
!
      REAL(KIND=KFPT) :: btim,btim0
!
!
      CONTAINS
!
!-----------------------------------------------------------------------
!#######################################################################
!-----------------------------------------------------------------------
!
      SUBROUTINE ATM_REGISTER(ATM_GRID_COMP,RC_REG)
! 
!-----------------------------------------------------------------------
!***  Register the ATM gridded component's initialize, run, and finalize
!***  routines.
!-----------------------------------------------------------------------
!
      TYPE(ESMF_GridComp),INTENT(INOUT) :: ATM_GRID_COMP                !<-- ATM gridded component
!
      INTEGER,INTENT(OUT)               :: RC_REG                       !<-- Return code for register
!     
!-----------------------------------------------------------------------
!***  LOCAL VARIABLES
!-----------------------------------------------------------------------
!
      TYPE(ESMF_Config)                :: CF                            !<-- The config object
      INTEGER :: RC
!
!-----------------------------------------------------------------------
!***********************************************************************
!-----------------------------------------------------------------------
!
      RC=ESMF_SUCCESS       ! Error signal variable
      RC_REG=ESMF_SUCCESS   ! Error signal variable

!-----------------------------------------------------------------------
!***  Register the ATM INITIALIZE subroutine.  Since it is just one 
!***  subroutine, use ESMF_SINGLEPHASE.  The second argument is
!***  a pre-defined subroutine type, such as ESMF_SETINIT, ESMF_SETRUN, 
!***  or ESMF_SETFINAL.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Create/Load the Configure Object"
!      CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~

!
      CALL ESMF_GridCompSetEntryPoint(ATM_GRID_COMP                     &  !<-- ATM gridded component
                                     ,ESMF_SETINIT                      &  !<-- Subroutine type
                                     ,ATM_INITIALIZE                    &  !<-- User's subroutine name
                                     ,ESMF_SINGLEPHASE                  &
                                     ,RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ 
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_REG)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ 
!
!-----------------------------------------------------------------------
!***  Register the ATM RUN subroutine.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ 
      MESSAGE_CHECK="Set Entry Point for ATM Run"
!      CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ 
!
      CALL ESMF_GridCompSetEntryPoint(ATM_GRID_COMP                     &  !<-- ATM gridded component
                                     ,ESMF_SETRUN                       &  !<-- Subroutine type
                                     ,ATM_RUN                           &  !<-- User's subroutine name
                                     ,ESMF_SINGLEPHASE                  &
                                     ,RC)

 
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ 
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_REG)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ 
!
!-----------------------------------------------------------------------
!***  Register the ATM FINALIZE subroutine.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ 
      MESSAGE_CHECK="Set Entry Point for ATM Finalize"
!      CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ 
!
      CALL ESMF_GridCompSetEntryPoint(ATM_GRID_COMP                     &  !<-- ATM gridded component
                                     ,ESMF_SETFINAL                     &  !<-- Subroutine type
                                     ,ATM_FINALIZE                      &  !<-- User's subroutine name
                                     ,ESMF_SINGLEPHASE                  &
                                     ,RC)

!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ 
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_REG)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ 
!
!-----------------------------------------------------------------------
!***  Check the error signal variable and print out the result.
!-----------------------------------------------------------------------
!
      IF(RC_REG==ESMF_SUCCESS)THEN
!       WRITE(0,*)' ATM_SET_SERVICES SUCCEEDED'
      ELSE
        WRITE(0,*)' ATM_SET_SERVICES FAILED  RC_REG=',RC_REG
      ENDIF
!
!-----------------------------------------------------------------------
!
      END SUBROUTINE ATM_REGISTER
!
!-----------------------------------------------------------------------
!#######################################################################
!-----------------------------------------------------------------------
!#######################################################################
!-----------------------------------------------------------------------
!
      SUBROUTINE ATM_INITIALIZE(ATM_GRID_COMP                           &
                               ,IMP_STATE,EXP_STATE                     &
                               ,CLOCK_MAIN                              &
                               ,RC_INIT)
!
!-----------------------------------------------------------------------
!***  THIS ROUTINE SETS UP FUNDAMENTAL ASPECTS OF THE MODEL RUN.
!-----------------------------------------------------------------------
!
      USE MODULE_CORE_SETUP
!-----------------------------------------------------------------------
!***  ARGUMENT VARIABLES.
!-----------------------------------------------------------------------
!
      TYPE(ESMF_GridComp),INTENT(INOUT) :: ATM_GRID_COMP                !<-- The ATM gridded component
      TYPE(ESMF_State)   ,INTENT(INOUT) :: IMP_STATE,EXP_STATE          !<-- The ATM component's import/export states
      TYPE(ESMF_Clock)   ,INTENT(INOUT)    :: CLOCK_MAIN                   !<-- The main program's ESMF Clock!
      INTEGER,OPTIONAL   ,INTENT(OUT)   :: RC_INIT                      !<-- Return code for Initialize step
!
!-----------------------------------------------------------------------
!***  LOCAL VARIABLES
!-----------------------------------------------------------------------
!
      TYPE(WRAP_ATM_INTERNAL_STATE)    :: WRAP                          !<-- The F90 wrap of the ATM internal state
      TYPE(ATM_INTERNAL_STATE),POINTER :: ATM_INT_STATE                 !<-- The ATM internal state pointer
!
      TYPE(ESMF_Config)                :: CF                            !<-- The config object
!
      TYPE(ESMF_Grid)                  :: GRID_ATM                      !<-- The ESMF GRID for the integration attached to
                                                                        !    the ATM gridded component.
      TYPE(ESMF_Grid)                  :: GRID_DYN                      !<-- The ESMF GRID for the integration attached to
                                                                        !    the dynamics gridded component.
      TYPE(ESMF_Grid)                  :: GRID_PHY                      !<-- The ESMF GRID for the integration attached to
                                                                        !    the physics gridded component.
!
      INTEGER                          :: TIMESTEP_SEC_WHOLE            !<-- Integer part of timestep in seconds
      INTEGER                          :: TIMESTEP_SEC_NUMERATOR        !<-- Numerator of timestep fraction
      INTEGER                          :: TIMESTEP_SEC_DENOMINATOR      !<-- Denominator of timestep fraction
      TYPE(ESMF_TimeInterval)          :: TIMESTEP                      !<-- The ESMF timestep (s)
      TYPE(ESMF_TimeInterval)          :: RUNDURATION                   !<-- The ESMF simulation length (h)
      TYPE(ESMF_Time)                  :: CURRTIME                      !<-- The ESMF current time.
      TYPE(ESMF_Time)                  :: STARTTIME                     !<-- The ESMF start time.
      TYPE(ESMF_Grid)  :: grid_gfs_dyn     ! the ESMF grid for the integration attached to
                                                   ! the dynamics gridded component.
      TYPE(ESMF_Grid)  :: grid_gfs_phy     ! the ESMF grid for the integration attached to
!
      TYPE(ESMF_Grid)                  :: grid_atmos    ! the esmf grid for the integration attached to

      INTEGER                          :: NHOURS_CLOCKTIME            & !<-- Hours between clocktime prints
                                         ,NHOURS_HISTORY              & !<-- Hours between history output
                                         ,NHOURS_RESTART                !<-- Hours between restart output
!
      TYPE(ESMF_TimeInterval)          :: TIMEINTERVAL_CLOCKTIME      & !<-- ESMF time interval between clocktime prints (h)
                                         ,TIMEINTERVAL_HISTORY        & !<-- ESMF time interval between history output (h)
                                         ,TIMEINTERVAL_RESTART          !<-- ESMF time interval between restart output (h)
!
      LOGICAL                          :: DIST_MEM,PHYSICS_ON           !<-- Logical flag for distributed
      LOGICAL                          :: QUILTING                      !<-- Logical flag for quilting in
!
      INTEGER                          :: I,IERR,RC,IRTN,J,K,N,NN
      INTEGER                          :: RC_FINAL
      CHARACTER(50)                    :: MODE
!
      type(ESMF_DistGrid)          :: DistGrid_atmos

!
      integer, dimension(2)         :: ncounts     ! parameter array to set up the
                                                   ! size of the 2-d ESMF grid.
      integer, dimension(2)         :: min,max     ! parameter arrays to set up the
                                                   ! start number and the end number of
                                                   ! the ESMF grid in each dimension.
      integer,dimension(ESMF_maxgriddim) :: counts
      INTEGER , DIMENSION(2)             :: i1
      INTEGER , DIMENSION(:, :), POINTER :: i2
      integer                      :: im,jm,lm                  ! full grid dimensions
      integer                      :: num_pes,num_pes_fcst,num_pes_tot
      integer                      :: mpi_intra,mpi_intra_b     ! the mpi intra-communicator!
      logical                      :: global
      RC     =ESMF_success


!-----------------------------------------------------------------------
!***********************************************************************
!-----------------------------------------------------------------------
!***  INITIALIZE TIMING VARIABLES.
!-----------------------------------------------------------------------
!
      btim0=timef()
      total_tim=0.
      totalsum_tim=0.
!
!-----------------------------------------------------------------------
!***  RETRIEVE THE CONFIG OBJECT CF FROM THE ATM GRIDDED COMPONENT.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Retrieve Config Object from ATM Component"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_GridCompGet(gridcomp=ATM_GRID_COMP                      &  !<-- The ATM gridded component
                           ,config  =CF                                 &  !<-- The config object (~namelist)
                           ,rc      =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------------------------------------------------
!***  EXTRACT THE DYNAMIC CORE NAME.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Extract Dynamic Core Name"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_ConfigGetAttribute(config=CF                            &  !<-- The config object
                                  ,value =CORE                          &  !<-- The variable filled (dynamic core name)
                                  ,label ='core:'                       &  !<-- Give this label's value to the previous variable
                                  ,rc    =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!-----------------------------------------------------------------------
!***  ALLOCATE THE ATM COMPONENT'S INTERNAL STATE.
!-----------------------------------------------------------------------
!
      IF (CORE=='nmm') THEN
      ALLOCATE(ATM_INT_STATE,stat=RC)
!
      wrap%ATM_INT_STATE=>ATM_INT_STATE
!
!-----------------------------------------------------------------------
!***  ATTACH THE ATM INTERNAL STATE TO THE ATM GRIDDED COMPONENT.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Attach ATM Internal State to Gridded Component"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_GridCompSetInternalState(ATM_GRID_COMP                  &  !<-- The ATM gridded component
                                        ,WRAP                           &  !<-- Pointer to the ATM internal state
                                        ,RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------------------------------------------------
!***  RETRIEVE THE VM (VIRTUAL MACHINE) OF THE ATM GRIDDED COMPONENT.
!***  CALL ESMF_GridCompGet TO RETRIEVE THE VM ANYWHERE YOU NEED IT.
!***  WE NEED VM NOW TO OBTAIN THE MPI TASK IDs.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Retrieve VM from ATM Gridded Component"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_GridCompGet(gridcomp=ATM_GRID_COMP                      &  !<-- The ATM gridded component
                           ,vm      =VM                                 &  !<-- Get the Virtual Machine from the ATM component
                           ,rc      =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      ENDIF
!-----------------------------------------------------------------------
      IF (CORE=='nmm') THEN
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Obtain MPI Task IDs from VM"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_VMGet(vm      =VM                                       &  !<-- The virtual machine
                     ,localpet=MYPE                                     &  !<-- Each MPI task ID
                     ,rc      =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!-----------------------------------------------------------------------
!***  WILL THE WRITE COMPONENTS WITH ASYNCHRONOUS QUILTING BE USED?
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Extract Quilting Flag from Config File"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_ConfigGetAttribute(config=CF                            &  !<-- The config object
                                  ,value =QUILTING                      &  !<-- The variable filled (flag
                                  ,label ='quilting:'                   &  !<-- Give this label's value to the previous variable
                                  ,rc    =RC)
!
      atm_int_state%QUILTING=QUILTING                                      !<-- Save this for the ATM's Run step
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------------------------------------------------
!***  EXTRACT FUNDAMENTAL TIMESTEP INFORMATION FROM THE CONFIG FILE.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Extract Timestep Information from Config File"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ESMF_ConfigGetAttribute(config=CF                            &  !<-- The config object
                                  ,value =TIMESTEP_SEC_WHOLE            &  !<-- The variable filled (integer part of timestep (sec))
                                  ,label ='dt_int:'                     &  !<-- Give this label's value to the previous variable
                                  ,rc    =RC)
!
      CALL ESMF_ConfigGetAttribute(config=CF                            &  !<-- The config object
                                  ,value =TIMESTEP_SEC_NUMERATOR        &  !<-- The variable filled (numerator of timestep fraction)
                                  ,label ='dt_num:'                     &  !<-- Give this label's value to the previous variable
                                  ,rc    =RC)
!
      CALL ESMF_ConfigGetAttribute(config=CF                            &  !<-- The config object
                                  ,value =TIMESTEP_SEC_DENOMINATOR      &  !<-- The variable filled (denominator of timestep fraction)
                                  ,label ='dt_den:'                     &  !<-- Give this label's value to the previous variable
                                  ,rc    =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------------------------------------------------
!***  ESTABLISH THE TIMESTEP.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Set up Time Step Interval"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_TimeIntervalSet(timeinterval=TIMESTEP                   &  !<-- The model's fundamental timestep (sec) (ESMF)
                               ,s           =TIMESTEP_SEC_WHOLE         &
                               ,sn          =TIMESTEP_SEC_NUMERATOR     &
                               ,sd          =TIMESTEP_SEC_DENOMINATOR   &
                               ,rc          =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      DT=TIMESTEP_SEC_WHOLE+                                            &  !<-- The model's fundamental timestep (sec) (REAL)
         REAL(TIMESTEP_SEC_NUMERATOR)/REAL(TIMESTEP_SEC_DENOMINATOR)
!
!-----------------------------------------------------------------------
!***  OBTAIN THE FORECAST START/END TIMES FROM THE MAIN CLOCK.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Start Time and Fcst Duration from Main Clock"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_ClockGet(clock      =CLOCK_MAIN                         &  !<-- The Main ESMF Clock
                        ,startTime  =STARTTIME                          &  !<-- The simulation start time
                        ,runDuration=RUNDURATION                        &  !<-- The simulation run duration
                        ,rc         =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CURRTIME=STARTTIME                                                   !<-- Set the current forecast time
!
!-----------------------------------------------------------------------
!***  WITH DATA FROM ABOVE, CREATE THE LOCAL ESMF CLOCK
!***  TO CONTROL THE TIMESTEPPING IN THE ATM COMPONENT.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Create the Local Clock for the ATM Component"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CLOCK_ATM=ESMF_ClockCreate(name       ='CLOCK_ATM'                &  !<-- The ATM Clock's name
                                ,timestep   =TIMESTEP                   &  !<-- The fundamental timestep in this component
                                ,starttime  =STARTTIME                  &  !<-- Start time of simulation
                                ,runduration=RUNDURATION                &  !<-- Duration of simulation
                                ,rc         =RC)
!
      CALL ESMF_ClockSet(clock   =CLOCK_ATM                             &  !<-- The ATM Component's Clock
                        ,currtime=CURRTIME                              &  !<-- Current time of simulation
                        ,rc      =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------------------------------------------------
!***  GET THE HISTORY OUTPUT INTERVAL (HOURS) FROM THE CONFIG FILE.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Obtain History Interval from the Config File"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_ConfigGetAttribute(config=CF                            &  !<-- The configure object
                                  ,value =NHOURS_HISTORY                &  !<-- Fill this variable
                                  ,label ='nhours_history:'             &  !<-- Give the variable this label's value from the config file
                                  ,rc    =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------------------------------------------------
!***  CREATE THE HISTORY FILE OUTPUT ALARM.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Create the History Output Alarm"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_TimeIntervalSet(timeinterval=TIMEINTERVAL_HISTORY           &  !<-- Time interval between
                               ,h           =NHOURS_HISTORY                 &  !<-- Hours between history
                               ,rc          =RC)
!
      ALARM_HISTORY=ESMF_AlarmCreate(name             ='ALARM_HISTORY'      &
                                    ,clock            =CLOCK_ATM            &  !<-- ATM Clock
                                    ,ringTime         =STARTTIME            &  !<-- Forecast start time (ESMF)
                                    ,ringInterval     =TIMEINTERVAL_HISTORY &  !<-- Time interval between
                                    ,ringTimeStepCount=1                    &  !<-- The Alarm rings for this many timesteps
                                    ,sticky           =.false.              &  !<-- Alarm does not ring until turned off
                                    ,rc               =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------------------------------------------------
!***  GET THE RESTART OUTPUT INTERVAL (HOURS) FROM THE CONFIG FILE.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Obtain Restart Interval from the Config File"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_ConfigGetAttribute(config=CF                            &  !<-- The configure object
                                  ,value =NHOURS_RESTART                &  !<-- Fill this variable
                                  ,label ='nhours_restart:'             &  !<-- Give the variable this label's value from the config file
                                  ,rc    =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------------------------------------------------
!***  CREATE THE RESTART FILE OUTPUT ALARM.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Create the Restart Output Alarm"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_TimeIntervalSet(timeinterval=TIMEINTERVAL_RESTART           &  !<-- Time interval between restart writes (h) (ESMF)
                               ,h           =NHOURS_RESTART                 &  !<-- Hours between restart writes (REAL)
                               ,rc          =RC)
!
      ALARM_RESTART=ESMF_AlarmCreate(name             ='ALARM_RESTART'      &
                                    ,clock            =CLOCK_ATM            &  !<-- ATM Clock
                                    ,ringTime         =STARTTIME            &  !<-- Forecast start time (ESMF)
                                    ,ringInterval     =TIMEINTERVAL_RESTART &  !<-- Time interval between restart output (ESMF)
                                    ,ringTimeStepCount=1                    &  !<-- The Alarm rings for this many timesteps
                                    ,sticky           =.false.              &  !<-- Alarm does not ring until turned off
                                    ,rc               =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------------------------------------------------
!***  CREATE THE ALARM FOR PRINTING CLOCKTIMES USED BY MODEL PIECES.
!***  READ IN FORECAST TIME INTERVAL FOR CLOCKTIME OUTPUT AS WELL AS
!***  THE SELECTED TASK ID THAT WILL PROVIDE THE CLOCKTIMES.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Read Fcst Interval for Clocktime Output"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_ConfigGetAttribute(config=CF                            &  !<-- The configure object
                                  ,value =NHOURS_CLOCKTIME              &  !<-- Fill this variable
                                  ,label ='nhours_clocktime:'           &  !<-- Give the variable this label's value from the config file
                                  ,rc    =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
       
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Read MPI Task ID That Provides Clocktime Output"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_ConfigGetAttribute(config=CF                            &  !<-- The configure object
                                  ,value =NPE_PRINT                     &  !<-- Fill this variable
                                  ,label ='npe_print:'                  &  !<-- Give the variable this label's value from the config file
                                  ,rc    =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Create ESMF Clocktime Output Interval"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_TimeIntervalSet(timeinterval=TIMEINTERVAL_CLOCKTIME         &  !<-- Time interval between
                               ,h           =NHOURS_CLOCKTIME               &  !<-- Hours between clocktime writes (REAL)
                               ,rc          =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Create the Clocktime Output Alarm"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      ALARM_CLOCKTIME=ESMF_AlarmCreate(name             ='ALARM_CLOCKTIME'      &
                                    ,clock              =CLOCK_ATM              &  !<-- ATM Clock
                                    ,ringTime           =STARTTIME              &  !<-- Forecast start time (ESMF)
                                    ,ringInterval       =TIMEINTERVAL_CLOCKTIME &  !<-- Time interval between clocktime prints (ESMF)
                                    ,ringTimeStepCount  =1                      &  !<-- The Alarm rings for this many timesteps
                                    ,sticky             =.false.                &  !<-- Alarm does not ring until turned off
                                    ,rc                 =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      ENDIF

      
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!***  MODEL-SPECIFIC ROUTINES MUST BE INVOKED IN ORDER TO ESTABLISH
!***  THE ESMF Grid.  THE DIFFERENT INTEGRATION GRIDS NECESSITATE
!***  DIFFERENT WAYS OF SETTING UP BOTH THE PARALLELISM FOR
!***  DISTRIBUTED MEMORY RUNS AND THE ESMF Grid ITSELF.
!***  WHEN THE PARALLELISM IS CONSTRUCTED, THE LOCAL DOMAIN LIMITS
!***  NEED TO BE INSERTED INTO THE ATM COMPONENT'S INTERNAL STATE
!***  IF QUILTING IS TO BE USED.  SEE 'IF(QUILTING)THEN' BELOW.
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
      IF(CORE=='nmm')THEN
        CALL NMM_SETUP(ATM_GRID_COMP,ATM_INT_STATE,GRID_ATM)
!-----------------------------------------------------------------------
!***  ATTACH THE CORE-SPECIFIC ESMF GRID TO THE ATM GRIDDED COMPONENT.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Attach the ESMF Grid to the ATM Component"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_GridCompSet(gridcomp=ATM_GRID_COMP                      & !<-- The ATM gridded component
                           ,grid    =GRID_ATM                           & !<-- Attach the ESMF grid to the ATM component
                           ,rc      =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
!-----------------------------------------------------------------------

      ELSE IF (CORE=='gfs') THEN
        CALL GFS_SETUP(ATM_GRID_COMP,grid_atmos)
      ENDIF
!
!-----------------------------------------------------------------------
!
!
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!***  CREATE THE DYNAMICS GRIDDED SUBCOMPONENT.
!***  REGISTER THE INITIALIZE, RUN, AND FINALIZE STEPS FOR IT.
!***  SINCE THERE IS ONLY A SINGLE INTEGRATION GRID, GIVE THE
!***  DYNAMICS THE ATM COMPONENT'S GRID.
!***  NOTE THAT THIS SUBCOMPONENT IS PART OF THE ATM COMPONENT'S
!***  INTERNAL STATE.  THIS WILL BE CONVENIENT IF WE NEED TO REACH
!***  THE Dynamics COMPONENT VIA THE ATM COMPONENT SUCH AS HAPPENS
!***  WHEN WRITE COMPONENTS ARE ESTABLISHED.
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!
!-------------------------------
!***  Create Dynamics component
!-------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Create the Dynamics Component"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      IF (CORE=='nmm') THEN
      atm_int_state%DYN_GRID_COMP=ESMF_GridCompCreate(                  &
                                  name      ="Dynamics component"       &  !<-- Name of the new Dynamics gridded component
                                 ,configFile='configure_file'           &  !<-- Attach this configure file to the component
                                 ,petList   =atm_int_state%PETLIST_FCST &  !<-- The forecast task IDs
                                 ,rc        =RC)
      ELSE IF (CORE=='gfs') THEN
      gc_gfs_dyn=esmf_gridcompcreate( name      ="dynamics component"   &
                                     ,configFile='dyn_namelist.rc'      &
                                     ,rc        =RC)
      ENDIF

!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!------------------------------------------------
!***  Register the Init, Run, and Finalize steps
!------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Register Dynamics Init, Run, Finalize"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
       
      IF (CORE=='nmm') THEN
      CALL ESMF_GridCompSetServices(atm_int_state%DYN_GRID_COMP         &  ! <-- The Dynamics gridded component
                                   ,DYN_REGISTER                        &  ! <-- The user's subroutineName for Register
                                   ,RC)
      ELSE IF (CORE=='gfs') THEN
      call esmf_gridcompsetservices(gc_gfs_dyn                   &
                                   ,gfs_dyn_setservices             &
                                   ,RC)
      ENDIF

!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!----------------------------------------------------
!***  Attach the ESMF Grid to the Dynamics component
!----------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Attach ESMF Grid to the Dynamics Component"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      
      IF (CORE=='nmm') THEN
      GRID_DYN=GRID_ATM
      CALL ESMF_GridCompSet(gridcomp=atm_int_state%DYN_GRID_COMP        &  !<-- The Dynamics component
                           ,grid    =GRID_DYN                           &  !<-- The Dynamics ESMF grid
                           ,rc      =RC)
      ENDIF
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------------------------------------------------
!***  Create empty Import and Export states for the Dynamics component
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Create Empty Import/Export States for Dynamics"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      IF (CORE=='nmm') THEN
      atm_int_state%IMP_STATE_DYN=ESMF_StateCreate(stateName="Dynamics Import" &  !<-- The Dynamics import state name
                                                  ,statetype=ESMF_STATE_IMPORT &
                                                  ,rc       =RC)
!
      atm_int_state%EXP_STATE_DYN=ESMF_StateCreate(stateName="Dynamics Export" &  !<-- The Dynamics export state name
                                                  ,statetype=ESMF_STATE_EXPORT &
                                                  ,rc       =RC)
      ELSE IF (CORE=='gfs') THEN
      imp_gfs_dyn=esmf_statecreate(statename="dynamics import"        &
                                    ,statetype=esmf_state_import      &
                                    ,rc       =RC)
!
      exp_gfs_dyn=esmf_statecreate(statename="dynamics export"        &
                                    ,statetype=esmf_state_export      &
                                    ,rc       =RC)
      ENDIF
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!---------------------------------------------------------
!***  CHECK CONDITION TO RUN ADIABATIC CASE (NO PHYSICS) 
!---------------------------------------------------------
!
      call ESMF_ConfigGetAttribute(       CF                            &
                                  ,value =MODE                          &
                                  ,label ='adiabatic:'                  &
                                  ,rc    =rc)
      IF (CORE=='nmm') THEN
      if(trim(mode)=='true')then
        PHYSICS_ON=.false.
        print *,' initialize without physics coupling '
      else
        PHYSICS_ON=.true.
        print *,' initialize with physics coupling '
      endif
      ELSE IF (CORE=='gfs') THEN
      if(trim(mode)=='.true.')then
        PHYSICS_ON=.false.
        print *,' initialize without physics coupling '
      else
        PHYSICS_ON=.true.
        print *,' initialize with physics coupling '
      endif
      ENDIF
!
      IF (PHYSICS_ON) THEN
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!***  CREATE THE PHYSICS GRIDDED SUBCOMPONENT.
!***  REGISTER THE INITIALIZE, RUN, AND FINALIZE STEPS FOR IT.
!***  SINCE THERE IS ONLY A SINGLE INTEGRATION GRID, GIVE THE
!***  PHYSICS THE ATM COMPONENT'S GRID.
!***  NOTE THAT THIS SUBCOMPONENT IS PART OF THE ATM COMPONENT'S
!***  INTERNAL STATE.  THIS WILL BE CONVENIENT IF WE NEED TO REACH
!***  THE Physics COMPONENT VIA THE ATM COMPONENT SUCH AS HAPPENS
!***  WHEN WRITE COMPONENTS ARE ESTABLISHED.
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!
!-------------------------------
!***  Create Physics component
!-------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Create the Physics Component"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      IF (CORE=='nmm') THEN
      atm_int_state%PHY_GRID_COMP=ESMF_GridCompCreate(                  &
                                  name      ="Physics component"        &  !<-- Name of the new Physics gridded component
                                 ,configFile='configure_file'           &  !<-- Attach this configure file to the component
                                 ,petList   =atm_int_state%PETLIST_FCST &  !<-- The forecast task IDs
                                 ,rc        =RC)
      ELSE IF (CORE=='gfs') THEN
      gc_gfs_phy=esmf_gridcompcreate( name      ="physics component"    &
                                     ,configfile='phy_namelist.rc'      &
                                     ,rc        =rc)
      ENDIF
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!------------------------------------------------
!***  Register the Init, Run, and Finalize steps
!------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Register Physics Init, Run, Finalize"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      IF (CORE=='nmm') THEN
      CALL ESMF_GridCompSetServices(atm_int_state%PHY_GRID_COMP         &  ! <-- The Physics gridded component
                                   ,PHY_REGISTER                        &  ! <-- The user's subroutineName
                                   ,RC)
      ELSE IF (CORE=='gfs') THEN
      call esmf_gridcompsetservices(gc_gfs_phy                   &
                                   ,gfs_phy_setservices             &
                                   ,rc)
      ENDIF
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------------------
!***  Attach the ESMF Grid to the Physics
!-----------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Attach the ESMF Grid to the Physics Component"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      IF (CORE=='nmm') THEN
      GRID_PHY=GRID_ATM
      CALL ESMF_GridCompSet(gridcomp=atm_int_state%PHY_GRID_COMP        &  !<-- The Physics component
                           ,grid    =GRID_PHY                           &  !<-- The Physics ESMF grid
                           ,rc      =RC)
!      ELSE IF (CORE=='gfs') THEN
!      grid_gfs_phy=grid_atmos
!      call esmf_gridcompset(gridcomp= gc_gfs_phy                         &
!                            ,grid    =grid_gfs_phy                       &
!                            ,rc	     =RC)
      ENDIF

!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      ENDIF !PHYSICS_ON
!
!------------------------------------------------------------------------
!***  Create empty Import and Export states for the Physics subcomponent
!------------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Create Empty Import/Export States for Physics"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      IF (CORE=='nmm') THEN
      atm_int_state%IMP_STATE_PHY=ESMF_StateCreate(stateName="Physics Import"  &  !<-- The Physics import
                                                  ,statetype=ESMF_STATE_IMPORT &
                                                  ,rc       =RC)
!
 
      atm_int_state%EXP_STATE_PHY=ESMF_StateCreate(stateName="Physics Export"  &  !<-- The Physics export
                                                  ,statetype=ESMF_STATE_EXPORT &
                                                  ,rc       =RC)
      
      ELSE IF (CORE=='gfs') THEN
      imp_gfs_phy=esmf_statecreate(statename="physics import"         &
                                    ,statetype=esmf_state_import      &
                                    ,rc       =rc)
!
      exp_gfs_phy=esmf_statecreate(statename="physics export"         &
                                    ,statetype=esmf_state_export      &
                                    ,rc       =rc)
      ENDIF
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!***  CREATE THE DYNAMICS-PHYSICS COUPLER SUBCOMPONENT.
!***  REGISTER THE INITIALIZE, RUN, AND FINALIZE STEPS FOR IT.
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!
!----------------------------
!***  Create Dyn-Phy Coupler
!----------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Create the Dynamics-Physics Coupler Component"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      IF (CORE=='nmm') THEN
      atm_int_state%COUPLER_DYN_PHY_COMP=ESMF_CplCompCreate                   &
                                         (name   ="Dyn-Phy coupler component" &
                                         ,petList=atm_int_state%PETLIST_FCST  &  !<-- The forecast task IDs
                                         ,rc     =RC)
      ELSE IF (CORE=='gfs') THEN
      gc_atm_cpl=esmf_cplcompcreate(name="coupler component"            &
                                     ,rc  =RC)
      ENDIF

!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!------------------------------------------------
!***  Register the Init, Run, and Finalize steps
!------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Register the Dyn-Phy Coupler's Init, Run, Finalize"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      IF (CORE=='nmm') THEN
      CALL ESMF_CplCompSetServices(atm_int_state%COUPLER_DYN_PHY_COMP   &  ! <-- The Dyn-Phy coupler component
                                  ,DYN_PHY_CPL_REGISTER                 &  ! <-- The user's subroutineName
                                  ,RC)
      ELSE IF (CORE=='gfs') THEN
      call esmf_cplcompsetservices(gc_atm_cpl                &
                                  ,atm_cpl_setservices              &
                                  ,RC)
      ENDIF

!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!***  IF QUILTING WAS SELECTED FOR THE GENERATION OF OUTPUT,
!***  SETUP THE WRITE COMPONENT(S).
!***  THIS MUST BE DONE PRIOR TO EXECUTING THE INITIALIZE STEPS
!***  OF THE DYNAMICS AND PHYSICS COMPONENTS BECAUSE THE WRITE
!***  COMPONENTS' IMPORT STATES ARE REQUIRED BY THOSE STEPS
!***  WHEN 'quilting' IS ACTIVE AND WRITE_SETUP IS THE ROUTINE
!***  IN WHICH THE WRITE COMPONENTS' IMPORT STATES ARE INSERTED
!***  INTO THE DYNAMICS AND PHYSICS EXPORT STATES WHICH ARE
!***  IN TURN PART OF THE ATM INTERNAL STATE.
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
      IF (CORE=='nmm') THEN
      IF(QUILTING)THEN
        CALL WRITE_SETUP(ATM_GRID_COMP,ATM_INT_STATE,CLOCK_ATM)
      ENDIF
      ENDIF
      
!
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!***  EXECUTE THE INITIALIZE STEPS FOR THE GRIDDED SUBCOMPONENTS.
!***  THESE ARE THE INITIALIZE SUBROUTINES SPECIFIED IN THE
!***  REGISTER ROUTINES CALLED IN ESMF_GridCompSetServices ABOVE.
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!
!--------------
!***  DYNAMICS
!--------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Initialize Dynamics Component"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      IF (CORE=='nmm') THEN
      CALL ESMF_GridCompInitialize(gridcomp   =atm_int_state%DYN_GRID_COMP  &  !<-- The dynamics gridded component
                                  ,importState=atm_int_state%IMP_STATE_DYN  &  !<-- The dynamics import state
                                  ,exportState=atm_int_state%EXP_STATE_DYN  &  !<-- The dynamics export state
                                  ,clock      =CLOCK_ATM                    &  !<-- The ATM clock
                                  ,phase      =ESMF_SINGLEPHASE             &
                                  ,rc         =RC)
      ELSE IF (CORE=='gfs') THEN
      call ESMF_GridCompInitialize(gridcomp   =gc_gfs_dyn            &
                                  ,importstate=imp_gfs_dyn           &
                                  ,exportstate=exp_gfs_dyn           &
                                  ,clock      =CLOCK_MAIN            &
                                  ,phase      =esmf_singlephase      &
                                  ,rc         =RC)
      grid_gfs_dyn=grid_atmos
      call esmf_gridcompset(         gc_gfs_dyn      &
                           ,grid    =grid_gfs_dyn    &
                           ,rc      =rc)
      ENDIF
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      IF (PHYSICS_ON) THEN
!-------------
!***  PHYSICS
!-------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Initialize Physics Component"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      IF (CORE=='nmm') THEN
      CALL ESMF_GridCompInitialize(gridcomp   =atm_int_state%PHY_GRID_COMP  &  !<-- The physics gridded component
                                  ,importState=atm_int_state%IMP_STATE_PHY  &  !<-- The physics import state
                                  ,exportState=atm_int_state%EXP_STATE_PHY  &  !<-- The physics export state
                                  ,clock      =CLOCK_ATM                    &  !<-- The ATM clock
                                  ,phase      =ESMF_SINGLEPHASE             &
                                  ,rc         =RC)
      ELSE IF (CORE=='gfs') THEN
      call esmf_gridcompinitialize(gridcomp   =gc_gfs_phy            &
                                  ,importstate=imp_gfs_phy           &
                                  ,exportstate=exp_gfs_phy           &
                                  ,clock      =CLOCK_MAIN            &
                                  ,phase      =esmf_singlephase      &
                                  ,rc         =RC)
      grid_gfs_phy=grid_atmos
      call esmf_gridcompset(         gc_gfs_phy      &
                           ,grid    =grid_gfs_phy    &
                           ,rc      =RC)

      ENDIF

!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      ENDIF !PHYSICS_ON
!
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!***  INITIALIZE THE DYN-PHY COUPLER SUBCOMPONENT.
!***  THE CHOICE OF IMPORT AND EXPORT STATE DOES NOT MATTER
!***  FOR THE INITIALIZE STEP.
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Initialize Dyn-Phy Coupler"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      IF (CORE=='nmm') THEN
      CALL ESMF_CplCompInitialize(cplcomp    =atm_int_state%COUPLER_DYN_PHY_COMP &  !<-- The dyn_phy coupler component
                                 ,importState=atm_int_state%EXP_STATE_DYN        &  !<-- The dyn-phy coupler import state
                                 ,exportState=atm_int_state%IMP_STATE_PHY        &  !<-- The dyn-phy coupler export state
                                 ,clock      =CLOCK_ATM                          &  !<-- The ATM Clock
                                 ,rc         =RC)
      ELSE If (CORE=='gfs') THEN
      call esmf_cplcompinitialize(cplcomp    =gc_atm_cpl              &
                                 ,importstate=exp_gfs_dyn             &
                                 ,exportstate=imp_gfs_phy             &
                                 ,clock      =CLOCK_MAIN              &
                                 ,rc         =RC)
      ENDIF
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_INIT)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------------------------------------------------
!***  IF QUILTING WAS SELECTED FOR THE GENERATION OF OUTPUT,
!***  EXECUTE THE INITIALIZE STEP OF THE WRITE COMPONENT(S).
!***  THIS MUST BE DONE AFTER THE INITIALIZATION OF THE
!***  DYNAMICS AND PHYSICS COMPONENTS BECAUSE THOSE COMPONENTS'
!***  INTERNAL STATES CONTAIN THE HISTORY OUTPUT VARIABLES.
!***  POINTERS TO THOSE VARIABLES ARE SET DURING THEIR INITIALIZE
!***  STEPS AND ARE THEN LOADED INTO THE WRITE COMPONENTS'
!***  IMPORT STATES WHICH THEMSELVES RESIDE IN THE DYNAMICS/PHYSICS
!***  EXPORT STATES.
!-----------------------------------------------------------------------
!
      IF (CORE=='nmm') THEN
      IF(QUILTING)THEN
        CALL WRITE_INIT(ATM_GRID_COMP,ATM_INT_STATE,CLOCK_ATM)
      ENDIF
      ENDIF
!
!-----------------------------------------------------------------------
!***  WRITE THE FINAL ERROR SIGNAL.
!-----------------------------------------------------------------------
!
      IF(RC_INIT==ESMF_SUCCESS)THEN
!       WRITE(0,*)'ATM INITIALIZE STEP SUCCEEDED'
      ELSE
        WRITE(0,*)'ATM INITIALIZE STEP FAILED RC_INIT=',RC_INIT
      ENDIF
!
!-----------------------------------------------------------------------
!
      total_tim=timef()-btim0
!
      if(mype==0)write(0,*)' atm_init_tim=',total_tim*1.e-3
!
!-----------------------------------------------------------------------
!
      END SUBROUTINE ATM_INITIALIZE
!-----------------------------------------------------------------------
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!-----------------------------------------------------------------------
!
      SUBROUTINE ATM_RUN(ATM_GRID_COMP                                  &
                        ,IMP_STATE,EXP_STATE                            &
                        ,CLOCK_MAIN                                     &
                        ,RC_RUN)
!
!-----------------------------------------------------------------------
!***  RUN THE ATM (Atmosphere) GRIDDED COMPONENT.
!-----------------------------------------------------------------------
      USE MODULE_DIGITAL_FILTER_NMM
      USE MODULE_DIGITAL_FILTER_GFS 
      USE MODULE_FWD_INTEGRATE

!
      TYPE(ESMF_GridComp),INTENT(INOUT) :: ATM_GRID_COMP                   !<-- The ATM gridded component
      TYPE(ESMF_State),   INTENT(IN)    :: IMP_STATE                       !<-- The ATM Run step's import
      TYPE(ESMF_State),   INTENT(INOUT) :: EXP_STATE                       !<-- The ATM Run step's export
      TYPE(ESMF_Clock),   INTENT(INOUT) :: CLOCK_MAIN                      !<-- The main ESMF Clock
      INTEGER,OPTIONAL,   INTENT(OUT)   :: RC_RUN                          !<-- Return code for the Run step
!
!-----------------------------------------------------------------------
!***  LOCAL VARIABLES
!-----------------------------------------------------------------------
!
      TYPE(ESMF_Config)         :: CF  
      TYPE(WRAP_ATM_INTERNAL_STATE)    :: WRAP                             !<-- The F90 wrap of the ATM internal state
      TYPE(ATM_INTERNAL_STATE),POINTER :: ATM_INT_STATE                    !<-- The ATM internal state pointer
      TYPE(ESMF_Time)                  :: CURRTIME                         !<-- The current forecast time
      TYPE(ESMF_Time)                  :: STARTTIME                        !<-- The current forecast time
      TYPE(ESMF_Time)                  :: SDFITIME
      TYPE(ESMF_Time)                  :: DFITIME                          !<-- Digital filter time interval
      TYPE(ESMF_Time)                  :: HALFDFITIME                      !<-- Digital filter time interval
      TYPE(ESMF_TimeInterval)          :: HALFDFIINTVAL                    !<-- Digital filter time interval
      TYPE(ESMF_TimeInterval)          :: TIMESTEP                         !<-- Digital filter time interval
      TYPE(ESMF_Alarm), save           :: alarm(2)
!
      INTEGER(KIND=KINT)         :: RC,NUM_PES_FCST                        !<-- Error signal variable.
      INTEGER(KIND=KINT)         :: I,IER,J
      INTEGER(KIND=KINT)         :: YY,MM,DD,H,M,S,NDFISTEP
      INTEGER(KIND=KINT),SAVE    :: NTIMESTEP                              !<-- The current forecast timestep (INT)
      INTEGER(KIND=ESMF_KIND_I8) :: NTIMESTEP_ESMF                         !<-- The current forecast timestep (ESMF_INT)
      INTEGER(KIND=KINT),SAVE    :: DFIHR                                  !<-- Digital filter time interval
      CHARACTER(50)              :: MODE
      INTEGER(KIND=KINT)         :: NUM_TRACERS_MET,NUM_TRACERS_CHEM
      LOGICAL                    :: PHYSICS_ON
      
!
!-----------------------------------------------------------------------
!***********************************************************************
!-----------------------------------------------------------------------
!
      btim0=timef()
      DFIHR=0
!
!-----------------------------------------------------------------------
!***  RETRIEVE THE ATM COMPONENT'S INTERNAL STATE.
!-----------------------------------------------------------------------
!
!
      CALL ESMF_GridCompGet(gridcomp=ATM_GRID_COMP                      &  !<-- The ATM gridded component                     
                            ,config  =CF                                 &  !<-- The config object (~namelist)
                            ,rc      =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_RUN)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~

      CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_ConfigGetAttribute(config=CF                            &  !<-- The config object
                                  ,value =CORE                          &  !<-- The variable filled (dynamic core name)
                                  ,label ='core:'                       &  !<-- Give this label's value to the previous variable
                                  ,rc    =RC_RUN)
     CALL ESMF_ConfigGetAttribute(config=CF                            &  !<-- The config object
                                  ,value  =NUM_TRACERS_MET               &  !<-- The variable filled (number of meteorological tracers)
                                  ,label ='num_tracers_met:'           &  !<-- Give this label's value to the previous variable
                                  ,rc    =RC_RUN)
      CALL ESMF_ConfigGetAttribute(config=CF                            &  !<-- The config object
                                  ,value =NUM_TRACERS_CHEM              &  !<-- The variable filled (number of chemical tracers)
                                  ,label ='num_tracers_met:'            &  !<-- Give this label's value to the previous variable
                                  ,rc    =RC_RUN)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      IF (CORE=='nmm') THEN
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Retrieve ATM Component's Internal State"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_GridCompGetInternalState(ATM_GRID_COMP                  &  !<-- The ATM gridded component
                                        ,WRAP                           &  !<-- The F90 wrap of the ATM internal state
                                        ,RC)
!
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_RUN)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      ATM_INT_STATE=>wrap%ATM_INT_STATE
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------------------------------------------------
!***  RETRIEVE THE TIMESTEP FROM THE ATM CLOCK.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Retrieve Timestep from the ATM Clock"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_ClockGet(clock       =CLOCK_ATM                         &
                        ,advanceCount=NTIMESTEP_ESMF                    &  !<-- # of times the clock has advanced
                        ,rc          =RC)
!
      NTIMESTEP=NTIMESTEP_ESMF
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_RUN)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      ENDIF 
      
!-----------------------------------------------------------------------
!***  RETRIEVE THE VM FROM THE ATM GRIDDED COMPONENT.
!-----------------------------------------------------------------------
!
      IF (CORE=='nmm') THEN
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Retrieve VM from ATM Component"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_GridCompGet(gridcomp=ATM_GRID_COMP                      &  !<-- the ATM gridded component
                           ,vm      =VM                                 &
                           ,rc      =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_RUN)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      ELSE IF (CORE=='gfs') THEN
      MESSAGE_CHECK="Retrieve VM from ATM Component"
      call esmf_gridcompget(gridcomp=ATM_GRID_COMP                      &
                           ,vm      =VM                                 &
                           ,config  =CF                                 &
                           ,rc      =RC)
!
      call esmf_vmget(     vm       =VM                                 &
                           ,localpet=MYPE                               &
                     	   ,rc      =RC)
      ENDIF

!---------------------------------------------------------
!***  condition to run only adiabatic (dynamics only)
!---------------------------------------------------------
!
      CALL ESMF_ConfigGetAttribute(       CF                            &
                                  ,value =MODE                          &
                                  ,label ='adiabatic:'                  &
                                  ,rc    =RC)
!
      IF (CORE=='nmm') THEN
      if(trim(mode)=='true')then
        PHYSICS_ON=.false.
        print *,' run without physics coupling '
      else
        PHYSICS_ON=.true.
        print *,' run with physics coupling.'
      endif
      ELSE IF (CORE=='gfs') THEN
      if(trim(mode)=='.true.')then
        PHYSICS_ON=.false.
        print *,' run without physics coupling.'
      else
        PHYSICS_ON=.true.
        print *,' run with physics coupling.'
      endif
      ENDIF

!
!
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_ConfigGetAttribute(config=CF                            &  !<-- The config object
                                  ,value =DFIHR                         &
                                  ,label ='nhours_dfini:'               &  !<-- Give this label's value to the previous variable
                                  ,rc    =RC)
!
! ------------------------------------------------------------------
!
           IF (DFIHR .GT. 0) THEN
           

! -------------------- initial stage -------------------------------
!
           CALL ESMF_TimeIntervalSet(HALFDFIINTVAL                      &
                                 ,h=DFIHR,rc=RC)
           IF (CORE=='nmm') THEN
           CALL ESMF_ClockGet(clock =CLOCK_ATM                          &
                          ,starttime =STARTTIME                         &
                          ,timestep =TIMESTEP                           &
                          ,rc =RC)
           ELSE IF (CORE=='gfs') THEN
           CALL ESMF_ClockGet(clock =CLOCK_MAIN                          &
                          ,starttime =STARTTIME                         &
                          ,timestep =TIMESTEP                           &
                          ,rc =RC)
           ENDIF
           NDFISTEP = HALFDFIINTVAL / TIMESTEP
           print *,'NDFISTEP=',NDFISTEP
           HALFDFITIME = STARTTIME + HALFDFIINTVAL
           SDFITIME = STARTTIME + HALFDFIINTVAL/NDFISTEP
           DFITIME = HALFDFITIME + HALFDFIINTVAL
           IF (CORE=='nmm') THEN
           alarm(1) = ESMF_AlarmCreate("Half of digital filter", CLOCK_ATM, &
                                  ringTime=HALFDFITIME,                 &
                                  ringTimeStepCount=1, sticky=.false.,  rc=RC)
           alarm(2) = ESMF_AlarmCreate("Fulldigital filter", CLOCK_ATM,     &
                                  ringTime=DFITIME,                     &
                                  ringTimeStepCount=1, sticky=.false.,  rc=RC)
           ELSE IF (CORE=='gfs') THEN
           alarm(1) = ESMF_AlarmCreate("Half of digital filter", CLOCK_MAIN, &
                                  ringTime=HALFDFITIME,                 &
                                  ringTimeStepCount=1, sticky=.false.,  rc=RC)
           alarm(2) = ESMF_AlarmCreate("Fulldigital filter", CLOCK_MAIN,     &
                                  ringTime=DFITIME,                     &
                                  ringTimeStepCount=1, sticky=.false.,  rc=RC)
           ENDIF
           ENDIF
!
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!***  THE INTEGRATION TIME LOOP OF THE ATMOSPHERE.
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!
      total_tim=total_tim+timef()-btim0
      
      IF (CORE=='nmm') THEN
           CALL NMM_FWD_INTEGRATE(ATM_GRID_COMP                         &
                                 ,ATM_INT_STATE                         &
                                 ,CLOCK_ATM                             &
                                 ,CURRTIME                              &
                                 ,HALFDFITIME                           &
                                 ,SDFITIME                              &
                                 ,DFITIME                               &
                                 ,STARTTIME                             &
                                 ,ALARM_CLOCKTIME                       &
                                 ,ALARM                                 &
                                 ,ALARM_HISTORY                         &
                                 ,ALARM_RESTART                         &
                                 ,MYPE                                  &
                                 ,NUM_TRACERS_MET                       &
                                 ,NUM_TRACERS_CHEM                      &
                                 ,NTIMESTEP                             &
                                 ,NDFISTEP                              &
                                 ,NPE_PRINT                             &
                                 ,DFIHR                                 &
                                 ,PHYSICS_ON)


      ELSE IF (CORE=='gfs') THEN
           CALL GFS_FWD_INTEGRATE(gc_gfs_dyn,gc_gfs_phy,gc_atm_cpl,imp_gfs_dyn,exp_gfs_dyn &
                                   ,imp_gfs_phy,exp_gfs_phy,CLOCK_ATM,ALARM,ALARM_HISTORY,CURRTIME,HALFDFITIME &
                                   ,SDFITIME,DFITIME,STARTTIME,NDFISTEP,DFIHR,MYPE,PHYSICS_ON)
      ENDIF






      CALL ESMF_ClockPrint(   clock=CLOCK_MAIN                      &
                              ,options="stoptime string"            &
                              ,rc=rc)


!
!-----------------------------------------------------------------------
!
      END SUBROUTINE ATM_RUN
!
!-----------------------------------------------------------------------
!***********************************************************************
!-----------------------------------------------------------------------
!
      SUBROUTINE ATM_FINALIZE(ATM_GRID_COMP                             &
                             ,IMP_STATE,EXP_STATE                       &
                             ,CLOCK_MAIN                                &
                             ,RC_FINALIZE)
!
!-----------------------------------------------------------------------
!***  THIS ROUTINE FINALIZES THE ATM GRIDDED COMPONENT.
!-----------------------------------------------------------------------
!
      TYPE(ESMF_GridComp),INTENT(INOUT) :: ATM_GRID_COMP                   !<-- The ATM gridded component
      TYPE(ESMF_State),   INTENT(INOUT) :: IMP_STATE                       !<-- The ATM finalize step's import state
      TYPE(ESMF_State),   INTENT(INOUT) :: EXP_STATE                       !<-- The ATM finalize step's export state
      TYPE(ESMF_Clock),   INTENT(INOUT) :: CLOCK_MAIN                      !<-- The main ESMF Clock
      TYPE(ESMF_Config)                 :: CF                               !<-- The config object
      INTEGER,OPTIONAL,   INTENT(OUT)   :: RC_FINALIZE                     !<-- Return code for the Finalize step
!
!-----------------------------------------------------------------------
!***  LOCAL VARIABLES
!-----------------------------------------------------------------------
!
      TYPE(WRAP_ATM_INTERNAL_STATE)    :: WRAP                             !<-- The F90 wrap of the ATM internal state
      TYPE(ATM_INTERNAL_STATE),POINTER :: ATM_INT_STATE                    !<-- The ATM internal state pointer
!
      INTEGER :: I,J
      INTEGER :: RC,RC_FINAL                                                ! The final error signal variables.
      CHARACTER(50):: MODE
      LOGICAL    :: PHYSICS_ON     

!
!-----------------------------------------------------------------------
!***********************************************************************
!-----------------------------------------------------------------------
!
      RC         =ESMF_SUCCESS
      RC_FINAL   =ESMF_SUCCESS
      RC_FINALIZE=ESMF_SUCCESS
!-----------------------------------------------------------------------
!***  RETRIEVE THE CONFIG OBJECT CF FROM THE ATM GRIDDED COMPONENT.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Retrieve Config Object from ATM Component"
      CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_GridCompGet(gridcomp=ATM_GRID_COMP                      &  !<-- The ATM gridded component
                           ,config  =CF                                 &  !<-- The config object (~namelist)
                           ,rc      =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_FINAL)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Extract Dynamic Core Name"
      CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_ConfigGetAttribute(config=CF                            &  !<-- The config object
                                  ,value =CORE                          &  !<-- The variable filled (dynamic core name)
                                  ,label ='core:'                       &  !<-- Give this label's value to the previous variable
                                  ,rc    =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_FINAL)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!---------------------------------------------------------
!***  condition to run only adiabatic (dynamics only)
!---------------------------------------------------------
!
      CALL ESMF_ConfigGetAttribute(       CF                            &
                                  ,value =MODE                          &
                                  ,label ='adiabatic:'                  &
                                  ,rc    =RC)
!
      IF (CORE=='nmm') THEN
      if(trim(mode)=='true')then
        PHYSICS_ON=.false.
        print *,' finalize without physics coupling. '
      else
        PHYSICS_ON=.true.
        print *,' finalize with physics coupling. '
      endif
      ELSE IF (CORE=='gfs') THEN
      if(trim(mode)=='.true.')then
        PHYSICS_ON=.false.
        print *,' finalize without physics coupling. '
      else
        PHYSICS_ON=.true.
        print *,' finalize with physics coupling. '
      endif
      ENDIF


!-----------------------------------------------------------------------

!
!-----------------------------------------------------------------------
!***  RETRIEVE THE ATM GRIDDED COMPONENT'S INTERNAL STATE.
!-----------------------------------------------------------------------
!
      IF (CORE=='nmm') THEN
      CALL ESMF_GridCompGetInternalState(ATM_GRID_COMP                  &  !<-- The ATM gridded component
                                        ,WRAP                           &  !<-- The F90 wrap of the ATM internal state
                                        ,RC)
!
      ATM_INT_STATE=>wrap%ATM_INT_STATE
      
      ENDIF 
!
!-----------------------------------------------------------------------
!***  FINALIZE EACH OF THE SUBCOMPONENTS.
!-----------------------------------------------------------------------
!
!--------------
!***  DYNAMICS
!--------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Finalize Dynamics Component"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      IF (CORE=='nmm') THEN
      CALL ESMF_GridCompFinalize(gridcomp   =atm_int_state%DYN_GRID_COMP &
                                ,importState=atm_int_state%IMP_STATE_DYN &
                                ,exportState=atm_int_state%EXP_STATE_DYN &
                                ,clock      =CLOCK_ATM                   &
                                ,rc         =RC)
      ELSE IF (CORE=='gfs') THEN
      call esmf_gridcompfinalize(gridcomp   =gc_gfs_dyn                  &
                               ,importstate=imp_gfs_dyn                 &
                               ,exportstate=exp_gfs_dyn                 &
                               ,clock      =CLOCK_MAIN                  &
                               ,rc         =RC)
      ENDIF

!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!ratko    CALL ERR_MSG(RC,MESSAGE_CHECK,RC_FINAL)
! - FIX later
 RC=ESMF_SUCCESS
 RC_FINAL=ESMF_SUCCESS
!ratko
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      IF (PHYSICS_ON) THEN
!-------------
!***  PHYSICS
!-------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Finalize Physics Component"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      IF (CORE=='nmm') THEN
      CALL ESMF_GridCompFinalize(gridcomp   =atm_int_state%PHY_GRID_COMP &
                                ,importState=atm_int_state%IMP_STATE_PHY &
                                ,exportState=atm_int_state%EXP_STATE_PHY &
                                ,clock      =CLOCK_ATM                   &
                                ,rc         =RC)
      ELSE IF (CORE=='gfs') THEN
      call esmf_gridcompfinalize(gridcomp   =gc_gfs_phy                 &
                                ,importstate=imp_gfs_phy                &
                                ,exportstate=exp_gfs_phy                &
                                ,clock      =CLOCK_MAIN                 &
                                ,rc         =RC)
      ENDIF
      ENDIF !PHYSICS_ON
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!ratko    CALL ERR_MSG(RC,MESSAGE_CHECK,RC_FINAL)
! - FIX later
 RC=ESMF_SUCCESS
 RC_FINAL=ESMF_SUCCESS
!ratko
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------
!***  DYNAMICS-PHYSICS COUPLER
!-----------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Finalize Dynamics-Physics Coupler"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      IF (CORE=='nmm') THEN
      CALL ESMF_CplCompFinalize(cplcomp    =atm_int_state%COUPLER_DYN_PHY_COMP &
                               ,importState=atm_int_state%EXP_STATE_DYN        &
                               ,exportState=atm_int_state%IMP_STATE_PHY        &
                               ,clock      =CLOCK_ATM                          &
                               ,rc         =RC)
      ELSE IF (CORE=='gfs') THEN
      call esmf_cplcompfinalize(cplcomp    = gc_atm_cpl                  &
                               ,importstate=exp_gfs_dyn                 &
                               ,exportstate=imp_gfs_phy                 &
                               ,clock      =CLOCK_MAIN                  &
                               ,rc         =RC)
      ENDIF

!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_FINAL)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------------------------------------------------
!***  DESTROY ALL STATES.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Destroy States"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      IF (CORE=='nmm') THEN
      CALL ESMF_StateDestroy(state=atm_int_state%IMP_STATE_DYN          &
                            ,rc   =RC)
!
      CALL ESMF_StateDestroy(state=atm_int_state%EXP_STATE_DYN          &
                            ,rc   =RC)
!
      IF (PHYSICS_ON) THEN
      CALL ESMF_StateDestroy(state=atm_int_state%IMP_STATE_PHY          &
                            ,rc   =RC)
!
      CALL ESMF_StateDestroy(state=atm_int_state%EXP_STATE_PHY          &
                            ,rc   =RC)
      ENDIF
      ELSE IF (CORE=='gfs') THEN
      call esmf_statedestroy(state=imp_gfs_dyn, rc=RC)
      call esmf_statedestroy(state=exp_gfs_dyn, rc=RC)
      IF (PHYSICS_ON) THEN
      call esmf_statedestroy(state=imp_gfs_phy, rc=RC)
      call esmf_statedestroy(state=exp_gfs_phy, rc=RC)
      ENDIF
      ENDIF

!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_FINAL)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!***  IF QUILTING WAS SELECTED FOR THE GENERATION OF OUTPUT,
!***  FINALIZE AND DESTROY OBJECTS RELATED TO THE WRITE COMPONENTS.
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!
      IF (CORE=='nmm') THEN
      IF(atm_int_state%QUILTING)THEN
        CALL WRITE_DESTROY(ATM_GRID_COMP,ATM_INT_STATE,CLOCK_ATM)
      ENDIF
!
!-----------------------------------------------------------------------
!***  DESTROY THE ATM CLOCK.
!-----------------------------------------------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Destroy ATM Clock"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      CALL ESMF_ClockDestroy(clock=CLOCK_ATM                            &
                            ,rc   =RC)
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_FINAL)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
       ENDIF
!-----------------------------------------------------------------------
!***  DESTROY ALL SUBCOMPONENTS.
!-----------------------------------------------------------------------
!
!--------------
!***  DYNAMICS
!--------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Destroy Dynamics Component"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      IF (CORE=='nmm') THEN
      CALL ESMF_GridCompDestroy(gridcomp=atm_int_state%DYN_GRID_COMP      &
                               ,rc      =RC)
      ELSE 
      call esmf_gridcompdestroy(gridcomp=gc_gfs_dyn, rc=RC)
      ENDIF
    
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_FINAL)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      IF (PHYSICS_ON) THEN
!-------------
!***  PHYSICS
!-------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Destroy Physics Component"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      IF (CORE=='nmm') THEN
      CALL ESMF_GridCompDestroy(gridcomp=atm_int_state%PHY_GRID_COMP      &
                               ,rc      =RC)
      ELSE
      call esmf_gridcompdestroy(gridcomp=gc_gfs_phy, rc=RC)
      ENDIF

!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_FINAL)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      ENDIF
!------------------------------
!***  DYNAMICS-PHYSICS COUPLER
!------------------------------
!
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
      MESSAGE_CHECK="Destroy Dynamics-Physics Coupler"
!     CALL ESMF_LogWrite(MESSAGE_CHECK,ESMF_LOG_INFO,rc=RC)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
      IF (CORE=='nmm') THEN
      CALL ESMF_CplCompDestroy(cplcomp=atm_int_state%COUPLER_DYN_PHY_COMP &
                              ,rc     =RC)
      ELSE
      call esmf_cplcompdestroy(cplcomp=gc_atm_cpl, rc=RC)
      ENDIF
      CALL ERR_MSG(RC,MESSAGE_CHECK,RC_FINAL)
! ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~
!
!-----------------------------------------------------------------------
!***  THE FINAL ERROR SIGNAL INFORMATION.
!-----------------------------------------------------------------------
!
      IF(RC_FINAL==ESMF_SUCCESS)THEN
        WRITE(0,*)'ATM FINALIZE STEP SUCCEEDED'
      ELSE
        WRITE(0,*)'ATM FINALIZE STEP FAILED'
      ENDIF
!
      IF(PRESENT(RC_FINALIZE))THEN
        RC_FINALIZE=RC_FINAL
      ENDIF
!
!-----------------------------------------------------------------------
!
      END SUBROUTINE ATM_FINALIZE
!
!-----------------------------------------------------------------------
!
      END MODULE MODULE_ATM_GRID_COMP
!
!-----------------------------------------------------------------------
